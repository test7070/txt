post:--orde
--訂單轉出貨單
SET QUOTED_IDENTIFIER OFF
declare @year nvarchar(20)=[1]--年度[1]
declare @noa nvarchar(20)=[2]--單據編號[2]
declare @condition nvarchar(20)=[3]--動作 0 刪除, 1 新增[3]
declare @project nvarchar(20)=[4] --客戶專案
-----------------------------------------------------------------------
declare @cmd nvarchar(max)
declare @vccno nvarchar(MAX)

declare @t_bbmupdate nvarchar(max)='N' --判斷是否要更新或刪除 表頭資料

if(@project!="uu")
begin
	declare @nowdate nvarchar(30) --今天日期
	set @nowdate=CONVERT (VARCHAR(7), GETDATE(),12 )+0890000
	set @nowdate=left(@nowdate,3)+'/'+substring(@nowdate,4,2)+'/'+right(@nowdate,2)
	
	declare @accy nvarchar(20)
	declare @invono nvarchar(MAX)
	set @accy=isnull((select top 1 accy from view_orde where noa=@noa),@year)
	set @vccno=isnull((select top 1 vccno from view_orde where noa=@noa),'')
	set @invono=isnull((select top 1 invono from view_vcc where noa=@vccno),'')
	
	--104/12/22 出貨單產生傳票不刪除 (收款也不刪除)//and ((select count(*) from view_vcc where noa=@vccno and accno!='')>0 or (select count(*) from umms where vccno=@vccno )>0 )
	--106/01/17 出貨單日期不變動
	if(@project="RB" and len(@vccno)>0)
	begin
		set @t_bbmupdate='Y'
	end
	
	if(@condition='0')
	begin
		--刪除產生的vcc
		if(@t_bbmupdate!='Y')
		begin
			set @cmd="delete vcc"+@accy+" where noa='"+@vccno+"'"
			EXECUTE sp_executesql @cmd
		end
		
		set @cmd="delete vccs"+@accy+" where noa='"+@vccno+"'"
		EXECUTE sp_executesql @cmd
	end
	
	declare @n_vccno nvarchar(50) --新的vccno
	
	if(@condition='1')
	begin
		--檢查orde的vccno是否已有編號(表示修改)
		if(LEN(@vccno)=0)
		begin
			--取得當天最後一個出貨單號
			select @n_vccno=MAX(noa) from view_vcc where noa like 'D'+REPLACE(@nowdate,'/','')+'%'
			--新的出貨單號(後面號碼+1)
			set @n_vccno='D'+REPLACE(@nowdate,'/','')+right('000'+cast(cast(RIGHT(isnull(@n_vccno,'000'),3) as int)+1 as nvarchar(10)),3)
		end
		else
		begin
			set @n_vccno=@vccno
		end
		
		if(@project="RB")
		begin
			set @invono=isnull((select top 1 ordbno from view_orde where noa=@noa),'')
			if(len(@invono)=0) --重新再找發票號碼
			begin
				set @invono=isnull(stuff((select ','+noa from vcca where trdno=@noa group by noa for xml path('')),1,1,''),'')
			end
			
			if(@t_bbmupdate='Y') --更新表頭資料
			begin
				set @cmd="update a 
				set stype=b.stype
				,custno=b.custno,comp=b.comp,nick=b.nick,tel=b.tel,fax=b.fax
				,post=b.post,addr=b.addr,post2=b.post2,addr2=b.addr2
				,salesno=b.salesno,sales=b.sales,cno=b.cno,acomp=b.acomp
				,paytype=b.paytype,trantype=b.trantype
				,money=b.money,tax=b.tax,taxtype=b.taxtype,total=b.total
				,worker=b.worker,worker2=b.worker2
				,unpay=b.total-a.payed,payed=a.payed
				,memo=b.memo+(case when len(b.memo)>0 then 'chr(10)' else '' end) +'由訂單'+b.noa+'轉來'
				,zipcode=b.gdate,zipname=b.gtime,storeno=b.postname,store=b.conform
				,invono='"+@invono+"',invo='"+@invono+"'
				,partno=isnull((select top 1 partno from sss where namea=b.worker),'')
				,part=isnull((select top 1 part from sss where namea=b.worker),'')
				from vcc"+@accy+" a outer apply (select top 1 * from orde"+@accy+" where noa='"+@noa+"' ) b 
				where a.noa='"+@n_vccno+"' "
				EXECUTE sp_executesql @cmd
			end
			else
			begin
				--將orde的內容轉至vcc
				set @cmd="insert vcc"+@accy+"(noa,ordeno,typea,stype,datea,custno,comp,nick,tel,fax,post,addr,post2,addr2,salesno,sales
				,cno,acomp,paytype,trantype,money,tax,taxtype,total,worker,worker2,unpay,payed,memo,mon
				,zipcode,zipname,storeno,store,invono,invo,partno,part,custno2)
				select '"+@n_vccno+"' noa,noa ordeno,'1' typea,stype,'"+@nowdate+"',custno,comp,nick,tel,fax,post,addr,post2,addr2,salesno,sales
				,cno,acomp,paytype,trantype,money,tax,taxtype,total,worker,worker2,total unpay,0 payed
				,memo+(case when len(memo)>0 then 'chr(10)' else '' end) +'由訂單'+noa+'轉來',left('"+@nowdate+"',6)
				,gdate,gtime,postname,conform,'"+@invono+"','"+@invono+"'
				,isnull((select top 1 partno from sss where namea=a.worker order by noa),'')
				,isnull((select top 1 part from sss where namea=a.worker order by noa),''),''
				from orde"+@accy+" a  where noa='"+@noa+"'"
				EXECUTE sp_executesql @cmd
			end
			
			--表身資料
			set @cmd="insert vccs"+@accy+"(noa,noq,datea,typea,productno,product,unit,spec,style,mount,weight
			,lengthb,width,dime,radius,size,price,total,memo,ordeno,no2,custno,storeno,store)
			select '"+@n_vccno+"' noa,a.no2 noq,'"+@nowdate+"','1' typea,a.productno,a.product,a.unit
			,a.spec,a.style,a.mount,a.weight,a.lengthb,a.width,a.dime,a.radius,a.size,a.price,a.total,a.memo,a.noa ordeno,a.no2,b.custno
			,b.postname,b.conform
			from ordes"+@accy+" a left join orde"+@accy+" b on a.noa=b.noa where a.noa='"+@noa+"'"
			EXECUTE sp_executesql @cmd
		end
		else
		begin
			--將orde的內容轉至vcc(通用)
			set @cmd="insert vcc"+@accy+"(noa,ordeno,typea,stype,datea,custno,comp,nick,tel,fax,post,addr,post2,addr2,salesno,sales
			,cno,acomp,paytype,trantype,money,tax,taxtype,total,worker,worker2,unpay,payed,memo,mon)
			select '"+@n_vccno+"' noa,noa ordeno,'1' typea,stype,'"+@nowdate+"',custno,comp,nick,tel,fax,post,addr,post2,addr2,salesno,sales
			,cno,acomp,paytype,trantype,money,tax,taxtype,total,worker,worker2,total unpay,0 payed,memo,mon
			from orde"+@accy+" where noa='"+@noa+"'"
			EXECUTE sp_executesql @cmd
			
			set @cmd="insert vccs"+@accy+"(noa,noq,datea,typea,productno,product,unit,spec,style,mount,weight
			,lengthb,width,dime,radius,size,price,total,memo,ordeno,no2,custno)
			select '"+@n_vccno+"' noa,a.no2 noq,'"+@nowdate+"','1' typea,a.productno,a.product,a.unit
			,a.spec,a.style,a.mount,a.weight,a.lengthb,a.width,a.dime,a.radius,a.size,a.price,a.total,a.memo,a.noa ordeno,a.no2,b.custno
			from ordes"+@accy+" a left join orde"+@accy+" b on a.noa=b.noa where a.noa='"+@noa+"'"
			EXECUTE sp_executesql @cmd
		end
			
		if(LEN(@vccno)=0)
		begin
			--資料寫入dno 避免下次自動產生出現問題
			insert dno(tablea,noa,usera,mech)
			select 'vcc',@n_vccno,'z001',replace(convert(nvarchar(20),GETDATE(),20),'-','/')
			
			--更新vccno
			set @cmd="update orde"+@accy+" set vccno='"+@n_vccno+"' where noa='"+@noa+"'"
			EXECUTE sp_executesql @cmd
			
			if(@project="RB")
			begin
				--更新到發票
				update vcca set vccno=@n_vccno where trdno=@noa
			end
		end
		
		set @vccno=@n_vccno
		
	end
	
	select @vccno vccno
end
else
begin
	declare @odate nvarchar(20)
	declare @autovcc nvarchar(50)=(select totalus from view_orde where noa=@noa)
	declare @quatno nvarchar(50)=(select quatno from view_orde where noa=@noa)
	declare @stype nvarchar(50)=(select stype from view_orde where noa=@noa)

	if(@condition='0')
	begin
		if(@autovcc=1)
		begin
			set @vccno=(select quatno from view_orde where noa=@noa)
			--刪除產生的vcc
			set @cmd="delete vcc"+@year+" where noa='"+@vccno+"'"
			EXECUTE sp_executesql @cmd
			set @cmd="delete vccs"+@year+" where noa='"+@vccno+"'"
			EXECUTE sp_executesql @cmd
			
			--清除quatno
			set @cmd="update orde"+@year+" set quatno='' where noa='"+@noa+"'"
			EXECUTE sp_executesql @cmd
			
		end
	end
	
	if(@condition='1')
	begin
		--取得訂單日期
		if(@autovcc=1)
		begin
			select @odate=odate from view_orde where noa=@noa
			
			--檢查ordeno的quatno是否已有編號(表示編輯)
			if(LEN(@quatno)=0)
			begin
				--取得當天最後一個出貨單號
				select @vccno=MAX(noa) from view_vcc where noa like 'D'+REPLACE(@odate,'/','')+'%'
				
				--新的出貨單號(後面號碼+1)
				set @vccno='D'+REPLACE(@odate,'/','')+right('000'+cast(cast(RIGHT(isnull(@vccno,'000'),3) as int)+1 as nvarchar(10)),3)
			end
			else
			begin
				set @vccno=@quatno
			end
			
			--將orde的內容轉至vcc
			set @cmd="insert vcc"+@year+"(noa,ordeno,typea,stype,datea,custno,comp,nick,tel,fax,post,addr,post2,addr2,salesno,sales
			,cno,acomp,invono,paytype,trantype,money,tax,taxtype,total,worker,worker2,unpay,payed,memo,mon)
			select '"+@vccno+"' noa,noa ordeno,'1' typea,'"+@stype+"' stype,odate,custno,comp,nick,tel,fax,post,addr,post2,addr2,salesno,sales
			,cno,acomp,postname invono,paytype,trantype,money,tax,taxtype,total,worker,worker2,total unpay,0 payed,memo,mon
			from orde"+@year+" where noa='"+@noa+"'"
			EXECUTE sp_executesql @cmd
			
			set @cmd="insert vccs"+@year+"(noa,noq,datea,typea,productno,product,unit,spec,mount,weight
			,lengthb,width,dime,radius,size,price,total,memo,ordeno,no2,storeno,store,custno)
			select '"+@vccno+"' noa,a.no2 noq,'"+@odate+"','1' typea,a.productno,a.product,a.unit
			,(select spec from ucc where noa=a.productno) spec
			,a.mount,a.weight,a.lengthb,a.width,a.dime,a.radius,a.size
			,a.price,a.total,a.memo,a.noa ordeno,a.no2
			,(select top 1 noa from store where noa=b.cno)storeno
			,(select top 1 store from store where noa=b.cno) store,b.custno
			from ordes"+@year+" a left join orde"+@year+" b on a.noa=b.noa where a.noa='"+@noa+"'"
			EXECUTE sp_executesql @cmd
			
			if(LEN(@quatno)=0)
			begin
				--資料寫入dno 避免下次自動產生出現問題
				insert dno(tablea,noa,usera)
				select 'vcc',@vccno,'z001'
				
				set @cmd="update orde"+@year+" set quatno='"+@vccno+"' where noa='"+@noa+"'"
				EXECUTE sp_executesql @cmd
			end
		end
	end
end
;
-------------------------------------------------------------------------------------------------------------------------------------------------------
orde_vcca:--orde_vcca
--彩虹訂單轉發票
SET QUOTED_IDENTIFIER OFF
declare @year nvarchar(20)=[1]--年度[1]
declare @noa nvarchar(20)=[2]--單據編號[2]
declare @condition nvarchar(20)=[3]--動作 0 刪除, 1 新增[3]
declare @t_err nvarchar(200)=''
-----------------------------------------------------------------------
declare @nowdate nvarchar(30) --今天日期
set @nowdate=CONVERT (VARCHAR(7), GETDATE(),12 )+0890000
set @nowdate=left(@nowdate,3)+'/'+substring(@nowdate,4,2)+'/'+right(@nowdate,2)

declare @cmd nvarchar(max)
declare @accy nvarchar(20)
declare @vccno nvarchar(max)
declare @invono nvarchar(max)
declare @t_cno nvarchar(50)
set @accy=isnull((select accy from view_orde where noa=@noa),@year)
set @vccno=isnull((select vccno from view_orde where noa=@noa),'')
set @invono=isnull((select ordbno from view_orde where noa=@noa),'')
declare @kind nvarchar(50) --ordekind
set @kind=isnull((select kind from view_orde where noa=@noa),'')
set @t_cno=isnull((select cno from view_orde where noa=@noa),'')

if(@condition='0')
begin
	--刪除產生的發票--隨貨單張或多張
	if(@kind='隨貨單張')
	begin
		if((select count(*) from vcca where trdno=@noa and [type]='E')>0) --由訂單產生發票
		begin
			set @cmd="delete a  from vccas a where exists (select noa from vcca where noa=a.noa and trdno='"+@noa+"' and [type]='E')"
			EXECUTE sp_executesql @cmd
			--105/05/20 不刪除發票表頭--保留
			--set @cmd="delete vcca where trdno='"+@noa+"' and [type]='E'"
			--EXECUTE sp_executesql @cmd
		end
	end
end

--可開立發票
declare @cvcca table(
	noa nvarchar(20),
	vccano nvarchar(20)
)
declare @vccarno nvarchar(20)
declare @bvccano nvarchar(20)
declare @evccano nvarchar(20)
declare @xvccano nvarchar(20)

declare @money int=0
declare @moneys int=0
declare @noq nvarchar(20)=''

if(@condition='1')
begin
	if(@kind='隨貨單張')
	begin
		--判斷是否有其他關聯發票
		if((select count(*) from vcca where charindex(trdno,@noa)>0 and [type]!='E')>0)
		begin
			set @t_err='【'+@noa+'】非由訂單方式產生過發票，故不變動發票內容!!'
		end
		
		if((select count(*) from vcca where charindex(vccno,@vccno)>0 and [type]!='E')>0)
		begin
			set @t_err='【'+@vccno+'】出貨單已產生過發票，故不變動發票內容!!'
		end

		if(len(@invono)=0)--無發票號碼
		begin
			--抓取可開立的發票
			declare cursor_table cursor for
			select a.noa,b.binvono,b.einvono from vccar a left join vccars b on a.noa=b.noa 
			where (@nowdate between a.bdate and a.edate) and isnull(a.iselectric,0)=1 and a.cno=@t_cno 
			order by a.noa,a.binvono
			open cursor_table
			fetch next from cursor_table
			into @vccarno,@bvccano,@evccano
			while(@@FETCH_STATUS <> -1)
			begin
				set @xvccano=@bvccano
				while (@xvccano<=@evccano and (@xvccano between @bvccano and @evccano))
				begin
					if((select count(*) from vcca where noa=@xvccano)=0)
					begin
						insert @cvcca
						select @vccarno,@xvccano
					end
					set @xvccano=LEFT(@xvccano,2)
					+RIGHT('00000000'+cast(cast(RIGHT(@xvccano,8) as int)+1 as nvarchar(10)),8)
				end
						fetch next from cursor_table
				into @vccarno,@bvccano,@evccano
			end
			close cursor_table
			deallocate cursor_table
			
			if((select count(*) from @cvcca)=0) 
			begin
				set @t_err='當期無可用發票，請手動開立'
			end
			else
			begin
				--set @invono=(select top 1 vccano from @cvcca order by noa,vccano )
				
				if((select count(*) from adpipe where noa=@invono)>0)
				begin
					set @invono= isnull((select top 1 vccano from @cvcca a where 
					not exists (select * from vcca where noa=a.vccano)
					and not exists (select * from adpipe where noa=a.vccano)
					order by noa,vccano),'')
					
					if(@invono='')
					begin
						set @t_err='當期無可用發票，請手動開立'
					end
					
					BEGIN TRY
						insert adpipe(noa)
						select @invono
					END TRY
					BEGIN CATCH
						set @t_err='開立發票錯誤，請重新開立'
					END CATCH
				end
				else
				begin
					insert adpipe(noa)
					select @invono
				end
			end
		end
		
		if(len(@t_err)=0)
		begin		
			--104/09/23 有統編 客戶名稱不帶統編帶入 沒有統編客戶名稱以及統編就不帶入
			--104/10/06 客戶編號要寫入
			--104/10/30 稅別固定應稅
			--104/11/24 表頭稅金金額不變 未稅金額有差調整最後一筆金額
			--105/05/19 表頭不刪除 用更新方式處理 不更新買受人
			
			if((select count(*) from vcca where noa=@invono)>0)
			begin
				update a
				set custno=b.custno,comp=b.comp,nick=b.nick
				,serial=b.coin--,datea=@nowdate
				,mon=case when isnull(b.mon,'')!='' then b.mon else left(@nowdate,6) end
				,cno=case when isnull(b.cno,'')!='' then b.cno else (select top 1 noa from acomp order by noa) end
				,acomp=case when isnull(b.cno,'')!='' then b.acomp else (select top 1 acomp from acomp order by noa) end
				,zip=isnull((select top 1 zip_invo from cust where noa=b.custno),'')
				,address=isnull((select top 1 addr_invo from cust where noa=b.custno),'')
				,taxtype='1',money=b.money,tax=b.tax,total=b.total
				,worker=case when b.worker2!='' then b.worker2 else b.worker end
				,vccno=@vccno
				from vcca a outer apply (select top 1 * from view_orde b where noa=@noa) b
				where a.noa=@invono
			end
			else
			begin
				insert vcca(noa,custno,comp,nick,serial,buyerno,buyer,datea,mon,cno,acomp,zip,address,taxtype,money,tax,total,trdno,worker,vccno,[type],memo,chkno)
				--select @invono,'','',b.nick,b.coin,'',''
				select @invono,b.custno,b.comp,b.nick,b.coin,'',''
				,@nowdate,case when isnull(b.mon,'')!='' then b.mon else left(@nowdate,6) end
				,case when isnull(b.cno,'')!='' then b.cno else (select top 1 noa from acomp order by noa) end
				,case when isnull(b.cno,'')!='' then b.acomp else (select top 1 acomp from acomp order by noa) end
				,isnull((select top 1 zip_invo from cust where noa=b.custno),'')
				,isnull((select top 1 addr_invo from cust where noa=b.custno),'')
				,'1',b.money,b.tax,b.total
				,b.noa,case when b.worker2!='' then b.worker2 else b.worker end,@vccno,'E','由訂單'+b.noa+'轉來' 
				,right('000000'+cast(cast(cast(
					cast(LOG((ascii(SUBSTRING(@invono,1,1))*100)+
					(ascii(SUBSTRING(@invono,2,1))*25)+
					cast(SUBSTRING(@invono,3,3) as int))*100 as int)
				*144 as int)
				+(SIN(cast(SUBSTRING(@invono,6,2) as int))*cast(SUBSTRING(@invono,8,3) as int)*100) as int)as nvarchar(10)),6)
				from view_orde b where noa=@noa
			end
			
			if((select taxtype from view_orde where noa=@noa)='3')
			begin
				insert vccas(noa,noq,custno,productno,product,unit,mount,price,money,datea,ordeno,no2)
				select @invono,a.no2,a.custno,a.productno,a.product,a.unit,a.mount
				,case when a.mount=0 then 0 else round(round(a.total/1.05,0)/a.mount,3) end
				,round(a.total/1.05,0),@nowdate,a.noa,a.no2
				from view_ordes a where a.noa=@noa
				
				set @money=isnull((select money from vcca where noa=@invono),0)
				set @moneys=isnull((select SUM(money) from vccas where noa=@invono),0)
				
				--表頭未稅與表身未稅金額不符
				if(@money!=@moneys)
				begin
					--調整最後一個產品金額(只取有金額)
					set @noq=(select MAX(noq) from vccas where noa=@invono and mount>0 and money>0)
					
					update vccas set money=money+(@money-@moneys) where noa=@invono and noq=@noq
					update vccas set price=round(money/mount,3) where noa=@invono and noq=@noq
				end
				
				--update a
				--set money=(select SUM(money) from vccas where noa=a.noa)
				--,tax=total-isnull((select SUM(money) from vccas where noa=a.noa),0)
				--from vcca a where noa=@invono
			end
			else
			begin
				insert vccas(noa,noq,custno,productno,product,unit,mount,price,money,datea,ordeno,no2)
				select @invono,a.no2,a.custno,a.productno,a.product,a.unit,a.mount,a.price,a.total,@nowdate,a.noa,a.no2
				from view_ordes a where a.noa=@noa
			end
			
			EXEC("update orde"+@accy+" set ordbno='"+@invono+"' where noa='"+@noa+"'")
			
			--若有出貨單更新出貨單的發票號碼
			if(len(@vccno)>0)
			begin
				set @accy= isnull((select accy from view_vcc where noa=@vccno),@year)
				EXEC("update vcc"+@accy+" set invono='"+@invono+"',invo='"+@invono+"' where noa='"+@vccno+"'")
			end
		end
	end
	else
	begin
		set @invono=isnull(stuff((select ','+noa from vcca where trdno=@noa group by noa for xml path('')),1,1,''),'') 
		EXEC("update orde"+@accy+" set ordbno=isnull(stuff((select ','+noa from vcca where trdno='"+@noa+"' group by noa for xml path('')),1,1,''),'') where noa='"+@noa+"'")
	end
end

select @invono invono,@t_err t_err
;
-------------------------------------------------------------------------------------------------------------------------------------------------------
orde2ordb:--ordb2ordb
--訂單轉至請購單
SET QUOTED_IDENTIFIER OFF
declare @year nvarchar(20)=[1]--年度
declare @sssno nvarchar(max)=[2] --採購員編號
declare @ordbno nvarchar(max)=[3] --目前請購代號
declare @ordbdata nvarchar(MAX)=[4]--轉請購資料
declare @ordbum nvarchar(max) --目前請購序號

declare @nowdate nvarchar(30) --今天日期
set @nowdate=CONVERT (VARCHAR(7), GETDATE(),12 )+0890000
set @nowdate=left(@nowdate,3)+'/'+substring(@nowdate,4,2)+'/'+right(@nowdate,2)

declare @ordbdate nvarchar(30)--請購有效日
set @ordbdate=CONVERT (VARCHAR(7), GETDATE()+10,12 )+0890000
set @ordbdate=left(@ordbdate,3)+'/'+substring(@ordbdate,4,2)+'/'+right(@ordbdate,2)

declare @accy nvarchar(20)=left(@nowdate,3)
declare @cmd nvarchar(max)

set @cmd="select @ordbum= isnull(right((select top 1 noa from view_ordb where CHARINDEX('"+@ordbno+"'+ REPLACE('"+@nowdate+"','/',''),noa)>0 order by noa desc),3),'0')"
EXEC SP_EXECUTESQL @cmd, N'@ordbum nvarchar(max) OUTPUT', @ordbum OUTPUT
-----------------------------------------------------------------------
declare @string nvarchar(max)
declare @n int

	IF OBJECT_ID('tempdb..#tmp')is not null
	BEGIN
		set @cmd = 'drop table #tmp'
		EXECUTE sp_executesql @cmd
	END
	
	create table #tmp(
		idno int identity(0,1),
		noa nvarchar(90),
		no2 nvarchar(90),
		mount float,
		tggno nvarchar(90),
		price float
	)
	
	set @string = @ordbdata
	while(1=1)
	begin
		set @n = PATINDEX('%##%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #tmp 
				select dbo.split(@string,'^',0),dbo.split(@string,'^',1)
				,cast(dbo.split(@string,'^',2) as float)
				,dbo.split(@string,'^',3)
				,cast(dbo.split(@string,'^',4) as float)
			end
			break
		end
		
		insert into #tmp 
		select dbo.split(LEFT(@string,@n-2),'^',0),dbo.split(LEFT(@string,@n-2),'^',1)
		,cast(dbo.split(LEFT(@string,@n-2),'^',2) as float)
		,dbo.split(LEFT(@string,@n-2),'^',3)
		,cast(dbo.split(LEFT(@string,@n-2),'^',4) as float)
		
		set @string = SUBSTRING(@string,@n+2,LEN(@string)-@n)
	end
	
	declare @tggno nvarchar(max)
	declare @ordbnos nvarchar(max)=''
	declare cursor_table cursor for 
	select tggno from #tmp group by tggno order by tggno
	open cursor_table 
	fetch next from cursor_table 
	into @tggno
	while(@@FETCH_STATUS <> -1) 
	begin
		--bbm
		EXEC("insert into ordb"+@accy+" (datea,odate,noa,kind,tggno,tgg,nick,paytype,trantype,tel,fax,cno,acomp,salesno,sales,worker,money,taxtype,total,memo,enda,isproj,cancel
		,tax,weight,floata,mount,price,totalus,isctrlweight,ordgweight,ordeweight,signprocess,apv)
		select '"+@ordbdate+"','"+@nowdate+"','"+@ordbno+"'+ REPLACE('"+@nowdate+"','/','')+right(('000'+cast(cast('"+@ordbum+"' as int)+1 as nvarchar(10))),3) noa
		,'1' kind,'"+@tggno+"' tggno,isnull((select top 1 comp from tgg where noa='"+@tggno+"'),'') tgg
		,isnull((select top 1 (case when isnull(nick,'')='' then left(comp,4) else nick end) from tgg where noa='"+@tggno+"'),'') nick
		,isnull((select top 1 paytype from tgg where noa='"+@tggno+"'),'') paytype
		,isnull((select top 1 trantype from tgg where noa='"+@tggno+"'),'') trantype
		,isnull((select top 1 tel from tgg where noa='"+@tggno+"'),'') tel
		,isnull((select top 1 fax from tgg where noa='"+@tggno+"'),'') fax
		,isnull((select top 1 noa from acomp),'') cno,isnull((select top 1 acomp from acomp),'') acomp
		,'"+@sssno+"' salesno
		,isnull((select top 1 namea from sss where noa='"+@sssno+"'),'') sales
		,isnull((select top 1 namea from nhpe where noa='"+@sssno+"'),'') worker
		,0 money,'0' taxtype, 0 total,'"+@nowdate+"'+' 訂單作業轉來 'memo,0,1,0,0,0,0,0,0,0,0,0,0,0,'N'")
		
		--bbs
		EXEC("insert into ordbs"+@accy+"(datea,noa,no3,productno,productno1,product,unit,mount,c1,notv,omount,stdmount,price
		,total,tggno,enda,cancel,kind,memo,spec,ordeno,no2,apv,weight,c2,notv2,dime,width,lengthb,theory,radius,isnotdeal)
		select '"+@ordbdate+"','"+@ordbno+"'+ REPLACE('"+@nowdate+"','/','')+right(('000'+cast(cast('"+@ordbum+"' as int)+1 as nvarchar(10))),3) noa
		,right('000'+cast(ROW_NUMBER() OVER (ORDER BY b.productno DESC) as nvarchar(10)),3) no3
		,b.productno,b.productno,b.product,b.unit,a.mount,0,a.mount,a.mount,0,a.price
		,round(a.mount*a.price,0) total
		,'"+@tggno+"',0,0, '1' kind,'','',a.noa,a.no2,'N',0,0,0,0,0,0,0,0,0
		from #tmp a left join view_ordes b on a.noa+'-'+a.no2=b.noa+'-'+b.no2 where isnull(a.tggno,'')='"+@tggno+"'")
		
		EXEC("update ordb"+@accy+" set money=round((select sum(total) from view_ordbs where noa='"+@ordbno+"'+ REPLACE('"+@nowdate+"','/','')+right(('000'+cast(cast('"+@ordbum+"' as int)+1 as nvarchar(10))),3)),0)
		,total=round((select sum(total) from view_ordbs where noa='"+@ordbno+"'+ REPLACE('"+@nowdate+"','/','')+right(('000'+cast(cast('"+@ordbum+"' as int)+1 as nvarchar(10))),3)),0)
		,ordeno=(select top 1 ordeno from view_ordbs where noa='"+@ordbno+"'+ REPLACE('"+@nowdate+"','/','')+right(('000'+cast(cast('"+@ordbum+"' as int)+1 as nvarchar(10))),3))
		where noa ='"+@ordbno+"'+ REPLACE('"+@nowdate+"','/','')+right(('000'+cast(cast('"+@ordbum+"' as int)+1 as nvarchar(10))),3)
		")
		
		set @ordbnos=@ordbnos+@ordbno+ REPLACE(@nowdate,'/','')+right(('000'+cast(cast(@ordbum as int)+1 as nvarchar(10))),3)+','
		set @ordbum=right(('000'+cast(cast(@ordbum as int)+1 as nvarchar(10))),3)
	
		fetch next from cursor_table 
		into @tggno
	end 
	close cursor_table 
	deallocate cursor_table 
	
	if(len(@ordbnos)>0)
	begin
		select @ordbnos ordbnos
		EXEC("update orde"+@year+" set ordbno='"+@ordbnos+"' where noa in(select noa from #tmp group by noa)")
	end

;
-------------------------------------------------------------------------------------------------------------------------------------------------------
apv:--orde_apv
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_userno nvarchar(max)
	declare @t_ordeno nvarchar(max)
	
	set @t_userno = [1]
	set @t_ordeno = [2]
	
	declare @namea nvarchar(20)
	declare @credit float
	declare @total float
	declare @accy nvarchar(20)
	declare @apv nvarchar(max)
	declare @tmp table(
		err int,
		msg nvarchar(max),
		ordeno nvarchar(max),
		userno nvarchar(max),
		namea nvarchar(max)
	)
	if (select COUNT(1) from @tmp)=0 and not exists(select * from nhpe where noa=@t_userno)
	begin
		insert into @tmp(err,msg)values(2,'【'+isnull(@t_userno,'')+'】查無使用者')
	end
	select @namea=namea,@credit=isnull(credit,0) from nhpe where noa=@t_userno
	-------------------------------------------------------------------------------------------------------
	if (select COUNT(1) from @tmp)=0 and not exists(select noa from view_orde where noa=@t_ordeno)
	begin
		insert into @tmp(err,msg)values(3,'【'+isnull(@t_ordeno,'')+'】查無訂單')
	end
	select @accy=accy,@total=isnull(total,0),@apv=apv from view_orde where noa=@t_ordeno
	-------------------------------------------------------------------------------------------------------
	if (select COUNT(1) from @tmp)=0 and LEN(ISNULL(@apv,''))>0
	begin
		insert into @tmp(err,msg)values(4,'訂單【'+@t_ordeno+'】已被【'+@apv+'】核准')
	end
	-------------------------------------------------------------------------------------------------------
	if (select COUNT(1) from @tmp)=0 and @credit<@total
	begin
		insert into @tmp(err,msg)values(5,'【'+isnull(@t_userno,'')+' '+isnull(@namea,'')+'】使用者額度不足')
	end
	-------------------------------------------------------------------------------------------------------
	if (select COUNT(1) from @tmp)=0 and (@credit>=@total and ISNULL(@credit,0)>0)
	begin
		set @cmd = "update orde"+@accy+" set apv=@namea where noa=@t_ordeno"
		execute sp_executesql @cmd,N'@namea nvarchar(20),@t_ordeno nvarchar(20)'
			,@namea=@namea,@t_ordeno=@t_ordeno
		insert into @tmp(err,ordeno,userno,namea)values(1,@t_ordeno,@t_userno,@namea)
		insert into drun(datea,timea,usera,action,noa,tablea,title,memo)
		values(CONVERT(nvarchar,GETDATE(),111),left(CONVERT(nvarchar,GETDATE(),108),5),@t_userno,'apv',@t_ordeno,'orde','核準','')
	end
	
	select * from @tmp;
-------------------------------------------------------------------------------------------------------------------------------------------------------------
conform:--orde_conform
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_userno nvarchar(max)
	declare @t_ordeno nvarchar(max)
	
	set @t_userno = [1]
	set @t_ordeno = [2]
	
	declare @namea nvarchar(20)
	declare @credit float
	declare @total float
	declare @accy nvarchar(20)
	declare @conform nvarchar(max)
	declare @tmp table(
		err int,
		msg nvarchar(max),
		ordeno nvarchar(max),
		userno nvarchar(max),
		namea nvarchar(max)
	)
	if (select COUNT(1) from @tmp)=0 and not exists(select * from nhpe where noa=@t_userno)
	begin
		insert into @tmp(err,msg)values(2,'【'+isnull(@t_userno,'')+'】查無使用者')
	end
	select @namea=namea,@credit=isnull(credit,0) from nhpe where noa=@t_userno
	-------------------------------------------------------------------------------------------------------
	if (select COUNT(1) from @tmp)=0 and not exists(select noa from view_orde where noa=@t_ordeno)
	begin
		insert into @tmp(err,msg)values(3,'【'+isnull(@t_ordeno,'')+'】查無訂單')
	end
	select @accy=accy,@total=isnull(total,0),@conform=conform from view_orde where noa=@t_ordeno
	-------------------------------------------------------------------------------------------------------
	if (select COUNT(1) from @tmp)=0 and LEN(ISNULL(@conform,''))>0
	begin
		insert into @tmp(err,msg)values(4,'訂單【'+@t_ordeno+'】已簽回')
	end
	-------------------------------------------------------------------------------------------------------
	if (select COUNT(1) from @tmp)=0
	begin
		set @cmd = "update orde"+@accy+" set conform='*' where noa=@t_ordeno"
		execute sp_executesql @cmd,N'@t_ordeno nvarchar(20)',@t_ordeno=@t_ordeno
		insert into @tmp(err,ordeno,userno,namea)values(1,@t_ordeno,@t_userno,@namea)
		insert into drun(datea,timea,usera,action,noa,tablea,title,memo)
		values(CONVERT(nvarchar,GETDATE(),111),left(CONVERT(nvarchar,GETDATE(),108),5),@t_userno,'conform',@t_ordeno,'orde','簽回','')
	end
	select * from @tmp;
------------------------------------------------------------------------------------------------------------------
orde_ordc_rc2_gu:--orde_ordc_rc2_gu 判斷轉採購單或已進貨
SET QUOTED_IDENTIFIER OFF

declare @t_accy nvarchar(50)
declare @t_noa nvarchar(50)

set @t_accy = case when '#non' = [1] then '104' else [1] end
set @t_noa = case when '#non' = [2] then '' else [2] end

select sum(isnull(cb.mount,0)) ordcmount,sum(isnull(rs.mount,0))rc2mount 
from view_ordc ca left join view_ordcs cb on ca.noa=cb.noa 
left join view_rc2s rs on cb.noa=rs.ordeno and cb.no2=rs.no2 
where ca.quatno=@t_noa --and isnull(rs.noa,'')!=''
;
----------------------------------------------------------------------------------
orde2ordc_gu:--orde2ordc_gu 轉採購單
SET QUOTED_IDENTIFIER OFF

declare @t_accy nvarchar(50)
declare @t_noa nvarchar(50)
declare @t_mount nvarchar(20)
declare @t_worker nvarchar(50)
declare @t_stkdate nvarchar(30)

set @t_accy = case when '#non' = [1] then '104' else [1] end
set @t_noa = case when '#non' = [2] then '' else [2] end
set @t_mount = case when '#non' = [3] then '0' else [3] end
set @t_worker = case when '#non' = [4] then '' else [4] end

set @t_stkdate=CONVERT (VARCHAR(7), GETDATE(),12 )+0890000
set @t_stkdate=left(@t_stkdate,3)+'/'+substring(@t_stkdate,4,2)+'/'+right(@t_stkdate,2)
---------------------------------------------------------------------------------
declare @tmpa table(
	productno nvarchar(50),
	product nvarchar(200),
	spec nvarchar(50),
	gdemand float
)

--uca
insert @tmpa
select b.productno,b.product,b.spec,b.mount*a.mount
from view_ordes a left join ucas b on a.productno=b.noa 
where a.noa=@t_noa and isnull(b.noa,'')!='' and isnull(a.productno,'')!=''

--ucc
insert @tmpa
select a.productno,a.product,a.spec,a.mount
from view_ordes a left join ucc b on a.productno=b.noa 
where a.noa=@t_noa and  isnull(b.noa,'')!='' and isnull(a.productno,'')!=''

declare @cmd nvarchar(max) 
IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
	set @cmd = 'drop table #tmp'
	EXECUTE sp_executesql @cmd
END

create table #tmp(
	gno nvarchar(1),
	tggno nvarchar(50),
	tgg nvarchar(100),
	productno nvarchar(50),
	product nvarchar(200),
	spec nvarchar(50),
	gdemand float,
	stkmount float,
	ordcmount float,
	safemount float,
	ndemand float,
	
	sordc float,
	src2 float,
	sunrc2 float,
	rc2days float 
)

insert #tmp (gno,productno,product,spec,gdemand)
select '0',productno,MAX(product),MAX(spec),sum(gdemand)
from @tmpa group by productno

update a
set tggno=isnull(b.tggno,''),tgg=isnull(b.tgg,'')
,stkmount=isnull(c.mount,0),ordcmount=isnull(d.mount,0),safemount=isnull(b.safemount,0)
,sordc=isnull(e.mount,0),src2=isnull(f.mount,0),sunrc2=isnull(e.mount,0)-isnull(f.mount,0)
,rc2days=case when isnull(b.[days],0)=0 then 1 else b.[days] end
from #tmp a
left join ucc b on a.productno=b.noa
outer apply (select sum(mount) mount from stkucc(@t_stkdate,'','') where productno=a.productno)c
outer apply (select sum(cb.mount)mount from view_ordc ca left join view_ordcs cb on ca.noa=cb.noa where isnull(ca.enda,0)!=1 and isnull(cb.enda,0)!=1 and cb.productno=a.productno and isnull(ca.quatno,'')='' and ca.quatno!=@t_noa )d
outer apply (select sum(cb.mount)mount from view_ordc ca left join view_ordcs cb on ca.noa=cb.noa where ca.quatno=@t_noa and productno=a.productno )e
outer apply (select sum(rs.mount)mount from view_ordc ca left join view_ordcs cb on ca.noa=cb.noa left join view_rc2s rs on cb.noa=rs.ordeno and cb.no2=rs.no2 where ca.quatno=@t_noa and cb.productno=a.productno and rs.productno=a.productno)f

update a
set ndemand=case when (a.gdemand-a.stkmount-a.ordcmount+a.safemount)<=0 then 0 else (a.gdemand-a.stkmount-a.ordcmount+a.safemount) end
from #tmp a

--select
--dbo.getComma(gdemand,0)gdemand
--,dbo.getComma(stkmount,0)stkmount
--,dbo.getComma(ordcmount,0)ordcmount
--,dbo.getComma(safemount,0)safemount
--,dbo.getComma(ndemand,0)ndemand
--,dbo.getComma(sordc,0)sordc
--,dbo.getComma(src2,0)src2
--,dbo.getComma(sunrc2,0)sunrc2
--,product products
--,*
--from #tmp order by gno,tggno,productno

--刪除已產生的採購單
declare @accy nvarchar(90)
set @accy=isnull((select top 1 accy from view_ordc where quatno=@t_noa),@t_accy)
EXEC("delete a from ordcs"+@accy+" a left join ordc"+@accy+" b on a.noa=b.noa where b.quatno='"+@t_noa+"' ")
EXEC("delete ordc"+@accy+" where quatno='"+@t_noa+"' ")

--新增採購單
declare @tggno nvarchar(90)
declare @ordcno nvarchar(90)

BEGIN TRY
	declare cursor_table cursor for 
	select tggno from #tmp group by tggno
	open cursor_table 
	fetch next from cursor_table 
	into @tggno
	while(@@FETCH_STATUS <> -1) 
	begin
		
		--新的採購單號
		select @ordcno=MAX(noa) from view_ordc where noa like 'P'+REPLACE(@t_stkdate,'/','')+'%'
		set @ordcno='P'+REPLACE(@t_stkdate,'/','')+right('000'+cast(cast(RIGHT(isnull(@ordcno,'000'),3) as int)+1 as nvarchar(10)),3)
		
		EXEC("insert ordc"+@accy+"(noa,quatno,kind,odate,datea,cno,acomp,tggno,tgg,nick,trantype,salesno,sales,paytype,tel,fax
		,post,addr,money,taxtype,tax,total,floata,totalus,isproj,cancel,enda,worker,trandate)
		select '"+@ordcno+"' noa,'"+@t_noa+"' quatno,'1' kind,'"+@t_stkdate+"' odate
		,dbo.q_cdn('"+@t_stkdate+"',20)datea,(select top 1 noa from acomp order by noa)cno,(select top 1 acomp from acomp order by noa )acomp
		,noa tggno,comp tgg,nick nick,trantype,salesno,sales,paytype,tel,fax,zip_comp,addr_comp
		,0 money,'0' taxtype,0 tax,0 total,0 floata,0 totalus,1 isproj,0 cancel,0 enda,'"+@t_worker+"' worker
		,dbo.q_cdn('"+@t_stkdate+"',isnull((select MAX(rc2days) from #tmp where tggno='"+@tggno+"'),0))
		from (select noa,comp,nick,trantype,salesno,sales,paytype,tel,fax,zip_comp,addr_comp from tgg 
		union all select '','','','','','','','','','','' )tmp
		where noa='"+@tggno+"'")
		
		EXEC("insert ordcs"+@accy+"(noa,no2,productno,product,spec,unit,mount,omount,stdmount,price,total,c1,notv,cancel,enda,tggno,datea,trandate)
		select '"+@ordcno+"',right('000'+cast(ROW_NUMBER() over (order by a.productno) as nvarchar(10)),3)
		,a.productno,a.product,a.spec,b.unit,case when '"+@t_mount+"'='0' then a.gdemand else a.ndemand end mount
		,case when '"+@t_mount+"'='0' then a.gdemand else a.ndemand end omount,b.stdmount,b.inprice
		,case when '"+@t_mount+"'='0' then a.gdemand else a.ndemand end*b.inprice total,0 c1
		,case when '"+@t_mount+"'='0' then a.gdemand else a.ndemand end notv,0 cancel,0 enda,'"+@tggno+"' tggno
		,dbo.q_cdn('"+@t_stkdate+"',20)datea
		,dbo.q_cdn('"+@t_stkdate+"',isnull((select MAX(rc2days) from #tmp where tggno='"+@tggno+"'),0))
		from #tmp a left join ucc b on a.productno=b.noa where a.tggno='"+@tggno+"'")
		
		EXEC(" update ordc"+@accy+" 
		set money=isnull((select sum(total) from view_ordcs where noa='"+@ordcno+"'),0) 
		,total=isnull((select sum(total) from view_ordcs where noa='"+@ordcno+"'),0) 
		where noa='"+@ordcno+"'")

		fetch next from cursor_table 
		into @tggno
	end 
	close cursor_table 
	deallocate cursor_table 
END TRY
BEGIN CATCH
	close cursor_table 
	deallocate cursor_table 
END CATCH

--更新orde的採購單號
set @accy=isnull((select top 1 accy from view_orde where noa=@t_noa),@t_accy)
EXEC("update orde"+@accy+" set ordcno=isnull(stuff((select ','+noa from view_ordc where quatno='"+@t_noa+"' FOR XML PATH('')),1,1,''),'') where noa='"+@t_noa+"' ")

--產生筆數
select count(*) counts from view_ordc where quatno=@t_noa

IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
	set @cmd = 'drop table #tmp'
	EXECUTE sp_executesql @cmd
END;
--------------------------------------------------------------------------------------------------------------------------------------------------------
orde2ordc_r:--orde2ordc_r: 轉採購單
SET QUOTED_IDENTIFIER OFF
declare @t_accy nvarchar(50)
declare @t_noa nvarchar(50)
declare @t_datea nvarchar(30)
declare @t_worker nvarchar(50)

set @t_accy = [1] --預設年度
set @t_noa = [2] --訂單號
set @t_datea = [3] --今天日期 由前端帶入
set @t_worker = [4] --操作者
declare @q_ip nvarchar(50)=[5]
declare @q_proj nvarchar(50)=[6]
declare @q_db nvarchar(50)=[7]

--1050726 增加產生越南訂單
declare @t_ip nvarchar(50) --IP
declare @t_db nvarchar(50) --DB
declare @t_factno nvarchar(50) --工廠編號
declare @t_factory nvarchar(50) --工廠名稱
declare @t_acomp nvarchar(50) --公司名稱
declare @t_custno nvarchar(50) --原客戶
declare @t_cno nvarchar(50) --公司編號

set @t_ip = isnull((select (select ip from factory where noa=a.gdate) from view_orde a where noa=@t_noa),'')
set @t_db = isnull((select (select db from factory where noa=a.gdate) from view_orde a where noa=@t_noa),'')
set @t_factno = isnull((select gdate from view_orde a where noa=@t_noa),'')
set @t_factory = isnull((select gtime from view_orde a where noa=@t_noa),'')
set @t_acomp = isnull((select (select case when isnull(nick,'')!='' then nick else acomp end from acomp where noa=a.cno) from view_orde a where noa=@t_noa),'')
set @t_custno = isnull((select custno from view_orde a where noa=@t_noa),'')
set @t_cno = isnull((select cno from view_orde a where noa=@t_noa),'')

--107/03/31 取消
--if(@q_ip=@t_ip)
--	set @t_ip='127.0.0.1'

declare @cmd nvarchar(max) 
IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
	set @cmd = 'drop table #tmp'
	EXECUTE sp_executesql @cmd
END

declare @err nvarchar(50)='採購單產生完畢!!'
declare @berr nvarchar(MAX)='' --越南錯誤訊息
declare @accy nvarchar(90)=@t_accy

declare @tmp table(
	accy nvarchar(50),
	ordcno nvarchar(50)
)

declare @t_allordc nvarchar(MAX)='' --全部的採購單號

declare @bmenda nvarchar(10) --bbm
declare @bmcancel nvarchar(10) --bbm
set @bmenda = cast(isnull((select enda from view_orde a where noa=@t_noa),0) as nvarchar(10))
set @bmcancel = cast(isnull((select cancel from view_orde a where noa=@t_noa),0) as nvarchar(10))

BEGIN TRY
	--Begin Transaction --沒有開放DTC所以暫時不使用

	--刪除已產生的採購單
	while ((select count(*) from view_ordc where quatno=@t_noa and not exists (select * from @tmp where noa=ordcno))>0)
	begin
		set @accy=isnull((select top 1 accy from view_ordc where quatno=@t_noa),@t_accy)
		EXEC("delete a from ordcs"+@accy+" a left join ordc"+@accy+" b on a.noa=b.noa where b.quatno='"+@t_noa+"' ")
		--表頭不清除
		--EXEC("delete ordc"+@accy+" where quatno='"+@t_noa+"' ")
		
		insert @tmp 
		EXEC("select '"+@accy+"',noa from ordc"+@accy+" where quatno='"+@t_noa+"' ")
		
		EXEC("update ordc"+@accy+" set money=0,tax=0,total=0,memo='',floata=0,totalus=0,coin='',worker2='"+@t_worker+"'")
	end
	
	create table #tmp(
		productno nvarchar(50),
		product nvarchar(MAX),
		mount float,
		datea nvarchar(20),
		tggno nvarchar(50),
		ordeno nvarchar(50),
		no2 nvarchar(50),
		enda bit,
		cancel bit
	)
	--105/05/20 不管 是不是原料
	--insert #tmp
	--select d.noa,d.product,b.mount,
	--case when len(b.datea)>0 then dbo.q_cdn(b.datea,-1) else dbo.q_cdn(@t_datea,1) end
	--,d.tggno
	--from view_orde a left join view_ordes b on a.noa=b.noa
	--left join ucx c on b.productno=c.noa
	--left join ucc d on c.uccno=d.noa
	--where exists (select * from ucc where noa=c.uccno)
	--and a.stype='3' and isnull(c.uccno,'')!='' and a.noa=@t_noa
	
	insert #tmp
	select b.productno,b.product,b.mount,
	case when len(b.datea)>0 then dbo.q_cdn(b.datea,-1) else dbo.q_cdn(@t_datea,1) end
	,case when len(@t_factno)>0 then isnull((select tggno from factory where noa=@t_factno),'') else c.tggno end
	,a.noa,b.no2,b.enda,b.cancel
	from view_orde a left join view_ordes b on a.noa=b.noa
	left join ucx c on b.productno=c.noa
	where a.noa=@t_noa --106/12/29 全部匯入 但根據訂單 顯示結案或取消 and isnull(b.cancel,0)!=1
	
	declare @tggno nvarchar(90)
	declare @custno nvarchar(90)
	declare @ordcno nvarchar(90)
	
	if((select count(*) from #tmp)=0)
	begin
		set @err='訂單無可採購原料!!'
	end
	else
	begin
		--新增採購單
		declare cursor_table cursor for 
		select tggno from #tmp group by tggno
		open cursor_table 
		fetch next from cursor_table 
		into @tggno
		while(@@FETCH_STATUS <> -1) 
		begin
					
			--新的採購單號
			if((select count(*) from @tmp)>0)
			begin
				select top 1 @ordcno=ordcno,@accy=accy 
				from @tmp order by ordcno
				
				delete @tmp where ordcno=@ordcno and @accy=accy	
				
				EXEC("update a
					set tggno=b.noa,tgg=b.comp,nick=b.nick,trantype=b.trantype,salesno=b.salesno,sales=b.sales
					,paytype=b.paytype,tel=b.tel,fax=b.fax,post=b.zip_comp,addr=b.addr_comp
					,money=0,taxtype='0',tax=0,total=0,floata=0,totalus=0,isproj=1
					,cancel="+@bmcancel+",enda="+@bmenda+",worker2='"+@t_worker+"',trandate=''
					from ordc"+@accy+" a outer apply(
					select * from (
						select noa,comp,nick,trantype,salesno,sales,paytype,tel,fax,zip_comp,addr_comp from tgg 
						union all select '','','','','','','','','','','' )tmp where noa='"+@tggno+"'
					)b where a.noa='"+@ordcno+"'
				")
			end
			else
			begin
				select @ordcno=MAX(noa) from view_ordc where noa like 'P'+REPLACE(@t_datea,'/','')+'%'
				set @ordcno='P'+REPLACE(@t_datea,'/','')+right('000'+cast(cast(RIGHT(isnull(@ordcno,'000'),3) as int)+1 as nvarchar(10)),3)			
				
				set @accy=@t_accy
				
				EXEC("insert ordc"+@accy+"(noa,quatno,kind,odate,datea,cno,acomp,tggno,tgg,nick,trantype,salesno,sales,paytype,tel,fax
				,post,addr,money,taxtype,tax,total,floata,totalus,isproj,cancel,enda,worker,trandate)
				select '"+@ordcno+"' noa,'"+@t_noa+"' quatno,'1' kind,'"+@t_datea+"' odate
				,dbo.q_cdn('"+@t_datea+"',20)datea,(select top 1 noa from acomp where noa='"+@t_cno+"' order by noa)cno,(select top 1 acomp from acomp where noa='"+@t_cno+"' order by noa )acomp
				,noa tggno,comp tgg,nick nick,trantype,salesno,sales,paytype,tel,fax,zip_comp,addr_comp
				,0 money,'0' taxtype,0 tax,0 total,0 floata,0 totalus,1 isproj,"+@bmcancel+" cancel,"+@bmenda+" enda,'"+@t_worker+"' worker,''
				from (select noa,comp,nick,trantype,salesno,sales,paytype,tel,fax,zip_comp,addr_comp from tgg 
				union all select '','','','','','','','','','','' )tmp
				where noa='"+@tggno+"'")
			end
			
			EXEC("insert ordcs"+@accy+"(noa,no2,productno,product,spec,unit,mount,omount,stdmount,price
			,total,c1,notv,cancel,enda,tggno,datea,trandate,ordbno,no3)
			select '"+@ordcno+"',right('000'+cast(ROW_NUMBER() over (order by a.productno) as nvarchar(10)),3)
			,a.productno,a.product,b.spec,b.unit,a.mount,a.mount omount,b.stdmount,isnull(c.price,b.cost)
			,a.mount*isnull(c.price,b.cost) total,0 c1
			,a.mount notv,a.cancel cancel,a.enda enda,'"+@tggno+"' tggno
			,dbo.q_cdn('"+@t_datea+"',20)datea,a.datea trandate,a.ordeno,a.no2
			from #tmp a left join ucx b on a.productno=b.noa 
			--outer apply (select top 1 xb.* from ucctgg xa left join ucctggs xb on xa.noa=xb.noa where xa.productno=a.productno and xa.tggno='"+@tggno+"' and xa.pricedate<'"+@t_datea+"' and isnull(xb.mount,0)<=a.mount order by xa.pricedate desc,xb.mount) c
			outer apply (select top 1 * from ucctggs where productno=a.productno and tggno='"+@tggno+"' and pricedate<'"+@t_datea+"' order by pricedate desc) c
			where a.tggno='"+@tggno+"'")
			
			EXEC(" update ordc"+@accy+" 
			set money=isnull((select sum(total) from view_ordcs where noa='"+@ordcno+"'),0) 
			,total=isnull((select sum(total) from view_ordcs where noa='"+@ordcno+"'),0) 
			where noa='"+@ordcno+"'")
			
			fetch next from cursor_table 
			into @tggno
		end 
		close cursor_table 
		deallocate cursor_table
	end
	
	set @t_allordc=isnull(stuff((select ','+noa from view_ordc where quatno=@t_noa FOR XML PATH('')),1,1,''),'')
	
	declare @chr59 nvarchar(50)=char(44)--char(59)
	declare @ordeno nvarchar(90)='' --越南訂單號
	--刪除已產生越南訂單
	if(len(@t_factno)>0 and len(@t_ip)>0 and len(@t_db)>0)
	begin
		set @cmd ="if ((select count(*) from ["+@t_ip+",1799]."+@t_db+".dbo.view_orde where memo2='"+@t_noa+"')>0)
		begin
			set @accy=isnull((select top 1 accy from ["+@t_ip+",1799]."+@t_db+".dbo.view_orde where memo2='"+@t_noa+"'),'"+@t_accy+"')
			set @ordeno=isnull((select top 1 noa from ["+@t_ip+",1799]."+@t_db+".dbo.view_orde where memo2='"+@t_noa+"'),'')
			
			--106/03/17 增加mess  condition=0
			--106/03/17 刪除sign
			EXEC('
				insert ["+@t_ip+",1799]."+@t_db+".dbo.mess (datea,qtime,tables,data,usera,act) 
				select replace(CONVERT (nvarchar(20) ,getdate(),20),''-'','''')
				,''"+@t_db+"''+replace(replace(replace(replace(CONVERT(nvarchar,SYSDATETIME()),''-'',''''),'':'',''''),''.'',''''),'' '','''')
				,''orde_post.post'',''"+@accy+@chr59+@ordeno+@chr59+"0'',''erp'',7
			')
			
			EXEC('
				delete ["+@t_ip+",1799]."+@t_db+".dbo.sign where zno=''"+@ordeno+"'' and fromdb!=''''
			')
			
			delete a from ["+@t_ip+",1799]."+@t_db+".dbo.ordes"+@accy+" a where a.noa=@ordeno
		end
		"
		--表頭不砍掉
		--delete ["+@t_ip+",1799]."+@t_db+".dbo.orde"+@accy+" where memo2='"+@t_noa+"'
		execute sp_executesql @cmd,N'@accy nvarchar(90) output,@ordeno nvarchar(90) output',@accy=@accy output,@ordeno=@ordeno output
		
	end
	
	set @custno=isnull((select custno from acomp where noa=isnull((select cno from view_orde where noa=@t_noa),'')),'')
	declare @berrcount table(counts int)
	--------------------------------------------------------
	--1060317 sign
	declare @signo nvarchar(MAX)
	declare @signum nvarchar(MAX)
	declare @sigmemo nvarchar(MAX)
	declare @signordememo nvarchar(MAX)
	declare @COLUMN nvarchar(MAX)
	set @sigmemo=isnull((select memo from signform a where form='orde'),'')
	declare cursor_table cursor for 
	SELECT COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS where TABLE_NAME='view_orde'
	open cursor_table 
	fetch next from cursor_table 
	into @COLUMN
	while(@@FETCH_STATUS <> -1) 
	begin
		if(@sigmemo like '%'+@COLUMN+'%')
			set @sigmemo=REPLACE(@sigmemo,@COLUMN,"'+cast("+@COLUMN+" as nvarchar)+'")
		fetch next from cursor_table 
		into @COLUMN
	end 
	close cursor_table 
	deallocate cursor_table
	
	set @sigmemo="'"+@sigmemo+"'"
	-----------------------------------------------------------
	
	--set @cmd ="select @t_custno=MAX(noa) from ["+@t_ip+",1799]."+@t_db+".dbo.cust where noa='"+@t_custno+"' "
	--execute sp_executesql @cmd,N'@t_custno nvarchar(90) output',@t_custno=@t_custno output
	
	set @cmd ="select top 1 @t_custno=custno from ["+@t_ip+",1799]."+@t_db+".dbo.acomp where dbname='"+@q_db+"' or not exists (select * from ["+@t_ip+",1799]."+@t_db+".dbo.acomp where dbname='"+@q_db+"')"
	execute sp_executesql @cmd,N'@t_custno nvarchar(90) output',@t_custno=@t_custno output
	
	--新的越南訂單單號
	if(len(@custno)>0 and len(@t_factno)>0 and len(@t_ip)>0 and len(@t_db)>0 and len(@t_custno)>0)
	begin
		if(LEN(@ordeno)=0)
		begin
			--set @cmd ="select @ordeno=MAX(noa) from ["+@t_ip+",1799]."+@t_db+".dbo.view_orde where noa like 'E'+REPLACE('"+@t_datea+"','/','')+'%'"
			--execute sp_executesql @cmd,N'@ordeno nvarchar(90) output',@ordeno=@ordeno output
			
			--set @ordeno='E'+REPLACE(@t_datea,'/','')+right('000'+cast(cast(RIGHT(isnull(@ordeno,'000'),3) as int)+1 as nvarchar(10)),3)

			--107/05/22 每間公司訂單號碼編號不同,以便後面識別,轉來後不用再重新編號(不會重複)
			set @ordeno=@t_noa
			
			--EXEC("insert ["+@t_ip+",1799]."+@t_db+".dbo.orde"+@accy+"
			--(noa,odate,stype,cno,acomp,custno,comp,nick,paytype,tel,fax,agentno,agent
			--,post,addr,post2,addr2,payterms,trantype,custorde,salesno,sales,taxtype
			--,money,tax,total,worker,isproj,memo,memo2,postname,custno2,cust2
			--,casetype,casemount,cuft,cuftnotv,date1,date2,date3,date4)
			--select '"+@ordeno+"','"+@t_datea+"','3',d.cno,d.acomp
			--,a.noa,a.comp,a.nick,a.paytype,a.tel,a.fax,b.agentno,b.agent
			--,a.zip_comp,a.addr_comp,a.zip_home,a.addr_home,b.payterms,a.trantype,d.custorde
			--,a.salesno,a.sales,b.taxtype,0,0,0,'"+@t_worker+"',1,'由"+@t_acomp+"訂單【"+@t_noa+"】轉來'
			--,'"+@t_noa+"' memo2,'"+@q_ip+"'+'##'+'"+@q_db+"'postname
			--,c.noa,case when isnull(c.nick,'')!='' then c.nick else c.comp end
			--,d.casetype,d.casemount,d.cuft,d.cuftnotv,d.date1,d.date2,d.date3,d.date4
			--from ["+@t_ip+",1799]."+@t_db+".dbo.cust a 
			--left join ["+@t_ip+",1799]."+@t_db+".dbo.custm b on a.noa=b.noa
			--outer apply (select * from ["+@t_ip+",1799]."+@t_db+".dbo.cust where noa='"+@custno+"' )c
			--outer apply (select top 1 * from view_orde where noa='"+@t_noa+"')d
			--where a.noa='"+@t_custno+"'
			--")
			
			--,(select top 1 noa from ["+@t_ip+",1799]."+@t_db+".dbo.acomp where noa='"+@t_cno+"' order by noa)cno
			--,(select top 1 acomp from ["+@t_ip+",1799]."+@t_db+".dbo.acomp where noa='"+@t_cno+"' order by noa )acomp
			
			--106/12/04 收款客戶為典盈
			--106/12/27 改為與典盈相同的客戶編號相同 當客戶編號不存在時幫其新增
			EXEC("insert ["+@t_ip+",1799]."+@t_db+".dbo.orde"+@accy+"
			(noa,odate,stype,cno,acomp,custno,comp,nick,paytype,tel,fax,agentno,agent
			,post,addr,post2,addr2,payterms,trantype,custorde,salesno,sales,taxtype
			,money,tax,total,worker,isproj,memo,memo2,postname,custno2,cust2
			,casetype,casemount,cuft,cuftnotv,date1,date2,date3,date4,enda,cancel)
			select '"+@ordeno+"','"+@t_datea+"','3',b.noa,b.acomp
			,a.custno,a.comp,a.nick,a.paytype,a.tel,a.fax,a.agentno,a.agent
			,a.post,a.addr,a.post2,a.addr2,a.payterms,a.trantype,a.custorde
			,a.salesno,a.sales,a.taxtype,0,0,0,'"+@t_worker+"',1,'由"+@t_acomp+"訂單【"+@t_noa+"】與採購單【"+@t_allordc+"】轉來chr(10)'+a.memo
			,'"+@t_noa+"' memo2,'"+@q_ip+"'+'##'+'"+@q_db+"'postname
			,c.custno,a.cust2,a.casetype,a.casemount,a.cuft,a.cuftnotv,a.date1,a.date2,a.date3,a.date4
			,a.enda,a.cancel
			from view_orde a
			outer apply (select top 1 * from ["+@t_ip+",1799]."+@t_db+".dbo.acomp where dbname='"+@t_db+"' or not exists (select * from ["+@t_ip+",1799]."+@t_db+".dbo.acomp where dbname='"+@t_db+"'))b
			outer apply (select top 1 * from ["+@t_ip+",1799]."+@t_db+".dbo.acomp where dbname='"+@q_db+"' or not exists (select * from ["+@t_ip+",1799]."+@t_db+".dbo.acomp where dbname='"+@q_db+"'))c
			where a.noa='"+@t_noa+"'
			")
		end
		else
		begin
			--EXEC("
			--update a
			--set custno=b.noa,comp=b.comp,nick=b.nick
			--,paytype=b.paytype,tel=b.tel,fax=b.fax,agentno=c.agentno,agent=c.agent
			--,post=b.zip_comp,addr=b.addr_comp,post2=b.zip_home,addr2=b.addr_home
			--,payterms=c.payterms,trantype=b.trantype,custorde=e.custorde
			--,salesno=b.salesno,sales=b.sales,taxtype=c.taxtype
			--,money=0,tax=0,total=0,worker2='"+@t_worker+"'
			--,custno2=d.noa,cust2=case when isnull(d.nick,'')!='' then d.nick else d.comp end
			--,casetype=e.casetype,casemount=e.casemount,cuft=e.cuft,cuftnotv=e.cuftnotv
			--,date1=e.date1,date2=e.date2,date3=e.date3,date4=e.date4
			--,cno=e.cno,acomp=e.acomp
			--from ["+@t_ip+",1799]."+@t_db+".dbo.orde"+@accy+" a 
			--outer apply (select * from ["+@t_ip+",1799]."+@t_db+".dbo.cust where noa='"+@t_custno+"')b
			--outer apply (select * from ["+@t_ip+",1799]."+@t_db+".dbo.custm where noa='"+@custno+"')c
			--outer apply (select * from ["+@t_ip+",1799]."+@t_db+".dbo.cust where noa='"+@custno+"' )d
			--outer apply (select top 1* from view_orde where noa='"+@t_noa+"')e
			--where a.noa='"+@ordeno+"'
			--")
			
			--106/12/04 收款客戶為典盈
			--106/12/27 改為與典盈相同的客戶編號相同 當客戶編號不存在時幫其新增
			EXEC("
			update a
			set custno=b.custno,comp=b.comp,nick=b.nick
			,paytype=b.paytype,tel=b.tel,fax=b.fax,agentno=b.agentno,agent=b.agent
			,post=b.post,addr=b.addr,post2=b.post2,addr2=b.addr2
			,payterms=b.payterms,trantype=b.trantype,custorde=b.custorde
			,salesno=b.salesno,sales=b.sales,taxtype=b.taxtype
			,money=0,tax=0,total=0,worker2='"+@t_worker+"'
			,custno2=d.custno,cust2=b.cust2
			,casetype=b.casetype,casemount=b.casemount,cuft=b.cuft,cuftnotv=b.cuftnotv
			,date1=b.date1,date2=b.date2,date3=b.date3,date4=b.date4
			,cno=c.noa,acomp=c.acomp,memo='由"+@t_acomp+"訂單【"+@t_noa+"】與採購單【"+@t_allordc+"】轉來chr(10)'+b.memo
			,enda=b.enda,cancel=b.cancel
			from ["+@t_ip+",1799]."+@t_db+".dbo.orde"+@accy+" a 
			outer apply (select top 1* from view_orde where noa='"+@t_noa+"')b
			outer apply (select top 1 * from ["+@t_ip+",1799]."+@t_db+".dbo.acomp where dbname='"+@t_db+"' or not exists (select * from ["+@t_ip+",1799]."+@t_db+".dbo.acomp where dbname='"+@t_db+"'))c
			outer apply (select top 1 * from ["+@t_ip+",1799]."+@t_db+".dbo.acomp where dbname='"+@q_db+"' or not exists (select * from ["+@t_ip+",1799]."+@t_db+".dbo.acomp where dbname='"+@q_db+"'))d
			where a.noa='"+@ordeno+"'
			")
		end
		
		--插入訂單不存在的客戶資料
		EXEC(" insert ["+@t_ip+",1799]."+@t_db+".dbo.cust(noa,comp,boss,conn,serial,salesno,sales,salesno2,sales2,tel,fax,mobile,addr_fact,addr_comp,addr_invo,addr_home,email,memo,post,ext,unit,task,start,uacc1,uacc2,uacc3,startdate,startn,mon,country,credit,chkdate,chkstatus,paytype,trantype,team,nick,head,typea,getdate,dueday,grpno,grpname,zip_fact,zip_comp,zip_invo,zip_home,status,keyin,worker,billmemo,invomemo,custno2,cust2,datea,invoicetitle,uacc4,conntel,connfax,kdate,isvccmon,profit,notprice,web,zip_fact2,addr_fact2,memo2)
		select noa,comp,boss,conn,serial,salesno,sales,salesno2,sales2,tel,fax,mobile,addr_fact,addr_comp,addr_invo,addr_home,email,memo,post,ext,unit,task,start,uacc1,uacc2,uacc3,startdate,startn,mon,country,credit,chkdate,chkstatus,paytype,trantype,team,nick,head,typea,getdate,dueday,grpno,grpname,zip_fact,zip_comp,zip_invo,zip_home,status,keyin,worker,billmemo,invomemo,custno2,cust2,datea,invoicetitle,uacc4,conntel,connfax,kdate,isvccmon,profit,notprice,web,zip_fact2,addr_fact2,memo2
		from cust a where exists (select * from view_orde where noa='"+@t_noa+"' and custno=a.noa)
		and not exists (select * from ["+@t_ip+",1799]."+@t_db+".dbo.cust where noa=a.noa)")
				
		--EXEC("insert ["+@t_ip+",1799]."+@t_db+".dbo.ordes"+@accy+"
		--(noa,no2,productno,product,spec,unit
		--,ucolor,scolor,class,classa,zinc,sizea,source,hard
		--,mount,sprice,price,total,payterms,packwayno,packway,cuft,c1,notv,memo
		--,quatno,no3,datea,enda,cancel,custno)
		--select '"+@ordeno+"',a.no2
		--,b.ucano,a.product,a.spec,a.unit
		--,a.ucolor,a.scolor,a.class,a.classa,a.zinc,a.sizea,a.source,a.hard
		--,a.mount,isnull(e.cost,0),isnull(e.price2,0),isnull(a.mount*e.price2,0),d.payterms
		--,a.packwayno,a.packway,a.cuft,0,a.mount,a.memo,a.noa,a.no2,a.datea,0,0,'"+@t_custno+"'
		--from view_ordes a left join ucx b on a.productno=b.noa 
		----outer apply (select top 1 tb.price from ucctgg ta left join ucctggs tb on ta.noa=tb.noa 
		----where ta.tggno=isnull((select tggno from factory where noa='"+@t_factno+"'),'') and tb.productno=a.productno order by ta.pricedate desc ) c
		--outer apply (select * from ["+@t_ip+",1799]."+@t_db+".dbo.custm where noa='"+@t_custno+"')d
		--outer apply (select top 1 * from ["+@t_ip+",1799]."+@t_db+".dbo.custprices where custno='"+@t_custno+"' and productno=b.ucano) e
		--where a.noa='"+@t_noa+"' and isnull(a.cancel,0)!=1 ")
		
		--106/12/04 收款客戶為典盈
		--106/12/27 改為與典盈相同的客戶編號相同 當客戶編號不存在時幫其新增
		EXEC("insert ["+@t_ip+",1799]."+@t_db+".dbo.ordes"+@accy+"
		(noa,no2,productno,product,spec,unit
		,ucolor,scolor,class,classa,zinc,sizea,source,hard
		,mount,sprice,price,total,payterms,packwayno,packway,cuft,c1,notv,memo
		,quatno,no3,datea,enda,cancel,custno)
		select '"+@ordeno+"',a.no2
		,b.ucano,a.product,a.spec,a.unit
		,a.ucolor,a.scolor,a.class,a.classa,a.zinc,a.sizea,a.source,a.hard
		,a.mount,isnull(e.cost,0),isnull(e.price2,0),isnull(a.mount*e.price2,0),a.payterms
		,a.packwayno,a.packway,a.cuft,0,a.mount,a.memo,a.noa,a.no2,a.datea,a.enda,a.cancel,a.custno
		from view_ordes a left join ucx b on a.productno=b.noa
		outer apply (select top 1 * from ["+@t_ip+",1799]."+@t_db+".dbo.acomp where dbname='"+@q_db+"' or not exists (select * from ["+@t_ip+",1799]."+@t_db+".dbo.acomp where dbname='"+@q_db+"'))c
		outer apply (select top 1 * from ["+@t_ip+",1799]."+@t_db+".dbo.custprices where custno=a.custno and productno=b.ucano) e
		where a.noa='"+@t_noa+"' ") --106/12/29 全部匯入 但根據訂單 顯示結案或取消 and isnull(a.cancel,0)!=1
		
		EXEC(" update ["+@t_ip+",1799]."+@t_db+".dbo.orde"+@accy+" 
		set money=isnull((select sum(total) from ["+@t_ip+",1799]."+@t_db+".dbo.view_ordes where noa='"+@ordeno+"'),0) 
		,total=isnull((select sum(total) from ["+@t_ip+",1799]."+@t_db+".dbo.view_ordes where noa='"+@ordeno+"'),0) 
		where noa='"+@ordeno+"'")
		
		--106/03/17 增加mess condition=1
		EXEC("
			insert ["+@t_ip+",1799]."+@t_db+".dbo.mess (datea,qtime,tables,data,usera,act) 
			select replace(CONVERT (nvarchar(20) ,getdate(),20),'-','')
			,'"+@t_db+"'+replace(replace(replace(replace(CONVERT(nvarchar,SYSDATETIME()),'-',''),':',''),'.',''),' ','')
			,'orde_post.post','"+@accy+@chr59+@ordeno+@chr59+"1','erp',7
		")
		
		--106/03/17 增加sign
		set @signo=replace(CONVERT (nvarchar(10) ,getdate(),20),'-','')
		set @signum=isnull((select top 1 noa from sign where noa like @signo+'%' order by noa desc),'00000')
		
		set @signum=right('00000'+CAST(CAST(@signum as int)+1 as nvarchar(50)),5)
		set @signo=@signo+@signum
		
		set @cmd ="select @signordememo="+@sigmemo+" from view_orde where noa='"+@ordeno+"'"
		execute sp_executesql @cmd,N'@signordememo nvarchar(MAX) output',@signordememo=@signordememo output
		
		EXEC("insert ["+@t_ip+",1799]."+@t_db+".dbo.sign (noa,datea,timea,enda,memo,form,partno,part,sender,zno,zno2
		,checker,memochecker,worker,fromdb)
		select '"+@signo+"','"+@t_datea+"',left(right(replace(CONVERT (nvarchar(20) ,getdate(),20),'-',''),8),5)
		,'N','"+@signordememo+"',formname,partno,part,'"+@t_worker+"','"+@ordeno+"','orde_r'+CHAR(59)+'noa'+CHAR(59)+'"+@accy+"'
		,checker,'','"+@t_worker+"',b.value
		from signform a
		outer apply(select top 1 value from qsys where noa='sys.ip') b
		where form='orde'")
		
		insert @berrcount
		EXEC("select count(*) from (
		select b.productno,b.price price1,0 price2 from view_ordc a left join view_ordcs b on a.noa=b.noa where quatno='"+@t_noa+"'
		union all
		select b.noa,0,isnull(e.price2,0) from view_ordes a left join ucx b on a.productno=b.noa 
		outer apply (select top 1 * from ["+@t_ip+",1799]."+@t_db+".dbo.custprices where custno='"+@t_custno+"' and productno=b.ucano) e
		where a.noa='"+@t_noa+"'
		)tmp group by productno having MAX(price1)!=MAX(price2)")
		
		if((select count(*) from @berrcount)>0)
		begin
			set @berr='轉Factory產品單價不同!!'
		end
	end
	else 
	begin
		if(len(isnull(@custno,''))=0)
			set @berr='Factory訂單不產生(客戶不存在)!!'
		else if(len(isnull(@t_factno,''))=0)
			set @berr='Factory訂單不產生(Factory【'+@t_factno+'】的ID不存在)!!'
		else if(len(isnull(@t_ip,''))=0)
			set @berr='Factory訂單不產生(Factory【'+@t_factno+'】的IP設定不正確)!!'
		else if(len(isnull(@t_db,''))=0)
			set @berr='Factory訂單不產生(Factory【'+@t_factno+'】的DB設定不正確)!!'
		else if(len(isnull(@t_custno,''))=0)
		begin
			--set @t_custno = isnull((select custno from view_orde a where noa=@t_noa),'')
			set @berr='Factory訂單不產生(Factory【'+@t_factno+'】在【"+@t_db+"】的《公司主檔》的【對應客戶編號】沒有設定)!!'
		end
	end
	
	--更新orde的採購單號
	set @accy=isnull((select top 1 accy from view_orde where noa=@t_noa),@t_accy)
	EXEC("update orde"+@accy+" set ordcno=isnull(stuff((select ','+noa from view_ordc where quatno='"+@t_noa+"' FOR XML PATH('')),1,1,''),'') 
	,memo2='"+@ordeno+"'
	where noa='"+@t_noa+"' ")
	
	--Commit Transaction
END TRY
BEGIN CATCH
	--ROLLBACK
	set @err='產生錯誤請聯絡工程師!!'
	set @berr=''
	set @ordeno=''
	BEGIN TRY
		close cursor_table
		deallocate cursor_table
	END TRY
	BEGIN CATCH
	END CATCH
END CATCH

--回傳採購單號
select @err+@berr err,isnull(stuff((select ','+noa from view_ordc where quatno=@t_noa FOR XML PATH('')),1,1,''),'') ordcno,@ordeno ordeno

IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
	set @cmd = 'drop table #tmp'
	EXECUTE sp_executesql @cmd
END
;
--------------------------------------------------------------------------------------------------------------------------------------------------------
ordetoumm:--ordetoumm
SET QUOTED_IDENTIFIER OFF
declare @year nvarchar(20)=[1]--年度[1]
declare @noa nvarchar(20)=[2]--單據編號[2]
declare @condition nvarchar(20)=[3]--動作 0 刪除, 1 新增[3]
declare @ummkey nvarchar(20)=[4] --ummkey
declare @project nvarchar(20)=[5] --客戶專案
declare @userno nvarchar(20)=[6] --userno
-----------------------------------------------------------------
declare @accy nvarchar(20)
declare @ummno nvarchar(20)=isnull((select ummno from view_orde where noa=@noa),'')
declare @odate nvarchar(20)=isnull((select odate from view_orde where noa=@noa),'')
set @accy=isnull((select accy from view_orde where noa=@noa),@year)

if(@condition='0')
begin
	delete umm where noa=@ummno
	delete umms where noa=@ummno
end

if(@condition='1')
begin
	if(@ummno='')
	begin
		declare @ummnoa nvarchar(20)=isnull((select MAX(noa) from umm where noa like @ummkey+replace(@odate,'/','')+'%'),'000')
		declare @ummnob nvarchar(20)=isnull((select MAX(noa) from dno where tablea='umm' and noa like @ummkey+replace(@odate,'/','')+'%'),'000')
		if(@ummnoa='' and @ummnob='')
		begin
			set @ummno=@ummkey+replace(@odate,'/','')+'001'
		end
		else
		begin
			if(@ummnoa>@ummnob)
				set @ummno=@ummnoa
			else 
				set @ummno=@ummnob
			
			set @ummno=@ummkey+replace(@odate,'/','')+right('000'+cast(cast(RIGHT(@ummno,3) as int)+1 as nvarchar(10)),3)
		end
	end
	
	insert into umms (noa,noq,paymon,custno,acc1,acc2,money,cno,memo2,vccno,paysale,datea)
	select @ummno,'001','',custno,acc1,acc2,deposit,'','','',0,odate
	from view_orde where noa=@noa
	
	insert into umm (noa,custno,comp,datea,mon,paysale,total,sale,opay,memo,accno,cno)
	select @ummno,custno,comp,odate,left(odate,len(odate)-3),0,deposit,0,deposit,'由訂單'+noa+'轉來','',cno
	from view_orde where noa=@noa
	
	insert into dno(tablea,noa,usera,mech)
	select 'umm',@ummno,@userno,replace(convert(varchar,GETDATE(),20),'-','/')
	
	EXEC("update orde"+@accy+" set ummno='"+@ummno+"' where noa='"+@noa+"'")
	
end

select @ummno ummno
;