z_car21:--z_car21
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_bcarno nvarchar(20)
	declare @t_ecarno nvarchar(20)
	declare @t_sssno nvarchar(20)
	declare @t_order nvarchar(20)
	
	set @t_bdate = case when '#non'=[3] then '' else [3] end
	set @t_edate = case when '#non'=[4] then char(255) else [4] end
	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_bcarno = case when '#non'=[16] then '' else [16] end
	set @t_ecarno  = case when '#non'=[17] then char(255) else [17] end	
	set @t_sssno  = case when '#non'=[24] then char(255) else [24] end	
	set @t_order = case when '#non'=[31] then '車行' else [31] end	

--*********************************************************************************** 

	declare @tmp table( 
		gno nvarchar(1), 
		recno int identity(1,1),--順序 
		checkdate nvarchar(10),--驗車日期 
		carno nvarchar(20),--車牌號碼 
		carowner nvarchar(20),--車主 
		passdate nvarchar(10),--發照日期 
		caryeartw nvarchar(10),--出廠 
		carbrand nvarchar(20),--廠牌 
		insurance nvarchar(10),--保險止日 
		cardeal nvarchar(20),--車行
		notice nvarchar(10)--通知  
	) 
	declare @cmd nvarchar(MAX)
--ROW_NUMBER()over(order by (case when len(@t_bdate+@t_edate)=0 then LEFT(a.checkdate,6) else a.checkdate end),a.carno)
set @cmd='select ''0'' gno, 
a.checkdate, a.carno, b.namea, a.passdate, a.caryeartw, c.brand, d.edate, e.nick ,a.notice
from car2 a 
left join carowner b on a.carownerno = b.noa 
left join carbrand c on a.carbrandno = c.noa 
left join (select noa,MAX(case when len(stopdate)>0 then stopdate else edate end) edate from carInsure group by noa) as d on a.carno = d.noa 
left join cardeal e on a.cardealno = e.noa 
where (a.checkdate between @t_bdate and @t_edate) and 
(a.cardealno between @t_bcardealno and @t_ecardealno) and 
(a.carownerno between @t_bcarownerno and @t_ecarownerno) and 
(a.carno between @t_bcarno and @t_ecarno) and 
a.carownerno!='''' and (a.enddate='''' or a.enddate is null) and (a.outdate='''' or a.outdate is null) and (a.wastedate='''' or a.wastedate is null)and (a.suspdate='''' or a.suspdate is null)' 

--婉容說不要顯示報停20130603

declare @ssscount int
set @ssscount=0

if(@t_sssno!=char(255))
begin
	while(PATINDEX('%,%',@t_sssno)>0)
	begin
		if (@ssscount=0)
			set @cmd=@cmd+' and (a.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		else
			set @cmd=@cmd+' or a.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		set @t_sssno=RIGHT(@t_sssno,LEN(@t_sssno)-PATINDEX('%,%',@t_sssno))
		set @ssscount=@ssscount+1
	end
	if (@ssscount=0)
		set @cmd=@cmd+' and a.sssno='''+@t_sssno+''''
	else
		set @cmd=@cmd+' or a.sssno='''+@t_sssno+''')'
end
	
if(@t_order='車行')
	set @cmd=@cmd+' order by a.cardealno,a.checkdate'
if(@t_order='車主')
	set @cmd=@cmd+' order by b.namea,a.checkdate'
if(@t_order='驗車日期')
	set @cmd=@cmd+' order by a.checkdate,a.noa'

insert into @tmp 
execute sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bcardealno nvarchar(20),@t_ecardealno nvarchar(20),@t_bcarownerno nvarchar(20),@t_ecarownerno nvarchar(20),@t_bcarno nvarchar(20),@t_ecarno nvarchar(20)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bcardealno=@t_bcardealno,@t_ecardealno=@t_ecardealno,@t_bcarownerno=@t_bcarownerno,@t_ecarownerno=@t_ecarownerno,@t_bcarno=@t_bcarno,@t_ecarno=@t_ecarno

--*********************************************************************************** 
select * from @tmp;
--******************************************************************************************************
z_car22:--z_car22
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_enddate nvarchar(10)
	
	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_enddate = case when '#non'=[15] then '' else [15] end

	declare @tmp table(
		cardealno nvarchar(20),
		cardeal nvarchar(50),
		carownerno nvarchar(20),
		carowner nvarchar(50),
		lenderno nvarchar(20),
		lender nvarchar(50),
		money int,
		installmentamount int,
		installment int,
		bkmoney int,
		surplusment int,
		surplusmoney int, 
		date nvarchar(50),
		memo nvarchar(MAX),
		carnos nvarchar(MAX)
		
)
--20130903睿庭貸款止日>截止日期就不顯示,且車子有遷出.報廢.繳銷也不顯示
--case說明--如果貸款止日>截止日期表示還沒還清否則已還清，沒有還清則計算剩餘還款期數(如果今天日期<計日，表示當期還沒還款，所以+1)
insert into @tmp
select a.cardealno,a.cardeal,a.noa,b.namea,a.lenderno,a.lender,a.money,a.installmentamount,a.installment,a.bkmoney,
case when a.edate > @t_enddate then
(left(a.edate,3)*12+right(left(a.edate,6),2))-(left(@t_enddate,3)*12+right(left(@t_enddate,6),2))+(case when cast(right(@t_enddate,2) as int)<=cast(a.day as int) then 1 else 0 end) else 0 end surplusment,
0 surplusmoney,a.bdate+' - '+a.edate date,a.memo,a.carnos
from carLender a left join carOwner b on a.noa=b.noa 
where (a.cardealno between @t_bcardealno and @t_ecardealno) and (a.noa between @t_bcarownerno and @t_ecarownerno)
and a.edate>@t_enddate 
and (select COUNT(*) from car2 where CHARINDEX(noa,a.carnos)>0 and (outdate='' or outdate is null ) and (enddate='' or enddate is null) and (wastedate='' or wastedate is null))>0
order by a.cardealno,a.noa,bdate desc
--計算貸款餘額
update @tmp
set surplusmoney=surplusment*installmentamount
where surplusment>0

--select * from @tmp
----------------------------------------------------------------------------------
declare @result table(
		gno nvarchar(1),
		cardealno nvarchar(20),
		cardeal nvarchar(50),
		carownerno nvarchar(20),
		carowner nvarchar(50),
		lenderno nvarchar(20),
		lender nvarchar(50),
		money int,
		installmentamount int,
		installment int,
		bkmoney int,
		surplusment int,
		surplusmoney int, 
		date nvarchar(50),
		memo nvarchar(MAX),
		carno nvarchar(MAX)
)

declare @cardealno nvarchar(20)
declare @cardeal nvarchar(50)
declare @carownerno nvarchar(20)
declare @carowner nvarchar(50)
declare @lenderno nvarchar(20)
declare @lender nvarchar(50)
declare @money int
declare @installmentamount int
declare @installment int
declare @bkmoney int
declare @surplusment int
declare @surplusmoney int
declare @date nvarchar(50)
declare @memo nvarchar(MAX)
declare @carnos nvarchar(MAX)
declare @count int

	declare cursor_table cursor for
	select cardealno,cardeal,carownerno,carowner,lenderno,lender,money,installmentamount,installment,bkmoney,surplusment,surplusmoney,date,memo,carnos from @tmp
	open cursor_table
	fetch next from cursor_table
	into @cardealno,@cardeal,@carownerno,@carowner,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,@carnos
	while(@@FETCH_STATUS <> -1)
	begin
		if(len(@carnos)>0)
		begin
			set @count=1
			while(@count>0)
			begin
				if(CHARINDEX(',',@carnos)=0)
				begin
					if(@count>1)
					begin
						insert into @result
						select '0',null,null,null,null,null,null,null,null,null,null,null,null,null,null,@carnos
					end
					else
					begin
						insert into @result
						select '0',@cardealno,@cardeal,@carownerno,@carowner,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,@carnos
					end
					
					set @count=0
				end
				else
				begin
					if(@count>1)
					begin
						insert into @result
						select '0',null,null,null,null,null,null,null,null,null,null,null,null,null,null,SUBSTRING(@carnos,0,CHARINDEX(',',@carnos))
					end
					else
					begin
						insert into @result
						select '0',@cardealno,@cardeal,@carownerno,@carowner,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,SUBSTRING(@carnos,0,CHARINDEX(',',@carnos))
					end
					set @carnos=SUBSTRING(@carnos,CHARINDEX(',',@carnos)+1,len(@carnos))
					set @count=@count+1
				end	
			end
		end
		else
		begin
			insert into @result
			select '0',@cardealno,@cardeal,@carownerno,@carowner,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,@carnos
		end
		insert into @result
		select '1',null,null,null,null,null,null,null,null,null,null,null,null,null,null,null
		
		fetch next from cursor_table
		into @cardealno,@cardeal,@carownerno,@carowner,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,@carnos
	end
	close cursor_table
	deallocate cursor_table
	
	insert into @result
	select '2',null,null,null,null,null,null,null,null,null,null,null,sum(surplusmoney),null,null,null
	from @result
	
	select a.gno,a.carownerno,a.carowner,a.cardealno,left(a.cardeal,3)cardeal,a.lenderno,left(a.lender,3)lender,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.money),1)),4,12)) money,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.installmentamount),1)),4,12)) installmentamount,a.installment,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.bkmoney),1)),4,12)) bkmoney,a.surplusment,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.surplusmoney),1)),4,12)) surplusmoney,a.date,a.memo,a.carno,
	c.brand,b.caryear from @result a left join car2 b on a.carno=b.noa left join carbrand c on b.carbrandno=c.noa;

--********************************************************************************************************************
z_car24:--z_car24
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_enddate nvarchar(10)
	
	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_enddate = case when '#non'=[15] then '' else [15] end

	declare @tmp table(
		cardealno nvarchar(20),
		cardeal nvarchar(50),
		carownerno nvarchar(20),
		carowner nvarchar(50),
		lenderno nvarchar(20),
		lender nvarchar(50),
		money int,
		installmentamount int,
		installment int,
		bkmoney int,
		surplusment int,
		surplusmoney int, 
		date nvarchar(50),
		memo nvarchar(MAX),
		carnos nvarchar(MAX)
		
)
--20130903睿庭貸款止日>截止日期就不顯示,且車子有遷出.報廢.繳銷也不顯示
--case說明--如果貸款止日>截止日期表示還沒還清否則已還清，沒有還清則計算剩餘還款期數(如果今天日期<計日，表示當期還沒還款，所以+1)
insert into @tmp
select a.cardealno,a.cardeal,a.noa,b.namea,a.lenderno,a.lender,a.money,a.installmentamount,a.installment,a.bkmoney,
case when a.edate > @t_enddate then
(left(a.edate,3)*12+right(left(a.edate,6),2))-(left(@t_enddate,3)*12+right(left(@t_enddate,6),2))+(case when cast(right(@t_enddate,2)as int)<=cast(a.day AS int) then 1 else 0 end) else 0 end surplusment,
0 surplusmoney,a.bdate+' - '+a.edate date,a.memo,a.carnos
from carLender a left join carOwner b on a.noa=b.noa
where (a.cardealno between @t_bcardealno and @t_ecardealno) and (a.noa between @t_bcarownerno and @t_ecarownerno)
and a.edate>@t_enddate 
and (select COUNT(*) from car2 where CHARINDEX(noa,a.carnos)>0 and (outdate='' or outdate is null ) and (enddate='' or enddate is null) and (wastedate='' or wastedate is null))>0
order by a.noa

--計算貸款餘額
update @tmp
set surplusmoney=surplusment*installmentamount
where surplusment>0

--select * from @tmp
----------------------------------------------------------------------------------
declare @result table(
		gno nvarchar(1),
		carownerno nvarchar(20),
		carowner nvarchar(50),
		cardealno nvarchar(20),
		cardeal nvarchar(50),
		lenderno nvarchar(20),
		lender nvarchar(50),
		money int,
		installmentamount int,
		installment int,
		bkmoney int,
		surplusment int,
		surplusmoney int, 
		date nvarchar(50),
		memo nvarchar(MAX),
		carno nvarchar(MAX)
)

declare @cardealno nvarchar(20)
declare @cardeal nvarchar(50)
declare @carownerno nvarchar(20)
declare @t_carownerno nvarchar(20) 
declare @carowner nvarchar(50)
declare @lenderno nvarchar(20)
declare @lender nvarchar(50)
declare @money int
declare @installmentamount int
declare @installment int
declare @bkmoney int
declare @surplusment int
declare @surplusmoney int
declare @date nvarchar(50)
declare @memo nvarchar(MAX)
declare @carnos nvarchar(MAX)
declare @count int

set @t_carownerno='XXXX'

	declare cursor_table cursor for
	select cardealno,cardeal,carownerno,carowner,lenderno,lender,money,installmentamount,installment,bkmoney,surplusment,surplusmoney,date,memo,carnos from @tmp
	open cursor_table
	fetch next from cursor_table
	into @cardealno,@cardeal,@carownerno,@carowner,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,@carnos
	while(@@FETCH_STATUS <> -1)
	begin
	
		if(@carownerno!=@t_carownerno and @t_carownerno!='XXXX')
		begin
			insert into @result 
			select '2',@t_carownerno,null,null,null,null,null,null,null,null,null,null,sum(surplusmoney),null,null,null from @tmp where carownerno=@t_carownerno
		end
		set @t_carownerno=@carownerno
	
		if(len(@carnos)>0)
		begin
			set @count=1
			while(@count>0)
			begin
				if(CHARINDEX(',',@carnos)=0)
				begin
					if(@count>1)
					begin
						insert into @result
						select '0',@carownerno,null,null,null,null,null,null,null,null,null,null,null,null,null,@carnos
					end
					else
					begin
						insert into @result
						select '0',@carownerno,@carowner,@cardealno,@cardeal,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,@carnos
					end
					
					set @count=0
				end
				else
				begin
					if(@count>1)
					begin
						insert into @result
						select '0',@carownerno,null,null,null,null,null,null,null,null,null,null,null,null,null,SUBSTRING(@carnos,0,CHARINDEX(',',@carnos))
					end
					else
					begin
						insert into @result
						select '0',@carownerno,@carowner,@cardealno,@cardeal,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,SUBSTRING(@carnos,0,CHARINDEX(',',@carnos))
					end
					set @carnos=SUBSTRING(@carnos,CHARINDEX(',',@carnos)+1,len(@carnos))
					set @count=@count+1
				end	
			end
		end
		else
		begin
			insert into @result
			select '0',@carownerno,@carowner,@cardealno,@cardeal,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,@carnos
		end
		insert into @result
		select '1',@carownerno,null,null,null,null,null,null,null,null,null,null,null,null,null,null
		
		fetch next from cursor_table
		into @cardealno,@cardeal,@carownerno,@carowner,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,@carnos
	end
	
	insert into @result 
	select '2',@t_carownerno,null,null,null,null,null,null,null,null,null,null,sum(surplusmoney),null,null,null from @tmp where carownerno=@t_carownerno
	
	close cursor_table
	deallocate cursor_table
	
	insert into @result 
	select '3',@t_carownerno,null,null,null,null,null,null,null,null,null,null,sum(surplusmoney),null,null,null from @result where gno='2'

	select a.gno,a.carownerno,a.carowner,a.cardealno,left(a.cardeal,3)cardeal,a.lenderno,left(a.lender,3)lender,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.money),1)),4,12)) money,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.installmentamount),1)),4,12)) installmentamount,a.installment,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.bkmoney),1)),4,12)) bkmoney,a.surplusment,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.surplusmoney),1)),4,12)) surplusmoney,a.date,a.memo,a.carno,
	c.brand,b.caryear from @result a left join car2 b on a.carno=b.noa left join carbrand c on b.carbrandno=c.noa;
--********************************************************************************************************************

--**************************************************************************************************************************************
z_car25:--z_car25高額欠款追蹤依車號
	declare @t_bcarno nvarchar(20)
	declare @t_ecarno nvarchar(20)
	declare @t_xmon nvarchar(10)
	declare @t_sssno nvarchar(20)
	declare @t_bmoney int
	declare @t_emoney int
	declare @t_order nvarchar(20)
	
	set @t_bcarno = case when '#non'=[16] then '' else [16] end
	set @t_ecarno  = case when '#non'=[17] then char(255) else [17] end
	set @t_xmon  = case when '#non'=[18] then '' else [18] end
	set @t_sssno  = case when '#non'=[24] then char(255) else [24] end	
	set @t_bmoney = case when '#non'=[26] then -99999999 else [26] end
	set @t_emoney  = case when '#non'=[27] then 99999999 else [27] end	
	set @t_order = case when '#non'=[28] then '車號' else [28] end
--************************************************************************************
SET QUOTED_IDENTIFIER OFF
declare @result table(
		gno nvarchar(1),
		recno int IDENTITY(1,1),
		noa nvarchar(20),
		mon nvarchar(10),
		carno nvarchar(20),
		carownerno nvarchar(20),
		carowner nvarchar(20),
		cardealno nvarchar(20),
		cardeal nvarchar(20),
		indate nvarchar(10),
		caryear nvarchar(10),
		carbrandno nvarchar(20),
		carbrand nvarchar(20),
		tel nvarchar(50),
		mobile nvarchar(50),
		total float
)
declare @cmd nvarchar(MAX)

set @cmd='select ''0'' gno,isnull(e.noa,''''),isnull(e.mon,''''),isnull(e.carno,''''),a.carownerno,b.namea,a.cardealno,ISNULL(c.nick,''''),a.indate,a.caryear,a.carbrandno, 
isnull(d.brand,''''),b.tel1,b.mobile,isnull(e.total,0) 
from car2 a 
left join carOwner b on b.noa = a.carownerno 
left join cardeal c on c.noa = a.cardealno 
left join carbrand d on d.noa = a.carbrandno 
left join cara e on e.carno = a.carno 
where (e.mon=@t_xmon) and (e.carno between @t_bcarno and @t_ecarno)  and 
a.carownerno!='''' and (total between @t_bmoney and @t_emoney) 
and a.carownerno!=''H003'' and a.carownerno!=''H264'' and a.carownerno!=''H326''
and a.carownerno!=''H273'' and a.carownerno!=''H249'' and a.carownerno!=''H041'' 
and a.noa!=''1111'' and a.noa!=''1120'' and a.noa!=''1122'''

declare @ssscount int
set @ssscount=0

if(@t_sssno!=char(255))
begin
	while(PATINDEX('%,%',@t_sssno)>0)
	begin
		if (@ssscount=0)
			set @cmd=@cmd+' and (a.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		else
			set @cmd=@cmd+' or a.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		set @t_sssno=RIGHT(@t_sssno,LEN(@t_sssno)-PATINDEX('%,%',@t_sssno))
		set @ssscount=@ssscount+1
	end
	if (@ssscount=0)
		set @cmd=@cmd+' and a.sssno='''+@t_sssno+''''
	else
		set @cmd=@cmd+' or a.sssno='''+@t_sssno+''')'
end

if(@t_order='車號')
set @cmd=@cmd+' order by e.carno,total desc,gno'
if(@t_order='金額')
set @cmd=@cmd+' order by total desc,e.carno,gno'

insert into @result 
execute sp_executesql @cmd,N'@t_xmon nvarchar(10),@t_bcarno nvarchar(20),@t_ecarno nvarchar(20),@t_bmoney int,@t_emoney int',
		@t_xmon=@t_xmon,@t_bcarno=@t_bcarno,@t_ecarno=@t_ecarno,@t_bmoney=@t_bmoney,@t_emoney=@t_emoney

--20130327加入vcc未付金額
--declare @carno nvarchar(50)
--declare @unpay float
--set @cmd="
--	declare cursor_table cursor for 
--	select carno,sum(unpay) unpay from (select (case when (select count(*) from car2 where noa=substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0
--	then substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))else
--	(select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by mon desc,carno)end) 
--	carno,isnull(a.total-a.payed,0) unpay 
--	from vcc"+left(@t_xmon,3)+" a left join car2 b on 
--	(case when (select count(*) from car2 where noa=substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0
--	then substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))else
--	(select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by mon desc,carno)end)=b.noa 
--	left join carbrand d on b.carbrandno=d.noa 
--	left join carOwner e on a.custno=e.noa 
--	where left(a.custno,1)='H' and (left(a.carno,6) <= '"+@t_xmon+"')) a group by carno"
--	execute sp_executesql @cmd

--open cursor_table 
--fetch next from cursor_table 
--into @carno,@unpay
--while(@@FETCH_STATUS <> -1) 
--	begin 
--		update @result
--		set total=total+@unpay
--		where carno=@carno
		
--		fetch next from cursor_table 
--		into @carno,@unpay
--	end 
--close cursor_table 
--deallocate cursor_tabl

insert into @result 
select '2' gno,'','',CHAR(255),'','','','','','','','','','',SUM(total) 
from @result 
where gno != 1 

select gno,recno,noa,mon,carno,carownerno,carowner,cardealno,cardeal,indate,caryear,carbrandno,carbrand,tel,mobile,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total
from @result order by recno; 

--**********************************************************************************

z_car26:--z_car26高額欠款追蹤依車主
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_xmon nvarchar(10)
	declare @t_sssno nvarchar(20)
	declare @t_bmoney int
	declare @t_emoney int
	declare @t_order nvarchar(20)
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_xmon  = case when '#non'=[18] then '' else [18] end
	set @t_sssno  = case when '#non'=[24] then char(255) else [24] end
	set @t_bmoney = case when '#non'=[26] then -99999999 else [26] end
	set @t_emoney  = case when '#non'=[27] then 99999999 else [27] end
	set @t_order = case when '#non'=[29] then '車主' else [29] end	
	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
		
--************************************************************************************
SET QUOTED_IDENTIFIER OFF
declare @result table(
		gno nvarchar(1),
		recno int IDENTITY(1,1),
		noa nvarchar(20),
		mon nvarchar(10),
		carno nvarchar(20),
		carownerno nvarchar(20),
		carowner nvarchar(20),
		cardealno nvarchar(20),
		cardeal nvarchar(20),
		indate nvarchar(10),
		caryear nvarchar(10),
		carbrandno nvarchar(20),
		carbrand nvarchar(20),
		tel nvarchar(50),
		mobile nvarchar(50),
		total float
)
declare @cmd nvarchar(MAX)

set @cmd='select ''0'' gno,isnull(e.noa,''''),isnull(e.mon,''''),isnull(e.carno,''''),a.carownerno
,b.namea,a.cardealno,ISNULL(c.nick,''''),a.indate,a.caryear,a.carbrandno,isnull(d.brand,'''')
,b.tel1,b.mobile,isnull(e.total,0)
from car2 a left join carOwner b on b.noa = a.carownerno
left join  cardeal c on c.noa = a.cardealno
left join carbrand d on d.noa = a.carbrandno
left join cara e on e.carno = a.carno
where (e.mon=@t_xmon) and (isnull(a.carownerno,'''') between @t_bcarownerno and @t_ecarownerno)
and (isnull(a.cardealno,'''') between @t_bcardealno and @t_ecardealno)  
and a.carownerno!='''' and a.carownerno!=''H003'' and a.carownerno!=''H264'' and a.carownerno!=''H326''
and a.carownerno!=''H273'' and a.carownerno!=''H249'' and a.carownerno!=''H041'' and a.noa!=''1111'' and a.noa!=''1120'' and a.noa!=''1122'''

declare @ssscount int
set @ssscount=0

if(@t_sssno!=char(255))
begin
	while(PATINDEX('%,%',@t_sssno)>0)
	begin
		if (@ssscount=0)
			set @cmd=@cmd+' and (e.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		else
			set @cmd=@cmd+' or e.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		set @t_sssno=RIGHT(@t_sssno,LEN(@t_sssno)-PATINDEX('%,%',@t_sssno))
		set @ssscount=@ssscount+1
	end
	if (@ssscount=0)
		set @cmd=@cmd+' and e.sssno='''+@t_sssno+''''
	else
		set @cmd=@cmd+' or e.sssno='''+@t_sssno+''')'
end

if(@t_order='車主') 
	set @cmd=@cmd+' order by b.namea'

insert into @result
execute sp_executesql @cmd,N'@t_xmon nvarchar(10),@t_bcarownerno nvarchar(20),@t_ecarownerno nvarchar(20),@t_bcardealno nvarchar(20),@t_ecardealno nvarchar(20)',
		@t_xmon=@t_xmon,@t_bcarownerno=@t_bcarownerno,@t_ecarownerno=@t_ecarownerno
		,@t_bcardealno=@t_bcardealno, @t_ecardealno=@t_ecardealno

--20130327加入vcc未付金額
--declare @carownerno nvarchar(50)
--declare @unpay float
--set @cmd="
--	declare cursor_table cursor for
--	select carownerno,sum(unpay) unpay from (
--	select b.carownerno carownerno,isnull(a.total-a.payed,0) unpay 
--	from vcc"+left(@t_xmon,3)+" a left join car2 b on 
--	(case when (select count(*) from car2 where noa=substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0
--	then substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))else
--	(select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by mon desc,carno)end)=b.noa 
--	left join carbrand d on b.carbrandno=d.noa 
--	left join carOwner e on a.custno=e.noa 
--	where left(a.custno,1)='H' and (left(a.carno,6) <= '"+@t_xmon+"')) a group by carownerno"
--	execute sp_executesql @cmd
	
--open cursor_table 
--fetch next from cursor_table 
--into @carownerno,@unpay
--while(@@FETCH_STATUS <> -1) 
--	begin 
--		update @result
--		set total=total+@unpay
--		where carownerno=@carownerno
		
--		fetch next from cursor_table 
--		into @carownerno,@unpay
--	end 
--close cursor_table 
--deallocate cursor_table 

if(@t_order='車主')
	begin
		insert into @result
		select '1' gno,'',mon,'',carownerno,carowner,'','','','','','','','',SUM(total)
		from @result
		group by carownerno,carowner,mon
		
		delete @result
		where carownerno in(select carownerno from @result where gno=1 and (total not between @t_bmoney and @t_emoney))
		
		insert into @result
		select '2' gno,'','','','',CHAR(255),'','','','','','','','',SUM(total)
		from @result
		where (gno = 1)
		
		select gno,recno,noa,mon,carno,carownerno xcarownerno,carowner,cardealno,cardeal,indate,caryear,carbrandno,carbrand 
		,substring(dbo.charbr(tel,12),0,case when CHARINDEX('<BR>',dbo.charbr(tel,12))=0 then len(tel)+1 else CHARINDEX('<BR>',dbo.charbr(tel,12)) end) tel
		,substring(dbo.charbr(mobile,12),0,case when CHARINDEX('<BR>',dbo.charbr(mobile,12))=0 then len(mobile)+1 else CHARINDEX('<BR>',dbo.charbr(mobile,12)) end) mobile,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total
		from @result
		order by carowner,gno
	end
if(@t_order='金額')
	begin
	
		declare @tmp table(
			gno nvarchar(1),
			recno int IDENTITY(1,1),
			noa nvarchar(20),
			mon nvarchar(10),
			carno nvarchar(20),
			carownerno nvarchar(20),
			carowner nvarchar(20),
			cardealno nvarchar(20),
			cardeal nvarchar(20),
			indate nvarchar(10),
			caryear nvarchar(10),
			carbrandno nvarchar(20),
			carbrand nvarchar(20),
			tel nvarchar(50),
			mobile nvarchar(50),
			total float
		)
		declare @t_carownerno nvarchar(30)
		declare @t_total int

		declare cursor_table cursor for 
		select carownerno,SUM(total)from @result group by carownerno order by sum(total) desc
		open cursor_table 
		fetch next from cursor_table 
		into @t_carownerno,@t_total
		while(@@FETCH_STATUS <> -1) 
			begin 
			insert into @tmp
			select gno,noa,mon,carno,carownerno,carowner,cardealno,cardeal,indate,caryear
			,carbrandno,carbrand,tel,mobile,total float from @result where carownerno=@t_carownerno
			
			insert into @tmp
			select '1' gno,'','','',@t_carownerno,'','','','','','','','','',@t_total
			
			fetch next from cursor_table 
			into @t_carownerno,@t_total
			end 
		close cursor_table 
		deallocate cursor_table 
		
		delete @tmp
		where carownerno in(select carownerno from @tmp where gno=1 and (total not between @t_bmoney and @t_emoney))
		
		insert into @tmp
		select '2' gno,'','','','',CHAR(255),'','','','','','','','',SUM(total)
		from @tmp
		where (gno = 1)
		
		declare @tmp2 table(
			gno nvarchar(1),
			recno int IDENTITY(1,1),
			xrecno int,
			noa nvarchar(20),
			mon nvarchar(10),
			carno nvarchar(20),
			carownerno nvarchar(20),
			carowner nvarchar(20),
			cardealno nvarchar(20),
			cardeal nvarchar(20),
			indate nvarchar(10),
			caryear nvarchar(10),
			carbrandno nvarchar(20),
			carbrand nvarchar(20),
			tel nvarchar(50),
			mobile nvarchar(50),
			total float
		)
		
		insert into @tmp2
		select gno,recno,noa,mon,carno,carownerno,carowner,cardealno,cardeal,indate,caryear
		,carbrandno,carbrand,tel,mobile,total float from @tmp where gno='0' order by recno
		
		insert into @tmp2
		select gno,recno,noa,mon,carno,carownerno,carowner,cardealno,cardeal,indate,caryear
		,carbrandno,carbrand,tel,mobile,total float from @tmp where gno='1' order by recno
		
		insert into @tmp2
		select gno,recno,noa,mon,carno,carownerno,carowner,cardealno,cardeal,indate,caryear
		,carbrandno,carbrand,tel,mobile,total float from @tmp where gno='2' order by recno
		
		select gno,recno,noa,mon,carno,carownerno xcarownerno,carowner,cardealno,cardeal,indate,caryear,carbrandno,carbrand
		,substring(dbo.charbr(tel,12),0,case when CHARINDEX('<BR>',dbo.charbr(tel,12))=0 then len(tel)+1 else CHARINDEX('<BR>',dbo.charbr(tel,12)) end) tel
		,substring(dbo.charbr(mobile,12),0,case when CHARINDEX('<BR>',dbo.charbr(mobile,12))=0 then len(mobile)+1 else CHARINDEX('<BR>',dbo.charbr(mobile,12)) end) mobile,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total
		from @tmp2 order by xrecno
		
	end;
--************************************************************************************
z_car27:--z_car27車輛統計表
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @t_bcarspecno nvarchar(20)
	declare @t_ecarspecno nvarchar(20)
	declare @t_pdate nvarchar(20)
	declare @t_sssno nvarchar(20)
	declare @t_enddate nvarchar(10)
	declare @t_xcarspec nvarchar(MAX)
	
	set @t_bdate = case when '#non'=[3] then '' else [3] end
	set @t_edate = case when '#non'=[4] then char(255) else [4] end
	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
	set @t_bcarspecno = case when '#non'=[21] then '' else [21] end
	set @t_ecarspecno  = case when '#non'=[22] then char(255) else [22] end	
	set @t_pdate = case when '#non'=[42] then '' else [42] end
	set @t_sssno  = case when '#non'=[24] then char(255) else [24] end	
	set @t_enddate = case when '#non'=[15] then '' else [15] end
	set @t_xcarspec = case when '#non'=[40] then '' else [40] end
	
declare @t_xmon nvarchar(20)
set @t_xmon = case when '#non' = [18] then '' else [18] end
--*********************************************************************************
--103/10/03 監理部車輛分類為 車頭 A、大貨兼曳C03、板台B、大貨車C01、C02...、全拖板 B16
	
declare @result table(
		gno nvarchar(1),
		noa nvarchar(20),
		cno nvarchar(20),
		cardeal nvarchar(20),
		carno nvarchar(20),
		carownerno nvarchar(20),
		carowner nvarchar(50),
		indate nvarchar(10),
		outdate nvarchar(10),
		sxdate nvarchar(10),
		exdate nvarchar(10),
		wasted nvarchar(10),
		carkindno nvarchar(10),
		carkind nvarchar(10),
		caryear nvarchar(10),
		weight3 nvarchar(20),
		carbrandno nvarchar(20),
		carbrand nvarchar(20),
		carmount int,--車頭 A
		palmount int, --板台 B
		camount int,--大貨兼曳 C03
		cbmount int, --大貨車 C01 C02 ....
		bmount int, --全拖板 B16
		dmount int,
		emount int,
		omount int,
		manage float,
		a1 int,a2 int,a3 int,
		b1 int,b2 int,b3 int,
		c1 int,c2 int,c3 int,
		d1 int,d2 int,d3 int,
		e1 int,e2 int,e3 int
)

declare @cmd nvarchar(MAX)

set @cmd='select ''0'' gno,a.noa,a.cardealno,ISNULL(c.nick,''''),a.carno,a.carownerno,b.namea,a.indate,a.outdate, 
a.suspdate,a.enddate,a.wastedate,a.carspecno,ISNULL(f.spec,''''),a.caryear,ISNULL(a.weight3,''''),a.carbrandno,isnull(d.brand,'''')
,0,0,0,0,0,0,0,0
,isnull((select sum(outmoney) from cara ca left join caras cb on ca.noa=cb.noa where cb.caritemno=''401'' and ca.carno=a.noa and ca.mon=left(@t_edate,6)),0)
-isnull((select sum(outmoney) from cara ca left join caras cb on ca.noa=cb.noa where cb.caritemno=''401'' and ca.carno=a.noa and ca.mon=left(@t_bdate,6)),0)
,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
from car2 a 
left join carowner b on b.noa = a.carownerno 
left join cardeal c on c.noa = a.cardealno 
left join carbrand d on d.noa = a.carbrandno 
left join carspec f on f.noa = a.carspecno 
where ((@t_enddate!='''' and a.indate<=@t_enddate) or  (@t_xmon!='''' and  left(a.indate,6)<=@t_xmon)) and (a.cardealno between @t_bcardealno and @t_ecardealno)
and a.carownerno!='''' '

if(@t_xcarspec!='')
set @cmd=@cmd+'and CHARINDEX(a.carspecno,'''+@t_xcarspec+''')>0'
--(a.carspecno between @t_bcarspecno and @t_ecarspecno)

if(PATINDEX('%遷出%',@t_pdate)=0)
	set @cmd=@cmd+' and (isnull(outdate,'''')='''' or (@t_enddate!='''' and @t_enddate<=a.outdate) or (@t_xmon!='''' and @t_xmon<=left(a.outdate,6)))'
if(PATINDEX('%報停%',@t_pdate)=0)
	set @cmd=@cmd+' and (isnull(a.suspdate,'''')='''' or (@t_enddate!='''' and @t_enddate<=a.suspdate) or (@t_xmon!='''' and @t_xmon<=left(a.suspdate,6)))'
if(PATINDEX('%報廢%',@t_pdate)=0)
	set @cmd=@cmd+' and (isnull(a.enddate,'''')='''' or (@t_enddate!='''' and @t_enddate<=a.enddate) or (@t_xmon!='''' and @t_xmon<=left(a.enddate,6)))'
if(PATINDEX('%繳銷%',@t_pdate)=0)
	set @cmd=@cmd+' and (isnull(a.wastedate,'''')='''' or (@t_enddate!='''' and @t_enddate<=a.wastedate) or (@t_xmon!='''' and @t_xmon<=left(a.wastedate,6)))'

if(@t_xmon='')
begin
	if(len(@t_pdate)>0)
	set @cmd=@cmd+' and (1=0 '
	if(PATINDEX('%遷出%',@t_pdate)!=0)
		set @cmd=@cmd+' or (outdate between @t_bdate and @t_edate)'
	if(PATINDEX('%報停%',@t_pdate)!=0)
		set @cmd=@cmd+' or (a.suspdate between @t_bdate and @t_edate)'
	if(PATINDEX('%報廢%',@t_pdate)!=0)
		set @cmd=@cmd+' or (a.enddate between @t_bdate and @t_edate)'
	if(PATINDEX('%繳銷%',@t_pdate)!=0)
		set @cmd=@cmd+' or (a.wastedate between @t_bdate and @t_edate)'
	if(PATINDEX('%遷入%',@t_pdate)!=0)
		set @cmd=@cmd+' or (a.indate between @t_bdate and @t_edate)'
	if(len(@t_pdate)>0)
	set @cmd=@cmd+' )'
end
else
begin
	if(len(@t_pdate)>0)
		set @cmd=@cmd+'and ( 1=1 '
	if(PATINDEX('%遷出%',@t_pdate)!=0)
		set @cmd=@cmd+' and (len(isnull(a.outdate,''''))=0 or isnull(left(a.outdate,6),'''')>=@t_xmon or a.outdate between @t_bdate and @t_edate ) '
	if(PATINDEX('%報停%',@t_pdate)!=0)
		set @cmd=@cmd+' and (len(isnull(a.suspdate,''''))=0 or isnull(left(a.suspdate,6),'''')>=@t_xmon or a.suspdate between @t_bdate and @t_edate )'
	if(PATINDEX('%報廢%',@t_pdate)!=0)
		set @cmd=@cmd+' and (len(isnull(a.enddate,''''))=0 or isnull(left(a.enddate,6),'''')>=@t_xmon or a.enddate between @t_bdate and @t_edate )'
	if(PATINDEX('%繳銷%',@t_pdate)!=0)
		set @cmd=@cmd+' and (len(isnull(a.wastedate,''''))=0 or isnull(left(a.wastedate,6),'''')>=@t_xmon or a.wastedate between @t_bdate and @t_edate )'
	if(PATINDEX('%遷入%',@t_pdate)!=0)
		set @cmd=@cmd+' and (a.indate <= @t_edate )'
	if(len(@t_pdate)>0)
	set @cmd=@cmd+' )'
end

declare @ssscount int
set @ssscount=0

if(@t_sssno!=char(255))
begin
	while(PATINDEX('%,%',@t_sssno)>0)
	begin
		if (@ssscount=0)
			set @cmd=@cmd+' and (a.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		else
			set @cmd=@cmd+' or a.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		set @t_sssno=RIGHT(@t_sssno,LEN(@t_sssno)-PATINDEX('%,%',@t_sssno))
		set @ssscount=@ssscount+1
	end
	if (@ssscount=0)
		set @cmd=@cmd+' and a.sssno='''+@t_sssno+''''
	else
		set @cmd=@cmd+' or a.sssno='''+@t_sssno+''')'
end

insert into @result 
execute sp_executesql @cmd,N'@t_enddate nvarchar(10),@t_bcardealno nvarchar(20),@t_ecardealno nvarchar(20),@t_bcarspecno nvarchar(20),@t_ecarspecno nvarchar(20),@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_xmon nvarchar(10)',
		@t_enddate=@t_enddate,@t_bcardealno=@t_bcardealno,@t_ecardealno=@t_ecardealno,@t_bcarspecno=@t_bcarspecno,@t_ecarspecno=@t_ecarspecno,@t_bdate=@t_bdate,@t_edate=@t_edate,@t_xmon=@t_xmon

insert into @result
select '1' gno,'',cno,'',COUNT(distinct carno),'','','','','','','','','','','','',''
,0,0,0,0,0,0,0,0,sum(manage),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
from @result
group by cno

declare @cno nvarchar(20) 
declare cursor_table cursor for 
select cno from @result where gno='1'
open cursor_table 
fetch next from cursor_table 
into @cno
while(@@FETCH_STATUS <> -1) 
	begin 
	
	--update @result
	--set carmount=(select COUNT(*) from @result where gno='0' and PATINDEX('%-%',carno)>0 and len(carno)=6 and cno=@cno),
	--palmount=(select COUNT(*) from @result where gno='0' and PATINDEX('%-%',carno)>0 and len(carno)=5 and cno=@cno)
	--where cno=@cno and gno='1'
	
	update @result
	set carmount=(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and charindex('A',b.carspecno)=1 and a.cno=@cno),
	palmount=(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and charindex('B',b.carspecno)=1 and b.carspecno!='B16' and a.cno=@cno),
	camount=(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and b.carspecno='C03' and a.cno=@cno),
	cbmount=(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and charindex('C',b.carspecno)=1 and b.carspecno!='C03' and a.cno=@cno),
	bmount=(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and b.carspecno='B16' and a.cno=@cno),
	dmount=(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and charindex('D',b.carspecno)=1 and a.cno=@cno),
	emount=(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and charindex('E',b.carspecno)=1 and a.cno=@cno),
	omount=(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and (isnull(b.carspecno,'')='' or left(b.carspecno,1) not in ('A','B','C','D','E')) and a.cno=@cno)
	
	,a1=(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and charindex('A',b.carspecno)=1 and isnull(b.indate,'')!='' and (isnull(b.indate,'') between @t_bdate and @t_edate) and a.cno=@cno)
	,a2=(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and charindex('A',b.carspecno)=1 and isnull(b.outdate,'')!='' and (isnull(b.outdate,'') between @t_bdate and @t_edate) and a.cno=@cno)
	,a3=(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and charindex('A',b.carspecno)=1 and isnull(b.outdate,'')='' and ((isnull(b.suspdate,'')!='' and (isnull(b.suspdate,'') between @t_bdate and @t_edate))  or (isnull(b.enddate,'')!='' and (isnull(b.enddate,'') between @t_bdate and @t_edate)) or (isnull(b.wastedate,'')!='' and (isnull(b.wastedate,'') between @t_bdate and @t_edate))) and a.cno=@cno)
	,b1=(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and b.carspecno='C03' and isnull(b.indate,'')!='' and (isnull(b.indate,'') between @t_bdate and @t_edate) and a.cno=@cno)
	,b2=(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and b.carspecno='C03' and isnull(b.outdate,'')!='' and (isnull(b.outdate,'') between @t_bdate and @t_edate) and a.cno=@cno)
	,b3=(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and b.carspecno='C03' and isnull(b.outdate,'')='' and ((isnull(b.suspdate,'')!='' and (isnull(b.suspdate,'') between @t_bdate and @t_edate))  or (isnull(b.enddate,'')!='' and (isnull(b.enddate,'') between @t_bdate and @t_edate)) or (isnull(b.wastedate,'')!='' and (isnull(b.wastedate,'') between @t_bdate and @t_edate))) and a.cno=@cno)
	,c1=(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and charindex('B',b.carspecno)=1 and b.carspecno!='B16' and isnull(b.indate,'')!='' and (isnull(b.indate,'') between @t_bdate and @t_edate) and a.cno=@cno)
	,c2=(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and charindex('B',b.carspecno)=1 and b.carspecno!='B16' and isnull(b.outdate,'')!='' and (isnull(b.outdate,'') between @t_bdate and @t_edate) and a.cno=@cno)
	,c3=(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and charindex('B',b.carspecno)=1 and b.carspecno!='B16' and isnull(b.outdate,'')='' and ((isnull(b.suspdate,'')!='' and (isnull(b.suspdate,'') between @t_bdate and @t_edate))  or (isnull(b.enddate,'')!='' and (isnull(b.enddate,'') between @t_bdate and @t_edate)) or (isnull(b.wastedate,'')!='' and (isnull(b.wastedate,'') between @t_bdate and @t_edate))) and a.cno=@cno)
	,d1=(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and b.carspecno='B16' and isnull(b.indate,'')!='' and (isnull(b.indate,'') between @t_bdate and @t_edate) and a.cno=@cno)
	,d2=(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and b.carspecno='B16' and isnull(b.outdate,'')!='' and (isnull(b.outdate,'') between @t_bdate and @t_edate) and a.cno=@cno)
	,d3=(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and b.carspecno='B16' and isnull(b.outdate,'')='' and ((isnull(b.suspdate,'')!='' and (isnull(b.suspdate,'') between @t_bdate and @t_edate))  or (isnull(b.enddate,'')!='' and (isnull(b.enddate,'') between @t_bdate and @t_edate)) or (isnull(b.wastedate,'')!='' and (isnull(b.wastedate,'') between @t_bdate and @t_edate))) and a.cno=@cno)
	,e1=(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and charindex('C',b.carspecno)=1 and b.carspecno!='C03' and isnull(b.indate,'')!='' and (isnull(b.indate,'') between @t_bdate and @t_edate) and a.cno=@cno)
	,e2=(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and charindex('C',b.carspecno)=1 and b.carspecno!='C03' and isnull(b.outdate,'')!='' and (isnull(b.outdate,'') between @t_bdate and @t_edate) and a.cno=@cno)
	,e3=(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and charindex('C',b.carspecno)=1 and b.carspecno!='C03' and isnull(b.outdate,'')='' and ((isnull(b.suspdate,'')!='' and (isnull(b.suspdate,'') between @t_bdate and @t_edate))  or (isnull(b.enddate,'')!='' and (isnull(b.enddate,'') between @t_bdate and @t_edate)) or (isnull(b.wastedate,'')!='' and (isnull(b.wastedate,'') between @t_bdate and @t_edate))) and a.cno=@cno)
	where cno=@cno and gno='1'

	fetch next from cursor_table 
	into @cno
	end 
close cursor_table 
deallocate cursor_table 

if(select COUNT(*) from @result where gno='1')>1
begin
	insert into @result 
	select '3' gno,char(255),char(255),'',COUNT(distinct carno),'','','','','','','','','','','','',''
	,(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and charindex('A',b.carspecno)=1 )
	,(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and charindex('B',b.carspecno)=1 and b.carspecno!='B16')
	,(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and b.carspecno='C03' )
	,(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and charindex('C',b.carspecno)=1 and b.carspecno!='C03')
	,(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and b.carspecno='B16' ) 
	,(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and charindex('D',b.carspecno)=1 )
	,(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and charindex('E',b.carspecno)=1 )
	,(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and (isnull(b.carspecno,'')='' or left(b.carspecno,1) not in ('A','B','C','D','E')) )
	,sum(manage)
	,(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and charindex('A',b.carspecno)=1 and isnull(b.indate,'')!='' and (isnull(b.indate,'') between @t_bdate and @t_edate))
	,(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and charindex('A',b.carspecno)=1 and isnull(b.outdate,'')!='' and (isnull(b.outdate,'') between @t_bdate and @t_edate))
	,(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and charindex('A',b.carspecno)=1 and isnull(b.outdate,'')='' and ((isnull(b.suspdate,'')!='' and (isnull(b.suspdate,'') between @t_bdate and @t_edate))  or (isnull(b.enddate,'')!='' and (isnull(b.enddate,'') between @t_bdate and @t_edate)) or (isnull(b.wastedate,'')!='' and (isnull(b.wastedate,'') between @t_bdate and @t_edate))))
	,(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and b.carspecno='C03' and isnull(b.indate,'')!='' and (isnull(b.indate,'') between @t_bdate and @t_edate))
	,(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and b.carspecno='C03' and isnull(b.outdate,'')!='' and (isnull(b.outdate,'') between @t_bdate and @t_edate))
	,(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and b.carspecno='C03' and isnull(b.outdate,'')='' and ((isnull(b.suspdate,'')!='' and (isnull(b.suspdate,'') between @t_bdate and @t_edate))  or (isnull(b.enddate,'')!='' and (isnull(b.enddate,'') between @t_bdate and @t_edate)) or (isnull(b.wastedate,'')!='' and (isnull(b.wastedate,'') between @t_bdate and @t_edate))))
	,(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and charindex('B',b.carspecno)=1 and b.carspecno!='B16' and isnull(b.indate,'')!='' and (isnull(b.indate,'') between @t_bdate and @t_edate))
	,(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and charindex('B',b.carspecno)=1 and b.carspecno!='B16' and isnull(b.outdate,'')!='' and (isnull(b.outdate,'') between @t_bdate and @t_edate))
	,(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and charindex('B',b.carspecno)=1 and b.carspecno!='B16' and isnull(b.outdate,'')='' and ((isnull(b.suspdate,'')!='' and (isnull(b.suspdate,'') between @t_bdate and @t_edate))  or (isnull(b.enddate,'')!='' and (isnull(b.enddate,'') between @t_bdate and @t_edate)) or (isnull(b.wastedate,'')!='' and (isnull(b.wastedate,'') between @t_bdate and @t_edate))))
	,(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and b.carspecno='B16' and isnull(b.indate,'')!='' and (isnull(b.indate,'') between @t_bdate and @t_edate))
	,(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and b.carspecno='B16' and isnull(b.outdate,'')!='' and (isnull(b.outdate,'') between @t_bdate and @t_edate))
	,(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and b.carspecno='B16' and isnull(b.outdate,'')='' and ((isnull(b.suspdate,'')!='' and (isnull(b.suspdate,'') between @t_bdate and @t_edate))  or (isnull(b.enddate,'')!='' and (isnull(b.enddate,'') between @t_bdate and @t_edate)) or (isnull(b.wastedate,'')!='' and (isnull(b.wastedate,'') between @t_bdate and @t_edate))))
	,(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and charindex('C',b.carspecno)=1 and b.carspecno!='C03' and isnull(b.indate,'')!='' and (isnull(b.indate,'') between @t_bdate and @t_edate))
	,(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and charindex('C',b.carspecno)=1 and b.carspecno!='C03' and isnull(b.outdate,'')!='' and (isnull(b.outdate,'') between @t_bdate and @t_edate))
	,(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and charindex('C',b.carspecno)=1 and b.carspecno!='C03' and isnull(b.outdate,'')='' and ((isnull(b.suspdate,'')!='' and (isnull(b.suspdate,'') between @t_bdate and @t_edate))  or (isnull(b.enddate,'')!='' and (isnull(b.enddate,'') between @t_bdate and @t_edate)) or (isnull(b.wastedate,'')!='' and (isnull(b.wastedate,'') between @t_bdate and @t_edate))))
	from @result where gno='0'
	
	update @result
	set gno='2'
	where gno='1' and cno=(select top 1 cno from @result where gno='1' order by cno desc)
	
end

select *
from @result
order by cno,gno,carkindno,noa;

--***************************************************************************************
z_car28:--z_car28車籍資料列印
	declare @t_bcarno nvarchar(20)
	declare @t_ecarno nvarchar(20)
	declare @t_sssno nvarchar(20)

	set @t_bcarno = case when '#non'=[16] then '' else [16] end
	set @t_ecarno  = case when '#non'=[17] then char(255) else [17] end
	set @t_sssno  = case when '#non'=[24] then char(255) else [24] end
--************************************************************************************
declare @result table(
		gno nvarchar(1),
		noa nvarchar(20),
		carno nvarchar(20),
		carownerno nvarchar(20),
		carowner nvarchar(20),
		cardealno nvarchar(20),
		cardeal nvarchar(20),
		sex nvarchar(1),
		idno nvarchar(50),
		birthday nvarchar(10),
		tel1 nvarchar(50),
		tel2 nvarchar(50),
		fax nvarchar(50),
		mobile nvarchar(50),
		addr_conn nvarchar(MAX),
		addr_home nvarchar(MAX),
		indate nvarchar(10),
		inmoney int,
		inplace nvarchar(50),
		outdate nvarchar(10),
		outmoney int,
		outplace nvarchar(50),
		passdate nvarchar(10),
		caryear nvarchar(10),
		ton nvarchar(20),
		carbrandno nvarchar(20),
		carbrand nvarchar(50),
		caryeartw nvarchar(20),
		engineno nvarchar(20),
		passno nvarchar(20),
		weight1 float,
		weight2 float,
		carspecno nvarchar(20),
		carspec nvarchar(20),
		carmode nvarchar(20),
		memo nvarchar(MAX),
		sxdate nvarchar(10),
		wasted nvarchar(10),
		oldcarno nvarchar(10)
)
declare @cmd nvarchar(MAX)

set @cmd='select ''0'' gno,a.noa,a.carno,a.carownerno,b.namea,a.cardealno,isnull(c.nick,''''),b.sex,b.idno,b.birthday,b.tel1, 
b.tel2,b.fax,b.mobile,b.addr_conn,b.addr_home,a.indate,a.inmoney,a.inplace,a.outdate,a.outmoney,a.outplace,a.passdate,a.caryear,a.ton, 
a.carbrandno,isnull(d.brand,''''),a.caryeartw,a.engineno,/*a.passno*/ '''',a.weight1,a.weight2,a.carspecno,f.spec,a.carmode,a.memo, 
ISNULL(a.suspdate,''''),ISNULL(a.enddate,''''),ISNULL(a.oldnoa,'''') 
from car2 a 
left join carowner b on b.noa = a.carownerno 
left join cardeal c on c.noa = a.cardealno 
left join carbrand d on d.noa = a.carbrandno 
left join carspec f on a.carspecno = f.noa 
where a.carno between @t_bcarno and @t_ecarno and a.carownerno!='''' and (a.enddate='''' or a.enddate is null) and (a.outdate='''' or a.outdate is null)'

declare @ssscount int
set @ssscount=0

if(@t_sssno!=char(255))
begin
	while(PATINDEX('%,%',@t_sssno)>0)
	begin
		if (@ssscount=0)
			set @cmd=@cmd+' and (a.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		else
			set @cmd=@cmd+' or a.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		set @t_sssno=RIGHT(@t_sssno,LEN(@t_sssno)-PATINDEX('%,%',@t_sssno))
		set @ssscount=@ssscount+1
	end
	if (@ssscount=0)
		set @cmd=@cmd+' and a.sssno='''+@t_sssno+''''
	else
		set @cmd=@cmd+' or a.sssno='''+@t_sssno+''')'
end

insert into @result 
execute sp_executesql @cmd,N'@t_bcarno nvarchar(20),@t_ecarno nvarchar(20)',
		@t_bcarno=@t_bcarno,@t_ecarno=@t_ecarno

update @result
set sex=(case when sex='M' then '男' else '女' end)

select *
from @result order by noa;
--*****************************************************************************************

z_car29:--z_car29車主擁有車輛
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_bcarspecno nvarchar(20)
	declare @t_ecarspecno nvarchar(20)
	declare @t_pdate nvarchar(20)
	declare @t_sssno nvarchar(20)
	declare @t_enddate nvarchar(10)

	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_enddate = case when '#non'=[15] then '' else [15] end
	set @t_bcarspecno = case when '#non'=[21] then '' else [21] end
	set @t_ecarspecno  = case when '#non'=[22] then char(255) else [22] end	
	set @t_pdate = case when '#non'=[23] then '' else [23] end
	set @t_sssno  = case when '#non'=[24] then char(255) else [24] end	
	
	--1031114新增車牌年份篩選與排序&序號
	declare @t_bcaryear nvarchar(20)
	declare @t_ecaryear nvarchar(20)
	declare @t_carbrand nvarchar(MAX)
	declare @t_vorder nvarchar(MAX)
	set @t_bcaryear = case when '#non'=[43] then '' else [43] end
	set @t_ecaryear  = case when '#non'=[44] then char(255) else [44] end	
	set @t_carbrand = case when '#non'=[45] then '' else [45] end
	set @t_vorder = case when '#non'=[46] then '' else [46] end
----------------------------------------------------------------------------------------------------------------------------------------
	--103/10/03 監理部車輛分類為 車頭 A、大貨兼曳C03、板台B、大貨車C01、C02...、全拖板 B16
	
	declare @result table(
		recno int,
		gno nvarchar(1),
		noa nvarchar(20),
		cardealno nvarchar(20),
		[card] nvarchar(20),
		carno nvarchar(20),
		carownerno nvarchar(20),
		a nvarchar(50),
		b nvarchar(10),
		c nvarchar(10),
		d nvarchar(10),
		h nvarchar(10),
		e nvarchar(10),
		carkindno nvarchar(10),
		f nvarchar(10),
		weight3 nvarchar(20),
		carbrandno nvarchar(20),
		g nvarchar(20),
		datea nvarchar(10),
		total float,
		carspecno nvarchar(10),
		carmount float,--車頭 A
		palmount float,--板台 B
		camount int,--大貨兼曳 C03
		cbmount int, --大貨車 C01 C02
		bmount int, --全拖板 B16
		dmount int,
		emount int,
		omount int
)

declare @cmd nvarchar(MAX)

set @cmd='select ROW_NUMBER() over (PARTITION by a.carownerno ORDER by '+case when @t_vorder='車行' then 'a.cardealno,a.carno' when @t_vorder='年份' then 'a.caryear,a.carno' when @t_vorder='廠牌' then 'isnull(d.brand,''''),a.carno' else 'a.cardealno,a.carno' end+'),
''0'' gno,a.noa,a.cardealno,ISNULL(c.nick,''''),a.carno,a.carownerno,b.namea,a.indate,a.outdate, 
a.suspdate,a.enddate,a.wastedate,a.carkindno,a.caryear,ISNULL(a.weight3,''''),a.carbrandno,isnull(d.brand,''''),isnull(f.bdate,''''),0 
,a.carspecno,0,0,0,0,0,0,0,0
from car2 a 
left join carowner b on b.noa = a.carownerno 
left join cardeal c on c.noa = a.cardealno 
left join carbrand d on d.noa = a.carbrandno 
left join (select * from carInsure where (noa+noq) in(select noa+MAX(noq) from carInsure group by noa)) f on f.noa = a.noa 
where a.indate<=@t_enddate and (a.carownerno between @t_bcarownerno and @t_ecarownerno) and 
(a.cardealno between @t_bcardealno and @t_ecardealno)and 
(a.carspecno between @t_bcarspecno and @t_ecarspecno) and a.carownerno!='''''

if(charindex('遷出',@t_pdate)=0) 
set @cmd=@cmd+' and (outdate='''' or outdate is null or outdate >@t_enddate) ' 

if(charindex('報停',@t_pdate)=0) 
set @cmd=@cmd+' and (a.suspdate='''' or a.suspdate is null or a.suspdate >@t_enddate)' 

if(charindex('報廢',@t_pdate)=0) 
set @cmd=@cmd+' and (a.enddate='''' or a.enddate is null or a.enddate >@t_enddate)'

if(charindex('繳銷',@t_pdate)=0) 
set @cmd=@cmd+' and (a.wastedate='''' or a.wastedate is null or a.wastedate >@t_enddate)' 


declare @ssscount int
set @ssscount=0

if(@t_sssno!=char(255))
begin
	while(PATINDEX('%,%',@t_sssno)>0)
	begin
		if (@ssscount=0)
			set @cmd=@cmd+' and (a.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		else
			set @cmd=@cmd+' or a.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		set @t_sssno=RIGHT(@t_sssno,LEN(@t_sssno)-PATINDEX('%,%',@t_sssno))
		set @ssscount=@ssscount+1
	end
	if (@ssscount=0)
		set @cmd=@cmd+' and a.sssno='''+@t_sssno+''''
	else
		set @cmd=@cmd+' or a.sssno='''+@t_sssno+''')'
end


if(@t_carbrand!='')
	set @cmd=@cmd+' and a.carbrandno in ('''+replace(@t_carbrand,'.',''',''')+''')'
	
set @cmd=@cmd+' and (a.caryear between @t_bcaryear and @t_ecaryear)'

insert into @result 
execute sp_executesql @cmd,N'@t_enddate nvarchar(10),@t_bcarownerno nvarchar(20),@t_ecarownerno nvarchar(20),@t_bcardealno nvarchar(20),@t_ecardealno nvarchar(20),@t_bcarspecno nvarchar(20),@t_ecarspecno nvarchar(20),@t_bcaryear nvarchar(20),@t_ecaryear nvarchar(20)',
		@t_enddate=@t_enddate,@t_bcarownerno=@t_bcarownerno,@t_ecarownerno=@t_ecarownerno,@t_bcardealno=@t_bcardealno,@t_ecardealno=@t_ecardealno,@t_bcarspecno=@t_bcarspecno,@t_ecarspecno=@t_ecarspecno,@t_bcaryear=@t_bcaryear,@t_ecaryear=@t_ecaryear

insert into @result
select 999,'1','','','','',carownerno,'','','','','','','','','','','','',count(*),''
,sum(case when left(carspecno,1)='A' then 1 else 0 end)
,sum(case when left(carspecno,1)='B' and carspecno!='B16' then 1 else 0 end)
,sum(case when carspecno='C03' then 1 else 0 end)
,sum(case when left(carspecno,1)='C' and carspecno!='C03' then 1 else 0 end)
,sum(case when carspecno='B16' then 1 else 0 end)
,sum(case when left(carspecno,1)='D' then 1 else 0 end)
,sum(case when left(carspecno,1)='E' then 1 else 0 end)
,sum(case when isnull(carspecno,'')='' or left(carspecno,1) not in ('A','B','C','D''E') then 1 else 0 end)

from @result group by carownerno

select *
from @result
order by carownerno,gno,recno;


--*****************************************************************************************

z_car99:
	-- not yet
	declare @t_bmon nvarchar(10)
	declare @t_emon nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_bsssno nvarchar(20)
	declare @t_esssno nvarchar(20)
	declare @t_carteamno nvarchar(2)
	declare @t_carno nvarchar(20)
	declare @t_enddate nvarchar(10)
	
	set @t_bmon = case when '#non'='#non' then '' else '#non' end
	set @t_emon = case when '#non'='#non' then char(255) else '#non' end
	set @t_bdate = case when '#non'='#non' then '' else '#non' end
	set @t_edate = case when '#non'='#non' then char(255) else '#non' end
	set @t_bcardealno = case when '#non'='#non' then '' else '#non' end
	set @t_ecardealno  = case when '#non'='#non' then char(255) else '#non' end	
	set @t_bcarownerno = case when '#non'='#non' then '' else '#non' end
	set @t_ecarownerno  = case when '#non'='#non' then char(255) else '#non' end	
	set @t_bdriverno = case when '#non'='#non' then '' else '#non' end
	set @t_edriverno  = case when '#non'='#non' then char(255) else '#non' end	
	set @t_bsssno = case when '#non'='#non' then '' else '#non' end
	set @t_esssno  = case when '#non'='#non' then char(255) else '#non' end	
	set @t_carteamno = case when '#non'='#non' then '' else '#non' end	
	set @t_carno = case when '#non'='#non' then '' else '#non' end		
	set @t_enddate = case when '#non'='#non' then '' else '#non' end	
	
	declare @tmp table(
		gno nvarchar(1),
		車牌 nvarchar(20),
		車主 nvarchar(20),
		車行 nvarchar(20),
		欠款金額 int,
		過入日 nvarchar(1),
		廠牌 nvarchar(20),
		電話 nvarchar(20),
		行動 nvarchar(20)
	)	
	
	insert into @tmp
		select 
			'0' gno
		from borrs a
		left join borr b on a.noa = b.noa
		left join car2 c on b.carno = c.noa 
		left join cardeal d on c.cardealno = d.noa
		left join carOwner e on c.carownerno = e.noa
		left join carbrand f on c.carbrandno = f.noa
		where (len(@t_carno)=0 or b.carno=@t_carno)and
		      (c.cardealno between @t_bcardealno and @t_ecardealno) and
		      (c.carownerno between @t_bcarownerno and @t_ecarownerno)
	;
	------------------------------------------------------------------------------------------------
z_car30:--z_car30	
declare @t_bcardealno nvarchar(20)
declare @t_ecardealno nvarchar(20)
declare @t_xmon nvarchar(20)
set @t_bcardealno = case when '#non' = [5] then '' else [5] end
set @t_ecardealno = case when '#non' = [6] then CHAR(255) else [6] end
set @t_xmon = case when '#non' = [18] then '' else [18] end
--************************************************************************
SET QUOTED_IDENTIFIER OFF

declare @tmpa table( 
gno nvarchar(1),  
cardealno nvarchar(20), 
cardeal nvarchar(50), 
total float ,
mon nvarchar(10)
) 

insert into @tmpa 
select '0' gno,b.cardealno,c.comp,sum(a.paytotal),@t_xmon
from cara a 
left join car2 b on a.carno = b.noa 
left join cardeal c on b.cardealno = c.noa 
where @t_xmon = a.mon and
(b.cardealno between @t_bcardealno and @t_ecardealno)
and b.carownerno!='' and b.carownerno!='H003' and b.carownerno!='H264' and b.carownerno!='H326'
and b.carownerno!='H273' and b.carownerno!='H249' and b.carownerno!='H041' and b.noa!='1111' and b.noa!='1120' and b.noa!='1122'

group by  b.cardealno,c.comp

--20130327加入vcc未付金額
--declare @cmd nvarchar(MAX)
--declare @cardealno nvarchar(50)
--declare @unpay float
--set @cmd="
--	declare cursor_table cursor for
--	select cardealno,sum(unpay) unpay from (
--	select b.cardealno cardealno,isnull(a.total-a.payed,0) unpay 
--	from vcc"+left(@t_xmon,3)+" a left join car2 b on 
--	(case when (select count(*) from car2 where noa=substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0
--	then substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))else
--	(select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by mon desc,carno)end)=b.noa 
--	left join carbrand d on b.carbrandno=d.noa 
--	left join carOwner e on a.custno=e.noa 
--	where left(a.custno,1)='H' and b.cardealno!='' and (left(a.carno,6) <= '"+@t_xmon+"')) a group by cardealno"
--	execute sp_executesql @cmd
--open cursor_table 
--fetch next from cursor_table 
--into @cardealno,@unpay
--while(@@FETCH_STATUS <> -1) 
--	begin 
--		update @tmpa
--		set total=total+@unpay
--		where cardealno=@cardealno
		
--		fetch next from cursor_table 
--		into @cardealno,@unpay
--	end 
--close cursor_table 
--deallocate cursor_table 

insert into @tmpa
select '1' gno,'','',SUM(total) ,@t_xmon
from @tmpa

select gno,cardealno,cardeal,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total,mon
from @tmpa
order by gno,cardealno;
-----------------------------------------------------------------------------------------
z_car31:--z_car31
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
declare @t_sssno nvarchar(20)
set @t_bdate = case when '#non' = [3] then '' else [3] end
set @t_edate = case when '#non' = [4] then CHAR(255) else [4] end
set @t_sssno  = case when '#non'=[24] then char(255) else [24] end
declare @tmp table(
        gno nvarchar(1), 
        datea nvarchar(20),
        carno nvarchar(20),
        carowner nvarchar(50),
        insurer nvarchar(50),
        moneys float,
        insuresheet nvarchar(20),
        insurecard nvarchar(20)
)
declare @cmd nvarchar(MAX)

set @cmd='select ''0'' gno,(case when isnull(a.stopdate,'''')!='''' then a.stopdate else a.edate end)
,a.noa,c.namea,a.insurer,a.money,a.insuresheet,a.insurecard 
from carInsure a left join car2 b on a.noa = b.noa left join carOwner c on c.noa = b.carownerno 
where ((case when isnull(a.stopdate,'''')!='''' then a.stopdate else a.edate end) >= @t_bdate and (case when isnull(a.stopdate,'''')!='''' then a.stopdate else a.edate end) <= @t_edate) 
and (b.outdate is null or b.outdate='''') 
and b.carownerno!='''' and (b.enddate='''' or b.enddate is null)'

declare @ssscount int
set @ssscount=0

if(@t_sssno!=char(255))
begin
	while(PATINDEX('%,%',@t_sssno)>0)
	begin
		if (@ssscount=0)
			set @cmd=@cmd+' and (b.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		else
			set @cmd=@cmd+' or b.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		set @t_sssno=RIGHT(@t_sssno,LEN(@t_sssno)-PATINDEX('%,%',@t_sssno))
		set @ssscount=@ssscount+1
	end
	if (@ssscount=0)
		set @cmd=@cmd+' and b.sssno='''+@t_sssno+''''
	else
		set @cmd=@cmd+' or b.sssno='''+@t_sssno+''')'
end

insert into @tmp 
execute sp_executesql @cmd,N'@t_bdate nvarchar(20),@t_edate nvarchar(20)',
		@t_bdate=@t_bdate,@t_edate=@t_edate
		
insert into @tmp 
select '1' gno,'','','','',SUM(moneys),'','' 
from @tmp 

select gno,datea,carno,carowner,insurer, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,moneys),1)),4,12)) moneys, 
insuresheet,insurecard 
from @tmp order by gno,datea;
------------------------------------------------------------------------------
z_car32:--z_car32
declare @t_binsurerno nvarchar(20)
declare @t_einsurerno nvarchar(20)
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
declare @t_sssno nvarchar(20)
set @t_binsurerno = case when '#non' = [19] then '' else [19] end
set @t_einsurerno = case when '#non' = [20] then CHAR(255) else [20] end
set @t_bdate = case when '#non' = [3] then '' else [3] end
set @t_edate = case when '#non' = [4] then CHAR(255) else [4] end
set @t_sssno  = case when '#non'=[24] then char(255) else [24] end
declare @tmp table(
		gno nvarchar(20),
		xinsurerno nvarchar(20),
		insurer nvarchar(50),
		carno nvarchar(20),
		carowner nvarchar(50),
		datea nvarchar(20),
		moneys float,
		kind nvarchar(20),
		recno float
)

declare @cmd nvarchar(MAX)

set @cmd='select ''0'' gno,a.insurerno,a.insurer,a.noa,c.namea,(case when isnull(a.stopdate,'''')!='''' then a.stopdate else a.edate end)
,a.money,a.kind,ROW_NUMBER()over(PARTITION BY a.insurer order by a.noa) recno 
from carInsure a 
left join car2 b on a.noa = b.noa 
left join carOwner c on c.noa = b.carownerno 
where ((case when isnull(a.stopdate,'''')!='''' then a.stopdate else a.edate end) >= @t_bdate and (case when isnull(a.stopdate,'''')!='''' then a.stopdate else a.edate end) <= @t_edate) and 
(a.insurerno between @t_binsurerno and @t_einsurerno) and b.carownerno!='''' and (b.enddate='''' or b.enddate is null) and (b.outdate='''' or b.outdate is null)'

declare @ssscount int
set @ssscount=0

if(@t_sssno!=char(255))
begin
	while(PATINDEX('%,%',@t_sssno)>0)
	begin
		if (@ssscount=0)
			set @cmd=@cmd+' and (b.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		else
			set @cmd=@cmd+' or b.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		set @t_sssno=RIGHT(@t_sssno,LEN(@t_sssno)-PATINDEX('%,%',@t_sssno))
		set @ssscount=@ssscount+1
	end
	if (@ssscount=0)
		set @cmd=@cmd+' and b.sssno='''+@t_sssno+''''
	else
		set @cmd=@cmd+' or b.sssno='''+@t_sssno+''')'
end

insert into @tmp 
execute sp_executesql @cmd,N'@t_bdate nvarchar(20),@t_edate nvarchar(20),@t_binsurerno nvarchar(20),@t_einsurerno nvarchar(20)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_binsurerno=@t_binsurerno,@t_einsurerno=@t_einsurerno

insert into @tmp
select '1' gno,xinsurerno,'','','','',SUM(moneys),'',max(recno)
from @tmp
group by xinsurerno

select gno,xinsurerno,insurer,carno,carowner,datea,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,moneys),1)),4,12)) moneys,
kind,recno
from @tmp
order by xinsurerno,gno,carno,datea;
------------------------------------------------------------------------------
z_car33:--z_car33
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_enddate nvarchar(10)
	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_enddate = case when '#non'=[15] then '' else [15] end

	declare @tmp table( 
		cardealno nvarchar(20), 
		cardeal nvarchar(50), 
		carownerno nvarchar(20), 
		carowner nvarchar(50), 
		lenderno nvarchar(20), 
		lender nvarchar(50), 
		money int, 
		installmentamount int, 
		installment int, 
		bkmoney int, 
		surplusment int, 
		surplusmoney int, 
		bdate nvarchar(50), 
		edate nvarchar(50), 
		memo nvarchar(MAX), 
		carnos nvarchar(MAX) 
	) 
	--case說明--如果貸款止日>截止日期表示還沒還清否則已還清，沒有還清則計算剩餘還款期數(如果今天日期<計日，表示當期還沒還款，所以+1) 
	insert into @tmp 
		select a.cardealno,a.cardeal,a.noa,b.namea,a.lenderno,a.lender,a.money,a.installmentamount,a.installment,a.bkmoney, 
		case when a.edate > @t_enddate then 
		(left(a.edate,3)*12+right(left(a.edate,6),2))-(left(@t_enddate,3)*12+right(left(@t_enddate,6),2))+(case when right(@t_enddate,2)<=a.day then 1 else 0 end) else 0 end surplusment, 
		0 surplusmoney,a.bdate,a.edate,a.memo,a.carnos 
		from carLender a left join carOwner b on a.noa=b.noa 
		order by a.noa 
	
	--計算貸款餘額 
	update @tmp 
	set surplusmoney=surplusment*installmentamount 
	where surplusment>0 
	
	declare @tmpa table( 
		gno nvarchar(20), 
		carownerno nvarchar(20), 
		typea nvarchar(20), 
		asset nvarchar(100),
		gdate nvarchar(10),
		dmoney int, 
		cmoney int,  
		fdate nvarchar(10),
		memo nvarchar(MAX),
		total int
	) 
	insert into @tmpa
	select '0',noa ,typea,asset,getdate,money,null,fdate,memo,0
	from balance
	union all
	select '0',carownerno,'車輛'typea,noa,indate,cast(round(inmoney*POWER(0.800,((left(@t_enddate,3)*12)+right(left(@t_enddate,6),2))-(left(indate,3)*12+right(left(indate,6),2))),0) as int),
	(select total from cara where carno=car2.noa and carno+mon in (select carno+MAX(mon) from cara where carno=car2.noa group by carno)),@t_enddate,memo,0
	from car2 where outdate='' or (select total from cara where carno=car2.noa and carno+mon in (select carno+MAX(mon) from cara where carno=car2.noa group by carno))!=0
	and carownerno between @t_bcarownerno and @t_ecarownerno
	--where indate!='' and inmoney>0
	union all
	select '0',carownerno,'貸款'typea,carnos,bdate,null,surplusmoney,edate,memo,0
	from @tmp
	union all
	select '0',compno,'未兌現票據',gqbno,datea,0,money,indate,(case when gqbno in (select checkno from borrs where checkno!='') then '借支 '+ memo else memo end),0 from gqb
	where left(compno,1)='H' and (len(enda)=0 or enda is null or enda ='N' or enda='n') and len(indate)=9 and typea!='3'
	and (left(right('0'+CONVERT (nvarchar(7),CONVERT (VARCHAR(7),dateadd(d,-5,CONVERT(datetime ,CONVERT(nvarchar(10),CONVERT(int,left(@t_enddate,3))+1911)+right(left(@t_enddate,6),2)+right(left(@t_enddate,9),2)) ),12 )+0890000),7),3)+'/'
	+right(left(right('0'+CONVERT (nvarchar(7),CONVERT (VARCHAR(7),dateadd(d,-5,CONVERT(datetime ,CONVERT(nvarchar(10),CONVERT(int,left(@t_enddate,3))+1911)+right(left(@t_enddate,6),2)+right(left(@t_enddate,9),2)) ),12 )+0890000),7),5),2)+'/'
	+right(right('0'+CONVERT (nvarchar(7),CONVERT (VARCHAR(7),dateadd(d,-5,CONVERT(datetime ,CONVERT(nvarchar(10),CONVERT(int,left(@t_enddate,3))+1911)+right(left(@t_enddate,6),2)+right(left(@t_enddate,9),2)) ),12 )+0890000),7),2))<=indate
	union all
	select '0',custno,'借支',noa,begindate,0,unpay,enddate,memo,0 from borr 
	where unpay!=0  and custno in(select noa from carOwner) and custno!=''
	union all --103/03/03 睿庭說要加入
	select '0',custno,'發票稅費',noa,carno,0,total-payed,@t_enddate,memo,0 from view_vcc where left(custno,1)='H' and carno!=''
	and total-payed!=0
	order by noa
	
	insert into @tmpa
	select '1',carownerno,typea,'','',SUM(dmoney),SUM(cmoney),'','',isnull(SUM(dmoney),0)-isnull(SUM(cmoney),0)
	from @tmpa
	group by carownerno,typea
	
	insert into @tmpa
	select '2',carownerno,char(255),'','',SUM(dmoney),SUM(cmoney),'','',isnull(SUM(dmoney),0)-isnull(SUM(cmoney),0)
	from @tmpa where gno='0'
	group by carownerno
	
	select a.gno,a.carownerno,a.typea,a.asset,a.gdate,a.fdate,REPLACE(a.memo,'chr(10)','<BR>') memo,b.namea
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.dmoney),1)),4,12)) dmoney
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.cmoney),1)),4,12)) cmoney
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.total),1)),4,12)) total
	from @tmpa a left join carOwner b on a.carownerno=b.noa
	where a.carownerno between @t_bcarownerno and @t_ecarownerno and a.carownerno!=''
	order by carownerno,typea,gno;
	
--**************************************************************************************************
z_car34:--z_car34
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @t_bcarspecno nvarchar(20)
	declare @t_ecarspecno nvarchar(20)
	
	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
	set @t_bcarspecno = case when '#non'=[21] then '' else [21] end
	set @t_ecarspecno  = case when '#non'=[22] then char(255) else [22] end	
--*********************************************************************************** 
declare @tmp table( 
	gno nvarchar(1), 
	cardealno nvarchar(20), 
	cardeal nvarchar(50), 
	recno int, 
	carno nvarchar(20), 
	carspecno nvarchar(20), 
	carspec nvarchar(50), 
	engineno nvarchar(50), 
	memo nvarchar(MAX) 
) 

declare @gno nvarchar(1)
declare @cardealno nvarchar(20)
declare @cardeal nvarchar(50)
declare @carno nvarchar(20)
declare @carspecno nvarchar(20)
declare @carspec nvarchar(50) 
declare @engineno nvarchar(50)

declare @recno int
declare @t_cardealno nvarchar(20) 
set @t_cardealno='XXXXXXX' 
set @gno=1

declare @now_date nvarchar(10)--前一年現在日期
set @now_date=CONVERT (VARCHAR(7), DATEADD(YEAR,-1,GETDATE()),12 )+0890000
set @now_date=left(@now_date,3)+'/'+substring(@now_date,4,2)+'/'+right(@now_date,2)

--特殊！報停一年內的車也要印出
declare cursor_table cursor for 
select a.cardealno,b.comp,a.carno,a.carspecno,c.spec,a.engineno
from car2 a left join cardeal b on a.cardealno=b.noa 
left join carspec c on a.carspecno=c.noa 
where a.carownerno!='' and (a.enddate='' or a.enddate is null) and (a.outdate='' or a.outdate is null) and a.cardealno!='' and a.carspecno!=''
and (a.suspdate='' or a.suspdate is null or a.suspdate> @now_date)
and (a.cardealno between @t_bcardealno and @t_ecardealno) and (a.carspecno between @t_bcarspecno and @t_ecarspecno) 
order by cardealno,carspecno  
open cursor_table 
fetch next from cursor_table 
into @cardealno,@cardeal,@carno,@carspecno,@carspec,@engineno
while(@@FETCH_STATUS <> -1) 
	begin 
	if(@t_cardealno!=@cardealno) 
	begin 
		
		if(@t_cardealno!='XXXXXXX' and @gno!=1)
		begin
			while((@recno-1)%30!=0)
			begin
				insert into @tmp
				select '0'gno,@t_cardealno,'',@recno,'','','','',''
				set @recno=@recno+1
			end
			insert into @tmp 
			select '1'gno,@t_cardealno,'',null,'','','','',''
		end
		set @recno=1 
		set @t_cardealno=@cardealno 
	end 

	insert into @tmp 
	select '0',@cardealno,@cardeal,@recno,@carno,@carspecno,@carspec,@engineno,''
	
	set @gno=0

	if(@recno%30=0)
	begin
		insert into @tmp 
		select '1'gno,@cardealno,'',null,'','','','',''
		set @gno=1
	end

	set @recno=@recno+1 

	fetch next from cursor_table 
	into @cardealno,@cardeal,@carno,@carspecno,@carspec,@engineno
	end 
close cursor_table 
deallocate cursor_table 
--********************最後一筆****************************
	if(@t_cardealno!='XXXXXXX')
	begin
			while((@recno-1)%30!=0)
			begin
				insert into @tmp
				select '0'gno,@t_cardealno,'',@recno,'','','','',''
				set @recno=@recno+1
			end
			insert into @tmp 
			select '1'gno,@t_cardealno,'',null,'','','','',''
		end
--******************************************************
select * from @tmp;
----------------------------------------------------
z_cara1:--z_cara1車主欠款明細
SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_pagecount int
	declare @pagecount int
	declare @t_bmon nvarchar(10)
	declare @t_emon nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_bcarno nvarchar(20)
	declare @t_ecarno nvarchar(20)
	declare @t_xcarnos nvarchar(MAX) 
	declare @sql_carnos nvarchar(MAX)
	declare @t_xmemo nvarchar(MAX) 
	declare @xyear nvarchar(20)
	declare @iacc nvarchar(20)
	
	set @pageCount = 16
	set @t_bmon = case when '#non'=[1] then '' else [1] end
	set @t_emon = case when '#non'=[2] then char(255) else [2] end
	set @t_bdate = case when '#non'=[3] then '' else [3] end
	set @t_edate = case when '#non'=[4] then char(255) else [4] end	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_bcarno = case when '#non'=[16] then '' else [16] end
	set @t_ecarno = case when '#non'=[17] then CHAR(255) else [17] end
	set @t_xcarnos = case when '#non'=[25] then '' else [25] end
	set @sql_carnos=''
	set @t_xmemo  = case when '#non'=[30] then '' else [30] end
	set @xyear='[38]'
	set @iacc=case when '#non'=[39] then '' else [39] end
	
if(RIGHT(@t_xcarnos,1)='.')
set @t_xcarnos=left(@t_xcarnos,len(@t_xcarnos)-1)
	
while(LEN(@t_xcarnos)>0)
begin
	if(CHARINDEX('.',@t_xcarnos)=0)
	begin
		set @sql_carnos=@sql_carnos+' b.carno='''+@t_xcarnos+''' and'
		set @t_xcarnos=''
	end
	if(CHARINDEX('.',@t_xcarnos)>0)
	begin
		set @sql_carnos=@sql_carnos+' b.carno='''+left(@t_xcarnos,CHARINDEX('.',@t_xcarnos)-1)+''' or'
		set @t_xcarnos=RIGHT(@t_xcarnos,LEN(@t_xcarnos)-CHARINDEX('.',@t_xcarnos))
	end
end


declare @tmp table( 
	[gno] nvarchar(1), 
	[noa] nvarchar(30), 
	[noq] nvarchar(20), 
	[carno] nvarchar(20), 
	[carownerno] nvarchar(20), 
	[carowner] nvarchar(50), 
	[indate] nvarchar(10), 
	[carbrandno] nvarchar(20), 
	[carbrand] nvarchar(50), 
	[caryear] nvarchar(10), 
	[mobile] nvarchar(50), 
	[caritemno] nvarchar(50), 
	[caritem] nvarchar(50), 
	[mon] nvarchar(20), 
	[datea] nvarchar(20), 
	[memo] nvarchar(max), 
	[outmoney] int, 
	[inmoney] int, 
	[total] int, 
	primary key (carownerno,carno,noa,noq,gno) 
)

declare @tmpa table( 
	[gno] nvarchar(1), 
	[noa] nvarchar(30), 
	[noq] nvarchar(20), 
	[carno] nvarchar(20), 
	[carownerno] nvarchar(20), 
	[carowner] nvarchar(50), 
	[indate] nvarchar(10), 
	[carbrandno] nvarchar(20), 
	[carbrand] nvarchar(50), 
	[caryear] nvarchar(10), 
	[mobile] nvarchar(50), 
	[caritemno] nvarchar(50), 
	[caritem] nvarchar(50), 
	[mon] nvarchar(20), 
	[datea] nvarchar(20), 
	[memo] nvarchar(max), 
	[outmoney] int, 
	[inmoney] int, 
	[total] int, 
	[count] int,
	[xmemo] nvarchar(max)
) 

declare @tmpb table( 
	[gno] nvarchar(1),
	[noa] nvarchar(30), 
	[noq] nvarchar(20), 
	[carno] nvarchar(20), 
	[carownerno] nvarchar(20), 
	[carowner] nvarchar(50), 
	[indate] nvarchar(10), 
	[carbrandno] nvarchar(20), 
	[carbrand] nvarchar(50), 
	[caryear] nvarchar(10), 
	[mobile] nvarchar(50), 
	[caritemno] nvarchar(50), 
	[caritem] nvarchar(50), 
	[mon] nvarchar(20), 
	[datea] nvarchar(20), 
	[memo] nvarchar(max), 
	[outmoney] int, 
	[inmoney] int, 
	[total] int
) 

declare @gno nvarchar(1) 
declare @noa nvarchar(20) 
declare @noq nvarchar(3) 
declare @carno nvarchar(20)
declare @carownerno nvarchar(20) 
declare @carowner nvarchar(50)
declare @indate nvarchar(20) 
declare @carbrandno nvarchar(20)
declare @carbrand nvarchar(50)
declare @caryear nvarchar(20)
declare @mobile nvarchar(50)
declare @caritemno nvarchar(50)
declare @caritem nvarchar(50)
declare @mon nvarchar(10)
declare @datea nvarchar(10)
declare @memo nvarchar(Max)
declare @outmoney int 
declare @inmoney int 
declare @total int 

--102/08/07 婉容勞健保轉過來的字要去掉(健勞保調整)
set @cmd =	"select a.*,0 "+ 
" from( " + 
"select '0' gno,a.noa ,a.noq,b.carno,isNull(b.carownerno,'') carownerno,isNull(d.namea,'') carowner,ISNULL(c.indate,'') indate, "+ 
"ISNULL(e.noa,'') carbrandno,ISNULL(e.brand,'') carbrand,ISNULL(c.caryear,'') caryear,ISNULL(d.mobile,'') mobile, "+ 
"a.caritemno ,a.caritem ,b.mon,a.datea,(case when a.caritemno!='403' then a.memo else replace(a.memo,'健勞保調整 ','') end)memo,a.outmoney,a.inmoney "+ 
"from caras a "+ 
"left join cara b on b.noa = a.noa "+ 
"left join car2 c on c.noa = b.carno "+ 
"left join carOwner d on d.noa = b.carownerno "+ 
"left join carbrand e on e.noa = c.carbrandno "+ 
" where "+ 
"(b.carno between @t_bcarno and @t_ecarno) and "+ 
"(b.carownerno between @t_bcarownerno and @t_ecarownerno) and "+ 
"(b.mon between @t_bmon and @t_emon) and"+ 
"("+@sql_carnos+" 1=1)"+
" ) a" 

--全部費用
insert into @tmp 
execute sp_executesql @cmd,N'@t_bcarno nvarchar(20),@t_ecarno nvarchar(20),@t_bcarownerno nvarchar(20),@t_ecarownerno nvarchar(20), 
@t_bmon nvarchar(10),@t_emon nvarchar(10)', 
@t_bcarno = @t_bcarno,@t_ecarno = @t_ecarno,@t_bcarownerno=@t_bcarownerno,@t_ecarownerno=@t_ecarownerno, 
@t_bmon=@t_bmon,@t_emon=@t_emon 

--1020312更新加入VCCTRAN的車主資料 --1020410加入判斷是否要顯示內帳(VCC)資料
if(left(@t_bmon,3)>='101' and @iacc='顯示')
begin
	--set @cmd="
	--select '0'gno,(select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by carno )+'-'+left(a.carno,6) noa 
	--,'999' noq 
	--,(select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by carno )carno 
	--,a.custno carownerno,a.comp carowner,b.indate,b.carbrandno,d.brand,b.caryear,e.mobile,'' caritemno,'請款' caritem 
	--,left(a.carno,6) mon,a.carno,a.memo memo,a.total outmoney ,0 inmoney,0 
	--from vcc"+left(@t_bmon,3)+" a left join car2 b on 
	--(select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by carno ) =b.noa 
	--left join carbrand d on b.carbrandno=d.noa 
	--left join carOwner e on a.custno=e.noa 
	--where left(a.custno,1)='H' and (left(a.carno,6) between '"+@t_bmon+"' and '"+@t_emon+"') 
	--and (select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by carno ) between '"+@t_bcarno+"' and '"+@t_ecarno+"'
	--and carownerno between '"+@t_bcarownerno+"' and '"+@t_ecarownerno+"'
	--and ("+@sql_carnos+" 1=1)
	--order by noa"
	
	
	--102/08/07 婉容睿庭 第一個和第二個空白之間為指定車牌,若沒有抓車主沒有遷出的第一台車,且備註去掉指定車牌
	--103/02/15 1/6 提出掛帳順序車頭(代號A.C)→已過出.報停.繳銷.報廢的車頭→板台(代號B)→已過出.報停.繳銷.報廢之板台
	
	insert into @tmpb
	exec(" 
	select '0'gno, 
	Replace((case when (select count(*) from car2 where noa=substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end))>0 
	then substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	else (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where c.mon<=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) end) 
	,' ','')+'-'+left(a.carno,6) noa ,'999' noq 
	,Replace((case when (select count(*) from car2 where noa=substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end))>0 
	then substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	else (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where c.mon<=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) end) 
	,' ','') carno 
	,a.custno carownerno,a.comp carowner,b.indate,b.carbrandno,d.brand,b.caryear,e.mobile,'' caritemno,(case when CHARINDEX('理賠',a.memo)>0 then '*其他' when CHARINDEX('請款',a.memo)>0 then '*請款' else '*發票稅費' end) caritem 
	,left(a.carno,6) mon,a.carno 
	,replace(a.memo,' '+(case when (select count(*) from car2 where noa=substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end))>0 
	then substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	else (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where c.mon<=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) end) 
	,'') memo 
	,a.total outmoney ,a.payed inmoney,0 
	from view_vcc a left join car2 b on 
	(case when (select count(*) from car2 where noa=substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end))>0 
	then substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	else (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where c.mon<=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) end)=b.noa 
	left join carbrand d on b.carbrandno=d.noa 
	left join carOwner e on a.custno=e.noa 
	where left(a.custno,1)='H' and a.carno!='' and (left(a.carno,6) between '"+@t_bmon+"' and '"+@t_emon+"') 
	and (case when (select count(*) from car2 where noa=substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end))>0 
	then substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	else (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where c.mon<=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) end) between '"+@t_bcarno+"' and '"+@t_ecarno+"' 
	and a.custno between '"+@t_bcarownerno+"' and '"+@t_ecarownerno+"' 
	and ("+@sql_carnos+" 1=1) 
	order by noa") 

	--插入tmpb(vcctran)
	declare cursor_table cursor for 
	select * from @tmpb 
	--where noa in(select noa from @tmp group by noa)
	open cursor_table 
	fetch next from cursor_table 
	into @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total 
	while(@@FETCH_STATUS <> -1) 
	begin 
	
	insert into @tmp 
	select @gno,@noa,(select right('00'+cast((cast(isnull(MAX(noq),0) as int)+1)as nvarchar(3)),3) from @tmp where noa=@noa),@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total  
	
	fetch next from cursor_table 
	into @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total 
	end 
	close cursor_table 
	deallocate cursor_table 
end

--月小計
insert into @tmp 
select '2',noa,'',carno,carownerno,'','','','','','','','',mon,'','',SUM(outmoney),SUM(inmoney),0 from @tmp group by noa,carownerno,carno,mon

--累計
insert into @tmp 
select '3','','',carno,carownerno,'','','','','','','','','999/99','','',SUM(outmoney),SUM(inmoney),0 from @tmp 
where gno='2'
group by carownerno,carno

--欠款累計 --20130119改成最後一個月cara的金額合計(檢查是否結轉正確)
insert into @tmp 
select '4',a.noa,'',a.carno,a.carownerno,a.carowner,b.indate,b.carbrandno,d.brand,b.caryear,c.mobile,'','','999/99',a.datea,'',0,0,a.total
from cara a
left join car2 b on b.noa = a.carno
left join carOwner c on c.noa = a.carownerno 
left join carbrand d on d.noa = b.carbrandno
where a.carno in(select carno from @tmp group by carno) and mon=@t_emon
and(a.carno between @t_bcarno and @t_ecarno) and 
(a.carownerno between @t_bcarownerno and @t_ecarownerno)

--插入沒有欠款累計
insert into @tmp 
select '4','','',b.noa,b.carownerno,c.namea,b.indate,b.carbrandno,d.brand,b.caryear,c.mobile,'','','999/99','','',0,0,0
from car2 b 
left join carOwner c on c.noa = b.carownerno 
left join carbrand d on d.noa = b.carbrandno 
where b.noa in(select carno from @tmp where carno not in (select carno from @tmp where gno='4' group by carno)group by carno)
and(b.noa between @t_bcarno and @t_ecarno) and 
(b.carownerno between @t_bcarownerno and @t_ecarownerno)
-----------------------------------------------------------------------------------------------
declare @count int 
declare @t_total int 
declare @t_outmoney int 
declare @t_inmoney int
declare @t_carownerno nvarchar(20)
declare @x_total int
declare @x_count int
declare @unpay int

set @count=1
declare @t_carno nvarchar(20)
set @t_carno='XXXX'
declare @t_mon nvarchar(10)
set @t_mon='001/01/01'
set @t_total=0
set @t_outmoney=0
set @t_inmoney=0
set @t_carownerno='ZZZZ'
set @x_total =0
set @x_count =0
set @t_pagecount=1
set @unpay=0

declare cursor_table cursor for 
select * from @tmp order by carownerno,carno,mon,gno,case when caritemno='001' then caritemno else datea end,noq
open cursor_table 
fetch next from cursor_table 
into @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total
while(@@FETCH_STATUS <> -1) 
	begin 
		if(@carownerno!=@t_carownerno and @t_carownerno!='ZZZZ')
		begin
			if((@t_pagecount+1)%@pageCount=1)
				begin
					insert into @tmpa
					select '8','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,@t_xmemo
				end
			else
				begin
					insert into @tmpa
					select '5','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,''
				end
			set @x_total =0
			set @x_count =0
			set @count=@count+1
			set @t_pagecount=@t_pagecount+1
			
			while (@t_pagecount%@pageCount>1 )
			begin
				insert into @tmpa
				select '6','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,''
				set @count=@count+1
				set @t_pagecount=@t_pagecount+1
			end
			
			if(@t_pagecount%@pageCount!=1)
			begin
				insert into @tmpa
				select '7','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,@t_xmemo
				set @count=@count+1
				set @t_pagecount=1
			end
		end
		
		if(@t_mon!=@mon)
		begin
			set @t_outmoney=0
			set @t_inmoney=0
			set @unpay=0
		end
	
		--插入gno1-廠牌年份....等資料
		if(@t_carno!=@carno or @t_carownerno!=@carownerno)
		begin
			insert into @tmpa
			select '1','','',@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,'','',@mon,'','',0,0,0,@count,''
			
			set @t_carno=@carno
			set @count=@count+1
			set @t_pagecount=@t_pagecount+1
			set @unpay=0
			
			--1020826加入當月沒有帳且上月有vcc未請款金額時,欠款金額補入到當月第一台車上
			if(left(@t_bmon,3)>='101' and @iacc='顯示')
			begin
				--求得開始月份之前的未付金額
				set @unpay =isnull((select 
					sum(a.total-a.payed) unpay 
					from view_vcc a left join car2 b on 
					Replace((case when (select count(*) from car2 where noa=substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end))>0 
					then substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end) 
					when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
					then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
					when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
					then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
					when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
					then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
					when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
					then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
					else (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where c.mon<=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) end),' ','') =b.noa 
					left join carbrand d on b.carbrandno=d.noa 
					left join carOwner e on a.custno=e.noa 
					where left(a.custno,1)='H' and (left(a.carno,6) < @t_bmon) 
					and (case when (select count(*) from car2 where noa=substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end))>0 
					and substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end) in (select c.carno from cara c left join car2 d on c.carno=d.noa where ((d.outdate='' or d.outdate is null) and (d.enddate='' or d.enddate is null) and (d.wastedate='' or d.wastedate is null) and (d.suspdate='' or d.suspdate is null)) and c.mon=left(a.carno,6) and a.custno=c.carownerno) 
					then substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end) 
					when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
					then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
					when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
					then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
					when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
					then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
					when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
					then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
					else (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where c.mon<=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) end)= @carno),0)
			end
			
			set @t_total=isnull(@outmoney,0)-isnull(@inmoney,0)+@unpay
			
			--印出車牌和車主
			insert into @tmpa
			select @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney+@unpay,@inmoney,@t_total,@count,''
			set @count=@count+1
			set @t_pagecount=@t_pagecount+1
			set @t_outmoney=@t_outmoney+@outmoney
			set @t_inmoney=@t_inmoney+@inmoney
		end
		else
		begin
			--之後的資料不印出001
			if(@caritemno!='001')
			begin
				--計算餘額和欠款累計
				if(@gno='0')
				begin
					set @t_total=@t_total+isnull(@outmoney,0)-isnull(@inmoney,0)
					set @t_outmoney=@t_outmoney+@outmoney
					set @t_inmoney=@t_inmoney+@inmoney
				end
				
				if(@gno='2')
				begin
					insert into @tmpa
					select @gno,@noa,@noq,@carno,@carownerno,'',@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@t_outmoney+@unpay,@t_inmoney,@t_total,@count,''
					set @count=@count+1
					set @t_pagecount=@t_pagecount+1
				end
				else if(@gno='3')
				begin
					insert into @tmpa
					select @gno,@noa,@noq,@carno,@carownerno,'',@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney+@unpay,@inmoney,@t_total,@count,''
					set @count=@count+1
					set @t_pagecount=@t_pagecount+1
				end
				else
				begin
					if(@gno='0' and @t_pagecount%@pageCount=1)
						begin
							insert into @tmpa
							select @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@t_total,@count,''
						end
					else
						begin
							if(@gno='4')--20130119改成最後一個月cara的金額合計(檢查是否結轉正確)--20130312應加入VCC資料會造成金額不正確所以拿掉
							begin
								insert into @tmpa
								select @gno,@noa,@noq,'',@carownerno,'',@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@t_total,@count,''
								--select @gno,@noa,@noq,'',@carownerno,'',@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total,@count,''
							end
							else
							begin
								insert into @tmpa
								select @gno,@noa,@noq,'',@carownerno,'',@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@t_total,@count,''
							end
						end
					
					set @count=@count+1
					set @t_pagecount=@t_pagecount+1
					if(@gno='4' and @t_pagecount%@pagecount!=1)
					begin
						insert into @tmpa
						select '6','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,''
						set @count=@count+1
						set @t_pagecount=@t_pagecount+1
					end
				end
				
			end
		end
		
		if(@gno='3')
		begin
			update @tmpa
			set outmoney=(select SUM(outmoney) from @tmpa where gno='2' and carownerno=@carownerno and carno=@carno),
				inmoney=(select SUM(inmoney) from @tmpa where gno='2' and carownerno=@carownerno and carno=@carno)
			where gno='3' and carownerno=@carownerno and carno=@carno
			
			set @x_total=@x_total+(select SUM(outmoney) from @tmpa where gno='2' and carownerno=@carownerno and carno=@carno)-(select SUM(inmoney) from @tmpa where gno='2' and carownerno=@carownerno and carno=@carno)
			set @x_count=@x_count+1
		end
		
		--set @count=@count+1
		set @t_mon=@mon
		set @t_carownerno=@carownerno
		
		fetch next from cursor_table 
		into @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total
	end 
close cursor_table 
deallocate cursor_table 
---------------------最後一筆
			if((@t_pagecount+1)%@pageCount=1)
				begin
					insert into @tmpa
					select '8','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,@t_xmemo
				end
			else
				begin
					insert into @tmpa
					select '5','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,''
				end
			set @x_total =0
			set @x_count =0
			set @count=@count+1
			set @t_pagecount=@t_pagecount+1
			
			while (@t_pagecount%@pageCount>1 )
			begin
				insert into @tmpa
				select '6','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,''
				set @count=@count+1
				set @t_pagecount=@t_pagecount+1
			end
			
			if(@t_pagecount%@pageCount!=1)
			begin
				insert into @tmpa
				select '7','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,@t_xmemo
				set @count=@count+1
				set @t_pagecount=1
			end
----------------------------------
--select gno,noa,noq,carno,carownerno,carowner,indate,carbrandno,carbrand,caryear,mobile,caritemno,caritem,mon,datea,left(memo,15) memo
--,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,outmoney),1)),4,12)) outmoney
--,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,inmoney),1)),4,12)) inmoney
--,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total
--,count,xmemo
--from @tmpa order by count

select gno,a.noa,noq,carno,carownerno,carowner,indate,carbrandno,carbrand,caryear,mobile,caritemno,caritem,mon,datea,left(memo,17) memo 
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,outmoney),1)),4,12)) outmoney 
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,inmoney),1)),4,12)) inmoney 
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total 
,count,xmemo xsmemo
from @tmpa a left join (select noa,namea from carowner) b on a.carownerno=b.noa order by b.namea,carownerno,count;

--------------------------------------------------------------------------------------------------
z_cara2:--z_cara2
declare @t_bcarownerno nvarchar(20)
declare @t_ecarownerno nvarchar(20)
declare @t_bcarno nvarchar(20)
declare @t_ecarno nvarchar(20)
declare @t_xcarnos nvarchar(MAX) 
declare @sql_carnos nvarchar(MAX)
declare @cmd nvarchar(max)
SET QUOTED_IDENTIFIER OFF
	
set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
set @t_ecarownerno = case when '#non'=[8] then char(255) else [8] end	
set @t_bcarno = case when '#non'=[16] then '' else [16] end
	set @t_ecarno = case when '#non'=[17] then CHAR(255) else [17] end
	set @t_xcarnos = case when '#non'=[25] then '' else [25] end
	set @sql_carnos=''
	
if(RIGHT(@t_xcarnos,1)='.')
set @t_xcarnos=left(@t_xcarnos,len(@t_xcarnos)-1)
	
while(LEN(@t_xcarnos)>0)
begin
	if(CHARINDEX('.',@t_xcarnos)=0)
	begin
		set @sql_carnos=@sql_carnos+' a.carno='''+@t_xcarnos+''' and'
		set @t_xcarnos=''
	end
	if(CHARINDEX('.',@t_xcarnos)>0)
	begin
		set @sql_carnos=@sql_carnos+' a.carno='''+left(@t_xcarnos,CHARINDEX('.',@t_xcarnos)-1)+''' or'
		set @t_xcarnos=RIGHT(@t_xcarnos,LEN(@t_xcarnos)-CHARINDEX('.',@t_xcarnos))
	end
end

declare @tmp table(
     gno nvarchar(1),
     carownerno nvarchar(20), 
     namea nvarchar(20),
     zip nvarchar(50),
     addr nvarchar(50)
)

set @cmd ="select DISTINCT '0' gno,carownerno,namea,zip_conn,addr_conn "+
"from car2 a left join carOwner b on a.carownerno=b.noa "+
"where a.carownerno!='''' and (b.noa between @t_bcarownerno and @t_ecarownerno) "+
"and (a.noa between @t_bcarno and @t_ecarno) and ("+@sql_carnos+" 1=1)"

insert into @tmp 
execute sp_executesql @cmd,N'@t_bcarno nvarchar(20),@t_ecarno nvarchar(20),@t_bcarownerno nvarchar(20),@t_ecarownerno nvarchar(20)', 
@t_bcarno = @t_bcarno,@t_ecarno = @t_ecarno,@t_bcarownerno=@t_bcarownerno,@t_ecarownerno=@t_ecarownerno


insert into @tmp
select '1' gno,carownerno,namea,'',''
from @tmp

select *
from @tmp
order by namea,carownerno,gno;


----------------------------------------------------
z_cara3:--z_cara3車主欠款明細(信封)
SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_pagecount int
	declare @pagecount int
	declare @t_bmon nvarchar(10)
	declare @t_emon nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_bcarno nvarchar(20)
	declare @t_ecarno nvarchar(20)
	declare @t_xcarnos nvarchar(MAX) 
	declare @sql_carnos nvarchar(MAX)
	declare @t_xmemo nvarchar(MAX) 
	declare @xyear nvarchar(20)
	declare @iacc nvarchar(20)
	
	set @pageCount = 16
	set @t_bmon = case when '#non'=[1] then '' else [1] end
	set @t_emon = case when '#non'=[2] then char(255) else [2] end
	set @t_bdate = case when '#non'=[3] then '' else [3] end
	set @t_edate = case when '#non'=[4] then char(255) else [4] end	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_bcarno = case when '#non'=[16] then '' else [16] end
	set @t_ecarno = case when '#non'=[17] then CHAR(255) else [17] end
	set @t_xcarnos = case when '#non'=[25] then '' else [25] end
	set @sql_carnos=''
	set @t_xmemo  = case when '#non'=[30] then '' else [30] end
	set @xyear='[38]'
	set @iacc=case when '#non'=[39] then '' else [39] end
	
if(RIGHT(@t_xcarnos,1)='.')
set @t_xcarnos=left(@t_xcarnos,len(@t_xcarnos)-1)
	
while(LEN(@t_xcarnos)>0)
begin
	if(CHARINDEX('.',@t_xcarnos)=0)
	begin
		set @sql_carnos=@sql_carnos+' b.carno='''+@t_xcarnos+''' and'
		set @t_xcarnos=''
	end
	if(CHARINDEX('.',@t_xcarnos)>0)
	begin
		set @sql_carnos=@sql_carnos+' b.carno='''+left(@t_xcarnos,CHARINDEX('.',@t_xcarnos)-1)+''' or'
		set @t_xcarnos=RIGHT(@t_xcarnos,LEN(@t_xcarnos)-CHARINDEX('.',@t_xcarnos))
	end
end


declare @tmp table( 
	[gno] nvarchar(1), 
	[noa] nvarchar(30), 
	[noq] nvarchar(20), 
	[carno] nvarchar(20), 
	[carownerno] nvarchar(20), 
	[carowner] nvarchar(50), 
	[indate] nvarchar(10), 
	[carbrandno] nvarchar(20), 
	[carbrand] nvarchar(50), 
	[caryear] nvarchar(10), 
	[mobile] nvarchar(50), 
	[caritemno] nvarchar(50), 
	[caritem] nvarchar(50), 
	[mon] nvarchar(20), 
	[datea] nvarchar(20), 
	[memo] nvarchar(max), 
	[outmoney] int, 
	[inmoney] int, 
	[total] int, 
	primary key (carownerno,carno,noa,noq,gno) 
)

declare @tmpa table( 
	[gno] nvarchar(2), 
	[noa] nvarchar(30), 
	[noq] nvarchar(20), 
	[carno] nvarchar(20), 
	[carownerno] nvarchar(20), 
	[carowner] nvarchar(50), 
	[indate] nvarchar(10), 
	[carbrandno] nvarchar(20), 
	[carbrand] nvarchar(50), 
	[caryear] nvarchar(10), 
	[mobile] nvarchar(50), 
	[caritemno] nvarchar(50), 
	[caritem] nvarchar(50), 
	[mon] nvarchar(20), 
	[datea] nvarchar(20), 
	[memo] nvarchar(max), 
	[outmoney] int, 
	[inmoney] int, 
	[total] int, 
	[count] int,
	[xmemo] nvarchar(max),
	page int
) 

declare @tmpc table( 
	[gno] nvarchar(1),
	[noa] nvarchar(30), 
	[noq] nvarchar(20), 
	[carno] nvarchar(20), 
	[carownerno] nvarchar(20), 
	[carowner] nvarchar(50), 
	[indate] nvarchar(10), 
	[carbrandno] nvarchar(20), 
	[carbrand] nvarchar(50), 
	[caryear] nvarchar(10), 
	[mobile] nvarchar(50), 
	[caritemno] nvarchar(50), 
	[caritem] nvarchar(50), 
	[mon] nvarchar(20), 
	[datea] nvarchar(20), 
	[memo] nvarchar(max), 
	[outmoney] int, 
	[inmoney] int, 
	[total] int
) 

declare @gno nvarchar(2) 
declare @noa nvarchar(20) 
declare @noq nvarchar(3) 
declare @carno nvarchar(20)
declare @carownerno nvarchar(20) 
declare @carowner nvarchar(50)
declare @indate nvarchar(20) 
declare @carbrandno nvarchar(20)
declare @carbrand nvarchar(50)
declare @caryear nvarchar(20)
declare @mobile nvarchar(50)
declare @caritemno nvarchar(50)
declare @caritem nvarchar(50)
declare @mon nvarchar(10)
declare @datea nvarchar(10)
declare @memo nvarchar(Max)
declare @outmoney int 
declare @inmoney int 
declare @total int 

--102/08/07 婉容勞健保轉過來的字要去掉(健勞保調整)
set @cmd =	"select a.*,0 "+ 
" from( " + 
"select '0' gno,a.noa ,a.noq,b.carno,isNull(b.carownerno,'') carownerno,isNull(d.namea,'') carowner,ISNULL(c.indate,'') indate, "+ 
"ISNULL(e.noa,'') carbrandno,ISNULL(e.brand,'') carbrand,ISNULL(c.caryear,'') caryear,ISNULL(d.mobile,'') mobile, "+ 
"a.caritemno ,a.caritem ,b.mon,a.datea,(case when a.caritemno!='403' then a.memo else replace(a.memo,'健勞保調整 ','') end)memo,a.outmoney,a.inmoney "+ 
"from caras a "+ 
"left join cara b on b.noa = a.noa "+ 
"left join car2 c on c.noa = b.carno "+ 
"left join carOwner d on d.noa = b.carownerno "+ 
"left join carbrand e on e.noa = c.carbrandno "+ 
" where "+ 
"(b.carno between @t_bcarno and @t_ecarno) and "+ 
"(b.carownerno between @t_bcarownerno and @t_ecarownerno) and "+ 
"(b.mon between @t_bmon and @t_emon) and"+ 
"("+@sql_carnos+" 1=1)"+
" ) a" 

--全部費用
insert into @tmp 
execute sp_executesql @cmd,N'@t_bcarno nvarchar(20),@t_ecarno nvarchar(20),@t_bcarownerno nvarchar(20),@t_ecarownerno nvarchar(20), 
@t_bmon nvarchar(10),@t_emon nvarchar(10)', 
@t_bcarno = @t_bcarno,@t_ecarno = @t_ecarno,@t_bcarownerno=@t_bcarownerno,@t_ecarownerno=@t_ecarownerno, 
@t_bmon=@t_bmon,@t_emon=@t_emon 

--1020312更新加入VCCTRAN的車主資料 --1020410加入判斷是否要顯示內帳(VCC)資料
if(left(@t_bmon,3)>='101' and @iacc='顯示')
begin
	--102/08/07 婉容睿庭 第一個和第二個空白之間為指定車牌,若沒有抓車主沒有遷出的第一台車,且備註去掉指定車牌
	--103/02/15 1/6 提出掛帳順序車頭(代號A.C)→已過出.報停.繳銷.報廢的車頭→板台(代號B)→已過出.報停.繳銷.報廢之板台
	insert into @tmpc
	exec(" 
	select '0'gno, 
	Replace((case when (select count(*) from car2 where noa=substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end))>0 
	then substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	else (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where c.mon<=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) end) 
	,' ','')+'-'+left(a.carno,6) noa ,'999' noq 
	,Replace((case when (select count(*) from car2 where noa=substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end))>0 
	then substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	else (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where c.mon<=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) end) 
	,' ','') carno 
	,a.custno carownerno,a.comp carowner,b.indate,b.carbrandno,d.brand,b.caryear,e.mobile,'' caritemno,(case when CHARINDEX('理賠',a.memo)>0 then '*其他' when CHARINDEX('請款',a.memo)>0 then '*請款' else '*發票稅費' end) caritem 
	,left(a.carno,6) mon,a.carno 
	,replace(a.memo,' '+(case when (select count(*) from car2 where noa=substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end))>0 
	then substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	else (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where c.mon<=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) end) 
	,'') memo 
	,a.total outmoney ,a.payed inmoney,0 
	from view_vcc a left join car2 b on 
	(case when (select count(*) from car2 where noa=substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end))>0 
	then substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	else (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where c.mon<=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) end)=b.noa 
	left join carbrand d on b.carbrandno=d.noa 
	left join carOwner e on a.custno=e.noa 
	where left(a.custno,1)='H' and a.carno!='' and (left(a.carno,6) between '"+@t_bmon+"' and '"+@t_emon+"') 
	and (case when (select count(*) from car2 where noa=substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end))>0 
	then substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	else (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where c.mon<=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) end) between '"+@t_bcarno+"' and '"+@t_ecarno+"' 
	and a.custno between '"+@t_bcarownerno+"' and '"+@t_ecarownerno+"' 
	and ("+@sql_carnos+" 1=1) 
	order by noa") 

	
	--插入tmpc(vcctran)
	declare cursor_table cursor for 
	select * from @tmpc 
	--where noa in(select noa from @tmp group by noa)
	open cursor_table 
	fetch next from cursor_table 
	into @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total 
	while(@@FETCH_STATUS <> -1) 
	begin 
	
		insert into @tmp 
		select @gno,@noa,(select right('00'+cast((cast(isnull(MAX(noq),0) as int)+1)as nvarchar(3)),3) from @tmp where noa=@noa),@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total 
	
	fetch next from cursor_table 
	into @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total 
	end 
	close cursor_table 
	deallocate cursor_table 
	end

--月小計
insert into @tmp 
select '2',noa,'',carno,carownerno,'','','','','','','','',mon,'','',SUM(outmoney),SUM(inmoney),0 from @tmp group by noa,carownerno,carno,mon

--累計
insert into @tmp 
select '3','','',carno,carownerno,'','','','','','','','','999/99','','',SUM(outmoney),SUM(inmoney),0 from @tmp 
where gno='2'
group by carownerno,carno

--欠款累計 --20130119改成最後一個月cara的金額合計(檢查是否結轉正確)
insert into @tmp 
select '4',a.noa,'',a.carno,a.carownerno,a.carowner,b.indate,b.carbrandno,d.brand,b.caryear,c.mobile,'','','999/99',a.datea,'',0,0,a.total
from cara a
left join car2 b on b.noa = a.carno
left join carOwner c on c.noa = a.carownerno 
left join carbrand d on d.noa = b.carbrandno
where a.carno in(select carno from @tmp group by carno) and mon=@t_emon
and(a.carno between @t_bcarno and @t_ecarno) and 
(a.carownerno between @t_bcarownerno and @t_ecarownerno)

--插入沒有欠款累計
insert into @tmp 
select '4','','',b.noa,b.carownerno,c.namea,b.indate,b.carbrandno,d.brand,b.caryear,c.mobile,'','','999/99','','',0,0,0
from car2 b 
left join carOwner c on c.noa = b.carownerno 
left join carbrand d on d.noa = b.carbrandno 
where b.noa in(select carno from @tmp where carno not in (select carno from @tmp where gno='4' group by carno)group by carno)
and(b.noa between @t_bcarno and @t_ecarno) and 
(b.carownerno between @t_bcarownerno and @t_ecarownerno)
-----------------------------------------------------------------------------------------------

declare @count int 
declare @t_total int 
declare @t_outmoney int 
declare @t_inmoney int
declare @t_carownerno nvarchar(20)
declare @x_total int
declare @x_count int
declare @unpay int

set @count=1
declare @t_carno nvarchar(20)
set @t_carno='XXXX'
declare @t_mon nvarchar(10)
set @t_mon='001/01/01'
set @t_total=0
set @t_outmoney=0
set @t_inmoney=0
set @t_carownerno='ZZZZ'
set @x_total =0
set @x_count =0
set @t_pagecount=1
set @unpay=0

declare cursor_table cursor for 
select * from @tmp order by carownerno,carno,mon,gno,case when caritemno='001' then caritemno else datea end,noq
open cursor_table 
fetch next from cursor_table 
into @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total
while(@@FETCH_STATUS <> -1) 
	begin 
		if(@carownerno!=@t_carownerno and @t_carownerno!='ZZZZ')
		begin
			if((@t_pagecount+1)%@pageCount=1)
				begin
					insert into @tmpa
					select '8','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,@t_xmemo,(@t_pagecount/@pageCount)+1
					set @t_pagecount=0
				end
			else
				begin
					if(@t_pagecount%@pageCount=1 and @t_pagecount!=1)
					begin
						insert into @tmpa
						select '11','','','',@t_carownerno,'','','','','','','','','','','','','','',@count,'',(@t_pagecount/@pageCount)+1
						set @count=@count+1
					end
					insert into @tmpa
					select '5','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,'',(@t_pagecount/@pageCount)+1
				end
			set @x_total =0
			set @x_count =0
			set @count=@count+1
			set @t_pagecount=@t_pagecount+1
			
			while (@t_pagecount%@pageCount>1 )
			begin
				insert into @tmpa
				select '6','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,'',(@t_pagecount/@pageCount)+1
				set @count=@count+1
				set @t_pagecount=@t_pagecount+1
			end
			
			if(@t_pagecount%@pageCount!=1)
			begin
				insert into @tmpa
				select '7','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,@t_xmemo,(@t_pagecount/@pageCount)+1
				set @count=@count+1
				set @t_pagecount=1
			end
		end
		
		if(@t_mon!=@mon)
		begin
			set @t_outmoney=0
			set @t_inmoney=0
			set @unpay=0
		end
		
		if(@t_pagecount%@pageCount=1 and @t_pagecount!=1 and (@t_carno!=@carno or @caritemno!='001'))
		begin
			insert into @tmpa
			select '11','','','',@carownerno,'','','','','','','','','','','','','','',@count,'',(@t_pagecount/@pageCount)+1
			set @count=@count+1
		end
		
		--插入gno1-廠牌年份....等資料
		if(@t_carno!=@carno or @t_carownerno!=@carownerno)
		begin
			insert into @tmpa
			select '1','','',@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,'','',@mon,'','',0,0,0,@count,'',(@t_pagecount/@pageCount)+1
			
			set @t_carno=@carno
			set @count=@count+1
			set @t_pagecount=@t_pagecount+1
			set @unpay=0
			
			--1020826加入當月沒有帳且上月有vcc未請款金額時,欠款金額補入到當月第一台車上
			if(left(@t_bmon,3)>='101' and @iacc='顯示')
			begin
				--求得開始月份之前的未付金額
				set @unpay =isnull((select 
					sum(a.total-a.payed) unpay 
					from view_vcc a left join car2 b on 
					Replace((case when (select count(*) from car2 where noa=substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end))>0 
					then substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end) 
					when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
					then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
					when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
					then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
					when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
					then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
					when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
					then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
					else (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where c.mon<=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) end),' ','') =b.noa 
					left join carbrand d on b.carbrandno=d.noa 
					left join carOwner e on a.custno=e.noa 
					where left(a.custno,1)='H' and (left(a.carno,6) < @t_bmon) 
					and (case when (select count(*) from car2 where noa=substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end))>0 
					and substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end) in (select c.carno from cara c left join car2 d on c.carno=d.noa where ((d.outdate='' or d.outdate is null) and (d.enddate='' or d.enddate is null) and (d.wastedate='' or d.wastedate is null) and (d.suspdate='' or d.suspdate is null)) and c.mon=left(a.carno,6) and a.custno=c.carownerno) 
					then substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end) 
					when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
					then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
					when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
					then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
					when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
					then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
					when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
					then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
					else (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where c.mon<=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) end)= @carno),0)
			end
			
			set @t_total=isnull(@outmoney,0)-isnull(@inmoney,0)+@unpay
			
			if(@t_pagecount%@pageCount=1 and @t_pagecount!=1)
			begin
				insert into @tmpa
				select '11','','','',@carownerno,'','','','','','','','','','','','','','',@count,'',(@t_pagecount/@pageCount)+1
				set @count=@count+1
			end
			
			--印出車牌和車主
			insert into @tmpa
			select @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney+@unpay,@inmoney,@t_total,@count,'',(@t_pagecount/@pageCount)+1
			set @count=@count+1
			set @t_pagecount=@t_pagecount+1
			set @t_outmoney=@t_outmoney+@outmoney
			set @t_inmoney=@t_inmoney+@inmoney
		end
		else
		begin
			--之後的資料不印出001
			if(@caritemno!='001')
			begin
				--計算餘額和欠款累計
				if(@gno='0')
				begin
					set @t_total=@t_total+isnull(@outmoney,0)-isnull(@inmoney,0)
					set @t_outmoney=@t_outmoney+@outmoney
					set @t_inmoney=@t_inmoney+@inmoney
				end
				
				if(@gno='2')
				begin
					insert into @tmpa
					select @gno,@noa,@noq,@carno,@carownerno,'',@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@t_outmoney+@unpay,@t_inmoney,@t_total,@count,'',(@t_pagecount/@pageCount)+1
					set @count=@count+1
					set @t_pagecount=@t_pagecount+1
				end
				else if(@gno='3')
				begin
					insert into @tmpa
					select @gno,@noa,@noq,@carno,@carownerno,'',@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney+@unpay,@inmoney,@t_total,@count,'',(@t_pagecount/@pageCount)+1
					set @count=@count+1
					set @t_pagecount=@t_pagecount+1
				end
				else
				begin
					if(@gno='0' and @t_pagecount%@pageCount=1)
						begin
							insert into @tmpa
							select @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@t_total,@count,'',(@t_pagecount/@pageCount)+1
						end
					else
						begin
							if(@gno='4')--20130119改成最後一個月cara的金額合計(檢查是否結轉正確)
							begin
								insert into @tmpa
								select @gno,@noa,@noq,'',@carownerno,'',@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@t_total,@count,'',(@t_pagecount/@pageCount)+1
								--select @gno,@noa,@noq,'',@carownerno,'',@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total,@count,'',(@t_pagecount/@pageCount)+1
							end
							else
							begin
								insert into @tmpa
								select @gno,@noa,@noq,'',@carownerno,'',@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@t_total,@count,'',(@t_pagecount/@pageCount)+1
							end
						end
					
					set @count=@count+1
					set @t_pagecount=@t_pagecount+1
					
					if(@gno='4'  and @t_pagecount%@pagecount>1)
					begin
						if(@t_pagecount%@pageCount=1 and @t_pagecount!=1)
						begin
							insert into @tmpa
							select '11',@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total,@count,'',(@t_pagecount/@pageCount)+1
							set @count=@count+1
						end
						
						insert into @tmpa
						select '6','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,'',(@t_pagecount/@pageCount)+1
						set @count=@count+1
						set @t_pagecount=@t_pagecount+1
					end
				end
			end
		end
		
		if(@gno='3')
		begin
			update @tmpa
			set outmoney=(select SUM(outmoney) from @tmpa where gno='2' and carownerno=@carownerno and carno=@carno),
				inmoney=(select SUM(inmoney) from @tmpa where gno='2' and carownerno=@carownerno and carno=@carno)
			where gno='3' and carownerno=@carownerno and carno=@carno
			
			set @x_total=@x_total+(select SUM(outmoney) from @tmpa where gno='2' and carownerno=@carownerno and carno=@carno)-(select SUM(inmoney) from @tmpa where gno='2' and carownerno=@carownerno and carno=@carno)
			set @x_count=@x_count+1
		end
		
		--set @count=@count+1
		set @t_mon=@mon
		set @t_carownerno=@carownerno
		
		fetch next from cursor_table 
		into @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total
	end 
close cursor_table 
deallocate cursor_table 
---------------------最後一筆
			if((@t_pagecount+1)%@pageCount=1)
				begin
					insert into @tmpa
					select '8','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,@t_xmemo,(@t_pagecount/@pageCount)+1
				end
			else
				begin
					insert into @tmpa
					select '5','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,'',(@t_pagecount/@pageCount)+1
				end
			set @x_total =0
			set @x_count =0
			set @count=@count+1
			set @t_pagecount=@t_pagecount+1
			
			while (@t_pagecount%@pageCount>1 )
			begin
				insert into @tmpa
				select '6','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,'',(@t_pagecount/@pageCount)+1
				set @count=@count+1
				set @t_pagecount=@t_pagecount+1
			end
			
			if(@t_pagecount%@pageCount!=1)
			begin
				insert into @tmpa
				select '7','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,@t_xmemo,(@t_pagecount/@pageCount)+1
				set @count=@count+1
				set @t_pagecount=1
			end
---------------(信封)------------------------------------------
declare @zip nvarchar(50)
declare @addr nvarchar(200)
declare @xmemo nvarchar(MAX) 
declare @page int

declare @now_date nvarchar(10)--現在日期
set @now_date=CONVERT (VARCHAR(7), GETDATE(),12 )+0890000
set @now_date=left(@now_date,3)+'/'+substring(@now_date,4,2)+'/'+right(@now_date,2)

declare @tmpb table( 
	[gno] nvarchar(2), 
	[noa] nvarchar(30), 
	[noq] nvarchar(20), 
	[carno] nvarchar(20), 
	[carownerno] nvarchar(20), 
	[carowner] nvarchar(50), 
	[indate] nvarchar(10), 
	[carbrandno] nvarchar(20), 
	[carbrand] nvarchar(50), 
	[caryear] nvarchar(10), 
	[mobile] nvarchar(50), 
	[caritemno] nvarchar(50), 
	[caritem] nvarchar(50), 
	[mon] nvarchar(20), 
	[datea] nvarchar(20), 
	[memo] nvarchar(max), 
	[outmoney] int, 
	[inmoney] int, 
	[total] int, 
	[count] int,
	[xmemo] nvarchar(max),
	page int,
	zip nvarchar(50),
	addr nvarchar(200),
	nowdate nvarchar(10)
) 

declare cursor_table cursor for 
select * from @tmpa order by count
open cursor_table 
fetch next from cursor_table 
into @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total,@count,@xmemo,@page
while(@@FETCH_STATUS <> -1) 
	begin 
		insert into @tmpb
		select @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total,@count,@xmemo,@page,'','',@now_date
		
		if(@gno='7' or @gno='8')
		begin
			set @zip=(select zip_conn from carOwner where noa=@carownerno)
			set @addr=(select addr_conn from carOwner where noa=@carownerno)
			set @carowner=(select namea from carOwner where noa=@carownerno)
			insert into @tmpb
			select '9',@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total,0,'',1,@zip,@addr,@now_date
			insert into @tmpb
			select '10',@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total,0,'',1,@zip,@addr,@now_date
			insert into @tmpb
			select '11',@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total,0,'',1,@zip,@addr,@now_date
		end
		
		fetch next from cursor_table 
		into @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total,@count,@xmemo,@page
	end 
close cursor_table 
deallocate cursor_table 

--select gno,noa,noq,carno,carownerno,carowner,indate,carbrandno,carbrand,caryear,mobile,caritemno,caritem,mon,datea,left(memo,15) memo
--,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,outmoney),1)),4,12)) outmoney
--,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,inmoney),1)),4,12)) inmoney
--,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total
--,count,xmemo,zip,addr,nowdate,page
--from @tmpb order by carownerno,count

select gno,a.noa,noq,carno,carownerno,carowner,indate,carbrandno,carbrand,caryear,mobile,caritemno,caritem,mon,datea,left(memo,17) memo 
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,outmoney),1)),4,12)) outmoney 
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,inmoney),1)),4,12)) inmoney 
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total 
,count,xmemo xsmemo,zip,addr,nowdate,page 
from @tmpb a left join (select noa,namea from carowner) b on a.carownerno=b.noa order by b.namea,carownerno,count;

--------------------------------------------------------------------------------------------------
z_carpack:--z_carpack
declare @t_bcardealno nvarchar(20) 
declare @t_ecardealno nvarchar(20) 
declare @t_enddate nvarchar(10) 
	
set @t_bcardealno = case when '#non'=[5] then '' else [5] end
set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
set @t_enddate = case when '#non'=[15] then '' else [15] end
-----------------------------------------------------------------------------------------------------------------------
declare @tmp table( 
	gno nvarchar(20),
	noa nvarchar(50),
	cardealno nvarchar(50), 
	cardeal nvarchar(100),
	bxdate nvarchar(20),
	exdate nvarchar(20),
	typea nvarchar(MAX),
	mount nvarchar(MAX),
	rate nvarchar(MAX),
	a1 float,
	b1 float,
	c1 float,
	a2 float,
	b2 float,
	c2 float,
	d2 float,--曳引車 可停半拖車位
	e2 float,--半拖車位 -半拖車位拿去車位
	a3 float,
	b3 float,
	c3 float,
	money float, 
	place nvarchar(50)
) 

insert @tmp
select '0',a.noa,a.cardealno,c.nick,a.bdate,a.edate
,isnull(typea,''),isnull(mount,''),isnull(rate,''),0,0,0
,isnull(b.a2,0),isnull(b.b2,0),isnull(b.c2,0),0,0,0,0,0,money,place
from carpack a left join (
	select cardealno
	,sum(case when left(carspecno,1)='A' then 1 else 0 end) a2
	,sum(case when left(carspecno,1)='B' then 1 else 0 end) b2
	,sum(case when left(carspecno,1)='C' then 1 else 0 end) c2
	from car2
	where cardealno!='' and indate<@t_enddate and (cardealno between @t_bcardealno and @t_ecardealno) and carownerno!='' 
	and (isnull(outdate,'')='' or outdate>@t_enddate) and (isnull(suspdate,'')='' or suspdate>@t_enddate) 
	and (isnull(enddate,'')='' or enddate>@t_enddate) and (isnull(wastedate,'')='' or wastedate>@t_enddate) 
	group by cardealno
)b on a.cardealno=b.cardealno
left join cardeal c on a.cardealno=c.noa
where (a.cardealno between @t_bcardealno and @t_ecardealno) and a.edate>@t_enddate
order by a.cardealno,a.bdate,a.edate

declare @noa nvarchar(50) 
declare @typea nvarchar(MAX) 
declare @mount nvarchar(MAX) 
declare @rate nvarchar(MAX) 
declare @t_typea nvarchar(MAX) 
declare @x_typea nvarchar(MAX) 
declare @t_mount nvarchar(MAX) 
declare @t_rate nvarchar(MAX) 

declare cursor_table cursor for 
select noa,typea,mount,rate from @tmp 
open cursor_table 
fetch next from cursor_table 
into @noa,@typea,@mount,@rate
while(@@FETCH_STATUS <> -1) 
begin 
	select @t_typea=@typea,@t_mount=@mount,@t_rate=@rate
	
	while(charindex(',',@t_typea)>0)
	begin
		select @x_typea=LEFT(@t_typea,charindex(',',@t_typea)-1)
		if(@x_typea='A')
		begin
			update @tmp 
			set a1=a1+cast(LEFT(@t_mount,charindex(',',@t_mount)-1)as float)
			,a3=cast(LEFT(@t_rate,charindex(',',@t_rate)-1)as float)
			where noa=@noa
		end
		if(@x_typea='B')
		begin
			update @tmp 
			set b1=b1+cast(LEFT(@t_mount,charindex(',',@t_mount)-1)as float)
			,b3=cast(LEFT(@t_rate,charindex(',',@t_rate)-1)as float)
			where noa=@noa
		end
		if(@x_typea='C')
		begin
			update @tmp 
			set c1=c1+cast(LEFT(@t_mount,charindex(',',@t_mount)-1)as float)
			,c3=cast(LEFT(@t_rate,charindex(',',@t_rate)-1)as float)
			where noa=@noa
		end
		
		set @t_typea=SUBSTRING(@t_typea,charindex(',',@t_typea)+1,LEN(@t_typea))
		set @t_mount=SUBSTRING(@t_mount,charindex(',',@t_mount)+1,LEN(@t_mount))
		set @t_rate=SUBSTRING(@t_rate,charindex(',',@t_rate)+1,LEN(@t_rate))
	end
	
	select @x_typea=@t_typea
	if(@x_typea='A')
	begin
		update @tmp 
		set a1=a1+cast(@t_mount as float),a3=cast(@t_rate as float)
		where noa=@noa
	end
	if(@x_typea='B')
	begin
		update @tmp 
		set b1=b1+cast(@t_mount as float),b3=cast(@t_rate as float)
		where noa=@noa
	end
	if(@x_typea='C')
	begin
		update @tmp 
		set c1=c1+cast(@t_mount as float),c3=cast(@t_rate as float)
		where noa=@noa
	end
	
	fetch next from cursor_table 
	into @noa,@typea,@mount,@rate
end 
close cursor_table 
deallocate cursor_table 

insert @tmp (gno,cardealno,cardeal,a1,b1,c1,a2,b2,c2,money,d2,e2)
select '1',cardealno,MAX(cardeal),SUM(a1),SUM(b1),SUM(c1)
,SUM(a1*a3)-MAX(a2),SUM(b1*b3)-MAX(b2),SUM(c1*c3)-MAX(c2),SUM(money)
,FLOOR((SUM(b1*b3)-MAX(b2))/(case when MAX(b3)=0 then 8 else MAX(b3) end))
*(case when MAX(b3)=0 then 8 else MAX(b3) end)*2
,SUM(b1*b3)-MAX(b2)-FLOOR((SUM(b1*b3)-MAX(b2))/(case when MAX(b3)=0 then 8 else MAX(b3) end))*(case when MAX(b3)=0 then 8 else MAX(b3) end)
from @tmp group by cardealno

--曳引車位足夠
update @tmp set e2=0 where gno='1' and b2<0

--更新半拖車位還多且易引車位不夠的車位數
update @tmp 
set b2=b2,a2=a2+d2,d2=0
where gno='1' and a2<0 and d2>0

insert @tmp (gno,cardealno,a1,b1,c1,a2,b2,c2,money)
select '2',CHAR(255),SUM(a1),SUM(b1),SUM(c1)
,SUM(a2),SUM(b2),SUM(c2),SUM(money)
from @tmp where gno='1'

update @tmp set a1=null where gno='0' and a1=0
update @tmp set b1=null where gno='0' and b1=0
update @tmp set c1=null where gno='0' and c1=0
update @tmp set a2=null where gno='0' and a2=0
update @tmp set b2=null where gno='0' and b2=0
update @tmp set c2=null where gno='0' and c2=0

select 
dbo.getComma(a1,0) a1,
dbo.getComma(b1,0) b1,
dbo.getComma(c1,0) c1,
dbo.getComma(a2,0)+(case when d2>0 and gno='1' then '('+dbo.getComma(d2,0)+')' else '' end) a2,
dbo.getComma(b2,0)+(case when e2>0 and gno='1' then '('+dbo.getComma(e2,0)+')' else '' end) b2, 
dbo.getComma(c2,0) c2,
dbo.getComma(money,0) money,
* 
from @tmp order by cardealno,gno,bxdate,exdate;

--*****************************************************************************************
z_backup1:--z_backup1
declare @t_bmon nvarchar(20)
declare @t_emon nvarchar(20)
declare @t_bcarownerno nvarchar(20)
declare @t_ecarownerno nvarchar(20)
set @t_bmon = case when '#non' = [1] then '' else [1] end
set @t_emon = case when '#non' = [2] then CHAR(255) else [2] end
set @t_bcarownerno = case when '#non' = [7] then '' else [7] end
set @t_ecarownerno = case when '#non' = [8] then CHAR(255) else [8] end
declare @tmp table(
		gno nvarchar(1),
		noa nvarchar(30),
		noq nvarchar(20),
		mon nvarchar(10),
		datea nvarchar(10),
		carownerno nvarchar(20),
		carowner nvarchar(50),
		carno nvarchar(20),
		memo nvarchar(100),
		outmoney float,
		inmoney float,
		mount float 
) 
insert into @tmp 
select '0' gno,a.noa,b.noq,b.mon,b.datea,a.carownerno,a.carowner,a.carno,b.memo,b.outmoney,b.inmoney,0
from cara a 
left join caras b on a.noa = b.noa 
where (b.mon between @t_bmon and @t_emon) and 
(a.carownerno between @t_bcarownerno and @t_ecarownerno) and 
(b.caritem='健勞保費') 

insert into @tmp 
select '1' gno,'','','','',CHAR(255),'','','',sum(outmoney),sum(inmoney),COUNT(DISTINCT carowner)  
from @tmp 

select gno,noa,noq,mon,datea,carownerno,carowner,carno,memo, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,outmoney),1)),4,12)) outmoney, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,inmoney),1)),4,12)) inmoney,mount 
from @tmp 
order by gno,carowner,datea;

----------------------------------------------------
z_cara4:--z_cara4車主欠款明細(A4)
SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_pagecount int
	declare @pagecount int
	declare @t_bmon nvarchar(10)
	declare @t_emon nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_bcarno nvarchar(20)
	declare @t_ecarno nvarchar(20)
	declare @t_xcarnos nvarchar(MAX) 
	declare @sql_carnos nvarchar(MAX)
	declare @t_xmemo nvarchar(MAX) 
	declare @xyear nvarchar(20)
	declare @iacc nvarchar(20)
	
	set @pageCount = 40
	set @t_bmon = case when '#non'=[1] then '' else [1] end
	set @t_emon = case when '#non'=[2] then char(255) else [2] end
	set @t_bdate = case when '#non'=[3] then '' else [3] end
	set @t_edate = case when '#non'=[4] then char(255) else [4] end	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_bcarno = case when '#non'=[16] then '' else [16] end
	set @t_ecarno = case when '#non'=[17] then CHAR(255) else [17] end
	set @t_xcarnos = case when '#non'=[25] then '' else [25] end
	set @sql_carnos=''
	set @t_xmemo  = case when '#non'=[30] then '' else [30] end
	set @xyear='[38]'
	set @iacc=case when '#non'=[39] then '' else [39] end
	
if(RIGHT(@t_xcarnos,1)='.')
set @t_xcarnos=left(@t_xcarnos,len(@t_xcarnos)-1)
	
while(LEN(@t_xcarnos)>0)
begin
if(CHARINDEX('.',@t_xcarnos)=0)
begin
set @sql_carnos=@sql_carnos+' b.carno='''+@t_xcarnos+''' and'
set @t_xcarnos=''
end
if(CHARINDEX('.',@t_xcarnos)>0)
begin
set @sql_carnos=@sql_carnos+' b.carno='''+left(@t_xcarnos,CHARINDEX('.',@t_xcarnos)-1)+''' or'
set @t_xcarnos=RIGHT(@t_xcarnos,LEN(@t_xcarnos)-CHARINDEX('.',@t_xcarnos))
end
end


declare @tmp table( 
	[gno] nvarchar(1), 
	[noa] nvarchar(30), 
	[noq] nvarchar(20), 
	[carno] nvarchar(20), 
	[carownerno] nvarchar(20), 
	[carowner] nvarchar(50), 
	[indate] nvarchar(10), 
	[carbrandno] nvarchar(20), 
	[carbrand] nvarchar(50), 
	[caryear] nvarchar(10), 
	[mobile] nvarchar(50), 
	[caritemno] nvarchar(50), 
	[caritem] nvarchar(50), 
	[mon] nvarchar(20), 
	[datea] nvarchar(20), 
	[memo] nvarchar(max), 
	[outmoney] int, 
	[inmoney] int, 
	[total] int, 
	primary key (carownerno,carno,noa,noq,gno) 
)

declare @tmpa table( 
	[gno] nvarchar(1), 
	[noa] nvarchar(30), 
	[noq] nvarchar(20), 
	[carno] nvarchar(20), 
	[carownerno] nvarchar(20), 
	[carowner] nvarchar(50), 
	[indate] nvarchar(10), 
	[carbrandno] nvarchar(20), 
	[carbrand] nvarchar(50), 
	[caryear] nvarchar(10), 
	[mobile] nvarchar(50), 
	[caritemno] nvarchar(50), 
	[caritem] nvarchar(50), 
	[mon] nvarchar(20), 
	[datea] nvarchar(20), 
	[memo] nvarchar(max), 
	[outmoney] int, 
	[inmoney] int, 
	[total] int, 
	[count] int,
	[xmemo] nvarchar(max)
) 

declare @tmpb table( 
	[gno] nvarchar(1),
	[noa] nvarchar(30), 
	[noq] nvarchar(20), 
	[carno] nvarchar(20), 
	[carownerno] nvarchar(20), 
	[carowner] nvarchar(50), 
	[indate] nvarchar(10), 
	[carbrandno] nvarchar(20), 
	[carbrand] nvarchar(50), 
	[caryear] nvarchar(10), 
	[mobile] nvarchar(50), 
	[caritemno] nvarchar(50), 
	[caritem] nvarchar(50), 
	[mon] nvarchar(20), 
	[datea] nvarchar(20), 
	[memo] nvarchar(max), 
	[outmoney] int, 
	[inmoney] int, 
	[total] int
) 

declare @gno nvarchar(1) 
declare @noa nvarchar(20) 
declare @noq nvarchar(3) 
declare @carno nvarchar(20)
declare @carownerno nvarchar(20) 
declare @carowner nvarchar(50)
declare @indate nvarchar(20) 
declare @carbrandno nvarchar(20)
declare @carbrand nvarchar(50)
declare @caryear nvarchar(20)
declare @mobile nvarchar(50)
declare @caritemno nvarchar(50)
declare @caritem nvarchar(50)
declare @mon nvarchar(10)
declare @datea nvarchar(10)
declare @memo nvarchar(Max)
declare @outmoney int 
declare @inmoney int 
declare @total int 

--102/08/07 婉容勞健保轉過來的字要去掉(健勞保調整)
set @cmd =	"select a.*,0 "+ 
" from( " + 
"select '0' gno,a.noa ,a.noq,b.carno,isNull(b.carownerno,'') carownerno,isNull(d.namea,'') carowner,ISNULL(c.indate,'') indate, "+ 
"ISNULL(e.noa,'') carbrandno,ISNULL(e.brand,'') carbrand,ISNULL(c.caryear,'') caryear,ISNULL(d.mobile,'') mobile, "+ 
"a.caritemno ,a.caritem ,b.mon,a.datea,(case when a.caritemno!='403' then a.memo else replace(a.memo,'健勞保調整 ','') end)memo,a.outmoney,a.inmoney "+ 
"from caras a "+ 
"left join cara b on b.noa = a.noa "+ 
"left join car2 c on c.noa = b.carno "+ 
"left join carOwner d on d.noa = b.carownerno "+ 
"left join carbrand e on e.noa = c.carbrandno "+ 
" where "+ 
"(b.carno between @t_bcarno and @t_ecarno) and "+ 
"(b.carownerno between @t_bcarownerno and @t_ecarownerno) and "+ 
"(b.mon between @t_bmon and @t_emon) and"+ 
"("+@sql_carnos+" 1=1)"+
" ) a" 

--全部費用
insert into @tmp 
execute sp_executesql @cmd,N'@t_bcarno nvarchar(20),@t_ecarno nvarchar(20),@t_bcarownerno nvarchar(20),@t_ecarownerno nvarchar(20), 
@t_bmon nvarchar(10),@t_emon nvarchar(10)', 
@t_bcarno = @t_bcarno,@t_ecarno = @t_ecarno,@t_bcarownerno=@t_bcarownerno,@t_ecarownerno=@t_ecarownerno, 
@t_bmon=@t_bmon,@t_emon=@t_emon 

--1020312更新加入VCCTRAN的車主資料 --1020410加入判斷是否要顯示內帳(VCC)資料
if(left(@t_bmon,3)>='101' and @iacc='顯示')
begin
	--102/08/07 婉容睿庭 第一個和第二個空白之間為指定車牌,若沒有抓車主沒有遷出的第一台車,且備註去掉指定車牌
	insert into @tmpb
	exec(" 
	select '0'gno, 
	Replace((case when (select count(*) from car2 where noa=substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end))>0 
	then substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	else (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where c.mon<=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) end) 
	,' ','')+'-'+left(a.carno,6) noa ,'999' noq 
	,Replace((case when (select count(*) from car2 where noa=substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end))>0 
	then substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	else (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where c.mon<=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) end) 
	,' ','') carno 
	,a.custno carownerno,a.comp carowner,b.indate,b.carbrandno,d.brand,b.caryear,e.mobile,'' caritemno,(case when CHARINDEX('理賠',a.memo)>0 then '*其他' when CHARINDEX('請款',a.memo)>0 then '*請款' else '*發票稅費' end) caritem 
	,left(a.carno,6) mon,a.carno 
	,replace(a.memo,' '+(case when (select count(*) from car2 where noa=substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end))>0 
	then substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	else (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where c.mon<=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) end) 
	,'') memo 
	,a.total outmoney ,a.payed inmoney,0 
	from view_vcc a left join car2 b on 
	(case when (select count(*) from car2 where noa=substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end))>0 
	then substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	else (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where c.mon<=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) end)=b.noa 
	left join carbrand d on b.carbrandno=d.noa 
	left join carOwner e on a.custno=e.noa 
	where left(a.custno,1)='H' and a.carno!='' and (left(a.carno,6) between '"+@t_bmon+"' and '"+@t_emon+"') 
	and (case when (select count(*) from car2 where noa=substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end))>0 
	then substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
	then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
	else (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where c.mon<=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) end) between '"+@t_bcarno+"' and '"+@t_ecarno+"' 
	and a.custno between '"+@t_bcarownerno+"' and '"+@t_ecarownerno+"' 
	and ("+@sql_carnos+" 1=1) 
	order by noa") 

	--插入tmpb(vcctran)
	declare cursor_table cursor for 
	select * from @tmpb 
	--where noa in(select noa from @tmp group by noa)
	open cursor_table 
	fetch next from cursor_table 
	into @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total 
	while(@@FETCH_STATUS <> -1) 
	begin 
	
	insert into @tmp 
	select @gno,@noa,(select right('00'+cast((cast(isnull(MAX(noq),0) as int)+1)as nvarchar(3)),3) from @tmp where noa=@noa),@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total 
	
	fetch next from cursor_table 
	into @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total 
	end 
	close cursor_table 
	deallocate cursor_table 
end

--月小計
insert into @tmp 
select '2',noa,'',carno,carownerno,'','','','','','','','',mon,'','',SUM(outmoney),SUM(inmoney),0 from @tmp group by noa,carownerno,carno,mon

--累計
insert into @tmp 
select '3','','',carno,carownerno,'','','','','','','','','999/99','','',SUM(outmoney),SUM(inmoney),0 from @tmp 
where gno='2'
group by carownerno,carno

--欠款累計 --20130119改成最後一個月cara的金額合計(檢查是否結轉正確)
insert into @tmp 
select '4',a.noa,'',a.carno,a.carownerno,a.carowner,b.indate,b.carbrandno,d.brand,b.caryear,c.mobile,'','','999/99',a.datea,'',0,0,a.total
from cara a
left join car2 b on b.noa = a.carno
left join carOwner c on c.noa = a.carownerno 
left join carbrand d on d.noa = b.carbrandno
where a.carno in(select carno from @tmp group by carno) and mon=@t_emon
and(a.carno between @t_bcarno and @t_ecarno) and 
(a.carownerno between @t_bcarownerno and @t_ecarownerno)

-----------------------------------------------------------------------------------------------
declare @count int 
declare @t_total int 
declare @t_outmoney int 
declare @t_inmoney int
declare @t_carownerno nvarchar(20)
declare @x_total int
declare @x_count int
declare @unpay int

set @count=1
declare @t_carno nvarchar(20)
set @t_carno='XXXX'
declare @t_mon nvarchar(10)
set @t_mon='001/01/01'
set @t_total=0
set @t_outmoney=0
set @t_inmoney=0
set @t_carownerno='ZZZZ'
set @x_total =0
set @x_count =0
set @t_pagecount=1
set @unpay=0

declare cursor_table cursor for 
select * from @tmp order by carownerno,carno,mon,gno,case when caritemno='001' then caritemno else datea end,noq
open cursor_table 
fetch next from cursor_table 
into @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total
while(@@FETCH_STATUS <> -1) 
	begin 
		if(@carownerno!=@t_carownerno and @t_carownerno!='ZZZZ')
		begin
			if((@t_pagecount+1)%@pageCount=1)
				begin
					insert into @tmpa
					select '8','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,@t_xmemo
				end
			else
				begin
					insert into @tmpa
					select '5','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,''
				end
			set @x_total =0
			set @x_count =0
			set @count=@count+1
			set @t_pagecount=@t_pagecount+1
			
			while (@t_pagecount%@pageCount>1 )
			begin
				insert into @tmpa
				select '6','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,''
				set @count=@count+1
				set @t_pagecount=@t_pagecount+1
			end
			
			if(@t_pagecount%@pageCount!=1)
			begin
				insert into @tmpa
				select '7','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,@t_xmemo
				set @count=@count+1
				set @t_pagecount=1
			end
		end
		
		if(@t_mon!=@mon)
		begin
			set @t_outmoney=0
			set @t_inmoney=0
			set @unpay=0
		end
	
		--插入gno1-廠牌年份....等資料
		if(@t_carno!=@carno or @t_carownerno!=@carownerno)
		begin
			insert into @tmpa
			select '1','','',@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,'','',@mon,'','',0,0,0,@count,''
			
			set @t_carno=@carno
			set @count=@count+1
			set @t_pagecount=@t_pagecount+1
			set @unpay=0
			
			--1020826加入當月沒有帳且上月有vcc未請款金額時,欠款金額補入到當月第一台車上
			if(left(@t_bmon,3)>='101' and @iacc='顯示')
			begin
				--求得開始月份之前的未付金額
				set @unpay =isnull((select 
					sum(a.total-a.payed) unpay 
					from view_vcc a left join car2 b on 
					Replace((case when (select count(*) from car2 where noa=substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end))>0 
					then substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end) 
					when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
					then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
					when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
					then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
					when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
					then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
					when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
					then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
					else (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where c.mon<=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) end),' ','') =b.noa 
					left join carbrand d on b.carbrandno=d.noa 
					left join carOwner e on a.custno=e.noa 
					where left(a.custno,1)='H' and (left(a.carno,6) < @t_bmon) 
					and (case when (select count(*) from car2 where noa=substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end))>0 
					and substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end) in (select c.carno from cara c left join car2 d on c.carno=d.noa where ((d.outdate='' or d.outdate is null) and (d.enddate='' or d.enddate is null) and (d.wastedate='' or d.wastedate is null) and (d.suspdate='' or d.suspdate is null)) and c.mon=left(a.carno,6) and a.custno=c.carownerno) 
					then substring(substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)),0,case when CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0 then CHARINDEX(' ',substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))) else len(a.memo) end) 
					when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
					then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
					when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
					then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='A' or left(d.carspecno,1)='C')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
					when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
					then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (isnull(d.outdate,'')='' and isnull(d.enddate,'')='' and isnull(d.wastedate,'')='' and isnull(d.suspdate,'')='') and (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
					when (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) is not null 
					then (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where (left(d.carspecno,1)='B')  and c.mon=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) 
					else (select top 1 c.carno from cara c left join car2 d on c.carno=d.noa where c.mon<=left(a.carno,6) and a.custno=c.carownerno order by c.mon desc,c.carno) end)= @carno),0)
			end
			
			set @t_total=isnull(@outmoney,0)-isnull(@inmoney,0)+@unpay
			
			--印出車牌和車主
			insert into @tmpa
			select @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney+@unpay,@inmoney,@t_total,@count,''
			set @count=@count+1
			set @t_pagecount=@t_pagecount+1
			set @t_outmoney=@t_outmoney+@outmoney
			set @t_inmoney=@t_inmoney+@inmoney
			
		end
		else
		begin
			--之後的資料不印出001
			if(@caritemno!='001')
			begin
				--計算餘額和欠款累計
				if(@gno='0')
				begin
					set @t_total=@t_total+isnull(@outmoney,0)-isnull(@inmoney,0)
					set @t_outmoney=@t_outmoney+@outmoney
					set @t_inmoney=@t_inmoney+@inmoney
				end
				
				if(@gno='2')
				begin
					insert into @tmpa
					select @gno,@noa,@noq,@carno,@carownerno,'',@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@t_outmoney+@unpay,@t_inmoney,@t_total,@count,''
					set @count=@count+1
					set @t_pagecount=@t_pagecount+1
				end
				else if(@gno='3')
				begin
					insert into @tmpa
					select @gno,@noa,@noq,@carno,@carownerno,'',@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney+@unpay,@inmoney,@t_total,@count,''
					set @count=@count+1
					set @t_pagecount=@t_pagecount+1
				end
				else
				begin
					if(@gno='0' and @t_pagecount%@pageCount=1)
						begin
							insert into @tmpa
							select @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@t_total,@count,''
						end
					else
						begin
							if(@gno='4')--20130119改成最後一個月cara的金額合計(檢查是否結轉正確)
							begin
								insert into @tmpa
								select @gno,@noa,@noq,'',@carownerno,'',@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@t_total,@count,''
								--select @gno,@noa,@noq,'',@carownerno,'',@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total,@count,''
							end
							else
							begin
								insert into @tmpa
								select @gno,@noa,@noq,'',@carownerno,'',@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@t_total,@count,''
							end
						end
					
					set @count=@count+1
					set @t_pagecount=@t_pagecount+1
					if(@gno='4')
					begin
						insert into @tmpa
						select '6','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,''
						set @count=@count+1
						set @t_pagecount=@t_pagecount+1
					end
				end
				
			end
		end
		
		if(@gno='3')
		begin
			update @tmpa
			set outmoney=(select SUM(outmoney) from @tmpa where gno='2' and carownerno=@carownerno and carno=@carno),
				inmoney=(select SUM(inmoney) from @tmpa where gno='2' and carownerno=@carownerno and carno=@carno)
			where gno='3' and carownerno=@carownerno and carno=@carno
			
			set @x_total=@x_total+(select SUM(outmoney) from @tmpa where gno='2' and carownerno=@carownerno and carno=@carno)-(select SUM(inmoney) from @tmpa where gno='2' and carownerno=@carownerno and carno=@carno)
			set @x_count=@x_count+1
		end
		
		--set @count=@count+1
		set @t_mon=@mon
		set @t_carownerno=@carownerno
		
		fetch next from cursor_table 
		into @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total
	end 
close cursor_table 
deallocate cursor_table 
---------------------最後一筆
			if((@t_pagecount+1)%@pageCount=1)
				begin
					insert into @tmpa
					select '8','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,@t_xmemo
				end
			else
				begin
					insert into @tmpa
					select '5','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,''
				end
			set @x_total =0
			set @x_count =0
			set @count=@count+1
			set @t_pagecount=@t_pagecount+1
			
			while (@t_pagecount%@pageCount>1 )
			begin
				insert into @tmpa
				select '6','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,''
				set @count=@count+1
				set @t_pagecount=@t_pagecount+1
			end
			
			if(@t_pagecount%@pageCount!=1)
			begin
				insert into @tmpa
				select '7','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,@t_xmemo
				set @count=@count+1
				set @t_pagecount=1
			end
----------------------------------
select gno,noa,noq,carno,carownerno,carowner,indate,carbrandno,carbrand,caryear,mobile,caritemno,caritem,mon,datea,left(memo,17) memo
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,outmoney),1)),4,12)) outmoney
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,inmoney),1)),4,12)) inmoney
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total
,count,xmemo xsmemo
from @tmpa order by count;
--------------------------------------------------------------------------------------------------
z_car35:--z_car35
declare @t_bmon nvarchar(20)
declare @t_emon nvarchar(20)
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
declare @t_bcardealno nvarchar(20)
declare @t_ecardealno nvarchar(20)
declare @t_bcarownerno nvarchar(20)
declare @t_ecarownerno nvarchar(20)
declare @t_bcarno nvarchar(20)
declare @t_ecarno nvarchar(20)
declare @t_bcaritemno nvarchar(20)
declare @t_ecaritemno nvarchar(20)
declare @t_order nvarchar(20)
declare @carc nvarchar(20)
declare @t_sssno nvarchar(50)

set @t_bmon = case when '#non' = [1] then '' else [1] end
set @t_emon = case when '#non' = [2] then CHAR(255) else [2] end
set @t_bdate = case when '#non' = [3] then '' else [3] end
set @t_edate = case when '#non' = [4] then CHAR(255) else [4] end
set @t_bcardealno = case when '#non'=[5] then '' else [5] end
set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end
set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end
set @t_bcarno = case when '#non' = [16] then '' else [16] end
set @t_ecarno = case when '#non' = [17] then CHAR(255) else [17] end
set @t_bcaritemno = case when '#non' = [32] then '' else [32] end
set @t_ecaritemno = case when '#non' = [33] then CHAR(255) else [33] end
set @t_order = case when '#non' = [34] then '車牌' else [34] end
set @carc = case when '#non'=[41] then '' else [41] end
set @t_sssno  = case when '#non'=[24] then char(255) else [24] end	
--**********************************************************************************************
SET QUOTED_IDENTIFIER OFF
declare @cmd nvarchar(MAX)
declare @tmp table( 
	gno nvarchar(1), 
	idno int identity(0,1),
	mon nvarchar(10), 
	datea nvarchar(10), 
	carno nvarchar(20), 
	carownerno nvarchar(20), 
	carowner nvarchar(50), 
	cardealno nvarchar(20), 
	cardeal nvarchar(50), 
	caritemno nvarchar(20), 
	caritem nvarchar(20), 
	outmoney float, 
	inmoney float, 
	memo nvarchar(200) 
) 

set @cmd=" 
	select '0'gno,a.mon,a.datea,a.carno,b.carownerno,b.carowner,c.cardealno,d.nick, 
	a.caritemno,a.caritem,a.outmoney,a.inmoney,a.memo from caras a 
	left join cara b on a.noa=b.noa 
	left join car2 c on b.carno=c.noa 
	left join cardeal d on c.cardealno=d.noa 
	where (a.mon between '"+@t_bmon+"' and '"+@t_emon+"') and 
	(a.datea between '"+@t_bdate+"' and '"+@t_edate+"') and 
	(a.carno between '"+@t_bcarno+"' and '"+@t_ecarno+"') and 
	(a.caritemno between '"+@t_bcaritemno+"' and '"+@t_ecaritemno+"') and 
	(b.carownerno between '"+@t_bcarownerno+"' and '"+@t_ecarownerno+"') and 
	(c.cardealno between '"+@t_bcardealno+"' and '"+@t_ecardealno+"') "
	
	
declare @ssscount int 
set @ssscount=0 

if(@t_sssno!=char(255)) 
begin 
	while(PATINDEX('%,%',@t_sssno)>0) 
	begin 
		if (@ssscount=0) 
			set @cmd=@cmd+' and (b.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+'''' 
		else 
			set @cmd=@cmd+' or b.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+'''' 
			
		set @t_sssno=RIGHT(@t_sssno,LEN(@t_sssno)-PATINDEX('%,%',@t_sssno)) 
		set @ssscount=@ssscount+1 
	end 
	
	if (@ssscount=0) 
		set @cmd=@cmd+' and b.sssno='''+@t_sssno+'''' 
	else 
		set @cmd=@cmd+' or b.sssno='''+@t_sssno+''')' 
end 
	
if(@carc='未付立帳')
begin
	set @cmd=@cmd+"and (udate='' or udate is null)
	and caritemno!='401' and caritemno!='001' and caritemno!='002' and caritemno!='101' 
	and caritemno!='102' and caritemno!='105' and caritemno!='106' and caritemno!='111' 
	and caritemno!='112' and caritemno!='202' and caritemno!='203' 
	and ummnoa='' and a.outmoney!=0 "
end

if(@t_order='車牌')
begin
	set @cmd=@cmd+"order by a.mon,a.datea,a.carno,b.carowner "
end

if(@t_order='車主')
begin
	set @cmd=@cmd+"order by a.mon,a.datea,b.carowner,a.carno"
end

if(@t_order='車行')
begin
	set @cmd=@cmd+"order by a.mon,a.datea,c.cardealno ,a.carno"
end

insert into @tmp 
execute sp_executesql @cmd

insert into @tmp 
select '1' gno,mon,datea,'','','','','','','',SUM(outmoney),SUM(inmoney),'' 
from @tmp 
group by mon,datea

insert into @tmp 
select '2' gno,CHAR(255),CHAR(255),CHAR(255),CHAR(255),CHAR(255),CHAR(255),CHAR(255),'','',SUM(outmoney),SUM(inmoney),'' 
from @tmp where gno='0'

declare @tmpa table( 
	gno nvarchar(1), 
	idno int,
	mon nvarchar(10), 
	datea nvarchar(10), 
	carno nvarchar(20), 
	carownerno nvarchar(20), 
	carowner nvarchar(50), 
	cardealno nvarchar(20), 
	cardeal nvarchar(50), 
	caritemno nvarchar(20), 
	caritem nvarchar(20), 
	outmoney float, 
	inmoney float, 
	memo nvarchar(200) 
) 
insert into @tmpa
select * from @tmp
order by mon,datea,gno,idno

declare @mon nvarchar(20)
declare @datea nvarchar(20)
declare @carno nvarchar(20)
declare @carowner nvarchar(20)
declare @t_mon nvarchar(20)
declare @t_datea nvarchar(20)
declare @t_carno nvarchar(20)
declare @t_carowner nvarchar(20)
set @t_mon = 'qwerty'
set @t_datea = 'asdfg'
set @t_carno = 'wdfvbg'
set @t_carowner = 'plmkiuj'
	declare cursor_table cursor for
	select mon,datea,carno,carowner
	from @tmpa
	open cursor_table 
	fetch next from cursor_table
	into @mon,@datea,@carno,@carowner
	while(@@FETCH_STATUS <> -1)
	begin
		if (@mon = @t_mon) and (@datea = @t_datea) and (@t_mon != 'qwerty') and (@t_datea != 'asdfg')
		begin
			if (@carno = @t_carno) and (@carowner = @t_carowner) and ( @t_carno != 'wdfvbg') and ( @t_carowner != 'plmkiuj')
			begin
				update @tmpa set mon ='',datea = '',carno = '',carowner = '' where current of cursor_table
			end
			else 
			begin 
				set @t_carno = @carno
				set @t_carowner = @carowner
				update @tmpa set mon = '' , datea = '' where current of cursor_table
			end
		end
		else
		begin
			set @t_carno = @carno 
			set @t_carowner = @carowner
			set @t_mon = @mon
			set @t_datea = @datea
		end
	fetch next from cursor_table
	into @mon,@datea,@carno,@carowner
	end
	close cursor_table
	deallocate cursor_table

select gno,mon,datea,carno,carowner,cardealno,cardeal,caritemno,caritem,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,outmoney),1)),4,12)) outmoney,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,inmoney),1)),4,12)) inmoney,
memo,@t_order t_order
from @tmpa;
--******************************************************************************************
z_car37:--z_car37
SET QUOTED_IDENTIFIER OFF
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @t_xmon nvarchar(10)
	declare @t_sssno nvarchar(20)
	declare @t_year nvarchar(20)
	declare @t_tax nvarchar(20)
	declare @sheetyn nvarchar(20)
	
	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
	set @t_xmon  = case when '#non'=[18] then '' else [18] end
	set @t_sssno  = case when '#non'=[24] then char(255) else [24] end
	set @t_year = case when '#non' = [35] then '' else [35] end
	set @t_tax = case when '#non' = [36] then '' else [36] end
	set @sheetyn = case when '#non' = [37] then '' else [37] end
--*********************************************************************************** 
	declare @tmp table( 
		recno int IDENTITY (1, 1),
		gno nvarchar(1), 		
		carno nvarchar(20),--車牌號碼 
		cardealno nvarchar(20),--車行
		cardealnick nvarchar(20),--車行
		mon nvarchar(10),
		memo nvarchar(MAX),
		outmoney float,
		paydate nvarchar(20),
		fareyn nvarchar(20),
		sheetyn nvarchar(20),
		xcount nvarchar(20)
	) 
	
	declare @cmd nvarchar(MAX)
	
	set @cmd="
	select '0'gno,a.carno,b.cardealno,c.nick,a.mon,a.memo,a.outmoney,a.paydate,a.fareyn,a.sheetyn,0
	from caras a left join car2 b on a.carno=b.noa left join cardeal c on b.cardealno=c.noa
	where (b.cardealno between '"+@t_bcardealno+"' and '"+@t_ecardealno+"')
	and left(a.mon,3)='"+@t_year+"' and  (a.fareyn='' or a.fareyn is null ) "
	
	if(PATINDEX('%已收單%',@sheetyn)>0)
	set @cmd=@cmd+" and (a.sheetyn='Y' or a.sheetyn='y')"
	
	if(PATINDEX('%未收單%',@sheetyn)>0)
	set @cmd=@cmd+" and (a.sheetyn='N' or a.sheetyn='n' or a.sheetyn='' or a.sheetyn is null)"
	
	declare @ssscount int
	set @ssscount=0
	
	while(PATINDEX('%,%',@t_sssno)>0)
	begin
		if (@ssscount=0)
			set @cmd=@cmd+" and (b.sssno='"+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+"'"
		else
			set @cmd=@cmd+" or b.sssno='"+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+"'"
			
		set @t_sssno=RIGHT(@t_sssno,LEN(@t_sssno)-PATINDEX('%,%',@t_sssno))
		set @ssscount=@ssscount+1
	end
	
	if (@ssscount=0)
		set @cmd=@cmd+" and (b.sssno='"+@t_sssno+"'"
	else
		set @cmd=@cmd+" or b.sssno='"+@t_sssno+"'"
	
	set @cmd=@cmd+")"
	
	declare @year nvarchar(MAX)
	
	if(@t_tax='春季燃料費')
	begin
		set @cmd=@cmd+" and(a.caritemno='502' and a.memo like '%春%')"
		set @year=@t_year+'春季燃料費'
	end
	if(@t_tax='上期牌照稅')
	begin
		set @cmd=@cmd+" and(a.caritemno='501' and a.memo like '%上%')"
		set @year=@t_year+'上期牌照稅'
	end
	if(@t_tax='夏季燃料費')
	begin
		set @cmd=@cmd+" and(a.caritemno='502' and a.memo like '%夏%')"
		set @year=@t_year+'夏季燃料費'
	end
	if(@t_tax='秋季燃料費')
	begin
		set @cmd=@cmd+" and(a.caritemno='502' and a.memo like '%秋%')"
		set @year=@t_year+'秋季燃料費'
	end
	if(@t_tax='下期牌照稅')
	begin
		set @cmd=@cmd+" and(a.caritemno='501' and a.memo like '%下%')"
		set @year=@t_year+'下期牌照稅'
	end
	if(@t_tax='冬季燃料費')
	begin
		set @cmd=@cmd+" and(a.caritemno='502' and a.memo like '%冬%')"
		set @year=@t_year+'冬季燃料費'
	end
	
	if(@t_tax='全部')
	begin
		set @cmd=@cmd+" and(a.caritemno='502' or a.caritemno='501')"
		set @year=@t_year+'牌照稅與燃料費'
	end
	
	--排序
	set @cmd=@cmd+" order by b.cardealno,a.carno"
	
	insert into @tmp 
	execute sp_executesql @cmd
	
	insert into @tmp
	select '1','',cardealno,cardealnick,'','',sum(outmoney),'','','',SUM(case when outmoney!=0 then 1 else 0 end) from @tmp
	group by cardealno,cardealnick
	
	insert into @tmp
	select '2','',(select top 1 cardealno from @tmp order by cardealno desc),(select top 1 cardealnick from @tmp order by cardealno desc),'','',sum(outmoney),'','','',COUNT(*) from @tmp
	where outmoney!=0 and gno='0'
	
	insert into @tmp
	select '3','',cardealno,cardealnick,'','','','','','',null from @tmp
	group by cardealno,cardealnick
	
	select recno,gno,carno,cardealno,cardealnick,mon,memo,paydate,fareyn,sheetyn,@year year,xcount,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,outmoney),1)),4,12)) outmoney
	from @tmp order by cardealno,gno,carno;
--***********************************************************************************************************
z_car38:--z_car38
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_enddate nvarchar(10)
	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_enddate = case when '#non'=[15] then '' else [15] end
	
	declare @tmp table( 
		gno nvarchar(1), 		
		compno nvarchar(50),
		comp nvarchar(50),
		typea nvarchar(10),
		datea nvarchar(10),
		indate nvarchar(10),
		gqbno nvarchar(30),
		account nvarchar(30),
		bank nvarchar(30),
		money float,
		memo nvarchar(MAX) 
	)
	
	insert into @tmp
	select '0'gno,compno,comp,case when typea=1 then '收票' when typea=2 then '開票' when typea=3 then '收退' else '開退' end typea,
	datea,indate,gqbno,account,bank,money,(case when gqbno in (select checkno from borrs where checkno!='') then '借支 '+ memo else memo end)
	from gqb
	where left(compno,1)='H' and (len(enda)=0 or enda is null or enda ='N' or enda='n') and len(indate)=9
	and (left(right('0'+CONVERT (nvarchar(7),CONVERT (VARCHAR(7),dateadd(d,-5,CONVERT(datetime ,CONVERT(nvarchar(10),CONVERT(int,left(@t_enddate,3))+1911)+right(left(@t_enddate,6),2)+right(left(@t_enddate,9),2)) ),12 )+0890000),7),3)+'/'
	+right(left(right('0'+CONVERT (nvarchar(7),CONVERT (VARCHAR(7),dateadd(d,-5,CONVERT(datetime ,CONVERT(nvarchar(10),CONVERT(int,left(@t_enddate,3))+1911)+right(left(@t_enddate,6),2)+right(left(@t_enddate,9),2)) ),12 )+0890000),7),5),2)+'/'
	+right(right('0'+CONVERT (nvarchar(7),CONVERT (VARCHAR(7),dateadd(d,-5,CONVERT(datetime ,CONVERT(nvarchar(10),CONVERT(int,left(@t_enddate,3))+1911)+right(left(@t_enddate,6),2)+right(left(@t_enddate,9),2)) ),12 )+0890000),7),2))<=indate
	and (compno between @t_bcarownerno and @t_ecarownerno)
	order by compno
	
	insert into @tmp 
	select '1',compno,b.namea,'','','','','','',sum(money),'' from @tmp a left join carOwner b on a.compno=b.noa
	group by compno,b.namea
	
	insert into @tmp
	select '2','ZZZZ','','','','','','','',sum(money),'' from @tmp where gno='0'

	select gno,compno,comp,typea,datea,indate,gqbno,account,bank,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money),1)),4,12)) money,	memo
	from @tmp order by compno,gno;
--***********************************************************************************************
z_car39:--z_car39
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @xyear nvarchar(10)
	
	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
	set @xyear = case when '#non' = [35] then '' else [35] end
--**********************************************************************************************

declare @tmp table( 
		gno nvarchar(1), 		
		carno nvarchar(50),
		year nvarchar(10),
		namea nvarchar(50),
		id nvarchar(10),
		addr nvarchar(MAX),
		jan float,
		feb float,
		mar float,
		apr float,
		may float,
		jun float,
		jul float,
		aug float,
		sep float,
		oct float,
		nov float,
		dec float,
		total float,
		memo nvarchar(MAX),
		cardealno nvarchar(20),
		comp nvarchar(MAX)
	)
	insert into @tmp
	select '0',a.noa,a.year,a.namea,a.id,a.addr,a.jan,a.feb,a.mar,a.apr,a.may,a.jun,a.jul,a.aug,a.sep,a.oct,a.nov,a.dec,
	(a.jan+a.feb+a.mar+a.apr+a.may+a.jun+a.jul+a.aug+a.sep+a.oct+a.nov+a.dec)total,a.memo,b.cardealno,c.comp
	from carsalary a left join car2 b on a.noa=b.noa
	left join cardeal c on b.cardealno=c.noa
	where (b.cardealno between @t_bcardealno and @t_ecardealno) and a.year=@xyear
	
	insert into @tmp (gno,cardealno,total)
	select '1',cardealno,sum(total)
	from @tmp group by cardealno
	
	select gno,carno,year,namea,id,addr,memo,comp
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,jan),1)),4,12)) jan
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,feb),1)),4,12)) feb
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,mar),1)),4,12)) mar
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,apr),1)),4,12)) apr
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,may),1)),4,12)) may
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,jun),1)),4,12)) jun
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,jul),1)),4,12)) jul
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,aug),1)),4,12)) aug
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,sep),1)),4,12)) sep
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,oct),1)),4,12)) oct
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,nov),1)),4,12)) nov
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,dec),1)),4,12)) dec
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total
	from @tmp order by cardealno,gno,carno;

--------------------------------------------------------------------------------------------------------------
z_car2_20:--z_car2_20
declare @t_bmon nvarchar(20)
declare @t_emon nvarchar(20)
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
declare @t_bcardealno nvarchar(20)
declare @t_ecardealno nvarchar(20)
declare @t_bcarownerno nvarchar(20)
declare @t_ecarownerno nvarchar(20)
declare @t_bcarno nvarchar(20)
declare @t_ecarno nvarchar(20)
declare @t_order nvarchar(20)
declare @t_sssno nvarchar(50)

set @t_bmon = case when '#non' = [1] then '' else [1] end
set @t_emon = case when '#non' = [2] then CHAR(255) else [2] end
set @t_bdate = case when '#non' = [3] then '' else [3] end
set @t_edate = case when '#non' = [4] then CHAR(255) else [4] end
set @t_bcardealno = case when '#non'=[5] then '' else [5] end
set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end
set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end
set @t_bcarno = case when '#non' = [16] then '' else [16] end
set @t_ecarno = case when '#non' = [17] then CHAR(255) else [17] end
set @t_order = case when '#non' = [34] then '車牌' else [34] end
set @t_sssno  = case when '#non'=[24] then '' else [24] end	
--**********************************************************************************************
SET QUOTED_IDENTIFIER OFF 

declare @cmd nvarchar(max) 
IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
	set @cmd = 'drop table #tmp'
	EXECUTE sp_executesql @cmd
END

--目前日期
declare @now_mon nvarchar(10)
set @now_mon=CONVERT (VARCHAR(7), GETDATE(),12 )+0890000
set @now_mon=left(@now_mon,3)+'/'+substring(@now_mon,4,2)

--避免月份日期空白
declare @t_btmon nvarchar(50) =case when @t_bmon='' then left(@t_bdate,6) else @t_bmon end
set @t_btmon=case when @t_btmon='' then '100/01/01' else @t_btmon end
declare @t_etmon nvarchar(50) =case when @t_emon='' then left(@t_edate,6) else @t_emon end
set @t_etmon=case when @t_etmon='' then @now_mon else @t_etmon end

--資料
create table #tmp(
	gno nvarchar(20),
	recno int,
	mon nvarchar(20),
	specno nvarchar(20),
	carno nvarchar(20),
	carownerno nvarchar(50),
	carowner nvarchar(100),
	cardealno nvarchar(50),
	cardeal nvarchar(100),
	memo nvarchar(MAX),
	manage float,
	cara float,
	carb float,
	outdate nvarchar(50),
	enddate nvarchar(50),
	wastedate nvarchar(50),
	suspdate nvarchar(50)
)

while (@t_btmon<=@t_etmon)
begin
	insert #tmp
	select '0',0,@t_btmon,a.carspecno,a.noa,a.carownerno,b.namea,a.cardealno,c.nick
	,case when isnull(a.manage,0)=0 then (case when charindex('管理費說明:',a.memo)=0 then '管理費未說明' else  SUBSTRING(a.memo,charindex('管理費說明:',a.memo)+6,len(a.memo)) end) else '' end 
	,a.manage,0,0,a.outdate,a.enddate,a.wastedate,a.suspdate
	from car2 a left join carOwner b on a.carownerno=b.noa
	left join cardeal c on a.cardealno=c.noa
	where a.cardealno between @t_bcardealno and @t_ecardealno
	and a.carownerno between @t_bcarownerno and @t_ecarownerno
	and a.noa between @t_bcarno and @t_ecarno
	and len(@t_sssno)=0 or CHARINDEX(a.sssno,@t_sssno)>0	
	and( (isnull(outdate,'')='' and isnull(enddate,'')='' and isnull(wastedate,'')='' and isnull(suspdate,'')='')
	or (isnull(left(outdate,6),'')>=@t_btmon) or (isnull(left(enddate,6),'')>=@t_btmon) 
	or (isnull(left(wastedate,6),'')>=@t_btmon) or (isnull(left(suspdate,6),'')>=@t_btmon))
	and left(a.carspecno,1) in('A','B','C') and isnull(left(a.indate,6),'') <= @t_btmon
	
	--刪除該月車主有車頭的板台
	delete a from #tmp a
	where mon=@t_btmon and left(a.specno,1)='B'
	and exists (select b.carownerno from #tmp b
	where left(b.specno,1) in('A','C') and b.mon=@t_btmon 
	and a.carownerno=b.carownerno group by b.carownerno )

	set @t_btmon=cast(cast(left(@t_btmon,3) as int)+1911 as nvarchar(10))+'/'+right(@t_btmon,2)+'/01'
	set @t_btmon=convert(varchar(10),dateadd(month,1,@t_btmon),120)
	set @t_btmon=cast(cast(left(@t_btmon,4) as int)-1911 as nvarchar(10))+'/'+left(right(@t_btmon,5),2)
end

declare @tt_order nvarchar(20)=case when @t_order='車主' then 'carowner' when @t_order='車行' then 'cardealno' else 'carno' end

EXEC("
update a
set recno=b.recno
from #tmp a left join 
(select ROW_NUMBER() over (order by mon,"+@tt_order+") recno,carno,mon from #tmp) b 
on a.carno=b.carno and a.mon=b.mon
")

insert #tmp (gno,mon,manage,cara,carb)
select '1',mon,SUM(manage),
(select COUNT(*) from #tmp where mon=a.mon and left(specno,1) in('A','C') and gno='0'),
(select COUNT(*) from #tmp where mon=a.mon and left(specno,1)='B' and gno='0')
from #tmp a where gno='0' group by mon

insert #tmp (gno,mon,manage,cara,carb)
select '2',CHAR(255),SUM(manage),
(select COUNT(*) from #tmp where left(specno,1) in('A','C') and gno='0'),
(select COUNT(*) from #tmp where left(specno,1)='B' and gno='0')
from #tmp a where gno='0'

select reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,manage),1)),4,30)) manage
,* from #tmp order by mon,gno
,case when @t_order='車主' then carowner when @t_order='車行' then cardealno else carno end

IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
	set @cmd = 'drop table #tmp'
	EXECUTE sp_executesql @cmd
END
;