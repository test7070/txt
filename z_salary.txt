z_salary1:--z_salary1
declare @t_xmon nvarchar(20)
declare @t_xkind nvarchar(20)
set @t_xmon = case when '#non' = [1] then '' else [1] end
set @t_xkind = case when '#non' = [3] then '' else [3] end
declare @tmp table(
		gno nvarchar(1),
		partno nvarchar(20),
		part nvarchar(30),
		indate nvarchar(10),
		sno nvarchar(20),
		namea nvarchar(50),
		sal float,
		pub float,
		boad float,
		botr float,
		bosp float,
		boot float,
		total1 float,
		chla1 float,
		chla2 float,
		chhei float,
		day float,
		mtotal float,
		bofu float,
		taxot float,
		total2 float,
		addh1 float,
		addh2 float,
		addm float,
		taxno float,
		total3 float,
		borrow float,
		labor float,
		laco float,
		lase float,
		lopofee float,
		taxs float,
		tax5 float,
		wel float,
		heal float,
		total4 float,
		total5 float
)
insert into @tmp
select '0' gno,b.partno,b.part,c.indate,b.sno,b.namea,b.daymoney,b.pubmoney,b.bo_admin,b.bo_traffic,b.bo_special,b.bo_oth,b.total1,
b.ch_labor1,b.ch_labor2,b.ch_health_insure,b.day,b.mtotal,b.bo_full,b.tax_other,b.total2,b.addh2_1,b.addh2_2,
b.addmoney,b.tax_other2,b.total3,b.borrow,b.ch_labor,b.ch_labor_comp,b.ch_labor_self,b.lodging_power_fee,b.tax,b.tax5,
b.welfare,b.ch_health,b.total4,b.total5
from salary a
left join salarys b on a.noa = b.noa
left join sss c on c.noa = b.sno
where a.person = '日薪' and @t_xmon = a.mon and @t_xkind = a.monkind

insert into @tmp
select '1' gno,partno,part,'','','',sum(sal),sum(pub),sum(boad),sum(botr),sum(bosp),sum(boot),sum(total1),
sum(chla1),sum(chla2),SUM(chhei),sum(day),sum(mtotal),sum(bofu),sum(taxot),sum(total2),sum(addh1),sum(addh2),
sum(addm),sum(taxno),sum(total3),sum(borrow),sum(labor),sum(laco),sum(lase),sum(lopofee),sum(taxs),sum(tax5),
sum(wel),sum(heal),sum(total4),sum(total5)
from @tmp
group by partno,part

select gno,partno,part,indate,sno,namea,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,sal),1)),4,12)) sal,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,pub),1)),4,12)) pub,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,boad),1)),4,12)) boad,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,botr),1)),4,12)) botr,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bosp),1)),4,12)) bosp,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,boot),1)),4,12)) boot,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total1),1)),4,12)) total1,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,chla1),1)),4,12)) chla1,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,chla2),1)),4,12)) chla2,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,chhei),1)),4,12)) chhei,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,day),1)),4,12)) day,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,mtotal),1)),4,12)) mtotal,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bofu),1)),4,12)) bofu,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,taxot),1)),4,12)) taxot,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total2),1)),4,12)) total2,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,addh1),1)),2,12)) addh1,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,addh2),1)),2,12)) addh2,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,addm),1)),4,12)) addm,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,taxno),1)),4,12)) taxno,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total3),1)),4,12)) total3,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,borrow),1)),4,12)) borrow,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,labor),1)),4,12)) labor,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,laco),1)),4,12))laco,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,lase),1)),4,12))lase,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,lopofee),1)),4,12)) lopofee,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,taxs),1)),4,12)) taxs,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax5),1)),4,12)) tax5,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,wel),1)),4,12)) wel,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,heal),1)),4,12)) heal,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total4),1)),4,12)) total4,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total5),1)),4,12)) total5,
(select worker from salary where person = '日薪' and @t_xmon = mon and @t_xkind = monkind) worker
from @tmp order by partno,gno;
------------------------------------------------------------------------------------------------------------------------------
z_salary2:--z_salary2
declare @t_xmon nvarchar(20)
declare @t_xkind nvarchar(20)
set @t_xmon = case when '#non' = [1] then '' else [1] end
set @t_xkind = case when '#non' = [3] then '' else [3] end
declare @tmp table(
		gno nvarchar(1),
		partno nvarchar(20),
		part nvarchar(30),
		indate nvarchar(10),
		sno nvarchar(20),
		namea nvarchar(50),
		sal float,
		pub float,
		boad float,
		botr float,
		bosp float,
		boot float,
		total1 float,
		chla1 float,
		chla2 float,
		chhei float,
		miday float,
		mitotal float,
		bofu float,
		taxot float,
		total2 float,
		addh1 float,
		addh2 float,
		addm float,
		taxno float,
		total3 float,
		borrow float,
		labor float,
		laco float,
		lase float,
		lopofee float,
		taxs float,
		tax5 float,
		wel float,
		heal float,
		total4 float,
		total5 float,
		jobno nvarchar(20),
		job nvarchar(50),
		plus float,
		minus float
)
insert into @tmp
select '0' gno,b.partno,b.part,c.indate,b.sno,b.namea,b.money,b.pubmoney,b.bo_admin,b.bo_traffic,b.bo_special,b.bo_oth,b.total1,
b.ch_labor1,b.ch_labor2,b.ch_health_insure,b.mi_saliday,b.mi_total,b.bo_full,b.tax_other,b.total2,b.addh2_1,b.addh2_2,
b.addmoney,b.tax_other2,b.total3,b.borrow,b.ch_labor,b.ch_labor_comp,b.ch_labor_self,b.lodging_power_fee,b.tax,b.tax5,
b.welfare,b.ch_health,b.total4,b.total5,b.jobno,b.job,b.plus,b.minus
from salary a
left join salarys b on a.noa = b.noa
left join sss c on c.noa = b.sno
where a.person = '本國' and @t_xmon = a.mon and @t_xkind = a.monkind

insert into @tmp
select '1' gno,partno,part,'','','',sum(sal),sum(pub),sum(boad),sum(botr),sum(bosp),sum(boot),sum(total1),
sum(chla1),sum(chla2),SUM(chhei),sum(miday),sum(mitotal),sum(bofu),sum(taxot),sum(total2),sum(addh1),sum(addh2),
sum(addm),sum(taxno),sum(total3),sum(borrow),sum(labor),sum(laco),sum(lase),sum(lopofee),sum(taxs),sum(tax5),
sum(wel),sum(heal),sum(total4),sum(total5),'','',sum(plus),sum(minus)
from @tmp
group by partno,part

insert into @tmp
select '2' gno,'999','','','','',sum(sal),sum(pub),sum(boad),sum(botr),sum(bosp),sum(boot),sum(total1),
sum(chla1),sum(chla2),SUM(chhei),sum(miday),sum(mitotal),sum(bofu),sum(taxot),sum(total2),sum(addh1),sum(addh2),
sum(addm),sum(taxno),sum(total3),sum(borrow),sum(labor),sum(laco),sum(lase),sum(lopofee),sum(taxs),sum(tax5),
sum(wel),sum(heal),sum(total4),sum(total5),'','',sum(plus),sum(minus)
from @tmp
where gno='0'

select gno,partno,part,indate,sno,namea,job,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,sal),1)),4,12)) sal,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,pub),1)),4,12)) pub,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,boad),1)),4,12)) boad,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,botr),1)),4,12)) botr,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bosp),1)),4,12)) bosp,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,boot),1)),4,12)) boot,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total1),1)),4,12)) total1,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,chla1),1)),4,12)) chla1,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,chla2),1)),4,12)) chla2,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,chhei),1)),4,12)) chhei,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,miday),1)),4,12)) miday,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,mitotal),1)),4,12)) mitotal,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bofu),1)),4,12)) bofu,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,taxot),1)),4,12)) taxot,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total2),1)),4,12)) total2,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,addh1),1)),2,12)) addh1,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,addh2),1)),2,12)) addh2,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,addm),1)),4,12)) addm,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,taxno),1)),4,12)) taxno,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total3),1)),4,12)) total3,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,borrow),1)),4,12)) borrow,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,labor),1)),4,12)) labor,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,laco),1)),4,12))laco,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,lase),1)),4,12))lase,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,lopofee),1)),4,12)) lopofee,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,taxs),1)),4,12)) taxs,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax5),1)),4,12)) tax5,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,wel),1)),4,12)) wel,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,heal),1)),4,12)) heal,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total4),1)),4,12)) total4,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total5),1)),4,12)) total5,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,plus),1)),4,12)) plus,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,minus),1)),4,12)) minus,
(select worker from salary where person = '本國' and @t_xmon = mon and @t_xkind = monkind) worker
from @tmp order by partno,gno,jobno;
---------------------------------------------------------------------------------------------------
z_salary3:--z_salary3
declare @t_xmon nvarchar(20)
set @t_xmon = case when '#non' = [1] then '' else [1] end
declare @tmp table(
		gno nvarchar(1),
		partno nvarchar(20),
		part nvarchar(30),
		indate nvarchar(10),
		sno nvarchar(20),
		namea nvarchar(50),
		sal float,
		pub float,
		boad float,
		botr float,
		bosp float,
		boot float,
		total1 float,
		chla1 float,
		chla2 float,
		chhei float,
		miday float,
		mitotal float,
		bobo float,
		boni float,
		bofu float,
		bodu float,
		taxot float,
		total2 float,
		addh1 float,
		addh2 float,
		addm float,
		addh461 float,
		addh462 float,
		add46m float,
		addh00 float,
		add0m float,
		taxno float,
		total3 float,
		borrow float,
		labor float,
		chg float,
		tax6 float,
		tax10 float,
		tax12 float,
		tax18 float,
		wel float,
		staym float,
		heal float,
		total4 float,
		total5 float
)
insert into @tmp
select '0' gno,b.partno,b.part,c.indate,b.sno,b.namea,b.money,b.pubmoney,b.bo_admin,b.bo_traffic,b.bo_special,b.bo_oth,b.total1,
b.ch_labor1,b.ch_labor2,b.ch_health_insure,b.mi_saliday,b.mi_total,b.bo_born,b.bo_night,b.bo_full,b.bo_duty,b.tax_other,b.total2,
b.addh2_1,b.addh2_2,b.addmoney,b.addh46_1,b.addh46_2,ROUND((b.ostand*addh46_1*1.33 + b.ostand*addh46_2*1.66),0),b.addh100,ROUND((b.addh100*b.ostand),0),b.tax_other2,b.total3,
b.borrow,b.ch_labor,b.chgcash,b.tax6,b.stay_tax,b.tax12,b.tax18,b.welfare,b.stay_money,b.ch_health,b.total4,b.total5
from salary a
left join salarys b on a.noa = b.noa
left join sss c on c.noa = b.sno
where a.person = '外勞' and @t_xmon = a.mon 

insert into @tmp
select '1',partno,part,'','','',sum(sal),sum(pub),sum(boad),sum(botr),sum(bosp),sum(boot),sum(total1),
sum(chla1),sum(chla2),sum(chhei),sum(miday),sum(mitotal),sum(bobo),sum(boni),sum(bofu),sum(bodu),sum(taxot),sum(total2),sum(addh1),sum(addh2),sum(addm),sum(addh461),sum(addh462),sum(add46m),sum(addh00),sum(add0m),sum(taxno),sum(total3),
sum(borrow),sum(labor),sum(chg),sum(tax6),sum(tax10),sum(tax12),sum(tax18),sum(wel),sum(staym),sum(heal),sum(total4),sum(total5) 
from @tmp
group by partno,part


select gno,partno,part,indate,sno,namea,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,sal),1)),4,12)) sal,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,pub),1)),4,12)) pub,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,boad),1)),4,12)) boad,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,botr),1)),4,12)) botr,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bosp),1)),4,12)) bosp,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,boot),1)),4,12)) boot,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total1),1)),4,12)) total1,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,chla1),1)),4,12)) chla1,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,chla2),1)),4,12)) chla2,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,chhei),1)),4,12)) chhei,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,miday),1)),4,12)) miday,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,mitotal),1)),4,12)) mitotal,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bobo),1)),4,12)) bobo,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,boni),1)),4,12)) boni,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bofu),1)),4,12)) bofu,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bodu),1)),4,12)) bodu,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,taxot),1)),4,12)) taxot,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total2),1)),4,12)) total2,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,addh1),1)),2,12)) addh1,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,addh2),1)),2,12)) addh2,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,addm),1)),4,12)) addm,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,addh461),1)),4,12)) addh461,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,addh462),1)),4,12)) addh462,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,addm),1)),4,12)) add46m,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,addh2),1)),4,12)) addh00,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,addm),1)),4,12)) add0m,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,taxno),1)),4,12)) taxno,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total3),1)),4,12)) total3,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,borrow),1)),4,12)) borrow,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,labor),1)),4,12)) labor,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,chg),1)),4,12)) chg,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax6),1)),4,12)) tax6,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax10),1)),4,12)) tax10,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax12),1)),4,12)) tax12,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax18),1)),4,12)) tax18,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,wel),1)),4,12)) wel,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,staym),1)),4,12)) staym,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,heal),1)),4,12)) heal,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total4),1)),4,12)) total4,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total5),1)),4,12)) total5,
(select worker from salary where person = '外勞' and @t_xmon = mon) worker
from @tmp order by partno,gno;

-----------------------------------------------------------------------------------------------
z_salary4:--z_salary4
declare @t_xmon nvarchar(20)
declare @t_xkind nvarchar(20)
declare @t_xperson nvarchar(20)
set @t_xmon = case when '#non' = [1] then '' else [1] end
set @t_xperson = case when '#non' = [2] then '' else [2] end
set @t_xkind = case when '#non' = [3] then '' else [3] end
declare @tmp table(
		gno  nvarchar(1),
		sno nvarchar(20),
		namea nvarchar(50),
		partno nvarchar(20),
		part nvarchar(20),
		jobno nvarchar(20),
		job nvarchar(20),
		addh00 float,
		add0m float,
		addh461 float,
		add461m float,
		addh462 float,
		add462m float,
		total float		
)
insert into @tmp
select '0' gno,b.sno,b.namea,b.partno,b.part,b.jobno,b.job,b.addh100,round(b.addh100*b.ostand,0),
b.addh46_1,ROUND((b.addh46_1*b.ostand*1.33),0),b.addh46_2,ROUND((b.addh46_2*b.ostand*1.66),0),
round(b.addh100*b.ostand,0)+ROUND((b.addh46_1*b.ostand*1.33),0)+ROUND((b.addh46_2*b.ostand*1.66),0)
from salary a
left join salarys b on a.noa = b.noa
left join sss c on b.sno = c.noa
where @t_xmon = a.mon and @t_xkind = a.monkind and @t_xperson = a.person

insert into @tmp
select '1' gno,'','',partno,part,'9999','',SUM(addh00),SUM(add0m),SUM(addh461),SUM(add461m),SUM(addh462),SUM(add462m),SUM(total)
from @tmp
group by partno,part

insert into @tmp
select '2' gno,'','','999999','','','',SUM(addh00),SUM(add0m),SUM(addh461),SUM(add461m),SUM(addh462),SUM(add462m),SUM(total)
from @tmp
where gno='1'

select gno,sno,namea,partno,part,job,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,addh00),1)),4,12)) addh00,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,add0m),1)),4,12)) add0m,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,addh461),1)),4,12))addh461,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,add461m),1)),4,12)) add461m,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,addh462),1)),4,12)) addh462,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,add462m),1)),4,12)) add462m,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total,
(select worker from salary where @t_xmon = mon and @t_xkind = monkind and @t_xperson = person) worker
from @tmp order by partno,jobno,gno;
------------------------------------------------------------------------------------------------
z_salary5:--z_salary5
declare @t_xmon nvarchar(20)
declare @t_xkind nvarchar(20)
declare @t_bsssno nvarchar(20)
declare @t_esssno nvarchar(20)
set @t_xmon = case when '#non' = [1] then '' else [1] end
set @t_xkind = case when '#non' = [3] then '' else [3] end
set @t_bsssno = case when '#non' = [4] then '' else [4] end
set @t_esssno = case when '#non' = [5] then CHAR(255) else [5] end
declare @tmp table(
		gno nvarchar(1),
		sno nvarchar(20),
		namea nvarchar(50),
		indate nvarchar(10),
		ft_date nvarchar(10),
		daymoney int,
		pubmoney int,
		bo_admins int,
		bo_traffic int,
		bo_special int,
		bo_oth int,
		total1 int,
		ch_labor1 int,
		ch_labor2 int,
		ich_health int,
		daya int,
		mtotal int,
		bo_full int,
		tax_other int,
		total2 int,
		addh2_1 float,
		addh2_2 float,
		addmoney int,
		tax_other2 int,
		total3 int,
		borrow int,
		ch_labor int,
		chla_comp int,
		chla_self int,
		hplus float,
		lopofee int,
		tax int,
		tax5 int, 
		welfare int,
		ch_health int,
		total4 int,
		total5 int
)
insert into @tmp
select '0' gno,b.sno,b.namea,c.indate,c.ft_date,b.daymoney,b.pubmoney,b.bo_admin,b.bo_traffic,b.bo_special,
b.bo_oth,b.total1,b.ch_labor1,b.ch_labor2,b.ch_health_insure,b.day,b.mtotal,b.bo_full,b.tax_other,b.total2,b.addh2_1,b.addh2_2,
b.addmoney,b.tax_other2,a.total3,b.borrow,b.ch_labor,b.ch_labor_comp,b.ch_labor_self,isnull(b.hplus2,0),b.lodging_power_fee,b.tax,b.tax5,
b.welfare,b.ch_health,b.total4,b.total5
from salary a
left join salarys b on a.noa = b.noa
left join sss c on b.sno = c.noa
where (LEN(@t_xmon) = 0 or @t_xmon = a.mon) and
(LEN(@t_xkind) = 0 or @t_xkind = a.monkind) and
(b.sno between @t_bsssno and @t_esssno) and
(a.person = '日薪')


select gno,sno,namea,indate,ft_date,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,daymoney),1)),4,12)) daymoney,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,pubmoney),1)),4,12)) pubmoney,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bo_admins),1)),4,12))bo_admins,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bo_traffic),1)),4,12)) bo_traffic,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bo_special),1)),4,12)) bo_special,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bo_oth),1)),4,12)) bo_oth,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total1),1)),4,12)) total1,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ch_labor1),1)),4,12)) ch_labor1,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ch_labor2),1)),4,12)) ch_labor2,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ich_health),1)),4,12)) ich_health,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,daya),1)),4,12)) daya,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,mtotal),1)),4,12)) mtotal,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bo_full),1)),4,12)) bo_full,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax_other),1)),4,12)) tax_other,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total2),1)),4,12)) total2,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,addh2_1),1)),4,12)) addh2_1,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,addh2_2),1)),4,12)) addh2_2,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,addmoney),1)),4,12)) addmoney,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax_other2),1)),4,12)) tax_other2,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total3),1)),4,12))total3,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,borrow),1)),4,12))borrow,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ch_labor),1)),4,12)) ch_labor,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,chla_comp),1)),4,12)) chla_comp,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,chla_self),1)),4,12)) chla_self,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,hplus),1)),4,12)) hplus,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,lopofee),1)),4,12)) lopofee,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax),1)),4,12))tax,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax5),1)),4,12)) tax5,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,welfare),1)),4,12)) welfare,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ch_health),1)),4,12)) ch_health,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total4),1)),4,12)) total4,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total5),1)),4,12)) total5,
(select worker from salary where @t_xmon = mon and @t_xkind = monkind and person = '日薪') worker
from @tmp;
----------------------------------------------------------------------------------------------
z_salary6:--z_salary6
declare @t_xmon nvarchar(20)
declare @t_xkind nvarchar(20)
declare @t_bsssno nvarchar(20)
declare @t_esssno nvarchar(20)
set @t_xmon = case when '#non' = [1] then '' else [1] end
set @t_xkind = case when '#non' = [3] then '' else [3] end
set @t_bsssno = case when '#non' = [4] then '' else [4] end
set @t_esssno = case when '#non' = [5] then CHAR(255) else [5] end
--**************************************************************
declare @tmp table( 
	gno nvarchar(1), 
	noa nvarchar(30), 
	noq nvarchar(20), 
	sno nvarchar(20), 
	namea nvarchar(50), 
	indate nvarchar(10), 
	ft_date nvarchar(10), 
	moneys int, 
	pubmoney int, 
	bo_admins int, 
	bo_traffic int, 
	bo_special int, 
	bo_oth int, 
	total1 int, 
	ch_labor1 int, 
	ch_labor2 int, 
	ich_health int, 
	mi_sailday int, 
	mi_total int, 
	bo_full int, 
	tax_other int, 
	total2 int, 
	addh2_1 float, 
	addh2_2 float, 
	addmoney int, 
	tax_other2 int, 
	total3 int, 
	borrow int, 
	ch_labor int, 
	chla_comp int, 
	chla_self int, 
	hplus float,
	lopofee int, 
	tax int, 
	tax5 int, 
	welfare int, 
	ch_health int, 
	total4 int, 
	total5 int, 
	monkind nvarchar(20), 
	mon nvarchar(10), 
	minus int, 
	plus int, 
	plusitem nvarchar(max), 
	minusitem nvarchar(max), 
	plusmemo nvarchar(max), 
	minusmemo nvarchar(max), 
	bomemo nvarchar(max) 
) 
insert into @tmp 
select '0' gno, a.noa,b.noq,b.sno,b.namea,c.indate,c.ft_date,b.money,b.pubmoney,b.bo_admin,b.bo_traffic,b.bo_special, 
b.bo_oth,b.total1,b.ch_labor1,b.ch_labor2,b.ch_health_insure,b.mi_saliday,b.mi_total,b.bo_full,b.tax_other,b.total2,b.addh2_1,b.addh2_2, 
b.addmoney,b.tax_other2,b.total3,b.borrow,b.ch_labor,b.ch_labor_comp,b.ch_labor_self,isnull(b.hplus2,0),b.lodging_power_fee,b.tax,b.tax5, 
b.welfare,b.ch_health,b.total4,b.total5,a.monkind,a.mon,isnull(b.minus,0),isnull(b.plus,0), 
(select plusitem from (select sssno,STUFF((select ','+T4.item from salchg T2 left join salchgitem T4 on T2.plusitem=T4.noa where T2.sssno=T1.sssno and mon=@t_xmon FOR XML PATH('')),1,1,'')plusitem from salchg T1 where mon=@t_xmon group by sssno) T3 where b.sno=sssno), 
(select minusitem from (select sssno,STUFF((select ','+T4.item from salchg T2 left join salchgitem T4 on T2.minusitem=T4.noa where T2.sssno=T1.sssno and mon=@t_xmon FOR XML PATH('')),1,1,'')minusitem from salchg T1 where mon=@t_xmon group by sssno) T3 where b.sno=sssno), 
(select plusmemo from (select sssno,STUFF((select ','+T2.memo from salchg T2 where plusitem!='' and minusitem='' and T2.sssno=T1.sssno and mon=@t_xmon FOR XML PATH('')),1,1,'')plusmemo from salchg T1 where mon=@t_xmon group by sssno) T3 where b.sno=sssno), 
(select minusmemo from (select sssno,STUFF((select ','+T2.memo from salchg T2 where plusitem='' and minusitem!='' and T2.sssno=T1.sssno and mon=@t_xmon FOR XML PATH('')),1,1,'')minusmemo from salchg T1 where mon=@t_xmon group by sssno) T3 where b.sno=sssno), 
(select top 1 memo from saladjust where noa=b.sno order by noq desc) 
from salary a 
left join salarys b on a.noa = b.noa 
left join sss c on b.sno = c.noa 
where (LEN(@t_xmon) = 0 or @t_xmon = a.mon) and 
(LEN(@t_xkind) = 0 or @t_xkind = a.monkind) and 
(b.sno between @t_bsssno and @t_esssno) and 
(a.person = '本國') 

select gno,noa,noq,sno,namea,indate,ft_date, (case when plusitem!='' then '('+plusitem+')' else '' end) plusitem, (case when minusitem!='' then '('+minusitem+')' else '' end) minusitem, (case when bomemo!='' then '('+bomemo+')' else '' end) bomemo, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,moneys),1)),4,12)) moneys, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,pubmoney),1)),4,12)) pubm, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bo_admins),1)),4,12))boad, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bo_traffic),1)),4,12)) botr, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bo_special),1)),4,12)) bosp, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bo_oth),1)),4,12)) boot, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total1),1)),4,12)) total1, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ch_labor1),1)),4,12)) chla, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ch_labor2),1)),4,12)) chlb, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ich_health),1)),4,12)) ichh, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,mi_sailday),1)),4,12)) misa, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,mi_total),1)),4,12)) mito, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bo_full),1)),4,12)) bofu, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax_other),1)),4,12)) taxo, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total2),1)),4,12)) total2, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,addh2_1),1)),2,12)) ad21, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,addh2_2),1)),2,12)) ad22, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,addmoney),1)),4,12)) addm, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax_other2),1)),4,12)) taxt, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total3),1)),4,12)) total3, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,borrow),1)),4,12)) bow, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ch_labor),1)),4,12)) chlo, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,chla_comp),1)),4,12)) chlc, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,chla_self),1)),4,12)) chls, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,hplus),1)),4,12)) hplus,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,lopofee),1)),4,12)) lopo, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax),1)),4,12))tax, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax5),1)),4,12)) tax5, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,welfare),1)),4,12)) welfare, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ch_health),1)),4,12)) chhe, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total4),1)),4,12)) total4, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total5),1)),4,12)) total5,mon,monkind, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,minus),1)),4,12)) minus, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,plus),1)),4,12)) plus, 
(select worker from salary where @t_xmon = mon and @t_xkind = monkind and person = '本國') worker 
,plusmemo,minusmemo
from @tmp;
---------------------------------------------------------------------------------------
z_salary7:--z_salary7
declare @t_xmon nvarchar(20)
declare @t_bsssno nvarchar(20)
declare @t_esssno nvarchar(20)
set @t_xmon = case when '#non' = [1] then '' else [1] end
set @t_bsssno = case when '#non' = [4] then '' else [4] end
set @t_esssno = case when '#non' = [5] then CHAR(255) else [5] end
declare @tmp table(
		gno nvarchar(1),
		noa nvarchar(30),
		noq nvarchar(20),
		sno nvarchar(20),
		namea nvarchar(50),
		indate nvarchar(10),
		moneys int,
		bo_admins int,
		bo_traffic int,
		bo_special int,
		bo_oth int,
		total1 int,
		ch_labor1 int,
		ich_health int,
		mi_sailday int,
		mi_total int,
		bo_born int,
		bo_night int,
		bo_full int,
		bo_duty int,
		tax_other int,
		total2 int,
		addh2_1 float,
		addh2_2 float,
		addmoney int,
		addh46_1 float,
		addh46_2 float,
		add46 int,
		addh100 float,
		addh1 int,
		tax_other2 int,
		total3 int,
		borrow int,
		ch_labor int,
		chgcash int,
		tax6 int,
		stay_tax int,
		tax12 int,
		tax18 int,
		welfare int,
		staymoney int,
		ch_health int,
		hplus float,
		total4 int,
		total5 int,
		ch_labor2 int,
		chla_comp int,
		chla_self int
)
insert into @tmp
select '0' gno, a.noa,b.noq,b.sno,b.namea,c.indate,b.money,b.bo_admin,b.bo_traffic,b.bo_special,
b.bo_oth,b.total1,b.ch_labor1,b.ch_health_insure,b.mi_saliday,b.mi_total,b.bo_born,b.bo_night,b.bo_full,b.bo_duty,
b.tax_other,b.total2,b.addh2_1,b.addh2_2,b.addmoney,b.addh46_1,b.addh46_2,ROUND((b.ostand*1.33*addh46_1 + b.ostand*1.66*addh46_2),0),
b.addh100,ROUND((b.ostand*b.addh100),0),
b.tax_other2,a.total3,b.borrow,b.ch_labor,b.chgcash,b.tax6,b.stay_tax,b.tax12,b.tax18,
b.welfare,b.stay_money,b.ch_health,isnull(b.hplus2,0),b.total4,b.total5,b.ch_labor2,b.ch_labor_comp,b.ch_labor_self
from salary a
left join salarys b on a.noa = b.noa
left join sss c on b.sno = c.noa
where (LEN(@t_xmon) = 0 or @t_xmon = a.mon) and
(b.sno between @t_bsssno and @t_esssno) and
(a.person = '外勞')

select gno,noa,noq,sno,namea,indate,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,moneys),1)),4,12)) moneys,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bo_admins),1)),4,12))bo_admins,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bo_traffic),1)),4,12)) bo_traffic,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bo_special),1)),4,12)) bo_special,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bo_oth),1)),4,12)) bo_oth,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total1),1)),4,12)) total1,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ch_labor1),1)),4,12)) ch_labor1,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ich_health),1)),4,12)) ich_health,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,mi_sailday),1)),4,12)) mi_sailday,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,mi_total),1)),4,12)) mi_total,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bo_born),1)),4,12)) bo_born,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bo_night),1)),4,12)) bo_night,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bo_full),1)),4,12)) bo_full,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bo_duty),1)),4,12)) bo_duty,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax_other),1)),4,12)) tax_other,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total2),1)),4,12)) total2,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,addh2_1),1)),4,12)) addh2_1,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,addh2_2),1)),4,12)) addh2_2,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,addmoney),1)),4,12)) addmoney,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,addh46_1),1)),4,12)) addh46_1,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,addh46_2),1)),4,12)) addh46_2,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,add46),1)),4,12)) add46,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,addh100),1)),4,12)) addh100,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,addh1),1)),4,12)) addh1,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax_other2),1)),4,12)) tax_other2,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total3),1)),4,12))total3,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,borrow),1)),4,12))borrow,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ch_labor),1)),4,12)) ch_labor,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,chgcash),1)),4,12)) chgcash,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax6),1)),4,12)) tax6,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,stay_tax),1)),4,12)) stay_tax,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax12),1)),4,12)) tax12,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax18),1)),4,12)) tax18,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,welfare),1)),4,12)) welfare,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,staymoney),1)),4,12)) staymoney,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ch_health),1)),4,12)) ch_health,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,hplus),1)),4,12)) hplus,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total4),1)),4,12)) total4,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total5),1)),4,12)) total5,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ch_labor2),1)),4,12)) ch_labor2,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,chla_comp),1)),4,12)) chla_comp,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,chla_self),1)),4,12)) chla_self,
(select worker from salary where @t_xmon = mon and person = '外勞') worker
from @tmp;
--------------------------------------------------------------------------------------------------
z_salary8:--z_salary8
declare @t_xmon nvarchar(20)
declare @t_xperson nvarchar(20)
declare @t_xkind nvarchar(20)
set @t_xmon = case when '#non' = [1] then '' else [1] end
set @t_xperson = case when '#non' = [2] then '' else [2] end
set @t_xkind = case when '#non' = [3] then '' else [3] end
--*****************************************************************
--刪除暫存資料庫
IF OBJECT_ID('tempdb..#tmpx')is not null
BEGIN
       drop table #tmpx
END

create table #tmpx(
		gno nvarchar(1),
		namea nvarchar(20),
		a float,
		b float,
		c float,
		d float,
		e float,
		f float,
		g float,
		h float,
		i float,
		j float,
		k float,
		l float,
		m float
)
--a,b,c,d,e,f,g,h,i,m->都是部門欄位
declare @list table(
	[namea] nvarchar(20),
	[list] nvarchar(20)
)
--插入要計算的欄位名稱
if  @t_xperson = '本國' 
begin
	
	insert into @list (namea,list) values('底薪','money') 
end
else
begin
	insert into @list (namea,list) values('日薪','daymoney')
end
insert into @list (namea,list) values('主管津貼','bo_admin')
insert into @list (namea,list) values('交通津貼','bo_traffic')
insert into @list (namea,list) values('工作津貼','bo_special')
insert into @list (namea,list) values('其他津貼','bo_oth')
insert into @list (namea,list) values('其他加項','plus')
insert into @list (namea,list) values('小計','total1')
--insert into @list (namea,list) values('勞保投保','ch_labor1')
--insert into @list (namea,list) values('勞退提繳','ch_labor2')
--insert into @list (namea,list) values('建保投保','ch_health_insure')
if @t_xperson = '本國'
begin
insert into @list (namea,list) values('扣薪時數','mi_saliday')
end
else
begin
insert into @list (namea,list) values('給薪日數','day')
end
if @t_xperson = '本國'
begin
insert into @list (namea,list) values('扣薪金額','mi_total')
end
else
begin
insert into @list (namea,list) values('給薪薪資','mtotal')
end

insert into @list (namea,list) values('*全勤獎金','bo_full')
insert into @list (namea,list) values('*應稅其他','tax_other')
insert into @list (namea,list) values('給付總額','total2')
insert into @list (namea,list) values('加班 H<2','addh2_1')
insert into @list (namea,list) values('加班 H>2','addh2_2')
insert into @list (namea,list) values('加班費','addmoney')
insert into @list (namea,list) values('免稅其他','tax_other2')
insert into @list (namea,list) values('應領總額','total3')
insert into @list (namea,list) values('借支','borrow')
insert into @list (namea,list) values('勞保費','ch_labor')
--insert into @list (namea,list) values('公司提繳','ch_labor_comp')
insert into @list (namea,list) values('個人提繳','ch_labor_self')
insert into @list (namea,list) values('健保費','ch_health')
insert into @list (namea,list) values('所得稅','tax')
insert into @list (namea,list) values('所得稅5%','tax5')
insert into @list (namea,list) values('福利金','welfare')
insert into @list (namea,list) values('其他扣款','minus')
insert into @list (namea,list) values('應扣總額','total4')
insert into @list (namea,list) values('實發金額','total5')

declare @lists nvarchar(20)
declare @namea nvarchar(20)
declare @cmd nvarchar(max)

declare cursor_table cursor for
select namea,list from  @list
open cursor_table
fetch next from cursor_table
into @namea,@lists
while(@@FETCH_STATUS <> -1)
begin
	set @cmd = 'insert into #tmpx (gno,namea,a,b,c,d,e,f,g,h,i,j,k,l,m) values(''0'','''+@namea+'''
	,(select SUM(b.'+@lists+') from salary a left join salarys b on a.noa = b.noa left join sss c on b.sno = c.noa where a.person='''+@t_xperson+''' and a.mon='''+@t_xmon+''' and a.monkind='''+@t_xkind+''' and b.partno=''01'' and b.job!=''特支'' and b.job!=''福利金'' and b.job!=''租金'')
	,(select SUM(b.'+@lists+') from salary a left join salarys b on a.noa = b.noa left join sss c on b.sno = c.noa where a.person='''+@t_xperson+''' and a.mon='''+@t_xmon+''' and a.monkind='''+@t_xkind+''' and b.partno=''02'' and b.job!=''特支'' and b.job!=''福利金'' and b.job!=''租金'')
	,(select SUM(b.'+@lists+') from salary a left join salarys b on a.noa = b.noa left join sss c on b.sno = c.noa where a.person='''+@t_xperson+''' and a.mon='''+@t_xmon+''' and a.monkind='''+@t_xkind+''' and b.partno=''03'' and b.job!=''特支'' and b.job!=''福利金'' and b.job!=''租金'') 
	,(select SUM(b.'+@lists+') from salary a left join salarys b on a.noa = b.noa left join sss c on b.sno = c.noa where a.person='''+@t_xperson+''' and a.mon='''+@t_xmon+''' and a.monkind='''+@t_xkind+''' and b.partno=''04'' and b.job!=''特支'' and b.job!=''福利金'' and b.job!=''租金'')
	,(select SUM(b.'+@lists+') from salary a left join salarys b on a.noa = b.noa left join sss c on b.sno = c.noa where a.person='''+@t_xperson+''' and a.mon='''+@t_xmon+''' and a.monkind='''+@t_xkind+''' and b.partno=''05'' and b.job!=''特支'' and b.job!=''福利金'' and b.job!=''租金'')
	,(select SUM(b.'+@lists+') from salary a left join salarys b on a.noa = b.noa left join sss c on b.sno = c.noa where a.person='''+@t_xperson+''' and a.mon='''+@t_xmon+''' and a.monkind='''+@t_xkind+''' and b.partno=''06'' and b.job!=''特支'' and b.job!=''福利金'' and b.job!=''租金'')
	,(select SUM(b.'+@lists+') from salary a left join salarys b on a.noa = b.noa left join sss c on b.sno = c.noa where a.person='''+@t_xperson+''' and a.mon='''+@t_xmon+''' and a.monkind='''+@t_xkind+''' and b.partno=''07'' and b.job!=''特支'' and b.job!=''福利金'' and b.job!=''租金'') 
	,(select SUM(b.'+@lists+') from salary a left join salarys b on a.noa = b.noa left join sss c on b.sno = c.noa where a.person='''+@t_xperson+''' and a.mon='''+@t_xmon+''' and a.monkind='''+@t_xkind+''' and b.partno=''08'' and b.job!=''特支'' and b.job!=''福利金'' and b.job!=''租金'')
	,(select SUM(b.'+@lists+') from salary a left join salarys b on a.noa = b.noa left join sss c on b.sno = c.noa where a.person='''+@t_xperson+''' and a.mon='''+@t_xmon+''' and a.monkind='''+@t_xkind+''' and b.partno=''09'' and b.job!=''特支'' and b.job!=''福利金'' and b.job!=''租金'')
	,(select SUM(b.'+@lists+') from salary a left join salarys b on a.noa = b.noa left join sss c on b.sno = c.noa where a.person='''+@t_xperson+''' and a.mon='''+@t_xmon+''' and a.monkind='''+@t_xkind+''' and b.job=''福利金'')
	,(select SUM(b.'+@lists+') from salary a left join salarys b on a.noa = b.noa left join sss c on b.sno = c.noa where a.person='''+@t_xperson+''' and a.mon='''+@t_xmon+''' and a.monkind='''+@t_xkind+''' and b.job=''租金'')
	,(select SUM(b.'+@lists+') from salary a left join salarys b on a.noa = b.noa left join sss c on b.sno = c.noa where a.person='''+@t_xperson+''' and a.mon='''+@t_xmon+''' and a.monkind='''+@t_xkind+''' and b.job=''特支'')
	,(select SUM(b.'+@lists+') from salary a left join salarys b on a.noa = b.noa left join sss c on b.sno = c.noa where a.person='''+@t_xperson+''' and a.mon='''+@t_xmon+''' and a.monkind='''+@t_xkind+''' and b.partno=''10'' and b.job!=''特支'' and b.job!=''福利金'' and b.job!=''租金'')
	)' 
	EXECUTE sp_executesql @cmd
fetch next from cursor_table
into @namea,@lists
end
close cursor_table
deallocate cursor_table

select gno,namea,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a),1)),4,12)) a,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,b),1)),4,12)) b,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,c),1)),4,12)) c,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,d),1)),4,12)) d,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,e),1)),4,12)) e,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,f),1)),4,12)) f,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,g),1)),4,12)) g,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,h),1)),4,12)) h,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,i),1)),4,12)) i,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,j),1)),4,12)) j,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,k),1)),4,12)) k,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,l),1)),4,12)) l,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,m),1)),4,12)) m,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a,0)+isnull(b,0)+isnull(c,0)+isnull(d,0)+isnull(e,0)+isnull(f,0)+isnull(g,0)+isnull(h,0)+isnull(i,0)+isnull(j,0)+isnull(k,0)+isnull(l,0)+isnull(m,0)),1)),4,12)) total,
(select worker from salary where @t_xmon = mon and @t_xkind = monkind and @t_xperson = person) worker 
from #tmpx

--刪除暫存資料庫
IF OBJECT_ID('tempdb..#tmpx')is not null
BEGIN
       drop table #tmpx
END;
----------------------------------------------------------------------------------------
z_salary9:--z_salary9
declare @t_xmon nvarchar(20)
set @t_xmon = case when '#non' = [1] then '' else [1] end
create table #tmp(
		gno nvarchar(1),
		namea nvarchar(20),
		a float,
		b float,
		c float,
		d float,
		e float,
		f float,
		g float,
		h float,
		i float
)
--a,b,c,d,e,f,g,h,i->都是部門欄位
declare @list table(
	[namea] nvarchar(20),
	[list] nvarchar(MAX)
)
--插入要計算的欄位名稱 
insert into @list (namea,list) values('底薪','SUM(b.money)') 
insert into @list (namea,list) values('主管津貼','SUM(b.bo_admin)') 
insert into @list (namea,list) values('交通津貼','SUM(b.bo_traffic)') 
insert into @list (namea,list) values('特別津貼','SUM(b.bo_special)') 
insert into @list (namea,list) values('其他津貼','SUM(b.bo_oth)') 
insert into @list (namea,list) values('小計','SUM(b.total1)') 
insert into @list (namea,list) values('勞保投保','SUM(b.ch_labor1)') 
insert into @list (namea,list) values('建保投保','SUM(b.ch_health_insure)') 
insert into @list (namea,list) values('扣薪日數','SUM(b.mi_saliday)') 
insert into @list (namea,list) values('扣薪金額','SUM(b.mi_total)') 
insert into @list (namea,list) values('*生產獎金','SUM(b.bo_born)') 
insert into @list (namea,list) values('*夜班獎金','SUM(b.bo_night)') 
insert into @list (namea,list) values('*全勤獎金','SUM(b.bo_full)') 
insert into @list (namea,list) values('*值班獎金','SUM(b.bo_duty)') 
insert into @list (namea,list) values('*應稅其他','SUM(b.tax_other)') 
insert into @list (namea,list) values('給付總額','SUM(b.total2)') 
insert into @list (namea,list) values('加班 H<2','SUM(b.addh2_1)') 
insert into @list (namea,list) values('加班 H>2','SUM(b.addh2_2)') 
insert into @list (namea,list) values('加班費(<46Hr)','SUM(b.addmoney)') 
insert into @list (namea,list) values('加班 H<2','SUM(b.addh46_1)') 
insert into @list (namea,list) values('加班 H<2','SUM(b.addh46_2)') 
insert into @list (namea,list) values('加班費(>46Hr)','SUM(ROUND((b.ostand*1.33*addh46_1 + b.ostand*1.66*addh46_2),0))')
insert into @list (namea,list) values('假日加班','SUM(b.addh100)') 
insert into @list (namea,list) values('假日加班費','SUM(ROUND((b.ostand*b.addh100),0))')
insert into @list (namea,list) values('免稅其他','SUM(b.tax_other2)') 
insert into @list (namea,list) values('應領總額','SUM(b.total3)') 
insert into @list (namea,list) values('借支','SUM(b.borrow)') 
insert into @list (namea,list) values('勞保費','SUM(b.ch_labor)') 
insert into @list (namea,list) values('代扣費用','SUM(b.chgcash)') 
insert into @list (namea,list) values('所得稅6%','SUM(b.tax6)') 
insert into @list (namea,list) values('暫留稅','SUM(b.stay_tax)') 
insert into @list (namea,list) values('所得稅12%','SUM(b.tax12)') 
insert into @list (namea,list) values('所得稅18%','SUM(b.tax18)') 
insert into @list (namea,list) values('福利金','SUM(b.welfare)') 
insert into @list (namea,list) values('暫留款','SUM(b.stay_money)') 
insert into @list (namea,list) values('健保費','SUM(b.ch_health)') 
insert into @list (namea,list) values('應扣總額','SUM(b.total4)') 
insert into @list (namea,list) values('實發金額','SUM(b.total5)') 



declare @lists nvarchar(MAX)
declare @namea nvarchar(20)
declare @cmd nvarchar(max)


declare cursor_table cursor for
select namea,list from  @list
open cursor_table
fetch next from cursor_table
into @namea,@lists
while(@@FETCH_STATUS <> -1)
begin
	set @cmd = 'insert into #tmp (gno,namea,a,b,c,d,e,f,g,h,i) values(''0'','''+@namea+''',(select '+@lists+' from salary a left join salarys b on a.noa = b.noa left join sss c on b.sno = c.noa where a.person=''外勞'' and a.mon='''+@t_xmon+''' and a.monkind=''本月'' and b.partno=''01''),(select '+@lists+' from salary a left join salarys b on a.noa = b.noa left join sss c on b.sno = c.noa where a.person=''外勞'' and a.mon='''+@t_xmon+''' and a.monkind=''本月'' and b.partno=''02''),(select '+@lists+' from salary a left join salarys b on a.noa = b.noa left join sss c on b.sno = c.noa where a.person=''外勞'' and a.mon='''+@t_xmon+''' and a.monkind=''本月'' and b.partno=''03'') 
		,(select '+@lists+' from salary a left join salarys b on a.noa = b.noa left join sss c on b.sno = c.noa where a.person=''外勞'' and a.mon='''+@t_xmon+''' and a.monkind=''本月'' and b.partno=''04''),(select '+@lists+' from salary a left join salarys b on a.noa = b.noa left join sss c on b.sno = c.noa where a.person=''外勞'' and a.mon='''+@t_xmon+''' and a.monkind=''本月'' and b.partno=''05''),(select '+@lists+' from salary a left join salarys b on a.noa = b.noa left join sss c on b.sno = c.noa where a.person=''外勞'' and a.mon='''+@t_xmon+''' and a.monkind=''本月'' and b.partno=''06''),(select '+@lists+' from salary a left join salarys b on a.noa = b.noa left join sss c on b.sno = c.noa where a.person=''外勞'' and a.mon='''+@t_xmon+''' and a.monkind=''本月'' and b.partno=''07'') 
		,(select '+@lists+' from salary a left join salarys b on a.noa = b.noa left join sss c on b.sno = c.noa where a.person=''外勞'' and a.mon='''+@t_xmon+''' and a.monkind=''本月'' and b.partno=''08''),(select '+@lists+' from salary a left join salarys b on a.noa = b.noa left join sss c on b.sno = c.noa where a.person=''外勞'' and a.mon='''+@t_xmon+''' and a.monkind=''本月'' and b.partno=''09''))' 
	EXECUTE sp_executesql @cmd
fetch next from cursor_table
into @namea,@lists
end
close cursor_table
deallocate cursor_table

select gno,namea,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a),1)),4,12)) a,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,b),1)),4,12)) b,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,c),1)),4,12)) c,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,e),1)),4,12)) e,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,f),1)),4,12)) f,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,g),1)),4,12)) g,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,h),1)),4,12)) h,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,i),1)),4,12)) i ,
(select worker from salary where person='外勞' and mon=@t_xmon and monkind='本月') worker
from #tmp

--刪除暫存資料庫
IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
       drop table #tmp
END;
--------------------------------------------------------------------------------------------------
z_salary10:--z_salary10
declare @t_xmon nvarchar(20)
declare @t_xkind nvarchar(20)
declare @t_bsssno nvarchar(20)
declare @t_esssno nvarchar(20)
declare @t_order nvarchar(20)
set @t_xmon = case when '#non' = [1] then '' else [1] end
set @t_xkind = case when '#non' = [3] then '' else [3] end
set @t_bsssno = case when '#non' = [4] then '' else [4] end
set @t_esssno = case when '#non' = [5] then CHAR(255) else [5] end
set @t_order = case when '#non' = [8] then '' else [8] end

declare @tmp table(
		gno nvarchar(1),
		noa nvarchar(30),
		noq nvarchar(20),
		mon nvarchar(20),
		sssno nvarchar(20), 
		partno nvarchar(20), 
		part nvarchar(50), 
		jobno nvarchar(20),
		job nvarchar(50),
		namea nvarchar(30),
		account nvarchar(20),
		total3 int,--現金
		total4 int,--匯款
		total5 int
)
insert into @tmp
select '0' gno,a.noa,b.noq,a.mon,c.noa,b.partno,b.part,b.jobno,b.job,b.namea,c.account,0,0,b.total5
from salary a
left join salarys b on a.noa = b.noa
left join sss c on b.sno = c.noa 
where (LEN(@t_xmon) = 0 or @t_xmon = a.mon) and 
(LEN(@t_xkind) = 0 or @t_xkind = a.monkind) and 
(b.sno between @t_bsssno and @t_esssno) and 
(a.person = '本國') 

--********102/01/04千嘉要求把員工的福利金加入到福利金的項目***********************
declare @t_welfare int
set @t_welfare=(select sum(b.welfare)
from salary a 
left join salarys b on a.noa = b.noa 
left join sss c on b.sno = c.noa 
where (LEN(@t_xmon) = 0 or @t_xmon = a.mon) and 
(LEN(@t_xkind) = 0 or @t_xkind = a.monkind) and 
(b.sno between @t_bsssno and @t_esssno) and 
(a.person = '本國') )

update @tmp 
set total5=total5+@t_welfare
where namea='福利金'
--*********************************************************************************

insert into @tmp 
select '1' gno,'','','','','','','','','','',0,0,sum(total5) 
from @tmp 

update @tmp
set total3=(select sum(total5) from  @tmp where gno='0' and account='')
where gno='1'
update @tmp
set total4=(select sum(total5) from  @tmp where gno='0' and account!='')
where gno='1'

if(@t_order='職稱')
select gno,noq,mon,namea,account,sssno,part,job,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total3),1)),4,12)) total3,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total4),1)),4,12)) total4,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total5),1)),4,12)) total5,
(select worker from salary where @t_xmon = mon and @t_xkind = monkind and person = '本國') worker
from @tmp order by gno,partno,jobno

if(@t_order='員工編號')
select gno,noq,mon,namea,account,sssno,part,job,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total3),1)),4,12)) total3,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total4),1)),4,12)) total4,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total5),1)),4,12)) total5,
(select worker from salary where @t_xmon = mon and @t_xkind = monkind and person = '本國') worker
from @tmp order by gno,noa

if(@t_order='帳號')
select gno,noq,mon,namea,account,sssno,part,job,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total3),1)),4,12)) total3,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total4),1)),4,12)) total4,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total5),1)),4,12)) total5,
(select worker from salary where @t_xmon = mon and @t_xkind = monkind and person = '本國') worker
from @tmp order by gno,account

if(@t_order='金額')
select gno,noq,mon,namea,account,sssno,part,job,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total3),1)),4,12)) total3,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total4),1)),4,12)) total4,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total5),1)),4,12)) total5,
(select worker from salary where @t_xmon = mon and @t_xkind = monkind and person = '本國') worker
from @tmp order by gno,cast(total5 as int) desc;



---------------------------------------------
z_salary11:--z_salary11
declare @t_xmon nvarchar(20)
declare @t_xperson nvarchar(20)
declare @t_xkind nvarchar(20)
declare @t_bxpartno nvarchar(20)
declare @t_expartno nvarchar(20)

set @t_xmon = case when '#non' = [1] then '' else [1] end
set @t_xperson = case when '#non' = [2] then '' else [2] end
set @t_xkind = case when '#non' = [3] then '' else [3] end
set @t_bxpartno = case when '#non' = [9] then '' else [9] end
set @t_expartno = case when '#non' = [10] then CHAR(255) else [10] end

declare @tmp table( 
	gno nvarchar(1), 
	sssno nvarchar(20),
	partno nvarchar(20),
	part nvarchar(20),
	jobno nvarchar(20),
	job nvarchar(20),
	namea nvarchar(50), 
	salary int, 
	botr int, 
	bosp int, 
	boad int, 
	bofu int, 
	boot int, 
	plus int, 
	total1 int, 
	mipe int, 
	misi int, 
	welfare int, 
	minus int, 
	lhrt int, 
	total4 int, 
	total5 int 
) 
insert into @tmp 
select '0' gno,c.noa,b.partno,b.part,b.jobno,b.job,b.namea,b.money,b.bo_traffic,b.bo_special,b.bo_admin,b.bo_full,b.bo_oth, 
isnull(b.plus,0)+b.addmoney,b.money+b.bo_traffic+b.bo_special+b.bo_admin+b.bo_full+b.bo_oth+isnull(b.plus,0),b.mi_person,b.mi_sick,b.welfare,isnull(b.minus,0),b.ch_labor+b.ch_labor_self+b.ch_health,
b.mi_person+b.mi_sick+b.welfare+isnull(b.minus,0)+b.ch_labor+b.ch_labor_self+b.ch_health, 
b.total5 
from salary a 
left join salarys b on a.noa = b.noa 
left join sss c on b.sno=c.noa
where (LEN(@t_xmon) =0 or @t_xmon = a.mon) and 
(LEN(@t_xkind) = 0 or @t_xkind = a.monkind) and 
(LEN(@t_xperson) = 0 or @t_xperson = a.person) and
(b.partno between @t_bxpartno and @t_expartno) 

insert into @tmp 
select '1' gno,'','','','','','',SUM(salary),SUM(botr),SUM(bosp),SUM(boad),SUM(bofu),sum(boot),SUM(plus),SUM(total1),SUM(mipe), 
SUM(misi),SUM(welfare),SUM(minus),SUM(lhrt),sum(total4),SUM(total5) 
from @tmp 

select gno,sssno,job,part,namea, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,salary),1)),4,12)) salary, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,botr),1)),4,12)) botr, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bosp),1)),4,12)) bosp, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,boad),1)),4,12)) boad, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bofu),1)),4,12)) bofu, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,boot),1)),4,12)) boot, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,plus),1)),4,12)) plus, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total1),1)),4,12)) total1, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,mipe),1)),4,12)) mipe, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,misi),1)),4,12)) misi, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,welfare),1)),4,12)) welfare, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,minus),1)),4,12)) minus, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,lhrt),1)),4,12)) lhrt, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total4),1)),4,12)) total4, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total5),1)),4,12)) total5,
(select worker from salary where @t_xmon = mon and @t_xkind = monkind and person = @t_xperson) worker 
from @tmp order by gno,partno,jobno;
-----------------------------------------------------------------------------------------------
z_salarydc:--z_salarydc 
declare @t_xmon nvarchar(20) 
declare @t_xkind nvarchar(20) 
set @t_xmon = case when '#non' = [1] then '' else [1] end
set @t_xkind = case when '#non' = [3] then '' else [3] end
declare @tmp table( 
		gno nvarchar(1),
		sssno nvarchar(20),
		namea nvarchar(50),
		daym float,
		boad float,
		botr float,
		bosp float,
		boot float,
		bofu float,
		taxt float,
		addm float,
		plus float,
		total3 float,
		borr float,
		chla float,
		minus float,
		welf float,
		chhe float,
		total4 float,
		total5 float
		) 
insert into @tmp 
select '0' gno,b.sno,b.namea,b.daymoney,b.bo_admin,b.bo_traffic,b.bo_special,b.bo_oth,b.bo_full, 
b.tax_other,b.addmoney,b.plus,b.total3,b.borrow,b.ch_labor,b.minus,b.welfare,b.ch_health,b.total4,b.total5
from salary a 
left join salarys b on a.noa = b.noa 
where a.person = '日薪' and @t_xmon = a.mon and @t_xkind = a.monkind 


select gno,sssno,namea,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,daym),1)),4,12)) daym,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,boad),1)),4,12)) boad,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,botr),1)),4,12)) botr,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bosp),1)),4,12)) bosp,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,boot),1)),4,12)) boot,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bofu),1)),4,12)) bofu,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,taxt),1)),4,12)) taxt,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,addm),1)),4,12)) addm,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,plus),1)),4,12)) plus,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total3),1)),4,12)) total3,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,borr),1)),4,12)) borr,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,chla),1)),4,12)) chla,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,minus),1)),4,12)) minus,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,welf),1)),4,12)) welf,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,chhe),1)),4,12)) chhe,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total4),1)),4,12)) total4,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total5),1)),4,12)) total5,
(select worker from salary where @t_xmon = mon and @t_xkind = monkind and person = '日薪') worker
from @tmp ;
------------------------------------------------------------------------------------------
z_saladjust1:--z_saladjust1
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
declare @t_bsssno nvarchar(20)
declare @t_esssno nvarchar(20)
set @t_bdate = case when '#non' = [6] then '' else [6] end
set @t_edate = case when '#non' = [7] then CHAR(255) else [7] end
set @t_bsssno = case when '#non' = [4] then '' else [4] end
set @t_esssno = case when '#non' = [5] then CHAR(255) else [5] end
declare @tmp table(
		gno nvarchar(1),
		noa nvarchar(20),
		namea nvarchar(50),
		datea nvarchar(20),
		jobno nvarchar(20),
		job nvarchar(50),
		level1 nvarchar(20),
		level2 nvarchar(20),
		moneys float,
		boad float,
		botr float,
		bosp float,
		boot float,
		bofu float,
		salary float
)
insert into @tmp
select '0' gno,a.noa,b.namea,a.datea,a.jobno,a.job,a.level1,a.level2,a.money,a.bo_admin,a.bo_traffic,a.bo_special,
a.bo_oth,a.bo_full,a.salary
from saladjust a
left join sss b on a.noa = b.noa
where (a.noa between @t_bsssno and @t_esssno) and
(a.datea between @t_bdate and @t_edate)

select gno,noa,namea,datea,jobno,job,level1,level2,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,moneys),1)),4,12)) moneys,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,boad),1)),4,12)) boad,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,botr),1)),4,12)) botr,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bosp),1)),4,12)) bosp,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,boot),1)),4,12)) boot,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bofu),1)),4,12)) bofu,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,salary),1)),4,12)) salary
from @tmp;
-------------------------------------------------------------------------------------------------------
z_salchg1:--z_salchg1
declare @t_xmon nvarchar(20) 
declare @t_bsssno nvarchar(20)
declare @t_esssno nvarchar(20)
set @t_xmon = case when '#non' = [1] then '' else [1] end
set @t_bsssno = case when '#non' = [4] then '' else [4] end
set @t_esssno = case when '#non' = [5] then CHAR(255) else [5] end
declare @tmp table(
		gno nvarchar(1),
		noa nvarchar(20),
		datea nvarchar(10),
		mon nvarchar(10),
		sssno nvarchar(20),
		namea nvarchar(50),
		mini nvarchar(20),
		minm float,
		plus nvarchar(20),
		plum float,
		memo nvarchar(200)
)
insert into @tmp 
select '0' gno,a.noa,datea,mon,sssno,namea,b.item,minus,c.item,plus,memo 
from salchg a left join salchgitem b on a.minusitem=b.noa
left join salchgitem c on a.plusitem=c.noa
where mon =@t_xmon and 
(sssno between @t_bsssno and @t_esssno) 

insert into @tmp
select '1' gno,'','','','','','',sum(minm),'',sum(plum),''
from @tmp

select gno,noa,datea,mon,sssno,namea,mini,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,minm),1)),4,12)) minm,plus,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,plum),1)),4,12)) plum,memo
from @tmp order by gno,sssno;
----------------------------------------------------------------------------------
z_saladjust2:--z_saladjust2
declare @t_bxpartno nvarchar(20)
declare @t_expartno nvarchar(20)
declare @t_bsssno nvarchar(20)
declare @t_esssno nvarchar(20)
declare @t_xyear nvarchar(20)

set @t_bxpartno = case when '#non' = [9] then '' else [9] end
set @t_expartno = case when '#non' = [10] then CHAR(255) else [10] end
set @t_bsssno = case when '#non' = [4] then '' else [4] end
set @t_esssno = case when '#non' = [5] then CHAR(255) else [5] end
set @t_xyear = case when '#non' = [11] then '' else [11] end

declare @i int
declare @countrecord int
declare @part nvarchar(20)
set @i = 0
set @countrecord = 0
set @part = ''
declare @tmp table(
		gno nvarchar(1),
		idno int identity(0,1),
		pno nvarchar(20),
		part nvarchar(20),
		namea nvarchar(50),
		jobno nvarchar(20),
		indate nvarchar(10)
)
insert into @tmp
select '0'gno,partno,part,namea,jobno,indate
from sss
where (partno between @t_bxpartno and @t_expartno) and 
(noa between @t_bsssno and @t_esssno) and noa!='Z001' and noa!='010132' and (outdate='' or outdate is null)
and (partno !='0910' and partno !='0911')
order by partno,jobno 

--select @countrecord = COUNT(*) from @tmp 
--while(@i < @countrecord)
--begin
	--if(@part = '' or (select part from @tmp where idno = @i ) != @part)
	--begin
		--select @part = part from @tmp where idno = @i
	--end
	--else
	--begin
			--update @tmp set part = '' where idno = @i
	--end
	--set @i +=1
--end
select *,@t_xyear xyear
from @tmp;
--------------------------------------------------------------------------------------
z_saladjust3:--z_saladjust3
declare @t_xyear nvarchar(20)
declare @t_bxpartno nvarchar(20)
declare @t_expartno nvarchar(20)
declare @t_bsssno nvarchar(20)
declare @t_esssno nvarchar(20)
set @t_xyear = case when '#non' = [11] then '' else [11] end
set @t_bxpartno = case when '#non' = [9] then '' else [9] end
set @t_expartno = case when '#non' = [10] then CHAR(255) else [10] end
set @t_bsssno = case when '#non' = [4] then '' else [4] end
set @t_esssno = case when '#non' = [5] then CHAR(255) else [5] end


declare @tmp table(
		gno  nvarchar(1),
		partno nvarchar(20),
		part nvarchar(20),
		sssno nvarchar(20),
		namea nvarchar(20),
		jobno nvarchar(20),
		salary float,
		botr float,
		bosp float,
		boad float,
		boot float,
		bofu float,
		total float,
		payrise float,
		rate float,
		afsalary float,
		memo nvarchar(MAX)
)

--插入去年薪資 (最後一次調整的薪資)1030414
declare @sssno nvarchar(20) 
declare cursor_table cursor for 
select noa from sss where noa!='Z001' and outdate='' and partno!='0910' and partno!='0911' 
and (partno between @t_bxpartno and @t_expartno) and noa between @t_bsssno and @t_esssno
open cursor_table 
fetch next from cursor_table 
into @sssno 
while(@@FETCH_STATUS <> -1) 
begin 
	insert into @tmp 
	select '0'gno, b.partno,b.part,a.noa,b.namea,b.jobno, 
	a.money,a.bo_traffic,a.bo_special,a.bo_admin,a.bo_oth,a.bo_full, 
	(a.money+a.bo_traffic+a.bo_special+a.bo_admin+a.bo_oth+a.bo_full)total,0,0,0,'' 
	from saladjust a right join sss b on a.noa=b.noa
	where a.noa=@sssno and a.datea=isnull((select MAX(datea) from saladjust where noa=@sssno and datea<=@t_xyear+'/05/31'),'')
	
	fetch next from cursor_table 
	into @sssno 
end 
close cursor_table 
deallocate cursor_table 

--插入去年薪資(之前版本)
--insert into @tmp 
--select '0'gno, b.partno,b.part,a.noa,b.namea,b.jobno,
--a.money,a.bo_traffic,a.bo_special,a.bo_admin,a.bo_oth,a.bo_full,
--(a.money+a.bo_traffic+a.bo_special+a.bo_admin+a.bo_oth+a.bo_full)total,0,0,0,''
--from saladjust a right join sss b on a.noa=b.noa
--where a.datea<=@t_xyear+'/05/31'
--and a.noa!='Z001' and b.outdate='' and b.partno!='0910' and b.partno!='0911'

--插入今年薪資與備註(今年第一筆 之後改為最後一筆)
declare cursor_table cursor for
	select sssno from @tmp
	open cursor_table
	fetch next from cursor_table
	into @sssno
	while(@@FETCH_STATUS <> -1)
	begin
		update @tmp
		--set afsalary=isnull((select (money+bo_traffic+bo_special+bo_admin+bo_oth+bo_full) from saladjust where noa=@sssno and datea>@t_xyear+'/05/31'),0),
		--memo=(select memo from saladjust where noa=@sssno and datea>@t_xyear+'/05/31')
		set afsalary=isnull((select top 1 (money+bo_traffic+bo_special+bo_admin+bo_oth+bo_full) from saladjust where noa=@sssno and datea>@t_xyear+'/05/31' order by datea desc),0), 
		memo=(select top 1 memo from saladjust where noa=@sssno and datea>@t_xyear+'/05/31' order by datea desc) 
		where sssno=@sssno
		fetch next from cursor_table
		into @sssno
	end
close cursor_table
deallocate cursor_table

--插入調整金額與比例

update @tmp 
set payrise=(case when (afsalary-total)=(-1*total) then 0 else (afsalary-total) end) 

update @tmp 
set rate=case when isnull(total,0)=0 then 0 else ROUND((payrise/total),3)*100.0 end

--插入合計
insert into @tmp 
select '1'gno, '','','','','',sum(salary),sum(botr),sum(bosp),sum(boad),sum(boot),sum(bofu),sum(total),sum(payrise),0,sum(afsalary),''
from @tmp where gno='0'

update @tmp 
set rate=case when isnull(total,0)=0 then 0 else ROUND((payrise/total),3)*100.0 end
where gno='1'


select gno,partno,part,sssno,namea,jobno,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,salary),1)),4,12)) salary, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,botr),1)),4,12)) botr, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bosp),1)),4,12)) bosp, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,boad),1)),4,12)) boad, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,boot),1)),4,12)) boot, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bofu),1)),4,12)) bofu,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,payrise),1)),4,12)) payrise,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,(case when afsalary=0 then total else afsalary end)),1)),4,12)) afsalary,
cast(rate as nvarchar(10))+'%' rate,memo
from @tmp order by gno,partno,jobno;

-------------------------------------------------------------------------------------------------------------------------------------------------------
z_salary12:--z_salary12
declare @t_year nvarchar(20) 
declare @t_bsssno nvarchar(20) 
declare @t_esssno nvarchar(20) 

set @t_year = case when '#non' = [11] then '' else [11] end
set @t_bsssno = case when '#non' = [4] then '' else [4] end
set @t_esssno = case when '#non' = [5] then CHAR(255) else [5] end

--刪除暫存資料庫 
IF OBJECT_ID('tempdb..#tmpa')is not null 
BEGIN 
	drop table #tmpa 
END 

create table #tmpa( 
	gno nvarchar(1), 
	recno int,
	title nvarchar(20),
	sssno nvarchar(20), 
	namea nvarchar(20), 
	a float, 
	b float, 
	c float, 
	d float, 
	e float, 
	f float, 
	g float, 
	h float, 
	i float, 
	j float, 
	k float, 
	l float, 
	m float
) 
--a,b,c,d,e,f,g,h,i->都是1~12月欄位 
declare @list table( 
	recno int, 
	[namea] nvarchar(20), 
	[list] nvarchar(MAX) 
) 
--插入要計算的欄位名稱 
insert into @list (recno,namea,list) values(1,'底薪','b.money') 
insert into @list (recno,namea,list) values(2,'主管津貼','b.bo_admin') 
insert into @list (recno,namea,list) values(3,'交通津貼','b.bo_traffic') 
insert into @list (recno,namea,list) values(4,'工作津貼','b.bo_special') 
insert into @list (recno,namea,list) values(5,'其他津貼','b.bo_oth') 
insert into @list (recno,namea,list) values(6,'其他加項','b.plus') 
insert into @list (recno,namea,list) values(7,'小計','b.total1') 
insert into @list (recno,namea,list) values(8,'扣薪時數','b.mi_saliday') 
insert into @list (recno,namea,list) values(9,'扣薪金額','b.mi_total') 
insert into @list (recno,namea,list) values(10,'全勤','b.bo_full') 
insert into @list (recno,namea,list) values(11,'應稅其他','b.tax_other') 
insert into @list (recno,namea,list) values(12,'給付總額','b.total2') 
insert into @list (recno,namea,list) values(13,'加班費','b.addmoney') 
insert into @list (recno,namea,list) values(14,'免稅其他','b.tax_other2') 
insert into @list (recno,namea,list) values(15,'應領總額','b.total3') 
insert into @list (recno,namea,list) values(16,'借支','b.borrow') 
insert into @list (recno,namea,list) values(17,'勞保費','b.ch_labor') 
insert into @list (recno,namea,list) values(18,'勞退公司提繳','b.ch_labor_comp') 
insert into @list (recno,namea,list) values(19,'勞退個人提繳','b.ch_labor_self') 
insert into @list (recno,namea,list) values(20,'健保費','b.ch_health') 
insert into @list (recno,namea,list) values(21,'福利金','b.welfare') 
insert into @list (recno,namea,list) values(22,'其他扣款','b.minus') 
insert into @list (recno,namea,list) values(23,'應扣總額','b.total4') 
insert into @list (recno,namea,list) values(24,'實發金額','b.total5') 

declare @lists nvarchar(MAX) 
declare @namea nvarchar(20) 
declare @recno int
declare @cmd nvarchar(max) 

declare @sssno nvarchar(20)
declare @sssnamea nvarchar(20)

declare sss_table cursor for 
select noa,namea from sss where noa between @t_bsssno and @t_esssno
and (noa in (select sno from salarys where left(mon,3)=@t_year))
open sss_table 
fetch next from sss_table 
into @sssno,@sssnamea
while(@@FETCH_STATUS <> -1) 
begin 

	declare cursor_table cursor for 
	select namea,list,recno from @list
	open cursor_table 
	fetch next from cursor_table 
	into @namea,@lists,@recno
	while(@@FETCH_STATUS <> -1) 
	begin 
		set @cmd = 'insert into #tmpa (gno,recno,title,a,b,c,d,e,f,g,h,i,j,k,l,sssno,namea) values(''0'','+cast(@recno as  nvarchar(20))+','''+@namea+''', 
		isnull((select sum('+@lists+') from salarys b where b.mon='''+@t_year+'/01'' and b.sno='''+@sssno+'''),0), 
		isnull((select sum('+@lists+') from salarys b where b.mon='''+@t_year+'/02'' and b.sno='''+@sssno+'''),0), 
		isnull((select sum('+@lists+') from salarys b where b.mon='''+@t_year+'/03'' and b.sno='''+@sssno+'''),0), 
		isnull((select sum('+@lists+') from salarys b where b.mon='''+@t_year+'/04'' and b.sno='''+@sssno+'''),0), 
		isnull((select sum('+@lists+') from salarys b where b.mon='''+@t_year+'/05'' and b.sno='''+@sssno+'''),0), 
		isnull((select sum('+@lists+') from salarys b where b.mon='''+@t_year+'/06'' and b.sno='''+@sssno+'''),0), 
		isnull((select sum('+@lists+') from salarys b where b.mon='''+@t_year+'/07'' and b.sno='''+@sssno+'''),0), 
		isnull((select sum('+@lists+') from salarys b where b.mon='''+@t_year+'/08'' and b.sno='''+@sssno+'''),0), 
		isnull((select sum('+@lists+') from salarys b where b.mon='''+@t_year+'/09'' and b.sno='''+@sssno+'''),0), 
		isnull((select sum('+@lists+') from salarys b where b.mon='''+@t_year+'/10'' and b.sno='''+@sssno+'''),0), 
		isnull((select sum('+@lists+') from salarys b where b.mon='''+@t_year+'/11'' and b.sno='''+@sssno+'''),0), 
		isnull((select sum('+@lists+') from salarys b where b.mon='''+@t_year+'/12'' and b.sno='''+@sssno+'''),0),'''+@sssno+''','''+@sssnamea+''')' 

		EXECUTE sp_executesql @cmd 

		fetch next from cursor_table 
		into @namea,@lists,@recno
	end 
	close cursor_table 
	deallocate cursor_table 
	
	fetch next from sss_table 
	into @sssno,@sssnamea
end 
close sss_table 
deallocate sss_table 

update #tmpa
set m=a+b+c+d+e+f+g+h+i+j+k+l

select gno,namea,title,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a),1)),4,12)) a, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,b),1)),4,12)) b, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,c),1)),4,12)) c, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,d),1)),4,12)) d, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,e),1)),4,12)) e, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,f),1)),4,12)) f, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,g),1)),4,12)) g, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,h),1)),4,12)) h,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,i),1)),4,12)) i,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,j),1)),4,12)) j,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,k),1)),4,12)) k, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,l),1)),4,12)) l,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,m),1)),4,12)) m 
from #tmpa order by sssno,gno,recno

--刪除暫存資料庫 
IF OBJECT_ID('tempdb..#tmpa')is not null 
BEGIN 
drop table #tmpa
END ;
-------------------------------------------------------------------------------------------------------------------------------------------------------