post:--deli
--報關轉進貨單
SET QUOTED_IDENTIFIER OFF
declare @year nvarchar(20)=[1]--年度[1]
declare @noa nvarchar(20)=[2]--單據編號[2]
declare @condition nvarchar(20)=[3]--動作 0 刪除, 1 新增[3]
declare @userno nvarchar(20)=[4]--使用者
declare @t_err nvarchar(200)=''
-----------------------------------------------------------------------
-----------------------------------------------------------------------
declare @nowdate nvarchar(30) --今天日期
set @nowdate=CONVERT (VARCHAR(7), GETDATE(),12 )+0890000
set @nowdate=left(@nowdate,3)+'/'+substring(@nowdate,4,2)+'/'+right(@nowdate,2)

--104/07/16依報關日
set @nowdate=isnull((select top 1 datea from deli where noa=@noa),@nowdate)

declare @cmd nvarchar(max)
declare @rc2no nvarchar(50)
declare @accy nvarchar(20) --rc2的年度

set @rc2no=isnull((select rc2no from deli where noa=@noa),'')
set @accy=isnull((select top 1 accy from view_rc2 where noa=@rc2no),@year)

if(@condition='0')
begin
	--刪除產生的rc2
	set @cmd="delete rc2"+@accy+" where noa='"+@rc2no+"'"
	EXECUTE sp_executesql @cmd
	set @cmd="delete rc2s"+@accy+" where noa='"+@rc2no+"'"
	EXECUTE sp_executesql @cmd
end

declare @n_rc2no nvarchar(50) --新的rc2no

if(@condition='1')
begin
	--檢查deli的rc2no是否已有編號(表示修改)
	if(LEN(@rc2no)=0)
	begin
		--取得當天最後一個出貨單號
		select @n_rc2no=MAX(noa) from view_rc2 where noa like 'B'+REPLACE(@nowdate,'/','')+'%'
		--新的出貨單號(後面號碼+1)
		set @n_rc2no='B'+REPLACE(@nowdate,'/','')+right('000'+cast(cast(RIGHT(isnull(@n_rc2no,'000'),3) as int)+1 as nvarchar(10)),3)
	end
	else
	begin
		set @n_rc2no=@rc2no
	end
	
	DECLARE @chk tinyint = 0
	Begin Transaction [Trans_Name]
	--將deli的內容轉至rc2
	--104/10/02 傑期 coin 寫入到 part2 12/14 entryno寫到 lcno
	if((select count(*) from acomp where acomp like '%傑期%')>0)
	begin
		set @cmd="insert rc2"+@accy+"(noa,ordeno,typea,kind,datea,tggno,comp,nick,tel,post,addr,salesno,sales
		,cno,acomp,paytype,trantype,floata,part2,taxtype,worker,worker2,memo,mon
		,money,tax,total,unpay,payed,totalus,lcno)
		select '"+@n_rc2no+"' noa,a.noa ordeno,'1','A1','"+@nowdate+"',a.tggno,a.comp,b.nick,b.tel,b.zip_fact,b.addr_fact,b.salesno,b.sales
		,a.cno,a.acomp,b.paytype,b.trantype,a.floata,a.coin,case when a.vatrate!=0 then '1' else  '' end,''
		,case when a.worker2!='' then a.worker2 else a.worker end,a.memo,left('"+@nowdate+"',6)
		,0,0,0,0,0,a.cointotal,a.entryno
		from deli a left join tgg b on a.tggno=b.noa where a.noa='"+@noa+"'"
		EXECUTE sp_executesql @cmd
		IF @@Error <> 0 BEGIN SET @chk = 1 END
	end
	else
	begin
		set @cmd="insert rc2"+@accy+"(noa,ordeno,typea,kind,datea,tggno,comp,nick,tel,post,addr,salesno,sales
		,cno,acomp,paytype,trantype,floata,coin,taxtype,worker,worker2,memo,mon
		,money,tax,total,unpay,payed,totalus)
		select '"+@n_rc2no+"' noa,a.noa ordeno,'1','A1','"+@nowdate+"',a.tggno,a.comp,b.nick,b.tel,b.zip_fact,b.addr_fact,b.salesno,b.sales
		,a.cno,a.acomp,b.paytype,b.trantype,a.floata,a.coin,case when a.vatrate!=0 then '1' else  '' end,''
		,case when a.worker2!='' then a.worker2 else a.worker end,a.memo,left('"+@nowdate+"',6)
		,0,0,0,0,0,a.cointotal
		from deli a left join tgg b on a.tggno=b.noa where a.noa='"+@noa+"'"
		EXECUTE sp_executesql @cmd
		IF @@Error <> 0 BEGIN SET @chk = 1 END
	end
	
	set @cmd="insert rc2s"+@accy+"(noa,noq,datea,typea,productno,product,unit,unit2
	,spec,style,uno,uno2,class,dime,width,lengthb,size,dime2,lengthc,source	,memo,ordeno,no2,tggno,storeno,store
	,ucolor,scolor,lengthd,mount,weight,price,sprice,sprice2,total)
	select '"+@n_rc2no+"' noa,a.noq,'"+@nowdate+"','1' typea,a.productno,a.product,a.unit,a.unit2
	,a.spec,a.style,a.uno,a.uno2,a.class,a.dime,a.width,a.lengthb,a.size,a.dime2,a.lengthc,a.source,a.memo,a.ordcno,a.no2,b.tggno,a.storeno,a.store
	,a.ucolor,a.scolor,a.lengthd,a.mount,a.weight
	--,round(a.price*b.floata,4)
	--,case when upper(isnull(a.unit,'')) in ('','KG','MT','公斤','噸','頓') then round(a.total/a.weight,3) else round(a.total/a.mount,3) end
	,a.price2
	,case when upper(isnull(a.unit,'')) in ('','KG','MT','公斤','噸','頓') then case when a.weight=0 then 0 else round(a.cost/a.weight,3) end else case when a.mount=0 then 0 else round(a.cost/a.mount,3) end end
	,case when upper(isnull(a.unit,'')) in ('','KG','MT','公斤','噸','頓') then case when a.weight=0 then 0 else round(a.total/a.weight,3) end else case when a.mount=0 then 0 else round(a.total/a.mount,3) end end
	,a.total
	from delis a left join deli b on a.noa=b.noa where a.noa='"+@noa+"'"
	EXECUTE sp_executesql @cmd
	IF @@Error <> 0 BEGIN SET @chk = 1 END
	
	EXEC("update rc2"+@accy+" 
	set money=isnull((select sum(total) from view_rc2s where noa='"+@n_rc2no+"'),0)
	,total=isnull((select sum(total) from view_rc2s where noa='"+@n_rc2no+"'),0)
	,unpay=isnull((select sum(total) from view_rc2s where noa='"+@n_rc2no+"'),0)-isnull((select sum(paysale) from pays where rc2no='"+@n_rc2no+"'),0)
	,payed=isnull((select sum(paysale) from pays where rc2no='"+@n_rc2no+"'),0)
	where noa='"+@n_rc2no+"' ")
	IF @@Error <> 0 BEGIN SET @chk = 1 END
	
	if(LEN(@rc2no)=0)
	begin
		--資料寫入dno 避免下次自動產生出現問題
		insert dno(tablea,noa,usera)
		select 'rc2',@n_rc2no,@userno
		IF @@Error <> 0 BEGIN SET @chk = 1 END
		
		insert drun(datea,timea,usera,action,noa,tablea,memo)
		select replace(CONVERT (VARCHAR(10), GETDATE(),20),'-','/')
		,left(right(CONVERT (VARCHAR(20), GETDATE(),20),8),5)
		,@userno,'update',@n_rc2no	,'rc2','手動更新'
		IF @@Error <> 0 BEGIN SET @chk = 1 END
		
		--更新rc2no
		set @cmd="update deli set rc2no='"+@n_rc2no+"' where noa='"+@noa+"'"
		EXECUTE sp_executesql @cmd
		IF @@Error <> 0 BEGIN SET @chk = 1 END
	end
	IF @chk <> 0 BEGIN -- 若是新增資料發生錯誤
		Rollback Transaction [Trans_Name] -- 復原所有操作所造成的變更
	END
	ELSE BEGIN
		Commit Transaction [Trans_Name] -- 提交所有操作所造成的變更
	END
	
	set @rc2no=@n_rc2no
	
end

	select @rc2no rc2no
;
-------------------------------------------------------------------------------------------------------------------------------------------------------