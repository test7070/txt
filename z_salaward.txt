z_salaward1:--z_salaward1
declare @year nvarchar(10)
declare @before_year nvarchar(10)
declare @t_bsssno nvarchar(20)
declare @t_esssno nvarchar(20)

set @year = case when '#non'=[2] then '' else [2] end
set @before_year = CAST(@year as int)-1
set @t_bsssno = case when '#non'=[3] then '' else [3] end
set @t_esssno = case when '#non'=[4] then char(255) else [4] end

------------------------------------------------------今年基本年終資料
declare @tmp table( 
gno nvarchar(1), 
partno nvarchar(20), 
part nvarchar(50), 
senior nvarchar(20), 
sssno nvarchar(20), 
namea nvarchar(50), 
indate nvarchar(10), 
salary float, 
boa float, 
bot float, 
bos float, 
boo float, 
total float, 
oldmidmon float, 
oldtotal float, 
total6 float, 
total5 float, 
total7 float, 
total8 float, 
first float, 
second float, 
memo2 nvarchar(MAX) 
) 
insert into @tmp 
select '0' gno,b.partno,b.part,'' senior,b.sssno,b.namea,b.indate 
,b.salary,b.bo_traffic,b.bo_special,b.bo_admin,b.bo_oth,b.money as total,b.oldmidmon,b.oldaward 
,b.total6,b.total5,b.total7,b.total8,b.firstmoney,b.secondmoney,b.memo2 
from salaward a left join salawards b on a.noa=b.noa 
where (a.year = @year) and (typea='年終') and (b.sssno between @t_bsssno and @t_esssno) 

------------------------------------------------------------------------------------------ 
--年資 
update @tmp 
set senior = ( 
case when (CAST(left(indate,3) as int)=0) then '未滿一月' else ( 
case when (@year-CAST(left(indate,3) as int)) >0 then cast((@year-CAST(left(indate,3) as int)) as nvarchar) + ' 年 ' else '' end + 
case when (12-CAST(right(left(indate,6),2) as int)) >0 then cast((12-CAST(right(left(indate,6),2) as int)) as nvarchar) + ' 月' else '' end ) 
end) 
------------------------------------------------------------------------------------------- 

--插入總計 
insert into @tmp 
select '1' gno ,'999','','','','','' 
,sum(salary),sum(bot),sum(bos),sum(boa),sum(boo),sum(total),sum(oldmidmon) 
,sum(oldtotal),sum(total6),sum(total5),sum(total7),sum(total8),sum(first),sum(second),'' 
from @tmp where gno='0' 


------------------------------------- 
--插入部門小計
insert into @tmp 
select '2' gno,partno,part,'','','','' 
,sum(salary),sum(bot),sum(bos),sum(boa),sum(boo),sum(total),sum(oldmidmon) 
,sum(oldtotal),sum(total6),sum(total5),sum(total7),sum(total8),sum(first),sum(second),'' 
from @tmp where gno='0' group by partno,part

select gno,partno,part,senior,namea, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,salary),1)),4,12)) salary, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bot),1)),4,12)) bot, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bos),1)),4,12)) bos, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,boa),1)),4,12)) boa, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,boo),1)),4,12)) boo, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,oldmidmon),1)),4,12)) oldmidmon, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,oldtotal),1)),4,12)) total1, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total6),1)),4,12)) total6, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total5),1)),4,12)) total5, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total7),1)),4,12)) total7, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total8),1)),4,12)) total8, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,first),1)),4,12)) first, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,second),1)),4,12)) second, 
memo2,(select worker from salaward where (year = @year) and (typea = '年終'))worker 
from @tmp 
order by partno,gno;
--*************************************************************************************************************
z_salaward2:--z_salaward2
declare @year nvarchar(10)
declare @t_bsssno nvarchar(20)
declare @t_esssno nvarchar(20)

set @year = case when '#non'=[2] then '' else [2] end
set @t_bsssno = case when '#non'=[3] then '' else [3] end
set @t_esssno = case when '#non'=[4] then char(255) else [4] end

declare @tmp table( 
gno nvarchar(1), 
idno int identity(1,1),
part nvarchar(50), 
namea nvarchar(50), 
salary float, 
adjustmoney float, 
sugmoney float, 
chkmoney float, 
memo nvarchar(max) 
) 
insert into @tmp 
select '0' gno,part,namea,salary,adjustmoney,sugmoney,chkmoney,memo2 
from salaward a left join salawards b on a.noa=b.noa 
where (a.year = @year) and (a.typea='秋節') and (b.sssno between @t_bsssno and @t_esssno) 

insert into @tmp 
select '1','','',SUM(salary),SUM(adjustmoney), SUM(sugmoney),SUM(chkmoney),'' 
from @tmp where gno = '0'

select gno,idno,part,namea,memo
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,salary),1)),4,12)) salary
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,adjustmoney),1)),4,12)) adjustmoney
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,sugmoney),1)),4,12)) sugmoney
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,chkmoney),1)),4,12)) chkmoney
,(select worker from salaward where (year = @year) and (typea = '秋節'))worker 
from @tmp;
----------------------------------------------------------------------------------
z_salaward3:--z_salaward3
declare @t_year nvarchar(20)
declare @t_bsssno nvarchar(20)
declare @t_esssno nvarchar(20)
set @t_year = case when '#non' = [2] then '' else [2] end
set @t_bsssno = case when '#non' = [3] then '' else [3] end
set @t_esssno = case when '#non' = [4] then CHAR(255) else [4] end
--刪除暫存資料庫
IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
       drop table #tmp
END
SET QUOTED_IDENTIFIER OFF
declare @tmpa table( 
idno int identity(1,1),
sssno nvarchar(20), 
namea nvarchar(50), 
total6 float, 
oldmidmon float, 
total5 float,
total7 float, 
firstmoney float, 
secondmoney float
)

create table #tmp( 
gno nvarchar(1), 
sssno1 nvarchar(20), 
namea1 nvarchar(50), 
total61 float, 
oldmidmon1 float, 
total51 float,
total71 float, 
firstmoney1 float, 
secondmoney1 float, 
sssno2 nvarchar(20), 
namea2 nvarchar(50), 
total62 float, 
oldmidmon2 float, 
total52 float,
total72 float, 
firstmoney2 float, 
secondmoney2 float, 
sssno3 nvarchar(20), 
namea3 nvarchar(50), 
total63 float, 
oldmidmon3 float, 
total53 float,
total73 float, 
firstmoney3 float, 
secondmoney3 float, 
sssno4 nvarchar(20), 
namea4 nvarchar(50), 
total64 float, 
oldmidmon4 float, 
total54 float,
total74 float, 
firstmoney4 float, 
secondmoney4 float, 
sssno5 nvarchar(20), 
namea5 nvarchar(50), 
total65 float, 
oldmidmon5 float, 
total55 float,
total75 float, 
firstmoney5 float, 
secondmoney5 float, 
sssno6 nvarchar(20), 
namea6 nvarchar(50), 
total66 float, 
oldmidmon6 float, 
total56 float,
total76 float, 
firstmoney6 float, 
secondmoney6 float, 
sssno7 nvarchar(20), 
namea7 nvarchar(50), 
total67 float, 
oldmidmon7 float, 
total57 float,
total77 float, 
firstmoney7 float, 
secondmoney7 float,
sssno0 nvarchar(20), 
namea0 nvarchar(50), 
total60 float, 
oldmidmon0 float, 
total50 float,
total70 float, 
firstmoney0 float, 
secondmoney0 float,
page int
) 

insert into @tmpa
select b.sssno,b.namea,b.total6,b.oldmidmon,b.total5,b.total7,b.firstmoney,b.secondmoney
from salaward a left join salawards b on a.noa=b.noa
where a.year=@t_year and a.typea='年終' and (b.sssno between @t_bsssno and @t_esssno) 

declare @idno int
declare @sssno nvarchar(20) 
declare @namea nvarchar(50)
declare @total6 float
declare @oldmidmon float
declare @total5 float
declare @total7 float
declare @firstmoney float
declare @secondmoney float

declare @page int
set @page=0
declare @cmd nvarchar(max)
declare cursor_table cursor for
	select * from @tmpa
	open cursor_table
	fetch next from cursor_table
	into @idno,@sssno,@namea,@total6,@oldmidmon,@total5,@total7,@firstmoney,@secondmoney
	while(@@FETCH_STATUS <> -1)
	begin
		if(@idno%8=1)
		begin
			set @page=@page+1
			INSERT INTO #tmp (gno,sssno1,namea1,total61,oldmidmon1,total51,total71,firstmoney1,secondmoney1,page)
			select '0',@sssno,@namea,@total6,@oldmidmon,@total5,@total7,@firstmoney,@secondmoney,@page
		end
		else
		begin
		set @cmd='update #tmp set sssno'+cast(@idno%8 as nvarchar(2))+' ='''+@sssno+''',namea'+cast(@idno%8 as nvarchar(2))+' ='''+@namea+''',total6'+cast(@idno%8 as nvarchar(2))+' ='+cast(@total6 as nvarchar(20))+',oldmidmon'+cast(@idno%8 as nvarchar(2))+' ='+cast(@oldmidmon as nvarchar(20))+',total5'+cast(@idno%8 as nvarchar(2))+' ='+cast(@total5 as nvarchar(20))+',total7'+cast(@idno%8 as nvarchar(2))+' ='+cast(@total7 as nvarchar(20))+',firstmoney'+cast(@idno%8 as nvarchar(2))+' ='+cast(@firstmoney as nvarchar(20))+',secondmoney'+cast(@idno%8 as nvarchar(2))+' ='+cast(@secondmoney as nvarchar(20))
		set @cmd=@cmd+' where page='+cast(@page as nvarchar(20))
		EXECUTE sp_executesql @cmd
		end
		
		fetch next from cursor_table
		into @idno,@sssno,@namea,@total6,@oldmidmon,@total5,@total7,@firstmoney,@secondmoney
	end
close cursor_table
deallocate cursor_table

select gno,sssno1,namea1,sssno2,namea2,sssno3,namea3,sssno4,namea4,sssno5,namea5,sssno6,namea6,sssno7,namea7,sssno0,namea0
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total61),1)),4,12)) total61
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,oldmidmon1),1)),4,12)) oldmidmon1
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total51),1)),4,12)) total51
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total71),1)),4,12)) total71
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,firstmoney1),1)),4,12)) firstmoney1
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,secondmoney1),1)),4,12)) secondmoney1

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total62),1)),4,12)) total62
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,oldmidmon2),1)),4,12)) oldmidmon2
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total52),1)),4,12)) total52
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total72),1)),4,12)) total72
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,firstmoney2),1)),4,12)) firstmoney2
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,secondmoney2),1)),4,12)) secondmoney2

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total63),1)),4,12)) total63
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,oldmidmon3),1)),4,12)) oldmidmon3
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total53),1)),4,12)) total53
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total73),1)),4,12)) total73
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,firstmoney3),1)),4,12)) firstmoney3
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,secondmoney3),1)),4,12)) secondmoney3

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total64),1)),4,12)) total64
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,oldmidmon4),1)),4,12)) oldmidmon4
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total54),1)),4,12)) total54
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total74),1)),4,12)) total74
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,firstmoney4),1)),4,12)) firstmoney4
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,secondmoney4),1)),4,12)) secondmoney4

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total65),1)),4,12)) total65
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,oldmidmon5),1)),4,12)) oldmidmon5
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total55),1)),4,12)) total55
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total75),1)),4,12)) total75
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,firstmoney5),1)),4,12)) firstmoney5
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,secondmoney5),1)),4,12)) secondmoney5

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total66),1)),4,12)) total66
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,oldmidmon6),1)),4,12)) oldmidmon6
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total56),1)),4,12)) total56
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total76),1)),4,12)) total76
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,firstmoney6),1)),4,12)) firstmoney6
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,secondmoney6),1)),4,12)) secondmoney6

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total67),1)),4,12)) total67
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,oldmidmon7),1)),4,12)) oldmidmon7
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total57),1)),4,12)) total57
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total77),1)),4,12)) total77
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,firstmoney7),1)),4,12)) firstmoney7
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,secondmoney7),1)),4,12)) secondmoney7

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total60),1)),4,12)) total60
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,oldmidmon0),1)),4,12)) oldmidmon0
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total50),1)),4,12)) total50
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total70),1)),4,12)) total70
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,firstmoney0),1)),4,12)) firstmoney0
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,secondmoney0),1)),4,12)) secondmoney0

from #tmp

--刪除暫存資料庫
IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
       drop table #tmp
END;
-------------------------------------------------------------------------------------------------
z_salaward4:--z_salaward4 
declare @year nvarchar(10) 
declare @before_year nvarchar(10) 
declare @t_bsssno nvarchar(20) 
declare @t_esssno nvarchar(20) 

set @year = case when '#non'=[2] then '' else [2] end
set @before_year = CAST(@year as int)-1
set @t_bsssno = case when '#non'=[3] then '' else [3] end
set @t_esssno = case when '#non'=[4] then char(255) else [4] end


------------------------------------------------------今年基本年終資料 
declare @tmp table( 
gno nvarchar(1), 
part nvarchar(50), 
senior nvarchar(20), 
sssno nvarchar(20), 
namea nvarchar(50), 
indate nvarchar(10), 
salary float, 
boa float, 
bot float, 
bos float, 
boo float, 
total float, 
oldmidmon float, 
oldtotal float, 
total6 float, 
total5 float, 
total7 float, 
total8 float, 
first float, 
second float, 
memo2 nvarchar(MAX),
total1 float,
late float,
lea float,
person float,
sick float,
leave float,
marry float,
bere float,
total2 float,
great float,
minor float,
com float,
major float,
pecca float,
repri float,
total3 float,
total4 float,
memo nvarchar(200)
) 
insert into @tmp 
select '0' gno ,b.part,'' senior,b.sssno,b.namea,b.indate 
,b.salary,b.bo_traffic,b.bo_special,b.bo_admin,b.bo_oth,b.money as total,b.oldmidmon,b.oldaward 
,b.total6,b.total5,b.total7,b.total8,b.firstmoney,b.secondmoney,b.memo2,b.total1,b.late,b.leaveearly,b.person,
b.sick,b.leave,b.marriageleave,b.bereavementleave,b.total2,b.greatmeriy,b.minormerits,b.commend,b.majordemerits,
b.peccadillo,b.reprimand,b.total3,b.total4,b.memo
from salaward a left join salawards b on a.noa=b.noa 
where (a.year = @year) and (typea='年終') and (b.sssno between @t_bsssno and @t_esssno) 

------------------------------------------------------------------------------------------ 
--年資 
update @tmp 
set senior = ( 
case when (CAST(left(indate,3) as int)=0) then '未滿一月' else ( 
case when (@year-CAST(left(indate,3) as int)) >0 then cast((@year-CAST(left(indate,3) as int)) as nvarchar) + ' 年 ' else '' end + 
case when (12-CAST(right(left(indate,6),2) as int)) >0 then cast((12-CAST(right(left(indate,6),2) as int)) as nvarchar) + ' 月' else '' end ) 
end) 
------------------------------------------------------------------------------------------- 

--插入總計 
insert into @tmp 
select '1' gno ,'','','','','' 
,sum(salary),sum(bot),sum(bos),sum(boa),sum(boo),sum(total),sum(oldmidmon) 
,sum(oldtotal),sum(total6),sum(total5),sum(total7),sum(total8),sum(first),sum(second),'',0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,'' 
from @tmp where gno='0' 


------------------------------------- 
select gno,part,senior,namea, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,salary),1)),4,12)) salary, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bot),1)),4,12)) bot, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bos),1)),4,12)) bos, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,boa),1)),4,12)) boa, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,boo),1)),4,12)) boo, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,oldmidmon),1)),4,12)) oldmidmon, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,oldtotal),1)),4,12)) total9, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total6),1)),4,12)) total6, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total5),1)),4,12)) total5, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total7),1)),4,12)) total7, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total8),1)),4,12)) total8, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,first),1)),4,12)) first, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,second),1)),4,12)) second, 
memo2,total1,late,lea,person,sick,leave,marry,bere,total2,great,minor,com,major,pecca,repri,total3,total4,memo
,(select worker from salaward where (year = @year) and (typea = '年終'))worker 
from @tmp ;

-------------------------------------------------------------------------------------------------
z_salaward5:--z_salaward5

declare @t_year nvarchar(10) 
set @t_year = case when '#non'=[2] then '' else [2] end

create table #tmp( 
	gno nvarchar(1), 
	namea nvarchar(20), 
	a float, 
	b float, 
	c float, 
	d float, 
	e float, 
	f float, 
	g float, 
	h float, 
	i float, 
	j float, 
	k float, 
	l float 
) 
--a,b,c,d,e,f,g,h,i->都是部門欄位 
declare @list table( 
[namea] nvarchar(20), 
[list] nvarchar(20) 
) 

insert into @list (namea,list) values('考績獎金','total5') 
insert into @list (namea,list) values('年終獎金','total6') 
insert into @list (namea,list) values('績效獎金','total7') 
insert into @list (namea,list) values('獎金合計','total8') 
insert into @list (namea,list) values('第一次發放金額','firstmoney') 
insert into @list (namea,list) values('第二次發放金額','secondmoney') 

declare @lists nvarchar(20) 
declare @namea nvarchar(20) 
declare @cmd nvarchar(max) 


declare cursor_table cursor for 
select namea,list from @list 
open cursor_table 
fetch next from cursor_table 
into @namea,@lists 
while(@@FETCH_STATUS <> -1) 
begin 
set @cmd = 'insert into #tmp (gno,namea,a,b,c,d,e,f,g,h,i,j,k,l) values(''0'','''+@namea+''',(select SUM(b.'+@lists+') from salaward a left join salawards b on a.noa = b.noa left join sss c on b.sssno = c.noa where a.year='''+@t_year+''' and a.typea=''年終'' and c.partno=''01''),(select SUM(b.'+@lists+') from salaward a left join salawards b on a.noa = b.noa left join sss c on b.sssno = c.noa where a.year='''+@t_year+''' and a.typea=''年終'' and c.partno=''02''),(select SUM(b.'+@lists+') from salaward a left join salawards b on a.noa = b.noa left join sss c on b.sssno = c.noa where a.year='''+@t_year+''' and a.typea=''年終'' and c.partno=''03'') 
,(select SUM(b.'+@lists+') from salaward a left join salawards b on a.noa = b.noa left join sss c on b.sssno = c.noa where a.year='''+@t_year+''' and a.typea=''年終'' and c.partno=''04''),(select SUM(b.'+@lists+') from salaward a left join salawards b on a.noa = b.noa left join sss c on b.sssno = c.noa where a.year='''+@t_year+''' and a.typea=''年終'' and c.partno=''05''),(select SUM(b.'+@lists+') from salaward a left join salawards b on a.noa = b.noa left join sss c on b.sssno = c.noa where a.year='''+@t_year+''' and a.typea=''年終'' and c.partno=''06''),(select SUM(b.'+@lists+') from salaward a left join salawards b on a.noa = b.noa left join sss c on b.sssno = c.noa where a.year='''+@t_year+''' and a.typea=''年終'' and c.partno=''07'') 
,(select SUM(b.'+@lists+') from salaward a left join salawards b on a.noa = b.noa left join sss c on b.sssno = c.noa where a.year='''+@t_year+''' and a.typea=''年終'' and c.partno=''08''),(select SUM(b.'+@lists+') from salaward a left join salawards b on a.noa = b.noa left join sss c on b.sssno = c.noa where a.year='''+@t_year+''' and a.typea=''年終'' and c.partno=''09''),(select SUM(b.'+@lists+') from salaward a left join salawards b on a.noa = b.noa left join sss c on b.sssno = c.noa where a.year='''+@t_year+''' and a.typea=''年終'' and c.partno=''0911'' and c.job=''福利金''),(select SUM(b.'+@lists+') from salaward a left join salawards b on a.noa = b.noa left join sss c on b.sssno = c.noa where a.year='''+@t_year+''' and a.typea=''年終'' and c.partno=''0910'' and c.job=''租金''),(select SUM(b.'+@lists+') from salaward a left join salawards b on a.noa = b.noa left join sss c on b.sssno = c.noa where a.year='''+@t_year+''' and a.typea=''年終'' and c.partno=''0910'' and c.job=''特支''))' 
EXECUTE sp_executesql @cmd 
fetch next from cursor_table 
into @namea,@lists 
end 
close cursor_table 
deallocate cursor_table 

select gno,namea, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a),1)),4,12)) a, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,b),1)),4,12)) b, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,c),1)),4,12)) c, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,d),1)),4,12)) d, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,e),1)),4,12)) e, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,f),1)),4,12)) f, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,g),1)),4,12)) g, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,h),1)),4,12)) h, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,i),1)),4,12)) i, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,j),1)),4,12)) j, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,k),1)),4,12)) k, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,l),1)),4,12)) l, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a,0)+isnull(b,0)+isnull(c,0)+isnull(d,0)+isnull(e,0)+isnull(f,0)+isnull(g,0)+isnull(h,0)+isnull(i,0)+isnull(j,0)+isnull(k,0)+isnull(l,0)),1)),4,12)) total, 
(select worker from salaward where year = @t_year and typea='年終') worker 
from #tmp 

--刪除暫存資料庫 
IF OBJECT_ID('tempdb..#tmp')is not null 
BEGIN 
drop table #tmp 
END;
-------------------------------------------
z_salaward6:--z_salaward6
declare @year nvarchar(10) 
declare @before_year nvarchar(10) 
declare @t_bsssno nvarchar(20) 
declare @t_esssno nvarchar(20) 

set @year = case when '#non'=[2] then '' else [2] end
set @before_year = CAST(@year as int)-1
set @t_bsssno = case when '#non'=[3] then '' else [3] end
set @t_esssno = case when '#non'=[4] then char(255) else [4] end


------------------------------------------------------今年基本年終資料 
declare @tmp table( 
gno nvarchar(1), 
part nvarchar(50), 
senior nvarchar(20), 
sssno nvarchar(20), 
namea nvarchar(50), 
indate nvarchar(10), 
salary float, 
boa float, 
bot float, 
bos float, 
boo float, 
total float, 
oldmidmon float, 
oldtotal float, 
total6 float, 
total5 float, 
total7 float, 
total8 float, 
first float, 
second float, 
memo2 nvarchar(MAX),
total1 float,
late float,
lea float,
person float,
sick float,
leave float,
marry float,
bere float,
total2 float,
great float,
minor float,
com float,
major float,
pecca float,
repri float,
total3 float,
total4 float,
memo nvarchar(200)
) 
insert into @tmp 
select '0' gno ,b.part,'' senior,b.sssno,b.namea,b.indate 
,b.salary,b.bo_traffic,b.bo_special,b.bo_admin,b.bo_oth,b.money as total,b.oldmidmon,b.oldaward 
,b.total6,b.total5,b.total7,b.total8,b.firstmoney,b.secondmoney,b.memo2,b.total1,b.late,b.leaveearly,b.person,
b.sick,b.leave,b.marriageleave,b.bereavementleave,b.total2,b.greatmeriy,b.minormerits,b.commend,b.majordemerits,
b.peccadillo,b.reprimand,b.total3,b.total4,b.memo
from salaward a left join salawards b on a.noa=b.noa 
where (a.year = @year) and (typea='年終') and (b.sssno between @t_bsssno and @t_esssno) 

------------------------------------------------------------------------------------------ 
--年資 
update @tmp 
set senior = ( 
case when (CAST(left(indate,3) as int)=0) then '未滿一月' else ( 
case when (@year-CAST(left(indate,3) as int)) >0 then cast((@year-CAST(left(indate,3) as int)) as nvarchar) + ' 年 ' else '' end + 
case when (12-CAST(right(left(indate,6),2) as int)) >0 then cast((12-CAST(right(left(indate,6),2) as int)) as nvarchar) + ' 月' else '' end ) 
end) 
------------------------------------------------------------------------------------------- 

--插入總計 
insert into @tmp 
select '1' gno ,'','','','','' 
,sum(salary),sum(bot),sum(bos),sum(boa),sum(boo),sum(total),sum(oldmidmon) 
,sum(oldtotal),sum(total6),sum(total5),sum(total7),sum(total8),sum(first),sum(second),'',0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,'' 
from @tmp where gno='0' 


------------------------------------- 
select gno,part,senior,namea, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,salary),1)),4,12)) salary, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bot),1)),4,12)) bot, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bos),1)),4,12)) bos, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,boa),1)),4,12)) boa, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,boo),1)),4,12)) boo, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,oldmidmon),1)),4,12)) oldmidmon, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,oldtotal),1)),4,12)) total9, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total6),1)),4,12)) total6, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total5),1)),4,12)) total5, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total7),1)),4,12)) total7, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total8),1)),4,12)) total8, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,first),1)),4,12)) first, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,second),1)),4,12)) second, 
memo2,total1,late,lea lea1,person,sick,leave lea2,marry,bere,total2,great,minor,com,major,pecca,repri,total3,total4,memo
,(select worker from salaward where (year = @year) and (typea = '年終'))worker 
from @tmp ;


 