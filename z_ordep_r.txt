z_vccp_r01:--z_vccp_r01
SET QUOTED_IDENTIFIER OFF 
declare @t_noa nvarchar(100)
set @t_noa=case when '#non' ='E20160427001'  then '' else 'E20160427001' end
--***********************************************************************************
declare @tmp table(
	gno nvarchar(10),
	idno int identity(0,1),
	page int,
	pageno int,
	noa nvarchar(30),
	noq nvarchar(30),
	custorde nvarchar(50),
	custno nvarchar(30),
	comp nvarchar(200),
	conn nvarchar(50),
	addr nvarchar(Max),
	contract nvarchar(50),
	tel nvarchar(50),
	fax nvarchar(50),
	odate nvarchar(20),
	datea nvarchar(20),
	payment nvarchar(MAX),
	shipment nvarchar(MAX),
	terms nvarchar(50),
	memo nvarchar(MAX),
	coin nvarchar(20),
	ftddate nvarchar(10),
		
	pno nvarchar(30),
	product nvarchar(MAX),
	spec nvarchar(max),
	custpno nvarchar(50),
	ucano nvarchar(50),
	pctn float,
	nw float,
	gw float,
	cuft float,
	cbm float,
	ctn float,
	needadd float,
	sdate nvarchar(10),
	smount float,
	
	
	scoin nvarchar(50),
	aprice float,
	amount float,
	atotal float,
	mount float,
	unit nvarchar(30),
	price float,
	total float,
	
	tnw float,
	tgw float,
	tcuft float,
	tcbm float,
	tctn float,
	
	main nvarchar(MAX),
	side nvarchar(MAX),
	etotal nvarchar(max),
	ectn nvarchar(max)
	
)

declare @noa nvarchar(50)
declare @noq nvarchar(50)
declare @pageline int = 44--每頁幾行
declare @page int=1 --頁數
declare @pagecount int=1 --目前行數
declare @tdatecount int=isnull((select count(*) from view_vccs where ordeno=@t_noa),0) --報價資料數
declare @datecount int=0 --目前已插入報價資料數

--表頭
insert @tmp (gno,noa,page,pageno,custorde,custno,comp,addr,conn,tel,fax,datea,payment,shipment,terms,ftddate,coin)
select '1',a.noa,@page,@pagecount,b.custorde,a.custno,a.comp,a.addr,c.conn,a.tel,a.fax,a.datea,a.paytype
		,a.trantype
		+case when ISNULL(bdock,'')!='' then ' From:'+bdock else '' end
		+case when ISNULL(edock,'')!='' then ' To:'+edock else '' end
		,b.payterms,d.etd,case when isnull(a.coin,'')='' then 'NT' else a.coin end+'$'
from view_vcc a
outer apply (select * from view_orde where noa=a.ordeno)b
outer apply (select * from view_ordei where noa=a.ordeno)c
outer apply (select * from invo where noa=a.invono)d
where a.ordeno=@t_noa

set @pagecount=@pagecount+15

declare cursor_table cursor for
select noa,noq from view_vccs where ordeno=@t_noa order by noa,noq
open cursor_table
fetch next from cursor_table
into @noa,@noq
while(@@FETCH_STATUS <> -1)
begin
	 set @datecount=@datecount+1
	 
	 insert @tmp
	 select '0',@page,@pagecount,a.noa,e.noq,b.custorde,a.custno,a.comp,c.conn,a.addr,b.contract,a.tel,a.fax
			,b.odate,a.datea,a.paytype,
			a.trantype
			+case when ISNULL(bdock,'')!='' then ' From:'+bdock else '' end
			+case when ISNULL(edock,'')!='' then ' To:'+edock else '' end
			,b.payterms,a.memo,case when isnull(a.coin,'')='' then 'NT' else a.coin end+'$'
			,d.etd
			,e.productno,e.product,e.spec,(select productno from ucccust where custno=a.custno and noa=e.productno)
			,(select case when ucano!='' then ucano else uccno end from ucx where noa=e.productno)
			,f.inmount*f.outmount,f.weight,f.gweight,f.cuft,f.cbm
			,case when isnull(f.inmount,0)*isnull(f.outmount,0)=0 then 1 else ceiling(e.mount/(f.inmount*f.outmount)) end
			,(e.mount-floor (e.mount/f.inmount*f.outmount)*(f.inmount*f.outmount))
			,d.etd,h.quantity
			,':'+case when isnull(a.coin,'')='' then 'NT' else a.coin end+'$'
			,e.price,e.mount,isnull(e.price,0)*isnull(e.mount,0),0,e.unit,isnull(a.floata,'')*e.price,a.total
			,e.mount*f.uweight
			,f.gweight*floor (e.mount/f.inmount*f.outmount)--整箱
			+(e.mount-floor (e.mount/f.inmount*f.outmount)*f.inmount*f.outmount)*f.uweight--散裝淨重
			+case when (b.mount-(floor(b.mount/(f.inmount*f.outmount))*(f.inmount*f.outmount)))>0 then f.outweight else 0 end --外包裝重
			+case when (b.mount-(floor(b.mount/(f.inmount*f.outmount))*(f.inmount*f.outmount)))>0 then ceiling((e.mount-(floor(e.mount/(f.inmount*f.outmount))*(f.inmount*f.outmount)))/f.inmount)*f.inweight else 0 end tgw --內包裝重
			,f.cuft*case when isnull(f.inmount,0)*isnull(f.outmount,0)=0 then 1 else ceiling(e.mount/(f.inmount*f.outmount)) end
			,f.cbm*case when isnull(f.inmount,0)*isnull(f.outmount,0)=0 then 1 else ceiling(e.mount/(f.inmount*f.outmount)) end
			,case when isnull(f.inmount,0)*isnull(f.outmount,0)=0 then 1 else ceiling(e.mount/(f.inmount*f.outmount)) end
			,Replace(Replace(Replace(c.main,'chr(10)','</BR>'),'　','&nbsp&nbsp'),'~#$','''')
			,Replace(Replace(Replace(c.side,'chr(10)','</BR>'),'　','&nbsp&nbsp'),'~#$','''')
			,'',''
			
	from view_vcc a 
		outer apply (select * from view_orde where noa=a.ordeno)b
		outer apply (select * from view_ordei where noa=a.ordeno)c
		outer apply (select * from invo where noa=a.invo)d
		outer apply (select * from view_vccs where noa=a.noa)e
		outer apply (select * from pack2s where noa=e.productno)f
		outer apply (select * from invos where noa=d.noa and productno=e.productno)h
	where a.noa=@noa and e.noq=@noq
	
	set @pagecount=@pagecount+11 --一個品項暫11行
	
	if(@tdatecount>1 and @tdatecount!=@datecount and @datecount%4=0)--資料筆數2以上 且 單行筆數
	begin
				--差入空白頁
		while (@pagecount%@pageline!=0 and @pagecount<40)
		begin
			insert @tmp (gno,page,pageno,noa)
			select '2',@page,@pagecount,@noa
			
			set @pagecount=@pagecount+1
		end
				
		--插入分頁
		insert @tmp (gno,page,pageno,noa)
		select '3',@page,@pagecount,@noa
		
		set @pagecount=1
		set @page=@page+1
		
		
		--插入第二頁以上的 抬頭
		insert @tmp (gno,noa,page,pageno,custorde,custno,comp,addr,conn,tel,fax,datea,payment,shipment,terms,ftddate,coin)
		select '4',a.noa,@page,@pagecount,b.custorde,a.custno,a.comp,a.addr,c.conn,a.tel,a.fax,a.datea,a.paytype
				,a.trantype
				+case when ISNULL(bdock,'')!='' then ' From:'+bdock else '' end
				+case when ISNULL(edock,'')!='' then ' To:'+edock else '' end
				,b.payterms,d.etd,case when isnull(a.coin,'')='' then 'NT' else a.coin end+'$'
		from view_vcc a
		outer apply (select * from view_orde where noa=a.ordeno)b
		outer apply (select * from view_ordei where noa=a.ordeno)c
		outer apply (select * from invo where noa=a.invono)d
		where a.ordeno=@t_noa
		
		set @pagecount=@pagecount+3
	end
	else if (@tdatecount=@datecount) --最後一筆
	begin
		update a
		set total=isnull((select SUM(round(atotal,0)) from @tmp where noa=a.noa),0)
		from @tmp a

		if(@pagecount>40) --換頁
		begin
			--差入空白頁
			while (@pagecount%@pageline!=0)
			begin
				insert @tmp (gno,page,pageno,noa)
				select '2',@page,@pagecount,@noa
				
				set @pagecount=@pagecount+1
			end
			
			--插入分頁
			insert @tmp (gno,page,pageno,noa)
			select '3',@page,@pagecount,@noa
			
			set @pagecount=1
			set @page=@page+1
			
			--插入第二頁以上的 抬頭
			insert @tmp (gno,noa,page,pageno,custorde,custno,comp,addr,conn,tel,fax,datea,payment,shipment,terms,ftddate,coin)
			select '4',a.noa,@page,@pagecount,b.custorde,a.custno,a.comp,a.addr,c.conn,a.tel,a.fax,a.datea,a.paytype
					,a.trantype
					+case when ISNULL(bdock,'')!='' then ' From:'+bdock else '' end
					+case when ISNULL(edock,'')!='' then ' To:'+edock else '' end
					,b.payterms,d.etd,case when isnull(a.coin,'')='' then 'NT' else a.coin end+'$'
			from view_vcc a
			outer apply (select * from view_orde where noa=a.ordeno)b
			outer apply (select * from view_ordei where noa=a.ordeno)c
			outer apply (select * from invo where noa=a.invono)d
			where a.noa=@t_noa
			set @pagecount=@pagecount+3
		end
		--合計
		insert into @tmp(gno,page,pageno,noa,noq,mount,unit,coin,total)
		select '5',@page,@pagecount,noa,CHAR(255),mount,MAX(unit),coin,total
		from @tmp where gno='0' group by noa,mount,coin,total
		set @pagecount=@pagecount+1
		

		--合計(英文大寫)
		insert into @tmp(gno,page,pageno,noa,etotal)
		select '6',@page,@pagecount,noa,('SAY TOTAL U.S DOLLAR '+UPPER(dbo.currencyToEnglish(total))) 
		from @tmp where gno='0' group by noa,total
		set @pagecount=@pagecount+1
		
		--合計(英文大寫)
		insert into @tmp(gno,page,pageno,noa,ectn)
		select '7',@page,@pagecount,noa,''--'SAY TOTAL '+UPPER(dbo.currencyToEnglish(tctn))+'CARTONS'
		from @tmp where gno='0' group by noa
		set @pagecount=@pagecount+1
		
		--MARK
		insert into @tmp(gno,page,pageno,noa,main,side)
		select '8',@page,@pagecount,noa,main,side
		from @tmp where gno='0' 
		group by noa,main,side
		
		set @pagecount=@pagecount+10
		
		--插入空白行
		while ((@pagecount+5+1)%@pageline!=0 and @pagecount<47) --5簽名+1行結束
		begin
			insert @tmp (gno,page,pageno,noa)
			select '2',@page,@pagecount,@noa
				
			set @pagecount=@pagecount+1
		end
		
		--簽名
		insert into @tmp(gno,noa,page,pageno,comp,main,side)
		select '9',noa,@page,@pagecount,comp,main,side from @tmp where gno='0'
		group by noa,comp,main,side
			
		--結束
		insert into @tmp(gno,noa,page,pageno)
		select '10',noa,@page,@pagecount from @tmp where gno='0'
		group by noa,comp
		
		set @pagecount=1
		set @page=@page+1
	
		
	
	end
	
			
	fetch next from cursor_table
	into @noa,@noq
	 
end
close cursor_table
deallocate cursor_table

update a 
set mount =(select sum(amount) from @tmp where noa=a.noa and gno='0')
,tnw=(select sum(tnw) from @tmp where noa=a.noa and gno='0')
,tgw=(select sum(tgw) from @tmp where noa=a.noa and gno='0')
,tcuft=(select sum(tcuft) from @tmp where noa=a.noa and gno='0')
,tcbm=(select sum(tcbm) from @tmp where noa=a.noa and gno='0')
,tctn =(select sum(tctn) from @tmp where noa=a.noa and gno='0')
from @tmp a
where gno='5' or gno='7'

update a 
set ectn =('SAY TOTAL '+UPPER(dbo.currencyToEnglish(tctn))+'CARTONS') 
from @tmp a where gno='7'

update a 
set ectn =('SAY TOTAL '+UPPER(dbo.currencyToEnglish(tctn))+'CARTONS') 
from @tmp a where gno='7'

select
dbo.getComma(amount,0)amount,
dbo.getComma(mount,0) mount,
dbo.getComma(aprice,3)aprice,
dbo.getComma(atotal,3)atotal,
dbo.getComma(price,2)price,
dbo.getComma(total,2)total,
dbo.getComma(isnull(pctn,0),0)pctn,
dbo.getComma(isnull(nw,0),3)nw,
dbo.getComma(isnull(gw,0),3)gw,
dbo.getComma(isnull(cuft,0),2)cuft,
dbo.getComma(isnull(cbm,0),2)cbm,
dbo.getComma(isnull(ctn,0),0)ctn,
dbo.getComma(isnull(tnw,0),3)tnw,
dbo.getComma(isnull(tgw,0),3)tgw,
dbo.getComma(isnull(tcuft,0),2)tcuft,
dbo.getComma(isnull(tcbm,0),2)tcbm,
dbo.getComma(isnull(tctn,0),0)tctn,
case when needadd>0 then '(Need To Add '+dbo.getComma(needadd,-1)+' '+case when len(unit)=0 then 'Pcs' else unit end+')' else '' end needadd,
* from @tmp a order by idno
;