z_tran_sh1:--z_tran_sh1
declare @t_bdate nvarchar(20) = case when '#non'=[2] then '' else [2] end
declare @t_edate nvarchar(20) = case when '#non'=[3] then char(255) else [3] end
declare @t_bcustno nvarchar(20) = case when '#non'=[6] then '' else [6] end
declare @t_ecustno nvarchar(20) = case when '#non'=[7] then char(255) else [7] end
declare @t_baddr1 nvarchar(20) = case when '#non'=[8] then '' else [8] end 
declare @t_eaddr1 nvarchar(20) = case when '#non'=[9] then char(255) else [9] end
declare @t_baddr2 nvarchar(20) = case when '#non'=[10] then '' else [10] end 
declare @t_eaddr2 nvarchar(20) = case when '#non'=[11] then char(255) else [11] end
declare @t_bdriver nvarchar(20) = case when '#non'=[12] then '' else [12] end
declare @t_edriver nvarchar(20) = case when '#non'=[13] then char(255) else [13] end
declare @t_chk1 nvarchar(20) = case when '#non'=[14] then '' else [14] end
declare @t_chk2 nvarchar(20) = case when '#non'=[15] then '' else [15] end

declare @tmp table( 
	gno nvarchar(10), 
	rr int, 
	datea nvarchar(10), 
	custno nvarchar(50), 
	cust nvarchar(100), 
	mount nvarchar(50),  
	volume nvarchar(50), 
	addrno nvarchar(50), 
	addr nvarchar(100), 
	addrno2 nvarchar(50), 
	addr2 nvarchar(100), 
	total float, 
	driverno1 nvarchar(50), 
	driver1 nvarchar(50), 
	driverno2 nvarchar(50), 
	driver2 nvarchar(50), 
	driverno3 nvarchar(50), 
	driver3 nvarchar(50), 
	chk1 nvarchar(50), 
	chk2 nvarchar(50), 
	memo nvarchar(max), 
	total1 float, 
	total2 float, 
	total3 float,
	productno nvarchar(50),
	product nvarchar(50),
	tranno nvarchar(50),
	productno2 nvarchar(50),
	unit nvarchar(50)
) 
insert @tmp 
select '1',ROW_NUMBER()over(partition by time1,custno,productno,tranno,productno2,addrno,addrno2,mount,volume,unit order by time1,noa,noq)
,time1,custno,cust,mount,volume,addrno,addr,addrno2,addr2,total,driverno,driver,'','','',''
,case when chk1=1 then 'V' else '' end ,case when chk2=1 then 'V' else '' end,memo,total2,'','',
productno,product,tranno,productno2,unit
from view_tranvcces 
where (time1 between @t_bdate and @t_edate) 
and (custno between @t_bcustno and @t_ecustno) 
and ((addrno between @t_baddr1 and @t_eaddr1) or (addr between @t_baddr1 and @t_eaddr1))
and ((addrno2 between @t_baddr2 and @t_eaddr2) or (addr2 between @t_baddr2 and @t_eaddr2))
and (driverno between @t_bdriver and @t_edriver) 
and (len(@t_chk1)=0 or chk1=@t_chk1) 
and (len(@t_chk2)=0 or chk1=@t_chk2)
order by time1,noa,noq 

update @tmp 
set driverno2=b.driverno1,driver2=b.driver1,total2=b.total1 
from @tmp a 
outer apply(select * from @tmp where a.datea=datea and custno=a.custno and mount=a.mount and unit=a.unit and volume=a.volume and a.addrno=addrno and a.addrno2=addrno2 and a.productno=productno and a.tranno=tranno and a.productno2=productno2 and rr='2')b 

update @tmp 
set driverno3=b.driverno1,driver3=b.driver1,total3=b.total1 
from @tmp a 
outer apply(select * from @tmp where a.datea=datea and custno=a.custno and mount=a.mount and unit=a.unit and volume=a.volume and a.addrno=addrno and a.addrno2=addrno2 and a.productno=productno and a.tranno=tranno and a.productno2=productno2 and rr='3')b 

delete @tmp where rr!='1'

update a
set rr=rx
from (select ROW_NUMBER()over(partition by gno order by datea,custno)rx,rr from @tmp)a

select 
mount+unit mount
,* from @tmp 
order by datea,custno
;
--------------------------------------------------------------------------------------------------------
z_tran_sh2:--z_tran_sh2
declare @t_bdate nvarchar(20) = case when '#non'=[2] then '' else [2] end
declare @t_edate nvarchar(20) = case when '#non'=[3] then char(255) else [3] end
declare @t_bcustno nvarchar(20) = case when '#non'=[6] then '' else [6] end
declare @t_ecustno nvarchar(20) = case when '#non'=[7] then char(255) else [7] end
declare @t_baddr1 nvarchar(20) = case when '#non'=[8] then '' else [8] end 
declare @t_eaddr1 nvarchar(20) = case when '#non'=[9] then char(255) else [9] end
declare @t_baddr2 nvarchar(20) = case when '#non'=[10] then '' else [10] end 
declare @t_eaddr2 nvarchar(20) = case when '#non'=[11] then char(255) else [11] end
declare @t_bdriver nvarchar(20) = case when '#non'=[12] then '' else [12] end
declare @t_edriver nvarchar(20) = case when '#non'=[13] then char(255) else [13] end
declare @t_chk1 nvarchar(20) = case when '#non'=[14] then '' else [14] end
declare @t_chk2 nvarchar(20) = case when '#non'=[15] then '' else [15] end

declare @tmp table( 
	gno nvarchar(10), 
	custno nvarchar(50),
	cust nvarchar(50),							
	tel nvarchar(50),	
	datea nvarchar(10),
	productno nvarchar(50),						
	product nvarchar(50),
	mount float,
	volume float,
	addrno nvarchar(50), 
	addr nvarchar(50),
	addrno2 nvarchar(50),
	addr2 nvarchar(50),
	tranno nvarchar(50),
	productno2 nvarchar(50),
	total float,
	memo nvarchar(max),
	addrno3 nvarchar(50),
	addr3 nvarchar(50),
	te12 nvarchar(50),
	address nvarchar(max),							
	worker nvarchar(50),
	driverno nvarchar(50),
	driver nvarchar(200)
) 
insert @tmp 
select '0',custno,cust,c.tel,time1,productno,product,mount,volume,a.addrno,a.addr,addrno2
,addr2,tranno,productno2,total,a.memo,isnull(addrno3,''),addr3,d.tel,d.addr_comp,b.worker,driverno,driver
from view_tranvcces a
left join view_tranvcce b on a.noa=b.noa
left join cust c on a.custno=c.noa
left join cust d on a.addrno3=d.noa
where (time1 between @t_bdate and @t_edate) 
and (custno between @t_bcustno and @t_ecustno) 
and ((a.addrno between @t_baddr1 and @t_eaddr1) or (a.addr between @t_baddr1 and @t_eaddr1))
and ((addrno2 between @t_baddr2 and @t_eaddr2) or (addr2 between @t_baddr2 and @t_eaddr2))
and (driverno between @t_bdriver and @t_edriver)

insert @tmp(gno,custno,datea,addrno3,te12,address,driverno,worker,driver)
select '1',custno,datea,addrno3,te12,address,driverno,worker,driver
from @tmp
group by custno,datea,addrno3,te12,address,driverno,worker,driver

insert @tmp(gno,custno,datea,addrno3,driverno,worker,driver)
select '2',custno,datea,addrno3,driverno,worker,driver
from @tmp
group by custno,datea,addrno3,driverno,worker,driver

select 
* from @tmp
order by custno,datea,addrno3,driverno,gno
;
--------------------------------------------------------------------------------------------------
z_tran_sh3:--z_tran_sh3
declare @t_bdate nvarchar(20) = case when '#non'=[2] then '' else [2] end
declare @t_edate nvarchar(20) = case when '#non'=[3] then char(255) else [3] end
declare @t_bcustno nvarchar(20) = case when '#non'=[6] then '' else [6] end
declare @t_ecustno nvarchar(20) = case when '#non'=[7] then char(255) else [7] end
declare @t_baddr1 nvarchar(20) = case when '#non'=[8] then '' else [8] end 
declare @t_eaddr1 nvarchar(20) = case when '#non'=[9] then char(255) else [9] end
declare @t_baddr2 nvarchar(20) = case when '#non'=[10] then '' else [10] end 
declare @t_eaddr2 nvarchar(20) = case when '#non'=[11] then char(255) else [11] end
declare @t_bdriver nvarchar(20) = case when '#non'=[12] then '' else [12] end
declare @t_edriver nvarchar(20) = case when '#non'=[13] then char(255) else [13] end
declare @t_chk1 nvarchar(20) = case when '#non'=[14] then '' else [14] end
declare @t_chk2 nvarchar(20) = case when '#non'=[15] then '' else [15] end

declare @tmp table( 
	gno nvarchar(1),
	custno nvarchar(50),
	comp nvarchar(50),
	serial nvarchar(50),
	addr nvarchar(max),
	tel nvarchar(50),
	fax nvarchar(50),
	datea nvarchar(10),
	mount float,
	unit nvarchar(20),
	volume float,
	straddrno nvarchar(50),
	straddr nvarchar(50),
	endaddrno nvarchar(50),
	endaddr nvarchar(50),
	total float,
	money float,
	money2 float,
	memo nvarchar(max),
	tax float,
	total2 float
)
insert @tmp
select '0',isnull(custno,''),b.comp,b.serial,b.addr_invo,b.tel,b.fax,trandate,sum(isnull(mount,0)),a.unit,sum(isnull(volume,0))
,straddrno,straddr,endaddrno,endaddr,sum(isnull(total,0)),'','',a.memo,'',''
from view_trans a
left join cust b on a.custno=b.noa
where (trandate between @t_bdate and @t_edate)
and len(caseno)=0 and ISNULL(total,0)!=0
and(custno between @t_bcustno and @t_ecustno)
group by custno,b.comp,b.serial,b.addr_invo,b.tel,b.fax,trandate,a.unit,straddrno,straddr,endaddrno,endaddr,a.memo

insert @tmp(gno,custno,datea,total,tax,total2)
select '1',custno,CHAR(255),SUM(total),SUM(total)*0.05,SUM(total)*1.05
from @tmp
group by custno

insert @tmp(gno,custno,datea)
select '2',custno,CHAR(255)
from @tmp
group by custno

select 
@t_bdate bdate,@t_edate edate
,dbo.getComma(total,0)total
,dbo.getComma(money,0)money
,dbo.getComma(money2,0)money2
,dbo.getComma(tax,0)tax
,dbo.getComma(total2,0)total2
,* from @tmp
order by custno,datea,gno
;
--------------------------------------------------------------------------------------------------
z_tran_sh4:--z_tran_sh4
declare @t_bdate nvarchar(20) = case when '#non'=[2] then '' else [2] end
declare @t_edate nvarchar(20) = case when '#non'=[3] then char(255) else [3] end
declare @t_bcustno nvarchar(20) = case when '#non'=[6] then '' else [6] end
declare @t_ecustno nvarchar(20) = case when '#non'=[7] then char(255) else [7] end
declare @t_baddr1 nvarchar(20) = case when '#non'=[8] then '' else [8] end 
declare @t_eaddr1 nvarchar(20) = case when '#non'=[9] then char(255) else [9] end
declare @t_baddr2 nvarchar(20) = case when '#non'=[10] then '' else [10] end 
declare @t_eaddr2 nvarchar(20) = case when '#non'=[11] then char(255) else [11] end
declare @t_bdriver nvarchar(20) = case when '#non'=[12] then '' else [12] end
declare @t_edriver nvarchar(20) = case when '#non'=[13] then char(255) else [13] end
declare @t_chk1 nvarchar(20) = case when '#non'=[14] then '' else [14] end
declare @t_chk2 nvarchar(20) = case when '#non'=[15] then '' else [15] end

declare @tmp table( 
	gno nvarchar(1),
	custno nvarchar(50),
	comp nvarchar(50),
	serial nvarchar(50),
	addr nvarchar(max),
	tel nvarchar(50),
	fax nvarchar(50),
	datea nvarchar(10),
	product nvarchar(50),
	caseno nvarchar(50),
	straddrno nvarchar(50),
	straddr nvarchar(50),
	endaddrno nvarchar(50),
	endaddr nvarchar(50),
	total float,
	money float,
	money2 float,
	memo nvarchar(max),
	tax float,
	total2 float
)
insert @tmp
select '0',isnull(custno,''),b.comp,b.serial,b.addr_invo,b.tel,b.fax,trandate
,product,caseno
,straddrno,straddr,endaddrno,endaddr,sum(isnull(total,0)),'','',a.memo,'',''
from view_trans a
left join cust b on a.custno=b.noa
where (trandate between @t_bdate and @t_edate)
and len(caseno)!=0 and ISNULL(total,0)!=0
and(custno between @t_bcustno and @t_ecustno)
group by custno,b.comp,b.serial,b.addr_invo,b.tel,b.fax,trandate,a.unit,straddrno,straddr,endaddrno,endaddr,a.memo,product,caseno

insert @tmp(gno,custno,datea,total,tax,total2)
select '1',custno,CHAR(255),SUM(total),SUM(total)*0.05,SUM(total)*1.05
from @tmp
group by custno

insert @tmp(gno,custno,datea)
select '2',custno,CHAR(255)
from @tmp
group by custno

select 
@t_bdate bdate,@t_edate edate
,dbo.getComma(total,0)total
,dbo.getComma(money,0)money
,dbo.getComma(money2,0)money2
,dbo.getComma(tax,0)tax
,dbo.getComma(total2,0)total2
,* from @tmp
order by custno,datea,gno
;
--------------------------------------------------------------------------------------------------
z_tran_sh5:--z_tran_sh5
declare @t_bdate nvarchar(20) = case when '#non'=[2] then '' else [2] end
declare @t_edate nvarchar(20) = case when '#non'=[3] then char(255) else [3] end
declare @t_bcustno nvarchar(20) = case when '#non'=[6] then '' else [6] end
declare @t_ecustno nvarchar(20) = case when '#non'=[7] then char(255) else [7] end
declare @t_baddr1 nvarchar(20) = case when '#non'=[8] then '' else [8] end 
declare @t_eaddr1 nvarchar(20) = case when '#non'=[9] then char(255) else [9] end
declare @t_baddr2 nvarchar(20) = case when '#non'=[10] then '' else [10] end 
declare @t_eaddr2 nvarchar(20) = case when '#non'=[11] then char(255) else [11] end
declare @t_bdriver nvarchar(20) = case when '#non'=[12] then '' else [12] end
declare @t_edriver nvarchar(20) = case when '#non'=[13] then char(255) else [13] end
declare @t_chk1 nvarchar(20) = case when '#non'=[14] then '' else [14] end
declare @t_chk2 nvarchar(20) = case when '#non'=[15] then '' else [15] end

declare @tmp table( 
	gno nvarchar(1),
	custno nvarchar(50),
	comp nvarchar(50),
	total float
)
insert @tmp
select '0',isnull(custno,''),b.comp,sum(isnull(total,0))
from view_trans a
left join cust b on a.custno=b.noa
where (trandate between @t_bdate and @t_edate)
and(custno between @t_bcustno and @t_ecustno)
group by custno,b.comp

insert @tmp(gno,total)
select '1',SUM(total)
from @tmp

select 
@t_bdate bdate,@t_edate edate
,dbo.getComma(total,0)total
,* from @tmp
order by gno,custno
;
--------------------------------------------------------------------------------------------------
z_tran_sh6:--z_tran_sh6
declare @t_bdate nvarchar(20) = case when '#non'=[2] then '' else [2] end
declare @t_edate nvarchar(20) = case when '#non'=[3] then char(255) else [3] end
declare @t_bcustno nvarchar(20) = case when '#non'=[6] then '' else [6] end
declare @t_ecustno nvarchar(20) = case when '#non'=[7] then char(255) else [7] end
declare @t_baddr1 nvarchar(20) = case when '#non'=[8] then '' else [8] end 
declare @t_eaddr1 nvarchar(20) = case when '#non'=[9] then char(255) else [9] end
declare @t_baddr2 nvarchar(20) = case when '#non'=[10] then '' else [10] end 
declare @t_eaddr2 nvarchar(20) = case when '#non'=[11] then char(255) else [11] end
declare @t_bdriver nvarchar(20) = case when '#non'=[12] then '' else [12] end
declare @t_edriver nvarchar(20) = case when '#non'=[13] then char(255) else [13] end
declare @t_chk1 nvarchar(20) = case when '#non'=[14] then '' else [14] end
declare @t_chk2 nvarchar(20) = case when '#non'=[15] then '' else [15] end 

declare @tmp table( 
	gno nvarchar(1),
	noa nvarchar(50),
	comp nvarchar(50),
	zip nvarchar(50),
	addr nvarchar(max),
	boss nvarchar(50),	
	tel nvarchar(50)
)
insert @tmp
select '1',noa,comp,zip_comp,addr_comp,boss,tel
from cust
where (noa between @t_bcustno and @t_ecustno)

select * from @tmp
order by noa
;
--------------------------------------------------------------------------------------------------
z_tran_sh7:--z_tran_sh7
declare @t_bdate nvarchar(20) = case when '#non'=[2] then '' else [2] end
declare @t_edate nvarchar(20) = case when '#non'=[3] then char(255) else [3] end
declare @t_bcustno nvarchar(20) = case when '#non'=[6] then '' else [6] end
declare @t_ecustno nvarchar(20) = case when '#non'=[7] then char(255) else [7] end
declare @t_baddr1 nvarchar(20) = case when '#non'=[8] then '' else [8] end 
declare @t_eaddr1 nvarchar(20) = case when '#non'=[9] then char(255) else [9] end
declare @t_baddr2 nvarchar(20) = case when '#non'=[10] then '' else [10] end 
declare @t_eaddr2 nvarchar(20) = case when '#non'=[11] then char(255) else [11] end
declare @t_bdriver nvarchar(20) = case when '#non'=[12] then '' else [12] end
declare @t_edriver nvarchar(20) = case when '#non'=[13] then char(255) else [13] end
declare @t_chk1 nvarchar(20) = case when '#non'=[14] then '' else [14] end
declare @t_chk2 nvarchar(20) = case when '#non'=[15] then '' else [15] end

declare @tmp table(
	gno nvarchar(1),
	dno nvarchar(50),
	driver nvarchar(50),
	datea nvarchar(10),
	custno nvarchar(50),
	nick nvarchar(50),
	productno nvarchar(50),
	product nvarchar(50),
	mount float,
	unit nvarchar(50),
	volume float,
	caseno nvarchar(50),
	po nvarchar(50),
	straddrno nvarchar(50),
	straddr nvarchar(50),
	endaddrno nvarchar(50),
	endaddr nvarchar(50),
	total2 float,
	money float,
	money2 float,
	memo nvarchar(max),
	money3 float,
	tax float,
	fee float,
	borrow float,
	bill float,
	rest float,
	total float
)
insert @tmp
select '0',a.driverno,a.driver,a.trandate,custno,nick,uccno,a.product,a.mount,a.unit,a.volume,a.caseno,po,straddrno,a.straddr,endaddrno
,a.endaddr,total2,'','',a.memo,'','','','','','',''
from view_trans a
left join view_tres b on a.noa=b.tranno and a.noq=b.trannoq
left join view_tre c on b.noa=c.noa
where (a.trandate between @t_bdate and @t_edate)
and (a.driverno between @t_bdriver and @t_edriver) 

insert @tmp(gno,dno,driver,datea,total2,money,money2,money3)
select '1',dno,driver,CHAR(255),SUM(total2),SUM(money),SUM(money2),SUM(total2)-SUM(money)-SUM(money2)
from @tmp a
group by dno,driver

--公費.利息.佣金
update @tmp
set fee=b.fee,bill=b.bill,rest=b.rest
from @tmp a
outer apply(select 
(case when minusitem like '%公費%' or plusitem like '%公費%' then SUM(minusmoney-plusmoney) end) bill, 
(case when minusitem like '%佣金%' or plusitem like '%佣金%' then SUM(minusmoney-plusmoney) end) fee, 
(case when minusitem like '%利息%' or plusitem like '%利息%' then SUM(minusmoney-plusmoney) end) rest 
from carchg where driverno=a.dno and (datea between @t_bdate and @t_edate) group by minusitem,plusitem)b
where gno='1'

--借支 
update @tmp 
set borrow=b.money 
from @tmp a 
outer apply(select sum(sb.money)money from carborr sa left join carborrs sb on sa.noa=sb.noa where driverno=a.dno and (sb.mon between left(@t_bdate,6) and left(@t_edate,6)))b 
where gno='1' 

update @tmp
set tax=money3*0.05,total=money3-money3*0.05-isnull(fee,0)-isnull(borrow,0)-isnull(bill,0)-isnull(rest,0)
from @tmp a
where gno='1'

insert @tmp(gno,dno,driver,datea)
select '2',dno,driver,CHAR(255)
from @tmp a
group by dno,driver

select 
dbo.getComma(mount,0)mount
,dbo.getComma(volume,0)volume
,dbo.getComma(total2,0)total2
,dbo.getComma(money,0)money
,dbo.getComma(money2,0)money2
,dbo.getComma(money3,0)money3
,dbo.getComma(tax,0)tax
,dbo.getComma(fee,0)fee
,dbo.getComma(borrow,0)borrow
,dbo.getComma(bill,0)bill
,dbo.getComma(rest,0)rest
,dbo.getComma(total,0)total
,* from @tmp 
order by dno,datea,gno
;
---------------------------------------------------------------------------------------------------
z_tran_sh8:--z_tran_sh8
declare @t_bdate nvarchar(20) = case when '#non'=[2] then '' else [2] end
declare @t_edate nvarchar(20) = case when '#non'=[3] then char(255) else [3] end
declare @t_bcustno nvarchar(20) = case when '#non'=[6] then '' else [6] end
declare @t_ecustno nvarchar(20) = case when '#non'=[7] then char(255) else [7] end
declare @t_baddr1 nvarchar(20) = case when '#non'=[8] then '' else [8] end 
declare @t_eaddr1 nvarchar(20) = case when '#non'=[9] then char(255) else [9] end
declare @t_baddr2 nvarchar(20) = case when '#non'=[10] then '' else [10] end 
declare @t_eaddr2 nvarchar(20) = case when '#non'=[11] then char(255) else [11] end
declare @t_bdriver nvarchar(20) = case when '#non'=[12] then '' else [12] end
declare @t_edriver nvarchar(20) = case when '#non'=[13] then char(255) else [13] end
declare @t_chk1 nvarchar(20) = case when '#non'=[14] then '' else [14] end
declare @t_chk2 nvarchar(20) = case when '#non'=[15] then '' else [15] end

declare @tmp table( 
	gno nvarchar(1),
	rr int,
	recno int,
	page int,
	dno nvarchar(50), 
	driver nvarchar(50), 
	total float
)
insert @tmp
select '0','','','',driverno,driver,SUM(total2)
from view_trans
where (trandate between @t_bdate and @t_edate)
and (driverno between @t_bdriver and @t_edriver)
group by driverno,driver

update a
set rr=rx,recno=case when rx%44=0 then rx/44-1 else rx/44 end,page=case when rx%88=0 then rx/88-1 else rx/88 end
from (select ROW_NUMBER()over(partition by gno order by dno)rx,rr,recno,page from @tmp)a

update a
set rr=rx
from (select ROW_NUMBER()over(partition by recno order by dno,page)rx,rr from @tmp)a

declare @result table( 
	gno nvarchar(1),
	rr int,
	recno int,
	page int,
	dno nvarchar(50), 
	driver nvarchar(50), 
	total float,
	dno2 nvarchar(50), 
	driver2 nvarchar(50), 
	total2 float
)
insert @result
select '0',rr,recno,page,dno,driver,total,'','',''
from @tmp
where recno%2=0

update @result
set dno2=b.dno,driver2=b.driver,total2=b.total
from @result a
outer apply(select * from @tmp where a.page=page and a.rr=rr and recno%2=1)b

insert @result(gno,rr,recno,page,driver2,total2)
select '1',45,MAX(recno),max(page),'總計:',SUM(isnull(total,0))+SUM(isnull(total2,0))
from @result

insert @result(gno,rr,recno,page)
select '2',MAX(rr)+1,MAX(recno),page
from @result
group by page

select @t_bdate bdate,@t_edate edate
,dbo.getComma(total,0)total
,dbo.getComma(total2,0)total2
,* from @result
order by recno,page,rr,gno
;
---------------------------------------------------------------------------------------------------
z_tran_sh9:--z_tran_sh9
SET QUOTED_IDENTIFIER OFF
declare @cmd nvarchar(max) 
declare @t_accy nvarchar(10) = '[1]' 
declare @t_bdate nvarchar(20) = case when '#non'=[2] then '' else [2] end
declare @t_edate nvarchar(20) = case when '#non'=[3] then char(255) else [3] end
declare @t_bcustno nvarchar(20) = case when '#non'=[6] then '' else [6] end
declare @t_ecustno nvarchar(20) = case when '#non'=[7] then char(255) else [7] end
declare @t_bdriver nvarchar(20) = case when '#non'=[12] then '' else [12] end
declare @t_edriver nvarchar(20) = case when '#non'=[13] then char(255) else [13] end
declare @t_detail nvarchar(max) = case when '#non'=[16] then '' else [16] end

declare @tmpa table(
		sel int identity(1,1)
		,gno nvarchar(20)
		,pno int
		,custno nvarchar(20)
		,total01 float --應收
		,plus01a float --客戶加項(不含暫收代收)
		,minus01a float--客戶減項(不含暫收代收)
		,plus01b float --客戶加項(暫收代收)
		,minus01b float--客戶減項(暫收代收)
		,plus02a float --司機加項(不含暫收代收)
		,minus02a float--司機減項(不含暫收代收)
		,plus02b float --司機加項(暫收代收)
		,minus02b float--司機減項(暫收代收)
		,amount float
		,diff float -- 差額

		-----------------------
		----客戶加減項
		,a_noa nvarchar(20)
		,a_date nvarchar(20)
		,a_item nvarchar(100)
		,a_plus float
		,a_minus float
		----司機加減項
		,b_noa nvarchar(20)
		,b_date nvarchar(20)
		,b_item nvarchar(100)
		,b_plus float
		,b_minus float
)
insert into @tmpa(gno,pno,custno,total01)
select '1',1,custno,SUM(ISNULL(total,0))
from view_trans
where (trandate between @t_bdate and @t_edate)
and (custno between @t_bcustno and @t_ecustno)
and (driverno between @t_bdriver and @t_edriver)
group by custno

-- 客戶加減項
declare @tmpb table(
	sel int identity(1,1)
	,typea nvarchar(20) -- 暫收、代收 另外算
	,custno nvarchar(20)
	,noa nvarchar(20)
	,datea nvarchar(20)
	,acc1 nvarchar(20)
	,acc2 nvarchar(50)
	,plusitem nvarchar(100)
	,plusmoney float
	,minusitem nvarchar(100)
	,minusmoney float
)
insert into @tmpb(typea,custno,noa,datea,acc1,acc2,plusitem,plusmoney,minusitem,minusmoney)
select case LEFT(a.acc1,4) when '1191' then '2' when '1194' then '2' else '1' end   
	,a.custno,a.noa,a.datea,a.acc1,a.acc2,a.plusitem,a.plusmoney,a.minusitem,a.minusmoney	
from custchg a
where a.datea between @t_bdate and @t_edate
and (a.custno  between  @t_bcustno   and  @t_ecustno)

-- 司機加減項     (需判斷公司車、外車)
--當只計算類別只有外車時,就不抓公司車的
declare @tmpc table(
	sel int identity(1,1)
	,typea nvarchar(20) -- 暫收、代收 另外算
	,custno nvarchar(20)
	,noa nvarchar(20)
	,datea nvarchar(20)
	,driverno nvarchar(20)
	,acc1 nvarchar(20)
	,acc2 nvarchar(50)
	,plusitem nvarchar(100)
	,plusmoney float
	,minusitem nvarchar(100)
	,minusmoney float
	,custchgno nvarchar(20)
)
insert into @tmpc(typea,custno,noa,datea,driverno,acc1,acc2,plusitem,plusmoney,minusitem,minusmoney,custchgno)
select case when LEFT(a.acc1,4)='1191' then '2' 
	when LEFT(a.acc1,4)='2191' then '2' 
	when LEFT(a.acc1,4)='2195' then '2' 
	when LEFT(a.acc1,4)='1149' then '2' 
	when LEFT(a.acc1,4)='1194' then '2'
	when a.acc1='1142.3' then '2'
	when a.acc1='6032.16' then '2' 
	when a.minusitemno='03' then '2' 
	when a.minusitemno='35' then '2' 
	else '1' end  
	,a.custno,a.noa,a.datea,a.driverno,a.acc1,a.acc2,a.plusitem,a.plusmoney,a.minusitem,a.minusmoney
	,isnull(a.custchgno,'')	
from carchg a
where a.datea between @t_bdate and @t_edate
and (a.custno  between  @t_bcustno   and  @t_ecustno)
and (driverno between @t_bdriver and @t_edriver)

insert into @tmpa(gno,pno,custno)
select '1',1,a.custno
from(
	select custno from @tmpb
	union all 
	select custno from @tmpc)a
left join @tmpa b on a.custno=b.custno
where b.custno is null
group by a.custno

update @tmpa set plus01a = b.plusmoney,minus01a = b.minusmoney
from @tmpa a
left join (select custno
	,SUM(isnull(plusmoney,0)) plusmoney
	,SUM(isnull(minusmoney,0)) minusmoney 
	from @tmpb where typea='1' group by custno) b on a.custno=b.custno
where b.custno is not null

update @tmpa set plus02a = b.plusmoney,minus02a = b.minusmoney
from @tmpa a
left join (select custno
	,SUM(isnull(plusmoney,0)) plusmoney
	,SUM(isnull(minusmoney,0)) minusmoney 
	from @tmpc where typea='1' group by custno) b on a.custno=b.custno
where b.custno is not null	

update @tmpa set plus01b = b.plusmoney,minus01b = b.minusmoney
from @tmpa a
left join (select custno
	,SUM(isnull(plusmoney,0)) plusmoney
	,SUM(isnull(minusmoney,0)) minusmoney 
	from @tmpb where typea='2' group by custno) b on a.custno=b.custno
where b.custno is not null	

update @tmpa set plus02b = b.plusmoney,minus02b = b.minusmoney
from @tmpa a
left join (select custno
	,SUM(isnull(plusmoney,0)) plusmoney
	,SUM(isnull(minusmoney,0)) minusmoney 
	from @tmpc where typea='2' group by custno) b on a.custno=b.custno
where b.custno is not null

--加減項明細
if len(@t_detail)>0
begin
	-- 客戶加減項
	insert into @tmpa(gno,pno,custno,a_noa,a_date,a_item,a_plus,a_minus)
	select '2',2,custno,noa,datea,ISNULL(plusitem,'')+ISNULL(minusitem,''),plusmoney,minusmoney
	from @tmpb
	where typea='1'
	-- 司機加減項
	declare @carchgno nvarchar(20)
	declare @custchgno nvarchar(20)
	declare @custno nvarchar(20)
	declare @datea nvarchar(20)
	declare @item nvarchar(100)
	declare @plusmoney float
	declare @minusmoney float
	declare @sel int
	
	declare cursor_table cursor for	
	select noa,custchgno,custno,datea
		,isnull(plusitem,'')+isnull(minusitem,'')
		,isnull(plusmoney,'')
		,isnull(minusmoney,'') 
	from @tmpc
	where typea='1'
	open cursor_table
	fetch next from cursor_table
	into @carchgno,@custchgno,@custno,@datea,@item,@plusmoney,@minusmoney
	while(@@FETCH_STATUS <> -1)
	begin
		if exists(select * from @tmpa where pno=2 and custno=@custno and a_noa=@custchgno and b_noa is null)
		begin
			select @sel = sel from @tmpa where pno=2 and custno=@custno and a_noa=@custchgno and b_noa is null
			update @tmpa set b_noa=@carchgno,b_date=@datea
				,b_item=@item,b_plus=@plusmoney,b_minus=@minusmoney
				where sel=@sel
		end
		else
		begin
			insert into @tmpa(gno,pno,custno,b_noa,b_date,b_item,b_plus,b_minus)
			select '3',3,@custno,@carchgno,@datea,@item,@plusmoney,@minusmoney
		end

		fetch next from cursor_table
		into @carchgno,@custchgno,@custno,@datea,@item,@plusmoney,@minusmoney
	end
	close cursor_table
	deallocate cursor_table
	
end
------------------------------------------------------------------------------------
-- 小計
insert into @tmpa(gno,pno,custno,total01,plus01a,minus01a
	,plus02a,minus02a)
select '4',4,CHAR(255),SUM(ISNULL(total01,0)),SUM(ISNULL(plus01a,0)),SUM(ISNULL(minus01a,0))
	,SUM(ISNULL(plus02a,0)),SUM(ISNULL(minus02a,0))
from @tmpa
where pno=1
---------------------------------------------------------------------------------------------
--加減項明細(暫收代收)
if len(@t_detail)>0
begin
	declare cursor_table cursor for	
	select noa,custchgno,CHAR(255),datea
		,isnull(plusitem,'')+isnull(minusitem,'')
		,isnull(plusmoney,'')
		,isnull(minusmoney,'') 
	from @tmpc
	where typea='2'
	open cursor_table
	fetch next from cursor_table
	into @carchgno,@custchgno,@custno,@datea,@item,@plusmoney,@minusmoney
	while(@@FETCH_STATUS <> -1)
	begin
		if exists(select * from @tmpa where pno=5 and custno=@custno and a_noa=@custchgno and b_noa is null)
		begin
			select @sel = sel from @tmpa where pno=5 and custno=@custno and a_noa=@custchgno and b_noa is null
			update @tmpa set b_noa=@carchgno,b_date=@datea
				,b_item=@item,b_plus=@plusmoney,b_minus=@minusmoney
				where sel=@sel
		end
		else
		begin
			insert into @tmpa(gno,pno,custno,b_noa,b_date,b_item,b_plus,b_minus)
			select '6',6,@custno,@carchgno,@datea,@item,@plusmoney,@minusmoney
		end

		fetch next from cursor_table
		into @carchgno,@custchgno,@custno,@datea,@item,@plusmoney,@minusmoney
	end
	close cursor_table
	deallocate cursor_table
	
end
------------------------------------------------------------------------------------
-- 總計
insert into @tmpa(
	gno,pno,custno,total01
	,plus01a,minus01a
	,plus01b,minus01b
	,plus02a,minus02a
	,plus02b,minus02b
)
select '7',7,CHAR(255),SUM(ISNULL(total01,0))
	,SUM(ISNULL(plus01a,0)),SUM(ISNULL(minus01a,0))
	,SUM(ISNULL(plus01b,0)),SUM(ISNULL(minus01b,0))
	,SUM(ISNULL(plus02a,0)),SUM(ISNULL(minus02a,0))
	,SUM(ISNULL(plus02b,0)),SUM(ISNULL(minus02b,0))
from @tmpa
where pno=1

update @tmpa set amount = ISNULL(plus02a,0)-ISNULL(minus02a,0)
update @tmpa set diff = ISNULL(total01,0)+ISNULL(plus01a,0)-ISNULL(minus01a,0)
	-(ISNULL(plus02a,0)+ISNULL(minus02a,0))

-------------------------------------------------------------------------------------
declare @noa nvarchar(20)
declare @carteam nvarchar(20)
set @cmd = ''
declare cursor_table cursor for
select a.noa,a.team 
from carteam a 
open cursor_table
fetch next from cursor_table
into @noa,@carteam
while(@@FETCH_STATUS <> -1)
begin
	set @cmd = @cmd+case when len(@cmd)>0 then ',' else '' end + @carteam
	fetch next from cursor_table
	into @noa,@carteam
end
close cursor_table
deallocate cursor_table
set @cmd = '【'+@cmd+'】'

set  @cmd  =  '交運日期：'+@t_bdate+'～'+@t_edate+'&nbsp'+char(59)+'&nbsp'+char(59)

select a.gno
	,@cmd titlea
	,a.custno a01
	,b.nick a02
	,dbo.getComma(a.total01,-1) a03
	,dbo.getComma(a.plus01a,-1) a04
	,dbo.getComma(a.minus01a,-1) a05
	,dbo.getComma(a.plus02a,-1) a08
	,dbo.getComma(a.minus02a,-1) a09
	,dbo.getComma(a.amount,-1) a10
	,dbo.getComma(a.diff,-1) a11
	
	,dbo.getComma(a.plus01b,-1) a12
	,dbo.getComma(a.minus01b,-1) a13
	,dbo.getComma(a.plus02b,-1) a14
	,dbo.getComma(a.minus02b,-1) a15
	
	,dbo.getComma(ISNULL(a.amount,0)+ISNULL(a.plus02b,0)-ISNULL(a.minus02b,0),-1) a16

	,a.a_item c01
	,dbo.getComma(a.a_plus,-1) c02
	,dbo.getComma(a.a_minus,-1) c03
	,a.b_item c04
	,dbo.getComma(a.b_plus,-1) c05
	,dbo.getComma(a.b_minus,-1) c06
	
from @tmpa a
left join cust b on a.custno=b.noa 
order by a.custno,a.pno,a.sel;
------------------------------------------------------------------------------------------------------
z_tran_sh10:--z_tran_sh10
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max) 
	declare @t_bmon nvarchar(20) = case when '#non'='106/01' then '' else '106/01' end 
	declare @t_emon nvarchar(20) = case when '#non'='106/11' then char(255) else '106/11' end 
	declare @t_bcustno nvarchar(20) = case when '#non'='#non' then '' else '#non' end 
	declare @t_ecustno nvarchar(20) = case when '#non'='#non' then char(255) else '#non' end 
	-------------------------------------------------------------------------------------------------
	declare @tmp table(
		gno nvarchar(10),
		pno nvarchar(10),
		custno nvarchar(20),
		insures float,
		money1 float,
		money2 float,
		custplus float,
		custminus float,
		driverplus float,
		driverminus float,
		reserve float,
		tolls float,
		etc float,
		oil float,
		wmoney float,
		wmoneycar float,
		wmoneyplate float,
		cmoney float,
		dmoney float,
		emoney float,
		ticket float,
		bonus float,
		tax float,
		depreciation float,
		driverpay float,
		profit float,
		tax2 float,
		rate float
	)
	insert into @tmp(gno,pno,custno,insures,money1,money2
		,custplus,custminus,driverplus,driverminus,reserve,tolls,etc,oil
		,wmoney,wmoneycar,wmoneyplate,cmoney,dmoney,emoney,ticket,bonus,tax,depreciation,driverpay)
	select '1','1',isnull(a.custno,'')
		,sum(ISNULL(a.insures,0)),sum(ISNULL(a.money1,0)),sum(ISNULL(a.money2,0))
		,sum(ISNULL(a.custplus,0)),sum(ISNULL(a.custminus,0)),sum(ISNULL(a.driverplus,0)),sum(ISNULL(a.driverminus,0))
		,sum(ISNULL(a.reserve,0)),sum(ISNULL(a.tolls,0)),sum(ISNULL(a.etc,0)),sum(ISNULL(a.oil,0))
		,sum(ISNULL(a.wmoney,0)),sum(ISNULL(a.wmoneycar,0)),sum(ISNULL(a.wmoneyplate,0)),sum(ISNULL(a.cmoney,0)),sum(ISNULL(a.dmoney,0)),sum(ISNULL(a.emoney,0))
		,sum(ISNULL(a.ticket,0)),sum(ISNULL(a.bonus,0)),sum(ISNULL(a.tax,0)),sum(ISNULL(a.depreciation,0)) 
		,sum(isnull(a.driverpay,0))
	from trans_sum a 
	left join view_trans b on a.tranaccy=b.accy and a.tranno=b.noa and a.trannoq=b.noq
	where a.mon between @t_bmon and @t_emon
	and isnull(a.custno,'') between @t_bcustno and @t_ecustno
	group by isnull(a.custno,'')
	
	insert into @tmp(gno,pno,custno,insures,money1,money2
		,custplus,custminus,driverplus,driverminus,reserve,tolls,etc,oil
		,wmoney,wmoneycar,wmoneyplate,cmoney,dmoney,emoney,ticket,bonus,tax,depreciation,driverpay)
	select '2','3',CHAR(255),sum(ISNULL(a.insures,0)),sum(ISNULL(a.money1,0)),sum(ISNULL(a.money2,0))
		,sum(ISNULL(a.custplus,0)),sum(ISNULL(a.custminus,0)),sum(ISNULL(a.driverplus,0)),sum(ISNULL(a.driverminus,0))
		,sum(ISNULL(a.reserve,0)),sum(ISNULL(a.tolls,0)),sum(ISNULL(a.etc,0)),sum(ISNULL(a.oil,0))
		,sum(ISNULL(a.wmoney,0)),sum(ISNULL(a.wmoneycar,0)),sum(ISNULL(a.wmoneyplate,0)),sum(ISNULL(a.cmoney,0)),sum(ISNULL(a.dmoney,0)),sum(ISNULL(a.emoney,0))
		,sum(ISNULL(a.ticket,0)),sum(ISNULL(a.bonus,0)),sum(ISNULL(a.tax,0)),sum(ISNULL(a.depreciation,0)) 
		,sum(isnull(a.driverpay,0))
	from @tmp a
	----------------------------------------------------------------------------------------------------
	update @tmp set tax2=0
	update @tmp set tax2=round(isnull(a.money1,0)*0.03,0)
	from @tmp a
	outer apply(select noa from view_trd where custno=a.custno and mon between @t_bmon and @t_emon and len(vccano)>0) b
	where b.noa is not null
	and gno='1'
	update @tmp set profit = money1-money2-insures+custplus-custminus-driverplus+driverminus-reserve-tolls
		-etc-oil-wmoney-cmoney-dmoney-emoney-ticket-bonus-tax-depreciation+driverpay-isnull(tax2,0)
	update @tmp set rate = case money1 when 0 then 0 else round(profit/money1*100,0) end 
	update @tmp set gno = '3' where gno='1' and profit<0

	select a.* 
		,b.nick nick
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.money1),1)),4,12)) a01 --應收運費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.custplus),1)),4,12)) a02 --客戶加項
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.custminus),1)),4,12)) a03 --客戶減項
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.money2),1)),4,12)) a04 --應付運費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.driverplus),1)),4,12)) a05 --司機加項
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.driverminus),1)),4,12)) a06 --司機減項
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.bonus),1)),4,12)) a07 --達成獎金
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.reserve),1)),4,12)) a08--寄櫃費	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.tolls+a.etc),1)),4,12)) a09--通行費	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.oil),1)),4,12)) a10--油費	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.wmoneycar),1)),4,12)) a11--維修	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.wmoneyplate),1)),4,12)) a12--板維修	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.driverpay),1)),4,12)) a13--司機付	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.cmoney),1)),4,12)) a14--輪胎	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.ticket),1)),4,12)) a15--罰單	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.tax),1)),4,12)) a16--保牌燃費	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.depreciation),1)),4,12)) a17--折舊	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.insures),1)),4,12)) a18--勞健保	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.tax2),1)),4,12)) a19--稅捐	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.profit),1)),4,12)) a20--毛利
	from @tmp a 
	left join cust b on a.custno=b.noa
	order by pno,profit,custno;
