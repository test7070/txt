z_genz1:--z_genz1
SET QUOTED_IDENTIFIER OFF
declare @accy nvarchar(10)
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bpno nvarchar(20)
declare @t_epno nvarchar(20)
set @accy='[1]'
set @t_bdate = case when '#non'=[2] then '' else [2] end
set @t_edate = case when '#non'=[3] then char(255) else [3] end
set @t_bpno = case when '#non'=[4] then '' else [4] end
set @t_epno = case when '#non'=[5] then char(255) else [5] end

IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
	drop table #tmp
END

create table #tmp(
	gno nvarchar(1),
	rr int,
	productno nvarchar(50),
	product nvarchar(100),
	unit nvarchar(10),
	datea nvarchar(10),
	typea nvarchar(50),
	mount float,--生產數量
	smount float,--銷售數量
	total float,--結存
	mon nvarchar(10)
)
--期初
insert #tmp
select '0','',noa,product,unit,@accy+'/01/01','上期結轉',isnull(beginmount,0),'',isnull(beginmount,0),@accy+'/01'
from ucca
where isnull(beginmount,0)!=0
and (noa between @t_bpno and @t_epno)

--生產
insert #tmp
select '1','',a.productno,a.product,a.unit,b.datea,'生產',isnull(b.mount,0),'',isnull(b.mount,0),LEFT(b.datea,6)
from #tmp a left join view_inas b on a.productno=b.productno
left join view_ina c on b.noa=c.noa
where c.itype='生產入庫' and isnull(c.itype,'')!=''
and (b.datea between @t_bdate and @t_edate)

--銷售
insert #tmp
select '2','',a.productno,a.product,a.unit,b.datea,'銷售','',case when c.typea='1' then 1 else -1 end*isnull(b.mount,0),-1*case when c.typea='1' then 1 else -1 end*isnull(b.mount,0),LEFT(b.datea,6)
from #tmp a left join view_vccs b on a.productno=b.productno
left join view_vcc c on b.noa=c.noa
where gno='0' and isnull(c.typea,'')!=''
and (b.datea between @t_bdate and @t_edate)

update a
set rr=rx,gno='0'
from (select ROW_NUMBER()over(partition by productno order by datea,gno)rx,rr,gno from #tmp)a

update a
set total=b.total
from #tmp a
outer apply(select sum(total)total from #tmp where rr<=a.rr and a.productno=productno)b

insert #tmp(gno,productno,mon,mount,smount)
select '1',productno,mon,SUM(mount),SUM(smount)
from #tmp
group by productno,mon

insert #tmp(gno,productno,mon,mount,smount,total)
select '2',productno,CHAR(255),SUM(mount),SUM(smount),b.total
from #tmp
outer apply(select top 1 total from #tmp order by rr desc)b
where gno='0'
group by productno,b.total

select 
productno pno,@accy [year],right(datea,5) datea
,* from #tmp
order by productno,mon,gno,rr

IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
	drop table #tmp
END
;
---------------------------------------------------------------------------------
z_genz2:--z_genz2
SET QUOTED_IDENTIFIER OFF
declare @accy nvarchar(10)
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bpno nvarchar(20)
declare @t_epno nvarchar(20)
set @accy='[1]'
set @t_bdate = case when '#non'=[2] then '' else [2] end
set @t_edate = case when '#non'=[3] then char(255) else [3] end
set @t_bpno = case when '#non'=[4] then '' else [4] end
set @t_epno = case when '#non'=[5] then char(255) else [5] end

IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
	drop table #tmp
END

create table #tmp(
	gno nvarchar(1),
	rr int,
	productno nvarchar(50),
	product nvarchar(100),
	unit nvarchar(10),
	datea nvarchar(10),
	product1 nvarchar(150),
	mount float,
	price float,
	total float,
	mon nvarchar(10)
)

insert #tmp
select '0','',a.noa,a.product,a.unit,b.datea,a.noa+' '+a.product,b.mount,c.price,b.mount*c.price,@accy+'/01'
from ucca a left join view_gets b on a.noa=b.productno
left join view_get c on c.noa=b.noa
where (a.noa between @t_bpno and @t_epno)
and(b.datea between @t_bdate and @t_edate)

update a
set rr=rx,gno='0'
from (select ROW_NUMBER()over(partition by productno order by datea,gno)rx,rr,gno from #tmp)a

update a
set total=b.total
from #tmp a
outer apply(select sum(total)total from #tmp where rr<=a.rr and a.productno=productno)b

insert #tmp(gno,productno,mon,mount,total)
select '1',productno,mon,SUM(mount),SUM(total)
from #tmp
group by productno,mon

insert #tmp(gno,productno,mon,mount,total)
select '2',productno,CHAR(255),SUM(mount),SUM(total)
from #tmp
where gno='0'
group by productno

select 
productno pno,@accy [year],right(datea,5) datea
,* from #tmp
order by productno,mon,gno,rr

IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
	drop table #tmp
END
;