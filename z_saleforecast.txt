z_saleforecast1:--z_saleforecast1
	declare @t_bcustno nvarchar(50)
	declare @t_ecustno nvarchar(50)
	declare @t_bpno nvarchar(50)
	declare @t_epno nvarchar(50)
	declare @t_mon nvarchar(10)
	declare @t_year nvarchar(10)
	declare @r_len int=[2]

	set @t_bcustno = case when '#non'=[3] then '' else [3] end
	set @t_ecustno = case when '#non'=[4] then char(255) else [4] end
	set @t_bpno = case when '#non'=[5] then '' else [5] end
	set @t_epno = case when '#non'=[6] then char(255) else [6] end
	set @t_mon = case when '#non'=[9] then '' else [9] end
	set @t_year = case when '#non'=[10] then '' else [10] end

--*****************************************************************************************	
declare @t_oldmon nvarchar(10)--上期月份 

set @t_oldmon='' 

declare @cmd nvarchar(max) 
IF OBJECT_ID('tempdb..#tmpmon')is not null
BEGIN
	set @cmd = 'drop table #tmpmon'
	EXECUTE sp_executesql @cmd
END

create table #tmpmon(
	custno nvarchar(50),
	productno nvarchar(50),
	omount float, 
	fmount float
)

declare @result table(
	gno nvarchar(1),
	custno nvarchar(50),
	comp nvarchar(50),
	pno nvarchar(50),
	product nvarchar(90),
	unit nvarchar(50),
	smount float, 
	cmount float,
	rmount float
)

set @t_oldmon=right('000'+cast ((cast(left(@t_mon,@r_len) as int) -1) as nvarchar(10)),@r_len)+'/'+right(@t_mon,2) 
	
	insert into #tmpmon
	select c.custno,u.productno
	,(select isnull(sum(o.mount),0)mount from view_ordes o where left(o.odate,6)=@t_oldmon and o.custno=c.custno and o.productno=u.productno )--實際
	,(select isnull(sum(f.mount),0)mount from saleforecasts f where mon=@t_oldmon and f.custno=c.custno and f.productno=u.productno ) --預測
	from (select noa custno from cust)c,(select noa productno from ucc union select noa productno from uca)u
	where (c.custno between @t_bcustno and @t_ecustno) and (u.productno between @t_bpno and @t_epno)
	
	delete #tmpmon where omount=0 and fmount=0 
	
	insert #tmpmon
	select custno,productno,0,0 from saleforecasts 
	where mon=@t_mon and custno+'_'+productno not in (select custno+'_'+productno from #tmpmon)
	and (productno between @t_bpno and @t_epno) 
	group by custno,productno
	
	insert #tmpmon
	select a.custno,b.productno,0,0 from view_orde a left join view_ordes b on a.noa=b.noa 
	where (case when a.mon!='' then a.mon else left(a.odate,6) end)=@t_mon and a.custno+'_'+b.productno not in (select custno+'_'+productno from #tmpmon)
	and (b.productno between @t_bpno and @t_epno) 
	group by a.custno,b.productno
	
	insert into @result
	select '0',m.custno,c.nick,m.productno,u.product,u.unit
	,isnull((select SUM(mount)mount from saleforecasts f where mon=@t_mon and f.productno=m.productno and f.custno=m.custno ),0)
	,m.omount+(case when m.omount=0 or (m.omount-m.fmount)<0 then 0 else(m.omount-m.fmount)/m.omount end)cmount 
	,(select isnull(sum(o.mount),0)mount from view_ordes o where left(o.odate,6)=@t_mon and o.custno=m.custno and o.productno=m.productno )
	from #tmpmon 
	m left join cust c on m.custno=c.noa 
	left join (select noa productno,product,unit from ucc union select noa productno,product,unit from uca where noa not in (select noa from ucc))u on m.productno=u.productno
	
	delete @result where isnull(smount,0)=0 and isnull(cmount,0)=0 and isnull(rmount,0)=0 
	
	insert into @result (gno,custno,pno)
	select '1',custno,char(255) from @result group by custno 

	select gno,custno,comp,pno,product,unit
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,smount),1)),0,30)) smount
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,cmount),1)),0,30)) cmount
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,rmount),1)),0,30)) rmount
	from @result order by custno,pno,gno
	
	IF OBJECT_ID('tempdb..#tmpmon')is not null
	BEGIN
		set @cmd = 'drop table #tmpmon'
		EXECUTE sp_executesql @cmd
	END

;
--*******************************************************************************************
z_saleforecast2:--z_saleforecast2
	declare @t_bcustno nvarchar(50)
	declare @t_ecustno nvarchar(50)
	declare @t_bpno nvarchar(50)
	declare @t_epno nvarchar(50)
	declare @t_mon nvarchar(10)
	declare @t_year nvarchar(10)
	declare @r_len int=[2]

	set @t_bcustno = case when '#non'=[3] then '' else [3] end
	set @t_ecustno = case when '#non'=[4] then char(255) else [4] end
	set @t_bpno = case when '#non'=[5] then '' else [5] end
	set @t_epno = case when '#non'=[6] then char(255) else [6] end
	set @t_mon = case when '#non'=[9] then '' else [9] end
	set @t_year = case when '#non'=[10] then '' else [10] end

--*****************************************************************************************	
declare @t_oldmon nvarchar(10)--上期月份 

set @t_oldmon='' 

declare @cmd nvarchar(max) 
IF OBJECT_ID('tempdb..#tmpmon')is not null
BEGIN
	set @cmd = 'drop table #tmpmon'
	EXECUTE sp_executesql @cmd
END

create table #tmpmon(
	custno nvarchar(50),
	productno nvarchar(50),
	omount float, 
	fmount float
)

declare @result table(
	gno nvarchar(1),
	custno nvarchar(50),
	comp nvarchar(50),
	pno nvarchar(50),
	product nvarchar(90),
	unit nvarchar(50),
	smount float, 
	cmount float,
	rmount float
)

set @t_oldmon=right('000'+cast ((cast(left(@t_mon,@r_len) as int) -1) as nvarchar(10)),@r_len)+'/'+right(@t_mon,2) 
	
	insert into #tmpmon
	select c.custno,u.productno
	,(select isnull(sum(o.mount),0)mount from view_ordes o where left(o.odate,6)=@t_oldmon and o.custno=c.custno and o.productno=u.productno )--實際
	,(select isnull(sum(f.mount),0)mount from saleforecasts f where mon=@t_oldmon and f.custno=c.custno and f.productno=u.productno ) --預測
	from (select noa custno from cust)c,(select noa productno from ucc union select noa productno from uca)u
	where (c.custno between @t_bcustno and @t_ecustno) and (u.productno between @t_bpno and @t_epno)
	
	delete #tmpmon where omount=0 and fmount=0 
	
	insert #tmpmon
	select custno,productno,0,0 from saleforecasts 
	where mon=@t_mon and custno+'_'+productno not in (select custno+'_'+productno from #tmpmon)
	and (productno between @t_bpno and @t_epno) 
	group by custno,productno
	
	insert #tmpmon
	select a.custno,b.productno,0,0 from view_orde a left join view_ordes b on a.noa=b.noa 
	where (case when a.mon!='' then a.mon else left(a.odate,6) end)=@t_mon and a.custno+'_'+b.productno not in (select custno+'_'+productno from #tmpmon)
	and (b.productno between @t_bpno and @t_epno) 
	group by a.custno,b.productno
	
	insert into @result
	select '0',m.custno,c.nick,m.productno,u.product,u.unit
	,isnull((select SUM(mount)mount from saleforecasts f where mon=@t_mon and f.productno=m.productno and f.custno=m.custno ),0)
	,m.omount+(case when m.omount=0 or (m.omount-m.fmount)<0 then 0 else(m.omount-m.fmount)/m.omount end)cmount
	,(select isnull(sum(o.mount),0)mount from view_ordes o where left(o.odate,6)=@t_mon and o.custno=m.custno and o.productno=m.productno )
	from #tmpmon 
	m left join cust c on m.custno=c.noa 
	left join (select noa productno,product,unit from ucc union select noa productno,product,unit from uca where noa not in (select noa from ucc))u on m.productno=u.productno
	
	delete @result where isnull(smount,0)=0 and isnull(cmount,0)=0 and isnull(rmount,0)=0 	
	
	insert into @result (gno,custno,pno,product,smount,cmount,rmount)
	select '1',char(255),pno,MAX(product),sum(smount),sum(cmount),sum(rmount) from @result group by pno 

	select gno,custno,comp,pno,product,unit
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,smount),1)),0,30)) smount
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,cmount),1)),0,30)) cmount
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,rmount),1)),0,30)) rmount
	from @result order by pno,custno,gno
	
	IF OBJECT_ID('tempdb..#tmpmon')is not null
	BEGIN
		set @cmd = 'drop table #tmpmon'
		EXECUTE sp_executesql @cmd
	END

;
--*******************************************************************************************
z_saleforecast3:--z_saleforecast3
	declare @t_bcustno nvarchar(50)
	declare @t_ecustno nvarchar(50)
	declare @t_bpno nvarchar(50)
	declare @t_epno nvarchar(50)
	declare @t_mon nvarchar(10)
	declare @t_year nvarchar(10)
	declare @r_len int=[2]

	set @t_bcustno = case when '#non'=[3] then '' else [3] end
	set @t_ecustno = case when '#non'=[4] then char(255) else [4] end
	set @t_bpno = case when '#non'=[5] then '' else [5] end
	set @t_epno = case when '#non'=[6] then char(255) else [6] end
	set @t_mon = case when '#non'=[9] then '' else [9] end
	set @t_year = case when '#non'=[10] then '' else [10] end
	
--*****************************************************************************************	
declare @t_oldyear nvarchar(10)--上期年度
declare @moncount int
set @t_oldyear='' 
set @moncount=1
set @t_oldyear=right('0000'+cast ((cast(@t_year as int) -1) as nvarchar(10)),@r_len)

declare @cmd nvarchar(max) 
IF OBJECT_ID('tempdb..#tmpmon')is not null
BEGIN
	set @cmd = 'drop table #tmpmon'
	EXECUTE sp_executesql @cmd
END

create table #tmpmon(
	custno nvarchar(50),
	productno nvarchar(50),
	omount float, 
	fmount float
)

declare @result table(
	gno nvarchar(1),
	custno nvarchar(50),
	comp nvarchar(50),
	pno nvarchar(50),
	product nvarchar(90),
	unit nvarchar(50),
	s01 float, 
	c01 float,
	r01 float,
	s02 float, 
	c02 float,
	r02 float,
	s03 float, 
	c03 float,
	r03 float,
	s04 float, 
	c04 float,
	r04 float,
	s05 float, 
	c05 float,
	r05 float,
	s06 float, 
	c06 float,
	r06 float,
	s07 float, 
	c07 float,
	r07 float,
	s08 float, 
	c08 float,
	r08 float,
	s09 float, 
	c09 float,
	r09 float,
	s10 float, 
	c10 float,
	r10 float,
	s11 float, 
	c11 float,
	r11 float,
	s12 float, 
	c12 float,
	r12 float,
	stotal float,
	ctotal float,
	rtotal float
)

declare @t_oldmons nvarchar(10)--去年
declare @t_mons nvarchar(10)--今年

while(@moncount<=12)
begin
	set @t_oldmons=@t_oldyear+'/'+right('0'+cast(@moncount as nvarchar(10)),2)
	set @t_mons=@t_year+'/'+right('0'+cast(@moncount as nvarchar(10)),2)
	
	insert into #tmpmon
	select c.custno,u.productno
	,(select isnull(sum(o.mount),0)mount from view_ordes o where left(o.odate,6)=@t_oldmons and o.custno=c.custno and o.productno=u.productno )--實際
	,(select isnull(sum(f.mount),0)mount from saleforecasts f where mon=@t_oldmons and f.custno=c.custno and f.productno=u.productno ) --預測
	from (select noa custno from cust)c,(select noa productno from ucc union select noa productno from uca)u
	where (c.custno between @t_bcustno and @t_ecustno) and (u.productno between @t_bpno and @t_epno)
	
	delete #tmpmon where omount=0 and fmount=0 
	
	insert #tmpmon
	select custno,productno,0,0 from saleforecasts 
	where mon=@t_mons and custno+'_'+productno not in (select custno+'_'+productno from #tmpmon)
	and (productno between @t_bpno and @t_epno) 
	group by custno,productno
	
	insert #tmpmon
	select a.custno,b.productno,0,0 from view_orde a left join view_ordes b on a.noa=b.noa 
	where (case when a.mon!='' then a.mon else left(a.odate,6) end)=@t_mons and a.custno+'_'+b.productno not in (select custno+'_'+productno from #tmpmon)
	and (b.productno between @t_bpno and @t_epno) 
	group by a.custno,b.productno
	
	if(@moncount=1)
	begin
		insert into @result(gno,custno,comp,pno,product,unit,s01,c01,r01)
		select '0',m.custno,c.nick,m.productno,u.product,u.unit
		,isnull((select SUM(mount)mount from saleforecasts f where mon=@t_mons and f.productno=m.productno and f.custno=m.custno ),0)
		,isnull(m.omount,0)+isnull((case when m.omount=0 or (m.omount-m.fmount)<0 then 0 else(m.omount-m.fmount)/m.omount end),0) cmount
		,isnull((select isnull(sum(o.mount),0)mount from view_ordes o where left(o.odate,6)=@t_mons and o.custno=m.custno and o.productno=m.productno),0)
		from #tmpmon m left join cust c on m.custno=c.noa 
		left join (select noa productno,product,unit from ucc union select noa productno,product,unit from uca where noa not in (select noa from ucc))u on m.productno=u.productno
	end
	if(@moncount=2)
	begin
		update a
		set s02=isnull((select SUM(mount)mount from saleforecasts f where mon=@t_mons and f.productno=b.productno and f.custno=b.custno ),0)
		,c02=isnull(b.omount,0)+isnull((case when b.omount=0 or (b.omount-b.fmount)<0 then 0 else (b.omount-b.fmount)/b.omount end),0)
		,r02=isnull((select isnull(sum(o.mount),0)mount from view_ordes o where left(o.odate,6)=@t_mons and o.custno=b.custno and o.productno=b.productno),0)
		from @result a left join #tmpmon b on a.custno=b.custno and a.pno=b.productno
	end
	if(@moncount=3)
	begin
		update a
		set s03=isnull((select SUM(mount)mount from saleforecasts f where mon=@t_mons and f.productno=b.productno and f.custno=b.custno ),0)
		,c03=isnull(b.omount,0)+isnull((case when b.omount=0 or (b.omount-b.fmount)<0 then 0 else (b.omount-b.fmount)/b.omount end),0)
		,r03=isnull((select isnull(sum(o.mount),0)mount from view_ordes o where left(o.odate,6)=@t_mons and o.custno=b.custno and o.productno=b.productno),0)
		from @result a left join #tmpmon b on a.custno=b.custno and a.pno=b.productno
	end
	if(@moncount=4)
	begin
		update a
		set s04=isnull((select SUM(mount)mount from saleforecasts f where mon=@t_mons and f.productno=b.productno and f.custno=b.custno ),0)
		,c04=isnull(b.omount,0)+isnull((case when b.omount=0 or (b.omount-b.fmount)<0 then 0 else (b.omount-b.fmount)/b.omount end),0)
		,r04=isnull((select isnull(sum(o.mount),0)mount from view_ordes o where left(o.odate,6)=@t_mons and o.custno=b.custno and o.productno=b.productno),0)
		from @result a left join #tmpmon b on a.custno=b.custno and a.pno=b.productno
	end
	if(@moncount=5)
	begin
		update a
		set s05=isnull((select SUM(mount)mount from saleforecasts f where mon=@t_mons and f.productno=b.productno and f.custno=b.custno ),0)
		,c05=isnull(b.omount,0)+isnull((case when b.omount=0 or (b.omount-b.fmount)<0 then 0 else (b.omount-b.fmount)/b.omount end),0)
		,r05=isnull((select isnull(sum(o.mount),0)mount from view_ordes o where left(o.odate,6)=@t_mons and o.custno=b.custno and o.productno=b.productno),0)
		from @result a left join #tmpmon b on a.custno=b.custno and a.pno=b.productno
	end
	if(@moncount=6)
	begin
		update a
		set s06=isnull((select SUM(mount)mount from saleforecasts f where mon=@t_mons and f.productno=b.productno and f.custno=b.custno ),0)
		,c06=isnull(b.omount,0)+isnull((case when b.omount=0 or (b.omount-b.fmount)<0 then 0 else (b.omount-b.fmount)/b.omount end),0)
		,r06=isnull((select isnull(sum(o.mount),0)mount from view_ordes o where left(o.odate,6)=@t_mons and o.custno=b.custno and o.productno=b.productno),0)
		from @result a left join #tmpmon b on a.custno=b.custno and a.pno=b.productno
	end
	if(@moncount=7)
	begin
		update a
		set s07=isnull((select SUM(mount)mount from saleforecasts f where mon=@t_mons and f.productno=b.productno and f.custno=b.custno ),0)
		,c07=isnull(b.omount,0)+isnull((case when b.omount=0 or (b.omount-b.fmount)<0 then 0 else (b.omount-b.fmount)/b.omount end),0)
		,r07=isnull((select isnull(sum(o.mount),0)mount from view_ordes o where left(o.odate,6)=@t_mons and o.custno=b.custno and o.productno=b.productno),0)
		from @result a left join #tmpmon b on a.custno=b.custno and a.pno=b.productno
	end
	if(@moncount=8)
	begin
		update a
		set s08=isnull((select SUM(mount)mount from saleforecasts f where mon=@t_mons and f.productno=b.productno and f.custno=b.custno ),0)
		,c08=isnull(b.omount,0)+isnull((case when b.omount=0 or (b.omount-b.fmount)<0 then 0 else (b.omount-b.fmount)/b.omount end),0)
		,r08=isnull((select isnull(sum(o.mount),0)mount from view_ordes o where left(o.odate,6)=@t_mons and o.custno=b.custno and o.productno=b.productno),0)
		from @result a left join #tmpmon b on a.custno=b.custno and a.pno=b.productno
	end
	if(@moncount=9)
	begin
		update a
		set s09=isnull((select SUM(mount)mount from saleforecasts f where mon=@t_mons and f.productno=b.productno and f.custno=b.custno ),0)
		,c09=isnull(b.omount,0)+isnull((case when b.omount=0 or (b.omount-b.fmount)<0 then 0 else (b.omount-b.fmount)/b.omount end),0)
		,r09=isnull((select isnull(sum(o.mount),0)mount from view_ordes o where left(o.odate,6)=@t_mons and o.custno=b.custno and o.productno=b.productno),0)
		from @result a left join #tmpmon b on a.custno=b.custno and a.pno=b.productno
	end
	if(@moncount=10)
	begin
		update a
		set s10=isnull((select SUM(mount)mount from saleforecasts f where mon=@t_mons and f.productno=b.productno and f.custno=b.custno ),0)
		,c10=isnull(b.omount,0)+isnull((case when b.omount=0 or (b.omount-b.fmount)<0 then 0 else (b.omount-b.fmount)/b.omount end),0)
		,r10=isnull((select isnull(sum(o.mount),0)mount from view_ordes o where left(o.odate,6)=@t_mons and o.custno=b.custno and o.productno=b.productno),0)
		from @result a left join #tmpmon b on a.custno=b.custno and a.pno=b.productno
	end
	if(@moncount=11)
	begin
		update a
		set s11=isnull((select SUM(mount)mount from saleforecasts f where mon=@t_mons and f.productno=b.productno and f.custno=b.custno ),0)
		,c11=isnull(b.omount,0)+isnull((case when b.omount=0 or (b.omount-b.fmount)<0 then 0 else (b.omount-b.fmount)/b.omount end),0)
		,r11=isnull((select isnull(sum(o.mount),0)mount from view_ordes o where left(o.odate,6)=@t_mons and o.custno=b.custno and o.productno=b.productno),0)
		from @result a left join #tmpmon b on a.custno=b.custno and a.pno=b.productno
	end
	if(@moncount=12)
	begin
		update a
		set s12=isnull((select SUM(mount)mount from saleforecasts f where mon=@t_mons and f.productno=b.productno and f.custno=b.custno ),0)
		,c12=isnull(b.omount,0)+isnull((case when b.omount=0 or (b.omount-b.fmount)<0 then 0 else (b.omount-b.fmount)/b.omount end),0)
		,r12=isnull((select isnull(sum(o.mount),0)mount from view_ordes o where left(o.odate,6)=@t_mons and o.custno=b.custno and o.productno=b.productno),0)
		from @result a left join #tmpmon b on a.custno=b.custno and a.pno=b.productno
	end
	
	delete #tmpmon
	set @moncount=@moncount+1
end
	delete @result 
	where isnull(s01,0)=0 and isnull(c01,0)=0 and isnull(r01,0)=0
	and isnull(s02,0)=0 and isnull(c02,0)=0 and isnull(r02,0)=0
	and isnull(s03,0)=0 and isnull(c03,0)=0 and isnull(r03,0)=0
	and isnull(s04,0)=0 and isnull(c04,0)=0 and isnull(r04,0)=0
	and isnull(s05,0)=0 and isnull(c05,0)=0 and isnull(r05,0)=0
	and isnull(s06,0)=0 and isnull(c06,0)=0 and isnull(r06,0)=0
	and isnull(s07,0)=0 and isnull(c07,0)=0 and isnull(r07,0)=0
	and isnull(s08,0)=0 and isnull(c08,0)=0 and isnull(r08,0)=0
	and isnull(s09,0)=0 and isnull(c09,0)=0 and isnull(r09,0)=0
	and isnull(s10,0)=0 and isnull(c10,0)=0 and isnull(r10,0)=0
	and isnull(s11,0)=0 and isnull(c11,0)=0 and isnull(r11,0)=0
	and isnull(s12,0)=0 and isnull(c12,0)=0 and isnull(r12,0)=0

	update @result
	set stotal=s01+s02+s03+s04+s05+s06+s07+s08+s09+s10+s11+s12,
	ctotal=c01+c02+c03+c04+c05+c06+c07+c08+c09+c10+c11+c12,
	rtotal=r01+r02+r03+r04+r05+r06+r07+r08+r09+r10+r11+r12
	
	insert into @result (gno,custno,pno,stotal,ctotal,rtotal)
	select '1',custno,char(255),999,999,999 from @result where stotal!=0 or ctotal !=0 or rtotal !=0 group by custno 
	
	select gno,custno,comp,pno,product,unit
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s01),1)),0,30)) s01
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s02),1)),0,30)) s02
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s03),1)),0,30)) s03
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s04),1)),0,30)) s04
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s05),1)),0,30)) s05
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s06),1)),0,30)) s06
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s07),1)),0,30)) s07
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s08),1)),0,30)) s08
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s09),1)),0,30)) s09
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s10),1)),0,30)) s10
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s11),1)),0,30)) s11
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s12),1)),0,30)) s12
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c01),1)),0,30)) c01
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c02),1)),0,30)) c02
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c03),1)),0,30)) c03
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c04),1)),0,30)) c04
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c05),1)),0,30)) c05
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c06),1)),0,30)) c06
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c07),1)),0,30)) c07
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c08),1)),0,30)) c08
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c09),1)),0,30)) c09
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c10),1)),0,30)) c10
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c11),1)),0,30)) c11
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c12),1)),0,30)) c12
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r01),1)),0,30)) r01
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r02),1)),0,30)) r02
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r03),1)),0,30)) r03
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r04),1)),0,30)) r04
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r05),1)),0,30)) r05
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r06),1)),0,30)) r06
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r07),1)),0,30)) r07
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r08),1)),0,30)) r08
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r09),1)),0,30)) r09
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r10),1)),0,30)) r10
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r11),1)),0,30)) r11
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r12),1)),0,30)) r12
	from @result 
	--where stotal!=0 or ctotal !=0 or rtotal !=0 
	order by custno,pno,gno
	
	IF OBJECT_ID('tempdb..#tmpmon')is not null
	BEGIN
		set @cmd = 'drop table #tmpmon'
		EXECUTE sp_executesql @cmd
	END
;
--*******************************************************************************************
z_saleforecast4:--z_saleforecast4
	declare @t_bcustno nvarchar(50)
	declare @t_ecustno nvarchar(50)
	declare @t_bpno nvarchar(50)
	declare @t_epno nvarchar(50)
	declare @t_mon nvarchar(10)
	declare @t_year nvarchar(10)
	declare @r_len int=[2]

	set @t_bcustno = case when '#non'=[3] then '' else [3] end
	set @t_ecustno = case when '#non'=[4] then char(255) else [4] end
	set @t_bpno = case when '#non'=[5] then '' else [5] end
	set @t_epno = case when '#non'=[6] then char(255) else [6] end
	set @t_mon = case when '#non'=[9] then '' else [9] end
	set @t_year = case when '#non'=[10] then '' else [10] end
	
--*****************************************************************************************	
declare @t_oldyear nvarchar(10)--上期年度
declare @moncount int
set @t_oldyear='' 
set @moncount=1
set @t_oldyear=right('0000'+cast ((cast(@t_year as int) -1) as nvarchar(10)),@r_len)

declare @cmd nvarchar(max) 
IF OBJECT_ID('tempdb..#tmpmon')is not null
BEGIN
	set @cmd = 'drop table #tmpmon'
	EXECUTE sp_executesql @cmd
END

create table #tmpmon(
	custno nvarchar(50),
	productno nvarchar(50),
	omount float, 
	fmount float
)

declare @result table(
	gno nvarchar(1),
	custno nvarchar(50),
	comp nvarchar(50),
	pno nvarchar(50),
	product nvarchar(90),
	unit nvarchar(50),
	s01 float, 
	c01 float,
	r01 float,
	s02 float, 
	c02 float,
	r02 float,
	s03 float, 
	c03 float,
	r03 float,
	s04 float, 
	c04 float,
	r04 float,
	s05 float, 
	c05 float,
	r05 float,
	s06 float, 
	c06 float,
	r06 float,
	s07 float, 
	c07 float,
	r07 float,
	s08 float, 
	c08 float,
	r08 float,
	s09 float, 
	c09 float,
	r09 float,
	s10 float, 
	c10 float,
	r10 float,
	s11 float, 
	c11 float,
	r11 float,
	s12 float, 
	c12 float,
	r12 float,
	stotal float,
	ctotal float,
	rtotal float
)

declare @t_oldmons nvarchar(10)--去年
declare @t_mons nvarchar(10)--今年

while(@moncount<=12)
begin
	set @t_oldmons=@t_oldyear+'/'+right('0'+cast(@moncount as nvarchar(10)),2)
	set @t_mons=@t_year+'/'+right('0'+cast(@moncount as nvarchar(10)),2)
	
	insert into #tmpmon
	select c.custno,u.productno
	,(select isnull(sum(o.mount),0)mount from view_ordes o where left(o.odate,6)=@t_oldmons and o.custno=c.custno and o.productno=u.productno )--實際
	,(select isnull(sum(f.mount),0)mount from saleforecasts f where mon=@t_oldmons and f.custno=c.custno and f.productno=u.productno ) --預測
	from (select noa custno from cust)c,(select noa productno from ucc union select noa productno from uca)u
	where (c.custno between @t_bcustno and @t_ecustno) and (u.productno between @t_bpno and @t_epno)
	
	delete #tmpmon where omount=0 and fmount=0 
	
	insert #tmpmon
	select custno,productno,0,0 from saleforecasts 
	where mon=@t_mons and custno+'_'+productno not in (select custno+'_'+productno from #tmpmon)
	and (productno between @t_bpno and @t_epno) 
	group by custno,productno
	
	insert #tmpmon
	select a.custno,b.productno,0,0 from view_orde a left join view_ordes b on a.noa=b.noa 
	where (case when a.mon!='' then a.mon else left(a.odate,6) end)=@t_mons and a.custno+'_'+b.productno not in (select custno+'_'+productno from #tmpmon)
	and (b.productno between @t_bpno and @t_epno) 
	group by a.custno,b.productno
	
	if(@moncount=1)
	begin
		insert into @result(gno,custno,comp,pno,product,unit,s01,c01,r01)
		select '0',m.custno,c.nick,m.productno,u.product,u.unit
		,isnull((select SUM(mount)mount from saleforecasts f where mon=@t_mons and f.productno=m.productno and f.custno=m.custno ),0)
		,m.omount+(case when m.omount!=0 then (m.omount-m.fmount)/m.omount else 0 end)cmount 
		,isnull((select isnull(sum(o.mount),0)mount from view_ordes o where left(o.odate,6)=@t_mons and o.custno=m.custno and o.productno=m.productno),0)
		from #tmpmon m left join cust c on m.custno=c.noa 
		left join (select noa productno,product,unit from ucc union select noa productno,product,unit from uca where noa not in (select noa from ucc))u on m.productno=u.productno
	end
	if(@moncount=2)
	begin
		update a
		set s02=isnull((select SUM(mount)mount from saleforecasts f where mon=@t_mons and f.productno=b.productno and f.custno=b.custno ),0)
		,c02=isnull(b.omount,0)+isnull((case when b.omount=0 or (b.omount-b.fmount)<0 then 0 else (b.omount-b.fmount)/b.omount end),0)
		,r02=isnull((select isnull(sum(o.mount),0)mount from view_ordes o where left(o.odate,6)=@t_mons and o.custno=b.custno and o.productno=b.productno),0)
		from @result a left join #tmpmon b on a.custno=b.custno and a.pno=b.productno
	end
	if(@moncount=3)
	begin
		update a
		set s03=isnull((select SUM(mount)mount from saleforecasts f where mon=@t_mons and f.productno=b.productno and f.custno=b.custno ),0)
		,c03=isnull(b.omount,0)+isnull((case when b.omount=0 or (b.omount-b.fmount)<0 then 0 else (b.omount-b.fmount)/b.omount end),0)
		,r03=isnull((select isnull(sum(o.mount),0)mount from view_ordes o where left(o.odate,6)=@t_mons and o.custno=b.custno and o.productno=b.productno),0)
		from @result a left join #tmpmon b on a.custno=b.custno and a.pno=b.productno
	end
	if(@moncount=4)
	begin
		update a
		set s04=isnull((select SUM(mount)mount from saleforecasts f where mon=@t_mons and f.productno=b.productno and f.custno=b.custno ),0)
		,c04=isnull(b.omount,0)+isnull((case when b.omount=0 or (b.omount-b.fmount)<0 then 0 else (b.omount-b.fmount)/b.omount end),0)
		,r04=isnull((select isnull(sum(o.mount),0)mount from view_ordes o where left(o.odate,6)=@t_mons and o.custno=b.custno and o.productno=b.productno),0)
		from @result a left join #tmpmon b on a.custno=b.custno and a.pno=b.productno
	end
	if(@moncount=5)
	begin
		update a
		set s05=isnull((select SUM(mount)mount from saleforecasts f where mon=@t_mons and f.productno=b.productno and f.custno=b.custno ),0)
		,c05=isnull(b.omount,0)+isnull((case when b.omount=0 or (b.omount-b.fmount)<0 then 0 else (b.omount-b.fmount)/b.omount end),0)
		,r05=isnull((select isnull(sum(o.mount),0)mount from view_ordes o where left(o.odate,6)=@t_mons and o.custno=b.custno and o.productno=b.productno),0)
		from @result a left join #tmpmon b on a.custno=b.custno and a.pno=b.productno
	end
	if(@moncount=6)
	begin
		update a
		set s06=isnull((select SUM(mount)mount from saleforecasts f where mon=@t_mons and f.productno=b.productno and f.custno=b.custno ),0)
		,c06=isnull(b.omount,0)+isnull((case when b.omount=0 or (b.omount-b.fmount)<0 then 0 else (b.omount-b.fmount)/b.omount end),0)
		,r06=isnull((select isnull(sum(o.mount),0)mount from view_ordes o where left(o.odate,6)=@t_mons and o.custno=b.custno and o.productno=b.productno),0)
		from @result a left join #tmpmon b on a.custno=b.custno and a.pno=b.productno
	end
	if(@moncount=7)
	begin
		update a
		set s07=isnull((select SUM(mount)mount from saleforecasts f where mon=@t_mons and f.productno=b.productno and f.custno=b.custno ),0)
		,c07=isnull(b.omount,0)+isnull((case when b.omount=0 or (b.omount-b.fmount)<0 then 0 else (b.omount-b.fmount)/b.omount end),0)
		,r07=isnull((select isnull(sum(o.mount),0)mount from view_ordes o where left(o.odate,6)=@t_mons and o.custno=b.custno and o.productno=b.productno),0)
		from @result a left join #tmpmon b on a.custno=b.custno and a.pno=b.productno
	end
	if(@moncount=8)
	begin
		update a
		set s08=isnull((select SUM(mount)mount from saleforecasts f where mon=@t_mons and f.productno=b.productno and f.custno=b.custno ),0)
		,c08=isnull(b.omount,0)+isnull((case when b.omount=0 or (b.omount-b.fmount)<0 then 0 else (b.omount-b.fmount)/b.omount end),0)
		,r08=isnull((select isnull(sum(o.mount),0)mount from view_ordes o where left(o.odate,6)=@t_mons and o.custno=b.custno and o.productno=b.productno),0)
		from @result a left join #tmpmon b on a.custno=b.custno and a.pno=b.productno
	end
	if(@moncount=9)
	begin
		update a
		set s09=isnull((select SUM(mount)mount from saleforecasts f where mon=@t_mons and f.productno=b.productno and f.custno=b.custno ),0)
		,c09=isnull(b.omount,0)+isnull((case when b.omount=0 or (b.omount-b.fmount)<0 then 0 else (b.omount-b.fmount)/b.omount end),0)
		,r09=isnull((select isnull(sum(o.mount),0)mount from view_ordes o where left(o.odate,6)=@t_mons and o.custno=b.custno and o.productno=b.productno),0)
		from @result a left join #tmpmon b on a.custno=b.custno and a.pno=b.productno
	end
	if(@moncount=10)
	begin
		update a
		set s10=isnull((select SUM(mount)mount from saleforecasts f where mon=@t_mons and f.productno=b.productno and f.custno=b.custno ),0)
		,c10=isnull(b.omount,0)+isnull((case when b.omount=0 or (b.omount-b.fmount)<0 then 0 else (b.omount-b.fmount)/b.omount end),0)
		,r10=isnull((select isnull(sum(o.mount),0)mount from view_ordes o where left(o.odate,6)=@t_mons and o.custno=b.custno and o.productno=b.productno),0)
		from @result a left join #tmpmon b on a.custno=b.custno and a.pno=b.productno
	end
	if(@moncount=11)
	begin
		update a
		set s11=isnull((select SUM(mount)mount from saleforecasts f where mon=@t_mons and f.productno=b.productno and f.custno=b.custno ),0)
		,c11=isnull(b.omount,0)+isnull((case when b.omount=0 or (b.omount-b.fmount)<0 then 0 else (b.omount-b.fmount)/b.omount end),0)
		,r11=isnull((select isnull(sum(o.mount),0)mount from view_ordes o where left(o.odate,6)=@t_mons and o.custno=b.custno and o.productno=b.productno),0)
		from @result a left join #tmpmon b on a.custno=b.custno and a.pno=b.productno
	end
	if(@moncount=12)
	begin
		update a
		set s12=isnull((select SUM(mount)mount from saleforecasts f where mon=@t_mons and f.productno=b.productno and f.custno=b.custno ),0)
		,c12=isnull(b.omount,0)+isnull((case when b.omount=0 or (b.omount-b.fmount)<0 then 0 else (b.omount-b.fmount)/b.omount end),0)
		,r12=isnull((select isnull(sum(o.mount),0)mount from view_ordes o where left(o.odate,6)=@t_mons and o.custno=b.custno and o.productno=b.productno),0)
		from @result a left join #tmpmon b on a.custno=b.custno and a.pno=b.productno
	end
	
	delete #tmpmon
	set @moncount=@moncount+1
end
	delete @result 
	where isnull(s01,0)=0 and isnull(c01,0)=0 and isnull(r01,0)=0
	and isnull(s02,0)=0 and isnull(c02,0)=0 and isnull(r02,0)=0
	and isnull(s03,0)=0 and isnull(c03,0)=0 and isnull(r03,0)=0
	and isnull(s04,0)=0 and isnull(c04,0)=0 and isnull(r04,0)=0
	and isnull(s05,0)=0 and isnull(c05,0)=0 and isnull(r05,0)=0
	and isnull(s06,0)=0 and isnull(c06,0)=0 and isnull(r06,0)=0
	and isnull(s07,0)=0 and isnull(c07,0)=0 and isnull(r07,0)=0
	and isnull(s08,0)=0 and isnull(c08,0)=0 and isnull(r08,0)=0
	and isnull(s09,0)=0 and isnull(c09,0)=0 and isnull(r09,0)=0
	and isnull(s10,0)=0 and isnull(c10,0)=0 and isnull(r10,0)=0
	and isnull(s11,0)=0 and isnull(c11,0)=0 and isnull(r11,0)=0
	and isnull(s12,0)=0 and isnull(c12,0)=0 and isnull(r12,0)=0
	
	update @result
	set stotal=s01+s02+s03+s04+s05+s06+s07+s08+s09+s10+s11+s12,
	ctotal=c01+c02+c03+c04+c05+c06+c07+c08+c09+c10+c11+c12,
	rtotal=r01+r02+r03+r04+r05+r06+r07+r08+r09+r10+r11+r12
	
	insert into @result (gno,custno,pno,stotal,ctotal,rtotal)
	select '1',char(255),pno,999,999,999 from @result where stotal!=0 or ctotal !=0 or rtotal !=0 group by pno 
	
	select gno,custno,comp,pno,product,unit
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s01),1)),0,30)) s01
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s02),1)),0,30)) s02
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s03),1)),0,30)) s03
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s04),1)),0,30)) s04
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s05),1)),0,30)) s05
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s06),1)),0,30)) s06
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s07),1)),0,30)) s07
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s08),1)),0,30)) s08
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s09),1)),0,30)) s09
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s10),1)),0,30)) s10
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s11),1)),0,30)) s11
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s12),1)),0,30)) s12
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c01),1)),0,30)) c01
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c02),1)),0,30)) c02
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c03),1)),0,30)) c03
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c04),1)),0,30)) c04
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c05),1)),0,30)) c05
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c06),1)),0,30)) c06
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c07),1)),0,30)) c07
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c08),1)),0,30)) c08
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c09),1)),0,30)) c09
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c10),1)),0,30)) c10
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c11),1)),0,30)) c11
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c12),1)),0,30)) c12
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r01),1)),0,30)) r01
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r02),1)),0,30)) r02
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r03),1)),0,30)) r03
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r04),1)),0,30)) r04
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r05),1)),0,30)) r05
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r06),1)),0,30)) r06
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r07),1)),0,30)) r07
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r08),1)),0,30)) r08
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r09),1)),0,30)) r09
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r10),1)),0,30)) r10
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r11),1)),0,30)) r11
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r12),1)),0,30)) r12
	from @result 
	--where stotal!=0 or ctotal !=0 or rtotal !=0 
	order by pno,custno,gno
	
	IF OBJECT_ID('tempdb..#tmpmon')is not null
	BEGIN
		set @cmd = 'drop table #tmpmon'
		EXECUTE sp_executesql @cmd
	END
;
--*******************************************************************************************
z_saleforecast5:--z_saleforecast5
	declare @t_bpno nvarchar(50)
	declare @t_epno nvarchar(50)
	declare @t_bmon nvarchar(10)
	declare @t_emon nvarchar(10)

	set @t_bpno = case when '#non'=[5] then '' else [5] end
	set @t_epno = case when '#non'=[6] then char(255) else [6] end
	set @t_bmon = case when '#non'=[11] then '' else [11] end
	set @t_emon = case when '#non'=[12] then char(255) else [12] end
	
--*****************************************************************************************	
declare @result table(
	gno nvarchar(2),
	productno nvarchar(90),
	product nvarchar(100),
	unit nvarchar(20),
	mount float
)
insert into @result
select '0' gno,noa,product,unit,0 from ucc
where noa between @t_bpno and @t_epno
--where typea='4' or typea='5'

declare @productno nvarchar(90)
declare @mount float

declare @tmp table(
	productno nvarchar(90),
	parent nvarchar(90),
	mount float
)

insert into @tmp
select productno,noa,mount from ucas

declare cursor_table cursor for
select productno,sum(mount)mount from saleforecasts where mon between @t_bmon and @t_emon group by productno
open cursor_table
fetch next from cursor_table
into @productno,@mount
while(@@FETCH_STATUS <> -1)
begin
	delete @tmp where parent='root'

	insert into @tmp
	select @productno,'root',1

	BEGIN TRY
	--遞迴
	WITH OrdersTable (productno,noa,Level,sortCol,mount) as
	(
	 Select productno,parent,0, CONVERT(nvarchar(128),productno),mount
	 from @tmp
	 where parent='root'
	 UNION ALL
	 SELECT a.productno,a.parent,OrdersTable.Level+1,CONVERT(nvarchar(128),OrdersTable.SortCol+'-'+CONVERT(nvarchar(128),a.productno)),a.mount*OrdersTable.mount
	 FROM @tmp a, OrdersTable 
	 WHERE a.parent=OrdersTable.productno 
	)
	--Select REPLICATE('       ',Level) + productno productno, Level, SortCol,mount,@mount rootneed,(case when productno in (select noa from ucc) then mount*@mount else 0 end) need
	--Select productno,(case when productno in (select noa from ucc) then mount*@mount else 0 end) need From OrdersTable 
	
	update a
	set a.mount=a.mount+isnull(b.need,0)
	from @result a left join (Select productno,(case when productno in (select noa from ucc) then mount*@mount else 0 end) need From OrdersTable) b on a.productno=b.productno where b.productno=a.productno
	
	END TRY
	BEGIN CATCH
	 select @@ERROR productno,0 need
	END CATCH
	
	fetch next from cursor_table
	into @productno,@mount
end
close cursor_table
deallocate cursor_table

select gno,productno pno,product,unit
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),0,30)) mount
,@t_bmon btmon,@t_emon etmon
from @result where mount>0
order by productno
;
--*******************************************************************************************
z_saleforecast6:--z_saleforecast6
	declare @t_bpno nvarchar(50)
	declare @t_epno nvarchar(50)
	declare @t_xmon nvarchar(10)
	declare @r_len int=[2]
	
	set @t_bpno = case when '#non'=[5] then '' else [5] end
	set @t_epno = case when '#non'=[6] then char(255) else [6] end
	set @t_xmon = case when '#non'=[9] then '' else [9] end
	
--*****************************************************************************************	
declare @t_epremon nvarchar(10)
declare @t_bpremon nvarchar(10)

if(@r_len=4) 
begin 
	set @t_epremon=CONVERT (VARCHAR(10), dateadd (m,-1,cast(left(@t_xmon,4) +right(@t_xmon,3)+'/01' as datetime)),20 )
	set @t_epremon=left(@t_epremon,4)+'/'+substring(@t_epremon,6,2) 
	set @t_bpremon=CONVERT (VARCHAR(10), dateadd (m,-11,cast(left(@t_epremon,4)+right(@t_epremon,3)+'/01' as datetime)),20 )
	set @t_bpremon=left(@t_bpremon,4)+'/'+substring(@t_bpremon,6,2) 
end 
else
begin
	set @t_epremon=CONVERT (VARCHAR(7), dateadd (m,-1,cast( cast(cast(left(@t_xmon,3) as int)+1911 as nvarchar(10))+right(@t_xmon,3)+'/01' as datetime)),12 )+0890000 
	set @t_epremon=left(@t_epremon,3)+'/'+substring(@t_epremon,4,2) 
	set @t_bpremon=CONVERT (VARCHAR(7), dateadd (m,-11,cast( cast(cast(left(@t_epremon,3) as int)+1911 as nvarchar(10))+right(@t_epremon,3)+'/01' as datetime)),12 )+0890000 
	set @t_bpremon=left(@t_bpremon,3)+'/'+substring(@t_bpremon,4,2) 
end

declare @result table( 
	gno nvarchar(2), 
	productno nvarchar(90), 
	product nvarchar(100), 
	unit nvarchar(20), 
	fmount float,
	omount float,
	days float,
	safety_factor float,
	sqrt_days float,
	standard_deviation float,
	ss float
) 

--插入原物料前置時間
insert into @result 
select '0' gno,noa,product,unit,0,0,isnull(days,0),0,0,0,0 from ucc 
where noa between @t_bpno and @t_epno 

declare @tmp table( 
	productno nvarchar(90), 
	parent nvarchar(90), 
	mount float 
) 

insert into @tmp 
select productno,noa,mount from ucas 

declare @productno nvarchar(90) 
declare @mount float 

declare cursor_table cursor for 
select productno,sum(mount)mount from saleforecasts where mon between @t_bpremon and @t_epremon group by productno 
open cursor_table 
fetch next from cursor_table 
into @productno,@mount 
while(@@FETCH_STATUS <> -1) 
begin 
	delete @tmp where parent='root' 

	insert into @tmp 
	select @productno,'root',1 

	BEGIN TRY 
	--遞迴 
	WITH OrdersTable (productno,noa,Level,sortCol,mount) as 
	( 
		Select productno,parent,0, CONVERT(nvarchar(128),productno),mount 
		from @tmp 
		where parent='root' 
		UNION ALL 
		SELECT a.productno,a.parent,OrdersTable.Level+1,CONVERT(nvarchar(128),OrdersTable.SortCol+'-'+CONVERT(nvarchar(128),a.productno)),a.mount*OrdersTable.mount 
		FROM @tmp a, OrdersTable 
		WHERE a.parent=OrdersTable.productno 
	) 
	--Select REPLICATE(' ',Level) + productno productno, Level, SortCol,mount,@mount rootneed,(case when productno in (select noa from ucc) then mount*@mount else 0 end) need 
	--Select productno,(case when productno in (select noa from ucc) then mount*@mount else 0 end) need From OrdersTable 
	
	update a 
	set a.fmount=a.fmount+isnull(b.need,0) 
	from @result a left join (Select productno,(case when productno in (select noa from ucc) then mount*@mount else 0 end) need From OrdersTable) b on a.productno=b.productno where b.productno=a.productno 
	
	END TRY 
	BEGIN CATCH 
	select @@ERROR productno,0 need 
	END CATCH 

	fetch next from cursor_table 
	into @productno,@mount 
end 
close cursor_table 
deallocate cursor_table 

--插入製成品前置時間與預測數量
insert into @result 
select '0'gno,uca.noa,product,unit,isnull(tmp.mount,0),0,pretime,0,0,0,0 from uca left join(
select productno,sum(mount)mount
from saleforecasts f where productno not in(select noa from ucc) and mon between @t_bpremon and @t_epremon group by productno
)tmp on uca.noa=tmp.productno where uca.typea='1'

--更新實際領料
update a
set a.omount=b.mount
from @result a left join (
	select productno,sum(mount)mount from (
	select productno,mount from view_workas where (left(datea,6) between @t_bpremon and @t_epremon)
	union all
	select productno,mount from view_workcs where (left(datea,6) between @t_bpremon and @t_epremon)
	union all
	select productno,mount from view_vccs where (left(datea,6) between @t_bpremon and @t_epremon)
)tmp
group by productno) b on a.productno=b.productno where b.productno!=''

--計算安全庫存相關數值
update @result
set safety_factor=case when omount=0 then 1 else 1-((omount-fmount)/omount) end,
sqrt_days =sqrt(days),
standard_deviation =sqrt(abs((isnull(fmount*fmount,0))-(isnull(omount*omount,0)))/12)
--求得安全庫存
update @result
set ss =case 
when safety_factor>=10 then round(1.29*sqrt_days*standard_deviation,0)
when safety_factor<10 and safety_factor>=9 then round(1.34*sqrt_days*standard_deviation,0)
when safety_factor<9 and safety_factor>=8 then round(1.41*sqrt_days*standard_deviation,0)
when safety_factor<8 and safety_factor>=7 then round(1.48*sqrt_days*standard_deviation,0)
when safety_factor<7 and safety_factor>=6 then round(1.56*sqrt_days*standard_deviation,0)
when safety_factor<6 and safety_factor>=5 then round(1.65*sqrt_days*standard_deviation,0)
when safety_factor<5 and safety_factor>=4 then round(1.75*sqrt_days*standard_deviation,0)
when safety_factor<4 and safety_factor>=3 then round(1.88*sqrt_days*standard_deviation,0)
when safety_factor<3 and safety_factor>=2 then round(2.05*sqrt_days*standard_deviation,0)
else round(2.33 *sqrt_days*standard_deviation,0)
end

select gno,productno pno,product,unit
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,ss),1)),0,30)) ss ,@t_xmon xtmon
from @result where ss>0
order by productno 

;
--*******************************************************************************************
z_saleforecast7:--z_saleforecast7
	declare @t_bcustno nvarchar(50)
	declare @t_ecustno nvarchar(50)
	declare @t_bpno nvarchar(50)
	declare @t_epno nvarchar(50)
	declare @t_mon nvarchar(10)
	declare @t_year nvarchar(10)
	declare @r_len int=[2]

	set @t_bcustno = case when '#non'=[3] then '' else [3] end
	set @t_ecustno = case when '#non'=[4] then char(255) else [4] end
	set @t_bpno = case when '#non'=[5] then '' else [5] end
	set @t_epno = case when '#non'=[6] then char(255) else [6] end
	set @t_mon = case when '#non'=[9] then '' else [9] end
	set @t_year = case when '#non'=[10] then '' else [10] end

--*****************************************************************************************	
declare @t_oldmon nvarchar(10)--上期月份 

set @t_oldmon='' 

declare @cmd nvarchar(max) 
IF OBJECT_ID('tempdb..#tmpmon')is not null
BEGIN
	set @cmd = 'drop table #tmpmon'
	EXECUTE sp_executesql @cmd
END

create table #tmpmon(
	productno nvarchar(50),
	omount float, 
	fmount float
)

declare @result table(
	gno nvarchar(1),
	pno nvarchar(50),
	product nvarchar(90),
	unit nvarchar(50),
	smount float, 
	cmount float,
	rmount float
)

set @t_oldmon=right('000'+cast ((cast(left(@t_mon,@r_len) as int) -1) as nvarchar(10)),@r_len)+'/'+right(@t_mon,2)  
	
	insert into #tmpmon
	select u.productno
	,(select isnull(sum(o.mount),0)mount from view_ordes o where left(o.odate,6)=@t_oldmon and o.productno=u.productno )--實際
	,(select isnull(sum(f.mount),0)mount from saleforecasts f where mon=@t_oldmon and f.productno=u.productno ) --預測
	from (select noa productno from ucc union select noa productno from uca)u
	where (u.productno between @t_bpno and @t_epno)
	
	delete #tmpmon where omount=0 and fmount=0 
	
	insert #tmpmon
	select productno,0,0 from saleforecasts 
	where mon=@t_mon and productno not in (select productno from #tmpmon)
	and (productno between @t_bpno and @t_epno) 
	group by productno
	
	insert #tmpmon
	select b.productno,0,0 from view_orde a left join view_ordes b on a.noa=b.noa 
	where (case when a.mon!='' then a.mon else left(a.odate,6) end)=@t_mon 
	and b.productno not in (select productno from #tmpmon)
	and (b.productno between @t_bpno and @t_epno) 
	group by b.productno
	
	insert into @result
	select '9',m.productno,u.product,u.unit
	,isnull((select SUM(mount)mount from saleforecasts f where mon=@t_mon and f.productno=m.productno  ),0)
	,m.omount+(case when m.omount=0 or (m.omount-m.fmount)<0 then 0 else(m.omount-m.fmount)/m.omount end)cmount
	,(select isnull(sum(o.mount),0)mount from view_ordes o where left(o.odate,6)=@t_mon and o.productno=m.productno )
	from #tmpmon m 
	left join (select noa productno,product,unit from ucc union select noa productno,product,unit from uca where noa not in (select noa from ucc))u on m.productno=u.productno
	
	delete @result where isnull(smount,0)=0 and isnull(cmount,0)=0 and isnull(rmount,0)=0 	
	
	insert into @result (gno,pno,product,smount,cmount,rmount)
	select '0',pno,MAX(product),sum(smount),sum(cmount),sum(rmount) from @result group by pno 

	select gno,pno,product,unit
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,smount),1)),0,30)) smount
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,cmount),1)),0,30)) cmount
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,rmount),1)),0,30)) rmount
	from @result order by pno,gno
	
	IF OBJECT_ID('tempdb..#tmpmon')is not null
	BEGIN
		set @cmd = 'drop table #tmpmon'
		EXECUTE sp_executesql @cmd
	END
;
--*******************************************************************************************
z_saleforecast8:--z_saleforecast8
	SET QUOTED_IDENTIFIER OFF
	declare @t_bsalesno nvarchar(50)
	declare @t_esalesno nvarchar(50)
	declare @t_bpno nvarchar(50)
	declare @t_epno nvarchar(50)
	declare @t_year nvarchar(10)
	declare @r_len int=[2]
	declare @r_lem int=@r_len+3 

	set @t_bsalesno = case when '#non'=[7] then '' else [7] end
	set @t_esalesno = case when '#non'=[8] then char(255) else [8] end
	set @t_bpno = case when '#non'=[5] then '' else [5] end
	set @t_epno = case when '#non'=[6] then char(255) else [6] end
	set @t_year = case when '#non'=[10] then '' else [10] end
	
--*****************************************************************************************	
declare @cmd nvarchar(max) 
IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
	set @cmd = 'drop table #tmp'
	EXECUTE sp_executesql @cmd
END

create table #tmp(
	gno nvarchar(1),
	salgroup nvarchar(50),
	salesno nvarchar(50),
	salesname nvarchar(50),
	s01 float, 
	c01 float,
	r01 float,
	s02 float, 
	c02 float,
	r02 float,
	s03 float, 
	c03 float,
	r03 float,
	s04 float, 
	c04 float,
	r04 float,
	s05 float, 
	c05 float,
	r05 float,
	s06 float, 
	c06 float,
	r06 float,
	s07 float, 
	c07 float,
	r07 float,
	s08 float, 
	c08 float,
	r08 float,
	s09 float, 
	c09 float,
	r09 float,
	s10 float, 
	c10 float,
	r10 float,
	s11 float, 
	c11 float,
	r11 float,
	s12 float, 
	c12 float,
	r12 float,
	stotal float,
	ctotal float,
	rtotal float
)

declare @moncount int
set @moncount=1
declare @t_mons nvarchar(10)
declare @t_n nvarchar(10)

while(@moncount<=12)
begin
	set @t_mons=@t_year+'/'+right('0'+cast(@moncount as nvarchar(10)),2)	
	set @t_n=right('0'+cast(@moncount as nvarchar(10)),2)
	
	EXEC("insert into #tmp(gno,salesno,s"+@t_n+")
	select '9',a.salesno,SUM(b.mount)
	from saleforecast a left join saleforecasts b on a.noa=b.noa 
	where a.mon='"+@t_mons+"' and a.salesno between '"+@t_bsalesno+"' and '"+@t_esalesno+"'
	and b.productno between '"+@t_bpno+"' and '"+@t_epno+"'
	group by a.salesno")
	
	EXEC("insert into #tmp(gno,salesno,c"+@t_n+")
	select '9',a.salesno,SUM(b.mount)
	from view_vcc a left join view_vccs b on a.noa=b.noa 
	where left(a.datea,"+@r_lem+")='"+@t_mons+"' and a.salesno between '"+@t_bsalesno+"' and '"+@t_esalesno+"'
	and b.productno between '"+@t_bpno+"' and '"+@t_epno+"'
	group by a.salesno")
	
	set @moncount=@moncount+1
end

insert #tmp (gno,salesno
,s01,c01,r01,s02,c02,r02,s03,c03,r03,s04,c04,r04,s05,c05,r05,s06,c06,r06
,s07,c07,r07,s08,c08,r08,s09,c09,r09,s10,c10,r10,s11,c11,r11,s12,c12,r12)
select '0',salesno
,SUM(isnull(s01,0)),SUM(isnull(c01,0)),SUM(isnull(s01,0)-isnull(c01,0)),SUM(isnull(s02,0)),SUM(isnull(c02,0)),SUM(isnull(s02,0)-isnull(c02,0)),SUM(isnull(s03,0)),SUM(isnull(c03,0)),SUM(isnull(s03,0)-isnull(c03,0))
,SUM(isnull(s04,0)),SUM(isnull(c04,0)),SUM(isnull(s04,0)-isnull(c04,0)),SUM(isnull(s05,0)),SUM(isnull(c05,0)),SUM(isnull(s05,0)-isnull(c05,0)),SUM(isnull(s06,0)),SUM(isnull(c06,0)),SUM(isnull(s06,0)-isnull(c06,0))
,SUM(isnull(s07,0)),SUM(isnull(c07,0)),SUM(isnull(s07,0)-isnull(c07,0)),SUM(isnull(s08,0)),SUM(isnull(c08,0)),SUM(isnull(s08,0)-isnull(c08,0)),SUM(isnull(s09,0)),SUM(isnull(c09,0)),SUM(isnull(s09,0)-isnull(c09,0))
,SUM(isnull(s10,0)),SUM(isnull(c10,0)),SUM(isnull(s10,0)-isnull(c10,0)),SUM(isnull(s11,0)),SUM(isnull(c11,0)),SUM(isnull(s11,0)-isnull(c11,0)),SUM(isnull(s12,0)),SUM(isnull(c12,0)),SUM(isnull(s12,0)-isnull(c12,0))
from #tmp group by salesno

delete #tmp where gno!='0'

update a
set a.salesname=b.namea ,a.salgroup=b.salesgroup
from #tmp a left join sss b on a.salesno=b.noa

delete #tmp 
where isnull(s01,0)=0 and isnull(c01,0)=0 and isnull(r01,0)=0
and isnull(s02,0)=0 and isnull(c02,0)=0 and isnull(r02,0)=0
and isnull(s03,0)=0 and isnull(c03,0)=0 and isnull(r03,0)=0
and isnull(s04,0)=0 and isnull(c04,0)=0 and isnull(r04,0)=0
and isnull(s05,0)=0 and isnull(c05,0)=0 and isnull(r05,0)=0
and isnull(s06,0)=0 and isnull(c06,0)=0 and isnull(r06,0)=0
and isnull(s07,0)=0 and isnull(c07,0)=0 and isnull(r07,0)=0
and isnull(s08,0)=0 and isnull(c08,0)=0 and isnull(r08,0)=0
and isnull(s09,0)=0 and isnull(c09,0)=0 and isnull(r09,0)=0
and isnull(s10,0)=0 and isnull(c10,0)=0 and isnull(r10,0)=0
and isnull(s11,0)=0 and isnull(c11,0)=0 and isnull(r11,0)=0
and isnull(s12,0)=0 and isnull(c12,0)=0 and isnull(r12,0)=0

insert #tmp (gno,salgroup
,s01,c01,r01,s02,c02,r02,s03,c03,r03,s04,c04,r04,s05,c05,r05,s06,c06,r06
,s07,c07,r07,s08,c08,r08,s09,c09,r09,s10,c10,r10,s11,c11,r11,s12,c12,r12)
select '1',salgroup
,SUM(s01),SUM(c01),SUM(r01),SUM(s02),SUM(c02),SUM(r02),SUM(s03),SUM(c03),SUM(r03)
,SUM(s04),SUM(c04),SUM(r04),SUM(s05),SUM(c05),SUM(r05),SUM(s06),SUM(c06),SUM(r06)
,SUM(s07),SUM(c07),SUM(r07),SUM(s08),SUM(c08),SUM(r08),SUM(s09),SUM(c09),SUM(r09)
,SUM(s10),SUM(c10),SUM(r10),SUM(s11),SUM(c11),SUM(r11),SUM(s12),SUM(c12),SUM(r12)
from #tmp group by salgroup
	
update #tmp
set stotal=s01+s02+s03+s04+s05+s06+s07+s08+s09+s10+s11+s12,
ctotal=c01+c02+c03+c04+c05+c06+c07+c08+c09+c10+c11+c12,
rtotal=r01+r02+r03+r04+r05+r06+r07+r08+r09+r10+r11+r12
	
	
select gno,salgroup,salesno,salesname
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s01),1)),0,30)) s01
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s02),1)),0,30)) s02
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s03),1)),0,30)) s03
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s04),1)),0,30)) s04
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s05),1)),0,30)) s05
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s06),1)),0,30)) s06
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s07),1)),0,30)) s07
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s08),1)),0,30)) s08
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s09),1)),0,30)) s09
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s10),1)),0,30)) s10
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s11),1)),0,30)) s11
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,s12),1)),0,30)) s12
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c01),1)),0,30)) c01
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c02),1)),0,30)) c02
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c03),1)),0,30)) c03
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c04),1)),0,30)) c04
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c05),1)),0,30)) c05
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c06),1)),0,30)) c06
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c07),1)),0,30)) c07
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c08),1)),0,30)) c08
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c09),1)),0,30)) c09
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c10),1)),0,30)) c10
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c11),1)),0,30)) c11
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,c12),1)),0,30)) c12
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r01),1)),0,30)) r01
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r02),1)),0,30)) r02
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r03),1)),0,30)) r03
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r04),1)),0,30)) r04
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r05),1)),0,30)) r05
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r06),1)),0,30)) r06
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r07),1)),0,30)) r07
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r08),1)),0,30)) r08
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r09),1)),0,30)) r09
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r10),1)),0,30)) r10
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r11),1)),0,30)) r11
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,r12),1)),0,30)) r12
from #tmp 
order by salgroup,gno,salesno

IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
	set @cmd = 'drop table #tmp'
	EXECUTE sp_executesql @cmd
END
;
--*******************************************************************************************