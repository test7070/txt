z_vcc1:--z_vcc1
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) =''
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
declare @t_bmon nvarchar(10)
declare @t_emon nvarchar(10)
if (@r_len='4')
	set @r_lenm='7'

--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
--後面改為根據小數點位來看
declare @mount_decimal int = 2
declare @weight_decimal int = 2
declare @price_decimal int = 2
declare @total_decimal int = 0

if(charindex('永勝',@t_acomp)>0)
begin
	set @mount_decimal =0
	set @weight_decimal =0
	set @price_decimal =0
end
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @mount_decimal =0
	
if(charindex('彩虹',@t_acomp)>0)
begin
	set @mount_decimal =0
	set @weight_decimal =0
	set @price_decimal = 3
	set @total_decimal = 0
end
--------------------------------------------------
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @qhref_acomp='_it'
if(charindex('永勝',@t_acomp)>0)
	set @qhref_acomp='_uu'
if(charindex('楊家',@t_acomp)>0 or charindex('德芳',@t_acomp)>0)
	set @qhref_acomp='_tn'
if(charindex('有達',@t_acomp)>0 )
	set @qhref_acomp='_xy'
if(charindex('義橋',@t_acomp)>0 )
	set @qhref_acomp='_yc'
if(charindex('彩虹',@t_acomp)>0 )
	set @qhref_acomp='_rb'
-------------------------------------------------
set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
set @t_bmon = case when '#non' = [6] then '' else [6]+',' end
set @t_emon = case when '#non' = [7] then '' else [7]+',' end
--***********************************************************************************
SET QUOTED_IDENTIFIER OFF

IF OBJECT_ID('tempdb..#result')is not null
BEGIN
	drop table #result
END

create table #result(
	gno nvarchar(10),
	noa nvarchar(30),
	noq nvarchar(10),
	typea nvarchar(12),
	datea nvarchar(10),
	mon nvarchar(7),
	custno nvarchar(30),
	comp nvarchar(90),
	productno nvarchar(30),
	xproduct nvarchar(MAX),
	unit nvarchar(12),
	mount float,
	weight float,
	price float,
	total float,
	qhref nvarchar(max),
	invono nvarchar(MAX),
	idate nvarchar(30),
	imoney float,
	itax float,
	itotal float
)

	insert into #result
	select '91' gno, a.noa noa, b.noq noq, a.typea typea, a.datea datea, (case when a.mon='' then left(a.datea,@r_lenm) else a.mon end), a.custno, a.comp
		,dbo.charbr(b.productno,10), b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end), b.unit, 
		   b.mount, b.weight, b.price, b.total,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
		   ,a.invono+(case when charindex('彩虹',@t_acomp)>0 and len(isnull(a.part2,''))>0 then+'#'+a.part2 else '' end)
		   ,v.datea,v.money,v.tax,v.total
	from view_vccs b
	left join view_vcc a on a.noa = b.noa
	left join view_ucaucc c on b.productno = c.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	left join vcca v on a.invono=v.noa
	where (a.datea between @t_bdate and @t_edate) and
		  (a.custno between @t_bcustno and @t_ecustno) and
		  (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and
		  (b.productno between @t_bproductno and @t_eproductno) and
		  (len(@t_groupano)=0 or c.groupano = @t_groupano) and
		  (len(@t_groupbno)=0 or c.groupbno = @t_groupbno) and
		  (len(@t_groupcno)=0 or c.groupcno = @t_groupcno) and
		  (len(@t_typea)=0 or isnull(c.typea,'null') = @t_typea) and (len(@t_stype)=0 or a.stype = @t_stype) 
		  and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
		  and (isnull(c.tggno,'') between @t_btggno and @t_etggno) and (len(@vcctypea)=0 or a.typea = @vcctypea) 
		  and (len(@t_partno)=0 or s.partno=@t_partno)
		  and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
		  and (a.mon between @t_bmon and @t_emon)
	order by a.datea,gno,noa,noq
	
if(@t_showinvono='1')
begin
		
	if(charindex('彩虹',@t_acomp)>0) --多張發票 也要抓vcct
	begin
		insert #result(gno,datea,noa,noq,invono,idate,imoney,itax,itotal)
		select '92',a.datea,a.noa,'ZZZ',b.noa,b.datea,b.money,b.tax,b.total
		from vcca b outer apply (select top 1 * from #result where charindex(b.noa,invono)>0)a
		where b.datea >= dbo.q_cdn(@t_bdate,-61) --加快速度 最多取前2個月
		and exists (select * from #result where charindex(b.noa,invono)>0)
		
		insert #result(gno,datea,noa,noq,invono,idate,imoney,itax,itotal)
		select '92',a.datea,a.noa,'ZZZ',b.noa,b.datea,b.money,b.tax,b.total
		from vcct b outer apply (select top 1 * from #result where charindex(b.noa,invono)>0)a
		where b.typea='2' and kind!='33' and kind!='34' and kind!='38' 
		and b.datea >= dbo.q_cdn(@t_bdate,-61) --加快速度 最多取前2個月
		and not exists (select * from #result where gno='92' and invono=b.noa) --排除以寫入的vcca
		and exists (select * from #result where gno='91' and charindex(b.noa,invono)>0)
	end
	else
	begin
		insert into #result(gno,datea,noa,noq,invono,idate,imoney,itax,itotal)
		select '92',datea,noa,'ZZZ',invono,idate,imoney,itax,itotal
		from #result group by datea,noa,invono,idate,imoney,itax,itotal
	end
	
end
	
insert into #result(gno,datea,noa,mount,price,total)
	select '93',datea,'ZZZZZZZZZZZZ',
		sum((case typea when '1' then mount else (-1)*mount end)),
		sum((case typea when '1' then price else (-1)*price end)),
		sum((case typea when '1' then total else (-1)*total end))
	from #result group by datea
	
insert into #result(gno,datea,noa,mount,price,total)
	select '94',left(datea,@r_lenm)+'z','ZZZZZZZZZZZZ',sum(mount),sum(price),sum(total)
	from #result a where gno='93' group by left(datea,@r_lenm)
--*************************************************************************	
update #result set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'
update #result set gno='0' where gno='91'
update #result set gno='1' where gno='92'
update #result set gno='2' where gno='93'
update #result set gno='3' where gno='94'

update #result
set mount=mount*-1,total=total*-1
where typea='退'

select gno, noa, noq, typea, datea, LEFT(datea,@r_lenm) xdatea, mon, custno, left(comp,10) comp, productno, xproduct,unit,qhref
	,dbo.getComma(mount,0) mount 
	,dbo.getComma(weight,0) weight 
	,dbo.getComma(price,@price_decimal) price 
	,dbo.getComma(total,@total_decimal) total 
	,invono,idate
	,dbo.getComma(imoney,@total_decimal) imoney 
	,dbo.getComma(itax,@total_decimal) itax 
	,dbo.getComma(itotal,@total_decimal) itotal  
from #result order by datea,noa,noq

IF OBJECT_ID('tempdb..#result')is not null
BEGIN
	drop table #result
END

;
--*********************************************************************************************************
z_vcc2:--z_vcc2
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bsalesno nvarchar(20)
	declare @t_esalesno nvarchar(20)
	declare @t_bproductno nvarchar(30)
	declare @t_eproductno nvarchar(30)
	declare @t_btggno nvarchar(50)
	declare @t_etggno nvarchar(50)
	declare @t_typea nvarchar(30)
	declare @t_groupano nvarchar(30)
	declare @t_groupbno nvarchar(30)
	declare @t_groupcno nvarchar(30)
	declare @t_stype nvarchar(30)
	declare @t_salesgroup nvarchar(100)
	declare @t_showinvono nvarchar(10)
	declare @vcctypea nvarchar(10) =''
	declare @r_len nvarchar(10)='[28]'
	declare @r_lenm nvarchar(10)='6'
	if (@r_len='4')
		set @r_lenm='7'
	set @t_bdate = case when '#non'=[4] then '' else [4] end
	set @t_edate = case when '#non'=[5] then char(255) else [5] end
	set @t_bcustno = case when '#non'=[8] then '' else [8] end
	set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
	set @t_bsalesno = case when '#non'=[10] then '' else [10] end
	set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
	set @t_bproductno = case when '#non'=[12] then '' else [12] end
	set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
	set @t_btggno = case when '#non' = [14] then '' else [14] end
	set @t_etggno = case when '#non' = [15] then char(255) else [15] end
	set @t_typea = case when '#non'=[16] then '' else [16] end
	set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
	set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
	set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
	set @t_stype = case when '#non'=[20] then '' else [20] end
	set @t_salesgroup = case when '#non' = [21] then '' else [21] end
	set @t_showinvono = case when '#non' = [24] then 0 else [24] end
	set @vcctypea = case when '#non' = [22] then '' else [22] end
	--***********************************************************************************
	declare @result table(
		gno nvarchar(1),
		typea nvarchar(4),
		noa nvarchar(15),
		noq nvarchar(3),
		datea nvarchar(10),
		mon nvarchar(7),
		custno nvarchar(20),
		comp nvarchar(90),
		addr_invo nvarchar(90),
		tel nvarchar(90),
		productno nvarchar(30),
		xproduct nvarchar(40),
		unit nvarchar(8),
		mount float,
		weight float,
		price float,
		total float,
		money float,
		back float,
		tax float,
		total1 float,
		pay float,
		unpay float,
		total2 float,
		pcount int,
		qhref nvarchar(MAX)
		primary key (custno,gno,mon,datea,noa,noq) 
	)
	
	insert into @result
	select '0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, (case when a.mon='' then left(a.datea,@r_lenm) else a.mon end) mon, 
		   (case when a.custno2!='' then a.custno2 else a.custno end) custno
		   , isnull(c.comp,''), isnull(c.addr_invo,''), isnull(c.tel,''), b.productno, b.product, b.unit, 
	       b.mount, b.weight, b.price, b.total, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount,'vcc?noa=$noa?'+a.accy
	from view_vccs b
	left join view_vcc a on a.noa = b.noa
	left join cust c on  (case when a.custno2!='' then a.custno2 else a.custno end) = c.noa
	where (a.datea between @t_bdate and @t_edate) and
		  ((case when a.mon='' then left(a.datea,@r_lenm) else a.mon end) between @t_bmon and @t_emon) and
		  (a.custno between @t_bcustno and @t_ecustno) and
		  (a.salesno between @t_bsalesno and @t_esalesno) and
		  (b.productno between @t_bproductno and @t_eproductno) and (len(@vcctypea)=0 or a.typea = @vcctypea) 
	union all --無發票系統
	select '0' gno, '稅' typea, noa, CHAR(255) noq, datea, (case when mon='' then left(datea,@r_lenm) else mon end), 
		    (case when custno2!='' then custno2 else custno end),  
		     (case when custno2!='' then comp2 else comp end),
		     '' addr_invo, '' tel, '' productno, '稅額' product, '' unit, 
		   0 mount, 0 weight, 0 price, tax, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount,'vcc?noa=$noa?'
	from view_vcc
	where tax > 0 and (taxtype='1' or taxtype='5') and
		  (datea between @t_bdate and @t_edate)and
		  ((case when mon='' then left(datea,@r_lenm) else mon end) between @t_bmon and @t_emon) and
		  ((case when custno2!='' then custno2 else custno end) between @t_bcustno and @t_ecustno)
	union all --有發票系統
	select '0' gno, '稅' typea, noa, '' noq, datea, (case when mon='' then left(datea,@r_lenm) else mon end), 
		   custno, comp, '' addr_invo, '' tel, '' productno, '稅額' product, '' unit, 
		   0 mount, 0 weight, 0 price, tax, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount,'vcca?noa=$noa?'
	from vcca 
	where tax > 0 and (taxtype='1' or taxtype='5') and [2]!=3 and
			(datea between @t_bdate and @t_edate)and
		  ((case when mon='' then left(datea,@r_lenm) else mon end) between @t_bmon and @t_emon) and
		  (custno between @t_bcustno and @t_ecustno)
		  and noa not in (select invono from view_vcc where tax > 0 and
		  (datea between @t_bdate and @t_edate)and
		  ((case when mon='' then left(datea,@r_lenm) else mon end) between @t_bmon and @t_emon) and
		  (custno between @t_bcustno and @t_ecustno) ) 	    	  
	order by custno,gno,mon,datea,noa,noq

	--***********************************************************************
	declare @gno nvarchar(1)
	declare @typea nvarchar(4)
	declare @noa nvarchar(15)
	declare @total float
	declare @mon nvarchar(7)
	declare @custno nvarchar(20)
	declare @comp nvarchar(90)
	declare @t_custno nvarchar(20)
	declare @t_comp nvarchar(90)
	declare @t_money float
	declare @t_back float
	declare @t_tax float
	declare @t_total1 float
	declare @t_pay float
	declare @t_unpay float
	declare @t_total2 float
	declare @t_pcount int
	set @t_custno = '#zzzz#zzzz'
	set @t_comp = ''
	set @t_money = 0
	set @t_back = 0
	set @t_tax = 0
	set @t_total1 = 0
	set @t_pay = 0
	set @t_unpay = 0
	set @t_total2 = 0
	set @t_pcount = 0
	--***********************************************************************
	declare cursor_table cursor for
	select gno,typea,custno,comp,mon,total from @result
	open cursor_table
	fetch next from cursor_table
	into @gno,@typea,@custno,@comp,@mon,@total
	while(@@FETCH_STATUS <> -1)
	begin
		if @t_custno != @custno
		begin
			if @t_custno != '#zzzz#zzzz'
			begin
				set @t_total1 = @t_money - @t_back + @t_tax
				insert into @result
				select '1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, @t_custno, @t_comp comp, '' addr_invo, '' tel, 
				       '' productno, '' product, '' unit, 0 mount, 0 weight, 0 price, 0 total, 
					   @t_money, @t_back, @t_tax, @t_total1, 0 pay, 0 unpay, 0 total2, @t_pcount,''
			end
			set @t_custno = @custno
			set @t_comp = @comp
			set @t_money = case when @typea = '1' then @total else 0 end
			set @t_back = case when @typea = '2' then @total else 0 end
			set @t_tax = case when @typea = '稅' then @total else 0 end
			set @t_pcount = 1
		end
		else
		begin
			set @t_money = @t_money + case when @typea = '1' then @total else 0 end
			set @t_back = @t_back + case when @typea = '2' then @total else 0 end
			set @t_tax = @t_tax + case when @typea = '稅' then @total else 0 end
			set @t_pcount = @t_pcount + 1
		end
		fetch next from cursor_table
		into @gno,@typea,@custno,@comp,@mon,@total
	end
	close cursor_table
	deallocate cursor_table
	
	if @t_custno != '#zzzz#zzzz'
	begin
		set @t_total1 = @t_money - @t_back + @t_tax
		insert into @result
		select '1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, @t_custno, @t_comp comp, '' addr_invo, '' tel, 
		       '' productno, '' product, '' unit, 0 mount, 0 weight, 0 price, 0 total, 
			   @t_money, @t_back, @t_tax, @t_total1, 0 pay, 0 unpay, 0 total2, @t_pcount,''
	end
	--***********************************************************************
	update @result set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'
	--已收款 
	update a
	set pay=isnull((select SUM(paysale) from umms where vccno in(select noa from @result where custno=a.custno)),0)
	+isnull((select SUM(ub.paysale) from umm ua left join umms ub on ua.noa=ub.noa where left(ub.vccno,len(a.custno))=a.custno and ua.datea  between @t_bdate and @t_edate and case when ua.mon!='' then ua.mon else left(ua.datea,@r_lenm) end between @t_bmon and @t_emon ),0)
	from @result a where a.gno='1'
	--*******************************************************************************
	--前期
		declare @tmp table(
		gno nvarchar(1),
		typea nvarchar(4),
		noa nvarchar(15),
		noq nvarchar(3),
		datea nvarchar(10),
		mon nvarchar(7),
		custno nvarchar(20),
		comp nvarchar(90),
		addr_invo nvarchar(90),
		tel nvarchar(90),
		productno nvarchar(30),
		xproduct nvarchar(40),
		unit nvarchar(8),
		mount float,
		weight float,
		price float,
		total float,
		money float,
		back float,
		tax float,
		total1 float,
		pay float,
		unpay float,
		total2 float,
		pcount int,
		qhref nvarchar(MAX)
		primary key (custno,gno,mon,datea,noa,noq) 
	)
	
	insert into @tmp
	select '0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, (case when a.mon='' then left(a.datea,@r_lenm) else a.mon end) mon, 
		   a.custno custno, isnull(c.comp,''), isnull(c.addr_invo,''), isnull(c.tel,''), b.productno, b.product, b.unit, 
	       b.mount, b.weight, b.price, b.total, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount,'vcc?noa=$noa?'+a.accy
	from view_vccs b
	left join view_vcc a on a.noa = b.noa
	left join cust c on  a.custno = c.noa
	where (a.datea < @t_bdate ) and
		  ((case when a.mon='' then left(a.datea,@r_lenm) else a.mon end) < @t_bmon ) and
		  (a.custno between @t_bcustno and @t_ecustno) and
		  (a.salesno between @t_bsalesno and @t_esalesno) and
		  (b.productno between @t_bproductno and @t_eproductno)
	union all
	select '0' gno, '稅' typea, noa, CHAR(255) noq, datea, (case when mon='' then left(datea,@r_lenm) else mon end), 
		   custno, comp, '' addr_invo, '' tel, '' productno, '稅額' product, '' unit, 
		   0 mount, 0 weight, 0 price, tax, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount,'vcc?noa=$noa?'
	from view_vcc
	where tax > 0 and
		  (datea < @t_bdate) and (taxtype='1' or taxtype='5') and
		  ((case when mon='' then left(datea,@r_lenm) else mon end) < @t_bmon) and
		  (custno between @t_bcustno and @t_ecustno) 
	union all
	select '0' gno, '稅' typea, noa, '' noq, datea, (case when mon='' then left(datea,@r_lenm) else mon end), 
		   custno, comp, '' addr_invo, '' tel, '' productno, '稅額' product, '' unit, 
		   0 mount, 0 weight, 0 price, tax, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount,'vcca?noa=$noa?' 
	from vcca
	where tax > 0 and [2]!=3 and
			(datea < @t_bdate) and (taxtype='1' or taxtype='5') and
		  ((case when mon='' then left(datea,@r_lenm) else mon end) < @t_bmon ) and
		  (custno between @t_bcustno and @t_ecustno)	  	    	  
	order by custno,gno,mon,datea,noa,noq

	--***********************************************************************
	set @t_custno = '#zzzz#zzzz'
	set @t_comp = ''
	set @t_money = 0
	set @t_back = 0
	set @t_tax = 0
	set @t_total1 = 0
	set @t_pay = 0
	set @t_unpay = 0
	set @t_total2 = 0
	set @t_pcount = 0
	declare cursor_table cursor for
	select gno,typea,custno,comp,mon,total from @tmp
	open cursor_table
	fetch next from cursor_table
	into @gno,@typea,@custno,@comp,@mon,@total
	while(@@FETCH_STATUS <> -1)
	begin
		if @t_custno != @custno
		begin
			if @t_custno != '#zzzz#zzzz'
			begin
				set @t_total1 = @t_money - @t_back + @t_tax
				insert into @tmp
				select '1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, @t_custno, @t_comp comp, '' addr_invo, '' tel, 
				       '' productno, '' product, '' unit, 0 mount, 0 weight, 0 price, 0 total, 
					   @t_money, @t_back, @t_tax, @t_total1, 0 pay, 0 unpay, 0 total2, @t_pcount,''
			end
			set @t_custno = @custno
			set @t_comp = @comp
			set @t_money = case when @typea = '1' then @total else 0 end
			set @t_back = case when @typea = '2' then @total else 0 end
			set @t_tax = case when @typea = '稅' then @total else 0 end
			set @t_pcount = 1
		end
		else
		begin
			set @t_money = @t_money + case when @typea = '1' then @total else 0 end
			set @t_back = @t_back + case when @typea = '2' then @total else 0 end
			set @t_tax = @t_tax + case when @typea = '稅' then @total else 0 end
			set @t_pcount = @t_pcount + 1
		end
		fetch next from cursor_table
		into @gno,@typea,@custno,@comp,@mon,@total
	end
	close cursor_table
	deallocate cursor_table
	
	if @t_custno != '#zzzz#zzzz'
	begin
		set @t_total1 = @t_money - @t_back + @t_tax
		insert into @tmp
		select '1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, @t_custno, @t_comp comp, '' addr_invo, '' tel, 
		       '' productno, '' product, '' unit, 0 mount, 0 weight, 0 price, 0 total, 
			   @t_money, @t_back, @t_tax, @t_total1, 0 pay, 0 unpay, 0 total2, @t_pcount,''
	end
	--***********************************************************************
	update @tmp set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'
	--已收款 
	update a
	set pay=isnull((select SUM(paysale) from umms where vccno in(select noa from @result where custno=a.custno)),0)
	+isnull((select SUM(ub.paysale) from umm ua left join umms ub on ua.noa=ub.noa where left(ub.vccno,len(a.custno))=a.custno and ua.datea  < @t_bdate and case when ua.mon!='' then ua.mon else left(ua.datea,@r_lenm) end < @t_bmon ),0)
	from @tmp a where a.gno='1'
	
	update a
	set unpay=isnull((select total1-pay from @tmp where custno=a.custno and gno='1'),0)
	from @result a where a.gno='1'
	
	update @result
	set total2=total1+unpay-pay 
	where gno='1'
	
	
	update @result
	set mount=mount*-1,total=total*-1
	where typea='退'
	
	select 
	gno,typea,noa,noq,datea,mon,custno,comp,addr_invo,tel,productno,xproduct,unit
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),0,30)) mount 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,weight),1)),0,30)) weight 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,price),1)),0,30)) price 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),4,30)) total 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,money),1)),4,30)) money 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,back),1)),4,30)) back 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,tax),1)),4,30)) tax 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total1),1)),4,30)) total1 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,pay),1)),4,30)) pay 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,unpay),1)),4,30)) unpay 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total2),1)),4,30)) total2 
	,pcount,qhref
	from @result order by custno,gno,mon,datea,noa,noq;
--**************************************************************************************************
z_vcc3:--z_vcc3
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bsalesno nvarchar(20)
	declare @t_esalesno nvarchar(20)
	declare @t_bproductno nvarchar(30)
	declare @t_eproductno nvarchar(30)
	declare @t_btggno nvarchar(50)
	declare @t_etggno nvarchar(50)
	declare @t_typea nvarchar(30)
	declare @t_groupano nvarchar(30)
	declare @t_groupbno nvarchar(30)
	declare @t_groupcno nvarchar(30)
	declare @t_stype nvarchar(30)
	declare @t_salesgroup nvarchar(100)
	declare @t_showinvono nvarchar(10)
	declare @t_acomp nvarchar(MAX)='[3]'
	declare @qhref_acomp nvarchar(10) =''
	declare @vcctypea nvarchar(10) =''
	declare @t_partno nvarchar(30)
	declare @isspec nvarchar(10)='[25]'
	declare @t_multcust nvarchar(max)
	declare @t_multucc nvarchar(max)
	declare @r_len nvarchar(10)='[28]'
	declare @r_lenm nvarchar(10)='6'
	if (@r_len='4')
		set @r_lenm='7'
	
	set @t_bdate = case when '#non'=[4] then '' else [4] end
	set @t_edate = case when '#non'=[5] then char(255) else [5] end
	set @t_bcustno = case when '#non'=[8] then '' else [8] end
	set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
	set @t_bsalesno = case when '#non'=[10] then '' else [10] end
	set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
	set @t_bproductno = case when '#non'=[12] then '' else [12] end
	set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
	set @t_btggno = case when '#non' = [14] then '' else [14] end
	set @t_etggno = case when '#non' = [15] then char(255) else [15] end
	set @t_typea = case when '#non'=[16] then '' else [16] end
	set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
	set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
	set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
	set @t_stype = case when '#non'=[20] then '' else [20] end
	set @t_salesgroup = case when '#non' = [21] then '' else [21] end
	set @t_showinvono = case when '#non' = [24] then 0 else [24] end
	set @vcctypea = case when '#non' = [22] then '' else [22] end
	set @t_partno = case when '#non' = [23] then '' else [23] end
	set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
	set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

if(charindex('永勝',@t_acomp)>0)
begin
	set @mount_decimal =4
	set @weight_decimal =4
	set @price_decimal =4
end
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @mount_decimal =4
--------------------------------------------------
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @qhref_acomp='_it'
if(charindex('永勝',@t_acomp)>0)
	set @qhref_acomp='_uu'
if(charindex('楊家',@t_acomp)>0 or charindex('德芳',@t_acomp)>0)
	set @qhref_acomp='_tn'
if(charindex('有達',@t_acomp)>0 )
	set @qhref_acomp='_xy'
if(charindex('彩虹',@t_acomp)>0 )
	set @qhref_acomp='_rb'
-------------------------------------------------
	SET QUOTED_IDENTIFIER OFF
	
	declare @result table(
		gno nvarchar(1),
		typea nvarchar(4),
		noa nvarchar(15),
		noq nvarchar(3),
		datea nvarchar(10),
		mon nvarchar(7),
		custno nvarchar(20),
		comp nvarchar(90),
		addr_invo nvarchar(90),
		tel nvarchar(90),
		productno nvarchar(30),
		xproduct nvarchar(MAX),
		unit nvarchar(8),
		mount float,
		weight float,
		price float,
		total float,
		money float,
		back float,
		tax float,
		total1 float,
		pay float,
		unpay float,
		total2 float,
		pcount int,
		qhref nvarchar(MAX)
		primary key (custno,productno,gno,datea,noa,noq) 
	)
	
	insert into @result
	select '0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, a.mon mon, 
		   a.custno custno, isnull(c.comp,''), isnull(c.addr_invo,''), isnull(c.tel,''),dbo.charbr(b.productno,9)
		   , b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
		   , b.unit,b.mount, b.weight, b.price, b.total, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
	       ,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vccs b
	left join view_vcc a on a.noa = b.noa
	left join cust c on  a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
		  (a.custno between @t_bcustno and @t_ecustno) and
		  (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and
		  (b.productno between @t_bproductno and @t_eproductno) and
		  (len(@t_groupano)=0 or d.groupano = @t_groupano) and 
		  (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and
		  (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea) and (len(@t_stype)=0 or a.stype = @t_stype) 
		  and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
		  and (isnull(d.tggno,'') between @t_btggno and @t_etggno) and (len(@vcctypea)=0 or a.typea = @vcctypea) 
		  and (len(@t_partno)=0 or s.partno=@t_partno)
		  and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by custno,productno,gno,datea,noa,noq
	--***********************************************************************
	declare @gno nvarchar(1)
	declare @typea nvarchar(4)
	declare @noa nvarchar(15)
	declare @mount float
	declare @weight float
	declare @total float
	declare @datea nvarchar(10)
	declare @custno nvarchar(20)
	declare @comp nvarchar(90)
	declare @productno nvarchar(30)
	declare @xproduct nvarchar(MAX)
	declare @t_custno1 nvarchar(20)
	declare @t_comp1 nvarchar(40)
	declare @t_custno2 nvarchar(20)
	declare @t_comp2 nvarchar(40)
	declare @t_productno nvarchar(30)
	declare @t_xproduct nvarchar(MAX)
	declare @t_mount1 float
	declare @t_weight1 float
	declare @t_total1 float
	declare @t_mount2 float
	declare @t_weight2 float
	declare @t_total2 float
	set @t_custno1 = '#zzzz#zzzz'
	set @t_custno2 = '#zzzz#zzzz'
	set @t_productno = '#zzzz#zzzz'
	set @t_xproduct = ''
	set @t_mount1 = 0
	set @t_weight1 = 0
	set @t_total1 = 0
	set @t_mount2 = 0
	set @t_weight2 = 0
	set @t_total2 = 0

	--***********************************************************************
	declare cursor_table cursor for
	select gno,typea,custno,comp,productno,xproduct,datea,total,mount,weight from @result
	open cursor_table
	fetch next from cursor_table
	into @gno,@typea,@custno,@comp,@productno,@xproduct,@datea,@total,@mount,@weight
	while(@@FETCH_STATUS <> -1)
	begin
		if @gno='0'
		begin
			if NOT(@t_custno1 = @custno and @t_productno = @productno)
			begin
				if NOT(@t_custno1 = '#zzzz#zzzz' and @t_productno = '#zzzz#zzzz')
				begin   
					insert into @result
					select '1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, @t_custno1, @t_comp1 comp, '' addr_invo, '' tel, 
						   @t_productno, @xproduct xproduct, '' unit, @t_mount1 mount, @t_weight1 weight, 0 price, @t_total1 total, 
						   0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount,''
				end
				set @t_custno1 = @custno
				set @t_comp1 = @comp
				set @t_productno = @productno
				set @t_xproduct = @xproduct
				set @t_mount1 = case @typea 
									when'1' then @mount 
									when'2' then -@mount 
									else 0 
								end 
				set @t_weight1 = case @typea 
									when'1' then @weight
									when'2' then -@weight
									else 0 
								end 
				set @t_total1 = case @typea
									when'1' then @total
									when'2' then -@total
								end
			end
			else
			begin
				set @t_mount1 = @t_mount1 + case @typea 
									when'1' then @mount 
									when'2' then -@mount 
									else 0 
								end 
				set @t_weight1 = @t_mount1 + case @typea 
									when'1' then @weight
									when'2' then -@weight
									else 0 
								end 
				set @t_total1 = @t_total1 + case @typea
									when'1' then @total
									when'2' then -@total
								end
			end
			
			if @t_custno2 != @custno
			begin
				if @t_custno2 != '#zzzz#zzzz'
				begin
					insert into @result
					select '2' gno, '' typea, '' noa, '' noq, '' datea, '' mon, @t_custno2, @t_comp2 comp, '' addr_invo, '' tel, 
						   CHAR(255) productno, '' xproduct, '' unit, @t_mount2 mount, @t_weight2 weight, 0 price, @t_total2 total, 
						   0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount,''
				end
				set @t_custno2 = @custno
				set @t_comp2 = @comp
				set @t_mount2 = case @typea 
									when'1' then @mount 
									when'2' then -@mount 
									else 0 
								end 
				set @t_weight2 = case @typea 
									when'1' then @weight
									when'2' then -@weight
									else 0 
								end 
				set @t_total2 = case @typea
									when'1' then @total
									when'2' then -@total
								end
			end
			else
			begin
				set @t_mount2 = @t_mount2 + case @typea 
									when'1' then @mount 
									when'2' then -@mount 
									else 0 
								end 
				set @t_weight2 = @t_mount2 + case @typea 
									when'1' then @weight
									when'2' then -@weight
									else 0 
								end 
				set @t_total2 = @t_total2 + case @typea
									when'1' then @total
									when'2' then -@total
								end
			end
		end
		fetch next from cursor_table
		into @gno,@typea,@custno,@comp,@productno,@xproduct,@datea,@total,@mount,@weight
	end
	close cursor_table
	deallocate cursor_table
	if NOT(@t_custno1 = '#zzzz#zzzz' and @t_productno = '#zzzz#zzzz')
	begin
		insert into @result
		select '1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, @t_custno1, @t_comp1 comp, '' addr_invo, '' tel, 
		       @t_productno, @xproduct xproduct, '' unit, @t_mount1 mount, @t_weight1 weight, 0 price, @t_total1 total, 
			   0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount,''
	end
	if @t_custno2 != '#zzzz#zzzz'
	begin
		insert into @result
		select '2' gno, '' typea, '' noa, '' noq, '' datea, '' mon, @t_custno2, @t_comp2 comp, '' addr_invo, '' tel, 
		       CHAR(255) productno, '' xproduct, '' unit, @t_mount2 mount, @t_weight2 weight, 0 price, @t_total2 total, 
			   0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount,''
	end
	--***********************************************************************
	update @result set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'
	
	
	update @result
	set mount=mount*-1,total=total*-1
	where typea='退'

	select gno, typea, noa, noq, datea, mon, custno, comp
	,addr_invo,tel,productno,xproduct,unit
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),@mount_decimal,30)) mount 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,weight),1)),@weight_decimal,30)) weight 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,price),1)),@price_decimal,30)) price 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),@total_decimal,30)) total 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,money),1)),@total_decimal,30)) money 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,back),1)),@total_decimal,30)) back 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,tax),1)),@total_decimal,30)) tax 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total1),1)),@total_decimal,30)) total1 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,pay),1)),@total_decimal,30)) pay 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,unpay),1)),@total_decimal,30)) unpay 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total2),1)),@total_decimal,30)) total2 
	,pcount ,qhref
	from @result order by custno,productno,gno,datea,noa,noq;
--**********************************************************************************************
z_vcc4:--z_vcc4
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
-------------------------------------------------------------------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

if(charindex('永勝',@t_acomp)>0)
begin
	set @mount_decimal =4
	set @weight_decimal =4
	set @price_decimal =4
end
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @mount_decimal =4
--------------------------------------------------
SET QUOTED_IDENTIFIER OFF
declare @tmp table(
	gno nvarchar(1),
	productno nvarchar(30),
	products nvarchar(MAX),
	cno nvarchar(30),
	custnick nvarchar(90),
	mount float,
	total float
)
	insert into @tmp
	select '9',b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end),a.custno,
		(case when isnull(c.nick,'') = '' then c.comp else c.nick end)
		,(case when a.typea='1' then 1 else -1 end)*b.mount,(case when a.typea='1' then 1 else -1 end)*b.total
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	where (a.datea between @t_bdate and @t_edate) and (a.custno between @t_bcustno and @t_ecustno) and 
			 (b.productno between @t_bproductno and @t_eproductno) 
			 and (len(@t_groupano)=0 or d.groupano = @t_groupano)
			 and (len(@t_groupbno)=0 or d.groupbno = @t_groupbno)
		  	 and (len(@t_groupcno)=0 or d.groupcno = @t_groupcno)
			 and (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea) and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno) and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by b.productno,b.product,a.custno,c.nick,c.comp	
	
	insert into @tmp 
	select '0',productno,products,cno,custnick,SUM(mount),SUM(total) from @tmp
	group by productno,products,cno,custnick
	
	delete @tmp where gno='9'

	insert into @tmp(gno,productno,products,mount,total) 
	select '1',productno,products,sum(mount),sum(total) 
	from @tmp where gno='0' group by productno,products 
	
select gno,productno,products,cno,left(custnick,10) custnick
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),@mount_decimal,30)) mount 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),@total_decimal,30)) total 
from @tmp order by productno,products,gno,cno;
--**********************************************************************************************
z_vcc5:--z_vcc5
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) =''
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

if(charindex('永勝',@t_acomp)>0)
begin
	set @mount_decimal =4
	set @weight_decimal =4
	set @price_decimal =4
end
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @mount_decimal =4
--------------------------------------------------
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @qhref_acomp='_it'
if(charindex('永勝',@t_acomp)>0)
	set @qhref_acomp='_uu'
if(charindex('楊家',@t_acomp)>0 or charindex('德芳',@t_acomp)>0)
	set @qhref_acomp='_tn'
if(charindex('有達',@t_acomp)>0 )
	set @qhref_acomp='_xy'
if(charindex('彩虹',@t_acomp)>0 )
	set @qhref_acomp='_rb'
-------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @result table(
	gno nvarchar(1),
	typea nvarchar(4),
	noa nvarchar(30),
	noq nvarchar(3),
	datea nvarchar(10),
	mon nvarchar(7),
	custno nvarchar(20),
	comp nvarchar(90),
	addr_invo nvarchar(90),
	tel nvarchar(90),
	productno nvarchar(30),
	xproduct nvarchar(MAX),
	unit nvarchar(8),
	mount float,
	weight float,
	price float,
	total float,
	pcount int,
	qhref nvarchar(MAX)
)

insert into @result
	select '0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, a.mon mon, 
		   a.custno custno, isnull(c.comp,''), isnull(c.addr_invo,''), isnull(c.tel,''),dbo.charbr(b.productno,12)
		   , b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
		   , b.unit,b.mount, b.weight, b.price, b.total, 0 pcount,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vccs b
	left join view_vcc a on a.noa = b.noa
	left join cust c on  a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
		  (a.custno between @t_bcustno and @t_ecustno) and
		  (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and
		  (b.productno between @t_bproductno and @t_eproductno) and
		  (len(@t_groupano)=0 or d.groupano = @t_groupano) and 
		  (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and
		  (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
		  and (len(@t_stype)=0 or a.stype = @t_stype) 
		  and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
		  and (isnull(d.tggno,'') between @t_btggno and @t_etggno) and (len(@vcctypea)=0 or a.typea = @vcctypea) 
		  and (len(@t_partno)=0 or s.partno=@t_partno)
		  and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by custno,gno,mon,datea,noa,noq
	
insert into @result(gno,custno,pcount,mount,total)
	select '1',custno,
		count(*),
		sum((case typea when '1' then mount else (-1)*mount end)),
		sum((case typea when '1' then total else (-1)*total end))
	from @result a group by custno
	
update @result set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'

update @result
	set mount=mount*-1,total=total*-1
	where typea='退'

select 
	gno,typea,noa,noq,datea,mon,custno,comp,addr_invo,tel,productno,xproduct,unit, qhref
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),@mount_decimal,30)) mount 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,weight),1)),@weight_decimal,30)) weight 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,price),1)),@price_decimal,30)) price 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),@total_decimal,30)) total
	,pcount 
from @result order by custno,gno,mon,datea,noa,noq;
--**********************************************************************************************
z_vcc6:--z_vcc6
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
-------------------------------------------------------------------------------------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

if(charindex('永勝',@t_acomp)>0)
begin
	set @mount_decimal =4
	set @weight_decimal =4
	set @price_decimal =4
end
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @mount_decimal =4
--------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	custno nvarchar(30),
	custs nvarchar(90),
	mon nvarchar(15),
	mount float,
	total float,
	tax float
)

insert into @tmp
	select
		'0',a.custno,(case when isnull(c.nick,'') = '' then c.comp else c.nick end),
		case when isnull(a.mon,'')!='' then a.mon else left(a.datea,@r_lenm) end,sum((case when a.typea='1' then 1 else -1 end)*b.mount),sum((case when a.typea='1' then 1 else -1 end)*b.total)
		,sum((case when a.typea='1' then 1 else -1 end)*a.tax)
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	where  (a.datea between @t_bdate and @t_edate) and --(isnull(a.salesno,'') != '') and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and 
			 (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  	 (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and
			 (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea) and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno) and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	group by a.custno,c.nick,c.comp,case when isnull(a.mon,'')!='' then a.mon else left(a.datea,@r_lenm) end
	
insert into @tmp(gno,custno,custs,mon,mount,total,tax) 
select '1',custno,custs,'999/99',sum(mount),sum(total),sum(tax) from @tmp group by custno,custs

insert into @tmp(gno,custno,mount,total,tax) 
select '2','ZZZZ_ZZZ',sum(mount), sum(total), sum(tax) from @tmp where gno='1'


select gno,custno cno,left(custs,10) custs,mon
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),@mount_decimal,30)) mount 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),@total_decimal,30)) total 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,tax),1)),@total_decimal,30)) tax 
from @tmp order by custno,mon,gno;
--**********************************************************************************************
z_vcc7:--z_vcc7
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) =''
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

if(charindex('永勝',@t_acomp)>0)
begin
	set @mount_decimal =4
	set @weight_decimal =4
	set @price_decimal =4
end
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @mount_decimal =4
--------------------------------------------------
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @qhref_acomp='_it'
if(charindex('永勝',@t_acomp)>0)
	set @qhref_acomp='_uu'
if(charindex('楊家',@t_acomp)>0 or charindex('德芳',@t_acomp)>0)
	set @qhref_acomp='_tn'
if(charindex('有達',@t_acomp)>0 )
	set @qhref_acomp='_xy'
if(charindex('彩虹',@t_acomp)>0 )
	set @qhref_acomp='_rb'
-------------------------------------------------
	SET QUOTED_IDENTIFIER OFF
	
	declare @result table(
		gno nvarchar(1),
		typea nvarchar(4),
		noa nvarchar(15),
		noq nvarchar(3),
		datea nvarchar(10),
		mon nvarchar(7),
		custno nvarchar(20),
		comp nvarchar(90),
		addr_invo nvarchar(90),
		tel nvarchar(90),
		productno nvarchar(30),
		xproduct nvarchar(MAX),
		unit nvarchar(8),
		mount float,
		weight float,
		price float,
		total float,
		money float,
		back float,
		tax float,
		total1 float,
		pay float,
		unpay float,
		total2 float,
		pcount int,
		qhref nvarchar(MAX)
		primary key (productno,gno,datea,noa,noq) 
	)
	
	insert into @result
	select '0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, case when isnull(a.mon,'')!='' then a.mon else left(a.datea,@r_lenm) end mon, 
		   a.custno custno, isnull(c.comp,''), isnull(c.addr_invo,''), isnull(c.tel,''),dbo.charbr(b.productno,12)
		   , b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
		   , b.unit,(case when a.typea='1' then 1 else -1 end) *b.mount, b.weight, b.price, b.total, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
	       ,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vccs b
	left join view_vcc a on a.noa = b.noa
	left join cust c on  a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
		  (a.custno between @t_bcustno and @t_ecustno) and
		  (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and
		  (b.productno between @t_bproductno and @t_eproductno) and
		  (len(@t_groupano)=0 or d.groupano = @t_groupano) and 
		  (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and
		  (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
		  and (len(@t_stype)=0 or a.stype = @t_stype) 
		  and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
		  and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
		  and (len(@vcctypea)=0 or a.typea = @vcctypea) 
		  and (len(@t_partno)=0 or s.partno=@t_partno)
		  and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by productno,gno,datea,noa,noq

	--***********************************************************************
	declare @gno nvarchar(1)
	declare @typea nvarchar(4)
	declare @noa nvarchar(15)
	declare @total float
	declare @datea nvarchar(10)
	declare @productno nvarchar(30)
	declare @t_productno nvarchar(30)
	declare @t_money float
	declare @t_back float
	declare @t_tax float
	declare @t_total1 float
	declare @t_pcount int
	set @t_productno = '#zzzz#zzzz'
	set @t_money = 0
	set @t_back = 0
	set @t_tax = 0
	set @t_total1 = 0
	set @t_pcount = 0
	--***********************************************************************
	declare cursor_table cursor for
	select gno,typea,productno,datea,total from @result
	open cursor_table
	fetch next from cursor_table
	into @gno,@typea,@productno,@datea,@total
	while(@@FETCH_STATUS <> -1)
	begin
		if @t_productno != @productno
		begin
			if @t_productno != '#zzzz#zzzz'
			begin
				set @t_total1 = @t_money - @t_back + @t_tax
				insert into @result
				select '1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, '' custno, '' comp, '' addr_invo, '' tel, 
				       @t_productno, '' product, '' unit, 0 mount, 0 weight, 0 price, 0 total, 
					   @t_money, @t_back, @t_tax, @t_total1, 0 pay, 0 unpay, 0 total2, @t_pcount,''
			end
			set @t_productno = @productno
			set @t_money = case when @typea = '1' then @total else 0 end
			set @t_back = case when @typea = '2' then @total else 0 end
			set @t_tax = case when @typea = '稅' then @total else 0 end
			set @t_pcount = 1
		end
		else
		begin
			set @t_money = @t_money + case when @typea = '1' then @total else 0 end
			set @t_back = @t_back + case when @typea = '2' then @total else 0 end
			set @t_tax = @t_tax + case when @typea = '稅' then @total else 0 end
			set @t_pcount = @t_pcount + 1
		end
		fetch next from cursor_table
		into @gno,@typea,@productno,@datea,@total
	end
	close cursor_table
	deallocate cursor_table
	
	if @t_productno != '#zzzz#zzzz'
	begin
		set @t_total1 = @t_money - @t_back + @t_tax
		insert into @result
		select '1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, '' custno, '' comp, '' addr_invo, '' tel, 
		       @t_productno, '' product, '' unit, 0 mount, 0 weight, 0 price, 0 total, 
			   @t_money, @t_back, @t_tax, @t_total1, 0 pay, 0 unpay, 0 total2, @t_pcount,''
	end
	--***********************************************************************
	update @result set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'
	
	update a 
	set mount=(select sum(mount) from @result where gno='0' and productno=a.productno) 
	from @result a	where gno='1' 
	
	update @result
	set total=total*-1
	where typea='退'
	
	select gno, typea, noa, noq, datea, mon, custno, left(comp,10) comp
	,addr_invo,tel,productno,xproduct,unit, qhref
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),@mount_decimal,30)) mount 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,weight),1)),@weight_decimal,30)) weight 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,price),1)),@price_decimal,30)) price 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),@total_decimal,30)) total 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,money),1)),@total_decimal,30)) money 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,back),1)),@total_decimal,30)) back 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,tax),1)),@total_decimal,30)) tax 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total1),1)),@total_decimal,30)) total1 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,pay),1)),@total_decimal,30)) pay 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,unpay),1)),@total_decimal,30)) unpay 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total2),1)),@total_decimal,30)) total2 
	,pcount 
	from @result order by productno,gno,datea,noa,noq;
--**********************************************************************************************
z_vcc8:--z_vcc8
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end

--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

if(charindex('永勝',@t_acomp)>0)
begin
	set @mount_decimal =4
	set @weight_decimal =4
	set @price_decimal =4
end
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @mount_decimal =4
--------------------------------------------------
SET QUOTED_IDENTIFIER OFF	

declare @tmp table(
	gno nvarchar(1),
	productno nvarchar(30),
	products nvarchar(MAX),
	spec nvarchar(MAX),
	mon nvarchar(15),
	mount float,
	total float
)
declare @cmd nvarchar(max)

insert into @tmp
	select
		'0',dbo.charbr(b.productno,11),b.product,b.spec
		,case when charindex('永勝',@t_acomp)>0 then left(a.datea,@r_lenm) when isnull(a.mon,'')!='' then a.mon else left(a.datea,@r_lenm) end
		,sum((case when a.typea='1' then 1 else -1 end)*b.mount),sum((case when a.typea='1' then 1 else -1 end)*b.total)
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join view_ucaucc d on b.productno = d.noa
	where  (a.datea between @t_bdate and @t_edate) and --(isnull(a.salesno,'') != '') and
	 		(a.custno between @t_bcustno and @t_ecustno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and
			 (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  	 (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and 
			 (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	group by b.productno,b.product,b.spec
	,case when charindex('永勝',@t_acomp)>0 then left(a.datea,@r_lenm) when isnull(a.mon,'')!='' then a.mon else left(a.datea,@r_lenm) end
	
insert into @tmp(gno,productno,products,mon,mount,total)
select '1',productno,products,'999/99',sum(mount),sum(total)
from @tmp group by productno,products
	
insert into @tmp(gno,productno,mount,total)
select '2','ZZZZZZZZZZZZ',sum(mount),sum(total)
from @tmp where gno='1'

select gno,productno,(case when gno='0' then dbo.charbr(products,24) else products end )
+(case when @isspec='1' then '<BR>&nbsp'+isnull(spec,'') else '' end)products,mon
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),@mount_decimal,30)) mount 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),@total_decimal,30)) total 
from @tmp order by productno,mon,gno;
--**********************************************************************************************
z_vcc9:--z_vcc9
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) =''
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

if(charindex('永勝',@t_acomp)>0)
begin
	set @mount_decimal =4
	set @weight_decimal =4
	set @price_decimal =4
end
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @mount_decimal =4
--------------------------------------------------
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @qhref_acomp='_it'
if(charindex('永勝',@t_acomp)>0)
	set @qhref_acomp='_uu'
if(charindex('楊家',@t_acomp)>0 or charindex('德芳',@t_acomp)>0)
	set @qhref_acomp='_tn'
if(charindex('有達',@t_acomp)>0 )
	set @qhref_acomp='_xy'
if(charindex('彩虹',@t_acomp)>0 )
	set @qhref_acomp='_rb'
-------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	salesno nvarchar(30),
	salesname nvarchar(50),
	comp nvarchar(100),
	datea nvarchar(10),
	noa nvarchar(35),
	typea nvarchar(15),
	productno nvarchar(30),
	products nvarchar(max),
	unit nvarchar(15),
	mount float,
	price float,
	total float,
	qhref nvarchar(max)
)
declare @cmd nvarchar(max)

insert into @tmp
	select '0',a.salesno,s.namea,a.comp,a.datea,a.noa,a.typea,dbo.charbr(b.productno,11)
	,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end),b.unit,b.mount,b.price,b.total
	,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vcc a
	left join view_vccs b  on a.noa = b.noa and a.accy = b.accy
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and --(isnull(a.salesno,'') != '') and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and
			 (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  	 (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and 
			 (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_partno)=0 or s.partno=@t_partno)
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by a.salesno,a.datea

insert into @tmp(gno,salesno,salesname,mount,total)
	select '1' gno,salesno,salesname,
		sum((case when typea='1' then mount else mount*(-1) end)),
		sum((case when typea='1' then total else total*(-1) end)) 
	from @tmp group by salesno,salesname
update @tmp set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'

update @tmp
set mount=mount*-1,total=total*-1
where typea='退'

select gno,salesno,salesname,left(comp,10)comp,datea,noa,typea,productno,products,unit,qhref
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,price),1)),@price_decimal,30)) price 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),@mount_decimal,30)) mount 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),@total_decimal,30)) total 
from @tmp order by salesno,salesname,gno,datea,productno;
--**********************************************************************************************
z_vcc10:--z_vcc10
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

if(charindex('永勝',@t_acomp)>0)
begin
	set @mount_decimal =4
	set @weight_decimal =4
	set @price_decimal =4
end
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @mount_decimal =4
--------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	salesno nvarchar(30),
	salesname nvarchar(90),
	mon nvarchar(15),
	mount float,
	total float
)

insert into @tmp
	select
		'0',a.salesno,s.namea,case when isnull(a.mon,'')!='' then a.mon else left(a.datea,@r_lenm) end
		,sum((case when a.typea='1' then 1 else -1 end)*b.mount)
		,sum((case when a.typea='1' then 1 else -1 end)*b.total)
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where  (a.datea between @t_bdate and @t_edate) and --(isnull(a.salesno,'') != '') and
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and 
			 (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  	 (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and
			 (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and  (a.custno between @t_bcustno and @t_ecustno) 
			 and (isnull(b.productno,'') between @t_bproductno and @t_eproductno)
			and (len(@t_stype)=0 or a.stype = @t_stype) 
			and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			and (len(@t_partno)=0 or s.partno=@t_partno)
			and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	group by a.salesno,s.namea,case when isnull(a.mon,'')!='' then a.mon else left(a.datea,@r_lenm) end
	
insert into @tmp(gno,salesno,salesname,mon,mount,total)
select '1',salesno,salesname,'999/99',sum(mount),sum(total)
from @tmp group by salesno,salesname
	
insert into @tmp(gno,salesno,mount,total)
select '2','ZZZZZZ',sum(mount),sum(total)
from @tmp where gno='1'
	
select gno,salesno sno,salesname,mon
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),@mount_decimal,30)) mount 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),@total_decimal,30)) total 
from @tmp order by salesno,mon,gno;
--**********************************************************************************************
z_vcc11:--z_vcc11
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) =''
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

if(charindex('永勝',@t_acomp)>0)
begin
	set @mount_decimal =4
	set @weight_decimal =4
	set @price_decimal =4
end
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @mount_decimal =4
--------------------------------------------------
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @qhref_acomp='_it'
if(charindex('永勝',@t_acomp)>0)
	set @qhref_acomp='_uu'
if(charindex('楊家',@t_acomp)>0 or charindex('德芳',@t_acomp)>0)
	set @qhref_acomp='_tn'
if(charindex('有達',@t_acomp)>0 )
	set @qhref_acomp='_xy'
if(charindex('彩虹',@t_acomp)>0 )
	set @qhref_acomp='_rb'
-------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	salesno nvarchar(30),
	salesname nvarchar(50),
	comp nvarchar(100),
	datea nvarchar(10),
	noa nvarchar(35),
	typea nvarchar(15),
	productno nvarchar(30),
	products nvarchar(max),
	unit nvarchar(15),
	mount float,
	price float,
	total float,
	qhref nvarchar(max)
)

insert into @tmp
	select '0',a.salesno,s.namea,a.comp,a.datea,a.noa,a.typea
	,dbo.charbr(b.productno,11)
	,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
	,b.unit,b.mount,b.price,b.total
	,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vcc a
	left join view_vccs b  on a.noa = b.noa and a.accy = b.accy
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and --(isnull(a.salesno,'') != '') and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and
			 (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  	 (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and 
			 (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_partno)=0 or s.partno=@t_partno)
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by a.salesno,b.productno

insert into @tmp(gno,salesno,salesname,mount,total)
	select '1' gno,salesno,salesname,
		sum((case when typea='1' then mount else mount*(-1) end)),
		sum((case when typea='1' then total else total*(-1) end)) 
	from @tmp group by salesno,salesname
	
update @tmp set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'

update @tmp
set mount=mount*-1,total=total*-1
where typea='退'

select 
gno,salesno,salesname,left(comp,10) comp,productno,products,datea,noa,typea,unit, qhref
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,price),1)),@price_decimal,30)) price 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),@mount_decimal,30)) mount 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),@total_decimal,30)) total  
from @tmp order by salesno,salesname,gno,productno,datea;
--**********************************************************************************************
z_vcc12:--z_vcc12
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

if(charindex('永勝',@t_acomp)>0)
begin
	set @mount_decimal =4
	set @weight_decimal =4
	set @price_decimal =4
end
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @mount_decimal =4
--------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	salesno nvarchar(30),
	salesname nvarchar(50),
	productno nvarchar(30),
	products nvarchar(max),
	mount float,
	total float
)

insert into @tmp
	select '0',a.salesno,s.namea,dbo.charbr(b.productno,13),b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
	,sum((case when a.typea='1' then 1 else -1 end)*b.mount)
	,sum((case when a.typea='1' then 1 else -1 end)*b.total)
	from view_vcc a
	left join view_vccs b  on a.noa = b.noa and a.accy = b.accy
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and 
			  (a.custno between @t_bcustno and @t_ecustno) and 
			 --(isnull(a.salesno,'') != '') and 
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and
			 (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  	 (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and 
			 (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_partno)=0 or s.partno=@t_partno)
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	group by a.salesno,s.namea,b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
	order by a.salesno,b.productno
	
insert into @tmp(gno,mount,total)
select '1',sum(mount),sum(total)
from @tmp

select gno,salesno sno ,salesname,productno,products
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),@mount_decimal,30)) mount 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),@total_decimal,30)) total  
from @tmp order by gno,salesno,productno;
--**********************************************************************************************
z_vcc13:--z_vcc13
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) =''
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

if(charindex('永勝',@t_acomp)>0)
begin
	set @mount_decimal =4
	set @weight_decimal =4
	set @price_decimal =4
end
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @mount_decimal =4
--------------------------------------------------
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @qhref_acomp='_it'
if(charindex('永勝',@t_acomp)>0)
	set @qhref_acomp='_uu'
if(charindex('楊家',@t_acomp)>0 or charindex('德芳',@t_acomp)>0)
	set @qhref_acomp='_tn'
if(charindex('有達',@t_acomp)>0 )
	set @qhref_acomp='_xy'
if(charindex('彩虹',@t_acomp)>0 )
	set @qhref_acomp='_rb'
-------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	custno nvarchar(30),
	custnick nvarchar(90),
	salesno nvarchar(30),
	salesname nvarchar(50),
	productno nvarchar(30),
	products nvarchar(max),
	datea nvarchar(10),
	noa nvarchar(35),
	typea nvarchar(15),
	unit nvarchar(15),
	mount float,
	price float,
	total float,
	qhref nvarchar(MAX)
)

insert into @tmp
	select '0',a.custno,(case when isnull(c.nick,'') = '' then left(c.comp,10) else c.nick end),
	a.salesno,s.namea,dbo.charbr(b.productno,11),b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
	,a.datea,a.noa,a.typea,b.unit,b.mount,b.price,b.total
	,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vcc a
	left join view_vccs b  on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and --(isnull(a.salesno,'') != '') and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			 and (len(@t_groupbno)=0 or d.groupbno = @t_groupbno)
		  	 and (len(@t_groupcno)=0 or d.groupcno = @t_groupcno)
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_partno)=0 or s.partno=@t_partno)
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by a.salesno,a.custno,b.productno
	
insert into @tmp(gno,salesno,salesname,mount,total)
	select '1' gno,salesno,salesname,
		sum((case when typea='1' then mount else mount*(-1) end)),
		sum((case when typea='1' then total else total*(-1) end)) 
	from @tmp group by salesno,salesname
	
update @tmp set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'

update @tmp
set mount=mount*-1,total=total*-1
where typea='退'

select gno,custno,custnick,salesno,salesname,productno,products,datea,noa,typea,unit,qhref
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,price),1)),@price_decimal,30)) price 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),@mount_decimal,30)) mount 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),@total_decimal,30)) total  
from @tmp order by salesno,gno,custno,productno,datea;
--**********************************************************************************************
z_vcc14:--z_vcc14
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

if(charindex('永勝',@t_acomp)>0)
begin
	set @mount_decimal =4
	set @weight_decimal =4
	set @price_decimal =4
end
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @mount_decimal =4
--------------------------------------------------
SET QUOTED_IDENTIFIER OFF	

declare @tmp table(
	gno nvarchar(1),
	custno nvarchar(30),
	custnick nvarchar(90),
	salesno nvarchar(30),
	salesname nvarchar(50),
	productno nvarchar(30),
	products nvarchar(max),
	mount float,
	total float
)

insert into @tmp
	select '0',a.custno,(case when isnull(c.nick,'') = '' then left(c.comp,10) else c.nick end),
	a.salesno,s.namea,dbo.charbr(b.productno,11),b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
	,sum((case when a.typea='1' then 1 else -1 end)*b.mount)
	,sum((case when a.typea='1' then 1 else -1 end)*b.total)
	from view_vcc a
	left join view_vccs b  on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (isnull(a.salesno,'')between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and --(isnull(a.salesno,'') != '') and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and
			 (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  	 (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and 
			 (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			and (len(@vcctypea)=0 or a.typea = @vcctypea)
			and (len(@t_partno)=0 or s.partno=@t_partno)
			and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
			and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	group by a.salesno,s.namea,a.custno,c.nick,c.comp,b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
	order by a.salesno,a.custno,b.productno
	
insert into @tmp(gno,mount,total)
select '1',sum(mount),sum(total)
from @tmp

select gno,custno,left(custnick,7) custnick,salesno sno ,salesname,productno,products
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),@mount_decimal,30)) mount 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),@total_decimal,30)) total  
from @tmp order by gno,salesno,custno,productno;
--**********************************************************************************************
z_vcc15:--z_vcc15
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) =''
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

if(charindex('永勝',@t_acomp)>0)
begin
	set @mount_decimal =4
	set @weight_decimal =4
	set @price_decimal =4
end
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @mount_decimal =4
--------------------------------------------------
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @qhref_acomp='_it'
if(charindex('永勝',@t_acomp)>0)
	set @qhref_acomp='_uu'
if(charindex('楊家',@t_acomp)>0 or charindex('德芳',@t_acomp)>0)
	set @qhref_acomp='_tn'
if(charindex('有達',@t_acomp)>0 )
	set @qhref_acomp='_xy'
if(charindex('彩虹',@t_acomp)>0 )
	set @qhref_acomp='_rb'
-------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	productno nvarchar(30),
	products nvarchar(MAX),
	sno nvarchar(30),
	salesname nvarchar(90),
	cno nvarchar(30),
	custnick nvarchar(90),
	datea nvarchar(10),
	noa nvarchar(30),
	typea nvarchar(15),
	mount float,
	price float,
	total float,
	qhref nvarchar(MAX)
)

insert into @tmp
	select
		'0',b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
		,a.salesno,s.namea,a.custno,
		(case when isnull(c.nick,'') = '' then left(c.comp,10) else c.nick end),
		a.datea,a.noa,a.typea,b.mount,b.price,b.total,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and
			 (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  	 (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and 
			 (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno) and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_partno)=0 or s.partno=@t_partno)
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by b.productno,b.product,a.salesno,s.namea,a.custno,c.nick,c.comp,a.datea,a.noa,a.typea
	  
insert into @tmp(gno,productno,products,mount,total)
	select '1',productno,products,
		sum((case when typea='1' then mount else mount*(-1) end)),
		sum((case when typea='1' then total else total*(-1) end))
	from @tmp group by productno,products
update @tmp set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'

update @tmp
set mount=mount*-1,total=total*-1
where typea='退'

select gno,productno,products,sno,salesname,cno,custnick,datea,noa,typea, qhref
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,price),1)),@price_decimal,30)) price 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),@mount_decimal,30)) mount 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),@total_decimal,30)) total  
from @tmp order by productno,products,gno,sno,cno,datea,typea;
--**********************************************************************************************
z_vcc16:--z_vcc16
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

if(charindex('永勝',@t_acomp)>0)
begin
	set @mount_decimal =4
	set @weight_decimal =4
	set @price_decimal =4
end
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @mount_decimal =4
--------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	productno nvarchar(30),
	products nvarchar(MAX),
	sno nvarchar(30),
	salesname nvarchar(90),
	cno nvarchar(30),
	custnick nvarchar(90),
	mount float,
	total float
)

insert into @tmp
	select
		'0',b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
		,a.salesno,s.namea,a.custno,
		(case when isnull(c.nick,'') = '' then c.comp else c.nick end)
		,sum((case when a.typea='1' then 1 else -1 end)*b.mount)
		,sum((case when a.typea='1' then 1 else -1 end)*b.total)
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			 and (len(@t_groupbno)=0 or d.groupbno = @t_groupbno)
		  	 and (len(@t_groupcno)=0 or d.groupcno = @t_groupcno)
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_partno)=0 or s.partno=@t_partno)
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	group by b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
	,a.salesno,s.namea,a.custno,c.nick,c.comp
	
insert into @tmp(gno,productno,products,mount,total)
select '1',productno,products,sum(mount),sum(total)
from @tmp group by productno,products
	
select gno,productno,products,sno,salesname,cno,left(custnick,10) custnick 
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),@mount_decimal,30)) mount 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),@total_decimal,30)) total  
from @tmp order by productno,products,gno,sno,cno;
--**********************************************************************************************
z_vcc17:--z_vcc17
declare @t_bmon nvarchar(7)
declare @t_emon nvarchar(7)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'
	
set @t_bmon = case when '#non'=[6] then '' else [6] end
set @t_emon = case when '#non'=[7] then char(255) else [7] end
--declare @tmp table(
--	gno nvarchar(1),
--	idno int,
--	salesno nvarchar(30),
--	salesname nvarchar(90),
--	custno nvarchar(30),
--	custs nvarchar(90),
--	unpay float,
--	money float,
--	tax float,
--	total1 float,
--	opay float,
--	total2 float
--)
--insert into @tmp
--	select
--		'0',ROW_NUMBER()over(partition by salesno order by a.noa),
--		a.salesno,b.namea,a.noa,a.nick,0,0,0,0,0,0
--	from cust a
--	left join sss b on a.salesno = b.noa
--	order by a.salesno
--declare @custno nvarchar(30)
--declare @idno int
--declare @w_unpay float
--declare @w_money float
--declare @w_tax float
--declare @w_opay float
--declare cursor_table cursor for
--	select custno,idno from @tmp
--open cursor_table
--fetch next from cursor_table
--	into @custno,@idno
--while(@@FETCH_STATUS <> -1)
--begin
--	select @w_unpay = (
--		select sum(a.total) from view_vcc[1] a where (case when a.custno2!='' then a.custno2 else a.custno end) = @custno and
--		((case when a.mon='' then left(a.datea,@r_lenm) else a.mon end) < @t_bmon )
--	)
--	select @w_money = (
--		select sum(a.money) from view_vcc[1] a where (case when a.custno2!='' then a.custno2 else a.custno end) = @custno and
--		((case when a.mon='' then left(a.datea,@r_lenm) else a.mon end) between @t_bmon and @t_emon)
--	)
--	select @w_tax = (
--		select sum(a.tax) from view_vcc[1] a where (case when a.custno2!='' then a.custno2 else a.custno end) = @custno and
--		((case when a.mon='' then left(a.datea,@r_lenm) else a.mon end) between @t_bmon and @t_emon)
--	)
--	select @w_opay = (
--		select sum(a.total) from umm a where a.custno = @custno and
--		((case when a.mon='' then left(a.datea,@r_lenm) else a.mon end) between @t_bmon and @t_emon)
--	)
--	update @tmp set unpay = isnull(@w_unpay,0),money = isnull(@w_money,0),
--							tax = isnull(@w_tax,0),opay = isnull(@w_opay,0)
--						where custno=@custno
--	fetch next from cursor_table
--	into @custno,@idno
--end
--close cursor_table
--deallocate cursor_table
--insert into @tmp(gno,salesno,unpay,money,tax,total1,opay,total2)
--	select '1',salesno,sum(unpay),sum(money),sum(tax),sum(total1),sum(opay),sum(total2)
--	from @tmp group by salesno
--update @tmp set total1 = (money+tax)
--update @tmp set total2 = (unpay+total1-opay)
--select * from @tmp order by salesno,gno,custno
----------------------------------------------------------------------------------------------------------------------

declare @tmp table( 
	gno nvarchar(1), 
	custno nvarchar(30), 
	comp nvarchar(90), 
	salesno nvarchar(30), 
	namea nvarchar(30), 
	money float, 
	total float, 
	payed float
) 

--前期
insert into @tmp (gno,custno,salesno,money,total,payed)
select '9',custno,salesno,SUM(money),0,0 from (
	--trd 
	--select aa.custno,bb.salesno,SUM(isnull(unpay,0)) money from view_trd[1] aa left join cust bb on aa.custno=bb.noa where (case when len(aa.mon)=0 then left(aa.datea,@r_lenm) else aa.mon end) < @t_bmon group by  aa.custno,bb.salesno
	--union all
	--vcc 
	select (case when aa.custno2!='' then aa.custno2 else aa.custno end) custno,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end) salesno
	,SUM(isnull((case when aa.typea='1' then 1 else -1 end)*unpay,0))-isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where len(vccno)>8 and right(vccno,4)!='-TAX' and right(vccno,@r_lenm)<@t_bmon and left(vccno,len(vccno)-7)=(case when aa.custno2!='' then aa.custno2 else aa.custno end)),0) money 
	from view_vcc aa left join cust bb on aa.custno=bb.noa where (case when len(aa.mon)=0 then left(aa.datea,@r_lenm) else aa.mon end) < @t_bmon and (left(kind,4)!='健勞勞退') 
	group by (case when aa.custno2!='' then aa.custno2 else aa.custno end) ,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end)
	 --vcca
	union all
	select  ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end) salesno
	,SUM(isnull(ca.tax,0))-isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where len(vccno)>8 and right(vccno,4)='-TAX' and left(right(vccno,10),@r_lenm)<@t_bmon and left(vccno,len(vccno)-11)=ca.custno),0)
	from vcca ca left join view_vcc cb on ca.noa=cb.invono left join cust cc on ca.custno=cc.noa
	where (case when ca.mon!='' then ca.mon else LEFT(ca.datea,@r_lenm) end) < @t_bmon
	and (ca.taxtype='1' or ca.taxtype='5')
	group by ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end)
	--union all
	--cara 
	--select ca.carownerno,ca.sssno,outmoney-inmoney from cara ca left join caras cb on ca.noa=cb.noa where ca.mon=@t_bmon and cb.caritemno='001'
)tmp group by custno,salesno

--本期

insert into @tmp (gno,custno,salesno,money,total,payed)
select '9',custno,salesno,0,SUM(total),0 from (
	--trd 
	--select aa.custno,bb.salesno,SUM(isnull(total,0)) total from view_trd[1] aa left join cust bb on aa.custno=bb.noa where (case when len(aa.mon)=0 then left(aa.datea,@r_lenm) else aa.mon end) between @t_bmon and @t_emon group by  aa.custno,bb.salesno
	--union all
	--vcc 
	select (case when aa.custno2!='' then aa.custno2 else aa.custno end) custno,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end) salesno
	,SUM(isnull((case when aa.typea='1' then 1 else -1 end)*total,0)) total
	from view_vcc aa left join cust bb on aa.custno=bb.noa where (case when len(aa.mon)=0 then left(aa.datea,@r_lenm) else aa.mon end) between @t_bmon and @t_emon and (left(kind,4)!='健勞勞退') 
	group by (case when aa.custno2!='' then aa.custno2 else aa.custno end) ,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end)
	--vcca
	union all
	select  ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end) salesno
	,SUM(isnull(ca.tax,0))
	from vcca ca left join view_vcc cb on ca.noa=cb.invono left join cust cc on ca.custno=cc.noa
	where (case when ca.mon!='' then ca.mon else LEFT(ca.datea,@r_lenm) end) between @t_bmon and @t_emon
	and (ca.taxtype='1' or ca.taxtype='5')
	group by ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end) 
	--union all
	--cara 
	--select ca.carownerno,ca.sssno,sum(outmoney) from cara ca left join caras cb on ca.noa=cb.noa where ca.mon between @t_bmon and @t_emon and cb.caritemno!='001' group by ca.carownerno,ca.sssno
)tmp group by custno,salesno

--本期已付
insert into @tmp (gno,custno,salesno,money,total,payed)
select '9',custno,salesno,0,0,SUM(payed) from (
	--trd 
	--select aa.custno,bb.salesno,SUM(isnull(payed,0)) payed from view_trd[1] aa left join cust bb on aa.custno=bb.noa where (case when len(aa.mon)=0 then left(aa.datea,@r_lenm) else aa.mon end) between @t_bmon and @t_emon group by  aa.custno,bb.salesno
	--union all
	--vcc 
	select (case when aa.custno2!='' then aa.custno2 else aa.custno end) custno,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end) salesno
	,SUM(isnull((case when aa.typea='1' then 1 else -1 end)*payed,0)) 
	+isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where len(vccno)>8 and right(vccno,4)!='-TAX' and right(vccno,@r_lenm) between @t_bmon and @t_emon and left(vccno,len(vccno)-7)=(case when aa.custno2!='' then aa.custno2 else aa.custno end)),0) payed 
	from view_vcc aa left join cust bb on aa.custno=bb.noa where (case when len(aa.mon)=0 then left(aa.datea,@r_lenm) else aa.mon end) between @t_bmon and @t_emon and (left(kind,4)!='健勞勞退') 
	group by (case when aa.custno2!='' then aa.custno2 else aa.custno end) ,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end)
	--vcca
	union all
	select  ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end) salesno
	,0+isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where len(vccno)>8 and right(vccno,4)='-TAX' and left(right(vccno,10),@r_lenm) between @t_bmon and @t_emon and left(vccno,len(vccno)-11)=ca.custno),0)
	from vcca ca left join view_vcc cb on ca.noa=cb.invono left join cust cc on ca.custno=cc.noa
	where (case when ca.mon!='' then ca.mon else LEFT(ca.datea,@r_lenm) end) between @t_bmon and @t_emon
	and (ca.taxtype='1' or ca.taxtype='5')
	group by ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end)
	--union all
	--cara 
	--select ca.carownerno,ca.sssno,sum(inmoney) from cara ca left join caras cb on ca.noa=cb.noa where ca.mon between @t_bmon and @t_emon and cb.caritemno!='001' group by ca.carownerno,ca.sssno
)tmp group by custno,salesno

insert into @tmp (gno,custno,salesno,money,total,payed)
select '0',custno,salesno,SUM(money),SUM(total),SUM(payed) from @tmp group by custno,salesno

delete @tmp where gno='9'

delete @tmp where money=0 and total=0 and payed=0 
update @tmp
set comp=(select top 1 nick from ((select nick from cust where noa=custno union select namea from carOwner where noa=custno union select namea from sss where noa=custno))tmp)
,namea=(select namea from sss where noa=salesno)

insert into @tmp 
select '1'gno,'','',salesno,'',sum(money),sum(total),sum(payed) from @tmp group by salesno 

---------------------------------------------------------------------------------------------------------------------
select gno,custno,comp,salesno,namea
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money),1)),4,12)) money
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,payed),1)),4,12)) payed
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money+total-payed),1)),4,12)) unpay
from @tmp order by salesno,gno;
------------------------------------------------------------------------------------------------------------------------------------
z_vcc18:--z_vcc18
	declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end

declare @tmp table( 
	gno nvarchar(1), 
	custno nvarchar(30), 
	comp nvarchar(90), 
	salesno nvarchar(30), 
	namea nvarchar(30), 
	money float, 
	total float, 
	payed float
) 

--前期
insert into @tmp (gno,custno,salesno,money,total,payed)
select '9',a.custno,a.salesno,SUM(a.money),0,0 from (
	--trd 
	--select aa.custno,bb.salesno,SUM(isnull(unpay,0)) money from view_trd[1] aa left join cust bb on aa.custno=bb.noa where (case when len(aa.mon)=0 then left(aa.datea,@r_lenm) else aa.mon end) < @t_bmon 
	--and @t_paytype='全部'
	--group by  aa.custno,bb.salesno
	--union all
	--vcc 
	select (case when aa.custno2!='' then aa.custno2 else aa.custno end) custno,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end) salesno
	,SUM(isnull((case when aa.typea='1' then 1 else -1 end)*unpay,0))-isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where len(vccno)>8 and right(vccno,@r_lenm)<@t_bmon and left(vccno,len(vccno)-7)=(case when aa.custno2!='' then aa.custno2 else aa.custno end)),0) money 
	from view_vcc aa left join cust bb on aa.custno=bb.noa where (case when len(aa.mon)=0 then left(aa.datea,@r_lenm) else aa.mon end) < @t_bmon and (left(kind,4)!='健勞勞退')
	and (@t_paytype='全部' or aa.paytype=@t_paytype)
	group by (case when aa.custno2!='' then aa.custno2 else aa.custno end) ,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end)
	--vcca
	union all
	select  ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end) salesno
	,SUM(isnull(ca.tax,0))-isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where len(vccno)>8 and right(vccno,4)='-TAX' and left(right(vccno,10),@r_lenm)<@t_bmon and left(vccno,len(vccno)-11)=ca.custno),0)
	from vcca ca left join view_vcc cb on ca.noa=cb.invono left join cust cc on ca.custno=cc.noa
	where (case when ca.mon!='' then ca.mon else LEFT(ca.datea,@r_lenm) end) < @t_bmon
	and (ca.taxtype='1' or ca.taxtype='5')
	group by ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end)
	--union all
	--cara 
	--select ca.carownerno,ca.sssno,outmoney-inmoney from cara ca left join caras cb on ca.noa=cb.noa where ca.mon=@t_bmon and cb.caritemno='001'
	--and @t_paytype='全部'
)a left join sss s on isnull(a.salesno,'')=s.noa
where (a.custno between @t_bcustno and @t_ecustno ) 
and (a.salesno between @t_bsalesno and @t_esalesno) 
and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
group by a.custno,a.salesno

--本期

insert into @tmp (gno,custno,salesno,money,total,payed)
select '9',a.custno,a.salesno,0,SUM(a.total),0 from (
	--trd 
	--select aa.custno,bb.salesno,SUM(isnull(total,0)) total from view_trd[1] aa left join cust bb on aa.custno=bb.noa where (case when len(aa.mon)=0 then left(aa.datea,@r_lenm) else aa.mon end) between @t_bmon and @t_emon 
	--and @t_paytype='全部'
	--group by  aa.custno,bb.salesno
	--union all
	--vcc 
	select (case when aa.custno2!='' then aa.custno2 else aa.custno end) custno,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end) salesno
	,SUM(isnull((case when aa.typea='1' then 1 else -1 end)*total,0)) total
	from view_vcc aa left join cust bb on aa.custno=bb.noa where (case when len(aa.mon)=0 then left(aa.datea,@r_lenm) else aa.mon end) between @t_bmon and @t_emon and (left(kind,4)!='健勞勞退')
	and (@t_paytype='全部' or aa.paytype=@t_paytype) 
	group by (case when aa.custno2!='' then aa.custno2 else aa.custno end) ,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end)
	--vcca
	union all
	select  ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end) salesno
	,SUM(isnull(ca.tax,0))
	from vcca ca left join view_vcc cb on ca.noa=cb.invono left join cust cc on ca.custno=cc.noa
	where (case when ca.mon!='' then ca.mon else LEFT(ca.datea,@r_lenm) end) between @t_bmon and @t_emon
	and (ca.taxtype='1' or ca.taxtype='5')
	group by ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end) 
	--union all
	--cara 
	--select ca.carownerno,ca.sssno,sum(outmoney) from cara ca left join caras cb on ca.noa=cb.noa where ca.mon between @t_bmon and @t_emon and cb.caritemno!='001' 
	--and @t_paytype='全部'
	--group by ca.carownerno,ca.sssno
)a left join sss s on isnull(a.salesno,'')=s.noa
where (a.custno between @t_bcustno and @t_ecustno ) 
and (a.salesno between @t_bsalesno and @t_esalesno) 
and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
group by custno,salesno

--本期已付
insert into @tmp (gno,custno,salesno,money,total,payed)
select '9',a.custno,a.salesno,0,0,SUM(a.payed) from (
	--trd 
	--select aa.custno,bb.salesno,SUM(isnull(payed,0)) payed from view_trd[1] aa left join cust bb on aa.custno=bb.noa where (case when len(aa.mon)=0 then left(aa.datea,@r_lenm) else aa.mon end) between @t_bmon and @t_emon 
	--and @t_paytype='全部'
	--group by  aa.custno,bb.salesno
	--union all
	--vcc 
	select (case when aa.custno2!='' then aa.custno2 else aa.custno end) custno,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end) salesno
	,SUM(isnull((case when aa.typea='1' then 1 else -1 end)*payed,0)) 
	+isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where len(vccno)>8 and right(vccno,@r_lenm) between @t_bmon and @t_emon and left(vccno,len(vccno)-7)=(case when aa.custno2!='' then aa.custno2 else aa.custno end)),0) payed 
	from view_vcc aa left join cust bb on aa.custno=bb.noa where (case when len(aa.mon)=0 then left(aa.datea,@r_lenm) else aa.mon end) between @t_bmon and @t_emon and (left(kind,4)!='健勞勞退')
	and (@t_paytype='全部' or aa.paytype=@t_paytype) 
	group by (case when aa.custno2!='' then aa.custno2 else aa.custno end) ,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end)
	--vcca
	union all
	select  ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end) salesno
	,0+isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where len(vccno)>8 and right(vccno,4)='-TAX' and left(right(vccno,10),@r_lenm) between @t_bmon and @t_emon and left(vccno,len(vccno)-11)=ca.custno),0)
	from vcca ca left join view_vcc cb on ca.noa=cb.invono left join cust cc on ca.custno=cc.noa
	where (case when ca.mon!='' then ca.mon else LEFT(ca.datea,@r_lenm) end) between @t_bmon and @t_emon
	and (ca.taxtype='1' or ca.taxtype='5')
	group by ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end)
	--union all
	--cara 
	--select ca.carownerno,ca.sssno,sum(inmoney) from cara ca left join caras cb on ca.noa=cb.noa where ca.mon between @t_bmon and @t_emon and cb.caritemno!='001' 
	--and @t_paytype='全部'
	--group by ca.carownerno,ca.sssno
)a left join sss s on isnull(a.salesno,'')=s.noa
where (a.custno between @t_bcustno and @t_ecustno ) 
and (a.salesno between @t_bsalesno and @t_esalesno) 
and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
group by a.custno,a.salesno

insert into @tmp (gno,custno,salesno,money,total,payed)
select '0',custno,salesno,SUM(money),SUM(total),SUM(payed) from @tmp group by custno,salesno

delete @tmp where gno='9'

delete @tmp where money=0 and total=0 and payed=0 
update @tmp
set comp=(select top 1 nick from ((select nick from cust where noa=custno union select namea from carOwner where noa=custno union select namea from sss where noa=custno))tmp)
,namea=(select namea from sss where noa=salesno)

insert into @tmp 
select '1'gno,'','',salesno,'',sum(money),sum(total),sum(payed) from @tmp group by salesno

select gno,custno,comp,salesno saleno,namea sales
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money),1)),4,12)) money
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,payed),1)),4,12)) payed
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money+total-payed),1)),4,12)) unpay
from @tmp order by salesno,gno,custno;
--**********************************************************************************************
z_vcc19:--z_vcc19
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
-------------------------------------------------------------------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

if(charindex('永勝',@t_acomp)>0)
begin
	set @mount_decimal =4
	set @weight_decimal =4
	set @price_decimal =4
end
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @mount_decimal =4
--------------------------------------------------
SET QUOTED_IDENTIFIER OFF
declare @tmp table(
	gno nvarchar(1),
	productno nvarchar(30),
	products nvarchar(MAX),
	cno nvarchar(30),
	custnick nvarchar(90),
	mount float,
	total float
)

insert into @tmp
	select '9',dbo.charbr(b.productno,12),b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
		,a.custno,	(case when isnull(c.nick,'') = '' then c.comp else c.nick end)
		,(case when a.typea='1' then 1 else -1 end)*b.mount,(case when a.typea='1' then 1 else -1 end)*b.total
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	where (a.datea between @t_bdate and @t_edate) and (a.custno between @t_bcustno and @t_ecustno) and 
			 (b.productno between @t_bproductno and @t_eproductno) 
			 and (len(@t_groupano)=0 or d.groupano = @t_groupano)
			 and (len(@t_groupbno)=0 or d.groupbno = @t_groupbno)
		  	 and (len(@t_groupcno)=0 or d.groupcno = @t_groupcno)
			 and (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea) and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by b.productno,b.product,a.custno,c.nick,c.comp
	
	insert into @tmp 
	select '0',productno,products,cno,custnick,SUM(mount),SUM(total) from @tmp
	group by productno,products,cno,custnick
	
	delete @tmp where gno='9'

	insert into @tmp(gno,cno,custnick,mount,total) 
	select '1',cno,custnick,sum(mount),sum(total) 
	from @tmp where gno='0' group by cno,custnick 
	
select gno,productno,products,cno,custnick
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),@mount_decimal,30)) mount 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),@total_decimal,30)) total 
from @tmp order by cno,custnick,gno,productno;

--********************************************************************************************************
--XY
--********************************************************************************************************
z_vcc1_xy:--z_vcc1_xy
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) =''
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
declare @t_bmon nvarchar(10)
declare @t_emon nvarchar(10)
if (@r_len='4')
	set @r_lenm='7'
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4
--------------------------------------------------
set @qhref_acomp='_xy'
-------------------------------------------------
set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
set @t_bmon = case when '#non' = [6] then '' else [6] end
set @t_emon = case when '#non' = [7] then char(255) else [7] end
--***********************************************************************************
SET QUOTED_IDENTIFIER OFF

declare @result table(
	gno nvarchar(10),
	noa nvarchar(30),
	noq nvarchar(10),
	typea nvarchar(12),
	datea nvarchar(10),
	mon nvarchar(7),
	custno nvarchar(30),
	comp nvarchar(90),
	productno nvarchar(30),
	xproduct nvarchar(MAX),
	unit nvarchar(12),
	lengthb float,
	lengthc float,
	mount float,
	weight float,
	price float,
	total float,
	qhref nvarchar(max),
	invono nvarchar(MAX),
	idate nvarchar(30),
	imoney float,
	itax float,
	itotal float
)

	insert into @result
	select '91' gno, a.noa noa, b.noq noq, a.typea typea, a.datea datea, (case when a.mon='' then left(a.datea,@r_lenm) else a.mon end), a.custno, a.comp
		, b.productno, b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end), b.unit, b.lengthb,b.lengthc
		  , b.mount, b.weight, b.price, b.total,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
		   ,a.invono,v.datea,v.money,v.tax,v.total
	from view_vccs b
	left join view_vcc a on a.noa = b.noa
	left join view_ucaucc c on b.productno = c.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	left join vcca v on a.invono=v.noa
	where (a.datea between @t_bdate and @t_edate) and
		  (a.custno between @t_bcustno and @t_ecustno) and
		  (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and
		  (b.productno between @t_bproductno and @t_eproductno) and
		  (len(@t_groupano)=0 or c.groupano = @t_groupano) and
		  (len(@t_groupbno)=0 or c.groupbno = @t_groupbno) and
		  (len(@t_groupcno)=0 or c.groupcno = @t_groupcno) and
		  (len(@t_typea)=0 or isnull(c.typea,'null') = @t_typea) and (len(@t_stype)=0 or a.stype = @t_stype) 
		  and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
		  and (isnull(c.tggno,'') between @t_btggno and @t_etggno) and (len(@vcctypea)=0 or a.typea = @vcctypea) 
		  and (len(@t_partno)=0 or s.partno=@t_partno)
		  and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
		  and (a.mon between @t_bmon and @t_emon)
	order by a.datea,gno,noa,noq
	
if(@t_showinvono='1')
begin
	insert into @result(gno,datea,noa,noq,invono,idate,imoney,itax,itotal)
	select '92',datea,noa,'ZZZ',invono,idate,imoney,itax,itotal
	from @result group by datea,noa,invono,idate,imoney,itax,itotal
end
	
insert into @result(gno,datea,noa,lengthb,lengthc,mount,price,total)
	select '93',datea,'ZZZZZZZZZZZZ',
		sum((case typea when '1' then lengthb else (-1)*lengthb end)),
		sum((case typea when '1' then lengthc else (-1)*lengthc end)),
		sum((case typea when '1' then mount else (-1)*mount end)),
		sum((case typea when '1' then price else (-1)*price end)),
		sum((case typea when '1' then total else (-1)*total end))
	from @result group by datea
	
insert into @result(gno,datea,noa,lengthb,lengthc,mount,price,total)
	select '94',left(datea,@r_lenm)+'z','ZZZZZZZZZZZZ',sum(lengthb),sum(lengthc),sum(mount),sum(price),sum(total)
	from @result a where gno='93' group by left(datea,@r_lenm)
--*************************************************************************	
update @result set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'
update @result set gno='0' where gno='91'
update @result set gno='1' where gno='92'
update @result set gno='2' where gno='93'
update @result set gno='3' where gno='94'

update @result
set mount=mount*-1,total=total*-1
where typea='退'

select gno, noa, noq, typea, datea, LEFT(datea,@r_lenm) xdatea, mon, custno, left(comp,10) comp, productno, xproduct,unit,qhref
	,dbo.getComma(lengthb,-1) lengthb
	,dbo.getComma(lengthc,-1) lengthc
	,dbo.getComma(mount,-1) mount
	,dbo.getComma(weight,-1) weight
	,dbo.getComma(price,-1) price
	,dbo.getComma(total,-1) total
	,invono,idate
	,dbo.getComma(imoney,-1) imoney
	,dbo.getComma(itax,-1) itax
	,dbo.getComma(itotal,-1) itotal
from @result order by datea,noa,noq;
--*********************************************************************************************************
z_vcc3_xy:--z_vcc3_xy
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bsalesno nvarchar(20)
	declare @t_esalesno nvarchar(20)
	declare @t_bproductno nvarchar(30)
	declare @t_eproductno nvarchar(30)
	declare @t_btggno nvarchar(50)
	declare @t_etggno nvarchar(50)
	declare @t_typea nvarchar(30)
	declare @t_groupano nvarchar(30)
	declare @t_groupbno nvarchar(30)
	declare @t_groupcno nvarchar(30)
	declare @t_stype nvarchar(30)
	declare @t_salesgroup nvarchar(100)
	declare @t_showinvono nvarchar(10)
	declare @t_acomp nvarchar(MAX)='[3]'
	declare @qhref_acomp nvarchar(10) =''
	declare @vcctypea nvarchar(10) =''
	declare @t_partno nvarchar(30)
	declare @isspec nvarchar(10)='[25]'
	declare @t_multcust nvarchar(max)
	declare @t_multucc nvarchar(max)
	declare @r_len nvarchar(10)='[28]'
	declare @r_lenm nvarchar(10)='6'
	if (@r_len='4')
		set @r_lenm='7'
	
	set @t_bdate = case when '#non'=[4] then '' else [4] end
	set @t_edate = case when '#non'=[5] then char(255) else [5] end
	set @t_bcustno = case when '#non'=[8] then '' else [8] end
	set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
	set @t_bsalesno = case when '#non'=[10] then '' else [10] end
	set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
	set @t_bproductno = case when '#non'=[12] then '' else [12] end
	set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
	set @t_btggno = case when '#non' = [14] then '' else [14] end
	set @t_etggno = case when '#non' = [15] then char(255) else [15] end
	set @t_typea = case when '#non'=[16] then '' else [16] end
	set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
	set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
	set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
	set @t_stype = case when '#non'=[20] then '' else [20] end
	set @t_salesgroup = case when '#non' = [21] then '' else [21] end
	set @t_showinvono = case when '#non' = [24] then 0 else [24] end
	set @vcctypea = case when '#non' = [22] then '' else [22] end
	set @t_partno = case when '#non' = [23] then '' else [23] end
	set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
	set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4
--------------------------------------------------
set @qhref_acomp='_xy'
-------------------------------------------------
	SET QUOTED_IDENTIFIER OFF
	
	declare @result table(
		gno nvarchar(1),
		typea nvarchar(4),
		noa nvarchar(15),
		noq nvarchar(3),
		datea nvarchar(10),
		mon nvarchar(7),
		custno nvarchar(20),
		comp nvarchar(90),
		addr_invo nvarchar(90),
		tel nvarchar(90),
		productno nvarchar(30),
		xproduct nvarchar(MAX),
		unit nvarchar(8),
		lengthb float,
		lengthc float,
		mount float,
		weight float,
		price float,
		total float,
		money float,
		back float,
		tax float,
		total1 float,
		pay float,
		unpay float,
		total2 float,
		pcount int,
		qhref nvarchar(MAX)
		primary key (custno,productno,gno,datea,noa,noq) 
	)
	
	insert into @result
	select '0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, a.mon mon, 
		   a.custno custno, isnull(c.comp,''), isnull(c.addr_invo,''), isnull(c.tel,''), b.productno
		   , b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
		   , b.unit,b.lengthb,b.lengthc,b.mount, b.weight, b.price, b.total, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
	       ,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vccs b
	left join view_vcc a on a.noa = b.noa
	left join cust c on  a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
		  (a.custno between @t_bcustno and @t_ecustno) and
		  (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and
		  (b.productno between @t_bproductno and @t_eproductno) and
		  (len(@t_groupano)=0 or d.groupano = @t_groupano) and 
		  (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and
		  (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea) and (len(@t_stype)=0 or a.stype = @t_stype) 
		  and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
		  and (isnull(d.tggno,'') between @t_btggno and @t_etggno) and (len(@vcctypea)=0 or a.typea = @vcctypea) 
		  and (len(@t_partno)=0 or s.partno=@t_partno)
		  and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by custno,productno,gno,datea,noa,noq
	--***********************************************************************
	insert @result(gno,custno,comp,productno,lengthb,lengthc,mount,total,datea,noa,noq)
	select '1',custno,MAX(comp),productno
	,sum(case typea when '1' then 1 else -1 end*lengthb)
	,sum(case typea when '1' then 1 else -1 end*lengthc)
	,sum(case typea when '1' then 1 else -1 end*mount)
	,sum(case typea when '1' then 1 else -1 end*total) ,CHAR(255),CHAR(255),CHAR(255)
	from @result where gno='0'
	group by custno,productno
	
	insert @result(gno,custno,comp,productno,lengthb,lengthc,mount,total,datea,noa,noq)
	select '2',custno,MAX(comp),char(255)
	,sum(case typea when '1' then 1 else -1 end*lengthb)
	,sum(case typea when '1' then 1 else -1 end*lengthc)
	,sum(case typea when '1' then 1 else -1 end*mount)
	,sum(case typea when '1' then 1 else -1 end*total) ,CHAR(255),CHAR(255),CHAR(255)
	from @result where gno='0'
	group by custno
	
	--***********************************************************************
	update @result set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'
	
	update @result
	set mount=mount*-1,total=total*-1,lengthb=lengthb*-1,lengthc=lengthc*-1
	where typea='退'

	select gno, typea, noa, noq, datea, mon, custno, comp
	,addr_invo,tel,productno,xproduct,unit
	,dbo.getComma(lengthb,-1) lengthb
	,dbo.getComma(lengthc,-1) lengthc
	,dbo.getComma(mount,-1) mount
	,dbo.getComma(total,-1) total
	,dbo.getComma(price,-1) price 
	,pcount ,qhref
	from @result order by custno,productno,gno,datea,noa,noq;
--**********************************************************************************************
z_vcc4_xy:--z_vcc4_xy
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
-------------------------------------------------------------------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

--------------------------------------------------
SET QUOTED_IDENTIFIER OFF
declare @tmp table(
	gno nvarchar(1),
	productno nvarchar(30),
	products nvarchar(MAX),
	unit nvarchar(10),
	cno nvarchar(30),
	custnick nvarchar(90),
	lengthb float,
	lengthc float,
	mount float,
	total float
)
	insert into @tmp
	select '9',b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end),d.unit
	,a.custno,(case when isnull(c.nick,'') = '' then c.comp else c.nick end)
	,(case when a.typea='1' then 1 else -1 end)*b.lengthb
	,(case when a.typea='1' then 1 else -1 end)*b.lengthc
	,(case when a.typea='1' then 1 else -1 end)*b.mount
	,(case when a.typea='1' then 1 else -1 end)*b.total
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	where (a.datea between @t_bdate and @t_edate) and (a.custno between @t_bcustno and @t_ecustno) and 
			 (b.productno between @t_bproductno and @t_eproductno) 
			 and (len(@t_groupano)=0 or d.groupano = @t_groupano)
			 and (len(@t_groupbno)=0 or d.groupbno = @t_groupbno)
		  	 and (len(@t_groupcno)=0 or d.groupcno = @t_groupcno)
			 and (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea) and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno) and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by b.productno,b.product,a.custno,c.nick,c.comp	
	
	insert into @tmp 
	select '0',productno,products,unit,cno,custnick,SUM(lengthb),SUM(lengthc),SUM(mount),SUM(total) from @tmp
	group by productno,products,unit,cno,custnick
	
	delete @tmp where gno='9'

	insert into @tmp(gno,productno,products,lengthb,lengthc,mount,total) 
	select '1',productno,products,sum(lengthb),sum(lengthc),sum(mount),sum(total) 
	from @tmp where gno='0' group by productno,products
	
select gno,productno,products,cno, custnick
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,dbo.getComma(lengthb,-1) lengthb
,dbo.getComma(lengthc,-1) lengthc
,dbo.getComma(mount,-1) mount
,dbo.getComma(total,-1) total
from @tmp order by productno,products,gno,cno;
--**********************************************************************************************
z_vcc5_xy:--z_vcc5_xy
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) =''
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4
--------------------------------------------------
set @qhref_acomp='_xy'
-------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @result table(
	gno nvarchar(1),
	typea nvarchar(4),
	noa nvarchar(30),
	noq nvarchar(3),
	datea nvarchar(10),
	mon nvarchar(7),
	custno nvarchar(20),
	comp nvarchar(90),
	addr_invo nvarchar(90),
	tel nvarchar(90),
	productno nvarchar(30),
	xproduct nvarchar(MAX),
	unit nvarchar(8),
	lengthb float,
	lengthc float,
	mount float,
	weight float,
	price float,
	total float,
	pcount int,
	qhref nvarchar(MAX)
)

insert into @result
	select '0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, a.mon mon, 
		   a.custno custno, isnull(c.comp,''), isnull(c.addr_invo,''), isnull(c.tel,''), b.productno
		   , b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
		   , b.unit,b.lengthb,b.lengthc,b.mount, b.weight, b.price, b.total, 0 pcount,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vccs b
	left join view_vcc a on a.noa = b.noa
	left join cust c on  a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
		  (a.custno between @t_bcustno and @t_ecustno) and
		  (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and
		  (b.productno between @t_bproductno and @t_eproductno) and
		  (len(@t_groupano)=0 or d.groupano = @t_groupano) and 
		  (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and
		  (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
		  and (len(@t_stype)=0 or a.stype = @t_stype) 
		  and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
		  and (isnull(d.tggno,'') between @t_btggno and @t_etggno) and (len(@vcctypea)=0 or a.typea = @vcctypea) 
		  and (len(@t_partno)=0 or s.partno=@t_partno)
		  and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by custno,gno,mon,datea,noa,noq
	
insert into @result(gno,custno,pcount,lengthb,lengthc,mount,total)
	select '1',custno,
		count(*),
		sum((case typea when '1' then lengthb else (-1)*lengthb end)),
		sum((case typea when '1' then lengthc else (-1)*lengthc end)),
		sum((case typea when '1' then mount else (-1)*mount end)),
		sum((case typea when '1' then total else (-1)*total end))
	from @result a group by custno
	
update @result set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'

update @result
	set mount=mount*-1,total=total*-1,lengthb=lengthb*-1,lengthc=lengthc*-1
	where typea='退'

select 
	gno,typea,noa,noq,datea,mon,custno,comp,addr_invo,tel,productno,xproduct,unit, qhref
	,dbo.getComma(lengthb,-1) lengthb
	,dbo.getComma(lengthc,-1) lengthc
	,dbo.getComma(mount,-1) mount
	,dbo.getComma(price,-1) price
	,dbo.getComma(total,-1) total
	,pcount 
from @result order by custno,gno,mon,datea,noa,noq;
--**********************************************************************************************
z_vcc6_xy:--z_vcc6_xy
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
-------------------------------------------------------------------------------------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

--------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	custno nvarchar(30),
	custs nvarchar(90),
	mon nvarchar(15),
	lengthb float,
	lengthc float,
	mount float,
	total float,
	tax float
)

insert into @tmp
	select
		'0',a.custno,(case when isnull(c.nick,'') = '' then c.comp else c.nick end),
		case when isnull(a.mon,'')!='' then a.mon else left(a.datea,@r_lenm) end
		,sum((case when a.typea='1' then 1 else -1 end)*b.lengthb)
		,sum((case when a.typea='1' then 1 else -1 end)*b.lengthc)
		,sum((case when a.typea='1' then 1 else -1 end)*b.mount)
		,sum((case when a.typea='1' then 1 else -1 end)*b.total)
		,sum((case when a.typea='1' then 1 else -1 end)*a.tax)
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	where  (a.datea between @t_bdate and @t_edate) and --(isnull(a.salesno,'') != '') and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and 
			 (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  	 (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and
			 (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea) and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno) and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	group by a.custno,c.nick,c.comp,case when isnull(a.mon,'')!='' then a.mon else left(a.datea,@r_lenm) end
	
insert into @tmp(gno,custno,custs,mon,lengthb,lengthc,mount,total,tax) 
select '1',custno,custs,'999/99',sum(lengthb),sum(lengthc),sum(mount),sum(total),sum(tax) from @tmp group by custno,custs

insert into @tmp(gno,custno,lengthb,lengthc,mount,total,tax) 
select '2','ZZZZ_ZZZ',sum(lengthb),sum(lengthc),sum(mount), sum(total), sum(tax) from @tmp where gno='1'


select gno,custno cno,left(custs,10) custs,mon
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,dbo.getComma(lengthb,-1) lengthb
,dbo.getComma(lengthc,-1) lengthc
,dbo.getComma(mount,-1) mount
,dbo.getComma(total,-1) total
,dbo.getComma(tax,-1) tax
from @tmp order by custno,mon,gno;
--**********************************************************************************************
z_vcc7_xy:--z_vcc7_xy
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) =''
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4
--------------------------------------------------
set @qhref_acomp='_xy'
-------------------------------------------------
	SET QUOTED_IDENTIFIER OFF
	
	declare @result table(
		gno nvarchar(1),
		typea nvarchar(4),
		noa nvarchar(15),
		noq nvarchar(3),
		datea nvarchar(10),
		mon nvarchar(7),
		custno nvarchar(20),
		comp nvarchar(90),
		addr_invo nvarchar(90),
		tel nvarchar(90),
		productno nvarchar(30),
		xproduct nvarchar(MAX),
		unit nvarchar(8),
		lengthb float,
		lengthc float,
		mount float,
		weight float,
		price float,
		total float,
		money float,
		back float,
		tax float,
		total1 float,
		pay float,
		unpay float,
		total2 float,
		pcount int,
		qhref nvarchar(MAX)
		primary key (productno,gno,datea,noa,noq) 
	)
	
	insert into @result
	select '0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, case when isnull(a.mon,'')!='' then a.mon else left(a.datea,@r_lenm) end mon, 
		   a.custno custno, isnull(c.comp,''), isnull(c.addr_invo,''), isnull(c.tel,''), b.productno
		   , b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
		   , b.unit,(case when a.typea='1' then 1 else -1 end) *b.lengthb,(case when a.typea='1' then 1 else -1 end) *b.lengthc
		   ,(case when a.typea='1' then 1 else -1 end) *b.mount, b.weight, b.price, b.total, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
	       ,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vccs b
	left join view_vcc a on a.noa = b.noa
	left join cust c on  a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
		  (a.custno between @t_bcustno and @t_ecustno) and
		  (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and
		  (b.productno between @t_bproductno and @t_eproductno) and
		  (len(@t_groupano)=0 or d.groupano = @t_groupano) and 
		  (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and
		  (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
		  and (len(@t_stype)=0 or a.stype = @t_stype) 
		  and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
		  and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
		  and (len(@vcctypea)=0 or a.typea = @vcctypea) 
		  and (len(@t_partno)=0 or s.partno=@t_partno)
		  and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by productno,gno,datea,noa,noq

	--***********************************************************************
	declare @gno nvarchar(1)
	declare @typea nvarchar(4)
	declare @noa nvarchar(15)
	declare @total float
	declare @datea nvarchar(10)
	declare @productno nvarchar(30)
	declare @t_productno nvarchar(30)
	declare @t_money float
	declare @t_back float
	declare @t_tax float
	declare @t_total1 float
	declare @t_pcount int
	set @t_productno = '#zzzz#zzzz'
	set @t_money = 0
	set @t_back = 0
	set @t_tax = 0
	set @t_total1 = 0
	set @t_pcount = 0
	--***********************************************************************
	declare cursor_table cursor for
	select gno,typea,productno,datea,total from @result
	open cursor_table
	fetch next from cursor_table
	into @gno,@typea,@productno,@datea,@total
	while(@@FETCH_STATUS <> -1)
	begin
		if @t_productno != @productno
		begin
			if @t_productno != '#zzzz#zzzz'
			begin
				set @t_total1 = @t_money - @t_back + @t_tax
				insert into @result
				select '1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, '' custno, '' comp, '' addr_invo, '' tel, 
				       @t_productno, '' product, '' unit,0,0, 0 mount, 0 weight, 0 price, 0 total, 
					   @t_money, @t_back, @t_tax, @t_total1, 0 pay, 0 unpay, 0 total2, @t_pcount,''
			end
			set @t_productno = @productno
			set @t_money = case when @typea = '1' then @total else 0 end
			set @t_back = case when @typea = '2' then @total else 0 end
			set @t_tax = case when @typea = '稅' then @total else 0 end
			set @t_pcount = 1
		end
		else
		begin
			set @t_money = @t_money + case when @typea = '1' then @total else 0 end
			set @t_back = @t_back + case when @typea = '2' then @total else 0 end
			set @t_tax = @t_tax + case when @typea = '稅' then @total else 0 end
			set @t_pcount = @t_pcount + 1
		end
		fetch next from cursor_table
		into @gno,@typea,@productno,@datea,@total
	end
	close cursor_table
	deallocate cursor_table
	
	if @t_productno != '#zzzz#zzzz'
	begin
		set @t_total1 = @t_money - @t_back + @t_tax
		insert into @result
		select '1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, '' custno, '' comp, '' addr_invo, '' tel, 
		       @t_productno, '' product, '' unit,0,0, 0 mount, 0 weight, 0 price, 0 total, 
			   @t_money, @t_back, @t_tax, @t_total1, 0 pay, 0 unpay, 0 total2, @t_pcount,''
	end
	--***********************************************************************
	update @result set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'
	
	update a 
	set mount=(select sum(mount) from @result where gno='0' and productno=a.productno) 
	,lengthb=(select sum(lengthb) from @result where gno='0' and productno=a.productno)
	,lengthc=(select sum(lengthc) from @result where gno='0' and productno=a.productno)
	from @result a	where gno='1' 
	
	update @result
	set total=total*-1
	where typea='退'
	
	select gno, typea, noa, noq, datea, mon, custno, left(comp,10) comp
	,addr_invo,tel,productno,xproduct,unit, qhref
	,dbo.getComma(lengthb,-1) lengthb
	,dbo.getComma(lengthc,-1) lengthc
	,dbo.getComma(mount,-1) mount
	,dbo.getComma(price,-1) price
	,dbo.getComma(total,-1) total
	,dbo.getComma(total1,-1) total1
	,pcount 
	from @result order by productno,gno,datea,noa,noq;
--**********************************************************************************************
z_vcc8_xy:--z_vcc8_xy
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end

--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

--------------------------------------------------
SET QUOTED_IDENTIFIER OFF	

declare @tmp table(
	gno nvarchar(1),
	productno nvarchar(30),
	products nvarchar(MAX),
	mon nvarchar(15),
	lengthb float,
	lengthc float,
	mount float,
	total float
)
declare @cmd nvarchar(max)

insert into @tmp
	select
		'0',b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
		,case when charindex('永勝',@t_acomp)>0 then left(a.datea,@r_lenm) when isnull(a.mon,'')!='' then a.mon else left(a.datea,@r_lenm) end
		,sum((case when a.typea='1' then 1 else -1 end)*b.lengthb),sum((case when a.typea='1' then 1 else -1 end)*b.lengthc)
		,sum((case when a.typea='1' then 1 else -1 end)*b.mount),sum((case when a.typea='1' then 1 else -1 end)*b.total)
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join view_ucaucc d on b.productno = d.noa
	where  (a.datea between @t_bdate and @t_edate) and --(isnull(a.salesno,'') != '') and
	 		(a.custno between @t_bcustno and @t_ecustno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and
			 (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  	 (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and 
			 (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	group by b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
	,case when charindex('永勝',@t_acomp)>0 then left(a.datea,@r_lenm) when isnull(a.mon,'')!='' then a.mon else left(a.datea,@r_lenm) end
	
insert into @tmp(gno,productno,products,mon,lengthb,lengthc,mount,total)
select '1',productno,products,'999/99',sum(lengthb),sum(lengthc),sum(mount),sum(total)
from @tmp group by productno,products
	
insert into @tmp(gno,productno,lengthb,lengthc,mount,total)
select '2','ZZZZZZZZZZZZ',sum(lengthb),sum(lengthc),sum(mount),sum(total)
from @tmp where gno='1'

select gno,productno,(case when gno='0' then dbo.charbr(products,24) else products end )products,mon
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,dbo.getComma(lengthb,-1) lengthb
,dbo.getComma(lengthc,-1) lengthc
,dbo.getComma(mount,-1) mount
,dbo.getComma(total,-1) total
from @tmp order by productno,mon,gno;
--**********************************************************************************************
z_vcc9_xy:--z_vcc9_xy
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) =''
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

--------------------------------------------------
set @qhref_acomp='_xy'
-------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	salesno nvarchar(30),
	salesname nvarchar(50),
	comp nvarchar(100),
	datea nvarchar(10),
	noa nvarchar(35),
	typea nvarchar(15),
	productno nvarchar(30),
	products nvarchar(max),
	unit nvarchar(15),
	lengthb float,
	lengthc float,
	mount float,
	price float,
	total float,
	qhref nvarchar(max)
)
declare @cmd nvarchar(max)

insert into @tmp
	select '0',a.salesno,s.namea,a.comp,a.datea,a.noa,a.typea,b.productno
	,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end),b.unit,b.lengthb,b.lengthc
	,b.mount,b.price,b.total
	,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vcc a
	left join view_vccs b  on a.noa = b.noa and a.accy = b.accy
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and --(isnull(a.salesno,'') != '') and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and
			 (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  	 (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and 
			 (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_partno)=0 or s.partno=@t_partno)
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by a.salesno,a.datea

insert into @tmp(gno,salesno,salesname,lengthb,lengthc,mount,total)
	select '1' gno,salesno,salesname,
		sum((case when typea='1' then lengthb else lengthb*(-1) end)),
		sum((case when typea='1' then lengthc else lengthc*(-1) end)),
		sum((case when typea='1' then mount else mount*(-1) end)),
		sum((case when typea='1' then total else total*(-1) end)) 
	from @tmp group by salesno,salesname
update @tmp set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'

update @tmp
set mount=mount*-1,total=total*-1,lengthb=lengthb*-1,lengthc=lengthc*-1
where typea='退'

select gno,salesno,salesname,left(comp,10)comp,datea,noa,typea,productno,products,unit,qhref
,dbo.getComma(lengthb,-1) lengthb
,dbo.getComma(lengthc,-1) lengthc
,dbo.getComma(mount,-1) mount
,dbo.getComma(price,-1) price
,dbo.getComma(total,-1) total
from @tmp order by salesno,salesname,gno,datea,productno;
--**********************************************************************************************
z_vcc10_xy:--z_vcc10_xy
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

--------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	salesno nvarchar(30),
	salesname nvarchar(90),
	mon nvarchar(15),
	lengthb float,
	lengthc float,
	mount float,
	total float
)

insert into @tmp
	select
		'0',a.salesno,s.namea,case when isnull(a.mon,'')!='' then a.mon else left(a.datea,@r_lenm) end
		,sum((case when a.typea='1' then 1 else -1 end)*b.lengthb)
		,sum((case when a.typea='1' then 1 else -1 end)*b.lengthc)
		,sum((case when a.typea='1' then 1 else -1 end)*b.mount)
		,sum((case when a.typea='1' then 1 else -1 end)*b.total)
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where  (a.datea between @t_bdate and @t_edate) and --(isnull(a.salesno,'') != '') and
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and 
			 (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  	 (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and
			 (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and  (a.custno between @t_bcustno and @t_ecustno) 
			 and (isnull(b.productno,'') between @t_bproductno and @t_eproductno)
			and (len(@t_stype)=0 or a.stype = @t_stype) 
			and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			and (len(@t_partno)=0 or s.partno=@t_partno)
			and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	group by a.salesno,s.namea,case when isnull(a.mon,'')!='' then a.mon else left(a.datea,@r_lenm) end
	
insert into @tmp(gno,salesno,salesname,mon,lengthb,lengthc,mount,total)
select '1',salesno,salesname,'999/99',sum(lengthb),sum(lengthc),sum(mount),sum(total)
from @tmp group by salesno,salesname
	
insert into @tmp(gno,salesno,lengthb,lengthc,mount,total)
select '2','ZZZZZZ',sum(lengthb),sum(lengthc),sum(mount),sum(total)
from @tmp where gno='1'
	
select gno,salesno sno,salesname,mon
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,dbo.getComma(lengthb,-1) lengthb
,dbo.getComma(lengthc,-1) lengthc
,dbo.getComma(mount,-1) mount
,dbo.getComma(total,-1) total
from @tmp order by salesno,mon,gno;
--**********************************************************************************************
z_vcc11_xy:--z_vcc11_xy
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) =''
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4
--------------------------------------------------
	set @qhref_acomp='_xy'
-------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	salesno nvarchar(30),
	salesname nvarchar(50),
	comp nvarchar(100),
	datea nvarchar(10),
	noa nvarchar(35),
	typea nvarchar(15),
	productno nvarchar(30),
	products nvarchar(max),
	unit nvarchar(15),
	lengthb float,
	lengthc float,
	mount float,
	price float,
	total float,
	qhref nvarchar(max)
)

insert into @tmp
	select '0',a.salesno,s.namea,a.comp,a.datea,a.noa,a.typea
	,b.productno
	,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
	,b.unit,b.lengthb,b.lengthc,b.mount,b.price,b.total
	,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vcc a
	left join view_vccs b  on a.noa = b.noa and a.accy = b.accy
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and --(isnull(a.salesno,'') != '') and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and
			 (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  	 (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and 
			 (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_partno)=0 or s.partno=@t_partno)
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by a.salesno,b.productno

insert into @tmp(gno,salesno,salesname,lengthb,lengthc,mount,total)
	select '1' gno,salesno,salesname,
		sum((case when typea='1' then lengthb else lengthb*(-1) end)),
		sum((case when typea='1' then lengthc else lengthc*(-1) end)),
		sum((case when typea='1' then mount else mount*(-1) end)),
		sum((case when typea='1' then total else total*(-1) end)) 
	from @tmp group by salesno,salesname
	
update @tmp set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'

update @tmp
set mount=mount*-1,total=total*-1,lengthb=lengthb*-1,lengthc=lengthc*-1
where typea='退'

select 
gno,salesno,salesname,left(comp,10) comp,productno,products,datea,noa,typea,unit, qhref
,dbo.getComma(lengthb,-1) lengthb
,dbo.getComma(lengthc,-1) lengthc
,dbo.getComma(mount,-1) mount
,dbo.getComma(price,-1) price
,dbo.getComma(total,-1) total
from @tmp order by salesno,salesname,gno,productno,datea;
--**********************************************************************************************
z_vcc12_xy:--z_vcc12_xy
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4
--------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	salesno nvarchar(30),
	salesname nvarchar(50),
	productno nvarchar(30),
	products nvarchar(max),
	lengthb float,
	lengthc float,
	mount float,
	total float
)

insert into @tmp
	select '0',a.salesno,s.namea,b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
	,sum((case when a.typea='1' then 1 else -1 end)*b.lengthb)
	,sum((case when a.typea='1' then 1 else -1 end)*b.lengthc)
	,sum((case when a.typea='1' then 1 else -1 end)*b.mount)
	,sum((case when a.typea='1' then 1 else -1 end)*b.total)
	from view_vcc a
	left join view_vccs b  on a.noa = b.noa and a.accy = b.accy
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and 
			  (a.custno between @t_bcustno and @t_ecustno) and 
			 --(isnull(a.salesno,'') != '') and 
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and
			 (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  	 (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and 
			 (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_partno)=0 or s.partno=@t_partno)
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	group by a.salesno,s.namea,b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
	order by a.salesno,b.productno
	
insert into @tmp(gno,lengthb,lengthc,mount,total)
select '1',sum(lengthb),sum(lengthc),sum(mount),sum(total)
from @tmp

select gno,salesno sno ,salesname,productno,products
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,dbo.getComma(lengthb,-1) lengthb
,dbo.getComma(lengthc,-1) lengthc
,dbo.getComma(mount,-1) mount
,dbo.getComma(total,-1) total
from @tmp order by gno,salesno,productno;
--**********************************************************************************************
z_vcc13_xy:--z_vcc13_xy
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) =''
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4
--------------------------------------------------
set @qhref_acomp='_xy'
-------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	custno nvarchar(30),
	custnick nvarchar(90),
	salesno nvarchar(30),
	salesname nvarchar(50),
	productno nvarchar(30),
	products nvarchar(max),
	datea nvarchar(10),
	noa nvarchar(35),
	typea nvarchar(15),
	unit nvarchar(15),
	lengthb float,
	lengthc float,
	mount float,
	price float,
	total float,
	qhref nvarchar(MAX)
)

insert into @tmp
	select '0',a.custno,(case when isnull(c.nick,'') = '' then left(c.comp,10) else c.nick end),
	a.salesno,s.namea,b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
	,a.datea,a.noa,a.typea,b.unit,b.lengthb,b.lengthc,b.mount,b.price,b.total
	,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vcc a
	left join view_vccs b  on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and --(isnull(a.salesno,'') != '') and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			 and (len(@t_groupbno)=0 or d.groupbno = @t_groupbno)
		  	 and (len(@t_groupcno)=0 or d.groupcno = @t_groupcno)
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_partno)=0 or s.partno=@t_partno)
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by a.salesno,a.custno,b.productno
	
insert into @tmp(gno,salesno,salesname,lengthb,lengthc,mount,total)
	select '1' gno,salesno,salesname,
		sum((case when typea='1' then lengthb else lengthb*(-1) end)),
		sum((case when typea='1' then lengthc else lengthc*(-1) end)),
		sum((case when typea='1' then mount else mount*(-1) end)),
		sum((case when typea='1' then total else total*(-1) end)) 
	from @tmp group by salesno,salesname
	
update @tmp set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'

update @tmp
set mount=mount*-1,total=total*-1,lengthb=lengthb*-1,lengthc=lengthc*-1
where typea='退'

select gno,custno,custnick,salesno,salesname,productno,products,datea,noa,typea,unit,qhref
,dbo.getComma(lengthb,-1) lengthb
,dbo.getComma(lengthc,-1) lengthc
,dbo.getComma(mount,-1) mount
,dbo.getComma(price,-1) price
,dbo.getComma(total,-1) total
from @tmp order by salesno,gno,custno,productno,datea;
--**********************************************************************************************
z_vcc14_xy:--z_vcc14_xy
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4
--------------------------------------------------
SET QUOTED_IDENTIFIER OFF	

declare @tmp table(
	gno nvarchar(1),
	custno nvarchar(30),
	custnick nvarchar(90),
	salesno nvarchar(30),
	salesname nvarchar(50),
	productno nvarchar(30),
	products nvarchar(max),
	lengthb float,
	lengthc float,
	mount float,
	total float
)

insert into @tmp
	select '0',a.custno,(case when isnull(c.nick,'') = '' then left(c.comp,10) else c.nick end),
	a.salesno,s.namea,b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
	,sum((case when a.typea='1' then 1 else -1 end)*b.lengthb)
	,sum((case when a.typea='1' then 1 else -1 end)*b.lengthc)
	,sum((case when a.typea='1' then 1 else -1 end)*b.mount)
	,sum((case when a.typea='1' then 1 else -1 end)*b.total)
	from view_vcc a
	left join view_vccs b  on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (isnull(a.salesno,'')between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and --(isnull(a.salesno,'') != '') and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and
			 (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  	 (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and 
			 (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			and (len(@vcctypea)=0 or a.typea = @vcctypea)
			and (len(@t_partno)=0 or s.partno=@t_partno)
			and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
			and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	group by a.salesno,s.namea,a.custno,c.nick,c.comp,b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
	order by a.salesno,a.custno,b.productno
	
insert into @tmp(gno,lengthb,lengthc,mount,total)
select '1',sum(lengthb),sum(lengthc),sum(mount),sum(total)
from @tmp

select gno,custno,custnick,salesno sno ,salesname,productno,products
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,dbo.getComma(lengthb,-1) lengthb
,dbo.getComma(lengthc,-1) lengthc
,dbo.getComma(mount,-1) mount
,dbo.getComma(total,-1) total
from @tmp order by gno,salesno,custno,productno;
--**********************************************************************************************
z_vcc15_xy:--z_vcc15_xy
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) =''
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4
--------------------------------------------------
set @qhref_acomp='_xy'
-------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	productno nvarchar(30),
	products nvarchar(MAX),
	sno nvarchar(30),
	salesname nvarchar(90),
	cno nvarchar(30),
	custnick nvarchar(90),
	datea nvarchar(10),
	noa nvarchar(30),
	typea nvarchar(15),
	lengthb float,
	lengthc float,
	mount float,
	price float,
	total float,
	qhref nvarchar(MAX)
)

insert into @tmp
	select
		'0',b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
		,a.salesno,s.namea,a.custno,
		(case when isnull(c.nick,'') = '' then left(c.comp,10) else c.nick end),
		a.datea,a.noa,a.typea,b.lengthb,b.lengthc,b.mount,b.price,b.total,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and
			 (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  	 (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and 
			 (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno) and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_partno)=0 or s.partno=@t_partno)
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by b.productno,b.product,a.salesno,s.namea,a.custno,c.nick,c.comp,a.datea,a.noa,a.typea
	  
insert into @tmp(gno,productno,products,lengthb,lengthc,mount,total)
	select '1',productno,products,
		sum((case when typea='1' then lengthb else lengthb*(-1) end)),
		sum((case when typea='1' then lengthc else lengthc*(-1) end)),
		sum((case when typea='1' then mount else mount*(-1) end)),
		sum((case when typea='1' then total else total*(-1) end))
	from @tmp group by productno,products
update @tmp set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'

update @tmp
set mount=mount*-1,total=total*-1,lengthb=lengthb*-1,lengthc=lengthc*-1
where typea='退'

select gno,productno,products,sno,salesname,cno,custnick,datea,noa,typea, qhref
,dbo.getComma(lengthb,-1) lengthb
,dbo.getComma(lengthc,-1) lengthc
,dbo.getComma(mount,-1) mount
,dbo.getComma(price,-1) price
,dbo.getComma(total,-1) total
from @tmp order by productno,products,gno,sno,cno,datea,typea;
--**********************************************************************************************
z_vcc16_xy:--z_vcc16_xy
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

--------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	productno nvarchar(30),
	products nvarchar(MAX),
	sno nvarchar(30),
	salesname nvarchar(90),
	cno nvarchar(30),
	custnick nvarchar(90),
	lengthb float,
	lengthc float,
	mount float,
	total float
)

insert into @tmp
	select
		'0',b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
		,a.salesno,s.namea,a.custno,
		(case when isnull(c.nick,'') = '' then c.comp else c.nick end)
		,sum((case when a.typea='1' then 1 else -1 end)*b.lengthb)
		,sum((case when a.typea='1' then 1 else -1 end)*b.lengthc)
		,sum((case when a.typea='1' then 1 else -1 end)*b.mount)
		,sum((case when a.typea='1' then 1 else -1 end)*b.total)
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			 and (len(@t_groupbno)=0 or d.groupbno = @t_groupbno)
		  	 and (len(@t_groupcno)=0 or d.groupcno = @t_groupcno)
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_partno)=0 or s.partno=@t_partno)
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	group by b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
	,a.salesno,s.namea,a.custno,c.nick,c.comp
	
insert into @tmp(gno,productno,products,lengthb,lengthc,mount,total)
select '1',productno,products,sum(lengthb),sum(lengthc),sum(mount),sum(total)
from @tmp group by productno,products
	
select gno,productno,products,sno,salesname,cno,custnick 
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,dbo.getComma(lengthb,-1) lengthb
,dbo.getComma(lengthc,-1) lengthc
,dbo.getComma(mount,-1) mount
,dbo.getComma(total,-1) total
from @tmp order by productno,products,gno,sno,cno;
--**********************************************************************************************
z_vcc19_xy:--z_vcc19_xy
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
-------------------------------------------------------------------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

--------------------------------------------------
SET QUOTED_IDENTIFIER OFF
declare @tmp table(
	gno nvarchar(1),
	productno nvarchar(30),
	products nvarchar(MAX),
	cno nvarchar(30),
	custnick nvarchar(90),
	lengthb float,
	lengthc float,
	mount float,
	total float
)

insert into @tmp
	select '9',b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
		,a.custno,	(case when isnull(c.nick,'') = '' then c.comp else c.nick end)
		,(case when a.typea='1' then 1 else -1 end)*b.lengthb
		,(case when a.typea='1' then 1 else -1 end)*b.lengthc
		,(case when a.typea='1' then 1 else -1 end)*b.mount,(case when a.typea='1' then 1 else -1 end)*b.total
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	where (a.datea between @t_bdate and @t_edate) and (a.custno between @t_bcustno and @t_ecustno) and 
			 (b.productno between @t_bproductno and @t_eproductno) 
			 and (len(@t_groupano)=0 or d.groupano = @t_groupano)
			 and (len(@t_groupbno)=0 or d.groupbno = @t_groupbno)
		  	 and (len(@t_groupcno)=0 or d.groupcno = @t_groupcno)
			 and (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea) and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by b.productno,b.product,a.custno,c.nick,c.comp
	
	insert into @tmp 
	select '0',productno,products,cno,custnick,sum(lengthb),sum(lengthc),SUM(mount),SUM(total) from @tmp
	group by productno,products,cno,custnick
	
	delete @tmp where gno='9'

	insert into @tmp(gno,cno,custnick,lengthb,lengthc,mount,total) 
	select '1',cno,custnick,sum(lengthb),sum(lengthc),sum(mount),sum(total) 
	from @tmp where gno='0' group by cno,custnick 
	
select gno,productno,products,cno,custnick
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,dbo.getComma(lengthb,-1) lengthb
,dbo.getComma(lengthc,-1) lengthc
,dbo.getComma(mount,-1) mount
,dbo.getComma(total,-1) total
from @tmp order by cno,custnick,gno,productno;
--**********************************************************************************************
z_vcc17_xy:--z_vcc17_xy
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
SET QUOTED_IDENTIFIER OFF

IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
	drop table #tmp
END

create table #tmp(
	gno nvarchar(10),
	typea nvarchar(10),
	typea2 nvarchar(10),
	vccno nvarchar(50),
	salesno nvarchar(MAX),
	sales nvarchar(MAX),
	custno nvarchar(MAX),
	comp nvarchar(MAX),
	productno nvarchar(MAX),
	products nvarchar(MAX),
	spec nvarchar(MAX),
	unit nvarchar(MAX),
	mount float,
	price float,
	total float,
	stk float,

	ptype nvarchar(10),
	t1 float,
	t2 float,
	t3 float
)

insert #tmp
select '9','1','1',a.noa
,isnull(a.salesno,''),a.sales,a.custno,a.nick,b.productno,b.product,b.spec,b.unit
,case when a.typea='1' then 1 else -1 end*b.mount,b.price
,case when a.typea='1' then 1 else -1 end*b.total
,case when a.typea='1' then 1 else -1 end*case when b.itemno='1' then 1 when b.itemno='2' then -1 else 0 end*b.dime
,'0',0,0,0
from view_vcc a left join view_vccs b on a.noa=b.noa left join cust c on a.custno=c.noa
where a.datea between @t_bdate and @t_edate
and a.custno between @t_bcustno and @t_ecustno
and a.salesno between @t_bsalesno and @t_esalesno 
and b.productno between @t_bproductno and @t_eproductno
and a.custno!='' and b.productno!=''

insert #tmp
select '0',typea,typea2,'',salesno,sales,custno,comp,productno,products,spec,unit 
,SUM(mount),price,SUM(total),SUM(stk),'0',0,0,0
from #tmp
group by typea,typea2,salesno,sales,custno,comp,productno,products,spec,unit,price

update a 
set typea='0'
from #tmp a
where gno='0' and not exists(select noa from view_vccs where custno=a.custno and datea<@t_bdate)

update a 
set typea2='0'
from #tmp a
where gno='0' and not exists(select noa from view_vccs where custno=a.custno and productno=a.productno and datea<@t_bdate)

if((select count(*) from #tmp)>0)
begin
	insert #tmp(gno,typea,typea2,vccno,salesno,sales,custno,comp,productno,products,spec,unit,mount,price,total,stk,ptype)
	select '1','1','1','',salesno,MAX(sales),CHAR(255),CHAR(255),CHAR(255),CHAR(255),CHAR(255),CHAR(255),SUM(mount),null,SUM(total),SUM(stk),'0'
	from #tmp where gno='0'
	group by salesno

	insert #tmp(gno,typea,typea2,vccno,salesno,sales,custno,comp,productno,products,spec,unit,mount,price,total,stk,ptype)
	select '2','1','1','',CHAR(255),CHAR(255),CHAR(255),CHAR(255),CHAR(255),CHAR(255),CHAR(255),CHAR(255),SUM(mount),null,SUM(total),SUM(stk),'0'
	from #tmp where gno='0'
	
	insert #tmp (gno,ptype)
	select '3','1'
	
	insert #tmp (gno,ptype,salesno,sales,t1,t2,t3,total)
	select '4','1',salesno,MAX(sales)
	,isnull((select SUM(total) from #tmp where gno='0' and salesno=a.salesno and typea='0'),0)
	,isnull((select SUM(total) from #tmp where gno='0' and salesno=a.salesno and typea!='0' and typea2='0'),0)
	,isnull((select SUM(total) from #tmp where gno='0' and salesno=a.salesno and typea!='0' and typea2!='0'),0)
	,isnull((select SUM(total) from #tmp where gno='0' and salesno=a.salesno),0)
	from #tmp a where gno='0' 
	group by salesno
	
	insert #tmp(gno,ptype,salesno,t1,t2,t3,total)
	select '5','1',CHAR(255),SUM(t1),SUM(t2),SUM(t3),SUM(total)
	from #tmp where gno='4'
	
end

select 
case when typea='0' then '*'+comp else comp end xcomp
,case when typea2='0' then '*'+productno else productno end xproductno
,dbo.getComma(mount,-1)mount
,dbo.getComma(price,-1)price
,dbo.getComma(total,-1)total
,dbo.getComma(t1,-1)t1
,dbo.getComma(t2,-1)t2
,dbo.getComma(t3,-1)t3
,*
from #tmp where gno!='9' order by ptype,salesno,gno,typea,typea2,productno

IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
 drop table #tmp
END
;
---------------------------------------------------------------------------------------------------------------------------------------
z_vcc20:--z_vcc20
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end

declare @tmp table ( 
gno nvarchar(2), 
rr int,
vccno nvarchar(50),
custno nvarchar(50), 
comp nvarchar(100), 
agentno nvarchar(50), 
agent nvarchar(100), 
invdatea nvarchar(10), 
boarddatea nvarchar(10),
invono nvarchar(50), 
scnoa nvarchar(50), 
lcnoa nvarchar(50), 
froma nvarchar(max), 
toa nvarchar(max), 
ucoin nvarchar(10), 
uprice float, 
ufloata float, 
floata float, 
coin nvarchar(10), 
nprice float, 
item nvarchar(100), 
ouprice float, 
onprice float, 
uiprice float, 
niprice float, 
ncuprice float, 
ncnprice float, 
ecuprice float, 
ecnprice float, 
prouprice float, 
pronprice float, 
[percent] float, 

custnoa nvarchar(100), 
productno nvarchar(50), 
mount float, 
unit nvarchar(10), 
price float, 
cost float, 
expence float, 
itemprice float, 
Profit float, 
tax float 
) 
insert @tmp(gno,vccno,invono,scnoa,custno) 
select '00',a.noa,isnull(b.noa,''),isnull(a.ordeno,''),a.custno 
from  view_vcc a
left join invo b on a.invo=b.noa
where (a.datea between @t_bdate and @t_edate)
and (a.custno between @t_bcustno and @t_ecustno)
and isnull(a.invo,'')!=''

insert @tmp(gno,vccno,custno,comp,agentno,agent,invdatea,boarddatea,invono,scnoa,lcnoa,froma,toa,ucoin,uprice,floata,coin,nprice,ouprice,onprice) 
select '01',a.vccno,b.custno,b.comp,c.agentno,c.agent,b.datea,b.saildate,b.noa,b.ordeno,b.lcno,b.froma,b.toa,'US$',b.amount,ROUND(c.floata*100,0),'NT$',b.amount*ROUND(b.floata*100,0),c.total,c.total*ROUND(c.floata*100,0) 
from @tmp a 
left join invo b on a.invono=b.noa 
left join view_orde c on b.ordeno=c.noa 

--P/O 
insert @tmp(gno,vccno,custno,invono,scnoa,item,ucoin,uiprice,coin,niprice) 
select '02',a.vccno,a.custno,a.invono,a.scnoa,b.chgitem+' '+c.tggno+' '+c.comp,'US$',b.total,'NT$',b.total*a.floata 
from paybs b 
left join @tmp a on b.invono=a.invono 
left join payb c on b.noa=c.noa 
where b.invono!='' 

--Net Cost 
insert @tmp(gno,vccno,custno,invono,scnoa,ucoin,ncuprice,coin,ncnprice) 
select '03',vccno,custno,invono,scnoa,'US$',sum(isnull(ouprice,0))-sum(isnull(uiprice,0)),'NT$',sum(isnull(onprice,0))-sum(isnull(niprice,0)) 
from @tmp 
group by custno,invono,scnoa,vccno

--Extra Cost 
insert @tmp(gno,vccno,custno,invono,scnoa,ucoin,ecuprice,coin,ecnprice) 
select '05',vccno,custno,invono,scnoa,'US$',0,'NT$',0 
from @tmp 
where gno ='01' 

--Estimated Pro 
insert @tmp(gno,vccno,custno,invono,scnoa,ucoin,prouprice,coin,pronprice) 
select '06',vccno,custno,invono,scnoa,'US$',sum(isnull(uprice,0))-sum(isnull(ncuprice,0))-sum(isnull(ecuprice,0)),'NT$',sum(isnull(nprice,0))-sum(isnull(ncnprice,0))-sum(isnull(ecnprice,0)) 
from @tmp 
group by custno,invono,scnoa,vccno

update @tmp 
set floata=b.floata,ufloata=1,[percent]=prouprice/nullif(b.uprice,0)*100 
from @tmp a left join (select custno,floata,uprice from @tmp where gno=1) b on a.custno=b.custno 
where gno='06' 

-- Item No. 
insert @tmp(gno,vccno,rr,custno,invono,scnoa,custnoa,productno,mount,unit,price,cost,expence,itemprice,profit,[percent],coin,ucoin,uprice,floata,nprice) 
select '07',a.vccno,ROW_NUMBER()over(partition by a.invono order by c.product),a.custno,a.invono,scnoa,b.custorde,c.productno,c.mount,c.unit,c.price,c.sprice*a.floata,'','',c.profit*a.floata,c.profit/c.price,'NT$','US$',b.money,a.floata,b.money*a.floata 
from @tmp a 
left join view_orde b on a.scnoa=b.noa 
left join view_ordes c on b.noa=c.noa 
where gno ='01' and c.productno!='' 

update @tmp 
set gno=case when rr=1 then '07' else '08' end 
where gno='07' 

-- A/R Received Detail 
insert @tmp(gno,vccno,custno,invono,scnoa,uprice,floata,nprice,ucoin,coin) 
select '09',vccno,custno,invono,scnoa,uprice,floata,uprice*floata,'US$','NT$' 
from @tmp 
where gno='01' 
group by custno,vccno,invono,scnoa,uprice,floata 

--Material Cost Detail 
insert @tmp(gno,vccno,rr,custno,agentno,agent,invono,scnoa,custnoa,productno,mount,unit,cost,price,coin,ucoin) 
select '10',a.vccno,ROW_NUMBER()over(partition by a.invono order by c.product),a.custno,a.agentno,a.agent,a.invono,scnoa,b.custorde,c.productno,c.mount,c.unit,c.sprice*a.floata,c.mount*c.sprice*a.floata,'NT$',case when b.tax is null then '' else '(未含)' end 
from @tmp a 
left join view_orde b on a.scnoa=b.noa 
left join view_ordes c on b.noa=c.noa 
where gno ='01' and c.productno!='' 

update @tmp 
set gno=case when rr=1 then '10' else '11' end 
where gno='10' 

insert @tmp(gno,vccno,custno,invono,scnoa,custnoa,price,coin,ucoin,tax,cost) 
select '12',a.vccno,a.custno,a.invono,scnoa,b.custorde,sum(c.mount*c.sprice*a.floata),'NT$' 
,case when b.tax is null then '' else '(含稅)' end,b.tax*a.floata*100,sum(c.mount*c.sprice*a.floata)+b.tax*a.floata 
from @tmp a 
left join view_orde b on a.scnoa=b.noa 
left join view_ordes c on b.noa=c.noa 
where gno ='01' and c.productno!='' 
group by a.vccno,a.custno,a.invono,a.invdatea,scnoa,b.custorde,taxtype,b.tax,a.floata 

if((select count(*) from @tmp)<=0)
begin
	insert @tmp(gno) 
	select '13'
end

insert @tmp(gno,vccno,custno,invono) 
select '14',vccno,custno,invono 
from @tmp 
group by invono,custno,vccno 

select 
dbo.getComma(uprice,2)uprice,dbo.getComma(ouprice,2)ouprice,dbo.getComma(uiprice,2)uiprice,dbo.getComma(ncuprice,2)ncuprice,dbo.getComma(ecuprice,2)ecuprice,dbo.getComma(prouprice,2)prouprice 
,dbo.getComma(nprice,0)nprice,dbo.getComma(onprice,0)onprice,dbo.getComma(niprice,0)niprice,dbo.getComma(ncnprice,0)ncnprice,dbo.getComma(ecnprice,0)ecnprice,dbo.getComma(pronprice,0)pronprice 
,dbo.getComma([percent],2)+'%' [percent] 
,case when gno<=09 then dbo.getComma(price,2) else dbo.getComma(price,0) end price 
,case when gno<=11 then dbo.getComma(cost,2) else dbo.getComma(price,0) end cost 
,dbo.getComma(Profit,2)Profit 
,dbo.getComma(tax,0)tax 
,* 
from @tmp 
order by vccno,invono,custno,gno 
;

------------------------------------------------------------------------------------------------------------------------------------------------------------
z_vcc21:--z_vcc21
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bsalesno nvarchar(20)
	declare @t_esalesno nvarchar(20)
	
	set @t_bdate = case when '#non'=[4] then '' else [4] end
	set @t_edate = case when '#non'=[5] then char(255) else [5] end
	set @t_bcustno = case when '#non'=[8] then '' else [8] end
	set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
	set @t_bsalesno = case when '#non'=[10] then '' else [10] end
	set @t_esalesno = case when '#non'=[11] then char(255) else [11] end

declare @tmp table(
	gno nvarchar(1),
	vccno nvarchar(50),
	noa	nvarchar(50),
	datea nvarchar(10),
	custno nvarchar(100),
	sno	nvarchar(50),
	total float,
	cost float,--P/O Cost
	cfee float,--報關費
	trans float,--內陸運費	
	bill float,--提單費
	ptotal float,--Profit Am't.
	bfee float,--銀行手續費
	cdm	float,--港工捐
	vfee float,--簽証費
	ecost float,-- Extra.Cost 	
	per float,
	chgitem nvarchar(100),
	comp nvarchar(200)
)
insert @tmp(gno,vccno,noa,datea,custno,sno,total,ptotal,per) 
select '9',a.noa,b.noa,b.sailing,a.custno,a.salesno,sum(b.amount),sum(c.benifit),round((sum(c.benifit)/sum(c.amount))*100,2)
from view_vcc a left join invo b on a.invo=b.noa
left join invos c on b.noa=c.noa
where (a.datea between @t_bdate and @t_edate) 
and(a.custno between @t_bcustno and @t_ecustno) 
and(isnull(a.salesno,'') between @t_bsalesno and @t_esalesno)
and ISNULL(a.invo,'')!='' 
group by a.noa,b.noa,b.sailing,a.custno,a.salesno

insert @tmp(gno,noa,datea,custno,sno,cfee,trans,bill,bfee,cdm,vfee,ecost)
select '8',a.noa,a.datea,a.custno,a.sno,SUM(ISNULL(b.cfee,0)),SUM(ISNULL(b.trans,0)),SUM(ISNULL(b.bill,0)),SUM(ISNULL(b.bfee,0))
,SUM(ISNULL(b.cdm,0)),SUM(ISNULL(b.vfee,0)),SUM(ISNULL(b.ecost,0))
from @tmp a 
outer apply (select invono
,case when chgitem like '%報關費%' then SUM(total)end cfee
,case when chgitem like '%運費%' then SUM(total)end trans
,case when chgitem like '%提單費%'then SUM(total)end bill
,case when chgitem like '%銀行手續費%' then SUM(total)end bfee
,case when chgitem like '%港工捐%' then SUM(total)end cdm
,case when chgitem like '%簽証費%'then SUM(total)end vfee
,case when chgitem like '%其他費用%' then SUM(total)end ecost from paybs where a.noa=invono group by invono,chgitem)b
group by a.noa,a.datea,a.custno,a.sno

insert @tmp(gno,noa,datea,custno,sno,total,cfee,trans,bill,ptotal,bfee,cdm,vfee,ecost,per)
select '0',noa,datea,custno,sno,SUM(ISNULL(total,0)),SUM(ISNULL(cfee,0))
,SUM(ISNULL(trans,0)),SUM(ISNULL(bill,0)),SUM(ISNULL(ptotal,0)),SUM(ISNULL(bfee,0)),SUM(ISNULL(cdm,0))
,SUM(ISNULL(vfee,0)),SUM(ISNULL(ecost,0)),MAX(per)
from @tmp
group by noa,datea,custno,sno

delete @tmp where gno='9' or gno='8'

update @tmp
set cost=total-cfee-trans-bill-ptotal-bfee-cdm-vfee-ecost

insert @tmp(gno,total,cost,cfee,trans,bill,ptotal,bfee,cdm,vfee,ecost,per) 
select '1',SUM(total),SUM(cost),SUM(cfee),SUM(trans),SUM(bill),SUM(ptotal),SUM(bfee) 
,SUM(cdm),SUM(vfee),SUM(ecost),round((SUM(ptotal)/nullif(SUM(total)*100,0)),2) 
from @tmp 

insert @tmp(gno,chgitem,custno,comp,total)
select '2',b.chgitem,c.tggno,c.comp,SUM(b.total)
from @tmp a left join paybs b on a.noa=b.invono
left join payb c on b.noa=c.noa
where
b.chgitem like '%報關費%' or b.chgitem like '%運費%' or b.chgitem like '%提單費%' 
or b.chgitem like '%銀行手續費%' or b.chgitem like '%港工捐%' or b.chgitem like '%簽証費%' 
or b.chgitem like '%其他費用%'
group by b.chgitem,c.tggno,c.comp

select
dbo.getComma(total,0)total
,dbo.getComma(cost,0)cost
,dbo.getComma(cfee,0)cfee 
,dbo.getComma(trans,0)trans 
,dbo.getComma(bill,0)bill 
,dbo.getComma(ptotal,0)ptotal
,dbo.getComma(bfee,0)bfee
,dbo.getComma(cdm,0)cdm 
,dbo.getComma(vfee,0)vfee 
,dbo.getComma(ecost,0)ecost
,cast(per as nvarchar)+'%' per 
,* from @tmp
order by gno,noa
;
------------------------------------------------------------------------------------------------------------------------------------------------------------
z_vcc22:--z_vcc22
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bproductno nvarchar(30)
	declare @t_eproductno nvarchar(30)
	
	set @t_bdate = case when '#non'=[4] then '' else [4] end
	set @t_edate = case when '#non'=[5] then char(255) else [5] end
	set @t_bcustno = case when '#non'=[8] then '' else [8] end
	set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
	set @t_bproductno = case when '#non'=[12] then '' else [12] end
	set @t_eproductno = case when '#non'=[13] then char(255) else [13] end

declare @tmp table(
	gno nvarchar(1),
	rr int,
	datea nvarchar(10),
	noa nvarchar(50),	
	custno nvarchar(100),
	nick nvarchar(100),	
	port nvarchar(100),								
	productno nvarchar(100),
	product nvarchar(max),
	mount float,
	unit nvarchar(10),	
	notv float,	
	total float,
	ordcnoa nvarchar(50),	
	tgg	nvarchar(100),
	cost float,
	packwayno nvarchar(50),	
	cuft float,	
	weight float,	
	ctn  float
)
insert @tmp
select '0','',a.date1,a.noa,a.custno,a.nick,c.edock,b.productno,b.product,b.mount,b.unit,b.notv,b.notv*b.price
,d.noa,d.nick,e.total,b.packwayno,f.cuft*case when isnull(f.inmount,0)*isnull(f.outmount,0)=0 then 1 else ceiling(b.mount/nullif((f.inmount*f.outmount),0)) end
,b.mount*f.uweight
,case when isnull(f.inmount,0)*isnull(f.outmount,0)=0 then 0 else ceiling(b.mount/nullif((f.inmount*f.outmount),0)) end
from view_orde a left join view_ordes b on a.noa=b.noa
left join view_ordei c on a.noa=c.noa
left join view_ordc d on a.ordcno=d.noa
left join view_ordcs e on d.noa=e.noa and b.productno=e.productno and b.no2=e.no2
left join pack2s f on f.noa=isnull(b.productno,'') and b.packwayno=f.packway and b.packway=f.pack
where (b.datea between @t_bdate and @t_edate) 
and (a.custno between @t_bcustno and @t_ecustno) 
and (b.productno between @t_bproductno and @t_eproductno) 

update a
set rr=rx,gno=case when rx!=1 then 1 else 0 end
from (select ROW_NUMBER()over(partition by noa order by noa)rx,rr,gno from @tmp)a

--單位小計
insert @tmp(gno,noa,mount,unit,notv)
select '2',noa,SUM(mount),unit,SUM(notv)
from @tmp
group by noa,unit

update a
set rr=rx,gno=case when rx!=1 then 3 else 2 end
from (select ROW_NUMBER()over(partition by noa order by unit)rx,rr,gno from @tmp where gno=2)a
where gno=2

--單位總計
insert @tmp (gno,noa,mount,unit,notv)
select '4',CHAR(255),SUM(mount),isnull(unit,''),SUM(notv)
from @tmp
group by isnull(unit,'')

update a
set rr=rx,gno=case when rx!=1 then 5 else 4 end
from (select ROW_NUMBER()over(partition by gno order by unit)rx,rr,gno from @tmp where gno=4)a
where gno=4

select 
@t_bdate bdate,@t_edate edate
,dbo.getComma(mount,0)mount 
,dbo.getComma(notv,0)notv 
,dbo.getComma(total,0)total 
,dbo.getComma(cuft,3)cuft 
,dbo.getComma(weight,2)weight 
,dbo.getComma(ctn,0)ctn
,dbo.getComma(cost,0)cost
,* from @tmp
order by noa,gno
;
------------------------------------------------------------------------------------------------------------------------------------------------------------
z_vcc23:--z_vcc23
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bsalesno nvarchar(20)
	declare @t_esalesno nvarchar(20)
	declare @t_bproductno nvarchar(30)
	declare @t_eproductno nvarchar(30)
	declare @t_typea nvarchar(30)
	declare @t_groupano nvarchar(30)
	declare @t_groupbno nvarchar(30)
	declare @t_groupcno nvarchar(30)
	declare @t_salesgroup nvarchar(100)
	declare @t_multcust nvarchar(max)
	declare @t_multucc nvarchar(max)
	
	set @t_bdate = case when '#non'=[4] then '' else [4] end
	set @t_edate = case when '#non'=[5] then char(255) else [5] end
	set @t_bcustno = case when '#non'=[8] then '' else [8] end
	set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
	set @t_bsalesno = case when '#non'=[10] then '' else [10] end
	set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
	set @t_bproductno = case when '#non'=[12] then '' else [12] end
	set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
	set @t_typea = case when '#non'=[16] then '' else [16] end
	set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
	set @t_salesgroup = case when '#non' = [21] then '' else [21] end
	set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
	set @t_multucc = case when '#non' = [27] then '' else [27]+',' end

declare @tmp table(
	gno nvarchar(1),
	custno nvarchar(50),
	comp nvarchar(250),
	rr int,
	productno nvarchar(100),
	product nvarchar(max),
	price float,
	mount float,
	makeup float,
	aprice float,
	amount float,
	amakeup float
)
 insert @tmp
 select '0',a.custno,c.comp,ROW_NUMBER()over(partition by a.custno order by b.productno),b.productno,b.product,SUM(b.total),SUM(b.mount),'','','',''
 from  view_vccs b
	left join view_vcc a on a.noa = b.noa
	left join cust c on  a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
 where (a.datea between @t_bdate and @t_edate) and
		  (a.custno between @t_bcustno and @t_ecustno) and
		  (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and
		  (b.productno between @t_bproductno and @t_eproductno) and
		  (len(@t_groupano)=0 or d.groupano = @t_groupano) and 
		  (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
		  and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
		  and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
 group by a.custno,c.comp,b.productno,b.product
  
 insert @tmp(gno,custno,price,mount,aprice,amount)
 select '1',custno,SUM(price),sum(mount),SUM(price),sum(mount)
 from @tmp
 group by custno
 
 update @tmp
 set makeup=a.price/nullif(b.price,0)*100,amakeup=a.price/nullif(b.price,0)*100
 from @tmp a left join  (select custno,price from @tmp where gno='1')b on a.custno=b.custno

insert @tmp(gno,custno)
 select '2',custno
 from @tmp
 group by custno
 
 select 
 dbo.getComma(price,2) price,
 dbo.getComma(makeup,2)+'%' makeup,
 dbo.getComma(amakeup,2)+'%' amakeup,
 'US$' coin,
 @t_bdate bdate,
 @t_edate edate,
 * from @tmp
 order by custno,gno,rr
 ;
 
----------------------------------------------------------------------------------------------------------
z_vcc24:--z_vcc24
declare @t_bdate nvarchar(20) = case when '#non'=[4] then '' else [4] end
declare @t_edate nvarchar(20) = case when '#non'=[5] then char(255) else [5] end
declare @t_bcustno nvarchar(50) = case when '#non'=[8] then '' else [8] end
declare @t_ecustno nvarchar(50) = case when '#non'=[9] then char(255) else [9] end

declare @tmp table(
	gno nvarchar(2),
	idno int identity(0,1),
	rr int,
	page int,
	pageno int,
	pagecounta int,
	custno nvarchar(100),
	comp nvarchar(200),
	addr nvarchar(max),
	tel nvarchar(50),
	fax nvarchar(50),
	boss nvarchar(50),
	sales nvarchar(50),
	serial nvarchar(50),
	
	datea nvarchar(10),
	typea nvarchar(10),
	ummno nvarchar(50),
	invo nvarchar(50),
	coin nvarchar(10),
	vccno nvarchar(50),
	noa nvarchar(50),
	mount float,
	unit nvarchar(10),
	price float,
	total float,
	atotal float,
	ntotal float,
	paytype nvarchar(10),
	
	moneya float,
	tax float,
	paysale float,
	itotal float,
	opay float,
	tprice float,
	mprice float,--加扣款
	mon nvarchar(10)
)

insert @tmp(gno,rr,custno,datea,invo,coin,vccno,noa,mount,unit,price,total)
select '3',ROW_NUMBER()over(partition by a.noa order by b.ordeno,b.no2),a.custno,a.datea,invono,coin,a.noa,b.ordeno,b.mount,b.unit,b.price,b.total
from view_vcc a left join view_vccs b on a.noa=b.noa
where isnull(b.ordeno,'')!=''
and (a.datea between @t_bdate and @t_edate)
and (a.custno between @t_bcustno and @t_ecustno)

update @tmp set gno=case when rr=1 then '3' else '4' end

insert @tmp(gno,rr,custno,vccno,tprice,mprice,tax,total,atotal,ntotal)
select '5',MAX(rr)+1,a.custno,a.vccno,b.money,0,isnull(b.tax,0),isnull(b.total,0),isnull(c.paysale,0),isnull(b.total,0)-isnull(c.paysale,0)
from @tmp a left join view_vcc b on a.vccno=b.noa
outer apply(select * from umms where vccno=a.vccno)c
where (b.datea between @t_bdate and @t_edate)
and (a.custno between @t_bcustno and @t_ecustno)
group by a.custno,a.vccno,b.money,b.tax,b.total,c.paysale

--溢收款
insert @tmp(gno,custno,datea,ummno,vccno,noa,total,atotal,ntotal)
select '6',a.custno,a.datea,a.noa,CHAR(255),'',(-1*isnull(a.opay,0))-(-1*isnull(a.unopay,0)),-1*isnull(a.unopay,0),-1*isnull(a.opay,0)
from umm a
where (a.datea between @t_bdate and @t_edate)
and (a.custno between @t_bcustno and @t_ecustno)
and (isnull(a.opay,0)!=0 or isnull(a.unopay,0)!=0)

insert @tmp(gno,rr,custno,vccno,moneya,tax,total,paysale,itotal,atotal,ntotal,coin)
select '7',MAX(rr)+1,a.custno,CHAR(255),SUM(isnull(a.total,0)),SUM(ISNULL(b.tax,0)),SUM(isnull(a.total,0))+SUM(ISNULL(b.tax,0)),SUM(ISNULL(atotal,0)),'',isnull(c.unpay,0),isnull(c.unpay,0)+SUM(ISNULL(ntotal,0)),'US$'
from @tmp a
left join invo b on a.invo=b.noa
outer apply (select noa,SUM(unpay)-sum(pay)unpay from cust_2s where a.custno=noa and mon<left(@t_bdate,7) group by noa)c
where gno=5 or gno=6
group by a.custno,c.unpay

--累計預收金額
update @tmp
set opay=b.opay
from @tmp a
left join (select custno,opay,MAX(mon)mon from umm where mon<=left(@t_edate,7) group by custno,opay)b on a.custno=b.custno
where gno=7

update @tmp 
set pagecounta=b.page
from @tmp a left join (select custno,idno,ROW_NUMBER()over(partition by custno order by custno,vccno,idno )page from @tmp)b 
on a.custno=b.custno and a.idno=b.idno

update @tmp
set pageno=case when gno='6' or gno='7' then 3 else (case when gno='5' then 4 else 1 end) end
from @tmp a

----更新頁數-------
declare @pageline int =30
declare @pageno int =1
declare @custno nvarchar(50) 
declare @page int
declare @pagecounta int

update @tmp
set pageno=(select SUM(pageno) from @tmp where custno=a.custno and pagecounta<=a.pagecounta)
from @tmp a

update a
set page=ceiling(cast(a.pageno as float)/@pageline)
from (select idno,page,pageno from @tmp)a
--------------------

insert @tmp(gno,rr,page,pageno,pagecounta,custno,comp,addr,tel,fax,boss,sales,serial)
select case when page=1 then 1 else 2 end,'0',page,case when page=1 then 14 else  9  end,0,a.custno,b.comp,b.addr_comp,b.tel,b.fax,b.boss,b.sales,b.serial
from @tmp a left join cust b on a.custno= b.noa
group by page,a.custno,b.comp,b.addr_comp,b.tel,b.fax,b.boss,b.sales,b.serial

declare @tpageline int =45

--補空白行
declare cursor_table cursor for 
select custno,MAX(page) page,SUM(case when gno=1 or gno=2 or gno=7 then pageno else 0 end) pageno,MAX(pagecounta) pagecounta from @tmp group by custno
open cursor_table 
fetch next from cursor_table 
into @custno,@page,@pageno,@pagecounta
while(@@FETCH_STATUS <> -1) 
begin
	while ((@pageno)%@tpageline>0)
	begin
		set @pageno=@pageno+1
		insert @tmp(gno,custno,page,pagecounta,vccno)
		select '8',@custno,@page,@pagecounta+1,CHAR(255)
	end

	fetch next from cursor_table 
	into @custno,@page,@pageno,@pagecounta
end 
close cursor_table 
deallocate cursor_table 

insert @tmp(gno,custno,vccno,page)
select '9',custno,CHAR(255),MAX(page)
from @tmp
group by custno

insert @tmp(gno,custno,vccno)
select '10',custno,CHAR(255)
from @tmp
group by custno

select @t_bdate bdatea,@t_edate edatea
,dbo.getComma(price,2)price
,case when total<0 then '('+dbo.getComma(total*-1,2)+')' else  dbo.getComma(total,2) end ttotal
,case when atotal<0 then '('+dbo.getComma(atotal*-1,2)+')' else  dbo.getComma(atotal,2) end  aatotal
,case when ntotal<0 then '('+dbo.getComma(ntotal*-1,2)+')' else  dbo.getComma(ntotal,2) end nntotal
,dbo.getComma(tprice,2)tprice 
,case when moneya<0 then '('+dbo.getComma(moneya*-1,2)+')' else  dbo.getComma(moneya,2) end  moneya
,case when paysale<0 then '('+dbo.getComma(paysale*-1,2)+')' else  dbo.getComma(paysale,2) end paysale
,dbo.getComma(opay,2)opay
,* from @tmp
order by custno,vccno,idno
;
-----------------------------------------------------------------------------------------------------------
z_vcc5_kdc:--z_vcc5_kdc
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end

declare @tmp table(
	gno nvarchar(1),
	noa nvarchar(20),
	custno nvarchar(10),
	cust nvarchar(50),
	datea nvarchar(10),
	product nvarchar(100),
	volume float,
	mount float,
	unit nvarchar(10),
	price float,
	total float,
	ordeno nvarchar(20),
	memo nvarchar(max),
	invono nvarchar(20),
	tax float
)
insert into @tmp(gno,noa,custno,cust,datea,product,volume,mount,unit,price,total,ordeno,memo,invono)
select '0',a.noa,a.custno,a.comp,a.datea,b.product,a.benifit,b.mount,b.unit,b.price,b.total,a.ordeno,b.memo,a.invono
from view_vcc a
left join view_vccs b on a.noa=b.noa
where a.datea between @t_bdate and @t_edate and a.custno between @t_bcustno and @t_ecustno

insert into @tmp (gno,cust,total)
select '1',cust,sum(total)
from @tmp group by cust

insert into @tmp(gno,datea,cust,invono)
select '2',datea,cust,invono
from @tmp where datea is not null group by datea,cust,invono

--抓發票資料
update a set a.datea=b.datea, a.total=b.money,tax=b.tax
from @tmp a outer apply(select * from vcca where a.invono=noa)b
where gno='2'
--在抓一次合計
insert into @tmp (gno,cust,total)
select '3',cust,total
from @tmp where gno='1'
--最後的合計,totla+tax
update a set a.total = a.total + isnull(b.tax,0)
from @tmp a outer apply(select SUM(tax) tax,cust from @tmp where gno='2' group by cust)b
where a.gno='3' and a.cust=b.cust

delete from @tmp where (len(invono)=0 and gno='2') or (invono is null and gno='2')

update @tmp set datea = right(datea,5) where gno='2'

select a.*,substring(datea,1,3) as yy,substring(datea,5,2) as mm
from @tmp a order by cust,gno;