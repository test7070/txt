z_tran17c:--z_tran17c
	declare @t_bmon nvarchar(10) = case when '#non'=[44] then '' else [44] end
	declare @t_emon nvarchar(10) = case when '#non'=[45] then char(255) else [45] end
	declare @t_bdriverno nvarchar(20) = case when '#non'=[46] then '' else [46] end
	declare @t_edriverno nvarchar(20) = case when '#non'=[47] then char(255) else [47] end
	declare @t_carno nvarchar(max) = case when '#non'=[48] then '' else [48] end
	declare @t_carkind nvarchar(max) = case when '#non'=[49] then '' else [49] end	
	declare @t_detail nvarchar(max) = case when '#non'=[50] then '' else [50] end	
	--------------------------------------------------------------------------------
	declare @t_pageline int = 30  --一頁的行數
	declare @tmp table(
		gno nvarchar(10),
		pno nvarchar(10),
		rno nvarchar(max),
		caryear nvarchar(20),
		carkindno nvarchar(20),
		carkind nvarchar(20),
		oilmount float,
		miles float,
		oilrate float,
		kl float,
		carday float,
		trandate nvarchar(10),
		custno nvarchar(20),
		cust nvarchar(50),
		carno nvarchar(20),
		driverno nvarchar(20),
		driver nvarchar(20),
		insures float,
		money1 float,
		money2 float,
		custplus float,
		custminus float,
		driverplus float,
		driverminus float,
		reserve float,
		tolls float,
		etc float,
		oil float,
		wmoney float,
		wmoneycar float,
		wmoneyplate float,
		cmoney float,
		dmoney float,
		emoney float,
		ticket float,
		bonus float,
		tax float,
		depreciation float,
		tax2 float,--稅捐  money1 * 3%
		driverpay float,
		profit float
	)
	insert into @tmp(gno,pno,carkindno,carkind,carno,insures,money1,money2
		,custplus,custminus,driverplus,driverminus,reserve,tolls,etc,oil
		,wmoney,wmoneycar,wmoneyplate,cmoney,dmoney,emoney,ticket,bonus,tax,depreciation,driverpay)
	select '1','1',isnull(b.carkindno,''),ISNULL(c.kind,''),ISNULL(a.carno,'')
		,sum(ISNULL(a.insures,0)),sum(ISNULL(a.money1,0)),sum(ISNULL(a.money2,0))
		,sum(ISNULL(a.custplus,0)),sum(ISNULL(a.custminus,0)),sum(ISNULL(a.driverplus,0)),sum(ISNULL(a.driverminus,0))
		,sum(ISNULL(a.reserve,0)),sum(ISNULL(a.tolls,0)),sum(ISNULL(a.etc,0)),sum(ISNULL(a.oil,0))
		,sum(ISNULL(a.wmoney,0)),sum(ISNULL(a.wmoneycar,0)),sum(ISNULL(a.wmoneyplate,0)),sum(ISNULL(a.cmoney,0)),sum(ISNULL(a.dmoney,0)),sum(ISNULL(a.emoney,0))
		,sum(ISNULL(a.ticket,0)),sum(ISNULL(a.bonus,0)),sum(ISNULL(a.tax,0)),sum(ISNULL(a.depreciation,0)) 
		,sum(isnull(a.driverpay,0))
	from trans_sum a
	left join car2 b on a.carno=b.carno
	left join carkind c on b.carkindno=c.noa
	where a.mon between @t_bmon and @t_emon
	and b.cartype = '2' --公司車
	and isnull(a.driverno,'') between @t_bdriverno and @t_edriverno
	and (len(@t_carno)=0 or (len(ISNULL(b.carno,''))>0 and CHARINDEX(','+b.carno+',',','+@t_carno+',')>0))
	and (len(@t_carkind)=0 or (len(ISNULL(b.carkindno,''))>0 and CHARINDEX(','+b.carkindno+',',','+@t_carkind+',')>0))
	group by isnull(b.carkindno,''),ISNULL(c.kind,''),ISNULL(a.carno,'')
	
	update @tmp set caryear=b.caryear,oilmount=c.mount,oilrate=case when money1!=0 then oil/money1*100 else 0 end
		,miles=c.miles
		,kl=case when c.mount!=0 then c.miles/c.mount else 0 end
		,carday=d.mount
	from @tmp a
	left join car2 b on a.carno=b.carno
	left join (select carno,SUM(isnull(mount,0)) mount,SUM(ISNULL(miles,0)) miles 
		from oil where LEFT(datea,6) between @t_bmon and @t_emon group by carno) c on a.carno=c.carno
	left join (select carno,count(1) mount 
		from (SELECT DISTINCT isnull(carno,'') carno,trandate from trans_sum where mon between @t_bmon and @t_emon) a 
		group by carno) d on a.carno=d.carno 
	
	insert into @tmp(gno,pno,carkindno,carkind,miles,oilmount,insures,money1,money2
		,custplus,custminus,driverplus,driverminus,reserve,tolls,etc,oil
		,wmoney,wmoneycar,wmoneyplate,cmoney,dmoney,emoney,ticket,bonus,tax,depreciation,driverpay)
	select '2','2',carkindno,carkind,SUM(ISNULL(miles,0)),SUM(isnull(oilmount,0)),sum(insures),SUM(money1),SUM(money2)
		,SUM(custplus),SUM(custminus),SUM(driverplus),SUM(driverminus),SUM(reserve),SUM(tolls),SUM(etc),SUM(oil)
		,SUM(wmoney),SUM(wmoneycar),SUM(wmoneyplate),SUM(cmoney),SUM(dmoney),SUM(emoney),SUM(ticket),SUM(bonus),SUM(tax),SUM(depreciation)
		,sum(driverpay)
	from @tmp where pno='1' group by carkindno,carkind

	update @tmp set oilrate=case when money1!=0 then oil/money1*100 else 0 end
		,kl = case when oilmount!=0 then miles/oilmount else 0 end
	where pno='2'
	
	update @tmp set tax2 = round(money1*0.03,0),profit=money1-money2-insures+custplus-custminus-driverplus+driverminus-reserve-tolls
		-etc-oil-wmoney-cmoney-dmoney-emoney-ticket-bonus-tax-depreciation-round(money1*0.03,0)+driverpay
	update @tmp set gno = '4' where profit<0 and pno='1'
	----------------------------------------------------------------------------------------------------
	if len(@t_detail)>0
	begin
		update @tmp set gno='5',rno=case when len(isnull(caryear,''))>0 then '1' else '2' end+isnull(caryear,'')+carno+CHAR(255) where gno='1'
		update @tmp set gno='6',rno=case when len(isnull(caryear,''))>0 then '1' else '2' end+isnull(caryear,'')+carno where gno='4'
		
		insert into @tmp(gno,pno,rno,carkindno,carkind,trandate
			--,custno,cust
			,carno
			--,driverno,driver
			,insures,money1,money2
			,custplus,custminus,driverplus,driverminus,reserve,tolls,etc,oil
			,wmoney,wmoneycar,wmoneyplate,cmoney,dmoney,emoney,ticket,bonus,tax,depreciation,driverpay)
		select '7','1'
			,case when len(isnull(b.caryear,''))>0 then '1' else '2' end+isnull(b.caryear,'')+a.carno
			,isnull(b.carkindno,''),ISNULL(c.kind,''),ISNULL(a.mon,'')
			--,ISNULL(a.custno,''),ISNULL(e.nick,'')
			,ISNULL(a.carno,'')
			--,ISNULL(a.driverno,''),ISNULL(d.namea,'')
			,SUM(ISNULL(a.insures,0)),SUM(ISNULL(a.money1,0)),SUM(ISNULL(a.money2,0))
			,SUM(ISNULL(a.custplus,0)),SUM(ISNULL(a.custminus,0)),SUM(ISNULL(a.driverplus,0))
			,SUM(ISNULL(a.driverminus,0))
			,SUM(ISNULL(a.reserve,0)),SUM(ISNULL(a.tolls,0)),SUM(ISNULL(a.etc,0)),SUM(ISNULL(a.oil,0))
			,SUM(ISNULL(a.wmoney,0)),SUM(ISNULL(a.wmoneycar,0)),SUM(ISNULL(a.wmoneyplate,0))
			,SUM(ISNULL(a.cmoney,0)),SUM(ISNULL(a.dmoney,0)),SUM(ISNULL(a.emoney,0))
			,SUM(ISNULL(a.ticket,0)),SUM(ISNULL(a.bonus,0)),SUM(ISNULL(a.tax,0)),SUM(ISNULL(a.depreciation,0)) 
			,SUM(isnull(a.driverpay,0))
		from trans_sum a
		left join car2 b on a.carno=b.carno
		left join carkind c on b.carkindno=c.noa
		left join driver d on a.driverno=d.noa
		left join cust e on a.custno=e.noa
		where a.mon between @t_bmon and @t_emon
		and b.cartype = '2' --公司車
		and isnull(a.driverno,'') between @t_bdriverno and @t_edriverno
		and (len(@t_carno)=0 or (len(ISNULL(b.carno,''))>0 and CHARINDEX(','+b.carno+',',','+@t_carno+',')>0))
		and (len(@t_carkind)=0 or (len(ISNULL(b.carkindno,''))>0 and CHARINDEX(','+b.carkindno+',',','+@t_carkind+',')>0))
		group by case when len(isnull(b.caryear,''))>0 then '1' else '2' end+isnull(b.caryear,'')+a.carno
			,isnull(b.carkindno,''),ISNULL(c.kind,''),ISNULL(a.mon,'')
			--,ISNULL(a.custno,''),ISNULL(e.nick,'')
			,ISNULL(a.carno,'')
			--,ISNULL(a.driverno,''),ISNULL(d.namea,'')
	end
	----------------------------------------------------------------------------------------------------
	declare @n int
	declare @carkindno nvarchar(20)
	declare @carkind nvarchar(20)
	
	declare cursor_table cursor for
	select carkindno,carkind,count(1) from @tmp group by carkindno,carkind
	open cursor_table
	fetch next from cursor_table
	into @carkindno,@carkind,@n
	while(@@FETCH_STATUS <> -1)
	begin		
		while @n%@t_pageline !=0
		begin
			insert into @tmp(gno,pno,rno,carkindno,carkind)
			values('3','3',CHAR(255),@carkindno,@carkind)
			set @n=@n+1
		end
		
		fetch next from cursor_table
		into @carkindno,@carkind,@n
	end
	close cursor_table
	deallocate cursor_table
	
	select *
	,caryear m01
	,cast(round(oilrate,0) as nvarchar)+'%' m02
	,cast(kl as decimal(10,2)) m03
	,carday m04
	,carno m05
	,driver m06
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money1),1)),4,12))  m07
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,custplus),1)),4,12))  m08
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,custminus),1)),4,12))  m09
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money2),1)),4,12))  m10
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,driverplus),1)),4,12))  m11
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,driverminus),1)),4,12))  m12
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,reserve),1)),4,12))  m13
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)+ISNULL(etc,0)),1)),4,12))  m14
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,oil),1)),4,12))  m15
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ISNULL(wmoney,0)+ISNULL(dmoney,0)+ISNULL(emoney,0)),1)),4,12))  m16
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,wmoneycar),1)),4,12))  ma16
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,wmoneyplate),1)),4,12))  mb16
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ISNULL(cmoney,0)),1)),4,12))  m17
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ticket),1)),4,12))  m18
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bonus),1)),4,12)) m19
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax),1)),4,12))  m20
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,depreciation),1)),4,12))  m21
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,insures),1)),4,12))  m22
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax2),1)),4,12))  m23
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,profit),1)),4,12))  m24
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,driverpay),1)),4,12))  m25
	from @tmp 
	order by case when len(carkindno)=0 then CHAR(255) else carkindno end
		,pno
		,rno
		,caryear
		,case when len(carno)=0 then CHAR(255) else carno end
		;

z_tran17b:--z_tran17b
	declare @t_bmon nvarchar(10) = case when '#non'=[44] then '' else [44] end
	declare @t_emon nvarchar(10) = case when '#non'=[45] then char(255) else [45] end
	declare @t_bdriverno nvarchar(20) = case when '#non'=[46] then '' else [46] end
	declare @t_edriverno nvarchar(20) = case when '#non'=[47] then char(255) else [47] end
	declare @t_carno nvarchar(max) = case when '#non'=[48] then '' else [48] end
	declare @t_carkind nvarchar(max) = case when '#non'=[49] then '' else [49] end	
	declare @t_pageline int = 30  --一頁的行數
	declare @t_detail nvarchar(max) = case when '#non'=[50] then '' else [50] end
	-----------------------------------------------------------------
	declare @tmp table(
		gno nvarchar(10),
		pno nvarchar(10),
		rno nvarchar(max),
		mon nvarchar(10),
		carkindno nvarchar(20),
		carkind nvarchar(20),
		oilmount float,
		miles float,
		oilrate float,
		kl float,
		driverno nvarchar(20),
		driver nvarchar(20),
		insures float,
		money1 float,
		money2 float,
		custplus float,
		custminus float,
		driverplus float,
		driverminus float,
		reserve float,
		tolls float,
		etc float,
		oil float,
		wmoney float,
		wmoneycar float,
		wmoneyplate float,
		cmoney float,
		dmoney float,
		emoney float,
		ticket float,
		bonus float,
		tax float,
		depreciation float,
		driverpay float,
		tax2 float,--稅捐  money1 * 3%
		profit float
	)
	insert into @tmp(gno,pno,carkindno,carkind,driverno,driver,insures,money1,money2
		,custplus,custminus,driverplus,driverminus,reserve,tolls,etc,oil
		,wmoney,wmoneycar,wmoneyplate,cmoney,dmoney,emoney,ticket,bonus,tax,depreciation
		,miles,oilmount,driverpay)
	select '1','1',isnull(b.carkindno,''),ISNULL(c.kind,''),ISNULL(a.driverno,''),ISNULL(f.namea,'')
		,sum(ISNULL(a.insures,0)),sum(ISNULL(a.money1,0)),sum(ISNULL(a.money2,0))
		,sum(ISNULL(a.custplus,0)),sum(ISNULL(a.custminus,0)),sum(ISNULL(a.driverplus,0)),sum(ISNULL(a.driverminus,0))
		,sum(ISNULL(a.reserve,0)),sum(ISNULL(a.tolls,0)),sum(ISNULL(a.etc,0)),sum(ISNULL(a.oil,0))
		,sum(ISNULL(a.wmoney,0)),sum(ISNULL(a.wmoneycar,0)),sum(ISNULL(a.wmoneyplate,0)),sum(ISNULL(a.cmoney,0)),sum(ISNULL(a.dmoney,0)),sum(ISNULL(a.emoney,0))
		,sum(ISNULL(a.ticket,0)),sum(ISNULL(a.bonus,0)),sum(ISNULL(a.tax,0)),sum(ISNULL(a.depreciation,0))
		,sum(ISNULL(d.miles,0))
		,sum(ISNULL(d.mount,0))
		,sum(ISNULL(a.driverpay,0))
	from trans_sum a
	left join car2 b on a.carno=b.carno
	left join carkind c on b.carkindno=c.noa
	left join (select carno,SUM(isnull(mount,0)) mount,SUM(ISNULL(miles,0)) miles 
		from oil where LEFT(datea,6) between @t_bmon and @t_emon group by carno) d on a.carno=d.carno
	left join (select carno,driverno,count(1) mount 
		from (SELECT DISTINCT isnull(carno,'') carno,isnull(driverno,'') driverno,trandate from trans_sum where mon between @t_bmon and @t_emon) a 
		group by carno,driverno) e on a.carno=e.carno and a.driverno=e.driverno
	left join driver f on a.driverno=f.noa
	where a.mon between @t_bmon and @t_emon
	and b.cartype = '2' --公司車
	and isnull(a.driverno,'') between @t_bdriverno and @t_edriverno
	and (len(@t_carno)=0 or (len(ISNULL(b.carno,''))>0 and CHARINDEX(','+b.carno+',',','+@t_carno+',')>0))
	and (len(@t_carkind)=0 or (len(ISNULL(b.carkindno,''))>0 and CHARINDEX(','+b.carkindno+',',','+@t_carkind+',')>0))
	group by isnull(b.carkindno,''),ISNULL(c.kind,''),ISNULL(a.driverno,''),ISNULL(f.namea,'')
	
	update @tmp set oilrate=case when money1!=0 then oil/money1*100 else 0 end
	,kl=case when oilmount!=0 then miles/oilmount else 0 end
	
	insert into @tmp(gno,pno,carkindno,carkind,miles,oilmount,insures,money1,money2
		,custplus,custminus,driverplus,driverminus,reserve,tolls,etc,oil
		,wmoney,wmoneycar,wmoneyplate,cmoney,dmoney,emoney,ticket,bonus,tax,depreciation,driverpay)
	select '2','2',carkindno,carkind,SUM(ISNULL(miles,0)),SUM(isnull(oilmount,0)),sum(insures),SUM(money1),SUM(money2)
		,SUM(custplus),SUM(custminus),SUM(driverplus),SUM(driverminus),SUM(reserve),SUM(tolls),SUM(etc),SUM(oil)
		,SUM(wmoney),SUM(wmoneycar),SUM(wmoneyplate),SUM(cmoney),SUM(dmoney),SUM(emoney),SUM(ticket),SUM(bonus),SUM(tax),SUM(depreciation)
		,SUM(driverpay)
	from @tmp where pno='1' group by carkindno,carkind

	update @tmp set oilrate=case when money1!=0 then oil/money1*100 else 0 end
		,kl = case when oilmount!=0 then miles/oilmount else 0 end
	where pno='2'
	
	update @tmp set tax2 = round(money1*0.03,0)
		,profit=money1-money2-insures+custplus-custminus-driverplus+driverminus-reserve-tolls
		-etc-oil-wmoney-cmoney-dmoney-emoney-ticket-bonus-tax-depreciation-round(money1*0.03,0)+driverpay
	update @tmp set gno = '4' where profit<0 and pno='1'
	----------------------------------------------------------------------------------------------------
	if len(@t_detail)>0
	begin
		update @tmp set gno='5',rno=driverno+CHAR(255) where gno='1'
		update @tmp set gno='6',rno=driverno+CHAR(255) where gno='4'
		
		insert into @tmp(rno,mon,gno,pno,carkindno,carkind,driverno,driver,insures,money1,money2
			,custplus,custminus,driverplus,driverminus,reserve,tolls,etc,oil
			,wmoney,wmoneycar,wmoneyplate,cmoney,dmoney,emoney,ticket,bonus,tax,depreciation
			,miles,oilmount,driverpay)
		select a.driverno+a.mon,a.mon,'7','1',isnull(b.carkindno,''),ISNULL(c.kind,''),ISNULL(a.driverno,''),ISNULL(f.namea,'')
			,sum(ISNULL(a.insures,0)),sum(ISNULL(a.money1,0)),sum(ISNULL(a.money2,0))
			,sum(ISNULL(a.custplus,0)),sum(ISNULL(a.custminus,0)),sum(ISNULL(a.driverplus,0)),sum(ISNULL(a.driverminus,0))
			,sum(ISNULL(a.reserve,0)),sum(ISNULL(a.tolls,0)),sum(ISNULL(a.etc,0)),sum(ISNULL(a.oil,0))
			,sum(ISNULL(a.wmoney,0)),sum(ISNULL(a.wmoneycar,0)),sum(ISNULL(a.wmoneyplate,0)),sum(ISNULL(a.cmoney,0)),sum(ISNULL(a.dmoney,0)),sum(ISNULL(a.emoney,0))
			,sum(ISNULL(a.ticket,0)),sum(ISNULL(a.bonus,0)),sum(ISNULL(a.tax,0)),sum(ISNULL(a.depreciation,0))
			,sum(ISNULL(d.miles,0))
			,sum(ISNULL(d.mount,0))
			,sum(ISNULL(a.driverpay,0))
		from trans_sum a
		left join car2 b on a.carno=b.carno
		left join carkind c on b.carkindno=c.noa
		left join (select carno,SUM(isnull(mount,0)) mount,SUM(ISNULL(miles,0)) miles 
			from oil where LEFT(datea,6) between @t_bmon and @t_emon group by carno) d on a.carno=d.carno
		left join (select carno,driverno,count(1) mount 
			from (SELECT DISTINCT isnull(carno,'') carno,isnull(driverno,'') driverno,trandate from trans_sum where mon between @t_bmon and @t_emon) a 
			group by carno,driverno) e on a.carno=e.carno and a.driverno=e.driverno
		left join driver f on a.driverno=f.noa
		where a.mon between @t_bmon and @t_emon
		and b.cartype = '2' --公司車
		and isnull(a.driverno,'') between @t_bdriverno and @t_edriverno
		and (len(@t_carno)=0 or (len(ISNULL(b.carno,''))>0 and CHARINDEX(','+b.carno+',',','+@t_carno+',')>0))
		and (len(@t_carkind)=0 or (len(ISNULL(b.carkindno,''))>0 and CHARINDEX(','+b.carkindno+',',','+@t_carkind+',')>0))
		group by a.driverno+a.mon,a.mon,isnull(b.carkindno,''),ISNULL(c.kind,''),ISNULL(a.driverno,''),ISNULL(f.namea,'')
		
		update @tmp set oilrate=case when money1!=0 then oil/money1*100 else 0 end
		,kl=case when oilmount!=0 then miles/oilmount else 0 end	
	
		update @tmp set tax2 = round(money1*0.03,0)
		,profit=money1-money2-insures+custplus-custminus-driverplus+driverminus-reserve-tolls
		-etc-oil-wmoney-cmoney-dmoney-emoney-ticket-bonus-tax-depreciation-round(money1*0.03,0)+driverpay
	end
	----------------------------------------------------------------------------------------------------
	declare @n int
	declare @carkindno nvarchar(20)
	declare @carkind nvarchar(20)
	
	declare cursor_table cursor for
	select carkindno,carkind,count(1) from @tmp group by carkindno,carkind
	open cursor_table
	fetch next from cursor_table
	into @carkindno,@carkind,@n
	while(@@FETCH_STATUS <> -1)
	begin		
		while @n%@t_pageline !=0
		begin
			insert into @tmp(gno,pno,carkindno,carkind)
			values('3','3',@carkindno,@carkind)
			set @n=@n+1
		end
		
		fetch next from cursor_table
		into @carkindno,@carkind,@n
	end
	close cursor_table
	deallocate cursor_table
	
	select *
	,cast(round(oilrate,0) as nvarchar)+'%' m02
	,cast(kl as decimal(10,2)) m03
	,driver m06
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money1),1)),4,12))  m07
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,custplus),1)),4,12))  m08
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,custminus),1)),4,12))  m09
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money2),1)),4,12))  m10
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,driverplus),1)),4,12))  m11
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,driverminus),1)),4,12))  m12
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,reserve),1)),4,12))  m13
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)+ISNULL(etc,0)),1)),4,12))  m14
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,oil),1)),4,12))  m15
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ISNULL(wmoney,0)+ISNULL(dmoney,0)+ISNULL(emoney,0)),1)),4,12))  m16
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,wmoneycar),1)),4,12))  ma16
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,wmoneyplate),1)),4,12))  mb16
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ISNULL(cmoney,0)),1)),4,12))  m17
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ticket),1)),4,12))  m18
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bonus),1)),4,12)) m19
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax),1)),4,12))  m20
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,depreciation),1)),4,12))  m21
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,insures),1)),4,12))  m22
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax2),1)),4,12))  m23
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,profit),1)),4,12))  m24
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,driverpay),1)),4,12))  m25
	from @tmp 
	order by case when len(carkindno)=0 then CHAR(255) else carkindno end
		,pno
		,case when len(driverno)=0 then CHAR(255) else driverno end
		,rno
		;
		
z_tran17a:--z_tran17a
	declare @t_bmon nvarchar(10) = case when '#non'=[44] then '' else [44] end
	declare @t_emon nvarchar(10) = case when '#non'=[45] then char(255) else [45] end
	declare @t_bdriverno nvarchar(20) = case when '#non'=[46] then '' else [46] end
	declare @t_edriverno nvarchar(20) = case when '#non'=[47] then char(255) else [47] end
	declare @t_carno nvarchar(max) = case when '#non'=[48] then '' else [48] end
	declare @t_carkind nvarchar(max) = case when '#non'=[49] then '' else [49] end
	
	declare @t_pageline int = 30  --一頁的行數
	declare @tmp table(
		gno nvarchar(10),
		pno nvarchar(10),
		
		caryear nvarchar(20),
		carkindno nvarchar(20),
		carkind nvarchar(20),
		oilmount float,
		miles float,
		oilrate float,
		kl float,
		carday float,
		carno nvarchar(20),
		driverno nvarchar(20),
		driver nvarchar(20),
		mon nvarchar(10),
		insures float,
		money1 float,
		money2 float,
		custplus float,
		custminus float,
		driverplus float,
		driverminus float,
		reserve float,
		tolls float,
		etc float,
		oil float,
		wmoney float,
		wmoneycar float,
		wmoneyplate float,
		cmoney float,
		dmoney float,
		emoney float,
		ticket float,
		bonus float,
		tax float,
		depreciation float,
		tax2 float,--稅捐  money1 * 3%
		driverpay float,
		profit float
	)
	insert into @tmp(gno,pno,carkindno,carkind,carno,driverno,mon,insures,money1,money2
		,custplus,custminus,driverplus,driverminus,reserve,tolls,etc,oil
		,wmoney,wmoneycar,wmoneyplate,cmoney,dmoney,emoney,ticket,bonus,tax,depreciation,driverpay)
	select '1','1',isnull(b.carkindno,''),ISNULL(c.kind,''),ISNULL(a.carno,''),ISNULL(a.driverno,''),ISNULL(a.mon,'')
		,sum(ISNULL(a.insures,0)),sum(ISNULL(a.money1,0)),sum(ISNULL(a.money2,0))
		,sum(ISNULL(a.custplus,0)),sum(ISNULL(a.custminus,0)),sum(ISNULL(a.driverplus,0)),sum(ISNULL(a.driverminus,0))
		,sum(ISNULL(a.reserve,0)),sum(ISNULL(a.tolls,0)),sum(ISNULL(a.etc,0)),sum(ISNULL(a.oil,0))
		,sum(ISNULL(a.wmoney,0)),sum(ISNULL(a.wmoneycar,0)),sum(ISNULL(a.wmoneyplate,0)),sum(ISNULL(a.cmoney,0)),sum(ISNULL(a.dmoney,0)),sum(ISNULL(a.emoney,0))
		,sum(ISNULL(a.ticket,0)),sum(ISNULL(a.bonus,0)),sum(ISNULL(a.tax,0)),sum(ISNULL(a.depreciation,0)) 
		,sum(isnull(a.driverpay,0))
	from trans_sum a
	left join car2 b on a.carno=b.carno
	left join carkind c on b.carkindno=c.noa
	where a.mon between @t_bmon and @t_emon
	and b.cartype = '2' --公司車
	and isnull(a.driverno,'') between @t_bdriverno and @t_edriverno
	and (len(@t_carno)=0 or (len(ISNULL(b.carno,''))>0 and CHARINDEX(','+b.carno+',',','+@t_carno+',')>0))
	and (len(@t_carkind)=0 or (len(ISNULL(b.carkindno,''))>0 and CHARINDEX(','+b.carkindno+',',','+@t_carkind+',')>0))
	group by isnull(b.carkindno,''),ISNULL(c.kind,''),ISNULL(a.carno,''),ISNULL(a.driverno,''),ISNULL(a.mon,'')
	

	update @tmp set caryear=b.caryear,oilmount=c.mount,oilrate=case when money1!=0 then oil/money1*100 else 0 end
		,miles=c.miles
		,kl=case when c.mount!=0 then c.miles/c.mount else 0 end
		,carday=d.mount
		,driver=e.namea
	from @tmp a
	left join car2 b on a.carno=b.carno
	left join (select carno,LEFT(datea,6) mon,SUM(isnull(mount,0)) mount,SUM(ISNULL(miles,0)) miles 
		from oil where LEFT(datea,6) between @t_bmon and @t_emon group by carno,LEFT(datea,6)) c on a.carno=c.carno and a.mon=c.mon
	left join (select carno,driverno,mon,count(1) mount 
		from (SELECT DISTINCT isnull(carno,'') carno,isnull(driverno,'') driverno,mon,trandate from trans_sum where mon between @t_bmon and @t_emon) a 
		group by carno,driverno,mon) d on a.carno=d.carno and a.driverno=d.driverno and a.mon=d.mon
	left join driver e on a.driverno=e.noa
	
	insert into @tmp(gno,pno,carkindno,carkind,miles,oilmount,insures,money1,money2
		,custplus,custminus,driverplus,driverminus,reserve,tolls,etc,oil
		,wmoney,wmoneycar,wmoneyplate,cmoney,dmoney,emoney,ticket,bonus,tax,depreciation,driverpay)
	select '2','2',carkindno,carkind,SUM(ISNULL(miles,0)),SUM(isnull(oilmount,0)),sum(insures),SUM(money1),SUM(money2)
		,SUM(custplus),SUM(custminus),SUM(driverplus),SUM(driverminus),SUM(reserve),SUM(tolls),SUM(etc),SUM(oil)
		,SUM(wmoney),SUM(wmoneycar),SUM(wmoneyplate),SUM(cmoney),SUM(dmoney),SUM(emoney),SUM(ticket),SUM(bonus),SUM(tax),SUM(depreciation)
		,sum(driverpay)
	from @tmp where pno='1' group by carkindno,carkind

	update @tmp set oilrate=case when money1!=0 then oil/money1*100 else 0 end
		,kl = case when oilmount!=0 then miles/oilmount else 0 end
	where pno='2'
	
	update @tmp set tax2 = round(money1*0.03,0),profit=money1-money2-insures+custplus-custminus-driverplus+driverminus-reserve-tolls
		-etc-oil-wmoney-cmoney-dmoney-emoney-ticket-bonus-tax-depreciation-round(money1*0.03,0)+driverpay
	update @tmp set gno = '4' where profit<0 and pno='1'
	----------------------------------------------------------------------------------------------------
	declare @n int
	declare @carkindno nvarchar(20)
	declare @carkind nvarchar(20)
	
	declare cursor_table cursor for
	select carkindno,carkind,count(1) from @tmp group by carkindno,carkind
	open cursor_table
	fetch next from cursor_table
	into @carkindno,@carkind,@n
	while(@@FETCH_STATUS <> -1)
	begin		
		while @n%@t_pageline !=0
		begin
			insert into @tmp(gno,pno,carkindno,carkind)
			values('3','3',@carkindno,@carkind)
			set @n=@n+1
		end
		
		fetch next from cursor_table
		into @carkindno,@carkind,@n
	end
	close cursor_table
	deallocate cursor_table
	
	select *
	,caryear m01
	,cast(round(oilrate,0) as nvarchar)+'%' m02
	,cast(kl as decimal(10,2)) m03
	,carday m04
	,carno m05
	,driver m06
	
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money1),1)),4,12))  m07
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,custplus),1)),4,12))  m08
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,custminus),1)),4,12))  m09
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money2),1)),4,12))  m10
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,driverplus),1)),4,12))  m11
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,driverminus),1)),4,12))  m12
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,reserve),1)),4,12))  m13
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)+ISNULL(etc,0)),1)),4,12))  m14
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,oil),1)),4,12))  m15
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ISNULL(wmoney,0)+ISNULL(dmoney,0)+ISNULL(emoney,0)),1)),4,12))  m16
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,wmoneycar),1)),4,12))  ma16
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,wmoneyplate),1)),4,12))  mb16
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ISNULL(cmoney,0)),1)),4,12))  m17
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ticket),1)),4,12))  m18
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bonus),1)),4,12)) m19
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax),1)),4,12))  m20
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,depreciation),1)),4,12))  m21
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,insures),1)),4,12))  m22
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax2),1)),4,12))  m23
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,profit),1)),4,12))  m24
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,driverpay),1)),4,12))  m25
	from @tmp 
	order by case when len(carkindno)=0 then CHAR(255) else carkindno end
		,pno
		,caryear
		,case when len(carno)=0 then CHAR(255) else carno end
		,case when len(driverno)=0 then CHAR(255) else driverno end
		,mon
		;
		
z_tran28:--z_tran28
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	declare @t_sort08  nvarchar(max)
	declare @t_field05  nvarchar(max)
	declare @t_sort03  nvarchar(max)
	declare @t_sort14  nvarchar(max)
	declare @t_bsalesno  nvarchar(20)
	declare @t_esalesno  nvarchar(20)
	declare @t_sort06 nvarchar(max)
	declare @t_bsalesno2  nvarchar(20)
	declare @t_esalesno2  nvarchar(20)
	declare @t_sort18  nvarchar(max)
	declare @t_option28 nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	set @t_sort08  = case when '#non'=[27] then '' else [27] end
	set @t_field05  = case when '#non'=[28] then '' else [28] end
	set @t_sort03 = case when '#non'=[29] then '' else [29] end
	set @t_sort14 = case when '#non'=[30] then '' else [30] end
	set @t_bsalesno = case when '#non'=[31] then '' else [31] end
	set @t_esalesno = case when '#non'=[32] then char(255) else [32] end
	set @t_sort06  = case when '#non'=[33] then '' else [33] end
	set @t_bsalesno2 = case when '#non'=[34] then '' else [34] end
	set @t_esalesno2 = case when '#non'=[35] then char(255) else [35] end
	set @t_sort18 = case when '#non'=[36] then '' else [36] end
	set @t_option28 = case when '#non'=[43] then '' else [43] end
	------------------------------------------------------------------------------------------------------------------
	declare @tmp table(
		custno nvarchar(20),
		mon nvarchar(10),
		inmoney float,
		inmount decimal(15,3),
		outmoney1 float,
		outmount1 decimal(15,3),
		outmoney2 float,
		outmount2 decimal(15,3),
		diff float
	)
	insert into @tmp(custno,mon,inmoney,inmount,outmoney1,outmount1,outmoney2,outmount2)
	select a.custno,LEFT(a.trandate,case when len(@t_option28)=0 then 0 else 6 end) mon
	,SUM(ISNULL(total,0)) inmoney
	,SUM(ISNULL(mount,0)) inmount
	,SUM(case when e.isoutside!=1 then (case when patindex('%in%',@t_option3)>0 then isnull(total2,0) else round(isnull(mount2,0)*isnull(price2,0),0) end) else 0 end) outmoney1
	,SUM(case when e.isoutside!=1 then isnull(mount2,0) else 0 end) outmount1
	,SUM(case when e.isoutside=1 then (case when patindex('%out%',@t_option3)>0 then isnull(total2,0) else round(isnull(mount2,0)*isnull(price3,0),0) end) else 0 end) outmoney2
	,SUM(case when e.isoutside=1 then isnull(mount2,0) else 0 end) outmount2
	from  view_trans  a
	left join carteam  d on a.carteamno=d.noa
	left join calctypes e on a.calctype=e.noa+e.noq
	where (a.datea  between  @t_bdate  and  @t_edate)  
	and (a.trandate between  @t_btrandate  and  @t_etrandate)
	and (a.custno  between  @t_bcustno   and  @t_ecustno)
	and (a.driverno  between  @t_bdriverno   and  @t_edriverno)
	and (len(@t_carno)=0  or  a.carno=@t_carno)
	and (len(@t_po)=0  or  a.po=@t_po)
	and (a.straddrno between @t_baddr and @t_eaddr)
	and (len(@t_carteam)=0 or CHARINDEX(','+a.carteamno+',',','+@t_carteam+',')>0)
	and (len(@t_calctype)=0 or CHARINDEX(','+a.calctype+',',','+@t_calctype+',')>0)
	and not(isnull(a.total,0)=0 and isnull(a.total2,0)=0)
	group by a.custno,LEFT(a.trandate,case when len(@t_option28)=0 then 0 else 6 end) 
	 
	update @tmp set diff = ISNULL(inmoney,0)-ISNULL(outmoney1,0)-ISNULL(outmoney2,0)
	
	declare @string nvarchar(max)
	if len(@t_bdate)>0
		set  @string  =  '登錄日期：'+@t_bdate+'～'+@t_edate
	else
		set  @string   =  '交運日期：'+@t_btrandate+'～'+@t_etrandate
	declare @tmp_addr1 nvarchar(20),@tmp_addr2 nvarchar(50),@tmp_addr nvarchar(max)
	select @tmp_addr1='',@tmp_addr2='',@tmp_addr=''
	select @tmp_addr1=ISNULL(addr,'') from addr where noa=@t_baddr
	select @tmp_addr2=ISNULL(addr,'') from addr where noa=@t_eaddr
	if(LEN(ISNULL(@tmp_addr1,''))>0 and LEN(ISNULL(@tmp_addr2,''))>0)
		if @tmp_addr1=@tmp_addr2
			set @tmp_addr = @tmp_addr1
		else
			set @tmp_addr = @tmp_addr1+'~'+@tmp_addr2
	------------------------------------------------------------------------------------------------------------------------
	if @t_sort18='custno'
	begin
		select a.*,b.nick nick,@string tt1,@tmp_addr tt2
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,floor(inmount)),1)),4,12))+'.'+RIGHT(CAST(inmount as nvarchar),3) a1
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,inmoney),1)),4,12)) a2
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,floor(outmount1)),1)),4,12))+'.'+RIGHT(CAST(outmount1 as nvarchar),3) a3
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,outmoney1),1)),4,12)) a4
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,floor(outmount2)),1)),4,12))+'.'+RIGHT(CAST(outmount2 as nvarchar),3) a5
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,outmoney2),1)),4,12)) a6
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,diff),1)),4,12)) a7
		from(	
			select case when a.recno=1 then '1' else '2' end gno,* 
			from (select ROW_NUMBER()over(PARTITION by custno order by custno,mon) recno,* from @tmp ) a
			union all 
			select '3',0,CHAR(255),'',SUM(inmoney),SUM(inmount),SUM(outmoney1),SUM(outmount1),SUM(outmoney2),SUM(outmount2),SUM(diff)
			from @tmp) a
		left join cust b on a.custno=b.noa
	end
	else
	begin
		select a.*
		,b.nick nick,@string tt1,@tmp_addr tt2
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,floor(a.inmount)),1)),4,12))+'.'+RIGHT(CAST(a.inmount as nvarchar),3) a1
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.inmoney),1)),4,12)) a2
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,floor(a.outmount1)),1)),4,12))+'.'+RIGHT(CAST(a.outmount1 as nvarchar),3) a3
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.outmoney1),1)),4,12)) a4
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,floor(a.outmount2)),1)),4,12))+'.'+RIGHT(CAST(a.outmount2 as nvarchar),3) a5
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.outmoney2),1)),4,12)) a6
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.diff),1)),4,12)) a7
		from (
			select case when c.recno=1 then '1' else '2' end gno,b.recno rr1,c.recno rr2,a.*
			from @tmp a
			left join (select ROW_NUMBER()over(order by inmoney,custno) recno,a.*
				from(select custno,SUM(inmoney) inmoney from @tmp group by custno) a)b on a.custno=b.custno
			left join(select ROW_NUMBER()over(PARTITION by custno order by custno,mon) recno,* from @tmp ) c on a.custno=c.custno and a.mon = c.mon
			union all
			select '3',0,0,CHAR(255),'',SUM(inmoney),SUM(inmount),SUM(outmoney1),SUM(outmount1),SUM(outmoney2),SUM(outmount2),SUM(diff) from @tmp
		)a
		left join cust b on a.custno=b.noa
		order by a.rr1 desc,a.rr2
	end;

z_tran27:--z_tran27
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	declare @t_sort08  nvarchar(max)
	declare @t_field05  nvarchar(max)
	declare @t_sort03  nvarchar(max)
	declare @t_sort14  nvarchar(max)
	declare @t_bsalesno  nvarchar(20)
	declare @t_esalesno  nvarchar(20)
	declare @t_sort06 nvarchar(max)
	declare @t_bsalesno2  nvarchar(20)
	declare @t_esalesno2  nvarchar(20)
	declare @t_sort18  nvarchar(max)
	declare @t_rate nvarchar(10)
	declare @t_sort01 nvarchar(max)
	declare @t_filter nvarchar(max)
	declare @t_option nvarchar(max)
	declare @t_option27 nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	set @t_sort08  = case when '#non'=[27] then '' else [27] end
	set @t_field05  = case when '#non'=[28] then '' else [28] end
	set @t_sort03 = case when '#non'=[29] then '' else [29] end
	set @t_sort14 = case when '#non'=[30] then '' else [30] end
	set @t_bsalesno = case when '#non'=[31] then '' else [31] end
	set @t_esalesno = case when '#non'=[32] then char(255) else [32] end
	set @t_sort06  = case when '#non'=[33] then '' else [33] end
	set @t_bsalesno2 = case when '#non'=[34] then '' else [34] end
	set @t_esalesno2 = case when '#non'=[35] then char(255) else [35] end
	set @t_sort18 = case when '#non'=[36] then '' else [36] end
	set @t_rate  = case when '#non'=[37] then '' else [37] end
	set @t_sort01  = case when '#non'=[38] then '' else [38] end
	set @t_filter  = case when '#non'=[39] then '' else [39] end
	set @t_option  = case when '#non'=[40] then '' else [40] end
	set @t_option27  = case when '#non'=[41] then '' else [41] end
	-----------------------------------------------------------------------	
	declare @string nvarchar(max)
	declare @n int
	----------------------------------------------------------------------------------------------
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_tran27')is not null
	BEGIN
		set @cmd = 'drop table #z_tran27'
		EXECUTE sp_executesql @cmd
	END
	create table  #z_tran27(
		tranno nvarchar(20),
		custno nvarchar(20),
		datea nvarchar(10),
		trandate nvarchar(10),
		straddrno nvarchar(20),
		straddr nvarchar(max),
		carno nvarchar(20),
		productno nvarchar(20),
		product nvarchar(20),
		mount float,
		price float,
		[money] float,
		custorde nvarchar(40),
		po nvarchar(40),
		caseno nvarchar(20)
	)
	create index custno on #z_tran27(custno)
	set @cmd = 
		"select a.noa,a.custno,a.datea,a.trandate,a.straddrno,a.straddr,a.carno"+
		",a.uccno,a.product,a.mount,a.price,a.total,a.custorde,a.po"+
		",a."+@t_option27+
		" from  view_trans"+@t_accy+"  a "+
		" left join #carteam  b on a.carteamno=b.noa"+	
		" left join #calctype c on a.calctype=c.noa"+
		" left join carteam  d on a.carteamno=d.noa"+	
		" left join calctypes e on a.calctype=e.noa+e.noq"+
		" left join cust f on f.noa = a.custno "+
		" where "+
		" (isnull(a.datea,'') between @t_bdate and @t_edate) and "+
		" (isnull(a.trandate,'') between @t_btrandate and @t_etrandate) and "+
		" (isnull(a.custno,'') between @t_bcustno and @t_ecustno) and" +
		" (isnull(a.driverno,'') between @t_bdriverno and @t_edriverno) and"+
		" (len(@t_carno) = 0 or a.carno = @t_carno) and"+
		" (len(@t_po)=0 or a.po = @t_po) and"+
		" (a.straddrno between @t_baddr and @t_eaddr) and"+
		" (b.noa  is  not  null) and (c.noa  is  not  null)"
	insert into #z_tran27
	execute sp_executesql @cmd,N'@t_cno  nvarchar(50),@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bcustno nvarchar(20),@t_ecustno nvarchar(20),@t_bdriverno  nvarchar(20),@t_edriverno  nvarchar(20),@t_carno  nvarchar(20),@t_po  nvarchar(20),@t_baddr nvarchar(20),@t_eaddr nvarchar(20),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10)',
		@t_cno=@t_cno,@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_po=@t_po,@t_baddr=@t_baddr,@t_eaddr=@t_eaddr,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate
	------------------------------------------------------------
	declare @tmp table(
		gno nvarchar(10),
		pno nvarchar(10),
		custno nvarchar(20),
		tranno nvarchar(20),
		
		acomp nvarchar(20),
		comp nvarchar(20),
		serial nvarchar(10),
		cust_addr nvarchar(40),
		cust_tel nvarchar(40),
		cust_fax nvarchar(40),
		
		trandate nvarchar(10),
		addrno nvarchar(20),
		addr nvarchar(max),
		carno nvarchar(20),
		product nvarchar(20),
		mount decimal(10,3),
		price decimal(10,3),
		[money] float,
		custorde nvarchar(40)
	)
	declare @custno nvarchar(20)
	declare @cust nvarchar(20)
	declare @serial nvarchar(10)
	declare @cust_addr nvarchar(40)
	declare @cust_tel nvarchar(40)
	declare @cust_fax nvarchar(40)
	
	declare @tranno nvarchar(20)
	declare @trandate nvarchar(10)
	declare @addrno nvarchar(20)
	declare @addr nvarchar(40)
	declare @carno nvarchar(20)
	declare @product nvarchar(20)
	declare @mount float
	declare @price float
	declare @money float
	declare @custorde nvarchar(40)
	declare @caseno nvarchar(20)
	
	declare cursor_table cursor for
	select custno from #z_tran27 group by custno
	open cursor_table
	fetch next from cursor_table
	into @custno
	while(@@FETCH_STATUS <> -1)
	begin
		select @cust='',@serial='',@cust_addr='',@cust_tel='',@cust_fax=''
		select @cust=comp,@serial=serial,@cust_addr=addr_home,@cust_tel=tel,@cust_fax=fax
		from cust where noa=@custno

		declare cursor_table2 cursor for
		select tranno,trandate,straddrno,straddr,carno,product,mount,price,[money],isnull(custorde,''),isnull(caseno,'') 
		from #z_tran27 where custno=@custno
		open cursor_table2
		fetch next from cursor_table2
		into @tranno,@trandate,@addrno,@addr,@carno,@product,@mount,@price,@money,@custorde ,@caseno
		while(@@FETCH_STATUS <> -1)
		begin
			insert into @tmp
			(gno,pno,acomp,custno,comp,serial,cust_addr,cust_tel,cust_fax
			,tranno,trandate,addrno,addr,carno,product,mount,price,[money],custorde)
			values('0','1',@t_cno,@custno,@cust,@serial,@cust_addr,@cust_tel,@cust_fax
			,@tranno,@trandate,@addrno,@addr,@caseno,@product,@mount,@price,@money,@custorde)
			
			fetch next from cursor_table2
			into @tranno,@trandate,@addrno,@addr,@carno,@product,@mount,@price,@money,@custorde,@caseno
		end
		close cursor_table2
		deallocate cursor_table2
		--日小計     2013/04/01  說不要,不顯示
		--declare cursor_table2 cursor for
		--select trandate,sum(mount),sum([money]) from #z_tran27 
		--where custno=@custno group by trandate having count(1)>1
		--open cursor_table2
		--fetch next from cursor_table2
		--into @trandate,@mount,@money
		--while(@@FETCH_STATUS <> -1)
		--begin
		--	insert into @tmp
		--	(gno,pno,acomp,custno,comp,serial,cust_addr,cust_tel,cust_fax
		--	,trandate,mount,[money])
		--	values('1','2',@t_cno,@custno,@cust,@serial,@cust_addr,@cust_tel,@cust_fax
		--	,@trandate,@mount,@money)
			
		--	fetch next from cursor_table2
		--	into @trandate,@mount,@money
		--end
		--close cursor_table2
		--deallocate cursor_table2
		
		--總計
		select @mount=0, @money=0
		select @mount=sum(mount),@money=sum([money]) from #z_tran27 where custno=@custno
		insert into @tmp
		(gno,pno,acomp,custno,comp,serial,cust_addr,cust_tel,cust_fax
		,trandate,mount,[money])
		values('2','3',@t_cno,@custno,@cust,@serial,@cust_addr,@cust_tel,@cust_fax
		,CHAR(255),@mount,@money)
	
		fetch next from cursor_table
		into @custno
	end
	close cursor_table
	deallocate cursor_table
	select * 
	,trandate dd
	,product pp
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,floor(mount)),1)),4,12))+'.'+RIGHT(CAST(mount as nvarchar),3) mt
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,floor(price)),1)),4,12))+'.'+RIGHT(CAST(price as nvarchar),3) mp
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,[money]),1)),4,12)) mm
	--from @tmp order by custno,trandate,pno,addrno,addr,tranno
	from @tmp order by custno,trandate,pno,tranno
	
	drop table #z_tran27;

z_tran01:--z_tran01	 查詢區間不可超過三個月
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	declare @t_sort08  nvarchar(max)
	declare @t_field05  nvarchar(max)
	declare @t_sort03  nvarchar(max)
	declare @t_sort14  nvarchar(max)
	declare @t_bsalesno  nvarchar(20)
	declare @t_esalesno  nvarchar(20)
	declare @t_sort06 nvarchar(max)
	declare @t_bsalesno2  nvarchar(20)
	declare @t_esalesno2  nvarchar(20)
	declare @t_sort18  nvarchar(max)
	declare @t_rate nvarchar(10)
	declare @t_sort01 nvarchar(max)
	declare @t_filter nvarchar(max)
	declare @t_option nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	set @t_sort08  = case when '#non'=[27] then '' else [27] end
	set @t_field05  = case when '#non'=[28] then '' else [28] end
	set @t_sort03 = case when '#non'=[29] then '' else [29] end
	set @t_sort14 = case when '#non'=[30] then '' else [30] end
	set @t_bsalesno = case when '#non'=[31] then '' else [31] end
	set @t_esalesno = case when '#non'=[32] then char(255) else [32] end
	set @t_sort06  = case when '#non'=[33] then '' else [33] end
	set @t_bsalesno2 = case when '#non'=[34] then '' else [34] end
	set @t_esalesno2 = case when '#non'=[35] then char(255) else [35] end
	set @t_sort18 = case when '#non'=[36] then '' else [36] end
	set @t_rate  = case when '#non'=[37] then '' else [37] end
	set @t_sort01  = case when '#non'=[38] then '' else [38] end
	set @t_filter  = case when '#non'=[39] then '' else [39] end
	set @t_option  = case when '#non'=[40] then '' else [40] end
	----------------------------------------------------------------------------------------------
	set @t_btrandate = case when len(@t_btrandate)=0 then @t_accy+'/01/01' else @t_btrandate end
	set @t_etrandate = case when @t_etrandate=CHAR(255) then @t_accy+'/12/31' else @t_etrandate end
	----------------------------------------------------------------------------------------------
	declare @string nvarchar(max)
	declare @n int
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end

	----------------------------------------------------------------------------------------------
	declare @carno nvarchar(20)
	declare @datea nvarchar(10)
	declare @carkindno  nvarchar(20)
	declare @carkind	nvarchar(20)
	declare @miles float
	declare @tranmoney float
	declare @drivermoney float
	declare @reserve float 
	declare @mount float 
	declare @money float 
	----------------------------------------------------------------------------------------------
	
	declare @t_date nvarchar(10)
	declare @t_date1 nvarchar(10)
	declare @t_date2 nvarchar(10)

	set @t_date1 = convert(nvarchar(4),convert(int,LEFT(@t_btrandate,3))+1911)+'-'+SUBSTRING(@t_btrandate,5,2)+'-'+RIGHT(@t_btrandate,2)
	set @t_date2 = convert(nvarchar(4),convert(int,LEFT(@t_etrandate,3))+1911)+'-'+SUBSTRING(@t_etrandate,5,2)+'-'+RIGHT(@t_etrandate,2)
	set @t_date=@t_date1

	if(isdate(@t_date1)=0 or isdate(@t_date2)=0)
	begin
		print '日期錯誤'
		return	
	end
	--if(DATEDIFF(MM,@t_date1,@t_date2)>2)
	--begin
	--	print '查詢區間不可超過三個月'
	--	return	
	--end
	IF OBJECT_ID('tempdb..#listDate')is not null
	BEGIN
		set @cmd = 'drop table #listDate'
		EXECUTE sp_executesql @cmd
	END
	create table #listDate(
		[date] nvarchar(20)
	)

	while (@t_date between @t_date1 and @t_date2)
	begin
		insert into #listDate select right('00'+convert(nvarchar(3),convert(int,YEAR(@t_date))-1911),3)+'/'+right('0'+convert(nvarchar(2),convert(int,MONTH(@t_date))),2)+'/'+right('0'+convert(nvarchar(2),convert(int,DAY(@t_date))),2)
		set @t_date= convert(date,DATEADD(DD,1,@t_date),111)
	end
	----------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#listCarno')is not null
	BEGIN
		set @cmd = 'drop table #listCarno'
		EXECUTE sp_executesql @cmd
	END
	create table #listCarno(
		carno nvarchar(20),	
		carkindno nvarchar(20),
		carkind nvarchar(20)																																				
	)
	set @cmd=
	" select  a.carno,isnull(c.noa,''),isnull(c.kind,'') "+ 
	" from  view_trans"+@t_accy+" a  "+
	" left join car2 b on a.carno=b.carno"+
	" left join carKind c on b.carkindno=c.noa"+
	" left join calctypes d on d.noa+d.noq=a.calctype"+
	" left join #carkind e on e.noa=c.noa"+ 
	" where isnull(d.isoutside,0)=0"+
	" and (len(@t_carno)=0 or @t_carno=a.carno)"+
	" and (e.noa is not null)"+
	" and (LEFT(a.trandate,6)  between LEFT(@t_btrandate,6)  and  LEFT(@t_etrandate,6)) "+ 
	" group  by a.carno,isnull(c.noa,''),isnull(c.kind,'') "
	
	insert into #listCarno
	execute  sp_executesql @cmd,N'@t_carno nvarchar(20),@t_btrandate  nvarchar(10),@t_etrandate  nvarchar(10)',@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate,@t_carno=@t_carno
	----------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_tran01')is not null
	BEGIN
		set @cmd = 'drop table #z_tran01'
		EXECUTE sp_executesql @cmd
	END
	create table #z_tran01 (
		n float,
		gno nvarchar(3),
		carno nvarchar(20),
		carkindno nvarchar(20),
		carkind nvarchar(20),
		driverno nvarchar(20),
		driver nvarchar(20),
		trandate nvarchar(10),
		miles float,
		tranmoney float,
		drivermoney float,
		oilmount float,
		oilmoney float,
		tolls float,
		ticket float,
		reserve float,
		profit  float,
		memo nvarchar(max),
		rate1 float,
		zdriver nvarchar(20),
		zaddr nvarchar(40),
		zmoney nvarchar(20),
		zmiles nvarchar(20),
		
		ystation nvarchar(20),
		ymount nvarchar(20),
		yprice nvarchar(20),
		ymiles nvarchar(20),
		ymoney nvarchar(20),
		ybmiles nvarchar(20),
		yemiles nvarchar(20)
	)
	CREATE INDEX noa ON #z_tran01 (carno,trandate)
	
	declare cursor_table cursor for
	select carno,carkindno,carkind,[date] from #listCarno,#listDate
	open cursor_table
	fetch next from cursor_table
	into @carno,@carkindno,@carkind,@datea
	while(@@FETCH_STATUS <> -1)
	begin
		insert into #z_tran01(n,gno,carno,carkindno,carkind,trandate,rate1)values(-1,'1',@carno,@carkindno,@carkind,@datea,0)
		fetch next from cursor_table
		into @carno,@carkindno,@carkind,@datea
	end
	close cursor_table
	deallocate cursor_table
	-----------------------------------------------------------------------------------------------------------
	declare @trandate nvarchar(10)
	declare @memo nvarchar(max)
	--出車單
	declare @tmp table(
		carno nvarchar(20),
		trandate nvarchar(20),
		miles float,
		tranmoney float,
		drivermoney float,
		reserve float
	)
	set @cmd  =
	" select a.carno,a.trandate"+
	" ,sum(ISNULL(miles,0))"+
	" ,sum(round(a.price*a.mount,0))"+
	" ,sum(round(a.price2*a.mount2*a.discount,0))"+
	" ,sum(isnull(a.reserve,0))"+
	" from view_trans"+@t_accy+" a"+
	" left join car2 b on a.carno=b.carno"+
	" left join #carkind c on b.carkindno=c.noa"+
	" left  join  calctypes d on d.noa+d.noq=a.calctype "+
	" where (c.noa is not null)"+
	" and (patindex('%option01%',@t_option)=0 or (patindex('%option01%',@t_option)>0 and isnull(b.option01,0)=1))"+
	" and isnull(d.isoutside,0)=0"+
	" and (a.trandate between @t_btrandate and @t_etrandate)"+
	" group by a.carno,a.trandate"
	
	insert into @tmp
	execute sp_executesql @cmd,N'@t_option nvarchar(max),@t_filter nvarchar(max),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10)'
	,@t_option=@t_option,@t_filter=@t_filter,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate
	
	
	----------------------------------------------------------------------------------------------
	declare cursor_table cursor for
	select carno,trandate,miles,tranmoney,drivermoney,reserve from @tmp
	open cursor_table
	fetch next from cursor_table
	into @carno,@trandate,@miles,@tranmoney,@drivermoney,@reserve
	while(@@FETCH_STATUS <> -1)
	begin
		update #z_tran01 set miles=@miles,tranmoney=@tranmoney,drivermoney=@drivermoney,reserve=@reserve where carno=@carno and trandate=@trandate
		
		fetch next from cursor_table
		into @carno,@trandate,@miles,@tranmoney,@drivermoney,@reserve
	end
	close cursor_table
	deallocate cursor_table
	
	-----------------------------------------------------------------------------------------------------------
	--油費
	declare cursor_table cursor for
	select a.carno,a.datea,SUM(isnull(a.mount,0)),SUM(isnull(a.[money],0))
	from oil a
	left join car2 b on a.carno=b.carno
	where (a.datea between @t_btrandate and @t_etrandate)
	and patindex('%option01%',@t_option)=0 or (patindex('%option01%',@t_option)>0 and isnull(b.option01,0)=1)
	group  by  a.carno,a.datea
	open cursor_table
	fetch next from cursor_table
	into @carno,@datea,@mount,@money
	while(@@FETCH_STATUS <> -1)
	begin
		update #z_tran01 set oilmount=@mount,oilmoney=@money where carno=@carno and trandate=@datea
		
		fetch next from cursor_table
		into @carno,@datea,@mount,@money
	end
	close cursor_table
	deallocate cursor_table
	--加油備註
	declare cursor_table cursor for
	select a.carno,a.datea,a.memo
	from oil a
	left join car2 b on a.carno=b.carno
	where len(isnull(a.memo,''))>1 --排除MEMO  =  .  的
	and (a.datea between @t_btrandate and @t_etrandate)
	and patindex('%option01%',@t_option)=0 or (patindex('%option01%',@t_option)>0 and isnull(b.option01,0)=1)
	open cursor_table
	fetch next from cursor_table
	into @carno,@datea,@memo
	while(@@FETCH_STATUS <> -1)
	begin
		set @memo = case when left(@memo,1)='.' then SUBSTRING(@memo,1,LEN(@memo)) else @memo end
		update #z_tran01 set
		memo=ISNULL(memo,'')+case when len(ISNULL(memo,''))>0 then CHAR(59) else '' end + @memo
		where carno=@carno and trandate=@datea
		
		fetch next from cursor_table
		into @carno,@datea,@memo
	end
	close cursor_table
	deallocate cursor_table
	-----------------------------------------------------------------------------------------------------------
	--ETC
	declare cursor_table cursor for
	select a.carno,a.datea,SUM(isnull(a.[money],0))
	from etc a
	left join car2 b on a.carno=b.carno
	where (a.typea='ETC' or a.typea='CASH')
	and (a.datea between @t_btrandate and @t_etrandate)
	and patindex('%option01%',@t_option)=0 or (patindex('%option01%',@t_option)>0 and isnull(b.option01,0)=1)
	group  by  a.carno,a.datea
	open cursor_table
	fetch next from cursor_table
	into @carno,@datea,@money
	while(@@FETCH_STATUS <> -1)
	begin
		update #z_tran01 set tolls=@money where carno=@carno and trandate=@datea
		
		fetch next from cursor_table
		into @carno,@datea,@money
	end
	close cursor_table
	deallocate cursor_table
	-----------------------------------------------------------------------------------------------------------
	--罰單
	declare cursor_table cursor for
	select a.carno,a.datea,SUM(isnull(a.comppay,0))
	from carborr a
	left join car2 b on a.carno=b.carno
	where comppay!=0
	and patindex('%option01%',@t_option)=0 or (patindex('%option01%',@t_option)>0 and isnull(b.option01,0)=1)
	and (a.datea between @t_btrandate and @t_etrandate)
	group  by  a.carno,a.datea
	open cursor_table
	fetch next from cursor_table
	into @carno,@datea,@money
	while(@@FETCH_STATUS <> -1)
	begin
		update #z_tran01 set ticket=@money where carno=@carno and trandate=@datea
		
		fetch next from cursor_table
		into @carno,@datea,@money
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------------------
	update #z_tran01 set profit=ISNULL(tranmoney,0)-ISNULL(drivermoney,0)-ISNULL(oilmoney,0)-ISNULL(tolls,0)-ISNULL(ticket,0)-ISNULL(reserve,0)
	
	delete #z_tran01 where (isnull(tranmoney,0)=0 and isnull(oilmoney,0)=0 and @t_rate>0) or (isnull(tranmoney,0)!=0 and round(isnull(oilmoney,0)*100/isnull(tranmoney,0),0)<CAST(@t_rate as float))
	
	---------------------------------------------------------------------------------------------
	insert into #z_tran01(n,gno,carno,trandate,miles,tranmoney,drivermoney,oilmount,oilmoney,tolls,ticket,reserve,profit)
	select 2,'2',CHAR(255),CHAR(255),SUM(ISNULL(miles,0)),SUM(ISNULL(tranmoney,0)),SUM(ISNULL(drivermoney,0))
	,SUM(ISNULL(oilmount,0)),SUM(ISNULL(oilmoney,0)),SUM(ISNULL(tolls,0)),SUM(ISNULL(ticket,0)),SUM(ISNULL(reserve,0)),SUM(ISNULL(profit,0))
	from  #z_tran01 where gno='1'

	update #z_tran01 set rate1 = cast(case when isnull(tranmoney,0)=0 then 0 else round(isnull(oilmoney,0)*100/isnull(tranmoney,0),0) end as nvarchar)
	----------------------------------------------------------------------------------------------
	declare @driver nvarchar(40)
	declare @straddr nvarchar(40)
	declare @total float
	declare @str varchar(max)
	declare @bool bit
	declare @rate1 float
	declare @oilstation nvarchar(20)
	declare @price float
	declare @bmiles float
	declare @emiles float
	declare @oilmoney float
	declare @profit float
	if(patindex('%trans%',@t_filter)>0 or patindex('%oil%',@t_filter)>0)
	begin
		declare cursor_table cursor for
		select trandate,carkindno,carno,isnull(rate1,0),tranmoney,oilmoney,profit from #z_tran01 where gno='1'
		open cursor_table
		fetch next from cursor_table
		into @trandate,@carkindno,@carno,@rate1,@tranmoney,@oilmoney,@profit
		while(@@FETCH_STATUS <> -1)
		begin
			--出車明細
			set @bool = 0
			set @cmd ="if exists(select noa from view_trans"+@t_accy+" where carno=@carno and trandate=@trandate) set @bool = 1 else set @bool = 0"
			execute sp_executesql @cmd,N'@bool bit output,@carno nvarchar(20),@trandate nvarchar(10)',@bool=@bool output,@carno=@carno,@trandate=@trandate			
			if(@bool=1 and patindex('%trans%',@t_filter)>0)
			begin
				insert into #z_tran01(n,gno,trandate,carkindno,carno,rate1,tranmoney,oilmoney,profit,zdriver,zaddr,zmoney,zmiles)
				values(0,'3',@trandate,@carkindno,@carno,@rate1,@tranmoney,@oilmoney,@profit,'司機','起迄地點','收入','里程數')
				set @cmd =
				" declare cursor_table2 cursor for"+
				" select driver,straddr,total,miles from view_trans"+@t_accy+" where carno=@carno and trandate=@trandate"+
				" open cursor_table2"+
				" fetch next from cursor_table2"+
				" into @driver,@straddr,@total,@miles"+
				" while(@@FETCH_STATUS <> -1)"+
				" begin"+
				" 	insert into #z_tran01(n,gno,trandate,carkindno,carno,rate1,tranmoney,oilmoney,profit,zdriver,zaddr,zmoney,zmiles)"+
				"   values(0.1,'7',@trandate,@carkindno,@carno,@rate1,@tranmoney,@oilmoney,@profit,@driver,@straddr"+
				",reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(@total,0)),1)),4,12))"+
				",reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(@miles,0)),1)),4,12)))"+
				" 	fetch next from cursor_table2"+
				" 	into @driver,@straddr,@total,@miles"+
				" end"+
				" close cursor_table2"+
				" deallocate cursor_table2"
				execute sp_executesql @cmd,N'@profit float,@tranmoney float,@oilmoney float,@rate1 float,@carno nvarchar(20),@carkindno nvarchar(20),@trandate nvarchar(10),@driver nvarchar(20),@straddr nvarchar(40),@total float,@miles float,@str varchar(max)'
				,@profit=@profit,@tranmoney=@tranmoney,@oilmoney=@oilmoney,@rate1=@rate1,@carno=@carno,@carkindno=@carkindno,@trandate=@trandate,@driver=@driver,@straddr=@straddr,@total=@total,@miles=@miles,@str=@str
			end
			--加油明細
			set @bool = 0
			if exists(select noa from oil where carno=@carno and datea=@trandate )
				set @bool = 1
			else
				set @bool = 0
			if(@bool=1 and patindex('%oil%',@t_filter)>0)
			begin	
				insert into #z_tran01(n,gno,trandate,carkindno,carno,memo,rate1,tranmoney,oilmoney,profit
				,ystation,yprice,ymount,ymoney,ymiles,ybmiles,yemiles)
				values(0.2,'4',@trandate,@carkindno,@carno,@str,@rate1,@tranmoney,@oilmoney,@profit
				,'站名','單價','公升','金額','里程數','上次里程數','本次里程數')

				declare cursor_table2 cursor for
				select oilstation,price,mount,[money],bmiles,emiles,miles from oil where carno=@carno and datea=@trandate order by datea,timea
				open cursor_table2
				fetch next from cursor_table2
				into @oilstation,@price,@mount,@money,@bmiles,@emiles,@miles
				while(@@FETCH_STATUS <> -1)
				begin
					insert into #z_tran01(n,gno,trandate,carkindno,carno,rate1,tranmoney,oilmoney,profit
					,ystation,yprice,ymount,ymoney,ymiles,ybmiles,yemiles)
					values(0.21,'8',@trandate,@carkindno,@carno,@rate1,@tranmoney,@oilmoney,@profit
					,@oilstation
					,convert(nvarchar,CONVERT(money,isnull(@price,0)),1)
					,convert(nvarchar,CONVERT(money,isnull(@mount,0)),1)
					,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(@money,0)),1)),4,12))
					,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(@miles,0)),1)),4,12))
					,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(@bmiles,0)),1)),4,12))
					,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(@emiles,0)),1)),4,12)))
					fetch next from cursor_table2
					into @oilstation,@price,@mount,@money,@bmiles,@emiles,@miles
				end
				close cursor_table2
				deallocate cursor_table2
			end

			fetch next from cursor_table
			into @trandate,@carkindno,@carno,@rate1,@tranmoney,@oilmoney,@profit
		end
		close cursor_table
		deallocate cursor_table
	end
	----------------------------------------------------------------------------------------------
	update #z_tran01 set gno='5' where gno='1' and profit<0
	select @cmd = ''
	select @cmd = cast(COUNT(1) as nvarchar)+'車次' from #z_tran01 where gno='1' or gno='5'
	if @t_sort01 = 'trandate'
	begin
		insert into #z_tran01(n,gno,trandate,miles,tranmoney,drivermoney,oilmount,oilmoney,tolls,ticket,reserve,profit,rate1)
		select -1,'6',LEFT(trandate,6)+'小計'
		,SUM(ISNULL(miles,0)),SUM(ISNULL(tranmoney,0)),SUM(ISNULL(drivermoney,0))
		,SUM(ISNULL(oilmount,0)),SUM(ISNULL(oilmoney,0)),SUM(ISNULL(tolls,0))
		,SUM(ISNULL(ticket,0)),SUM(ISNULL(reserve,0)),SUM(ISNULL(profit,0))
		,case when sum(isnull(tranmoney,0))!=0 then round(sum(ISNULL(oilmoney,0))/sum(isnull(tranmoney,0))*100,0) else 0 end
		from #z_tran01
		where (gno='1' or gno='5')
		group by LEFT(trandate,6)
		
		select a.*,trandate dd,c.kind 類別,b.caryear 年份,b.cylinder 汽缸
		,case when a.oilmount=0 then null else cast(a.miles/a.oilmount as decimal(10,3)) end kml
		,cast(a.rate1 as nvarchar)+'%' 耗油比
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(miles,0)),1)),4,12)) 公里數
		,cast(case when isnull(oilmount,0)=0 then 0 else round(isnull(miles,0)/isnull(oilmount,0),2) end as nvarchar) 公里升
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tranmoney,0)),1)),4,12)) 收入
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(drivermoney,0)),1)),4,12)) 薪資
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) 油費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12))油量
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) 通行費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) 罰款
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.reserve,0)),1)),4,12)) 寄櫃費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.profit,0)),1)),4,12)) 淨利
		,isnull(a.memo,'')+case when len(ISNULL(a.memo,''))>0 then CHAR(59) else '' end +isnull(e.memo,'') mmm
		,@cmd times
		,zaddr xxaddr
		from #z_tran01 a
		left join car2 b on a.carno=b.carno
		left join carKind c on b.carkindno=c.noa
		left join driver d on a.driverno=d.noa
		left join carpresents e on a.carno=e.carno and a.trandate=e.datea
		order  by  a.trandate,a.carkindno,b.caryear,a.carno,n
	end
	if @t_sort01 = 'rate1'
	begin
		select a.*,trandate dd,c.kind 類別,b.caryear 年份,b.cylinder 汽缸
		,case when a.oilmount=0 then null else cast(a.miles/a.oilmount as decimal(10,3)) end kml
		,cast(a.rate1 as nvarchar)+'%' 耗油比
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(miles,0)),1)),4,12)) 公里數
		,cast(case when isnull(oilmount,0)=0 then 0 else round(isnull(miles,0)/isnull(oilmount,0),2) end as nvarchar) 公里升
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tranmoney,0)),1)),4,12)) 收入
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(drivermoney,0)),1)),4,12)) 薪資
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) 油費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12))油量
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) 通行費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) 罰款
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.reserve,0)),1)),4,12)) 寄櫃費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.profit,0)),1)),4,12)) 淨利
		,isnull(a.memo,'')+case when len(ISNULL(a.memo,''))>0 then CHAR(59) else '' end +isnull(e.memo,'') mmm
		,@cmd times
		,case when gno='2' then -999 when a.rate1=0 and a.oilmoney!=0 then (9999) else a.rate1 end sort01
		,zaddr xxaddr
		from #z_tran01 a
		left join car2 b on a.carno=b.carno
		left join carKind c on b.carkindno=c.noa
		left join driver d on a.driverno=d.noa
		left join carpresents e on a.carno=e.carno and a.trandate=e.datea
		order  by  sort01 desc,a.trandate,a.carkindno,b.caryear,a.carno,n
	end
	if @t_sort01 = 'tranmoney'
	begin
		select a.*,trandate dd,c.kind 類別,b.caryear 年份,b.cylinder 汽缸
		,case when a.oilmount=0 then null else cast(a.miles/a.oilmount as decimal(10,3)) end kml
		,cast(a.rate1 as nvarchar)+'%' 耗油比
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(miles,0)),1)),4,12)) 公里數
		,cast(case when isnull(oilmount,0)=0 then 0 else round(isnull(miles,0)/isnull(oilmount,0),2) end as nvarchar) 公里升
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tranmoney,0)),1)),4,12)) 收入
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(drivermoney,0)),1)),4,12)) 薪資
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) 油費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12))油量
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) 通行費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) 罰款
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.reserve,0)),1)),4,12)) 寄櫃費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.profit,0)),1)),4,12)) 淨利
		,isnull(a.memo,'')+case when len(ISNULL(a.memo,''))>0 then CHAR(59) else '' end +isnull(e.memo,'') mmm
		,@cmd times		
		,zaddr xxaddr
		from #z_tran01 a
		left join car2 b on a.carno=b.carno
		left join carKind c on b.carkindno=c.noa
		left join driver d on a.driverno=d.noa
		left join carpresents e on a.carno=e.carno and a.trandate=e.datea
		order  by  (case when a.gno='2' then 9 else 1 end),a.tranmoney desc,a.trandate,a.carkindno,b.caryear,a.carno,n
	end
	if @t_sort01 = 'caryear'
	begin
		select a.*,trandate dd,c.kind 類別,b.caryear 年份,b.cylinder 汽缸
		,case when a.oilmount=0 then null else cast(a.miles/a.oilmount as decimal(10,3)) end kml
		,cast(a.rate1 as nvarchar)+'%' 耗油比
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(miles,0)),1)),4,12)) 公里數
		,cast(case when isnull(oilmount,0)=0 then 0 else round(isnull(miles,0)/isnull(oilmount,0),2) end as nvarchar) 公里升
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tranmoney,0)),1)),4,12)) 收入
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(drivermoney,0)),1)),4,12)) 薪資
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) 油費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12))油量
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) 通行費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) 罰款
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.reserve,0)),1)),4,12)) 寄櫃費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.profit,0)),1)),4,12)) 淨利
		,isnull(a.memo,'')+case when len(ISNULL(a.memo,''))>0 then CHAR(59) else '' end +isnull(e.memo,'') mmm
		,@cmd times
		,zaddr xxaddr
		from #z_tran01 a
		left join car2 b on a.carno=b.carno
		left join carKind c on b.carkindno=c.noa
		left join driver d on a.driverno=d.noa
		left join carpresents e on a.carno=e.carno and a.trandate=e.datea
		order  by  (case when a.gno='2' then 9 else 1 end),isnull(b.caryear,'') desc,a.carkindno,a.carno,a.trandate,n
	end
	if @t_sort01 = 'driverno'
	begin
		select a.*,trandate dd,c.kind 類別,b.caryear 年份,b.cylinder 汽缸
		,case when a.oilmount=0 then null else cast(a.miles/a.oilmount as decimal(10,3)) end kml
		,cast(a.rate1 as nvarchar)+'%' 耗油比
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(miles,0)),1)),4,12)) 公里數
		,cast(case when isnull(oilmount,0)=0 then 0 else round(isnull(miles,0)/isnull(oilmount,0),2) end as nvarchar) 公里升
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tranmoney,0)),1)),4,12)) 收入
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(drivermoney,0)),1)),4,12)) 薪資
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) 油費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12))油量
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) 通行費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) 罰款
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.reserve,0)),1)),4,12)) 寄櫃費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.profit,0)),1)),4,12)) 淨利
		,isnull(a.memo,'')+case when len(ISNULL(a.memo,''))>0 then CHAR(59) else '' end +isnull(e.memo,'') mmm
		,@cmd times
		,zaddr xxaddr
		from #z_tran01 a
		left join car2 b on a.carno=b.carno
		left join carKind c on b.carkindno=c.noa
		left join driver d on a.driverno=d.noa
		left join carpresents e on a.carno=e.carno and a.trandate=e.datea
		order  by  (case when a.gno='2' then 9 else 1 end),a.driverno,a.carkindno,a.carno,a.trandate,n
	end
	if @t_sort01 = 'profit'
	begin
		select a.*,trandate dd,c.kind 類別,b.caryear 年份,b.cylinder 汽缸
		,case when a.oilmount=0 then null else cast(a.miles/a.oilmount as decimal(10,3)) end kml
		,cast(a.rate1 as nvarchar)+'%' 耗油比
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(miles,0)),1)),4,12)) 公里數
		,cast(case when isnull(oilmount,0)=0 then 0 else round(isnull(miles,0)/isnull(oilmount,0),2) end as nvarchar) 公里升
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tranmoney,0)),1)),4,12)) 收入
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(drivermoney,0)),1)),4,12)) 薪資
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) 油費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12))油量
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) 通行費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) 罰款
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.reserve,0)),1)),4,12)) 寄櫃費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.profit,0)),1)),4,12)) 淨利
		,isnull(a.memo,'')+case when len(ISNULL(a.memo,''))>0 then CHAR(59) else '' end +isnull(e.memo,'') mmm
		,@cmd times
		,zaddr xxaddr
		from #z_tran01 a
		left join car2 b on a.carno=b.carno
		left join carKind c on b.carkindno=c.noa
		left join driver d on a.driverno=d.noa
		left join carpresents e on a.carno=e.carno and a.trandate=e.datea
		order  by  (case when a.gno='2' then 9 else 1 end),a.profit desc,a.trandate,a.carkindno,b.caryear,a.carno,n
	end
	----------------------------------------------------------------------------------------------
	drop table #carkind
	drop table #listDate
	drop table #z_tran01;

z_tran26:--z_tran26 ref z_tran17
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	declare @t_sort08  nvarchar(max)
	declare @t_field05  nvarchar(max)
	declare @t_sort03  nvarchar(max)
	declare @t_sort14  nvarchar(max)
	declare @t_bsalesno  nvarchar(20)
	declare @t_esalesno  nvarchar(20)
	declare @t_sort06 nvarchar(max)
	declare @t_bsalesno2  nvarchar(20)
	declare @t_esalesno2  nvarchar(20)
	declare @t_sort18  nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	set @t_sort08  = case when '#non'=[27] then '' else [27] end
	set @t_field05  = case when '#non'=[28] then '' else [28] end
	set @t_sort03 = case when '#non'=[29] then '' else [29] end
	set @t_sort14 = case when '#non'=[30] then '' else [30] end
	set @t_bsalesno = case when '#non'=[31] then '' else [31] end
	set @t_esalesno = case when '#non'=[32] then char(255) else [32] end
	set @t_sort06  = case when '#non'=[33] then '' else [33] end
	set @t_bsalesno2 = case when '#non'=[34] then '' else [34] end
	set @t_esalesno2 = case when '#non'=[35] then char(255) else [35] end
	set @t_sort18 = case when '#non'=[36] then '' else [36] end
	---------------------------------------------------------------------------------------------- 
	--解析要計算的種類
	declare @string nvarchar(max)
	declare @n int
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	-------------------------------------------------------------------------------------------------------------
	declare @carno  nvarchar(20)
	declare @driverno  nvarchar(20)
	declare @driver nvarchar(20)
	declare @mon nvarchar(10)
	declare @money float
	declare @tranmoney float
	declare @miles float
	declare @reserve  float
	declare @oilmount float
	declare @oilmoney float
	declare @fixa1 float
	declare @fixa2 float
	declare @tire1 float
	declare @tire2 float
	declare @driverpay float
	declare @tolls float
	declare @ticket float
	declare @carsal float
	declare @tax float
	declare @depreciation  float
	declare @profit  float
	declare @carkindno nvarchar(20)
	declare @carkind nvarchar(20)
	declare @caryear nvarchar(10)
	declare @day  int
	-------------------------------------------------------------------------------------------------------------
	--暫存資料
	IF OBJECT_ID('tempdb..#z_tran26')is not null
	BEGIN
		set @cmd = 'drop table #z_tran26'
		EXECUTE sp_executesql @cmd
	END
	create table #z_tran26(
		gno nvarchar(3),
		carkindno nvarchar(20),
		carkind nvarchar(20),
		carno nvarchar(20),
		caryear nvarchar(10),
		driverno nvarchar(20),
		driver nvarchar(20),
		mon nvarchar(20),
		[day] int,
		tranmoney float,
		miles float,
		oilmount float,
		oilmoney float,
		rate1 float,--油秏
		rate2 float,--公里/升
		fixa1 float,--車輛維修
		fixa2 float,--板台維修
		tire1 float,--車輛輪胎
		tire2 float,--板台輪胎
		driverpay  float,--司機維修自付
		tolls float,--通行費
		reserve float,--寄櫃費
		ticket float,--罰款
		carsal float,--薪資
		tax float,--保牌燃費
		depreciation float,--折舊
		profit float,--淨利
	)
	create index noa on #z_tran26(carno,driverno,mon)
	-------------------------------------------------------------------------------------------------------------------
	--出車單
	declare @tmp1 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		tranmoney  float,
		miles  float,
		reserve  float
	)	
	set @cmd=" select  a.carno,a.driverno,LEFT(a.datea,6)"
	if @t_option1='收金額'
		set @cmd=@cmd+" ,sum(round(ISNULL(a.price,0)*isnull(a.mount,0),0))"
	else
		set @cmd=@cmd+" ,sum(round(ISNULL(a.price2,0)*isnull(a.mount2,0),0))"
	set @cmd=@cmd+",sum(ISNULL(a.miles,0)),sum(ISNULL(a.reserve,0))"+
	" from view_trans"+@t_accy+" a "+ 
	" left  join  calctypes  b  on  b.noa+b.noq=a.calctype"+
	" where len(ISNULL(a.carno,''))>0 and  (b.noa is  not  null) and isnull(b.isoutside,0)=0"+
	" and (a.datea  between  @t_bdate  and  @t_edate)"+
	" group by a.carno,a.driverno,LEFT(a.datea,6)"+
	" order  by a.carno,LEFT(a.datea,6),a.driverno"
	
	insert into @tmp1
	execute sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10)',@t_bdate=@t_bdate,@t_edate=@t_edate
	-------------------------------------------------------------------------------------------------------------------
	--油費
	declare @tmp2 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		oilmount float,
		oilmoney float
	)
	insert into @tmp2
	select  carno,driverno,LEFT(datea,6),SUM(ISNULL(mount,0)),SUM(ISNULL([money],0))  
	from  oil
	where (datea between @t_bdate  and @t_edate)
	group  by  carno,driverno,LEFT(datea,6)
	order  by  carno,LEFT(datea,6),driverno
	-------------------------------------------------------------------------------------------------------------------
	--維修
	declare @tmp3 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		fixa1 float,--車輛維修
		fixa2 float,--板台維修
		tire1 float,--車輛輪胎
		tire2 float,--板台輪胎
		driverpay  float--司機維修自付
	)
	insert into @tmp3
	select  carno,driverno,left(fixadate,6)
	,SUM(case when len(isnull(carplateno,''))=0 then isnull(wmoney-discount,0) else 0  end)
	,SUM(case when len(isnull(carplateno,''))>0 then isnull(wmoney-discount,0) else 0  end)
	,SUM(case when len(isnull(carplateno,''))=0 then isnull(cmoney,0) else 0  end)
	,SUM(case when len(isnull(carplateno,''))>0 then isnull(cmoney,0) else 0  end) 
	,0
	from  fixa
	where (fixadate between @t_bdate and @t_edate)
	group  by carno,driverno,left(fixadate,6)
	order by carno,left(fixadate,6),driverno
	
	declare cursor_table cursor for
	select carno,driverno,left(outdate,6)
	,sum(case when len(isnull(carplateno,''))=0  then isnull([money],0) else 0  end)
	,sum(case when len(isnull(carplateno,''))>0  then isnull([money],0) else 0  end)
	from fixout
	where (outdate between @t_bdate and @t_edate)
	group  by carno,driverno,left(outdate,6)
	order by carno,left(outdate,6),driverno
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@tire1,@tire2
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select  *  from @tmp3 where carno=@carno and driverno=@driverno and mon=@mon)
			insert into @tmp3(carno,driverno,mon,tire1,tire2)values(@carno,@driverno,@mon,@tire1,@tire2)
		else
			update @tmp3 set tire1=isnull(tire1,0)+@tire1,tire2=isnull(tire2,0)+@tire2  where carno=@carno and driverno=@driverno and mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@tire1,@tire2
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,sum(isnull([money],0))
	from carborr
	where (mon between left(@t_bdate,6)  and left(@t_edate,6)) and  typea='維修'
	group  by carno,driverno,mon
	order by carno,mon,driverno
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@money
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select  *  from @tmp3 where carno=@carno and driverno=@driverno and mon=@mon)
			insert into @tmp3(carno,driverno,mon,driverpay)values(@carno,@driverno,@mon,@money)
		else
			update @tmp3 set driverpay=@money  where carno=@carno and driverno=@driverno and mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@money
	end
	close cursor_table
	deallocate cursor_table
	-------------------------------------------------------------------------------------------------------------------
	--ETC
	declare @tmp4 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		tolls float
	)
	insert into @tmp4
	select carno,driverno,LEFT(datea,6),SUM(ISNULL([money],0))
	from etc
	where typea='ETC' and (datea between @t_bdate and @t_edate)
	group by carno,driverno,LEFT(datea,6)
	order by carno,LEFT(datea,6),driverno
	-------------------------------------------------------------------------------------------------------------------
	--罰款
	declare @tmp5 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		ticket float
	)
	insert into @tmp5
	select carno,driverno,mon,SUM(ISNULL(comppay,0)) 
	from carborr
	where typea='罰單' and  (mon between  left(@t_bdate,6) and LEFT(@t_edate,6))
	group  by  carno,driverno,mon
	order  by  carno,mon,driverno
	-------------------------------------------------------------------------------------------------------------------
	--薪資
	declare @tmp6 table(
		driverno  nvarchar(20),
		mon  nvarchar(10),
		carsal float
	)
	insert into @tmp6
	select driverno,noa,[money]
	from carsals
	where (noa between LEFT(@t_bdate,6) and LEFT(@t_edate,6))
	-------------------------------------------------------------------------------------------------------------------
	--保牌燃費,折舊 
	declare @tmp7 table(
		carno nvarchar(20),
		mon nvarchar(10),
		tax float,
		depreciation float
	)
	insert into @tmp7
	select  b.carno,a.mon,a.tax,a.depreciation
	from carts a  
	left join cart b on a.noa=b.noa
	where (len(ISNULL(b.carno,''))>0) and (a.mon between left(@t_bdate,6) and left(@t_edate,6))
	-------------------------------------------------------------------------------------------------------------------
	-------------------------------------------------------------------------------------------------------------------	
	declare cursor_table cursor for
	select carno,driverno,mon,tranmoney,miles,reserve from @tmp1
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@tranmoney,@miles,@reserve
	while(@@FETCH_STATUS <> -1)
	begin
		insert into #z_tran26 (carno,driverno,mon,tranmoney,miles,reserve)values(@carno,@driverno,@mon,@tranmoney,@miles,@reserve)
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@tranmoney,@miles,@reserve
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,oilmount,oilmoney from @tmp2
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@oilmount,@oilmoney
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select *  from  #z_tran26 where carno=@carno  and  driverno=@driverno and  mon=@mon)
			insert into #z_tran26 (carno,driverno,mon,oilmount,oilmoney)values(@carno,@driverno,@mon,@oilmount,@oilmoney)
		else
			update #z_tran26 set oilmount=@oilmount,oilmoney=@oilmoney where carno=@carno  and  driverno=@driverno and  mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@oilmount,@oilmoney
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,fixa1,fixa2,tire1,tire2,driverpay from @tmp3
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@fixa1,@fixa2,@tire1,@tire2,@driverpay
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select *  from  #z_tran26 where carno=@carno  and  driverno=@driverno and  mon=@mon)
			insert into #z_tran26 (carno,driverno,mon,fixa1,fixa2,tire1,tire2,driverpay)values(@carno,@driverno,@mon,@fixa1,@fixa2,@tire1,@tire2,@driverpay)
		else
			update #z_tran26 set fixa1=isnull(fixa1,0)+@fixa1,fixa2=isnull(fixa2,0)+@fixa2
			,tire1=isnull(tire1,0)+@tire1,tire2=isnull(tire2,0)+@tire2,driverpay=isnull(driverpay,0)+@driverpay 
			where carno=@carno  and  driverno=@driverno and  mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@fixa1,@fixa2,@tire1,@tire2,@driverpay
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,tolls from @tmp4
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@tolls
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select *  from  #z_tran26 where carno=@carno  and  driverno=@driverno and  mon=@mon)
			insert into #z_tran26 (carno,driverno,mon,tolls)values(@carno,@driverno,@mon,@tolls)
		else
			update #z_tran26 set tolls=isnull(tolls,0)+@tolls where carno=@carno  and  driverno=@driverno and  mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@tolls
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,ticket from @tmp5
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@ticket
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select *  from  #z_tran26 where carno=@carno  and  driverno=@driverno and  mon=@mon)
			insert into #z_tran26 (carno,driverno,mon,ticket)values(@carno,@driverno,@mon,@ticket)
		else
			update #z_tran26 set ticket=@ticket where carno=@carno  and  driverno=@driverno and  mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@ticket
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select driverno,mon,carsal from @tmp6
	open cursor_table
	fetch next from cursor_table
	into @driverno,@mon,@carsal
	while(@@FETCH_STATUS <> -1)
	begin
		select @carno=''
		select top(1) @carno=carno from #z_tran26 where driverno=@driverno and mon=@mon order by tranmoney desc
		if LEN(@carno)>0
		begin
			update #z_tran26 set carsal=@carsal where carno=@carno  and  driverno=@driverno and  mon=@mon
		end
		fetch next from cursor_table
		into @driverno,@mon,@carsal
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,mon,tax,depreciation from @tmp7
	open cursor_table
	fetch next from cursor_table
	into @carno,@mon,@tax,@depreciation
	while(@@FETCH_STATUS <> -1)
	begin
		select @driverno=''
		select top(1) @driverno=driverno from #z_tran26 where carno=@carno and mon=@mon order by tranmoney desc
		if LEN(@driverno)>0
		begin
			update #z_tran26 set tax=@tax,depreciation=@depreciation where carno=@carno  and  driverno=@driverno and  mon=@mon
		end
		fetch next from cursor_table
		into @carno,@mon,@tax,@depreciation
	end
	close cursor_table
	deallocate cursor_table
	------------------------------------------------------------------------------------------------------------------------
	declare cursor_table cursor for
	select carno from #z_tran26 group  by  carno
	open cursor_table
	fetch next from cursor_table
	into @carno
	while(@@FETCH_STATUS <> -1)
	begin
		select @carkindno='',@carKind='',@caryear=''
		select @carkindno=a.carkindno,@carKind=b.kind,@caryear=a.caryear 
		from car2 a left join carkind b on  a.carkindno=b.noa
		where carno=@carno
		update #z_tran26 set carkindno=@carkindno,carkind=@carkind,caryear=@caryear where carno=@carno
		
		fetch next from cursor_table
		into @carno
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select driverno from #z_tran26 group by driverno
	open cursor_table
	fetch next from cursor_table
	into @driverno
	while(@@FETCH_STATUS <> -1)
	begin
		select @driver=''
		select @driver=namea from driver where noa=@driverno
		update #z_tran26 set driver=@driver where driverno=@driverno
		
		fetch next from cursor_table
		into @driverno
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon from #z_tran26 group by carno,driverno,mon
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon
	while(@@FETCH_STATUS <> -1)
	begin
		select @day=0
		set @cmd="select @day=count(1) from (SELECT DISTINCT datea from view_trans"+@t_accy+" where carno=@carno and driverno=@driverno and LEFT(datea,6)=@mon)as a"
		execute sp_executesql @cmd,N'@carno  nvarchar(20),@driverno  nvarchar(20),@mon nvarchar(10),@day  int  output'
		,@carno=@carno,@driverno=@driverno,@mon=@mon,@day=@day  output
		
		update #z_tran26  set  [day]=@day where carno=@carno and driverno=@driverno and mon=@mon  
		fetch next from cursor_table
		into @carno,@driverno,@mon
	end
	close cursor_table
	deallocate cursor_table
	-------------------------------------------------------------------------------------------------------------------------------
	declare cursor_table cursor for
	select carkindno from #z_tran26 group by carkindno
	open cursor_table
	fetch next from cursor_table
	into @carkindno
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select * from #carkind where noa=@carkindno)
			delete #z_tran26 where carkindno=@carkindno
		fetch next from cursor_table
		into @carkindno
	end
	close cursor_table
	deallocate cursor_table
	
	if LEN(@t_carno)>0
		delete #z_tran26 where carno!=@t_carno
	delete #z_tran26 where not(driverno between @t_bdriverno and @t_edriverno)
	update #z_tran26 set gno='0' 
	-------------------------------------------------------------------	
	insert into #z_tran26
	select '1',carkindno,carKind,CHAR(255),'','','',mon,'',SUM(ISNULL(tranmoney,0)),SUM(ISNULL(miles,0)),SUM(ISNULL(oilmount,0)),SUM(ISNULL(oilmoney,0))
	,0,0,SUM(ISNULL(fixa1,0)),SUM(ISNULL(fixa2,0)),SUM(ISNULL(tire1,0)),SUM(ISNULL(tire2,0)),SUM(ISNULL(driverpay,0))
	,SUM(ISNULL(tolls,0)),SUM(ISNULL(reserve,0)),SUM(ISNULL(ticket,0)),SUM(ISNULL(carsal,0)),SUM(ISNULL(tax,0)),SUM(ISNULL(depreciation,0)),0
	from #z_tran26 where gno='0'group by carkindno,carkind,mon
	
	delete #z_tran26 where gno='0'
	update #z_tran26 set gno='0' where gno='1'
	
	insert into #z_tran26
	select '1',carkindno,carKind,CHAR(255),'','','','','',SUM(ISNULL(tranmoney,0)),SUM(ISNULL(miles,0)),SUM(ISNULL(oilmount,0)),SUM(ISNULL(oilmoney,0))
	,0,0,SUM(ISNULL(fixa1,0)),SUM(ISNULL(fixa2,0)),SUM(ISNULL(tire1,0)),SUM(ISNULL(tire2,0)),SUM(ISNULL(driverpay,0))
	,SUM(ISNULL(tolls,0)),SUM(ISNULL(reserve,0)),SUM(ISNULL(ticket,0)),SUM(ISNULL(carsal,0)),SUM(ISNULL(tax,0)),SUM(ISNULL(depreciation,0)),0
	from #z_tran26 where gno='0' group by carkindno,carkind
	
	update #z_tran26  set rate1= case when isnull(tranmoney,0)=0  then 0 else round(ISNULL(oilmoney,0)/tranmoney*100,0) end
	,rate2= case when isnull(oilmount,0)=0  then 0 else round(ISNULL(miles,0)/oilmount,3) end
	,profit=ISNULL(tranmoney,0)-ISNULL(oilmoney,0)-ISNULL(fixa1,0)-ISNULL(fixa2,0)-isnull(tire1,0)-ISNULL(tire2,0)+ISNULL(driverpay,0)
	-ISNULL(tolls,0)-ISNULL(reserve,0)-ISNULL(ticket,0)-ISNULL(carsal,0)-ISNULL(tax,0)-ISNULL(depreciation,0)
	---------------------------------------------------------------------------------------------------------------------
	select * 
	,caryear m01
	,cast(rate1 as nvarchar)+'%' m02
	,[day] m03
	,cast(rate2 as decimal(10,3)) m04
	,carno m05
	,driver m06
	,mon m07
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tranmoney,0)),1)),4,12)) m08
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12)) m09
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) m10
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(fixa1,0)),1)),4,12)) m11
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(fixa2,0)),1)),4,12)) m12
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tire1,0)),1)),4,12)) m13
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tire2,0)),1)),4,12)) m14
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(driverpay,0)),1)),4,12))  m15
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) m16
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) m17
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(reserve,0)),1)),4,12)) m18
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(carsal,0)),1)),4,12)) m19
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tax,0)),1)),4,12)) m20
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(depreciation,0)),1)),4,12)) m21
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(profit,0)),1)),4,12)) m22
	from #z_tran26 order  by  carkindno,gno,mon;
	

z_tran25:
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	declare @t_sort08  nvarchar(max)
	declare @t_field05  nvarchar(max)
	declare @t_sort03  nvarchar(max)
	declare @t_sort14  nvarchar(max)
	declare @t_bsalesno  nvarchar(20)
	declare @t_esalesno  nvarchar(20)
	declare @t_sort06 nvarchar(max)
	declare @t_bsalesno2  nvarchar(20)
	declare @t_esalesno2  nvarchar(20)
	declare @t_sort18  nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	set @t_sort08  = case when '#non'=[27] then '' else [27] end
	set @t_field05  = case when '#non'=[28] then '' else [28] end
	set @t_sort03 = case when '#non'=[29] then '' else [29] end
	set @t_sort14 = case when '#non'=[30] then '' else [30] end
	set @t_bsalesno = case when '#non'=[31] then '' else [31] end
	set @t_esalesno = case when '#non'=[32] then char(255) else [32] end
	set @t_sort06  = case when '#non'=[33] then '' else [33] end
	set @t_bsalesno2 = case when '#non'=[34] then '' else [34] end
	set @t_esalesno2 = case when '#non'=[35] then char(255) else [35] end
	set @t_sort18 = case when '#non'=[36] then '' else [36] end
	---------------------------------------------------------------------------------------------- 
	--解析要計算的種類
	declare @string nvarchar(max)
	declare @n int
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	-------------------------------------------------------------------------------------------------------------
	declare @carno  nvarchar(20)
	declare @driverno  nvarchar(20)
	declare @driver nvarchar(20)
	declare @mon nvarchar(10)
	declare @money float
	declare @tranmoney float
	declare @miles float
	declare @reserve  float
	declare @oilmount float
	declare @oilmoney float
	declare @fixa1 float
	declare @fixa2 float
	declare @tire1 float
	declare @tire2 float
	declare @driverpay float
	declare @tolls float
	declare @ticket float
	declare @carsal float
	declare @tax float
	declare @depreciation  float
	declare @profit  float
	declare @carkindno nvarchar(20)
	declare @carkind nvarchar(20)
	declare @caryear nvarchar(10)
	declare @day  int
	-------------------------------------------------------------------------------------------------------------
	--暫存資料
	IF OBJECT_ID('tempdb..#z_tran25')is not null
	BEGIN
		set @cmd = 'drop table #z_tran25'
		EXECUTE sp_executesql @cmd
	END
	create table #z_tran25(
		gno nvarchar(3),
		carkindno nvarchar(20),
		carkind nvarchar(20),
		carno nvarchar(20),
		caryear nvarchar(10),
		driverno nvarchar(20),
		driver nvarchar(20),
		mon nvarchar(20),
		[day] int,
		tranmoney float,
		miles float,
		oilmount float,
		oilmoney float,
		rate1 float,--油秏
		rate2 float,--公里/升
		fixa1 float,--車輛維修
		fixa2 float,--板台維修
		tire1 float,--車輛輪胎
		tire2 float,--板台輪胎
		driverpay  float,--司機維修自付
		tolls float,--通行費
		reserve float,--寄櫃費
		ticket float,--罰款
		carsal float,--薪資
		tax float,--保牌燃費
		depreciation float,--折舊
		profit float,--淨利
	)
	create index noa on #z_tran25(carno,driverno,mon)
	-------------------------------------------------------------------------------------------------------------------
	--出車單
	declare @tmp1 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		tranmoney  float,
		miles  float,
		reserve  float
	)	
	set @cmd=" select  a.carno,a.driverno,LEFT(a.datea,6)"
	if @t_option1='收金額'
		set @cmd=@cmd+" ,sum(round(ISNULL(a.price,0)*isnull(a.mount,0),0))"
	else
		set @cmd=@cmd+" ,sum(round(ISNULL(a.price2,0)*isnull(a.mount2,0),0))"
	set @cmd=@cmd+",sum(ISNULL(a.miles,0)),sum(ISNULL(a.reserve,0))"+
	" from view_trans"+@t_accy+" a "+ 
	" left  join  calctypes  b  on  b.noa+b.noq=a.calctype"+
	" where len(ISNULL(a.carno,''))>0 and  (b.noa is  not  null) and isnull(b.isoutside,0)=0"+
	" and (a.datea  between  @t_bdate  and  @t_edate)"+
	" group by a.carno,a.driverno,LEFT(a.datea,6)"+
	" order  by a.carno,LEFT(a.datea,6),a.driverno"
	
	insert into @tmp1
	execute sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10)',@t_bdate=@t_bdate,@t_edate=@t_edate
	-------------------------------------------------------------------------------------------------------------------
	--油費
	declare @tmp2 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		oilmount float,
		oilmoney float
	)
	insert into @tmp2
	select  carno,driverno,LEFT(datea,6),SUM(ISNULL(mount,0)),SUM(ISNULL([money],0))  
	from  oil
	where (datea between @t_bdate  and @t_edate)
	group  by  carno,driverno,LEFT(datea,6)
	order  by  carno,LEFT(datea,6),driverno
	-------------------------------------------------------------------------------------------------------------------
	--維修
	declare @tmp3 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		fixa1 float,--車輛維修
		fixa2 float,--板台維修
		tire1 float,--車輛輪胎
		tire2 float,--板台輪胎
		driverpay  float--司機維修自付
	)
	insert into @tmp3
	select  carno,driverno,left(datea,6)
	,SUM(case when len(isnull(carplateno,''))=0 then isnull(wmoney-discount,0) else 0  end)
	,SUM(case when len(isnull(carplateno,''))>0 then isnull(wmoney-discount,0) else 0  end)
	,SUM(case when len(isnull(carplateno,''))=0 then isnull(cmoney,0) else 0  end)
	,SUM(case when len(isnull(carplateno,''))>0 then isnull(cmoney,0) else 0  end) 
	,0
	from  fixa
	where datea between @t_bdate and @t_edate
	group  by carno,driverno,left(datea,6)
	order by carno,left(datea,6),driverno
	
	declare cursor_table cursor for
	select carno,driverno,left(datea,6)
	,sum(case when len(isnull(carplateno,''))=0  then isnull([money],0) else 0  end)
	,sum(case when len(isnull(carplateno,''))>0  then isnull([money],0) else 0  end)
	from fixout
	where (left(datea,6) between left(@t_bdate,6)  and left(@t_edate,6)) 
	group  by carno,driverno,left(datea,6)
	order by carno,left(datea,6),driverno
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@tire1,@tire2
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select  *  from @tmp3 where carno=@carno and driverno=@driverno and mon=@mon)
			insert into @tmp3(carno,driverno,mon,tire1,tire2)values(@carno,@driverno,@mon,@tire1,@tire2)
		else
			update @tmp3 set tire1=isnull(tire1,0)+@tire1,tire2=isnull(tire2,0)+@tire2  where carno=@carno and driverno=@driverno and mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@tire1,@tire2
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,sum(isnull([money],0))
	from carborr
	where (mon between left(@t_bdate,6)  and left(@t_edate,6)) and  typea='維修'
	group  by carno,driverno,mon
	order by carno,mon,driverno
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@money
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select  *  from @tmp3 where carno=@carno and driverno=@driverno and mon=@mon)
			insert into @tmp3(carno,driverno,mon,driverpay)values(@carno,@driverno,@mon,@money)
		else
			update @tmp3 set driverpay=@money  where carno=@carno and driverno=@driverno and mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@money
	end
	close cursor_table
	deallocate cursor_table
	-------------------------------------------------------------------------------------------------------------------
	--ETC
	declare @tmp4 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		tolls float
	)
	insert into @tmp4
	select carno,driverno,LEFT(datea,6),SUM(ISNULL([money],0))
	from etc
	where typea='ETC' and (datea between @t_bdate and @t_edate)
	group by carno,driverno,LEFT(datea,6)
	order by carno,LEFT(datea,6),driverno
	-------------------------------------------------------------------------------------------------------------------
	--罰款
	declare @tmp5 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		ticket float
	)
	insert into @tmp5
	select carno,driverno,mon,SUM(ISNULL(comppay,0)) 
	from carborr
	where typea='罰單' and  (mon between  left(@t_bdate,6) and LEFT(@t_edate,6))
	group  by  carno,driverno,mon
	order  by  carno,mon,driverno
	-------------------------------------------------------------------------------------------------------------------
	--薪資
	declare @tmp6 table(
		driverno  nvarchar(20),
		mon  nvarchar(10),
		carsal float
	)
	insert into @tmp6
	select driverno,noa,[money]
	from carsals
	where (noa between LEFT(@t_bdate,6) and LEFT(@t_edate,6))
	-------------------------------------------------------------------------------------------------------------------
	--保牌燃費,折舊 
	declare @tmp7 table(
		carno nvarchar(20),
		mon nvarchar(10),
		tax float,
		depreciation float
	)
	insert into @tmp7
	select  b.carno,a.mon,a.tax,a.depreciation
	from carts a  
	left join cart b on a.noa=b.noa
	where (len(ISNULL(b.carno,''))>0) and (a.mon between left(@t_bdate,6) and left(@t_edate,6))
	-------------------------------------------------------------------------------------------------------------------
	-------------------------------------------------------------------------------------------------------------------	
	declare cursor_table cursor for
	select carno,driverno,mon,tranmoney,miles,reserve from @tmp1
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@tranmoney,@miles,@reserve
	while(@@FETCH_STATUS <> -1)
	begin
		insert into #z_tran25 (carno,driverno,mon,tranmoney,miles,reserve)values(@carno,@driverno,@mon,@tranmoney,@miles,@reserve)
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@tranmoney,@miles,@reserve
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,oilmount,oilmoney from @tmp2
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@oilmount,@oilmoney
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select *  from  #z_tran25 where carno=@carno  and  driverno=@driverno and  mon=@mon)
			insert into #z_tran25 (carno,driverno,mon,oilmount,oilmoney)values(@carno,@driverno,@mon,@oilmount,@oilmoney)
		else
			update #z_tran25 set oilmount=@oilmount,oilmoney=@oilmoney where carno=@carno  and  driverno=@driverno and  mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@oilmount,@oilmoney
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,fixa1,fixa2,tire1,tire2,driverpay from @tmp3
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@fixa1,@fixa2,@tire1,@tire2,@driverpay
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select *  from  #z_tran25 where carno=@carno  and  driverno=@driverno and  mon=@mon)
			insert into #z_tran25 (carno,driverno,mon,fixa1,fixa2,tire1,tire2,driverpay)values(@carno,@driverno,@mon,@fixa1,@fixa2,@tire1,@tire2,@driverpay)
		else
			update #z_tran25 set fixa1=isnull(fixa1,0)+@fixa1,fixa2=isnull(fixa2,0)+@fixa2
			,tire1=isnull(tire1,0)+@tire1,tire2=isnull(tire2,0)+@tire2,driverpay=isnull(driverpay,0)+@driverpay 
			where carno=@carno  and  driverno=@driverno and  mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@fixa1,@fixa2,@tire1,@tire2,@driverpay
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,tolls from @tmp4
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@tolls
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select *  from  #z_tran25 where carno=@carno  and  driverno=@driverno and  mon=@mon)
			insert into #z_tran25 (carno,driverno,mon,tolls)values(@carno,@driverno,@mon,@tolls)
		else
			update #z_tran25 set tolls=isnull(tolls,0)+@tolls where carno=@carno  and  driverno=@driverno and  mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@tolls
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,ticket from @tmp5
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@ticket
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select *  from  #z_tran25 where carno=@carno  and  driverno=@driverno and  mon=@mon)
			insert into #z_tran25 (carno,driverno,mon,ticket)values(@carno,@driverno,@mon,@ticket)
		else
			update #z_tran25 set ticket=@ticket where carno=@carno  and  driverno=@driverno and  mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@ticket
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select driverno,mon,carsal from @tmp6
	open cursor_table
	fetch next from cursor_table
	into @driverno,@mon,@carsal
	while(@@FETCH_STATUS <> -1)
	begin
		select @carno=''
		select top(1) @carno=carno from #z_tran25 where driverno=@driverno and mon=@mon order by tranmoney desc
		if LEN(@carno)>0
		begin
			update #z_tran25 set carsal=@carsal where carno=@carno  and  driverno=@driverno and  mon=@mon
		end
		fetch next from cursor_table
		into @driverno,@mon,@carsal
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,mon,tax,depreciation from @tmp7
	open cursor_table
	fetch next from cursor_table
	into @carno,@mon,@tax,@depreciation
	while(@@FETCH_STATUS <> -1)
	begin
		select @driverno=''
		select top(1) @driverno=driverno from #z_tran25 where carno=@carno and mon=@mon order by tranmoney desc
		if LEN(@driverno)>0
		begin
			update #z_tran25 set tax=@tax,depreciation=@depreciation where carno=@carno  and  driverno=@driverno and  mon=@mon
		end
		fetch next from cursor_table
		into @carno,@mon,@tax,@depreciation
	end
	close cursor_table
	deallocate cursor_table
	------------------------------------------------------------------------------------------------------------------------
	declare cursor_table cursor for
	select carno from #z_tran25 group  by  carno
	open cursor_table
	fetch next from cursor_table
	into @carno
	while(@@FETCH_STATUS <> -1)
	begin
		select @carkindno='',@carKind='',@caryear=''
		select @carkindno=a.carkindno,@carKind=b.kind,@caryear=a.caryear 
		from car2 a left join carkind b on  a.carkindno=b.noa
		where carno=@carno
		update #z_tran25 set carkindno=@carkindno,carkind=@carkind,caryear=@caryear where carno=@carno
		
		fetch next from cursor_table
		into @carno
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select driverno from #z_tran25 group by driverno
	open cursor_table
	fetch next from cursor_table
	into @driverno
	while(@@FETCH_STATUS <> -1)
	begin
		select @driver=''
		select @driver=namea from driver where noa=@driverno
		update #z_tran25 set driver=@driver where driverno=@driverno
		
		fetch next from cursor_table
		into @driverno
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon from #z_tran25 group by carno,driverno,mon
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon
	while(@@FETCH_STATUS <> -1)
	begin
		select @day=0
		set @cmd="select @day=count(1) from (SELECT DISTINCT datea from view_trans"+@t_accy+" where carno=@carno and driverno=@driverno and LEFT(datea,6)=@mon)as a"
		execute sp_executesql @cmd,N'@carno  nvarchar(20),@driverno  nvarchar(20),@mon nvarchar(10),@day  int  output'
		,@carno=@carno,@driverno=@driverno,@mon=@mon,@day=@day  output
		
		update #z_tran25  set  [day]=@day where carno=@carno and driverno=@driverno and mon=@mon  
		fetch next from cursor_table
		into @carno,@driverno,@mon
	end
	close cursor_table
	deallocate cursor_table
	-------------------------------------------------------------------------------------------------------------------------------
	declare cursor_table cursor for
	select carkindno from #z_tran25 group by carkindno
	open cursor_table
	fetch next from cursor_table
	into @carkindno
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select * from #carkind where noa=@carkindno)
			delete #z_tran25 where carkindno=@carkindno
		fetch next from cursor_table
		into @carkindno
	end
	close cursor_table
	deallocate cursor_table
	
	if LEN(@t_carno)>0
		delete #z_tran25 where carno!=@t_carno
	delete #z_tran25 where not(driverno between @t_bdriverno and @t_edriverno)
	update #z_tran25 set gno='0' 
	-------------------------------------------------------------------
	insert into #z_tran25
	select '2',carkindno,carkind,'','',driverno,driver,'','',SUM(isnull(tranmoney,0)),SUM(isnull(miles,0)),SUM(ISNULL(oilmount,0)),SUM(ISNULL(oilmoney,0))
	,null,null,SUM(ISNULL(fixa1,0)),SUM(ISNULL(fixa2,0)),SUM(ISNULL(tire1,0)),SUM(ISNULL(tire2,0)),SUM(ISNULL(driverpay,0))
	,SUM(ISNULL(tolls,0)),SUM(ISNULL(reserve,0)),SUM(ISNULL(ticket,0)),SUM(ISNULL(carsal,0)),SUM(ISNULL(tax,0)),SUM(ISNULL(depreciation,0)),null
	from #z_tran25 group by carkindno,carkind,driverno,driver
	
	delete #z_tran25 where gno='0'
	update #z_tran25 set gno='0' where gno='2'
	-------------------------------------------------------------------
	
	insert into #z_tran25
	select '1',carkindno,carKind,CHAR(255),'','','','','',SUM(ISNULL(tranmoney,0)),SUM(ISNULL(miles,0)),SUM(ISNULL(oilmount,0)),SUM(ISNULL(oilmoney,0))
	,0,0,SUM(ISNULL(fixa1,0)),SUM(ISNULL(fixa2,0)),SUM(ISNULL(tire1,0)),SUM(ISNULL(tire2,0)),SUM(ISNULL(driverpay,0))
	,SUM(ISNULL(tolls,0)),SUM(ISNULL(reserve,0)),SUM(ISNULL(ticket,0)),SUM(ISNULL(carsal,0)),SUM(ISNULL(tax,0)),SUM(ISNULL(depreciation,0)),0
	from #z_tran25 where gno='0'group by carkindno,carkind
	
	update #z_tran25  set rate1= case when isnull(tranmoney,0)=0  then 0 else round(ISNULL(oilmoney,0)/tranmoney*100,0) end
	,rate2= case when isnull(oilmount,0)=0  then 0 else round(ISNULL(miles,0)/oilmount,3) end
	,profit=ISNULL(tranmoney,0)-ISNULL(oilmoney,0)-ISNULL(fixa1,0)-ISNULL(fixa2,0)-isnull(tire1,0)-ISNULL(tire2,0)+ISNULL(driverpay,0)
	-ISNULL(tolls,0)-ISNULL(reserve,0)-ISNULL(ticket,0)-ISNULL(carsal,0)-ISNULL(tax,0)-ISNULL(depreciation,0)
	---------------------------------------------------------------------------------------------------------------------
	select * 
	,caryear m01
	,cast(rate1 as nvarchar)+'%' m02
	,[day] m03
	,cast(rate2 as decimal(10,3)) m04
	,carno m05
	,driver m06
	,mon m07
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tranmoney,0)),1)),4,12)) m08
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12)) m09
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) m10
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(fixa1,0)),1)),4,12)) m11
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(fixa2,0)),1)),4,12)) m12
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tire1,0)),1)),4,12)) m13
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tire2,0)),1)),4,12)) m14
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(driverpay,0)),1)),4,12))  m15
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) m16
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) m17
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(reserve,0)),1)),4,12)) m18
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(carsal,0)),1)),4,12)) m19
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tax,0)),1)),4,12)) m20
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(depreciation,0)),1)),4,12)) m21
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(profit,0)),1)),4,12)) m22
	from #z_tran25 order  by  carkindno,gno,caryear,driverno;

z_tran24:--z_tran24 ref z_tran17
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	declare @t_sort08  nvarchar(max)
	declare @t_field05  nvarchar(max)
	declare @t_sort03  nvarchar(max)
	declare @t_sort14  nvarchar(max)
	declare @t_bsalesno  nvarchar(20)
	declare @t_esalesno  nvarchar(20)
	declare @t_sort06 nvarchar(max)
	declare @t_bsalesno2  nvarchar(20)
	declare @t_esalesno2  nvarchar(20)
	declare @t_sort18  nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	set @t_sort08  = case when '#non'=[27] then '' else [27] end
	set @t_field05  = case when '#non'=[28] then '' else [28] end
	set @t_sort03 = case when '#non'=[29] then '' else [29] end
	set @t_sort14 = case when '#non'=[30] then '' else [30] end
	set @t_bsalesno = case when '#non'=[31] then '' else [31] end
	set @t_esalesno = case when '#non'=[32] then char(255) else [32] end
	set @t_sort06  = case when '#non'=[33] then '' else [33] end
	set @t_bsalesno2 = case when '#non'=[34] then '' else [34] end
	set @t_esalesno2 = case when '#non'=[35] then char(255) else [35] end
	set @t_sort18 = case when '#non'=[36] then '' else [36] end
	---------------------------------------------------------------------------------------------- 
	--解析要計算的種類
	declare @string nvarchar(max)
	declare @n int
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	-------------------------------------------------------------------------------------------------------------
	declare @carno  nvarchar(20)
	declare @driverno  nvarchar(20)
	declare @driver nvarchar(20)
	declare @mon nvarchar(10)
	declare @money float
	declare @tranmoney float
	declare @miles float
	declare @reserve  float
	declare @oilmount float
	declare @oilmoney float
	declare @fixa1 float
	declare @fixa2 float
	declare @tire1 float
	declare @tire2 float
	declare @driverpay float
	declare @tolls float
	declare @ticket float
	declare @carsal float
	declare @tax float
	declare @depreciation  float
	declare @profit  float
	declare @carkindno nvarchar(20)
	declare @carkind nvarchar(20)
	declare @caryear nvarchar(10)
	declare @day  int
	-------------------------------------------------------------------------------------------------------------
	--暫存資料
	IF OBJECT_ID('tempdb..#z_tran24')is not null
	BEGIN
		set @cmd = 'drop table #z_tran24'
		EXECUTE sp_executesql @cmd
	END
	create table #z_tran24(
		gno nvarchar(3),
		carkindno nvarchar(20),
		carkind nvarchar(20),
		carno nvarchar(20),
		caryear nvarchar(10),
		driverno nvarchar(20),
		driver nvarchar(20),
		mon nvarchar(20),
		[day] int,
		tranmoney float,
		miles float,
		oilmount float,
		oilmoney float,
		rate1 float,--油秏
		rate2 float,--公里/升
		fixa1 float,--車輛維修
		fixa2 float,--板台維修
		tire1 float,--車輛輪胎
		tire2 float,--板台輪胎
		driverpay  float,--司機維修自付
		tolls float,--通行費
		reserve float,--寄櫃費
		ticket float,--罰款
		carsal float,--薪資
		tax float,--保牌燃費
		depreciation float,--折舊
		profit float,--淨利
	)
	create index noa on #z_tran24(carno,driverno,mon)
	-------------------------------------------------------------------------------------------------------------------
	--出車單
	declare @tmp1 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		tranmoney  float,
		miles  float,
		reserve  float
	)	
	set @cmd=" select  a.carno,a.driverno,LEFT(a.datea,6)"
	if @t_option1='收金額'
		set @cmd=@cmd+" ,sum(round(ISNULL(a.price,0)*isnull(a.mount,0),0))"
	else
		set @cmd=@cmd+" ,sum(round(ISNULL(a.price2,0)*isnull(a.mount2,0),0))"
	set @cmd=@cmd+",sum(ISNULL(a.miles,0)),sum(ISNULL(a.reserve,0))"+
	" from view_trans"+@t_accy+" a "+ 
	" left  join  calctypes  b  on  b.noa+b.noq=a.calctype"+
	" where len(ISNULL(a.carno,''))>0 and  (b.noa is  not  null) and isnull(b.isoutside,0)=0"+
	" and (a.datea  between  @t_bdate  and  @t_edate)"+
	" group by a.carno,a.driverno,LEFT(a.datea,6)"+
	" order  by a.carno,LEFT(a.datea,6),a.driverno"
	
	insert into @tmp1
	execute sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10)',@t_bdate=@t_bdate,@t_edate=@t_edate
	-------------------------------------------------------------------------------------------------------------------
	--油費
	declare @tmp2 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		oilmount float,
		oilmoney float
	)
	insert into @tmp2
	select  carno,driverno,LEFT(datea,6),SUM(ISNULL(mount,0)),SUM(ISNULL([money],0))  
	from  oil
	where (datea between @t_bdate  and @t_edate)
	group  by  carno,driverno,LEFT(datea,6)
	order  by  carno,LEFT(datea,6),driverno
	-------------------------------------------------------------------------------------------------------------------
	--維修
	declare @tmp3 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		fixa1 float,--車輛維修
		fixa2 float,--板台維修
		tire1 float,--車輛輪胎
		tire2 float,--板台輪胎
		driverpay  float--司機維修自付
	)
	insert into @tmp3
	select  carno,driverno,mon
	,SUM(case when len(isnull(carplateno,''))=0 then isnull(wmoney-discount,0) else 0  end)
	,SUM(case when len(isnull(carplateno,''))>0 then isnull(wmoney-discount,0) else 0  end)
	,SUM(case when len(isnull(carplateno,''))=0 then isnull(cmoney,0) else 0  end)
	,SUM(case when len(isnull(carplateno,''))>0 then isnull(cmoney,0) else 0  end) 
	,0
	from  fixa
	where (mon between left(@t_bdate,6)  and left(@t_edate,6))
	group  by carno,driverno,mon
	order by carno,mon,driverno
	
	declare cursor_table cursor for
	select carno,driverno,mon
	,sum(case when len(isnull(carplateno,''))=0  then isnull([money],0) else 0  end)
	,sum(case when len(isnull(carplateno,''))>0  then isnull([money],0) else 0  end)
	from fixout
	where (mon between left(@t_bdate,6)  and left(@t_edate,6)) 
	group  by carno,driverno,mon
	order by carno,mon,driverno
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@tire1,@tire2
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select  *  from @tmp3 where carno=@carno and driverno=@driverno and mon=@mon)
			insert into @tmp3(carno,driverno,mon,tire1,tire2)values(@carno,@driverno,@mon,@tire1,@tire2)
		else
			update @tmp3 set tire1=isnull(tire1,0)+@tire1,tire2=isnull(tire2,0)+@tire2  where carno=@carno and driverno=@driverno and mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@tire1,@tire2
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,sum(isnull([money],0))
	from carborr
	where (mon between left(@t_bdate,6)  and left(@t_edate,6)) and  typea='維修'
	group  by carno,driverno,mon
	order by carno,mon,driverno
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@money
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select  *  from @tmp3 where carno=@carno and driverno=@driverno and mon=@mon)
			insert into @tmp3(carno,driverno,mon,driverpay)values(@carno,@driverno,@mon,@money)
		else
			update @tmp3 set driverpay=@money  where carno=@carno and driverno=@driverno and mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@money
	end
	close cursor_table
	deallocate cursor_table
	-------------------------------------------------------------------------------------------------------------------
	--ETC
	declare @tmp4 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		tolls float
	)
	insert into @tmp4
	select carno,driverno,LEFT(datea,6),SUM(ISNULL([money],0))
	from etc
	where typea='ETC' and (datea between @t_bdate and @t_edate)
	group by carno,driverno,LEFT(datea,6)
	order by carno,LEFT(datea,6),driverno
	-------------------------------------------------------------------------------------------------------------------
	--罰款
	declare @tmp5 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		ticket float
	)
	insert into @tmp5
	select carno,driverno,mon,SUM(ISNULL(comppay,0)) 
	from carborr
	where typea='罰單' and  (mon between  left(@t_bdate,6) and LEFT(@t_edate,6))
	group  by  carno,driverno,mon
	order  by  carno,mon,driverno
	-------------------------------------------------------------------------------------------------------------------
	--薪資
	declare @tmp6 table(
		driverno  nvarchar(20),
		mon  nvarchar(10),
		carsal float
	)
	insert into @tmp6
	select driverno,noa,[money]
	from carsals
	where (noa between LEFT(@t_bdate,6) and LEFT(@t_edate,6))
	-------------------------------------------------------------------------------------------------------------------
	--保牌燃費,折舊 
	declare @tmp7 table(
		carno nvarchar(20),
		mon nvarchar(10),
		tax float,
		depreciation float
	)
	insert into @tmp7
	select  b.carno,a.mon,a.tax,a.depreciation
	from carts a  
	left join cart b on a.noa=b.noa
	where (len(ISNULL(b.carno,''))>0) and (a.mon between left(@t_bdate,6) and left(@t_edate,6))
	-------------------------------------------------------------------------------------------------------------------
	-------------------------------------------------------------------------------------------------------------------	
	declare cursor_table cursor for
	select carno,driverno,mon,tranmoney,miles,reserve from @tmp1
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@tranmoney,@miles,@reserve
	while(@@FETCH_STATUS <> -1)
	begin
		insert into #z_tran24 (carno,driverno,mon,tranmoney,miles,reserve)values(@carno,@driverno,@mon,@tranmoney,@miles,@reserve)
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@tranmoney,@miles,@reserve
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,oilmount,oilmoney from @tmp2
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@oilmount,@oilmoney
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select *  from  #z_tran24 where carno=@carno  and  driverno=@driverno and  mon=@mon)
			insert into #z_tran24 (carno,driverno,mon,oilmount,oilmoney)values(@carno,@driverno,@mon,@oilmount,@oilmoney)
		else
			update #z_tran24 set oilmount=@oilmount,oilmoney=@oilmoney where carno=@carno  and  driverno=@driverno and  mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@oilmount,@oilmoney
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,fixa1,fixa2,tire1,tire2,driverpay from @tmp3
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@fixa1,@fixa2,@tire1,@tire2,@driverpay
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select *  from  #z_tran24 where carno=@carno  and  driverno=@driverno and  mon=@mon)
			insert into #z_tran24 (carno,driverno,mon,fixa1,fixa2,tire1,tire2,driverpay)values(@carno,@driverno,@mon,@fixa1,@fixa2,@tire1,@tire2,@driverpay)
		else
			update #z_tran24 set fixa1=isnull(fixa1,0)+@fixa1,fixa2=isnull(fixa2,0)+@fixa2
			,tire1=isnull(tire1,0)+@tire1,tire2=isnull(tire2,0)+@tire2,driverpay=isnull(driverpay,0)+@driverpay 
			where carno=@carno  and  driverno=@driverno and  mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@fixa1,@fixa2,@tire1,@tire2,@driverpay
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,tolls from @tmp4
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@tolls
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select *  from  #z_tran24 where carno=@carno  and  driverno=@driverno and  mon=@mon)
			insert into #z_tran24 (carno,driverno,mon,tolls)values(@carno,@driverno,@mon,@tolls)
		else
			update #z_tran24 set tolls=isnull(tolls,0)+@tolls where carno=@carno  and  driverno=@driverno and  mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@tolls
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,ticket from @tmp5
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@ticket
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select *  from  #z_tran24 where carno=@carno  and  driverno=@driverno and  mon=@mon)
			insert into #z_tran24 (carno,driverno,mon,ticket)values(@carno,@driverno,@mon,@ticket)
		else
			update #z_tran24 set ticket=@ticket where carno=@carno  and  driverno=@driverno and  mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@ticket
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select driverno,mon,carsal from @tmp6
	open cursor_table
	fetch next from cursor_table
	into @driverno,@mon,@carsal
	while(@@FETCH_STATUS <> -1)
	begin
		select @carno=''
		select top(1) @carno=carno from #z_tran24 where driverno=@driverno and mon=@mon order by tranmoney desc
		if LEN(@carno)>0
		begin
			update #z_tran24 set carsal=@carsal where carno=@carno  and  driverno=@driverno and  mon=@mon
		end
		fetch next from cursor_table
		into @driverno,@mon,@carsal
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,mon,tax,depreciation from @tmp7
	open cursor_table
	fetch next from cursor_table
	into @carno,@mon,@tax,@depreciation
	while(@@FETCH_STATUS <> -1)
	begin
		select @driverno=''
		select top(1) @driverno=driverno from #z_tran24 where carno=@carno and mon=@mon order by tranmoney desc
		if LEN(@driverno)>0
		begin
			update #z_tran24 set tax=@tax,depreciation=@depreciation where carno=@carno  and  driverno=@driverno and  mon=@mon
		end
		fetch next from cursor_table
		into @carno,@mon,@tax,@depreciation
	end
	close cursor_table
	deallocate cursor_table
	------------------------------------------------------------------------------------------------------------------------
	declare cursor_table cursor for
	select carno from #z_tran24 group  by  carno
	open cursor_table
	fetch next from cursor_table
	into @carno
	while(@@FETCH_STATUS <> -1)
	begin
		select @carkindno='',@carKind='',@caryear=''
		select @carkindno=a.carkindno,@carKind=b.kind,@caryear=a.caryear 
		from car2 a left join carkind b on  a.carkindno=b.noa
		where carno=@carno
		update #z_tran24 set carkindno=@carkindno,carkind=@carkind,caryear=@caryear where carno=@carno
		
		fetch next from cursor_table
		into @carno
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select driverno from #z_tran24 group by driverno
	open cursor_table
	fetch next from cursor_table
	into @driverno
	while(@@FETCH_STATUS <> -1)
	begin
		select @driver=''
		select @driver=namea from driver where noa=@driverno
		update #z_tran24 set driver=@driver where driverno=@driverno
		
		fetch next from cursor_table
		into @driverno
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon from #z_tran24 group by carno,driverno,mon
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon
	while(@@FETCH_STATUS <> -1)
	begin
		select @day=0
		set @cmd="select @day=count(1) from (SELECT DISTINCT datea from view_trans"+@t_accy+" where carno=@carno and driverno=@driverno and LEFT(datea,6)=@mon)as a"
		execute sp_executesql @cmd,N'@carno  nvarchar(20),@driverno  nvarchar(20),@mon nvarchar(10),@day  int  output'
		,@carno=@carno,@driverno=@driverno,@mon=@mon,@day=@day  output
		
		update #z_tran24  set  [day]=@day where carno=@carno and driverno=@driverno and mon=@mon  
		fetch next from cursor_table
		into @carno,@driverno,@mon
	end
	close cursor_table
	deallocate cursor_table
	-------------------------------------------------------------------------------------------------------------------------------
	declare cursor_table cursor for
	select carkindno from #z_tran24 group by carkindno
	open cursor_table
	fetch next from cursor_table
	into @carkindno
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select * from #carkind where noa=@carkindno)
			delete #z_tran24 where carkindno=@carkindno
		fetch next from cursor_table
		into @carkindno
	end
	close cursor_table
	deallocate cursor_table
	
	if LEN(@t_carno)>0
		delete #z_tran24 where carno!=@t_carno
	delete #z_tran24 where not(driverno between @t_bdriverno and @t_edriverno)
	update #z_tran24 set gno='0' 
	-------------------------------------------------------------------
	insert into #z_tran24
	select '2',carkindno,carkind,carno,caryear,'','',mon,'',SUM(isnull(tranmoney,0)),SUM(isnull(miles,0)),SUM(ISNULL(oilmount,0)),SUM(ISNULL(oilmoney,0))
	,null,null,SUM(ISNULL(fixa1,0)),SUM(ISNULL(fixa2,0)),SUM(ISNULL(tire1,0)),SUM(ISNULL(tire2,0)),SUM(ISNULL(driverpay,0))
	,SUM(ISNULL(tolls,0)),SUM(ISNULL(reserve,0)),SUM(ISNULL(ticket,0)),SUM(ISNULL(carsal,0)),SUM(ISNULL(tax,0)),SUM(ISNULL(depreciation,0)),null
	from #z_tran24 group by carkindno,carkind,carno,caryear,mon
	
	delete #z_tran24 where gno='0'
	update #z_tran24 set gno='0' where gno='2'
	-------------------------------------------------------------------
	
	insert into #z_tran24
	select '1',carkindno,carKind,CHAR(255),'','','','','',SUM(ISNULL(tranmoney,0)),SUM(ISNULL(miles,0)),SUM(ISNULL(oilmount,0)),SUM(ISNULL(oilmoney,0))
	,0,0,SUM(ISNULL(fixa1,0)),SUM(ISNULL(fixa2,0)),SUM(ISNULL(tire1,0)),SUM(ISNULL(tire2,0)),SUM(ISNULL(driverpay,0))
	,SUM(ISNULL(tolls,0)),SUM(ISNULL(reserve,0)),SUM(ISNULL(ticket,0)),SUM(ISNULL(carsal,0)),SUM(ISNULL(tax,0)),SUM(ISNULL(depreciation,0)),0
	from #z_tran24 where gno='0'group by carkindno,carkind
	
	update #z_tran24  set rate1= case when isnull(tranmoney,0)=0  then 0 else round(ISNULL(oilmoney,0)/tranmoney*100,0) end
	,rate2= case when isnull(oilmount,0)=0  then 0 else round(ISNULL(miles,0)/oilmount,3) end
	,profit=ISNULL(tranmoney,0)-ISNULL(oilmoney,0)-ISNULL(fixa1,0)-ISNULL(fixa2,0)-isnull(tire1,0)-ISNULL(tire2,0)+ISNULL(driverpay,0)
	-ISNULL(tolls,0)-ISNULL(reserve,0)-ISNULL(ticket,0)-ISNULL(carsal,0)-ISNULL(tax,0)-ISNULL(depreciation,0)
	---------------------------------------------------------------------------------------------------------------------
	select * 
	,caryear m01
	,cast(rate1 as nvarchar)+'%' m02
	,[day] m03
	,cast(rate2 as decimal(10,3)) m04
	,carno m05
	,driver m06
	,mon m07
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tranmoney,0)),1)),4,12)) m08
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12)) m09
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) m10
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(fixa1,0)),1)),4,12)) m11
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(fixa2,0)),1)),4,12)) m12
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tire1,0)),1)),4,12)) m13
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tire2,0)),1)),4,12)) m14
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(driverpay,0)),1)),4,12))  m15
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) m16
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) m17
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(reserve,0)),1)),4,12)) m18
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(carsal,0)),1)),4,12)) m19
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tax,0)),1)),4,12)) m20
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(depreciation,0)),1)),4,12)) m21
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(profit,0)),1)),4,12)) m22
	from #z_tran24 order  by  carkindno,gno,caryear,carno;

z_tran23:--z_tran23 
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	declare @t_sort08  nvarchar(max)
	declare @t_field05  nvarchar(max)
	declare @t_sort03  nvarchar(max)
	declare @t_sort14  nvarchar(max)
	declare @t_bsalesno  nvarchar(20)
	declare @t_esalesno  nvarchar(20)
	declare @t_sort06 nvarchar(max)
	declare @t_bsalesno2  nvarchar(20)
	declare @t_esalesno2  nvarchar(20)
	declare @t_sort18  nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	set @t_sort08  = case when '#non'=[27] then '' else [27] end
	set @t_field05  = case when '#non'=[28] then '' else [28] end
	set @t_sort03 = case when '#non'=[29] then '' else [29] end
	set @t_sort14 = case when '#non'=[30] then '' else [30] end
	set @t_bsalesno = case when '#non'=[31] then '' else [31] end
	set @t_esalesno = case when '#non'=[32] then char(255) else [32] end
	set @t_sort06  = case when '#non'=[33] then '' else [33] end
	set @t_bsalesno2 = case when '#non'=[34] then '' else [34] end
	set @t_esalesno2 = case when '#non'=[35] then char(255) else [35] end
	set @t_sort18 = case when '#non'=[36] then '' else [36] end
	---------------------------------------------------------------------------------------------- 
	declare @minN int
	declare @string nvarchar(max)
	declare @n int
	declare @carno nvarchar(20)
	declare @datea nvarchar(10)
	declare @carkindno  nvarchar(20)
	declare @carkind	nvarchar(20)
	declare @miles float
	declare @tranmoney float
	declare @drivermoney float
	declare @reserve float 
	declare @mount float 
	declare @money float 
	declare @unit nvarchar(20)
	declare @custno nvarchar(20)
	declare @comp  nvarchar(max)
	declare @carteamno nvarchar(20)
	declare @team  nvarchar(20)
	declare @po nvarchar(20)
	declare @trandono nvarchar(20)
	declare @noa nvarchar(20)
	declare @acomp nvarchar(max)
	declare @mount2 float
	declare @mount3 float
	declare @serial nvarchar(20)
	declare @tel nvarchar(20)
	declare @money2 float
	declare @money3 float
	----------------------------------------------------------------------------------------------
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_tran23')is not null
	BEGIN
		set @cmd = 'drop table #z_tran23'
		EXECUTE sp_executesql @cmd
	END
	create table  #z_tran23(
			gno nvarchar(1),
			acomp nvarchar(50),
			
			noa nvarchar(20),
			datea nvarchar(20),
			trandate nvarchar(20),
			po nvarchar(20),
			custno nvarchar(20),
			comp nvarchar(50),
			serial nvarchar(20),
			tel nvarchar(20),
			straddr nvarchar(20),
			product nvarchar(20),
			mount decimal(18,3),
			price decimal(18,3),
			total decimal(18,3),
			carno nvarchar(20),
			caseno nvarchar(20),
			custorde nvarchar(20)
	)
	create index noa on #z_tran23(noa)
	set @cmd = 
		"select '0' gno,(@t_cno+'【請款明細表】'),a.noa,a.datea,a.trandate,a.po,a.custno,isnull(f.comp,''),isnull(f.serial,''),left(isnull(f.tel,''),20)"+
		",a.straddr,a.product,a.mount,a.price,a.total,a.carno,a.caseno,a.custorde"+
		" from  view_trans"+@t_accy+"  a "+
		" left join #carteam  b on a.carteamno=b.noa"+	
		" left join #calctype c on a.calctype=c.noa"+
		" left join carteam  d on a.carteamno=d.noa"+	
		" left join calctypes e on a.calctype=e.noa+e.noq"+
		" left join cust f on f.noa = a.custno "+
		" where "+
		"(isnull(a.datea,'') between @t_bdate and @t_edate) and "+
		"(isnull(a.trandate,'') between @t_btrandate and @t_etrandate) and "+
		"(isnull(a.custno,'') between @t_bcustno and @t_ecustno) and" +
		"(isnull(a.driverno,'') between @t_bdriverno and @t_edriverno) and"+
		"(len(@t_carno) = 0 or a.carno = @t_carno) and"+
		"(len(@t_po)=0 or a.po = @t_po) and"+
		"(a.straddrno between @t_baddr and @t_eaddr) and"+
		" (b.noa  is  not  null) and (c.noa  is  not  null)"
	insert into #z_tran23
	execute sp_executesql @cmd,N'@t_cno  nvarchar(50),@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bcustno nvarchar(20),@t_ecustno nvarchar(20),@t_bdriverno  nvarchar(20),@t_edriverno  nvarchar(20),@t_carno  nvarchar(20),@t_po  nvarchar(20),@t_baddr nvarchar(20),@t_eaddr nvarchar(20),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10)',
		@t_cno=@t_cno,@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_po=@t_po,@t_baddr=@t_baddr,@t_eaddr=@t_eaddr,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate

	declare @tot_mount decimal(18,3)
	declare @tot_total decimal(18,3)
	declare @price decimal(18,3)
	
	declare cursor_table cursor for
	select acomp,po,sum(isnull(mount,0)),price from #z_tran23 group by acomp,po,price
	open cursor_table
	fetch next from cursor_table
	into @acomp,@po,@mount,@price
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select * from #z_tran23 where gno='1' and acomp=@acomp and po=@po)
			insert into #z_tran23(gno,acomp,po,mount,total)values('1',@acomp,@po,@mount,ROUND(@mount*@price,0))
		else
		begin
			select @tot_mount = 0,@tot_total=0
			select @tot_mount=mount,@tot_total=total from #z_tran23 where gno='1' and acomp=@acomp and po=@po
			update #z_tran23 set mount=@tot_mount+@mount,total=@tot_total+ROUND(@mount*@price,0) where gno='1' and acomp=@acomp and po=@po
		end
		fetch next from cursor_table
		into @acomp,@po,@mount,@price
	end
	close cursor_table
	deallocate cursor_table
	
	insert into #z_tran23
	select '2','','','','',po,'','','','','','',0,0,0,'','','' from #z_tran23 group by po
	
	select *
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) ctotal
	from #z_tran23 order by po,gno,trandate,custorde;

z_tran18:--z_tran18   ref z_tran14
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	declare @t_sort08  nvarchar(max)
	declare @t_field05  nvarchar(max)
	declare @t_sort03  nvarchar(max)
	declare @t_sort14  nvarchar(max)
	declare @t_bsalesno  nvarchar(20)
	declare @t_esalesno  nvarchar(20)
	declare @t_sort06 nvarchar(max)
	declare @t_bsalesno2  nvarchar(20)
	declare @t_esalesno2  nvarchar(20)
	declare @t_sort18  nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	set @t_sort08  = case when '#non'=[27] then '' else [27] end
	set @t_field05  = case when '#non'=[28] then '' else [28] end
	set @t_sort03 = case when '#non'=[29] then '' else [29] end
	set @t_sort14 = case when '#non'=[30] then '' else [30] end
	set @t_bsalesno = case when '#non'=[31] then '' else [31] end
	set @t_esalesno = case when '#non'=[32] then char(255) else [32] end
	set @t_sort06  = case when '#non'=[33] then '' else [33] end
	set @t_bsalesno2 = case when '#non'=[34] then '' else [34] end
	set @t_esalesno2 = case when '#non'=[35] then char(255) else [35] end
	set @t_sort18 = case when '#non'=[36] then '' else [36] end
	----------------------------------------------------------------------------------------------
	--解析要計算的種類
	declare @string nvarchar(max)
	declare @n int
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	declare @display table(
		noa nvarchar(20)
	)
	set @string = @t_field05
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into @display select @string
			end
			break
		end
		insert into @display select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	------------------------------------------------------------------------------------------------------------------
	declare  @sortkey  nvarchar(20)
	declare  @title  nvarchar(max)
	declare  @totmount1  float
	declare  @totmount2  float
	declare  @totmount3  float
	declare  @totmoney1  float
	declare  @totmoney2  float
	declare  @totmoney3  float
	declare  @totmoney4  float
	declare  @acomp  nvarchar(30)
	declare @custno nvarchar(20)
	declare @nick nvarchar(20)
	------------------------------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_tran18')is not null
	BEGIN
		set @cmd = 'drop table #z_tran18'
		EXECUTE sp_executesql @cmd
	END
	create table  #z_tran18(
		gno nvarchar(3),
		sortkey nvarchar(20),
		title nvarchar(max),
		acomp nvarchar(30),
		noa nvarchar(20),	
		custno nvarchar(20),
		comp nvarchar(50),
		nick nvarchar(20),
		po nvarchar(20),
		datea nvarchar(20),
		trandate nvarchar(20),
		driverno nvarchar(20),
		driver nvarchar(20),
		straddrno nvarchar(20),
		straddr nvarchar(40),
		productno nvarchar(20),
		product nvarchar(40),
		memo nvarchar(max),
		isoutside int,
		inmount decimal(12, 3),
		pton1 decimal(12, 3),
		mount1 decimal(12, 3),
		price1 decimal(12, 3),
		money1 float,
		outmount decimal(12, 3),
		pton2 decimal(12, 3),
		mount2 decimal(12, 3),
		price2 decimal(12, 3),
		discount decimal(12, 3),
		money2 float,
		totmount1 decimal(12, 3),--客戶
		totmount2 decimal(12, 3),--司機
		totmount3 decimal(12, 3),--外車
		totmoney1 float,--客戶
		totmoney2 float,--司機
		totmoney3 float,--外車
		totmoney4 float,--差額
	)
	
	--客戶
	set @cmd = "select '0',a.custno,('客戶：'+rtrim(a.custno)+space(2)+rtrim(a.comp))"

	set @cmd =	@cmd+
		",@t_cno,a.noa,a.custno,a.comp,a.nick,a.po,a.datea,a.trandate"+
		" ,a.driverno,a.driver,a.straddrno,a.straddr,a.uccno,a.product,a.memo,isnull(e.isoutside,0)"+
		" ,a.inmount,a.pton,a.mount,a.price,a.total"+
		" ,a.outmount,a.pton2,a.mount2,(isnull(a.price2,0)+isnull(a.price3,0)),a.discount,a.total2"+
		" ,0,0,0,0,0,0,0"+
		" from  view_trans"+@t_accy+"  a"+
		" left join #carteam  b on a.carteamno=b.noa"+	
		" left join #calctype c on a.calctype=c.noa"+
		" left join carteam  d on a.carteamno=d.noa"+	
		" left join calctypes e on a.calctype=e.noa+e.noq"+
		" left join cust f on a.custno=f.nick"+
		" where "+
		" (a.datea  between  @t_bdate  and  @t_edate) and "+
		" (a.trandate between  @t_btrandate  and  @t_etrandate) and "+
		" (a.custno  between  @t_bcustno   and  @t_ecustno) and "+
		" (a.driverno  between  @t_bdriverno   and  @t_edriverno) and "+
		" (len(@t_carno)=0  or  a.carno=@t_carno) and "+
		" (len(@t_po)=0  or  a.po=@t_po) and "+
		" (a.straddrno between @t_baddr and @t_eaddr)  and"+
		" (b.noa  is  not  null) and (c.noa  is  not  null)"
	insert into #z_tran18
	execute sp_executesql @cmd,N'@t_cno nvarchar(40),@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10)
	,@t_bcustno nvarchar(20),@t_ecustno nvarchar(20),@t_bdriverno  nvarchar(20),@t_edriverno  nvarchar(20),@t_carno  nvarchar(20),@t_po  nvarchar(20),@t_baddr  nvarchar(20),@t_eaddr  nvarchar(20)',
		@t_cno=@t_cno,@t_bdate=@t_bdate,@t_edate=@t_edate,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate
		,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_po=@t_po,@t_baddr=@t_baddr,@t_eaddr=@t_eaddr
		
	if(patindex('%in%',@t_option3)=0)
	begin
		update #z_tran18 set discount=1,money2=ROUND(mount2*price2,0) where isoutside=0
	end
	if(patindex('%out%',@t_option3)=0)
	begin
		update #z_tran18 set discount=1,money2=ROUND(mount2*price2,0) where isoutside=1
	end
	
	declare cursor_table cursor for
	select sortkey from #z_tran18  group by sortkey order by sortkey
	open cursor_table
	fetch next from cursor_table
	into @sortkey
	while(@@FETCH_STATUS <> -1)
	begin
		select @title='',@acomp='',@totmount1=0,@totmount2=0,@totmount3=0,@totmoney1=0,@totmoney2=0,@totmoney3=0,@totmoney4=0
		select top 1 @title=title,@acomp=acomp,@custno=custno,@nick=nick from #z_tran18 where sortkey=@sortkey
		select @totmount1=SUM(mount1)
			,@totmount2=SUM(case when isoutside=0 then mount2 else 0 end) 
			,@totmount3=SUM(case when isoutside=1 then mount2 else 0 end)  
			,@totmoney1=SUM(money1)
			,@totmoney2=SUM(case when isoutside=0 then money2 else 0 end) 
			,@totmoney3=SUM(case when isoutside=1 then money2 else 0 end)
			,@totmoney4=SUM(money1-money2)
		from  #z_tran18  where  sortkey=@sortkey
		insert into #z_tran18(gno,title,acomp,custno,nick,sortkey,totmount1,totmount2,totmount3,totmoney1,totmoney2,totmoney3,totmoney4)
		values('1',@title,@acomp,@custno,@nick,@sortkey,@totmount1,@totmount2,@totmount3,@totmoney1,@totmoney2,@totmoney3,@totmoney4)
		fetch next from cursor_table
		into @sortkey
	end
	close cursor_table
	deallocate cursor_table
	--************************
	delete #z_tran18 where gno='0'
	update #z_tran18 set gno='0'
	--************************
	if len(@t_bdate)>0
		set  @string  =  '登錄日期：'+@t_bdate+'～'+@t_edate
	else
		set  @string   =  '交運日期：'+@t_btrandate+'～'+@t_etrandate
	
	select @totmount1=SUM(ISNULL(totmount1,0)),@totmount2=SUM(ISNULL(totmount2,0)),@totmount3=SUM(ISNULL(totmount3,0))
	,@totmoney1=SUM(ISNULL(totmoney1,0)),@totmoney2=SUM(ISNULL(totmoney2,0)),@totmoney3=SUM(ISNULL(totmoney3,0)),@totmoney4=SUM(ISNULL(totmoney4,0))
	from #z_tran18
	insert into #z_tran18 (gno,totmount1,totmount2,totmount3,totmoney1,totmoney2,totmoney3,totmoney4)
	values('1',@totmount1,@totmount2,@totmount3,@totmoney1,@totmoney2,@totmoney3,@totmoney4)
	declare @tmp_addr nvarchar(40)
	declare @tmp_addr1 nvarchar(20)
	declare @tmp_addr2 nvarchar(20)
	
	select @tmp_addr1='',@tmp_addr2='',@tmp_addr=''
	select @tmp_addr1=ISNULL(addr,'') from addr where noa=@t_baddr
	select @tmp_addr2=ISNULL(addr,'') from addr where noa=@t_eaddr
	if(LEN(ISNULL(@tmp_addr1,''))>0 and LEN(ISNULL(@tmp_addr2,''))>0)
		if @tmp_addr1=@tmp_addr2
			set @tmp_addr = @tmp_addr1
		else
			set @tmp_addr = @tmp_addr1+'~'+@tmp_addr2
			
	set @cmd = 
	" select @tmp_addr xxxx,@string xtitlea, gno,sortkey,acomp,custno,nick,title,trandate tdate,driver dd,straddr addr,product pp,memo"+ 
	" ,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,(case when mount1<0 then -1 else 1 end)*floor(abs(mount1))),1)),4,12))+RIGHT(cast(mount1 as nvarchar),4) mount1"+ 
	" ,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,(case when price1<0 then -1 else 1 end)*floor(abs(price1))),1)),4,12))+RIGHT(cast(price1 as nvarchar),4) price1"+ 
	" ,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,(case when price2<0 then -1 else 1 end)*floor(abs(price2))),1)),4,12))+RIGHT(cast(price2 as nvarchar),4) price2"+ 
	" ,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,(case when mount2<0 then -1 else 1 end)*floor(abs(mount2))),1)),4,12))+RIGHT(cast(mount2 as nvarchar),4) mount2"+ 
	" ,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,(case when totmount1<0 then -1 else 1 end)*floor(abs(totmount1))),1)),4,12))+RIGHT(cast(totmount1 as nvarchar),4) totmount1"+ 
	" ,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,(case when totmount2<0 then -1 else 1 end)*floor(abs(totmount2))),1)),4,12))+RIGHT(cast(totmount2 as nvarchar),4) totmount2"+ 
	" ,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,(case when totmount3<0 then -1 else 1 end)*floor(abs(totmount3))),1)),4,12))+RIGHT(cast(totmount3 as nvarchar),4) totmount3"+ 
	" ,case when discount=1 then null else discount end disc"+ 
	" ,totmoney1 tt1"+ 
	" ,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money1),1)),4,12)) money1"+ 
	" ,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money2),1)),4,12)) money2"+ 
	" ,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,totmoney1),1)),4,12)) totmoney1"+ 
	" ,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,totmoney2),1)),4,12)) totmoney2"+ 
	" ,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,totmoney3),1)),4,12)) totmoney3"+ 
	" ,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,totmoney4),1)),4,12)) totmoney4"+ 
	" from #z_tran18 order by gno,"+@t_sort18+",noa" 
	execute sp_executesql @cmd,N'@string nvarchar(max),@tmp_addr nvarchar(40)',@string=@string ,@tmp_addr=@tmp_addr
	drop table #z_tran18 ;
	
z_tran22:--z_tran22
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	declare @t_sort08  nvarchar(max)
	declare @t_field05  nvarchar(max)
	declare @t_sort03  nvarchar(max)
	declare @t_sort14  nvarchar(max)
	declare @t_bsalesno  nvarchar(20)
	declare @t_esalesno  nvarchar(20)
	declare @t_sort06 nvarchar(max)
	declare @t_bsalesno2  nvarchar(20)
	declare @t_esalesno2  nvarchar(20)
	declare @t_sort22 nvarchar(20)
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	set @t_sort08  = case when '#non'=[27] then '' else [27] end
	set @t_field05  = case when '#non'=[28] then '' else [28] end
	set @t_sort03 = case when '#non'=[29] then '' else [29] end
	set @t_sort14 = case when '#non'=[30] then '' else [30] end
	set @t_bsalesno = case when '#non'=[31] then '' else [31] end
	set @t_esalesno = case when '#non'=[32] then char(255) else [32] end
	set @t_sort06  = case when '#non'=[33] then '' else [33] end
	set @t_bsalesno2 = case when '#non'=[34] then '' else [34] end
	set @t_esalesno2 = case when '#non'=[35] then char(255) else [35] end
	set @t_sort22 = case when '#non'=[42] then char(255) else [42] end
	------------------------------------------------------------------------------------
	declare @string nvarchar(max)
	declare @n int
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	declare @display table(
		noa nvarchar(20)
	)
	set @string = @t_field05
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into @display select @string
			end
			break
		end
		insert into @display select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	-------------------------------------------------------------------------------------------------------------
	declare @tmp table(
		gno nvarchar(1),
		noa nvarchar(30),
		po nvarchar(20),
		datea nvarchar(10),
		trandate nvarchar(10),
		carno nvarchar(20),
		driverno nvarchar(20),
		driver nvarchar(20),
		nick nvarchar(20),
		straddr nvarchar(40),
		inmount decimal(10,3),
		pton decimal(10,3),
		weight2 decimal(10,3),
		weight3 decimal(10,3)
	  )
	  set @cmd = 
	  " select '0',a.noa,a.po,a.datea,a.trandate,a.carno,a.driverno,a.driver,a.nick,a.straddr,a.inmount,a.pton,a.weight2,a.weight3"+
	  " from view_trans"+@t_accy+" a"+
	  " left join #carteam b on a.carteamno=b.noa"+
	  " where (b.noa is not null)"+
	  " and (a.datea between @t_bdate and @t_edate)"+
	  " and (a.trandate between @t_btrandate and @t_etrandate)"+
	  " and (a.driverno between @t_bdriverno and @t_edriverno)"+
	  " and (len(@t_carno)=0 or @t_carno=a.carno)"+
	  " and (len(@t_po)=0 or @t_po=a.po)"+
	  " order by a.driverno,a.trandate"
	  insert into @tmp
	  execute sp_executesql @cmd,N'@t_po nvarchar(20),@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10),@t_bdriverno nvarchar(20),@t_edriverno nvarchar(20),@t_carno nvarchar(20)'
	  ,@t_po=@t_po,@t_bdate=@t_bdate,@t_edate=@t_edate,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno
	  insert into @tmp
	  select '1','',po,'','','','','','','',SUM(isnull(inmount,0)),SUM(isnull(pton,0)),SUM(isnull(weight2,0)),SUM(isnull(weight3,0)) from @tmp where gno='0' group by po 
	  if @t_sort22 = 'driver'
	  begin
		select * from @tmp 
		order by po,gno,driverno,trandate
	  end 
	  else if @t_sort22 = 'carno'
	  begin
		select * from @tmp 
		order by po,gno,carno,trandate
	  end 
	  else if @t_sort22 = 'weight3'
	  begin
		select * from @tmp 
		order by po,gno,weight3
	  end 
	  else if @t_sort22 = 'noa'
	  begin
		select * from @tmp 
		order by po,gno,noa
	  end;
	  

z_tran21:--z_tran21  客戶有2個業務且金額為奇數時,無條件捨去
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	declare @t_sort08  nvarchar(max)
	declare @t_field05  nvarchar(max)
	declare @t_sort03  nvarchar(max)
	declare @t_sort14  nvarchar(max)
	declare @t_bsalesno  nvarchar(20)
	declare @t_esalesno  nvarchar(20)
	declare @t_sort06 nvarchar(max)
	declare @t_bsalesno2  nvarchar(20)
	declare @t_esalesno2  nvarchar(20)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	set @t_sort08  = case when '#non'=[27] then '' else [27] end
	set @t_field05  = case when '#non'=[28] then '' else [28] end
	set @t_sort03 = case when '#non'=[29] then '' else [29] end
	set @t_sort14 = case when '#non'=[30] then '' else [30] end
	set @t_bsalesno = case when '#non'=[31] then '' else [31] end
	set @t_esalesno = case when '#non'=[32] then char(255) else [32] end
	set @t_sort06  = case when '#non'=[33] then '' else [33] end
	set @t_bsalesno2 = case when '#non'=[34] then '' else [34] end
	set @t_esalesno2 = case when '#non'=[35] then char(255) else [35] end
	------------------------------------------------------------------------------------
	declare @string nvarchar(max)
	declare @n int
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	declare @display table(
		noa nvarchar(20)
	)
	set @string = @t_field05
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into @display select @string
			end
			break
		end
		insert into @display select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	-------------------------------------------------------------------------------------------------------------
	declare @gkey nvarchar(20)
	declare @minN int
	set @minN = 7
	declare @gname  nvarchar(20)
	declare  @salesno  nvarchar(20)
	declare  @unit  nvarchar(20)
	declare  @carteamno  nvarchar(20)
	declare  @mount  float
	declare  @fieldA  nvarchar(20)
	declare  @fieldB  nvarchar(20)
	declare  @fieldC  nvarchar(20)
	declare  @fieldD  nvarchar(20)
	declare  @namea  nvarchar(20)
	declare  @money  float
	declare  @result  nvarchar(max)
	declare  @team  nvarchar(20)
	declare  @mon  nvarchar(10)
	-------------------------------------------------------------------------------------------------------------
	--記錄欄位
	declare @field table(
		noa  nvarchar(20),
		team nvarchar(20),
		unit  nvarchar(20),
		field_mount_header nvarchar(10),
		field_mount nvarchar(10),
		field_money_header nvarchar(10),
		field_money nvarchar(10)
	)
	
	-------------------------------------------------------------------------------------------------------------
	--暫存資料
	IF OBJECT_ID('tempdb..#z_tran21')is not null
	BEGIN
		set @cmd = 'drop table #z_tran21'
		EXECUTE sp_executesql @cmd
	END
	create table #z_tran21(
		gno nvarchar(3),
		salesno nvarchar(20),
		namea nvarchar(20),
		mon nvarchar(10),
		primary key(salesno,mon,gno)
	)
	-------------------------------------------------------------------------------------------------------------
	
	-------------------------------------------------------------------------------------------------------------
	--出車單:客戶金額
	select @n= COUNT(1) from @field

	declare cursor_table cursor for
	select a.noa,a.team,a.unit from carteam a
	left join carteam b on a.noa=b.noa
	left join #carteam c on b.noa=c.noa
	where b.noa=c.noa
	group by a.noa,a.team,a.unit
	open cursor_table
	fetch next from cursor_table
	into @gkey,@gname,@unit
	while(@@FETCH_STATUS <> -1)
	begin
		set @n = @n + 1
		insert into @field(noa,team,unit,field_mount_header,field_mount,field_money_header,field_money)
			values( @gkey,@gname,@unit,
				"a"+right("00"+CONVERT(nvarchar(10),@n),3),
				"b"+right("00"+CONVERT(nvarchar(10),@n),3),
				"c"+right("00"+CONVERT(nvarchar(10),@n),3),
				"d"+right("00"+CONVERT(nvarchar(10),@n),3))
		set @cmd = "alter table #z_tran21 add a"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran21 add b"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran21 add cb"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran21 add c"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran21 add d"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran21 add cd"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		fetch next from cursor_table
		into @gkey,@gname,@unit
	end
	close cursor_table
	deallocate cursor_table
	---------------------------------------------
	--總計
	set @n = @n + 1
	insert into @field(noa,team,unit,field_mount_header,field_mount,field_money_header,field_money)
		values( CHAR(255),'總計',null,
			"a"+right("00"+CONVERT(nvarchar(10),@n),3),
			"b"+right("00"+CONVERT(nvarchar(10),@n),3),
			"c"+right("00"+CONVERT(nvarchar(10),@n),3),
			"d"+right("00"+CONVERT(nvarchar(10),@n),3))
	set @cmd = "alter table #z_tran21 add a"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
	EXECUTE sp_executesql @cmd
	set @cmd = "alter table #z_tran21 add b"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
	EXECUTE sp_executesql @cmd
	set @cmd = "alter table #z_tran21 add cb"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
	EXECUTE sp_executesql @cmd
	set @cmd = "alter table #z_tran21 add c"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
	EXECUTE sp_executesql @cmd
	set @cmd = "alter table #z_tran21 add d"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
	EXECUTE sp_executesql @cmd
	set @cmd = "alter table #z_tran21 add cd"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
	EXECUTE sp_executesql @cmd
	---------------------------------------------
	select @n= COUNT(1) from @field
	while(@n<@minN)
	begin
		set  @n = @n +  1
		insert into @field(noa,team,unit,field_mount_header,field_mount,field_money_header,field_money)
			values( null,null,null,
				"a"+right("00"+CONVERT(nvarchar(10),@n),3),
				"b"+right("00"+CONVERT(nvarchar(10),@n),3),
				"c"+right("00"+CONVERT(nvarchar(10),@n),3),
				"d"+right("00"+CONVERT(nvarchar(10),@n),3))
		set @cmd = "alter table #z_tran21 add a"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran21 add b"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran21 add cb"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran21 add c"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran21 add d"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran21 add cd"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--------------------------------------------------------------------------------------------------------------------
	declare @tmp1 table(
		salesno nvarchar(20),
		mon nvarchar(10),
		carteamno nvarchar(10),
		mount float,
		[money] float
	)

	--salesno  1
	set @cmd =" select isnull(d.salesno,''),left(a.trandate,6),a.carteamno,"
	if  @t_option1='收金額'
		set  @cmd  =  @cmd  +  "sum(case when len(d.salesno2)=0 then a.mount else floor(a.mount*1000/2)/1000 end)"+
			",sum( case when len(d.salesno2)=0 then round(isnull(a.price*a.mount,0),0) else floor(round(isnull(a.price*a.mount,0),0)/2) end) money"
	else
		set  @cmd  =  @cmd  +  "sum(a.mount2),sum(round(isnull((a.price2+a.price3)*a.mount2,0),0)) money"
	set @cmd =	@cmd  +
		" from view_trans"+@t_accy+" a"+
		" left join #calctype b on a.calctype=b.noa"+
		" left join #carteam c on a.carteamno=c.noa"+
		" left join cust d on a.custno=d.noa"+
		" where (b.noa  is  not  null) and (c.noa  is  not  null)"+
		" and (len(@t_carno)=0 or a.carno=@t_carno)"+
		" and (a.datea between @t_bdate and @t_edate)"+
		" and (a.trandate between @t_btrandate and @t_etrandate)"+
		" and (a.straddrno between @t_baddr and @t_eaddr)"+
		" and (a.custno between @t_bcustno and @t_ecustno)"+
		" and (a.driverno between @t_bdriverno and @t_edriverno)"+
		" and (isnull(d.salesno,'') between @t_bsalesno2 and @t_esalesno2)"+
		" and (len(@t_po)=0 or a.po=@t_po)"+
		" group by isnull(d.salesno,''),left(a.trandate,6),a.carteamno"
	insert into @tmp1
	EXECUTE sp_executesql @cmd,N'@t_baddr nvarchar(20),@t_eaddr nvarchar(20),@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10),@t_bdriverno nvarchar(20),@t_edriverno nvarchar(20),@t_carno nvarchar(20),@t_bcustno  nvarchar(20),@t_ecustno  nvarchar(20),@t_po nvarchar(30),@t_bsalesno2 nvarchar(20),@t_esalesno2 nvarchar(20)',		
	@t_baddr=@t_baddr,@t_eaddr=@t_eaddr,@t_bdate=@t_bdate,@t_edate=@t_edate,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate
	,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_po=@t_po,@t_bsalesno2=@t_bsalesno2,@t_esalesno2=@t_esalesno2
	
	--salesno  2
	set @cmd =" select isnull(d.salesno2,''),left(a.trandate,6),a.carteamno,"
	if  @t_option1='收金額'
		set  @cmd  =  @cmd  +  "sum(case when len(d.salesno2)=0 then a.mount else floor(a.mount*1000/2)/1000 end)"+
			",sum( case when len(d.salesno2)=0 then round(isnull(a.price*a.mount,0),0) else floor(round(isnull(a.price*a.mount,0),0)/2) end) money"
	else
		set  @cmd  =  @cmd  +  "sum(a.mount2),sum(round(isnull((a.price2+a.price3)*a.mount2,0),0)) money"
	set @cmd =	@cmd  +
		" from view_trans"+@t_accy+" a"+
		" left join #calctype b on a.calctype=b.noa"+
		" left join #carteam c on a.carteamno=c.noa"+
		" left join cust d on a.custno=d.noa"+
		" where (b.noa  is  not  null) and (c.noa  is  not  null)"+
		" and len(isnull(d.salesno2,''))>0"+
		" and (len(@t_carno)=0 or a.carno=@t_carno)"+
		" and (a.datea between @t_bdate and @t_edate)"+
		" and (a.trandate between @t_btrandate and @t_etrandate)"+
		" and (a.straddrno between @t_baddr and @t_eaddr)"+
		" and (a.custno between @t_bcustno and @t_ecustno)"+
		" and (a.driverno between @t_bdriverno and @t_edriverno)"+
		" and (isnull(d.salesno2,'') between @t_bsalesno2 and @t_esalesno2)"+
		" and (len(@t_po)=0 or a.po=@t_po)"+
		" group by isnull(d.salesno2,''),left(a.trandate,6),a.carteamno"
	insert into @tmp1
	EXECUTE sp_executesql @cmd,N'@t_baddr nvarchar(20),@t_eaddr nvarchar(20),@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10),@t_bdriverno nvarchar(20),@t_edriverno nvarchar(20),@t_carno nvarchar(20),@t_bcustno  nvarchar(20),@t_ecustno  nvarchar(20),@t_po nvarchar(30),@t_bsalesno2 nvarchar(20),@t_esalesno2 nvarchar(20)',		
	@t_baddr=@t_baddr,@t_eaddr=@t_eaddr,@t_bdate=@t_bdate,@t_edate=@t_edate,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate
	,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_po=@t_po,@t_bsalesno2=@t_bsalesno2,@t_esalesno2=@t_esalesno2
		
	-------------------------------------------------------------------------------------------------------------
	
	declare cursor_table cursor for
	select salesno,mon,carteamno,sum(mount),sum([money]) from @tmp1 group by salesno,mon,carteamno
	open cursor_table
	fetch next from cursor_table
	into @salesno,@mon,@carteamno,@mount,@money
	while(@@FETCH_STATUS <> -1)
	begin
		if exists(select * from @field where noa=@carteamno)
		begin
			select @fieldB='',@fieldD=''
			select @fieldB=field_mount,@fieldD=field_money from @field where noa=@carteamno
			if not  exists(select  *  from  #z_tran21  where  salesno=@salesno and mon=@mon)
			begin
				set @namea=''
				select @namea=namea from sss where noa=@salesno
				insert  into  #z_tran21(gno,salesno,namea,mon)values('0',@salesno,@namea,@mon)
			end
			set  @cmd="update #z_tran21 set "+@fieldB+"=@mount,"+@fieldD+"=@money where gno='0' and salesno=@salesno and mon=@mon"
			execute sp_executesql @cmd,N'@salesno nvarchar(20),@mon  nvarchar(10),@mount  float,@money float'
			,@salesno=@salesno,@mon=@mon,@mount=@mount,@money=@money
		end
		fetch next from cursor_table
		into @salesno,@mon,@carteamno,@mount,@money
	end
	close cursor_table
	deallocate cursor_table
	-------------------------------------------
	--計算總計
	set @result=''

	declare cursor_table cursor for
	select field_money from  @field where noa!=char(255)
	open cursor_table
	fetch next from cursor_table
	into @fieldD
	while(@@FETCH_STATUS <> -1)
	begin
		if LEN(@result)=0
			set @result='isnull('+@fieldD+',0)'
		else
			set @result=@result+'+isnull('+@fieldD+',0)'
		fetch next from cursor_table
		into @fieldD
	end
	close cursor_table
	deallocate cursor_table
	
	select @fieldD=''
	select @fieldD=field_money from  @field where noa=char(255)
	set @result="update #z_tran21 set "+@fieldD+"="+@result
	execute sp_executesql @result
	----------------------------------------------------------------------------------------------------------------------
	--計算小計
	set @result="select '1',char(255),'',''"
	
	declare cursor_table cursor for
	select unit,team,field_mount_header,field_mount,field_money_header,field_money from  @field
	open cursor_table
	fetch next from cursor_table
	into @unit,@team,@fieldA,@fieldB,@fieldC,@fieldD
	while(@@FETCH_STATUS <> -1)
	begin
		set @result = @result+",'',sum("+@fieldB+"),'','',sum("+@fieldD+"),''"
		
		set @cmd = "update #z_tran21 set " +@fieldA+"=@unit,"+@fieldC+"=@team+'/$'"
		execute sp_executesql @cmd,N'@unit nvarchar(20),@team nvarchar(20)',@unit=@unit,@team=@team
		
		fetch next from cursor_table
		into @unit,@team,@fieldA,@fieldB,@fieldC,@fieldD
	end
	close cursor_table
	deallocate cursor_table
	set @result = @result+" from #z_tran21 group by gno"
	insert into #z_tran21
	execute sp_executesql @result
	----------------------------------------------------------------------------------------------------------------------
	declare cursor_table cursor for
	select field_mount,field_money from @field
	open cursor_table
	fetch next from cursor_table
	into @fieldB,@fieldD
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd="update #z_tran21 set c"+@fieldB+"=convert(nvarchar(15),CONVERT(money,"+@fieldB+"),1),"+
						" c"+@fieldD+"=reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,"+@fieldD+"),1)),4,12))"
		EXECUTE sp_executesql @cmd
		fetch next from cursor_table
		into @fieldB,@fieldD
	end
	close cursor_table
	deallocate cursor_table
	
	if len(@t_bdate)>0
		set  @string  =  '登錄日期：'+@t_bdate+'～'+@t_edate
	else
		set  @string   =  '交運日期：'+@t_btrandate+'～'+@t_etrandate
		
	select @string titlea,* from #z_tran21
	drop table #z_tran21;
	

z_tran20:--z_tran20
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	declare @t_sort08  nvarchar(max)
	declare @t_field05  nvarchar(max)
	declare @t_sort03  nvarchar(max)
	declare @t_sort14  nvarchar(max)
	declare @t_bsalesno  nvarchar(20)
	declare @t_esalesno  nvarchar(20)
	declare @t_sort06 nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	set @t_sort08  = case when '#non'=[27] then '' else [27] end
	set @t_field05  = case when '#non'=[28] then '' else [28] end
	set @t_sort03 = case when '#non'=[29] then '' else [29] end
	set @t_sort14 = case when '#non'=[30] then '' else [30] end
	set @t_bsalesno = case when '#non'=[31] then '' else [31] end
	set @t_esalesno = case when '#non'=[32] then char(255) else [32] end
	set @t_sort06  = case when '#non'=[33] then '' else [33] end
	------------------------------------------------------------------------------------
	declare @minN int
	declare @string nvarchar(max)
	declare @n int
	declare @carno nvarchar(20)
	declare @datea nvarchar(10)
	declare @carkindno  nvarchar(20)
	declare @carkind	nvarchar(20)
	declare @miles float
	declare @tranmoney float
	declare @drivermoney float
	declare @reserve float 
	declare @mount float 
	declare @money float 
	declare @unit nvarchar(20)
	declare @custno nvarchar(20)
	declare @comp  nvarchar(max)
	declare @carteamno nvarchar(20)
	declare @team  nvarchar(20)
	----------------------------------------------------------------------------------------------
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	--記錄欄位
	declare @gkey  nvarchar(max)
	declare @gname  nvarchar(max)
	declare @fieldA nvarchar(max)
	declare @fieldB nvarchar(max)
	declare @fieldC nvarchar(max)
	declare @fieldD nvarchar(max)
	declare @result nvarchar(max)
	
	declare @field table(
		noa  nvarchar(20),
		team nvarchar(20),
		unit  nvarchar(20),
		field_mount_header nvarchar(10),
		field_mount nvarchar(10),
		field_money_header nvarchar(10),
		field_money nvarchar(10)
	)
	-------------------------------------------------------------------------------------------------------------
	set @minN=6
	-------------------------------------------------------------------------------------------------------------
	--暫存資料
	IF OBJECT_ID('tempdb..#z_tran20')is not null
	BEGIN
		set @cmd = 'drop table #z_tran20'
		EXECUTE sp_executesql @cmd
	END
	create table #z_tran20(
		gno nvarchar(3),
		custno nvarchar(20),
		comp nvarchar(40),
		primary key(custno,gno)
	)
	-------------------------------------------------------------------------------------------------------------
	
	-------------------------------------------------------------------------------------------------------------
	--出車單:客戶金額
	select @n= COUNT(1) from @field

	declare cursor_table cursor for
	select a.noa,a.team,a.unit from carteam a
	left join carteam b on a.noa=b.noa
	left join #carteam c on b.noa=c.noa
	where b.noa=c.noa
	group by a.noa,a.team,a.unit
	open cursor_table
	fetch next from cursor_table
	into @gkey,@gname,@unit
	while(@@FETCH_STATUS <> -1)
	begin
		set @n = @n + 1
		insert into @field
		select @gkey,@gname,@unit,
				"a"+right("00"+CONVERT(nvarchar(10),@n),3),
				"b"+right("00"+CONVERT(nvarchar(10),@n),3),
				"c"+right("00"+CONVERT(nvarchar(10),@n),3),
				"d"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @cmd = "alter table #z_tran20 add a"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran20 add b"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran20 add cb"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran20 add c"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran20 add d"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran20 add cd"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		fetch next from cursor_table
		into @gkey,@gname,@unit
	end
	close cursor_table
	deallocate cursor_table
	
	select @n= COUNT(1) from @field
	while(@n<@minN)
	begin
		set  @n = @n +  1
		insert into @field
		select null,null,null,
				"a"+right("00"+CONVERT(nvarchar(10),@n),3),
				"b"+right("00"+CONVERT(nvarchar(10),@n),3),
				"c"+right("00"+CONVERT(nvarchar(10),@n),3),
				"d"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @cmd = "alter table #z_tran20 add a"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran20 add b"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran20 add cb"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran20 add c"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran20 add d"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran20 add cd"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--------------------------------------------------------------------------------------------------------------------
	declare @tmp1 table(
		custno nvarchar(20),
		carteamno nvarchar(10),
		mount float,
		[money] float
	)

	set @cmd =" select a.custno,a.carteamno,"
	if  @t_option1='收金額'
		set  @cmd  =  @cmd  +  "sum(a.mount), sum(round(a.mount*a.price,0)) money"
	else
		set  @cmd  =  @cmd  +  "sum(a.mount2), sum(round(a.mount2*(a.price2+a.price3),0)) money"
	set @cmd =	@cmd  +
		" from view_trans"+@t_accy+" a"+
		" left join #calctype b on a.calctype=b.noa"+
		" left join calctype c on left(a.calctype,1)=c.noa"+
		" left join #carteam d on a.carteamno=d.noa"+
		" where a.calctype=b.noa  and  a.carteamno=d.noa"+
		" and (len(@t_carno)=0 or a.carno=@t_carno)"+
		" and (a.datea between @t_bdate and @t_edate)"+
		" and (a.trandate between @t_btrandate and @t_etrandate)"+
		" and (a.custno between @t_bcustno and @t_ecustno)"+
		" and (a.driverno between @t_bdriverno and @t_edriverno)"+
		" and (a.straddrno between @t_baddr and @t_eaddr)"+
		" and (len(@t_po)=0 or a.po=@t_po)"+
		" group by a.custno,a.carteamno"
	insert into @tmp1
	execute sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10),@t_bcustno nvarchar(20),@t_ecustno nvarchar(20),@t_bdriverno  nvarchar(20),@t_edriverno  nvarchar(20),@t_carno  nvarchar(20),@t_po  nvarchar(20),@t_baddr  nvarchar(20),@t_eaddr  nvarchar(20)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_po=@t_po,@t_baddr=@t_baddr,@t_eaddr=@t_eaddr
	
	-------------------------------------------------------------------------------------------------------------
	
	declare cursor_table cursor for
	select custno,carteamno,mount,[money] from @tmp1
	open cursor_table
	fetch next from cursor_table
	into @custno,@carteamno,@mount,@money
	while(@@FETCH_STATUS <> -1)
	begin
		if exists(select * from @field where noa=@carteamno)
		begin
			select @fieldB='',@fieldD=''
			select @fieldB=field_mount,@fieldD=field_money from @field where noa=@carteamno
			if not  exists(select  *  from  #z_tran20  where  custno=@custno)
			begin
				set @comp=''
				select @comp=nick from cust where noa=@custno
				insert  into  #z_tran20(gno,custno,comp)values('0',@custno,@comp)
			end
			set  @cmd="update #z_tran20 set "+@fieldB+"=@mount,"+@fieldD+"=@money where gno='0' and custno=@custno"
			execute sp_executesql @cmd,N'@custno nvarchar(20),@mount  float,@money float',@custno=@custno,@mount=@mount,@money=@money
		end
		fetch next from cursor_table
		into @custno,@carteamno,@mount,@money
	end
	close cursor_table
	deallocate cursor_table
	-------------------------------------------
	set @result="select '1',char(255),''"
	
	
	declare cursor_table cursor for
	select unit,team,field_mount_header,field_mount,field_money_header,field_money from  @field
	open cursor_table
	fetch next from cursor_table
	into @unit,@team,@fieldA,@fieldB,@fieldC,@fieldD
	while(@@FETCH_STATUS <> -1)
	begin
		set @result = @result+",'',sum("+@fieldB+"),'','',sum("+@fieldD+"),''"
		
		set @cmd = "update #z_tran20 set " +@fieldA+"=@unit,"+@fieldC+"=@team"
		execute sp_executesql @cmd,N'@unit nvarchar(20),@team nvarchar(20)',@unit=@unit,@team=@team
		
		fetch next from cursor_table
		into @unit,@team,@fieldA,@fieldB,@fieldC,@fieldD
	end
	close cursor_table
	deallocate cursor_table
	set @result = @result+" from #z_tran20 group by gno"
	insert into #z_tran20
	execute sp_executesql @result
	----------------------------------------------------------------------------------------------------------------------
	declare cursor_table cursor for
	select field_mount,field_money from @field
	open cursor_table
	fetch next from cursor_table
	into @fieldB,@fieldD
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd="update #z_tran20 set c"+@fieldB+"=convert(nvarchar(15),CONVERT(money,"+@fieldB+"),1),"+
						" c"+@fieldD+"=reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,"+@fieldD+"),1)),4,12))"
		EXECUTE sp_executesql @cmd
		fetch next from cursor_table
		into @fieldB,@fieldD
	end
	close cursor_table
	deallocate cursor_table
	------------------------------------------------------------------------------------------------------------------------
	if len(@t_bdate)>0
		set  @cmd  =  '登錄日期：'+@t_bdate+'～'+@t_edate
	else
		set  @cmd  =  '交運日期：'+@t_btrandate+'～'+@t_etrandate
	
	set @string=''		
	select @string=field_mount from @field where noa=@t_sort06
	if len(@string)=0
		set @string='b001'
	set @cmd="select '"+@cmd+"' titlea ,* from #z_tran20 order by gno,"+@string+" desc,custno"
	execute sp_executesql @cmd
	-------------------------------------------------------------------------------------------------------------------
	drop table #z_tran20
	drop table #carkind
	drop table #carteam
	drop table #calctype;

z_tran19:--z_tran19	
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	declare @t_sort08  nvarchar(max)
	declare @t_field05  nvarchar(max)
	declare @t_sort03  nvarchar(max)
	declare @t_sort14  nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	set @t_sort08  = case when '#non'=[27] then '' else [27] end
	set @t_field05  = case when '#non'=[28] then '' else [28] end
	set @t_sort03 = case when '#non'=[29] then '' else [29] end
	set @t_sort14 = case when '#non'=[30] then '' else [30] end
	---------------------------------------------------------------------------------------------- 
	--解析要計算的種類
	declare @string nvarchar(max)
	declare @n int
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	declare @display table(
		noa nvarchar(20)
	)
	set @string = @t_field05
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into @display select @string
			end
			break
		end
		insert into @display select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	declare @count int
	declare @mount float
	declare @mount2 float
	declare @total2 float
	declare @drivermoney float
	declare @inmount float
	declare @pton float
	declare @outmount float
	declare @pton2 float
	declare @driverno nvarchar(20)
	declare @carno nvarchar(20)
	declare @noa nvarchar(20)
	declare @x_key nvarchar(20)
	----------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_tran19')is not null
	BEGIN
		set @cmd = 'drop table #z_tran19'
		EXECUTE sp_executesql @cmd
	END
	create table #z_tran19(
		gno nvarchar(3),
		trandate nvarchar(10),
		datea nvarchar(10),
		custno nvarchar(20),
		comp nvarchar(40),
		driverno nvarchar(20),
		namea nvarchar(20),
		carno nvarchar(20),
		addr nvarchar(40),
		product nvarchar(40),
		inmount float,
		pton float,
		mount decimal(10,3),
		price float,
		total float,
		outmount decimal(10,3),
		pton2 decimal(10,3),
		mount2 decimal(10,3),
		price2 float,
		price3 float,
		discount decimal(10,3),
		total2 float,
		drivermoney float,
		po nvarchar(30),
		caseno nvarchar(30),
		cc  nvarchar(20),
		tt  nvarchar(20),
		noa  nvarchar(20),
		carcount int
	)
	
	set @cmd = 
		" select  '0',a.trandate,a.datea,a.custno,left(a.comp,4),a.driverno,a.driver,a.carno,a.straddr,a.product,"+
		" a.inmount,a.pton,a.mount,a.price,a.total,a.outmount,a.pton2,a.mount2,a.price2,a.price3,a.discount,a.total2,round((price2+price3)*mount2,0)"+
		",a.po,a.caseno,e.typea,d.team,a.noa,0"+
		" from  view_trans"+@t_accy+"  a"+
		" left join #carteam  b on a.carteamno=b.noa"+	
		" left join #calctype c on a.calctype=c.noa"+
		" left join carteam  d on a.carteamno=d.noa"+	
		" left join calctypes e on a.calctype=e.noa+e.noq"+
		" where "+
		" (a.datea  between  @t_bdate  and  @t_edate) and "+
		" (a.trandate  between  @t_btrandate  and  @t_etrandate) and "+
		" (a.custno  between  @t_bcustno   and  @t_ecustno) and "+
		" (a.driverno  between  @t_bdriverno   and  @t_edriverno) and "+
		" (len(@t_carno)=0  or  a.carno=@t_carno) and "+
		" (len(@t_po)=0  or  a.po=@t_po) and "+
		" (a.straddrno between @t_baddr and @t_eaddr) and"+
		" (b.noa  is  not  null) and (c.noa  is  not  null)"+
		" order  by  a.datea,a.noa"
	insert into #z_tran19
	execute sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10),@t_bcustno nvarchar(20),@t_ecustno nvarchar(20),@t_bdriverno  nvarchar(20),@t_edriverno  nvarchar(20),@t_carno  nvarchar(20),@t_po  nvarchar(20),@t_baddr  nvarchar(20),@t_eaddr  nvarchar(20)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_po=@t_po,@t_baddr=@t_baddr,@t_eaddr=@t_eaddr
	
	declare @money float
	select @money=0
	select @money=SUM(total2) from #z_tran19 where gno='0'
	insert into #z_tran19 (gno,total2)values('1',@money)
	
	if len(@t_bdate)>0
		set  @string  =  '登錄日期：'+@t_bdate+'～'+@t_edate
	else
		set  @string   =  '交運日期：'+@t_btrandate+'～'+@t_etrandate
	
	set @cmd = 
		" select @string titlea, gno,trandate  aa,custno bb,driverno mm,namea cc,carno dd,carcount ss,addr,product ee,inmount pp1,pton qq1,mount ff1,outmount pp2,pton2 qq2,mount2 ff2,"+
		" case when price2=0 then price3 else price2 end gg,discount hh,"+
		" reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total2),1)),4,12)) ii,"+
		" caseno jj,case when right(noa,1)=char(255) then '' else noa  end kk, "+
		" reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,drivermoney),1)),4,12)) dm"+
		" from  #z_tran19  order  by gno,datea,noa"
	
	EXECUTE sp_executesql @cmd,N'@string nvarchar(max)',@string=@string
	drop table #z_tran19
	drop table #carkind
	drop table #calctype
	drop table #carteam;
	


z_tran17:--z_tran17
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	declare @t_sort08  nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	set @t_sort08  = case when '#non'=[27] then '' else [27] end
	----------------------------------------------------------------------------------------------
	--解析要計算的種類
	declare @string nvarchar(max)
	declare @n int
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	-------------------------------------------------------------------------------------------------------------
	declare @carno  nvarchar(20)
	declare @driverno  nvarchar(20)
	declare @driver nvarchar(20)
	declare @mon nvarchar(10)
	declare @money float
	declare @tranmoney float
	declare @miles float
	declare @reserve  float
	declare @oilmount float
	declare @oilmoney float
	declare @fixa1 float
	declare @fixa2 float
	declare @tire1 float
	declare @tire2 float
	declare @driverpay float
	declare @tolls float
	declare @ticket float
	declare @carsal float
	declare @tax float
	declare @depreciation  float
	declare @profit  float
	declare @carkindno nvarchar(20)
	declare @carkind nvarchar(20)
	declare @caryear nvarchar(10)
	declare @day  int
	-------------------------------------------------------------------------------------------------------------
	--暫存資料
	IF OBJECT_ID('tempdb..#z_tran17')is not null
	BEGIN
		set @cmd = 'drop table #z_tran17'
		EXECUTE sp_executesql @cmd
	END
	create table #z_tran17(
		n float,
		gno nvarchar(3),
		carkindno nvarchar(20),
		carkind nvarchar(20),
		carno nvarchar(20),
		caryear nvarchar(10),
		driverno nvarchar(20),
		driver nvarchar(20),
		mon nvarchar(20),
		[day] int,
		tranmoney float,
		miles float,
		oilmount float,
		oilmoney float,
		rate1 float,--油秏
		rate2 float,--公里/升
		fixa1 float,--車輛維修
		fixa2 float,--板台維修
		tire1 float,--車輛輪胎
		tire2 float,--板台輪胎
		driverpay  float,--司機維修自付
		tolls float,--通行費
		reserve float,--寄櫃費
		ticket float,--罰款
		carsal float,--薪資
		tax float,--保牌燃費
		depreciation float,--折舊
		profit float,--淨利
	)
	create index noa on #z_tran17(carno,driverno,mon)
	-------------------------------------------------------------------------------------------------------------------
	--出車單
	declare @tmp1 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		tranmoney  float,
		miles  float,
		reserve  float
	)	
	set @cmd=" select  a.carno,a.driverno,LEFT(a.datea,6)"
	if @t_option1='收金額'
		set @cmd=@cmd+" ,sum(round(ISNULL(a.price,0)*isnull(a.mount,0),0))"
	else
		set @cmd=@cmd+" ,sum(round(ISNULL(a.price2,0)*isnull(a.mount2,0),0))"
	set @cmd=@cmd+",sum(ISNULL(a.miles,0)),sum(ISNULL(a.reserve,0))"+
	" from view_trans"+@t_accy+" a "+ 
	" left  join  calctypes  b  on  b.noa+b.noq=a.calctype"+
	" where len(ISNULL(a.carno,''))>0 and  (b.noa is  not  null) and isnull(b.isoutside,0)=0"+
	" and (a.datea  between  @t_bdate  and  @t_edate)"+
	" group by a.carno,a.driverno,LEFT(a.datea,6)"+
	" order  by a.carno,LEFT(a.datea,6),a.driverno"
	
	insert into @tmp1
	execute sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10)',@t_bdate=@t_bdate,@t_edate=@t_edate
	-------------------------------------------------------------------------------------------------------------------
	--油費
	declare @tmp2 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		oilmount float,
		oilmoney float
	)
	insert into @tmp2
	select  carno,driverno,LEFT(datea,6),SUM(ISNULL(mount,0)),SUM(ISNULL([money],0))  
	from  oil
	where (datea between @t_bdate  and @t_edate)
	group  by  carno,driverno,LEFT(datea,6)
	order  by  carno,LEFT(datea,6),driverno
	-------------------------------------------------------------------------------------------------------------------
	--維修
	declare @tmp3 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		fixa1 float,--車輛維修
		fixa2 float,--板台維修
		tire1 float,--車輛輪胎
		tire2 float,--板台輪胎
		driverpay  float--司機維修自付
	)
	insert into @tmp3
	select  carno,driverno,left(datea,6)
	,SUM(case when len(isnull(carplateno,''))=0 then isnull(wmoney-discount,0) else 0  end)
	,SUM(case when len(isnull(carplateno,''))>0 then isnull(wmoney-discount,0) else 0  end)
	,SUM(case when len(isnull(carplateno,''))=0 then isnull(cmoney,0) else 0  end)
	,SUM(case when len(isnull(carplateno,''))>0 then isnull(cmoney,0) else 0  end) 
	,0
	from  fixa
	where (isnull(datea,'') between @t_bdate  and @t_edate)
	group  by carno,driverno,left(datea,6)
	order by carno,left(datea,6),driverno
	
	declare cursor_table cursor for
	select carno,driverno,left(datea,6)
	,sum(case when len(isnull(carplateno,''))=0  then isnull([money],0) else 0  end)
	,sum(case when len(isnull(carplateno,''))>0  then isnull([money],0) else 0  end)
	from fixout
	where (isnull(datea,'') between @t_bdate  and @t_edate)
	group  by carno,driverno,left(datea,6)
	order by carno,left(datea,6),driverno
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@tire1,@tire2
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select  *  from @tmp3 where carno=@carno and driverno=@driverno and mon=@mon)
			insert into @tmp3(carno,driverno,mon,tire1,tire2)values(@carno,@driverno,@mon,@tire1,@tire2)
		else
			update @tmp3 set tire1=isnull(tire1,0)+@tire1,tire2=isnull(tire2,0)+@tire2  where carno=@carno and driverno=@driverno and mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@tire1,@tire2
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,sum(isnull([money],0))
	from carborr
	where (mon between left(@t_bdate,6)  and left(@t_edate,6)) and  typea='維修'
	group  by carno,driverno,mon
	order by carno,mon,driverno
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@money
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select  *  from @tmp3 where carno=@carno and driverno=@driverno and mon=@mon)
			insert into @tmp3(carno,driverno,mon,driverpay)values(@carno,@driverno,@mon,@money)
		else
			update @tmp3 set driverpay=@money  where carno=@carno and driverno=@driverno and mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@money
	end
	close cursor_table
	deallocate cursor_table
	-------------------------------------------------------------------------------------------------------------------
	--ETC
	declare @tmp4 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		tolls float
	)
	insert into @tmp4
	select carno,driverno,LEFT(datea,6),SUM(ISNULL([money],0))
	from etc
	where typea='ETC' and (datea between @t_bdate and @t_edate)
	group by carno,driverno,LEFT(datea,6)
	order by carno,LEFT(datea,6),driverno
	-------------------------------------------------------------------------------------------------------------------
	--罰款
	declare @tmp5 table(
		carno  nvarchar(20),
		driverno  nvarchar(20),
		mon  nvarchar(10),
		ticket float
	)
	insert into @tmp5
	select carno,driverno,mon,SUM(ISNULL(comppay,0)) 
	from carborr
	where typea='罰單' and  (mon between  left(@t_bdate,6) and LEFT(@t_edate,6))
	group  by  carno,driverno,mon
	order  by  carno,mon,driverno
	-------------------------------------------------------------------------------------------------------------------
	--薪資
	declare @tmp6 table(
		driverno  nvarchar(20),
		mon  nvarchar(10),
		carsal float
	)
	insert into @tmp6
	select driverno,noa,[money]
	from carsals
	where (noa between LEFT(@t_bdate,6) and LEFT(@t_edate,6))
	-------------------------------------------------------------------------------------------------------------------
	--保牌燃費,折舊 
	declare @tmp7 table(
		carno nvarchar(20),
		mon nvarchar(10),
		tax float,
		depreciation float
	)
	insert into @tmp7
	select  b.carno,a.mon,a.tax,a.depreciation
	from carts a  
	left join cart b on a.noa=b.noa
	where (len(ISNULL(b.carno,''))>0) and (a.mon between left(@t_bdate,6) and left(@t_edate,6))
	-------------------------------------------------------------------------------------------------------------------
	-------------------------------------------------------------------------------------------------------------------	
	declare cursor_table cursor for
	select carno,driverno,mon,tranmoney,miles,reserve from @tmp1
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@tranmoney,@miles,@reserve
	while(@@FETCH_STATUS <> -1)
	begin
		insert into #z_tran17 (n,carno,driverno,mon,tranmoney,miles,reserve)values(0,@carno,@driverno,@mon,@tranmoney,@miles,@reserve)
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@tranmoney,@miles,@reserve
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,oilmount,oilmoney from @tmp2
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@oilmount,@oilmoney
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select *  from  #z_tran17 where carno=@carno  and  driverno=@driverno and  mon=@mon)
			insert into #z_tran17 (n,carno,driverno,mon,oilmount,oilmoney)values(0,@carno,@driverno,@mon,@oilmount,@oilmoney)
		else
			update #z_tran17 set oilmount=@oilmount,oilmoney=@oilmoney where carno=@carno  and  driverno=@driverno and  mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@oilmount,@oilmoney
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,fixa1,fixa2,tire1,tire2,driverpay from @tmp3
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@fixa1,@fixa2,@tire1,@tire2,@driverpay
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select *  from  #z_tran17 where carno=@carno  and  driverno=@driverno and  mon=@mon)
			insert into #z_tran17 (n,carno,driverno,mon,fixa1,fixa2,tire1,tire2,driverpay)values(0,@carno,@driverno,@mon,@fixa1,@fixa2,@tire1,@tire2,@driverpay)
		else
			update #z_tran17 set fixa1=isnull(fixa1,0)+@fixa1,fixa2=isnull(fixa2,0)+@fixa2
			,tire1=isnull(tire1,0)+@tire1,tire2=isnull(tire2,0)+@tire2,driverpay=isnull(driverpay,0)+@driverpay 
			where carno=@carno  and  driverno=@driverno and  mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@fixa1,@fixa2,@tire1,@tire2,@driverpay
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,tolls from @tmp4
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@tolls
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select *  from  #z_tran17 where carno=@carno  and  driverno=@driverno and  mon=@mon)
			insert into #z_tran17 (n,carno,driverno,mon,tolls)values(0,@carno,@driverno,@mon,@tolls)
		else
			update #z_tran17 set tolls=isnull(tolls,0)+@tolls where carno=@carno  and  driverno=@driverno and  mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@tolls
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon,ticket from @tmp5
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon,@ticket
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select *  from  #z_tran17 where carno=@carno  and  driverno=@driverno and  mon=@mon)
			insert into #z_tran17 (n,carno,driverno,mon,ticket)values(0,@carno,@driverno,@mon,@ticket)
		else
			update #z_tran17 set ticket=@ticket where carno=@carno  and  driverno=@driverno and  mon=@mon
		
		fetch next from cursor_table
		into @carno,@driverno,@mon,@ticket
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select driverno,mon,carsal from @tmp6
	open cursor_table
	fetch next from cursor_table
	into @driverno,@mon,@carsal
	while(@@FETCH_STATUS <> -1)
	begin
		select @carno=''
		select top(1) @carno=carno from #z_tran17 where driverno=@driverno and mon=@mon order by tranmoney desc
		if LEN(@carno)>0
		begin
			update #z_tran17 set carsal=@carsal where carno=@carno  and  driverno=@driverno and  mon=@mon
		end
		fetch next from cursor_table
		into @driverno,@mon,@carsal
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,mon,tax,depreciation from @tmp7
	open cursor_table
	fetch next from cursor_table
	into @carno,@mon,@tax,@depreciation
	while(@@FETCH_STATUS <> -1)
	begin
		select @driverno=''
		select top(1) @driverno=driverno from #z_tran17 where carno=@carno and mon=@mon order by tranmoney desc
		if LEN(@driverno)>0
		begin
			update #z_tran17 set tax=@tax,depreciation=@depreciation where carno=@carno  and  driverno=@driverno and  mon=@mon
		end
		fetch next from cursor_table
		into @carno,@mon,@tax,@depreciation
	end
	close cursor_table
	deallocate cursor_table
	------------------------------------------------------------------------------------------------------------------------
	declare cursor_table cursor for
	select carno from #z_tran17 group  by  carno
	open cursor_table
	fetch next from cursor_table
	into @carno
	while(@@FETCH_STATUS <> -1)
	begin
		select @carkindno='',@carKind='',@caryear=''
		select @carkindno=a.carkindno,@carKind=b.kind,@caryear=a.caryear 
		from car2 a left join carkind b on  a.carkindno=b.noa
		where carno=@carno
		update #z_tran17 set carkindno=@carkindno,carkind=@carkind,caryear=@caryear where carno=@carno
		
		fetch next from cursor_table
		into @carno
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select driverno from #z_tran17 group by driverno
	open cursor_table
	fetch next from cursor_table
	into @driverno
	while(@@FETCH_STATUS <> -1)
	begin
		select @driver=''
		select @driver=namea from driver where noa=@driverno
		update #z_tran17 set driver=@driver where driverno=@driverno
		
		fetch next from cursor_table
		into @driverno
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mon from #z_tran17 group by carno,driverno,mon
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mon
	while(@@FETCH_STATUS <> -1)
	begin
		select @day=0
		set @cmd="select @day=count(1) from (SELECT DISTINCT datea from view_trans"+@t_accy+" where carno=@carno and driverno=@driverno and LEFT(datea,6)=@mon)as a"
		execute sp_executesql @cmd,N'@carno  nvarchar(20),@driverno  nvarchar(20),@mon nvarchar(10),@day  int  output'
		,@carno=@carno,@driverno=@driverno,@mon=@mon,@day=@day  output
		
		update #z_tran17  set  [day]=@day where carno=@carno and driverno=@driverno and mon=@mon  
		fetch next from cursor_table
		into @carno,@driverno,@mon
	end
	close cursor_table
	deallocate cursor_table
	-------------------------------------------------------------------------------------------------------------------------------
	declare cursor_table cursor for
	select carkindno from #z_tran17 group by carkindno
	open cursor_table
	fetch next from cursor_table
	into @carkindno
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select * from #carkind where noa=@carkindno)
			delete #z_tran17 where carkindno=@carkindno
		fetch next from cursor_table
		into @carkindno
	end
	close cursor_table
	deallocate cursor_table
	
	if LEN(@t_carno)>0
		delete #z_tran17 where carno!=@t_carno
	delete #z_tran17 where not(driverno between @t_bdriverno and @t_edriverno)
	update #z_tran17 set gno='0' 
	
	insert into #z_tran17
	select 1,'1',carkindno,carKind,CHAR(255),'','','','','',SUM(ISNULL(tranmoney,0)),SUM(ISNULL(miles,0)),SUM(ISNULL(oilmount,0)),SUM(ISNULL(oilmoney,0))
	,0,0,SUM(ISNULL(fixa1,0)),SUM(ISNULL(fixa2,0)),SUM(ISNULL(tire1,0)),SUM(ISNULL(tire2,0)),SUM(ISNULL(driverpay,0))
	,SUM(ISNULL(tolls,0)),SUM(ISNULL(reserve,0)),SUM(ISNULL(ticket,0)),SUM(ISNULL(carsal,0)),SUM(ISNULL(tax,0)),SUM(ISNULL(depreciation,0)),0
	from #z_tran17 where gno='0'group by carkindno,carkind
	
	update #z_tran17  set rate1= case when isnull(tranmoney,0)=0  then 0 else round(ISNULL(oilmoney,0)/tranmoney*100,0) end
	,rate2= case when isnull(oilmount,0)=0  then 0 else round(ISNULL(miles,0)/oilmount,3) end
	,profit=ISNULL(tranmoney,0)-ISNULL(oilmoney,0)-ISNULL(fixa1,0)-ISNULL(fixa2,0)-isnull(tire1,0)-ISNULL(tire2,0)+ISNULL(driverpay,0)
	-ISNULL(tolls,0)-ISNULL(reserve,0)-ISNULL(ticket,0)-ISNULL(carsal,0)-ISNULL(tax,0)-ISNULL(depreciation,0)
	---------------------------------------------------------------------------------------------------------------------
	
	update #z_tran17 set gno='2' where gno='0' and profit<0
	
	select * 
	,caryear m01
	,cast(rate1 as nvarchar)+'%' m02
	,[day] m03
	,cast(rate2 as decimal(10,3)) m04
	,carno m05
	,driver m06
	,mon m07
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tranmoney,0)),1)),4,12)) m08
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12)) m09
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) m10
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(fixa1,0)),1)),4,12)) m11
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(fixa2,0)),1)),4,12)) m12
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tire1,0)),1)),4,12)) m13
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tire2,0)),1)),4,12)) m14
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(driverpay,0)),1)),4,12))  m15
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) m16
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) m17
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(reserve,0)),1)),4,12)) m18
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(carsal,0)),1)),4,12)) m19
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tax,0)),1)),4,12)) m20
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(depreciation,0)),1)),4,12)) m21
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(profit,0)),1)),4,12)) m22
	from #z_tran17 order  by  carkindno,n,caryear,carno;


z_tran16:--z_tran16    ref  z_tran08
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	declare @t_sort08  nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	set @t_sort08  = case when '#non'=[27] then '' else [27] end
	----------------------------------------------------------------------------------------------
	
	declare @minN int
	declare @string nvarchar(max)
	declare @n int
	declare @carno nvarchar(20)
	declare @datea nvarchar(10)
	declare @carkindno  nvarchar(20)
	declare @carkind	nvarchar(20)
	declare @miles float
	declare @tranmoney float
	declare @drivermoney float
	declare @reserve float 
	declare @mount float 
	declare @money float 
	declare @unit nvarchar(20)
	declare @custno nvarchar(20)
	declare @comp  nvarchar(max)
	declare @carteamno nvarchar(20)
	declare @team  nvarchar(20)
	declare @po nvarchar(20)
	declare @trandono nvarchar(20)
	declare @noa nvarchar(20)
	declare @acomp nvarchar(max)
	declare @mount2 float
	declare @mount3 float
	declare @serial nvarchar(20)
	declare @tel nvarchar(20)
	declare @money2 float
	declare @money3 float
	----------------------------------------------------------------------------------------------
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_tran08')is not null
	BEGIN
		set @cmd = 'drop table #z_tran08'
		EXECUTE sp_executesql @cmd
	END
	create table  #z_tran08(
			gno nvarchar(1),
			pno nvarchar(1),
			acomp nvarchar(50),
			noa nvarchar(20),
			datea nvarchar(20),
			trandate nvarchar(20),
			po nvarchar(20),
			custno nvarchar(20),
			comp nvarchar(50),
			custorde nvarchar(30),
			newcustorde nvarchar(30),
			serial nvarchar(20),
			tel nvarchar(20),
			straddr nvarchar(20),
			product nvarchar(20),
			mount decimal(18,3),
			price decimal(18,3),
			total decimal(18,3),
			carno nvarchar(20),
			isoutside int,
			caseno nvarchar(20),
			driverno nvarchar(20),
			carteamno nvarchar(20),
			calctype nvarchar(20),
			mount2 float,--公司車
			mount3 float,--外車
			total2 float,--公司車
			total3 float,--外車
			times int--車次
	)
	create index noa on #z_tran08(noa)
	set @cmd = 
		"select '0' gno,'0' pno,(@t_cno+'【請款明細表】'),a.noa,a.datea,a.trandate,a.po,a.custno,isnull(f.comp,''),a.custorde,'',isnull(f.serial,''),left(isnull(f.tel,''),20)"
	if LEN(@z_addr)>0
		set @cmd =  @cmd +",'"+@z_addr+"'"
	else
		set @cmd =  @cmd +",a.straddr"
	if LEN(@z_product)>0
		set @cmd =  @cmd +",'"+@z_product+"'"
	else
		set @cmd =  @cmd +",a.product"
	set @cmd = @cmd +
		",a.mount,a.price,a.total,a.carno,isnull(e.isoutside,''),a.caseno,a.driverno,a.carteamno,a.calctype,0,0,0,0,0"+
		" from  view_trans"+@t_accy+"  a "+
		" left join #carteam  b on a.carteamno=b.noa"+	
		" left join #calctype c on a.calctype=c.noa"+
		" left join carteam  d on a.carteamno=d.noa"+	
		" left join calctypes e on a.calctype=e.noa+e.noq"+
		" left join cust f on f.noa = a.custno "+
		" where "+
		"(isnull(a.datea,'') between @t_bdate and @t_edate) and "+
		"(isnull(a.trandate,'') between @t_btrandate and @t_etrandate) and "+
		"(isnull(a.custno,'') between @t_bcustno and @t_ecustno) and" +
		"(isnull(a.driverno,'') between @t_bdriverno and @t_edriverno) and"+
		"(len(@t_carno) = 0 or a.carno = @t_carno) and"+
		"(len(@t_po)=0 or a.po = @t_po) and"+
		"(a.straddrno between @t_baddr and @t_eaddr) and"+
		" (b.noa  is  not  null) and (c.noa  is  not  null)"
	insert into #z_tran08
	execute sp_executesql @cmd,N'@t_cno  nvarchar(50),@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bcustno nvarchar(20),@t_ecustno nvarchar(20),@t_bdriverno  nvarchar(20),@t_edriverno  nvarchar(20),@t_carno  nvarchar(20),@t_po  nvarchar(20),@t_baddr nvarchar(20),@t_eaddr nvarchar(20),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10)',
		@t_cno=@t_cno,@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_po=@t_po,@t_baddr=@t_baddr,@t_eaddr=@t_eaddr,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate
	
	declare cursor_table cursor for
	select noa,custorde from #z_tran08
	open cursor_table
	fetch next from cursor_table
	into @noa,@string
	while(@@FETCH_STATUS <> -1)
	begin
		set @n = PATINDEX('%[0-9]%',@string)
		if(@n>1)
		begin
			set @string = substring(@string,@n,len(@string)-@n+1)+LEFT(@string,@n-1)
		end
		update #z_tran08 set newcustorde=@string where  noa=@noa
		
		fetch next from cursor_table
		into @noa,@string
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select acomp,custno,comp,serial,tel,count(1) n,sum(mount),sum(total) from #z_tran08 group by acomp,custno,comp,serial,tel
	open cursor_table
	fetch next from cursor_table
	into @acomp,@custno,@comp,@serial,@tel,@n,@mount,@money
	while(@@FETCH_STATUS <> -1)
	begin
		select @mount2=0,@mount3=0,@money2=0,@money3=0
		select @mount2=isnull(SUM(isnull(mount,0)),0),@money2=isnull(sum(isnull(total,0)),0) from  #z_tran08  a
		left join calctypes b on a.calctype=b.noa+b.noq
		where  a.custno=@custno  and  not((b.noa+b.noq)is null) and b.isoutside!=1
		select @mount3=isnull(SUM(isnull(mount,0)),0),@money3=isnull(sum(isnull(total,0)),0) from  #z_tran08  a
		left join calctypes b on a.calctype=b.noa+b.noq
		where  a.custno=@custno  and  not((b.noa+b.noq)is null) and  b.isoutside=1

		insert into #z_tran08(gno,pno,acomp,custno,comp,serial,tel,mount,total,times,mount2,total2,mount3,total3)values('1','x',@acomp,@custno,@comp,@serial,@tel,@mount,@money,@n,@mount2,@money2,@mount3,@money3)
		set @n=(@n+2)%@minN
		while(@n!=0 and @n<@minN)
		begin
			insert into #z_tran08(gno,pno,acomp,custno,comp,serial,tel)values('0','y',@acomp,@custno,@comp,@serial,@tel)
			set @n = @n+1
		end
		insert into #z_tran08(gno,pno,acomp,custno,comp,serial,tel)values('2','z',@acomp,@custno,@comp,@serial,@tel)
		fetch next from cursor_table
		into @acomp,@custno,@comp,@serial,@tel,@n,@mount,@money
	end
	close cursor_table
	deallocate cursor_table
	
	declare @h1  char(120)
	declare @h2  char(120)
	set @h1=" 日   期 "+space(1)+" 起  迄  點 "+space(1)+" 品    名 "+SPACE(1)+" 數    量 "+SPACE(1)
			+" 單    價 "+SPACE(1)+" 金    額 "+SPACE(1)+" P/O        "+SPACE(1)+" 憑 單 號 碼 "+SPACE(1)+" 貨 櫃 號 碼 "
	set @h2=REPLICATE('=',9)+SPACE(1)+REPLICATE('=',12)+SPACE(1)+REPLICATE('=',10)+SPACE(1)+REPLICATE('=',10)+SPACE(1) 
		+REPLICATE('=',10)+SPACE(1) +REPLICATE('=',10)+SPACE(1)+REPLICATE('=',12)+SPACE(1)+REPLICATE('=',13)+SPACE(1)+REPLICATE('=',13)+SPACE(1)  
	declare @tmp table(
		gno nvarchar(3),
		pno nvarchar(3),
		acomp nvarchar(50),
		custno  nvarchar(20),
		newcustorde  nvarchar(30),
		comp  nvarchar(50),
		serial nvarchar(20),
		tel nvarchar(20),
		po nvarchar(20),
		times int,
		h1 char(1000),
		h2 char(1000),
		memo char(1000),
		t1 char(1000),
		t2 char(1000),
		t3 char(1000)
	)
	set @cmd="select gno,pno,acomp,custno,newcustorde,comp,serial,tel,isnull(po,'')"+
	",times"+
	",@h1,@h2,("+
	"cast(isnull(trandate,'') as char(9))+space(1)+cast(isnull(straddr,'') as char(12))+space(1)+cast(isnull(product,'') as char(10))"+
	"+space(1)+right(space(10)+(reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,(case when mount<0 then -1 else 1 end)*floor(abs(mount))),1)),4,12))+left(right(convert(nvarchar,cast(mount  as  money),2),5),4)),10)"+
	"+space(1)+right(space(10)+(reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,(case when price<0 then -1 else 1 end)*floor(abs(price))),1)),4,12))+left(right(convert(nvarchar,cast(price  as  money),2),5),4)),10)"+
	"+space(1)+right(space(10)+reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)),10)"+
	"+space(1)+cast(isnull(po,'') as char(12))"+
	"+space(1)+cast(isnull(custorde,'') as char(13))"+
	"+space(1)+cast(isnull(caseno,'') as char(13))"+
	") memo"+
	",(space(25)+'合  計：'"+
	"+space(1)+right(space(10)+(reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,(case when mount<0 then -1 else 1 end)*floor(abs(mount))),1)),4,12))+left(right(convert(nvarchar,cast(mount  as  money),2),5),4)),10)"+
	"+space(12)+right(space(10)+reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)),10)"+
	")"+
	",(space(25)+'公司車：'"+
	"+space(1)+right(space(10)+(reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,(case when mount2<0 then -1 else 1 end)*floor(abs(mount2))),1)),4,12))+left(right(convert(nvarchar,cast(mount2  as  money),2),5),4)),10)"+
	"+space(12)+right(space(10)+reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total2),1)),4,12)),10)"+
	")"+
	",(space(25)+'外  車：'"+
	"+space(1)+right(space(10)+(reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,(case when mount3<0 then -1 else 1 end)*floor(abs(mount3))),1)),4,12))+left(right(convert(nvarchar,cast(mount3  as  money),2),5),4)),10)"+
	"+space(12)+right(space(10)+reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total3),1)),4,12)),10)"+
	")"+
	"  from  #z_tran08  order  by  custno,pno,gno,"+(case when @t_sort08='custorde' then 'newcustorde' else @t_sort08 end)+",noa"
	insert into @tmp
	execute sp_executesql @cmd,N'@h1 nvarchar(max),@h2 nvarchar(max)',@h1=@h1,@h2=@h2
	update @tmp set h1=REPLACE(h1,SPACE(1),'&nbsp'+char(59))
	,h2=REPLACE(h2,SPACE(1),'&nbsp'+char(59))
	,memo=REPLACE(memo,SPACE(1),'&nbsp'+char(59))
	,t1=REPLACE(t1,SPACE(1),'&nbsp'+char(59))
	,t2=REPLACE(t2,SPACE(1),'&nbsp'+char(59))
	,t3=REPLACE(t3,SPACE(1),'&nbsp'+char(59))
	
	if len(@t_bdate)>0
		set  @cmd  =  '登錄日期：'+@t_bdate+'～'+@t_edate
	else
		set  @cmd  =  '交運日期：'+@t_btrandate+'～'+@t_etrandate
	select @cmd titlea ,* from @tmp
	-------------------------------------------------------------------------------------------------------------------
	drop table #z_tran08
	drop table #carkind
	drop table #carteam
	drop table #calctype;

z_tran12:--z_tran12
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	declare @t_sort08  nvarchar(max)
	declare @t_field05  nvarchar(max)
	declare @t_sort03  nvarchar(max)
	declare @t_sort14  nvarchar(max)
	declare @t_bsalesno  nvarchar(20)
	declare @t_esalesno  nvarchar(20)
	declare @t_sort06 nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	set @t_sort08  = case when '#non'=[27] then '' else [27] end
	set @t_field05  = case when '#non'=[28] then '' else [28] end
	set @t_sort03 = case when '#non'=[29] then '' else [29] end
	set @t_sort14 = case when '#non'=[30] then '' else [30] end
	set @t_bsalesno = case when '#non'=[31] then '' else [31] end
	set @t_esalesno = case when '#non'=[32] then char(255) else [32] end
	set @t_sort06  = case when '#non'=[33] then '' else [33] end
	----------------------------------------------------------------------------------------------
	--解析要計算的種類
	declare @string nvarchar(max)
	declare @n int
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	declare @display table(
		noa nvarchar(20)
	)
	set @string = @t_field05
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into @display select @string
			end
			break
		end
		insert into @display select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	-------------------------------------------------------------------------------------------------------------
	declare @gkey nvarchar(20)
	declare @minN int
	set @minN = 7
	declare @gname  nvarchar(20)
	declare  @salesno  nvarchar(20)
	declare  @unit  nvarchar(20)
	declare  @carteamno  nvarchar(20)
	declare  @mount  float
	declare  @fieldA  nvarchar(20)
	declare  @fieldB  nvarchar(20)
	declare  @fieldC  nvarchar(20)
	declare  @fieldD  nvarchar(20)
	declare  @namea  nvarchar(20)
	declare  @money  float
	declare  @result  nvarchar(max)
	declare  @team  nvarchar(20)
	declare  @mon  nvarchar(10)
	-------------------------------------------------------------------------------------------------------------
	--記錄欄位
	declare @field table(
		noa  nvarchar(20),
		team nvarchar(20),
		unit  nvarchar(20),
		field_mount_header nvarchar(10),
		field_mount nvarchar(10),
		field_money_header nvarchar(10),
		field_money nvarchar(10)
	)
	
	-------------------------------------------------------------------------------------------------------------
	--暫存資料
	IF OBJECT_ID('tempdb..#z_tran12')is not null
	BEGIN
		set @cmd = 'drop table #z_tran12'
		EXECUTE sp_executesql @cmd
	END
	create table #z_tran12(
		gno nvarchar(3),
		salesno nvarchar(20),
		namea nvarchar(20),
		mon nvarchar(10),
		primary key(salesno,mon,gno)
	)
	-------------------------------------------------------------------------------------------------------------
	
	-------------------------------------------------------------------------------------------------------------
	--出車單:客戶金額
	select @n= COUNT(1) from @field

	declare cursor_table cursor for
	select a.noa,a.team,a.unit from carteam a
	left join carteam b on a.noa=b.noa
	left join #carteam c on b.noa=c.noa
	where b.noa=c.noa
	group by a.noa,a.team,a.unit
	open cursor_table
	fetch next from cursor_table
	into @gkey,@gname,@unit
	while(@@FETCH_STATUS <> -1)
	begin
		set @n = @n + 1
		insert into @field(noa,team,unit,field_mount_header,field_mount,field_money_header,field_money)
			values( @gkey,@gname,@unit,
				"a"+right("00"+CONVERT(nvarchar(10),@n),3),
				"b"+right("00"+CONVERT(nvarchar(10),@n),3),
				"c"+right("00"+CONVERT(nvarchar(10),@n),3),
				"d"+right("00"+CONVERT(nvarchar(10),@n),3))
		set @cmd = "alter table #z_tran12 add a"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran12 add b"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran12 add cb"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran12 add c"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran12 add d"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran12 add cd"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		fetch next from cursor_table
		into @gkey,@gname,@unit
	end
	close cursor_table
	deallocate cursor_table
	---------------------------------------------
	--總計
	set @n = @n + 1
	insert into @field(noa,team,unit,field_mount_header,field_mount,field_money_header,field_money)
		values( CHAR(255),'總計',null,
			"a"+right("00"+CONVERT(nvarchar(10),@n),3),
			"b"+right("00"+CONVERT(nvarchar(10),@n),3),
			"c"+right("00"+CONVERT(nvarchar(10),@n),3),
			"d"+right("00"+CONVERT(nvarchar(10),@n),3))
	set @cmd = "alter table #z_tran12 add a"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
	EXECUTE sp_executesql @cmd
	set @cmd = "alter table #z_tran12 add b"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
	EXECUTE sp_executesql @cmd
	set @cmd = "alter table #z_tran12 add cb"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
	EXECUTE sp_executesql @cmd
	set @cmd = "alter table #z_tran12 add c"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
	EXECUTE sp_executesql @cmd
	set @cmd = "alter table #z_tran12 add d"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
	EXECUTE sp_executesql @cmd
	set @cmd = "alter table #z_tran12 add cd"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
	EXECUTE sp_executesql @cmd
	---------------------------------------------
	select @n= COUNT(1) from @field
	while(@n<@minN)
	begin
		set  @n = @n +  1
		insert into @field(noa,team,unit,field_mount_header,field_mount,field_money_header,field_money)
			values( null,null,null,
				"a"+right("00"+CONVERT(nvarchar(10),@n),3),
				"b"+right("00"+CONVERT(nvarchar(10),@n),3),
				"c"+right("00"+CONVERT(nvarchar(10),@n),3),
				"d"+right("00"+CONVERT(nvarchar(10),@n),3))
		set @cmd = "alter table #z_tran12 add a"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran12 add b"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran12 add cb"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran12 add c"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran12 add d"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran12 add cd"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--------------------------------------------------------------------------------------------------------------------
	declare @tmp1 table(
		salesno nvarchar(20),
		mon nvarchar(10),
		carteamno nvarchar(10),
		mount float,
		[money] float
	)

	set @cmd =" select isnull(a.salesno,''),left(a.trandate,6),a.carteamno,"
	if  @t_option1='收金額'
		set  @cmd  =  @cmd  +  "sum(a.mount),sum(round(isnull(a.price*a.mount,0),0)) money"
	else
		set  @cmd  =  @cmd  +  "sum(a.mount2),sum(round(isnull((a.price2+a.price3)*a.mount2,0),0)) money"
	set @cmd =	@cmd  +
		" from view_trans"+@t_accy+" a"+
		" left join #calctype b on a.calctype=b.noa"+
		" left join #carteam c on a.carteamno=c.noa"+
		" where (b.noa  is  not  null) and (c.noa  is  not  null)"+
		" and (len(@t_carno)=0 or a.carno=@t_carno)"+
		" and (a.datea between @t_bdate and @t_edate)"+
		" and (a.trandate between @t_btrandate and @t_etrandate)"+
		" and (a.straddrno between @t_baddr and @t_eaddr)"+
		" and (a.custno between @t_bcustno and @t_ecustno)"+
		" and (a.driverno between @t_bdriverno and @t_edriverno)"+
		" and (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno)"+
		" and (len(@t_po)=0 or a.po=@t_po)"+
		" group by isnull(a.salesno,''),left(a.trandate,6),a.carteamno"
	insert into @tmp1
	EXECUTE sp_executesql @cmd,N'@t_baddr nvarchar(20),@t_eaddr nvarchar(20),@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10),@t_bdriverno nvarchar(20),@t_edriverno nvarchar(20),@t_carno nvarchar(20),@t_bcustno  nvarchar(20),@t_ecustno  nvarchar(20),@t_po nvarchar(30),@t_bsalesno nvarchar(20),@t_esalesno nvarchar(20)',		
	@t_baddr=@t_baddr,@t_eaddr=@t_eaddr,@t_bdate=@t_bdate,@t_edate=@t_edate,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate
	,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_po=@t_po,@t_bsalesno=@t_bsalesno,@t_esalesno=@t_esalesno
	
	-------------------------------------------------------------------------------------------------------------
	
	declare cursor_table cursor for
	select salesno,mon,carteamno,mount,[money] from @tmp1
	open cursor_table
	fetch next from cursor_table
	into @salesno,@mon,@carteamno,@mount,@money
	while(@@FETCH_STATUS <> -1)
	begin
		if exists(select * from @field where noa=@carteamno)
		begin
			select @fieldB='',@fieldD=''
			select @fieldB=field_mount,@fieldD=field_money from @field where noa=@carteamno
			if not  exists(select  *  from  #z_tran12  where  salesno=@salesno and mon=@mon)
			begin
				set @namea=''
				select @namea=namea from sss where noa=@salesno
				insert  into  #z_tran12(gno,salesno,namea,mon)values('0',@salesno,@namea,@mon)
			end
			set  @cmd="update #z_tran12 set "+@fieldB+"=@mount,"+@fieldD+"=@money where gno='0' and salesno=@salesno and mon=@mon"
			execute sp_executesql @cmd,N'@salesno nvarchar(20),@mon  nvarchar(10),@mount  float,@money float'
			,@salesno=@salesno,@mon=@mon,@mount=@mount,@money=@money
		end
		fetch next from cursor_table
		into @salesno,@mon,@carteamno,@mount,@money
	end
	close cursor_table
	deallocate cursor_table
	-------------------------------------------
	--計算總計
	set @result=''

	declare cursor_table cursor for
	select field_money from  @field where noa!=char(255)
	open cursor_table
	fetch next from cursor_table
	into @fieldD
	while(@@FETCH_STATUS <> -1)
	begin
		if LEN(@result)=0
			set @result='isnull('+@fieldD+',0)'
		else
			set @result=@result+'+isnull('+@fieldD+',0)'
		fetch next from cursor_table
		into @fieldD
	end
	close cursor_table
	deallocate cursor_table
	
	select @fieldD=''
	select @fieldD=field_money from  @field where noa=char(255)
	set @result="update #z_tran12 set "+@fieldD+"="+@result
	execute sp_executesql @result
	----------------------------------------------------------------------------------------------------------------------
	--計算小計
	set @result="select '1',char(255),'',''"
	
	declare cursor_table cursor for
	select unit,team,field_mount_header,field_mount,field_money_header,field_money from  @field
	open cursor_table
	fetch next from cursor_table
	into @unit,@team,@fieldA,@fieldB,@fieldC,@fieldD
	while(@@FETCH_STATUS <> -1)
	begin
		set @result = @result+",'',sum("+@fieldB+"),'','',sum("+@fieldD+"),''"
		
		set @cmd = "update #z_tran12 set " +@fieldA+"=@unit,"+@fieldC+"=@team+'/$'"
		execute sp_executesql @cmd,N'@unit nvarchar(20),@team nvarchar(20)',@unit=@unit,@team=@team
		
		fetch next from cursor_table
		into @unit,@team,@fieldA,@fieldB,@fieldC,@fieldD
	end
	close cursor_table
	deallocate cursor_table
	set @result = @result+" from #z_tran12 group by gno"
	insert into #z_tran12
	execute sp_executesql @result
	----------------------------------------------------------------------------------------------------------------------
	declare cursor_table cursor for
	select field_mount,field_money from @field
	open cursor_table
	fetch next from cursor_table
	into @fieldB,@fieldD
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd="update #z_tran12 set c"+@fieldB+"=convert(nvarchar(15),CONVERT(money,"+@fieldB+"),1),"+
						" c"+@fieldD+"=reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,"+@fieldD+"),1)),4,12))"
		EXECUTE sp_executesql @cmd
		fetch next from cursor_table
		into @fieldB,@fieldD
	end
	close cursor_table
	deallocate cursor_table
	
	if len(@t_bdate)>0
		set  @string  =  '登錄日期：'+@t_bdate+'～'+@t_edate
	else
		set  @string   =  '交運日期：'+@t_btrandate+'～'+@t_etrandate
		
	select @string titlea,* from #z_tran12
	drop table #z_tran12;

z_tran14:--z_tran14
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	declare @t_sort08  nvarchar(max)
	declare @t_field05  nvarchar(max)
	declare @t_sort03  nvarchar(max)
	declare @t_sort14  nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	set @t_sort08  = case when '#non'=[27] then '' else [27] end
	set @t_field05  = case when '#non'=[28] then '' else [28] end
	set @t_sort03 = case when '#non'=[29] then '' else [29] end
	set @t_sort14 = case when '#non'=[30] then '' else [30] end
	----------------------------------------------------------------------------------------------
	--解析要計算的種類
	declare @string nvarchar(max)
	declare @n int
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	declare @display table(
		noa nvarchar(20)
	)
	set @string = @t_field05
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into @display select @string
			end
			break
		end
		insert into @display select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	------------------------------------------------------------------------------------------------------------------
	declare  @sortkey  nvarchar(20)
	declare  @title  nvarchar(max)
	declare  @totmount1  float
	declare  @totmount2  float
	declare  @totmount3  float
	declare  @totmoney1  float
	declare  @totmoney2  float
	declare  @totmoney3  float
	declare  @totmoney4  float
	declare  @acomp  nvarchar(30)
	------------------------------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_tran14')is not null
	BEGIN
		set @cmd = 'drop table #z_tran14'
		EXECUTE sp_executesql @cmd
	END
	create table  #z_tran14(
		gno nvarchar(3),
		sortkey nvarchar(20),
		title nvarchar(max),
		acomp nvarchar(30),
		noa nvarchar(20),	
		custno nvarchar(20),
		comp nvarchar(50),
		po nvarchar(20),
		datea nvarchar(20),
		trandate nvarchar(20),
		driverno nvarchar(20),
		driver nvarchar(20),
		straddrno nvarchar(20),
		straddr nvarchar(40),
		productno nvarchar(20),
		product nvarchar(40),
		memo nvarchar(max),
		isoutside int,
		inmount decimal(12, 3),
		pton1 decimal(12, 3),
		mount1 decimal(12, 3),
		price1 decimal(12, 3),
		money1 float,
		outmount decimal(12, 3),
		pton2 decimal(12, 3),
		mount2 decimal(12, 3),
		price2 decimal(12, 3),
		discount decimal(12, 3),
		money2 float,
		totmount1 decimal(12, 3),--客戶
		totmount2 decimal(12, 3),--司機
		totmount3 decimal(12, 3),--外車
		totmoney1 float,--客戶
		totmoney2 float,--司機
		totmoney3 float,--外車
		totmoney4 float,--差額
	)
	
	if(@t_sort14='custno')
		set @cmd = "select '0',a.custno,('客戶：'+rtrim(a.custno)+space(2)+rtrim(a.comp))"
	else
		set @cmd = "select '0',a.custno,('P／O：'+a.po)"

	set @cmd =	@cmd+
		",@t_cno,a.noa,a.custno,a.comp,a.po,a.datea,a.trandate"+
		" ,a.driverno,a.driver,a.straddrno,a.straddr,a.uccno,a.product,a.memo,isnull(e.isoutside,0)"+
		" ,a.inmount,a.pton,a.mount,a.price,a.total"+
		" ,a.outmount,a.pton2,a.mount2,(isnull(a.price2,0)+isnull(a.price3,0)),a.discount,a.total2"+
		" ,0,0,0,0,0,0,0"+
		" from  view_trans"+@t_accy+"  a"+
		" left join #carteam  b on a.carteamno=b.noa"+	
		" left join #calctype c on a.calctype=c.noa"+
		" left join carteam  d on a.carteamno=d.noa"+	
		" left join calctypes e on a.calctype=e.noa+e.noq"+
		" where "+
		" (a.datea  between  @t_bdate  and  @t_edate) and "+
		" (a.trandate between  @t_btrandate  and  @t_etrandate) and "+
		" (a.custno  between  @t_bcustno   and  @t_ecustno) and "+
		" (a.driverno  between  @t_bdriverno   and  @t_edriverno) and "+
		" (len(@t_carno)=0  or  a.carno=@t_carno) and "+
		" (len(@t_po)=0  or  a.po=@t_po) and "+
		" (a.straddrno between @t_baddr and @t_eaddr)  and"+
		" (b.noa  is  not  null) and (c.noa  is  not  null)"
	insert into #z_tran14
	execute sp_executesql @cmd,N'@t_cno nvarchar(40),@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10)
	,@t_bcustno nvarchar(20),@t_ecustno nvarchar(20),@t_bdriverno  nvarchar(20),@t_edriverno  nvarchar(20),@t_carno  nvarchar(20),@t_po  nvarchar(20),@t_baddr  nvarchar(20),@t_eaddr  nvarchar(20)',
		@t_cno=@t_cno,@t_bdate=@t_bdate,@t_edate=@t_edate,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate
		,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_po=@t_po,@t_baddr=@t_baddr,@t_eaddr=@t_eaddr
		
	if(patindex('%in%',@t_option3)=0)
	begin
		update #z_tran14 set discount=1,money2=ROUND(mount2*price2,0) where isoutside=0
	end
	if(patindex('%out%',@t_option3)=0)
	begin
		update #z_tran14 set discount=1,money2=ROUND(mount2*price2,0) where isoutside=1
	end
	
	declare cursor_table cursor for
	select sortkey from #z_tran14  group by sortkey order by sortkey
	open cursor_table
	fetch next from cursor_table
	into @sortkey
	while(@@FETCH_STATUS <> -1)
	begin
		select @title='',@acomp='',@totmount1=0,@totmount2=0,@totmount3=0,@totmoney1=0,@totmoney2=0,@totmoney3=0,@totmoney4=0
		select top 1 @title=title,@acomp=acomp from #z_tran14 where sortkey=@sortkey
		select @totmount1=SUM(mount1)
			,@totmount2=SUM(case when isoutside=0 then mount2 else 0 end) 
			,@totmount3=SUM(case when isoutside=1 then mount2 else 0 end)  
			,@totmoney1=SUM(money1)
			,@totmoney2=SUM(case when isoutside=0 then money2 else 0 end) 
			,@totmoney3=SUM(case when isoutside=1 then money2 else 0 end)
			,@totmoney4=SUM(money1-money2)
		from  #z_tran14  where  sortkey=@sortkey
		insert into #z_tran14(gno,title,acomp,sortkey,totmount1,totmount2,totmount3,totmoney1,totmoney2,totmoney3,totmoney4)
		values('1',@title,@acomp,@sortkey,@totmount1,@totmount2,@totmount3,@totmoney1,@totmoney2,@totmoney3,@totmoney4)
		fetch next from cursor_table
		into @sortkey
	end
	close cursor_table
	deallocate cursor_table
	
	if len(@t_bdate)>0
		set  @string  =  '登錄日期：'+@t_bdate+'～'+@t_edate
	else
		set  @string   =  '交運日期：'+@t_btrandate+'～'+@t_etrandate
		
	select  @string xtitlea, gno,sortkey,acomp,title,trandate tdate,driver dd,straddr addr,product pp,memo
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,(case when mount1<0 then -1 else 1 end)*floor(abs(mount1))),1)),4,12))+RIGHT(cast(mount1 as nvarchar),4) mount1
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,(case when price1<0 then -1 else 1 end)*floor(abs(price1))),1)),4,12))+RIGHT(cast(price1 as nvarchar),4) price1
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,(case when price2<0 then -1 else 1 end)*floor(abs(price2))),1)),4,12))+RIGHT(cast(price2 as nvarchar),4) price2
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,(case when mount2<0 then -1 else 1 end)*floor(abs(mount2))),1)),4,12))+RIGHT(cast(mount2 as nvarchar),4) mount2
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,(case when totmount1<0 then -1 else 1 end)*floor(abs(totmount1))),1)),4,12))+RIGHT(cast(totmount1 as nvarchar),4) totmount1
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,(case when totmount2<0 then -1 else 1 end)*floor(abs(totmount2))),1)),4,12))+RIGHT(cast(totmount2 as nvarchar),4) totmount2
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,(case when totmount3<0 then -1 else 1 end)*floor(abs(totmount3))),1)),4,12))+RIGHT(cast(totmount3 as nvarchar),4) totmount3
		,case when discount=1 then null else discount end disc
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money1),1)),4,12)) money1
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money2),1)),4,12)) money2
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,totmoney1),1)),4,12)) totmoney1
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,totmoney2),1)),4,12)) totmoney2
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,totmoney3),1)),4,12)) totmoney3
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,totmoney4),1)),4,12)) totmoney4
	from #z_tran14 order by sortkey,gno,trandate,noa
	drop table #z_tran14;

z_tran15:--ref.z_tran03
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	declare @t_sort08  nvarchar(max)
	declare @t_field05  nvarchar(max)
	declare @t_sort03  nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	set @t_sort08  = case when '#non'=[27] then '' else [27] end
	set @t_field05  = case when '#non'=[28] then '' else [28] end
	set @t_sort03 = case when '#non'=[29] then '' else [29] end
	----------------------------------------------------------------------------------------------
	--解析要計算的種類
	declare @string nvarchar(max)
	declare @n int
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	declare @display table(
		noa nvarchar(20)
	)
	set @string = @t_field05
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into @display select @string
			end
			break
		end
		insert into @display select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	declare @mount2 float
	declare @total2 float
	declare @drivermoney float
	declare @driverno nvarchar(20)
	declare @carno nvarchar(20)
	declare @noa nvarchar(20)
	declare @x_key nvarchar(20)
	----------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_tran03')is not null
	BEGIN
		set @cmd = 'drop table #z_tran03'
		EXECUTE sp_executesql @cmd
	END
	create table #z_tran03(
		gno nvarchar(3),
		trandate nvarchar(10),
		datea nvarchar(10),
		custno nvarchar(20),
		comp nvarchar(40),
		driverno nvarchar(20),
		namea nvarchar(20),
		carno nvarchar(20),
		straddrno nvarchar(20),
		addr nvarchar(40),
		product nvarchar(40),
		mount decimal(10,3),
		price float,
		total float,
		mount2 decimal(10,3),
		price2 float,
		price3 float,
		discount decimal(10,3),
		total2 float,
		drivermoney float,
		po nvarchar(30),
		caseno nvarchar(30),
		cc  nvarchar(20),
		tt  nvarchar(20),
		noa  nvarchar(20)
	)
	
	set @cmd = 
		" select  '0',a.trandate,a.datea,a.custno,left(a.comp,4),a.driverno,a.driver,a.carno,a.straddrno,a.straddr,a.product,"+
		" a.mount,a.price,a.total,a.mount2,a.price2,a.price3,a.discount,a.total2,round((price2+price3)*mount2,0)"+
		",a.po,a.caseno,e.typea,d.team,a.noa"+
		" from  view_trans"+@t_accy+"  a"+
		" left join #carteam  b on a.carteamno=b.noa"+	
		" left join #calctype c on a.calctype=c.noa"+
		" left join carteam  d on a.carteamno=d.noa"+	
		" left join calctypes e on a.calctype=e.noa+e.noq"+
		" where "+
		" (a.datea  between  @t_bdate  and  @t_edate) and "+
		" (a.trandate  between  @t_btrandate  and  @t_etrandate) and "+
		" (a.custno  between  @t_bcustno   and  @t_ecustno) and "+
		" (a.driverno  between  @t_bdriverno   and  @t_edriverno) and "+
		" (len(@t_carno)=0  or  a.carno=@t_carno) and "+
		" (len(@t_po)=0  or  a.po=@t_po) and "+
		" (a.straddrno between @t_baddr and @t_eaddr) and"+
		" (b.noa  is  not  null) and (c.noa  is  not  null)"
	if @t_sort03='carno'  or @t_sort03='noa' or @t_sort03='driverno' 
		set  @cmd  =  @cmd+" order  by  a.driverno,a.carno,a.noa"
	else
		set  @cmd  =  @cmd+" order  by  a.driverno,a.carno,a.["+@t_sort03+"],a.noa"
	insert into #z_tran03
	execute sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10),@t_bcustno nvarchar(20),@t_ecustno nvarchar(20),@t_bdriverno  nvarchar(20),@t_edriverno  nvarchar(20),@t_carno  nvarchar(20),@t_po  nvarchar(20),@t_baddr  nvarchar(20),@t_eaddr  nvarchar(20)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_po=@t_po,@t_baddr=@t_baddr,@t_eaddr=@t_eaddr
		
	select @mount2=SUM(ISNULL(mount2,0)),@total2=SUM(ISNULL(total2,0)),@drivermoney=SUM(ISNULL(drivermoney,0)) from #z_tran03
	--insert into #z_tran03 (gno,driverno,carno,mount2,total2)values('1',CHAR(255),CHAR(255),@mount2,@total2)
	
	
	if @t_sort03='carno'  or @t_sort03='noa' 
	begin 
		declare cursor_table cursor for
		select driverno,carno,max(noa),sum(isnull(mount2,0)),sum(isnull(total2,0)),SUM(ISNULL(drivermoney,0)) from #z_tran03 where gno='0' group  by  driverno,carno
		open cursor_table
		fetch next from cursor_table
		into @driverno,@carno,@noa,@mount2,@total2,@drivermoney
		while(@@FETCH_STATUS <> -1)
		begin
			insert  into #z_tran03(gno,driverno,carno,noa,mount2,total2,drivermoney)values('1',@driverno,@carno,@noa+CHAR(255),@mount2,@total2,@drivermoney)		
			fetch next from cursor_table
			into @driverno,@carno,@noa,@mount2,@total2,@drivermoney
		end
		close cursor_table
		deallocate cursor_table
	end
	else
	begin
		declare cursor_table cursor for
		select driverno,carno from #z_tran03 where gno='0'  group  by  driverno,carno
		open cursor_table
		fetch next from cursor_table
		into @driverno,@carno
		while(@@FETCH_STATUS <> -1)
		begin
			set @x_key=''
			set @cmd="select @x_key=cast(max("+@t_sort03+") as  nvarchar) from  #z_tran03 where driverno=@driverno and carno=@carno"
			execute sp_executesql @cmd,N'@driverno nvarchar(20),@carno  nvarchar(20),@x_key nvarchar(max) output',@driverno=@driverno,@carno=@carno,@x_key=@x_key output 
			
			set @noa=''
			set @cmd="select @noa=max(noa) from  #z_tran03 where driverno=@driverno and carno=@carno and "+@t_sort03+"=@x_key"
			execute sp_executesql @cmd,N'@driverno nvarchar(20),@carno  nvarchar(20),@x_key nvarchar(max),@noa nvarchar(20) output',@driverno=@driverno,@carno=@carno,@x_key=@x_key,@noa=@noa output
			select @mount2=0,@total2=0
			select @mount2=sum(isnull(mount2,0)),@total2=sum(isnull(total2,0)),@drivermoney=sum(isnull(drivermoney,0)) from #z_tran03 where driverno=@driverno and carno=@carno
			
			set @cmd="insert  into  #z_tran03(gno,driverno,carno,"+@t_sort03+",noa,mount2,total2,drivermoney)values('0',@driverno,@carno,char(255),CHAR(255),@mount2,@total2,@drivermoney)"
			execute sp_executesql @cmd,N'@driverno nvarchar(20),@carno  nvarchar(20),@mount2  float,@total2  float,@drivermoney float',@driverno=@driverno,@carno=@carno,@mount2=@mount2,@total2=@total2,@drivermoney=@drivermoney
			
			fetch next from cursor_table
			into @driverno,@carno
		end
		close cursor_table
		deallocate cursor_table
	end
	
	if len(@t_bdate)>0
		set  @string  =  '登錄日期：'+@t_bdate+'～'+@t_edate
	else
		set  @string   =  '交運日期：'+@t_btrandate+'～'+@t_etrandate
		
	if @t_sort03='carno'  or @t_sort03='noa' or @t_sort03='driverno' 
	begin
		set @cmd = 
			" select @string titlea, gno,trandate  aa,custno bb,driverno mm,namea cc,carno dd,straddrno,addr,product ee,mount2 ff,"+
			" case when price2=0 then price3 else price2 end gg,discount hh,"+
			" reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total2),1)),4,12)) ii,"+
			" caseno jj,case when right(noa,1)=char(255) then '' else noa  end kk, "+
			" reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,drivermoney),1)),4,12)) dm"+
			" from  #z_tran03  order  by driverno,carno,gno,noa"
	end
	else
	begin
		set @cmd = " select @string titlea, gno,trandate  aa,custno bb,driverno mm,namea cc,carno dd,straddrno,addr,product ee,mount2 ff,"+
			" case when price2=0 then price3 else price2 end gg,discount hh,"+
			" reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total2),1)),4,12)) ii,"+
			" caseno jj,noa kk, "+
			" reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,drivermoney),1)),4,12)) dm"+
			" from  #z_tran03  order  by driverno,carno,gno,["+@t_sort03+"],noa"
	end
	EXECUTE sp_executesql @cmd,N'@string nvarchar(max)',@string=@string
	drop table #z_tran03
	drop table #carkind
	drop table #calctype
	drop table #carteam;
	
z_tran03:--z_tran03
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	declare @t_sort08  nvarchar(max)
	declare @t_field05  nvarchar(max)
	declare @t_sort03  nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	set @t_sort08  = case when '#non'=[27] then '' else [27] end
	set @t_field05  = case when '#non'=[28] then '' else [28] end
	set @t_sort03 = case when '#non'=[29] then '' else [29] end
	----------------------------------------------------------------------------------------------
	--解析要計算的種類
	declare @string nvarchar(max)
	declare @n int
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	declare @display table(
		noa nvarchar(20)
	)
	set @string = @t_field05
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into @display select @string
			end
			break
		end
		insert into @display select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	declare @count int
	declare @mount float
	declare @total float
	declare @mount2 float
	declare @total2 float
	declare @drivermoney float
	declare @inmount float
	declare @pton float
	declare @outmount float
	declare @pton2 float
	declare @driverno nvarchar(20)
	declare @carno nvarchar(20)
	declare @noa nvarchar(20)
	declare @x_key nvarchar(20)
	----------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_tran03')is not null
	BEGIN
		set @cmd = 'drop table #z_tran03'
		EXECUTE sp_executesql @cmd
	END
	create table #z_tran03(
		gno nvarchar(3),
		trandate nvarchar(10),
		datea nvarchar(10),
		custno nvarchar(20),
		comp nvarchar(40),
		driverno nvarchar(20),
		namea nvarchar(20),
		carno nvarchar(20),
		straddrno nvarchar(20),
		addr nvarchar(40),
		product nvarchar(40),
		inmount float,
		pton float,
		mount decimal(10,3),
		price decimal(10,3),
		total float,
		outmount decimal(10,3),
		pton2 decimal(10,3),
		mount2 decimal(10,3),
		price2 decimal(10,3),
		price3 decimal(10,3),
		discount decimal(10,3),
		total2 float,
		drivermoney float,
		po nvarchar(30),
		caseno nvarchar(30),
		cc  nvarchar(20),
		tt  nvarchar(20),
		noa  nvarchar(20),
		carcount int,
		ordeno nvarchar(max)
	)
	set @cmd = 
		" select  '0',a.trandate,a.datea,a.custno,left(a.comp,4),a.driverno,a.driver,a.carno,a.straddrno,a.straddr,a.product,"+
		" a.inmount,a.pton,a.mount,a.price,a.total,a.outmount,a.pton2,a.mount2,a.price2,a.price3,a.discount,a.total2,round((price2+price3)*mount2,0)"+
		",a.po,a.caseno,e.typea,d.team,a.noa,0,a.ordeno"+
		" from  view_trans"+@t_accy+"  a"+
		" left join #carteam  b on a.carteamno=b.noa"+	
		" left join #calctype c on a.calctype=c.noa"+
		" left join carteam  d on a.carteamno=d.noa"+	
		" left join calctypes e on a.calctype=e.noa+e.noq"+
		" where "+
		" (a.datea  between  @t_bdate  and  @t_edate) and "+
		" (a.trandate  between  @t_btrandate  and  @t_etrandate) and "+
		" (a.custno  between  @t_bcustno   and  @t_ecustno) and "+
		" (a.driverno  between  @t_bdriverno   and  @t_edriverno) and "+
		" (len(@t_carno)=0  or  a.carno=@t_carno) and "+
		" (len(@t_po)=0  or  a.po=@t_po) and "+
		" (a.straddrno between @t_baddr and @t_eaddr) and"+
		" (b.noa  is  not  null) and (c.noa  is  not  null)"
	if @t_sort03='carno'  or @t_sort03='noa' or @t_sort03='driverno' 
		set  @cmd  =  @cmd+" order  by  a.driverno,a.carno,a.noa"
	else
	begin
		if(@t_sort03='ordeno')
			set  @cmd  =  @cmd+" order  by  a.driverno,a.carno,a.["+@t_sort03+"],a.trandate,a.straddr"
		else
			set  @cmd  =  @cmd+" order  by  a.driverno,a.carno,a.["+@t_sort03+"],a.noa"
	end
		
	insert into #z_tran03
	execute sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10),@t_bcustno nvarchar(20),@t_ecustno nvarchar(20),@t_bdriverno  nvarchar(20),@t_edriverno  nvarchar(20),@t_carno  nvarchar(20),@t_po  nvarchar(20),@t_baddr  nvarchar(20),@t_eaddr  nvarchar(20)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_po=@t_po,@t_baddr=@t_baddr,@t_eaddr=@t_eaddr
		
	select @count=count(1),@mount=SUM(ISNULL(mount,0)),@total=SUM(ISNULL(total,0)),@mount2=SUM(ISNULL(mount2,0)),@total2=SUM(ISNULL(total2,0)),@drivermoney=SUM(ISNULL(drivermoney,0))
	,@outmount=SUM(isnull(outmount,0)),@pton2=SUM(ISNULL(pton2,0))
	,@inmount=SUM(ISNULL(inmount,0)),@pton=SUM(ISNULL(pton,0)) from #z_tran03
	insert into #z_tran03 (gno,driverno,carno,carcount,mount,total,mount2,total2,drivermoney,outmount,pton2,inmount,pton)
	values('2',CHAR(255),CHAR(255),@count,@mount,@total,@mount2,@total2,@drivermoney,@outmount,@pton2,@inmount,@pton) 
	
	
	
	
	if @t_sort03='carno'  or @t_sort03='noa' or @t_sort03='driverno' 
	begin 
		declare cursor_table cursor for
		select driverno,carno,count(1),max(noa),sum(isnull(mount,0)),sum(isnull(total,0)),sum(isnull(mount2,0)),sum(isnull(total2,0)),SUM(ISNULL(drivermoney,0))
		,SUM(isnull(outmount,0)),SUM(ISNULL(pton2,0)) 
		,SUM(isnull(inmount,0)),SUM(ISNULL(pton,0)) 
		from #z_tran03 where gno='0' group  by  driverno,carno
		open cursor_table
		fetch next from cursor_table
		into @driverno,@carno,@count,@noa,@mount,@total,@mount2,@total2,@drivermoney,@outmount,@pton2,@inmount,@pton
		while(@@FETCH_STATUS <> -1)
		begin
			insert  into #z_tran03(gno,driverno,carno,carcount,noa,mount,total,mount2,total2,drivermoney,outmount,pton2,inmount,pton)
			values('1',@driverno,@carno,@count,@noa+CHAR(255),@mount,@total,@mount2,@total2,@drivermoney,@outmount,@pton2,@inmount,@pton)		
			fetch next from cursor_table
			into @driverno,@carno,@count,@noa,@mount,@total,@mount2,@total2,@drivermoney,@outmount,@pton2,@inmount,@pton
		end
		close cursor_table
		deallocate cursor_table
	end
	else
	begin
		declare cursor_table cursor for
		select driverno,carno from #z_tran03 where gno='0'  group  by  driverno,carno
		open cursor_table
		fetch next from cursor_table
		into @driverno,@carno
		while(@@FETCH_STATUS <> -1)
		begin
			set @x_key=''
			set @cmd="select @x_key=cast(max("+@t_sort03+") as  nvarchar) from  #z_tran03 where driverno=@driverno and carno=@carno"
			execute sp_executesql @cmd,N'@driverno nvarchar(20),@carno  nvarchar(20),@x_key nvarchar(max) output',@driverno=@driverno,@carno=@carno,@x_key=@x_key output 
			
			set @noa=''
			set @cmd="select @noa=max(noa) from  #z_tran03 where driverno=@driverno and carno=@carno and "+@t_sort03+"=@x_key"
			execute sp_executesql @cmd,N'@driverno nvarchar(20),@carno  nvarchar(20),@x_key nvarchar(max),@noa nvarchar(20) output',@driverno=@driverno,@carno=@carno,@x_key=@x_key,@noa=@noa output
			select @mount2=0,@total2=0
			select @count=count(1),@mount=sum(isnull(mount,0)),@mount2=sum(isnull(mount2,0)),@total2=sum(isnull(total2,0)),@drivermoney=sum(isnull(drivermoney,0)) 
			,@outmount=SUM(isnull(outmount,0)),@pton2=SUM(ISNULL(pton2,0)),@inmount=SUM(isnull(inmount,0)),@pton=SUM(ISNULL(pton,0))
			from #z_tran03 where gno='0' and driverno=@driverno and carno=@carno
			
			set @cmd="insert  into  #z_tran03(gno,driverno,carno,carcount,"+@t_sort03+",noa,mount,mount2,total2,drivermoney,outmount,pton2,inmount,pton)values('1',@driverno,@carno,@count,char(255),CHAR(255),@mount,@mount2,@total2,@drivermoney,@outmount,@pton2,@inmount,@pton)"
			execute sp_executesql @cmd,N'@driverno nvarchar(20),@carno  nvarchar(20),@mount2  float,@total2  float,@drivermoney float,@outmount float,@pton2 float,@inmount float,@pton float,@mount float,@count int'
			,@driverno=@driverno,@carno=@carno,@mount2=@mount2,@total2=@total2,@drivermoney=@drivermoney,@outmount=@outmount,@pton2=@pton2,@inmount=@inmount,@pton=@pton,@mount=@mount,@count=@count	
			
			fetch next from cursor_table
			into @driverno,@carno
		end
		close cursor_table
		deallocate cursor_table
	end
	
	if len(@t_bdate)>0
		set  @string  =  '登錄日期：'+@t_bdate+'～'+@t_edate
	else
		set  @string   =  '交運日期：'+@t_btrandate+'～'+@t_etrandate
		
	if @t_sort03='carno'  or @t_sort03='noa' or @t_sort03='driverno' 
	begin
		set @cmd = 
			" select @string titlea, gno,trandate  aa,custno bb,driverno mm,namea cc,carno dd,carcount ss,straddrno,addr,product ee,inmount pp1,pton qq1,mount ff1,outmount pp2,pton2 qq2,mount2 ff2,"+
			" price ww,"+
			" reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) vv,"+
			" case when price2=0 then price3 else price2 end gg,discount hh,"+
			" reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total2),1)),4,12)) ii,"+
			" caseno jj,case when right(noa,1)=char(255) then '' else noa  end kk, "+
			" reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,drivermoney),1)),4,12)) dm"+
			" from  #z_tran03  order  by driverno,carno,gno,noa"
	end
	else
	begin
		set @cmd = " select @string titlea, gno,trandate  aa,custno bb,driverno mm,namea cc,carno dd,carcount ss,straddrno,addr,product ee,inmount pp1,pton qq1,mount ff1,outmount pp2,pton2 qq2,mount2 ff2,"+
			" price ww,"+
			" reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) vv,"+
			" case when price2=0 then price3 else price2 end gg,discount hh,"+
			" reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total2),1)),4,12)) ii,"+
			" caseno jj,noa kk, "+
			" reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,drivermoney),1)),4,12)) dm"+
			" from  #z_tran03  order  by driverno,carno,gno,["+@t_sort03+"],noa"
	end
	EXECUTE sp_executesql @cmd,N'@string nvarchar(max)',@string=@string
	drop table #z_tran03
	drop table #carkind
	drop table #calctype
	drop table #carteam;

z_tran11:--z_tran11
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	declare @t_sort08  nvarchar(max)
	declare @t_field05  nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	set @t_sort08  = case when '#non'=[27] then '' else [27] end
	set @t_field05  = case when '#non'=[28] then '' else [28] end
	----------------------------------------------------------------------------------------------
	--解析要計算的種類
	declare @string nvarchar(max)
	declare @n int
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	declare @display table(
		noa nvarchar(20)
	)
	set @string = @t_field05
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into @display select @string
			end
			break
		end
		insert into @display select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------

	declare @t_date nvarchar(10)
	declare @t_bdatea nvarchar(10)
	declare @t_edatea nvarchar(10)
	
	if  LEN(@t_bdate)>0
	begin
		set @t_bdatea = convert(nvarchar(4),convert(int,LEFT(@t_bdate,3))+1911)+'-'+SUBSTRING(@t_bdate,5,2)+'-'+RIGHT(@t_bdate,2)
		set @t_edatea = convert(nvarchar(4),convert(int,LEFT(@t_edate,3))+1911)+'-'+SUBSTRING(@t_edate,5,2)+'-'+RIGHT(@t_edate,2)
		set @t_date=@t_bdatea
	end
	else
	begin
		set @t_bdatea = convert(nvarchar(4),convert(int,LEFT(@t_btrandate,3))+1911)+'-'+SUBSTRING(@t_btrandate,5,2)+'-'+RIGHT(@t_btrandate,2)
		set @t_edatea = convert(nvarchar(4),convert(int,LEFT(@t_etrandate,3))+1911)+'-'+SUBSTRING(@t_etrandate,5,2)+'-'+RIGHT(@t_etrandate,2)
		set @t_date=@t_bdatea
	end

	if(isdate(@t_bdatea)=0 or isdate(@t_edatea)=0)
	begin
		select '0' gno,'' [date],0 mount,'日期錯誤' memo 
		return	
	end
	if(DATEDIFF(MM,@t_bdatea,@t_edatea)>2)
	begin
		select '0' gno,'' [date],0 mount,'查詢區間不可超過三個月' memo 
		return	
	end
	declare @listDate table(
		[date] nvarchar(10),
		[mount] int,
		[memo] nvarchar(max)
	)

	while (@t_date between @t_bdatea and @t_edatea)
	begin
		insert into @listDate select right('00'+convert(nvarchar(3),convert(int,YEAR(@t_date))-1911),3)+'/'+right('0'+convert(nvarchar(2),convert(int,MONTH(@t_date))),2)+'/'+right('0'+convert(nvarchar(2),convert(int,DAY(@t_date))),2),0,''
		set @t_date= convert(date,DATEADD(DD,1,@t_date),111)
	end

	declare @detail table(
		carno nvarchar(20),
		[date] nvarchar(10)
	)
	set @cmd = 
		" select DISTINCT a.carno,a.datea"+
		" from view_trans"+@t_accy+" a"+
		" left join car2 b on b.noa=a.carno"+
		" where b.cartype='2' "+
		" and (a.datea between @t_bdate and @t_edate)"+
		" and (a.trandate between @t_btrandate and @t_etrandate)"+
		" order by a.carno,a.datea"
	insert into @detail
	execute sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10)'
	,@t_bdate=@t_bdate,@t_edate=@t_edate,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate
	declare @tmp table(
		[date] nvarchar(10),
		[memo] nvarchar(max)
	)

	declare @date nvarchar(10)
	declare @carno nvarchar(20)

	declare cursor_table cursor for
	select [date],carno 
	from @listDate listDate,(select carno from @detail group by carno) listCarno
	where not exists(select * from @detail where [date]= listDate.date and carno=listCarno.carno)
	open cursor_table
	fetch next from cursor_table
	into @date,@carno
	while(@@FETCH_STATUS <> -1)
	begin
		update top(1) @listDate set mount=mount+1,memo=memo+@carno+',' where [date]=@date
		fetch next from cursor_table
		into @date,@carno
	end
	close cursor_table
	deallocate cursor_table

	if len(@t_bdate)>0
		set  @cmd  =  '登錄日期：'+@t_bdate+'～'+@t_edate
	else
		set  @cmd  =  '交運日期：'+@t_btrandate+'～'+@t_etrandate
	select @cmd titlea,'0' gno,[date],mount,case when len(memo)>0 then LEFT(memo,len(memo)-1) else memo end memo from @listDate;

z_tran10:--z_tran10
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	declare @t_sort08  nvarchar(max)
	declare @t_field05  nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	set @t_sort08  = case when '#non'=[27] then '' else [27] end
	set @t_field05  = case when '#non'=[28] then '' else [28] end
	----------------------------------------------------------------------------------------------
	--解析要計算的種類
	declare @string nvarchar(max)
	declare @n int
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	declare @display table(
		noa nvarchar(20)
	)
	set @string = @t_field05
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into @display select @string
			end
			break
		end
		insert into @display select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	declare @carno nvarchar(20) 
	declare @driverno nvarchar(20)
	declare @driver nvarchar(20)
	declare @carkindno nvarchar(20)
	declare @carkind nvarchar(20)
	declare @money float
	declare @mount float
	declare @miles float
	declare @caryear nvarchar(20)
	declare @carbrand nvarchar(20)
	-------------------------------------------------------------------------------------------------------------
	declare @tmp1 table(
		carno nvarchar(20),
		carkindno nvarchar(20),
		carkind nvarchar(20),
		driverno nvarchar(20),
		datea nvarchar(10),
		[money] float,
		miles float
	)
	set @cmd = " select a.carno,d.noa,d.kind,a.driverno,a.datea,"
	if @t_option1='收金額'
		set @cmd = @cmd +" sum(round(isnull(a.price*a.mount,0),0)) total,"
	else
		set @cmd = @cmd +" sum(round(isnull(a.price2*a.mount2,0),0)) total,"
	set @cmd = @cmd +
		" sum(round(a.miles,0))"+
		" from view_trans"+@t_accy+" a"+
		" left join car2 b on a.carno=b.carno"+
		" left join #carkind c on b.carkindno=c.noa"+
		" left join carkind d on d.noa=c.noa"+
		" left join calctypes e on e.noa+e.noq=a.calctype"+
		" where (c.noa is not  null) and isnull(e.isoutside,0)=0"+
		" and (a.datea between @t_bdate and @t_edate)"+
		" and (len(@t_carno)=0 or a.carno=@t_carno)"+
		" group by a.carno,d.noa,d.kind,a.driverno,a.datea"	
	insert into @tmp1
	EXECUTE sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_carno nvarchar(20)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_carno=@t_carno

	declare @tmp2 table(
		carno nvarchar(20),
		carkindno nvarchar(20),
		carkind nvarchar(20),
		driverno nvarchar(20),
		mount float,
		[money] float
	)
	set @cmd=
		" select a.carno,f.noa,f.kind,a.driverno,sum(isnull(a.mount,0)),sum(isnull(a.money,0)) from oil a"+
		" left join car2 d on a.carno=d.carno"+
		" left join #carkind e on d.carkindno=e.noa"+
		" left join carkind f on f.noa=e.noa"+
		" where (e.noa is not null)"+ 
		" and (a.datea between @t_bdate and @t_edate)"+
		" and (isnull(a.mount,0)>0 or isnull(a.money,0)>0) "+
		" and (len(@t_carno)=0 or a.carno=@t_carno)"+
		" group by a.carno,f.noa,f.kind,a.driverno"	
	insert into @tmp2	
	EXECUTE sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_carno nvarchar(20)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_carno=@t_carno	
	------------------------------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_tran10')is not null
	BEGIN
		set @cmd = 'drop table #z_tran10'
		EXECUTE sp_executesql @cmd
	END
	create table #z_tran10(
		gno nvarchar(3),
		carno nvarchar(20),
		carkindno  nvarchar(20),
		carkind  nvarchar(20),
		driverno nvarchar(20),
		driver nvarchar(20),
		[money] float,
		cmoney nvarchar(20),
		oilmount float,
		oilmoney float,
		coilmoney nvarchar(20),
		rate1 nvarchar(20),
		[day] int,
		miles float,
		rate2 nvarchar(20),
		caryear nvarchar(10),
		carbrand nvarchar(20)
	)

	declare cursor_table cursor for
	select carno,carkindno,carkind,driverno,sum([money]),sum(miles) from @tmp1 group by carno,carkindno,carkind,driverno
	open cursor_table
	fetch next from cursor_table
	into @carno,@carkindno,@carkind,@driverno,@money,@miles
	while(@@FETCH_STATUS <> -1)
	begin
		set @driver=''
		select @driver=namea from driver where noa=@driverno
		set @n = 0
		select @n=count(*) from (select distinct datea from @tmp1 where carno=@carno and driverno=@driverno )as a
		insert into #z_tran10(gno,carno,carkindno,carkind,driverno,driver,[day],[money],miles)values('0',@carno,@carkindno,@carkind,@driverno,@driver,@n,@money,@miles)
		fetch next from cursor_table
		into @carno,@carkindno,@carkind,@driverno,@money,@miles
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,carkindno,carkind,driverno,mount,[money] from @tmp2
	open cursor_table
	fetch next from cursor_table
	into @carno,@carkindno,@carkind,@driverno,@mount,@money
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select * from #z_tran10 where carno=@carno and driverno=@driverno)
		begin
			set @driver=''
			select @driver=namea from driver where noa=@driverno
			insert into #z_tran10(gno,carno,carkindno,carkind,driverno,driver)values('0',@carno,@carkindno,@carkind,@driverno,@driver)
		end
		update top(1) #z_tran10 set oilmount=@mount,oilmoney=@money where carno=@carno and driverno=@driverno
		fetch next from cursor_table
		into @carno,@carkindno,@carkind,@driverno,@mount,@money
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno from #z_tran10 group by carno
	open cursor_table
	fetch next from cursor_table
	into @carno
	while(@@FETCH_STATUS <> -1)
	begin
		select @caryear = '',@carbrand=''
		select @caryear=a.caryear,@carbrand=isnull(b.brand,'') from car2 a left join carbrand b on a.carbrandno=b.noa where a.carno=@carno
		
		update #z_tran10 set caryear=@caryear,carbrand=@carbrand,
			cmoney=reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,[money]),1)),4,12)),
			coilmoney=reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,oilmoney),1)),4,12)),
			rate1=convert(varchar(15),case when [money]=0 then 0 else ROUND(oilmoney/[money]*100,0) end),
			rate2=convert(varchar(15),convert(decimal(10, 3),case when oilmount=0 then 0 else ROUND(miles/oilmount,3) end)) 
		where carno=@carno
		
		fetch next from cursor_table
		into @carno
	end
	close cursor_table
	deallocate cursor_table
	
	insert into #z_tran10(gno,carkindno,[money],oilmount,oilmoney,miles)
	select '1',CHAR(255),SUM(ISNULL([money],0)),SUM(ISNULL(oilmount,0))
	,SUM(ISNULL(oilmoney,0)),SUM(ISNULL(miles,0)) from #z_tran10
	update #z_tran10 set cmoney=reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,[money]),1)),4,12)),
			coilmoney=reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,oilmoney),1)),4,12)),
			rate1=convert(varchar(15),case when [money]=0 then 0 else ROUND(oilmoney/[money]*100,0) end),
			rate2=convert(varchar(15),convert(decimal(10, 3),case when oilmount=0 then 0 else ROUND(miles/oilmount,3) end)) 
	where gno='1'
	
	select gno,ROW_NUMBER()over(order by carkindno,caryear,carno) rr
	,carkind  a,caryear b,carno c,driver d,carbrand e,
	cmoney f,coilmoney g,cast(rate1 as nvarchar)+'%' h,[day] i,rate2 j 
	from #z_tran10 order by carkindno,caryear,carno
	
	drop table #z_tran10;

z_tran05:--z_tran05
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	declare @t_sort08  nvarchar(max)
	declare @t_field05  nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	set @t_sort08  = case when '#non'=[27] then '' else [27] end
	set @t_field05  = case when '#non'=[28] then '' else [28] end
	----------------------------------------------------------------------------------------------
	--解析要計算的種類
	declare @string nvarchar(max)
	declare @n int
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	declare @display table(
		noa nvarchar(20)
	)
	set @string = @t_field05
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into @display select @string
			end
			break
		end
		insert into @display select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	declare @fieldh nvarchar(20)
	declare @fieldm nvarchar(20)
	declare @fieldm2 nvarchar(20)
	declare @minN int
	set @minN = 22
	declare @calctypeno nvarchar(10)
	declare @carkind nvarchar(20)
	declare @carkindno nvarchar(10)
	declare @carno nvarchar(20)
	declare @caryear nvarchar(20)
	declare @cylinder int
	declare @day int
	declare @driver nvarchar(20)
	declare @driverno nvarchar(20)
	declare @header nvarchar(20)
	declare @isDiscount int
	declare @miles float
	declare @mon nvarchar(10)
	declare @money float
	declare @money2 float
	declare @mount float
	declare @namea nvarchar(30)
	declare @noa nvarchar(30)
	declare @product float
	declare @reserve float
	declare @sort nvarchar(max)
	declare @tolls float
	declare @tax float
	-------------------------------------------------------------------------------------------------------------
	--記錄欄位
	declare @field table(
		[key] nvarchar(20),
		fieldh nvarchar(10),
		fieldm nvarchar(10),
		[header] nvarchar(40),
		product float,
		isSum bit,
		sort nvarchar(10)
	)
	-------------------------------------------------------------------------------------------------------------
	--暫存資料
	IF OBJECT_ID('tempdb..#z_tran05')is not null
	BEGIN
		set @cmd = 'drop table #z_tran05'
		EXECUTE sp_executesql @cmd
	END
	create table #z_tran05(
		gno nvarchar(3),
		carno nvarchar(20),
		carkindno nvarchar(20),
		driverno nvarchar(20),
		mon nvarchar(20),
		tranmoney float,
		miles float,
		oilmount float,
		oilmoney float,
		rowheader nvarchar(20)
		
		primary key(carkindno,carno,driverno,mon)
	)
	-------------------------------------------------------------------------------------------------------------
	--車輛種類
	if exists(select * from @display where noa='carkind')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product)
			values('carkind',@fieldh,@fieldm,'類別',0)
		
		set @cmd = "alter table #z_tran05 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--年份
	if exists(select * from @display where noa='caryear')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product)
			values('caryear',@fieldh,@fieldm,'年份',0)
		
		set @cmd = "alter table #z_tran05 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--汽缸
	if exists(select * from @display where noa='cylinder')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product)
			values('cylinder',@fieldh,@fieldm,'汽缸',0)
		
		set @cmd = "alter table #z_tran05 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--耗油比
	if exists(select * from @display where noa='rate1')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,sort)
			values('rate1',@fieldh,@fieldm,'耗油比',0,@fieldm+' desc')
		
		set @cmd = "alter table #z_tran05 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--日數
	if exists(select * from @display where noa='day')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,sort)
			values('day',@fieldh,@fieldm,'日數',0,@fieldm+' desc')
		
		set @cmd = "alter table #z_tran05 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--公里/升
	if exists(select * from @display where noa='rate2')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,sort)
			values('rate2',@fieldh,@fieldm,'公里/升',0,@fieldm+' desc')
		
		set @cmd = "alter table #z_tran05 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--車牌
	if exists(select * from @display where noa='carno')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product)
			values('carno',@fieldh,@fieldm,'車牌',0)
		
		set @cmd = "alter table #z_tran05 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--司機
	if exists(select * from @display where noa='driver')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product)
			values('driver',@fieldh,@fieldm,'司機',0)
		
		set @cmd = "alter table #z_tran05 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--月份
	if exists(select * from @display where noa='mon')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product)
			values('mon',@fieldh,@fieldm,'月份',0)
		
		set @cmd = "alter table #z_tran05 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--收入
	if exists(select * from @display where noa='tranmoney')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('tranmoney',@fieldh,@fieldm,'收入',1,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_tran05 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
	end
	--油量
	if exists(select * from @display where noa='oilmount')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('oilmount',@fieldh,@fieldm,'油量',0,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_tran05 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
	end
	--油費
	if exists(select * from @display where noa='oil')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('oil',@fieldh,@fieldm,'油費',-1,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_tran05 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
	end
	--修理費
	if exists(select * from @display where noa='fixa')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('fixa',@fieldh,@fieldm,'修理費',-1,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_tran05 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
		
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('fixa2',@fieldh,@fieldm,'板修理費',-1,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_tran05 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
	end
	--輪胎費
	if exists(select * from @display where noa='tire')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('tire',@fieldh,@fieldm,'輪胎費',-1,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_tran05 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
		
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('tire2',@fieldh,@fieldm,'板輪胎費',-1,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_tran05 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
	end
	--通行費
	if exists(select * from @display where noa='tolls')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('tolls',@fieldh,@fieldm,'通行費',-1,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_tran05 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
	end
	--罰款
	if exists(select * from @display where noa='ticket')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('ticket',@fieldh,@fieldm,'罰款',-1,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_tran05 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
	end
	--寄櫃費
	if exists(select * from @display where noa='reserve')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('reserve',@fieldh,@fieldm,'寄櫃費',-1,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_tran05 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
	end
	--薪資
	if exists(select * from @display where noa='carsal')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('carsal',@fieldh,@fieldm,'薪資',-1,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_tran05 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
	end
	--保牌燃費
	if exists(select * from @display where noa='tax')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('tax',@fieldh,@fieldm,'保牌燃費',-1,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_tran05 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
	end
	--折舊
	if exists(select * from @display where noa='depreciation')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('depreciation',@fieldh,@fieldm,'折舊',-1,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_tran05 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
	end
	--淨利
	if exists(select * from @display where noa='profit')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('profit',@fieldh,@fieldm,'淨利',0,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_tran05 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
	end
	--**
	select @n= COUNT(1) from @field
	while(@n<@minN)
	begin
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		insert into @field([key],fieldh,fieldm,[header],product,isSum)
			values(null,@fieldh,@fieldm,null,null,null)
		
		set @cmd = "alter table #z_tran05 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran05 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--************************************************************************************************************
	--出車單: 收入
	declare @tmp1 table(
		carkindno nvarchar(20),
		carno nvarchar(20),
		driverno nvarchar(20),
		datea nvarchar(20),
		[money] float,
		miles float,
		reserve float
	)
	set @cmd =
		" select isnull(e.carkindno,''),a.carno,a.driverno,isnull(a.datea,''),"
	if @t_option1='收金額'	
		set @cmd =  @cmd+" sum(isnull(round(a.price*a.mount,0),0)) [money],"
	else
		set @cmd =  @cmd+" sum(isnull(round((a.price2+a.price3)*a.mount2,0),0)) [money],"
	set @cmd =  @cmd+
		" sum(isnull(a.miles,0)) miles,"+
		" sum(isnull(a.reserve,0)) reserve"+
		" from view_trans"+@t_accy+" a"+
		" left join #calctype b on a.calctype=b.noa"+
		" left join calctype c on left(a.calctype,1)=c.noa"+
		" left join car2 e on a.carno=e.noa"+
		" left join #carkind f on e.carkindno=f.noa"+
		" where a.calctype=b.noa and (not f.noa is null)"+
		" and (len(@t_carno)=0 or a.carno=@t_carno)"+
		" and (a.datea between @t_bdate and @t_edate)"+
		" and (a.custno between @t_bcustno and @t_ecustno)"+
		" and (a.driverno between @t_bdriverno and @t_edriverno)"+
		" and (len(@t_po)=0 or a.po=@t_po)"+
		" group by isnull(e.carkindno,''),a.carno,a.driverno,a.datea,c.noa"	
	insert into @tmp1
	EXECUTE sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bdriverno nvarchar(20),@t_edriverno nvarchar(20),@t_carno nvarchar(20),@t_bcustno  nvarchar(20),@t_ecustno  nvarchar(20),@t_po  nvarchar(30)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_po=@t_po

	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='tranmoney'

	declare cursor_table cursor for
	select carkindno,carno,driverno,left(datea,6),sum([money]),sum(miles) from @tmp1 where [money]!=0 group by carkindno,carno,driverno,left(datea,6)
	open cursor_table
	fetch next from cursor_table
	into @carkindno,@carno,@driverno,@mon,@money,@miles
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select * from #z_tran05 where carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon)
		begin
			insert into #z_tran05(gno,carno,carkindno,driverno,mon)values('0',@carno,@carkindno,@driverno,@mon)
		end
		
		if LEN(@fieldm)>0
		begin
			set @cmd = "update #z_tran05 set tranmoney=isnull(tranmoney,0)+@money,miles=isnull(miles,0)+@miles,"+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@money),1)),4,12)),m"+@fieldm+"=@money where gno='0' and carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon"
			execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10),@money float,@miles float',
				@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon,@money=@money,@miles=@miles
		end
		
		fetch next from cursor_table
		into @carkindno,@carno,@driverno,@mon,@money,@miles
	end
	close cursor_table
	deallocate cursor_table
	
	------------------------------------------------------------------------------------------------------------------
	--加油
	declare @tmp2 table(
		carkindno nvarchar(20),
		carno nvarchar(20),
		driverno nvarchar(20),
		mon nvarchar(20),
		mount float,
		[money] float
	)
	
	set @cmd =
		" select isnull(e.carkindno,''),a.carno,a.driverno,left(a.datea,6),"+
		" sum(isnull(a.mount,0)) mount,"+
		" sum(isnull(a.money,0)) [money]"+
		" from oil a"+
		" left join car2 e on a.carno=e.noa"+
		" left join #carkind f on e.carkindno=f.noa"+
		" where (not f.noa is null)"+
		" and (len(@t_carno)=0 or a.carno=@t_carno)"+
		" and (a.datea between @t_bdate and @t_edate)"+
		" and (a.driverno between @t_bdriverno and @t_edriverno)"+
		" group by isnull(e.carkindno,''),a.carno,a.driverno,left(a.datea,6)"	
	insert into @tmp2
	EXECUTE sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bdriverno nvarchar(20),@t_edriverno nvarchar(20),@t_carno nvarchar(20),@t_bcustno  nvarchar(20),@t_ecustno  nvarchar(20),@t_po  nvarchar(30)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_po=@t_po
	
	
	declare cursor_table cursor for
	select carkindno,carno,driverno,mon,mount,[money] from @tmp2 where mount!=0 and [money]!=0
	open cursor_table
	fetch next from cursor_table
	into @carkindno,@carno,@driverno,@mon,@mount,@money
	while(@@FETCH_STATUS <> -1)
	begin
		
		if not exists(select * from #z_tran05 where carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon)
		begin
			insert into #z_tran05(gno,carno,carkindno,driverno,mon)values('0',@carno,@carkindno,@driverno,@mon)
		end
		set @cmd = "update #z_tran05 set oilmount=@mount,oilmoney=@money where gno='0' and carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon"
		execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10),@mount float,@money float',
			@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon,@mount=@mount,@money=@money
				
		set @fieldm=''
		select @fieldm=fieldm from @field where [key]='oil'
		if LEN(@fieldm)>0
		begin
			set @cmd = "update #z_tran05 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@money),1)),4,12)),m"+@fieldm+"=@money where gno='0' and carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon"
			execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10),@mount float,@money float',
				@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon,@mount=@mount,@money=@money
		end
		set @fieldm=''
		select @fieldm=fieldm from @field where [key]='oilmount'
		if LEN(@fieldm)>0
		begin
		
			set @cmd = "update #z_tran05 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@mount),1)),4,12)),m"+@fieldm+"=@mount where gno='0' and carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon"
			execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10),@mount float,@money float',
				@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon,@mount=@mount,@money=@money
		end

		fetch next from cursor_table
		into @carkindno,@carno,@driverno,@mon,@mount,@money
	end
	close cursor_table
	deallocate cursor_table
	------------------------------------------------------------------------------------------------------------------
	
	--公里/升,耗油比
	update #z_tran05 set tranmoney=isnull(tranmoney,0),miles=ISNULL(miles,0),oilmount=ISNULL(oilmount,0),oilmoney=ISNULL(oilmoney,0)
	set @fieldm=''
	select @fieldm=fieldm from @field where [key]='rate1'
	if LEN(@fieldm)>0
	begin
		set @cmd="update #z_tran05 set "+@fieldm+"=case when tranmoney=0 then '0 %' else convert(char(6),round(oilmoney/tranmoney*100,0))+' %' end"
		execute sp_executesql @cmd
	end
	
	set @fieldm=''
	select @fieldm=fieldm from @field where [key]='rate2'
	if LEN(@fieldm)>0
	begin
		set @cmd="update #z_tran05 set "+@fieldm+"=case when oilmount=0 then '' else convert(char(6),CAST(round(miles/oilmount,3) as decimal(10,3))) end"
		execute sp_executesql @cmd
	end
	------------------------------------------------------------------------------------------------------------------
	--通行費
	if exists(select * from @field where [key]='tolls')
	begin
		declare  @tmp3  table(
			carkindno nvarchar(20),
			carno nvarchar(20),
			driverno nvarchar(20),
			mon nvarchar(20),
			tolls float
		)
		set @cmd=
		" select c.noa,a.carno,a.driverno,left(a.datea,6),sum(ISNULL(money,0))"+ 
		" from etc a"+
		" left  join  car2 b  on  a.carno=b.carno"+
		" left  join  #carKind  c  on  b.carkindno=c.noa"+
		" where  (c.noa  is  not  null)  and  (a.typea='ETC' or  a.typea='CASH')"+
		" and (a.datea  between  @t_bdate  and  @t_edate)"+
		" and (len(@t_carno)=0 or a.carno=@t_carno)"+
		" and (a.driverno between @t_bdriverno and @t_edriverno)"+
		" group by c.noa,a.carno,a.driverno,left(a.datea,6)"
		
		insert  into  @tmp3
		execute  sp_executesql  @cmd,N'@t_bdate  nvarchar(10),@t_edate  nvarchar(10),@t_carno  nvarchar(20),@t_bdriverno  nvarchar(20),@t_edriverno  nvarchar(20)'
		,@t_bdate=@t_bdate,@t_edate=@t_edate,@t_carno=@t_carno,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno
		
		set @fieldm = ''
		select @fieldm=fieldm from @field where [key]='tolls'
			
		declare cursor_table cursor for
		select carkindno,carno,driverno,mon,tolls from @tmp3 where tolls!=0
		open cursor_table
		fetch next from cursor_table
		into @carkindno,@carno,@driverno,@mon,@tolls
		while(@@FETCH_STATUS <> -1)
		begin
			if not exists(select * from #z_tran05 where carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon)
			begin
				insert into #z_tran05(gno,carno,carkindno,driverno,mon)values('0',@carno,@carkindno,@driverno,@mon)
			end

			if LEN(@fieldm)>0
			begin
				set @cmd = "update #z_tran05 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@tolls),1)),4,12)),m"+@fieldm+"=@tolls where gno='0' and carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon"
				execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10),@tolls float',
					@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon,@tolls=@tolls
			end
			
			fetch next from cursor_table
			into @carkindno,@carno,@driverno,@mon,@tolls
		end
		close cursor_table
		deallocate cursor_table
	end
	--寄櫃費
	if exists(select * from @field where [key]='reserve')
	begin
		set @fieldm = ''
		select @fieldm=fieldm from @field where [key]='reserve'
			
		declare cursor_table cursor for
		select carkindno,carno,driverno,left(datea,6),sum(isnull(reserve,0)) from @tmp1 group  by  carkindno,carno,driverno,left(datea,6)
		open cursor_table
		fetch next from cursor_table
		into @carkindno,@carno,@driverno,@mon,@reserve
		while(@@FETCH_STATUS <> -1)
		begin
			if not exists(select * from #z_tran05 where carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon)
			begin
				insert into #z_tran05(gno,carno,carkindno,driverno,mon)values('0',@carno,@carkindno,@driverno,@mon)
			end

			if LEN(@fieldm)>0
			begin
				set @cmd = "update #z_tran05 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@reserve),1)),4,12)),m"+@fieldm+"=@reserve where gno='0' and carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon"
				execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10),@reserve float',
					@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon,@reserve=@reserve
			end
			
			fetch next from cursor_table
			into @carkindno,@carno,@driverno,@mon,@reserve
		end
		close cursor_table
		deallocate cursor_table
	end

	------------------------------------------------------------------------------------------------------------------
	--罰款
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='ticket'
	if LEN(@fieldm)>0
	begin
		declare @tmp4 table(
			carkindno nvarchar(20),
			carno nvarchar(20),
			driverno nvarchar(20),
			mon nvarchar(20),
			[money] float
		)
		set @cmd=
			" select isnull(e.carkindno,''),a.carno,a.driverno,mon,"+
			" SUM(isnull(a.comppay,0))"+  
			" from carborr a  "+
			" left join car2 e on a.carno=e.noa"+
			" left join #carkind f on e.carkindno=f.noa"+
			" where a.typea='罰單' and isnull(a.comppay,0)>0 and (not f.noa is null)"+
			" and (len(@t_carno)=0 or a.carno=@t_carno)"+
			" and (a.mon between left(@t_bdate,6) and left(@t_edate,6))"+
			" and (a.driverno between @t_bdriverno and @t_edriverno)"+
			" group by isnull(e.carkindno,''),a.carno,a.driverno,mon"
		insert @tmp4
		EXECUTE sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bdriverno nvarchar(20),@t_edriverno nvarchar(20),@t_carno nvarchar(20),@t_bcustno  nvarchar(20),@t_ecustno  nvarchar(20),@t_po  nvarchar(30)',
			@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_po=@t_po
		
		declare cursor_table cursor for
		select carkindno,carno,driverno,mon,[money] from @tmp4 where [money]!=0
		open cursor_table
		fetch next from cursor_table
		into @carkindno,@carno,@driverno,@mon,@money
		while(@@FETCH_STATUS <> -1)
		begin
			if not exists(select * from #z_tran05 where carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon)
			begin
				insert into #z_tran05(gno,carno,carkindno,driverno,mon)values('0',@carno,@carkindno,@driverno,@mon)
			end
			set @cmd = "update #z_tran05 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@money),1)),4,12)),m"+@fieldm+"=@money where gno='0' and carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon"
			execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10),@money float',
				@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon,@money=@money
			fetch next from cursor_table
			into @carkindno,@carno,@driverno,@mon,@money
		end
		close cursor_table
		deallocate cursor_table
	end
	------------------------------------------------------------------------------------------------------------------
	--修理費
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='fixa'
	set @fieldm2 = ''
	select @fieldm2=fieldm from @field where [key]='fixa2'
	if LEN(@fieldm)>0
	begin
		declare cursor_table cursor for
		select isnull(e.carkindno,'') carkindno,a.carno,a.driverno,LEFT(datea,6)  mon
		 ,SUM(case when len(isnull(a.carplateno,''))=0 then isnull(a.wmoney,0) else 0 end) 
		 ,SUM(case when len(isnull(a.carplateno,''))>0 then isnull(a.wmoney,0) else 0 end)
		 from fixa a 
		 left join car2 e on a.carno=e.noa
		 left join #carkind f on e.carkindno=f.noa
		 where 
		 isnull(a.wmoney,0)>0 and (not f.noa is null)
		 and (len(@t_carno)=0 or a.carno=@t_carno)
		 and (a.datea between @t_bdate and @t_edate)
		 and (a.driverno between @t_bdriverno and @t_edriverno)
		 group by isnull(e.carkindno,''),a.carno,a.driverno,LEFT(datea,6)
		open cursor_table
		fetch next from cursor_table
		into @carkindno,@carno,@driverno,@mon,@money,@money2
		while(@@FETCH_STATUS <> -1)
		begin
			if not exists(select *  from  #z_tran05 where carkindno=@carkindno and carno=@carno and driverno=@driverno and mon=@mon)
			begin
				insert into #z_tran05(gno,carkindno,carno,driverno,mon)values('0',@carkindno,@carno,@driverno,@mon)
			end
			set @cmd = "update #z_tran05 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@money),1)),4,12)),m"+@fieldm+"=@money "
			+","+@fieldm2+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@money2),1)),4,12)),m"+@fieldm2+"=@money2 "
			+"where gno='0' and carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon"
			execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10),@money float,@money2 float',
				@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon,@money=@money,@money2=@money2
	
			fetch next from cursor_table
			into @carkindno,@carno,@driverno,@mon,@money,@money2
		end
		close cursor_table
		deallocate cursor_table
	end
	------------------------------------------------------------------------------------------------------------------
	--輪胎費
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='tire'
	set @fieldm2 = ''
	select @fieldm2=fieldm from @field where [key]='tire2'
	if LEN(@fieldm)>0
	begin
		declare cursor_table cursor for
		select isnull(e.carkindno,'') carkindno,a.carno,a.driverno,LEFT(datea,6)  mon
		 ,SUM(case when len(isnull(a.carplateno,''))=0 then isnull(a.cmoney,0) else 0 end) 
		 ,SUM(case when len(isnull(a.carplateno,''))>0 then isnull(a.cmoney,0) else 0 end) 
		 from fixa a 
		 left join car2 e on a.carno=e.noa
		 left join #carkind f on e.carkindno=f.noa
		 where 
		 isnull(a.cmoney,0)>0 and (not f.noa is null)
		 and (len(@t_carno)=0 or a.carno=@t_carno)
		 and (a.datea between @t_bdate and @t_edate)
		 and (a.driverno between @t_bdriverno and @t_edriverno)
		 group by isnull(e.carkindno,''),a.carno,a.driverno,LEFT(datea,6)
		open cursor_table
		fetch next from cursor_table
		into @carkindno,@carno,@driverno,@mon,@money,@money2
		while(@@FETCH_STATUS <> -1)
		begin
			if not exists(select *  from  #z_tran05 where carkindno=@carkindno and carno=@carno and driverno=@driverno and mon=@mon)
			begin
				insert into #z_tran05(gno,carkindno,carno,driverno,mon)values('0',@carkindno,@carno,@driverno,@mon)
			end
			set @cmd = "update #z_tran05 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@money),1)),4,12)),m"+@fieldm+"=@money "
			+","+@fieldm2+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@money2),1)),4,12)),m"+@fieldm2+"=@money2 "
			+"where gno='0' and carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon"
			
			execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10),@money float,@money2 float',
				@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon,@money=@money,@money2=@money2
	
			fetch next from cursor_table
			into @carkindno,@carno,@driverno,@mon,@money,@money2
		end
		close cursor_table
		deallocate cursor_table
	end
	------------------------------------------------------------------------------------------------------------------
	declare @field_tranmoney nvarchar(20)
	set @field_tranmoney=''
	select @field_tranmoney=fieldm from @field where [key]='tranmoney'
	
	--折舊
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='depreciation'
	if LEN(@fieldm)>0
	begin
		declare cursor_table cursor for
		select carno,isnull(depreciation,0) from car2 
		open cursor_table
		fetch next from cursor_table
		into @carno,@money
		while(@@FETCH_STATUS <> -1)
		begin
			declare cursor_table2 cursor for
			select mon  from  #z_tran05 where carno=@carno group by mon
			open cursor_table2
			fetch next from cursor_table2
			into @mon
			while(@@FETCH_STATUS <> -1)
			begin
				select @driverno=''
				set @cmd =" select top(1) @driverno=driverno  from  #z_tran05  where  carno=@carno  and  mon=@mon order  by "+@field_tranmoney+"  desc"  
				execute sp_executesql @cmd,N'@carno nvarchar(20),@driverno nvarchar(20)  out,@mon nvarchar(10)'
				,@carno=@carno ,@driverno=@driverno out,@mon=@mon
			
				set @cmd = "update top(1) #z_tran05 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@money),1)),4,12)),m"+@fieldm+"=@money where gno='0' and carno=@carno and mon=@mon  and  driverno=@driverno" 
				execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10),@money float',
					@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon,@money=@money
				fetch next from cursor_table2
				into @mon
			end
			close cursor_table2
			deallocate cursor_table2

			fetch next from cursor_table
			into @carno,@money
		end
		close cursor_table
		deallocate cursor_table
	end
	------------------------------------------------------------------------------------------------------------------
	--保牌燃費
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='tax'
	if LEN(@fieldm)>0
	begin
		declare cursor_table cursor for
		select carno,isnull(tax,0) from car2 
		open cursor_table
		fetch next from cursor_table
		into @carno,@money
		while(@@FETCH_STATUS <> -1)
		begin
			declare cursor_table2 cursor for
			select mon  from  #z_tran05 where carno=@carno group by mon
			open cursor_table2
			fetch next from cursor_table2
			into @mon
			while(@@FETCH_STATUS <> -1)
			begin
				select @driverno=''
				set @cmd =" select top(1) @driverno=driverno  from  #z_tran05  where  carno=@carno  and  mon=@mon order  by "+@field_tranmoney+"  desc"  
				execute sp_executesql @cmd,N'@carno nvarchar(20),@driverno nvarchar(20)  out,@mon nvarchar(10)'
				,@carno=@carno ,@driverno=@driverno out,@mon=@mon
			
				set @cmd = "update top(1) #z_tran05 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@money),1)),4,12)),m"+@fieldm+"=@money where gno='0' and carno=@carno and mon=@mon  and  driverno=@driverno" 
				execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10),@money float',
					@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon,@money=@money
				fetch next from cursor_table2
				into @mon
			end
			close cursor_table2
			deallocate cursor_table2

			fetch next from cursor_table
			into @carno,@money
		end
		close cursor_table
		deallocate cursor_table
	end
	------------------------------------------------------------------------------------------------------------------
	--薪資
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='carsal'
	if LEN(@fieldm)>0  and  LEN(@field_tranmoney)>0
	begin
		declare cursor_table cursor for
		select driverno,noa,[money] from carsals 
		where (noa between left(@t_bdate,6)  and  left(@t_edate,6))  and  (driverno  between  @t_bdriverno  and  @t_edriverno)
		open cursor_table
		fetch next from cursor_table
		into @driverno,@mon,@money
		while(@@FETCH_STATUS <> -1)
		begin
			select @carkindno='',@carno=''
			set @cmd =" select top(1) @carkindno=carkindno,@carno=carno  from  #z_tran05  where  driverno=@driverno  and  mon=@mon order  by "+@field_tranmoney+"  desc"  

			execute sp_executesql @cmd,N'@carkindno nvarchar(20) output,@carno nvarchar(20) output,@driverno nvarchar(20),@mon nvarchar(10)'
			,@carkindno=@carkindno output,@carno=@carno output,@driverno=@driverno,@mon=@mon
			
			if LEN( @carno)>0
			begin
				set @cmd = "update #z_tran05 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@money),1)),4,12)),m"+@fieldm+"=@money where gno='0' and carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon"
				execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10),@money float',
					@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon,@money=@money
			end
			fetch next from cursor_table
			into @driverno,@mon,@money
		end
		close cursor_table
		deallocate cursor_table
	end
	------------------------------------------------------------------------------------------------------------------
	--淨利
	if exists(select * from @field where [key]='profit')
	begin
		set @cmd='0'
		declare cursor_table cursor for
		select fieldm,product from @field where product!=0
		open cursor_table
		fetch next from cursor_table
		into @fieldm,@product
		while(@@FETCH_STATUS <> -1)
		begin
			set @cmd=@cmd+"+(isnull(m"+@fieldm+",0)*("+CONVERT(nvarchar,@product)+"))"
			fetch next from cursor_table
			into @fieldm,@product
		end
		close cursor_table
		deallocate cursor_table
		
		set @fieldm = ''
		select @fieldm=fieldm from @field where [key]='profit'
		if LEN(@fieldm)>0
		begin
			set @cmd = "update #z_tran05 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,"+@cmd+"),1)),4,12)),m"+@fieldm+"="+@cmd
			execute sp_executesql @cmd
		end
	end
	------------------------------------------------------------------------------------------------------------------
	--類別
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='carkind'
	if LEN(@fieldm)>0
	begin
		declare cursor_table cursor for
		select carkindno from #z_tran05 group by carkindno
		open cursor_table
		fetch next from cursor_table
		into @carkindno
		while(@@FETCH_STATUS <> -1)
		begin
			set @carkind=''
			select @carkind=kind from carKind where noa=@carkindno
			set @cmd="update #z_tran05 set "+@fieldm+"=@carkind where carkindno=@carkindno"
			execute sp_executesql @cmd,N'@carkind nvarchar(20),@carkindno nvarchar(10)',@carkind=@carkind,@carkindno=@carkindno	
			fetch next from cursor_table
			into @carkindno
		end
		close cursor_table
		deallocate cursor_table	
	end
	------------------------------------------------------------------------------------------------------------------
	--年份
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='caryear'
	if LEN(@fieldm)>0
	begin
		declare cursor_table cursor for
		select carno from #z_tran05 group by carno
		open cursor_table
		fetch next from cursor_table
		into @carno
		while(@@FETCH_STATUS <> -1)
		begin
			set @caryear=''
			select @caryear=caryear from car2 where noa=@carno
			set @cmd="update #z_tran05 set "+@fieldm+"=@caryear where carno=@carno"
			execute sp_executesql @cmd,N'@carno nvarchar(20),@caryear nvarchar(10)',@carno=@carno,@caryear=@caryear	
			fetch next from cursor_table
			into @carno
		end
		close cursor_table
		deallocate cursor_table	
	end
	------------------------------------------------------------------------------------------------------------------
	--汽缸
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='cylinder'
	if LEN(@fieldm)>0
	begin
		declare cursor_table cursor for
		select carno from #z_tran05 group by carno
		open cursor_table
		fetch next from cursor_table
		into @carno
		while(@@FETCH_STATUS <> -1)
		begin
			set @cylinder=0
			select @cylinder=cylinder from car2 where noa=@carno
			set @cmd="update #z_tran05 set "+@fieldm+"=convert(char(2),@cylinder) where carno=@carno"
			execute sp_executesql @cmd,N'@carno nvarchar(20),@cylinder int',@carno=@carno,@cylinder=@cylinder
			fetch next from cursor_table
			into @carno
		end
		close cursor_table
		deallocate cursor_table	
	end
	------------------------------------------------------------------------------------------------------------------
	--日數
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='day'
	if LEN(@fieldm)>0
	begin
		declare cursor_table cursor for
		select carkindno,carno,driverno,mon from #z_tran05
		open cursor_table
		fetch next from cursor_table
		into @carkindno,@carno,@driverno,@mon
		while(@@FETCH_STATUS <> -1)
		begin
			select @day=0
			select @day=count(1) from (SELECT DISTINCT datea from @tmp1 where carkindno=@carkindno and carno=@carno and driverno=@driverno and LEFT(datea,6)=@mon)as a
			
			set @cmd="update #z_tran05 set "+@fieldm+"=convert(char(2),@day) where gno='0' and carkindno=@carkindno and carno=@carno and driverno=@driverno and mon=@mon"
			execute sp_executesql @cmd,
				N'@day int,@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10)',
				@day=@day,@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon

			fetch next from cursor_table
			into @carkindno,@carno,@driverno,@mon
		end
		close cursor_table
		deallocate cursor_table	
	end
	------------------------------------------------------------------------------------------------------------------
	--車牌
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='carno'
	if LEN(@fieldm)>0
	begin
		set @cmd="update #z_tran05 set "+@fieldm+"=carno"
		execute sp_executesql @cmd
	end
	------------------------------------------------------------------------------------------------------------------
	--司機
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='driver'
	if LEN(@fieldm)>0
	begin
		declare cursor_table cursor for
		select driverno from #z_tran05 group by driverno
		open cursor_table
		fetch next from cursor_table
		into @driverno
		while(@@FETCH_STATUS <> -1)
		begin
			set @driver=''
			select @driver=namea from driver where noa=@driverno
			set @cmd="update #z_tran05 set "+@fieldm+"=@driver where driverno=@driverno"
			execute sp_executesql @cmd,N'@driver nvarchar(20),@driverno nvarchar(20)',@driver=@driver,@driverno=@driverno
			fetch next from cursor_table
			into @driverno
		end
		close cursor_table
		deallocate cursor_table	
	end
	------------------------------------------------------------------------------------------------------------------
	--月份
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='mon'
	if LEN(@fieldm)>0
	begin
		set @cmd="update #z_tran05 set "+@fieldm+"=mon"
		execute sp_executesql @cmd
	end
	------------------------------------------------------------------------------------------------------------------
	--小計
	declare cursor_table cursor for
	select carkindno from #z_tran05 group by carkindno
	open cursor_table
	fetch next from cursor_table
	into @carkindno
	while(@@FETCH_STATUS <> -1)
	begin
		set @fieldm=''
		select @fieldm=fieldm from @field where [key]='carno'
		set @carkind=''
		select @carkind=kind from carkind where noa=@carkindno
		if LEN(@fieldm)>0
		begin
			set @cmd="insert into #z_tran05(gno,carkindno,carno,driverno,mon,rowheader,"+@fieldm+")values('1',@carkindno,'','','',@carkind+'小計',@carkind+'小計')"
			execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carkind nvarchar(20)',@carkindno=@carkindno,@carkind=@carkind
		end
		else
			insert into #z_tran05(gno,carkindno,carno,driverno,mon,rowheader)values('1',@carkindno,'','','',@carkind+'小計')

		declare cursor_table2 cursor for
		select fieldm from @field where isSum=1
		open cursor_table2
		fetch next from cursor_table2
		into @fieldm
		while(@@FETCH_STATUS <> -1)
		begin
			set @money=0
			set @cmd="select @money=sum(isnull(m"+@fieldm+",0)) from #z_tran05 where gno='0' and carkindno=@carkindno group by carkindno"
			execute sp_executesql @cmd,N'@carkindno nvarchar(10),@money float output',@carkindno=@carkindno,@money=@money output
			
			set @cmd="update #z_tran05 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@money),1)),4,12)),m"+@fieldm+"=@money where gno='1' and carkindno=@carkindno"
			execute sp_executesql @cmd,N'@carkindno nvarchar(10),@money float',@carkindno=@carkindno,@money=@money
			
			fetch next from cursor_table2
			into @fieldm
		end
		close cursor_table2
		deallocate cursor_table2
		
		
		fetch next from cursor_table
		into @carkindno
	end
	close cursor_table
	deallocate cursor_table
	--*************************************************************************************************
	declare cursor_table cursor for
	select fieldh,header from @field
	open cursor_table
	fetch next from cursor_table
	into @fieldh,@header
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd="update #z_tran05 set "+@fieldh+"=@header"
		execute sp_executesql @cmd,N'@header nvarchar(20)',@header=@header
		fetch next from cursor_table
		into @fieldh,@header
	end
	close cursor_table
	deallocate cursor_table
	
	select @fieldm='',@sort=''
	select @fieldm=fieldm,@sort=isnull(sort,'') from @field where [key]='caryear'
	set @cmd="select * from #z_tran05 order by carkindno,gno"+case when len(@sort)>0 then ','+@sort when len(@fieldm)>0 then ','+@fieldm else '' end+",carno"
	execute sp_executesql @cmd
	drop table #z_tran05
	drop table #carkind
	drop table #calctype
	drop table #carteam;

z_tran09:--z_tran09	
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	declare @t_sort08  nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	set @t_sort08  = case when '#non'=[27] then '' else [27] end
	----------------------------------------------------------------------------------------------
	declare @minN int
	declare @string nvarchar(max)
	declare @n int
	declare @carno nvarchar(20)
	declare @datea nvarchar(10)
	declare @carkindno  nvarchar(20)
	declare @carkind	nvarchar(20)
	declare @miles float
	declare @tranmoney float
	declare @drivermoney float
	declare @reserve float 
	declare @mount float 
	declare @money float 
	declare @unit nvarchar(20)
	declare @custno nvarchar(20)
	declare @comp  nvarchar(max)
	declare @carteamno nvarchar(20)
	declare @team  nvarchar(20)
	declare @po nvarchar(20)
	declare @trandono nvarchar(20)
	declare @noa nvarchar(20)
	declare @acomp nvarchar(max)
	declare @mount2 float
	declare @mount3 float
	declare @serial nvarchar(20)
	declare @tel nvarchar(20)
	declare @money2 float
	declare @money3 float
	declare @driver nvarchar(20)
	declare @rate float
	----------------------------------------------------------------------------------------------
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	set @cmd= 
	" select a.carno,a.driver,sum(isnull(a.miles,0))"+
	" from view_trans"+@t_accy+" a"+
	" left join #calctype b on a.calctype=b.noa"+
	" left join car2 c on a.carno=c.carno"+
	" left join #carkind d on c.carkindno=d.noa"+
	" where (b.noa is  not  null) and (d.noa is  not  null)"+
	"	and (len(@t_carno)=0 or a.carno=@t_carno)"+
	"	and (a.datea between @t_bdate and @t_edate)"+
	"	and (a.trandate between @t_btrandate and @t_etrandate)"+
	"	and (a.custno between @t_bcustno and @t_ecustno)"+
	"	and (a.driverno between @t_bdriverno and @t_edriverno)"+
	"	and (a.straddrno between @t_baddr and @t_eaddr)"+
	"	and (len(@t_po)=0 or a.po=@t_po) and isnull(a.miles,0)>0"+
	" group by a.carno,a.driver"
	
	declare @tmp1 table(
		carno nvarchar(20),
		driver nvarchar(20),
		miles float
	)
	insert into @tmp1
	EXECUTE sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bdriverno nvarchar(20),@t_edriverno nvarchar(20),@t_carno nvarchar(20),@t_bcustno  nvarchar(20),@t_ecustno  nvarchar(20),@t_po  nvarchar(30),@t_btrandate  nvarchar(10),@t_etrandate  nvarchar(10),@t_baddr  nvarchar(20),@t_eaddr  nvarchar(20)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_po=@t_po,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate,@t_baddr=@t_baddr,@t_eaddr=@t_eaddr
	----------------------------------------------------------------------------
	declare @tmp2 table(
		carno nvarchar(20),
		driver nvarchar(20),
		mount float
	)
	if  LEN(@t_bdate)>0
	begin
		insert into @tmp2
		select a.carno,a.driver,SUM(isnull(a.mount,0)) 
		from oil a
		left  join  car2  b  on  a.carno=b.carno
		left  join  #carkind  c  on  c.noa=b.carkindno  
		where (c.noa  is  not  null)
			and (a.datea between @t_bdate and @t_edate) 
			and (a.driverno between @t_bdriverno and @t_edriverno)
			and (len(@t_carno)=0 or a.carno=@t_carno)
		group by a.carno,a.driver
	end
	else
	begin
		insert into @tmp2
		select a.carno,a.driver,SUM(isnull(a.mount,0)) 
		from oil a
		left  join  car2  b  on  a.carno=b.carno
		left  join  #carkind  c  on  c.noa=b.carkindno  
		where (c.noa  is  not  null)
			and (a.datea between @t_btrandate and @t_etrandate) 
			and (a.driverno between @t_bdriverno and @t_edriverno)
			and (len(@t_carno)=0 or a.carno=@t_carno)
		group by a.carno,a.driver
	end
	
	declare @tmp table(
		gno nvarchar(3),
		carno nvarchar(20),
		miles float,
		cmiles nvarchar(20),
		mount float,
		cmount nvarchar(20),
		rate float,
		crate nvarchar(20),
		memo nvarchar(max)
	)
	declare cursor_table cursor for
	select a.carno,SUM(a.miles) miles,SUM(a.mount) mount
	from(
		select carno,SUM(miles) miles,0 mount from @tmp1 group by carno
		union all
		select carno,0,SUM(mount) from @tmp2 group by carno)as a
	group by carno
	open cursor_table
	fetch next from cursor_table
	into @carno,@miles,@mount
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd=''
		
		declare cursor_table2 cursor for
		select driver
		from(select driver from @tmp1 where carno=@carno
			union all
			select driver from @tmp2 where carno=@carno)as a
		group by driver
		open cursor_table2
		fetch next from cursor_table2
		into @driver
		while(@@FETCH_STATUS <> -1)
		begin
			set @cmd = @cmd +SPACE(2)+@driver
			fetch next from cursor_table2
			into @driver
		end
		close cursor_table2
		deallocate cursor_table2
		
		set @rate = case when @mount>0 then round(@miles/@mount,3) else 0 end
		insert into @tmp (gno,carno,miles,mount,rate,memo)values('0',@carno,@miles,@mount,@rate,ltrim(@cmd))
		
		fetch next from cursor_table
		into @carno,@miles,@mount
	end
	close cursor_table
	deallocate cursor_table
	
	select @miles=0,@mount=0
	select @miles=SUM(miles),@mount=SUM(mount) from @tmp where gno='0'
	insert into @tmp(gno,miles,mount)values('1',@miles,@mount)
	
	update @tmp set cmiles=reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,miles),1)),4,12)),
						cmount=reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,mount),1)),4,12)),
						crate=convert(nvarchar(15),CONVERT(money,rate),1)
	if len(@t_bdate)>0
		set  @cmd  =  '登錄日期：'+@t_bdate+'～'+@t_edate
	else
		set  @cmd  =  '交運日期：'+@t_btrandate+'～'+@t_etrandate
	select @cmd titlea ,* from @tmp order by gno,carno
	drop table #carkind
	drop table #carteam
	drop table #calctype;


z_tran08:--z_tran08
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	declare @t_sort08  nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	set @t_sort08  = case when '#non'=[27] then '' else [27] end
	----------------------------------------------------------------------------------------------
	----------------------------------------------------------------------------------------------
	declare @minN int
	declare @string nvarchar(max)
	declare @n int
	declare @carno nvarchar(20)
	declare @datea nvarchar(10)
	declare @carkindno  nvarchar(20)
	declare @carkind	nvarchar(20)
	declare @miles float
	declare @tranmoney float
	declare @drivermoney float
	declare @reserve float 
	declare @mount float 
	declare @money float 
	declare @unit nvarchar(20)
	declare @custno nvarchar(20)
	declare @comp  nvarchar(max)
	declare @carteamno nvarchar(20)
	declare @team  nvarchar(20)
	declare @po nvarchar(20)
	declare @trandono nvarchar(20)
	declare @noa nvarchar(20)
	declare @acomp nvarchar(max)
	declare @mount2 float
	declare @mount3 float
	declare @serial nvarchar(20)
	declare @tel nvarchar(20)
	declare @money2 float
	declare @money3 float
	----------------------------------------------------------------------------------------------
	declare @z_tran08 table(
			gno nvarchar(1),
			pno nvarchar(1),
			acomp nvarchar(50),
			noa nvarchar(20),
			datea nvarchar(20),
			trandate nvarchar(20),
			po nvarchar(20),
			custno nvarchar(20),
			comp nvarchar(50),
			custorde nvarchar(30),
			newcustorde nvarchar(30),
			serial nvarchar(20),
			tel nvarchar(20),
			straddr nvarchar(max),
			product nvarchar(20),
			mount decimal(18,3),
			price decimal(18,3),
			total decimal(18,3),
			carno nvarchar(20),
			isoutside int,
			caseno nvarchar(20),
			driverno nvarchar(20),
			carteamno nvarchar(20),
			calctype nvarchar(20),
			mount2 float,--公司車
			mount3 float,--外車
			total2 float,--公司車
			total3 float,--外車
			times int,--車次
			sortkey nvarchar(max)
	)
	insert into @z_tran08
	select '0' gno,'0' pno,(@t_cno+'【請款明細表】'),a.noa,a.datea,a.trandate,a.po,a.custno,isnull(f.comp,''),a.custorde,'',isnull(f.serial,''),left(isnull(f.tel,''),20),a.straddr,a.product,
	a.mount,a.price,a.total,a.carno,isnull(e.isoutside,''),a.caseno,a.driverno,a.carteamno,a.calctype,0,0,0,0,0,''
	from  view_trans a 
	--left join #carteam b on a.carteamno=b.noa	
	--left join #calctype c on a.calctype=c.noa
	left join carteam  d on a.carteamno=d.noa	
	left join calctypes e on a.calctype=e.noa+e.noq
	left join cust f on f.noa = a.custno 
	where (isnull(a.datea,'') between @t_bdate and @t_edate) 
	and (isnull(a.trandate,'') between @t_btrandate and @t_etrandate)
	and (isnull(a.custno,'') between @t_bcustno and @t_ecustno)
	and (isnull(a.driverno,'') between @t_bdriverno and @t_edriverno)
	and (len(@t_carno) = 0 or a.carno = @t_carno)
	and (len(@t_po)=0 or a.po = @t_po)
	and (a.straddrno between @t_baddr and @t_eaddr)
	and (len(@t_carteam)=0 or CHARINDEX(','+a.carteamno+',',','+@t_carteam+',')>0)
	and (len(@t_calctype)=0 or CHARINDEX(','+a.calctype+',',','+@t_calctype+',')>0)
	
	declare cursor_table cursor for
	select noa,custorde from @z_tran08
	open cursor_table
	fetch next from cursor_table
	into @noa,@string
	while(@@FETCH_STATUS <> -1)
	begin
		set @n = PATINDEX('%[0-9]%',@string)
		if(@n>1)
		begin
			set @string = substring(@string,@n,len(@string)-@n+1)+LEFT(@string,@n-1)
		end
		update @z_tran08 set newcustorde=@string where  noa=@noa
		
		fetch next from cursor_table
		into @noa,@string
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select acomp,custno,comp,serial,tel,count(1) n,sum(mount),sum(total) from @z_tran08 group by acomp,custno,comp,serial,tel
	open cursor_table
	fetch next from cursor_table
	into @acomp,@custno,@comp,@serial,@tel,@n,@mount,@money
	while(@@FETCH_STATUS <> -1)
	begin
		select @mount2=0,@mount3=0,@money2=0,@money3=0
		select @mount2=isnull(SUM(isnull(mount,0)),0),@money2=isnull(sum(isnull(total,0)),0) from  @z_tran08  a
		left join calctypes b on a.calctype=b.noa+b.noq
		where  a.custno=@custno  and  not((b.noa+b.noq)is null) and b.isoutside!=1
		select @mount3=isnull(SUM(isnull(mount,0)),0),@money3=isnull(sum(isnull(total,0)),0) from  @z_tran08  a
		left join calctypes b on a.calctype=b.noa+b.noq
		where  a.custno=@custno  and  not((b.noa+b.noq)is null) and  b.isoutside=1

		insert into @z_tran08(gno,pno,acomp,custno,comp,serial,tel,mount,total,times,mount2,total2,mount3,total3)values('1','x',@acomp,@custno,@comp,@serial,@tel,@mount,@money,@n,@mount2,@money2,@mount3,@money3)
		set @n=(@n+2)%@minN
		while(@n!=0 and @n<@minN)
		begin
			insert into @z_tran08(gno,pno,acomp,custno,comp,serial,tel)values('0','y',@acomp,@custno,@comp,@serial,@tel)
			set @n = @n+1
		end
		insert into @z_tran08(gno,pno,acomp,custno,comp,serial,tel)values('2','z',@acomp,@custno,@comp,@serial,@tel)
		fetch next from cursor_table
		into @acomp,@custno,@comp,@serial,@tel,@n,@mount,@money
	end
	close cursor_table
	deallocate cursor_table
	
	update @z_tran08 
	set sortkey = case @t_sort08 
		when 'datea' then datea
		when 'custorde' then newcustorde
		when 'trandate' then trandate
		when 'carno' then carno  
		else '' end
	------------------------------------------------
	if len(@t_bdate)>0
		set  @cmd  =  '登錄日期：'+@t_bdate+'～'+@t_edate
	else
		set  @cmd  =  '交運日期：'+@t_btrandate+'～'+@t_etrandate
	
	select  @cmd titlea
		,trandate a01
		,straddr a02
		,product a03
		,dbo.getComma(mount,3) a04
		,dbo.getComma(price,3) a05
		,dbo.getComma(total,0) a06
		,carno a07
		,custorde a08
		,caseno a09
		,*
	from @z_tran08
	order by custno,pno,gno,sortkey,noa;

z_tran07:--z_tran07
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	----------------------------------------------------------------------------------------------
	----------------------------------------------------------------------------------------------
	declare @minN int
	declare @string nvarchar(max)
	declare @n int
	declare @carno nvarchar(20)
	declare @datea nvarchar(10)
	declare @carkindno  nvarchar(20)
	declare @carkind	nvarchar(20)
	declare @miles float
	declare @tranmoney float
	declare @drivermoney float
	declare @reserve float 
	declare @mount float 
	declare @money float 
	declare @unit nvarchar(20)
	declare @custno nvarchar(20)
	declare @comp  nvarchar(max)
	declare @carteamno nvarchar(20)
	declare @team  nvarchar(20)
	declare @po nvarchar(20)
	declare @trandono nvarchar(20)
	----------------------------------------------------------------------------------------------
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_tran07')is not null
	BEGIN
		set @cmd = 'drop table #z_tran07'
		EXECUTE sp_executesql @cmd
	END
	create table  #z_tran07(
		gno nvarchar(3),
		p nvarchar(3),
		acomp  nvarchar(50),
		custno nvarchar(20),
		comp nvarchar(40),
		memo varchar(1000),
		noa nvarchar(20),
		trandate char(9),
		custorde char(30),
		caseno char(20),
		[money] float,
		cmoney char(7),
		po char(20),
		product char(40),
		addr char(40),
		boatname char(40),
		trandono nvarchar(20)
	)
	declare @h1 varchar(120)
	declare @h2 varchar(120)
	declare @h3 varchar(120)
	set @h1 = SPACE(1)+'運輸日期'+SPACE(1)+'憑單號碼'+SPACE(3)+'貨櫃號碼'+SPACE(5)+'金'+SPACE(3)+'額'+SPACE(1)+
			'P/O號碼'+SPACE(10)+'貨品名稱'+SPACE(5)+'起訖地點'+SPACE(16)+'船名'+SPACE(18)
	set @h2 = REPLICATE('=',9)+SPACE(1)+REPLICATE('=',10)+SPACE(1)+REPLICATE('=',12)+SPACE(1)+REPLICATE('=',7)+SPACE(1)+
			REPLICATE('=',16)+SPACE(1)++REPLICATE('=',12)+SPACE(1)++REPLICATE('=',23)+SPACE(1)++REPLICATE('=',24)
	set @h3 = REPLICATE('-',120)
	
	set @cmd= 
	" select '0','2','',a.custno,e.comp,'',a.noa,a.trandate,left(convert(char(30),a.custorde ),10),left(convert(char(30),a.caseno ),16)"+
	" ,total,reverse(substring(reverse(convert(nvarchar(10),CONVERT(money,a.total),1)),4,7))"+
	" ,a.po"+
	" ,case when g.noa is null then a.product else f.product end"+
	" ,case when g.noa is null then a.straddr else f.addr end"+
	" ,case when g.noa is null then a.boatname else g.boatname end"+
	" ,isnull(g.deliveryno,'')"+
	" from view_trans"+@t_accy+" a"+
	" left join #calctype b on a.calctype=b.noa"+
	" left join calctype c on left(a.calctype,1)=c.noa"+
	" left join #carteam d on a.carteamno=d.noa"+
	" left join cust e on a.custno=e.noa"+
	" left join trandos f on a.noa=f.tranno  and  a.noq=f.trannoq and a.caseno=f.caseno"+
	" left join trando g on f.noa=g.noa"+
	" where a.calctype=b.noa  and  a.carteamno=d.noa "+
	"	and (len(@t_carno)=0 or a.carno=@t_carno)"+
	"	and (a.datea between @t_bdate and @t_edate)"+
	"	and (a.trandate between @t_btrandate and @t_etrandate)"+
	"	and (a.custno between @t_bcustno and @t_ecustno)"+
	"	and (a.driverno between @t_bdriverno and @t_edriverno)"+
	"	and (len(@t_po)=0 or a.po=@t_po) and len(a.po)>0"+
	"   and (a.straddrno between @t_baddr and @t_eaddr)"+
	" and (len(@z_delivery)=0 or g.deliveryno=@z_delivery)"
	insert into #z_tran07
	EXECUTE sp_executesql @cmd,N'@t_btrandate nvarchar(10),@t_etrandate nvarchar(10),@z_delivery nvarchar(30),@t_baddr nvarchar(20),@t_eaddr nvarchar(20),@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bdriverno nvarchar(20),@t_edriverno nvarchar(20),@t_carno nvarchar(20),@t_bcustno nvarchar(20),@t_ecustno nvarchar(20),@t_po nvarchar(30)',
	@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate,@z_delivery=@z_delivery,@t_baddr=@t_baddr,@t_eaddr=@t_eaddr,@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_po=@t_po

	set @cmd="update #z_tran07 set memo=isnull(trandate,space(9))+SPACE(1)+isnull(left(custorde,10),space(10))+SPACE(1)+isnull(left(caseno,12),space(12))+SPACE(1)+isnull(right(space(7)+rtrim(cmoney),7),space(7))+SPACE(1)+isnull(convert(char(16),po),space(16))+SPACE(1)+"
	if len(@z_product)=0
	set @cmd = @cmd + "isnull(convert(char(12),product),space(12))+SPACE(1)+"
	else
	set @cmd = @cmd + "convert(char(12),isnull(@z_product,space(12)))+SPACE(1)+"
	if LEN(@z_addr)=0
		set @cmd = @cmd + "convert(char(23),isnull(addr,space(23)))+SPACE(1)+"	
	else
		set @cmd = @cmd + "convert(char(23),isnull(@z_addr,space(23)))+SPACE(1)+"
	if LEN(@z_boatname)=0
		set @cmd = @cmd + "convert(char(24),isnull(boatname,space(24)))"
	else
		set @cmd = @cmd + "convert(char(24),isnull(@z_boatname,space(24)))"
	EXECUTE sp_executesql  @cmd,N'@z_product nvarchar(max),@z_addr nvarchar(max),@z_boatname nvarchar(max)',
	@z_product=@z_product,@z_addr=@z_addr,@z_boatname=@z_boatname
	
	declare cursor_table cursor for
	select custno,comp,po,trandono,count(1),sum(isnull([money],0))
	from #z_tran07 group by custno,comp,po,trandono
	open cursor_table
	fetch next from cursor_table
	into @custno,@comp,@po,@trandono,@mount,@money
	while(@@FETCH_STATUS <> -1)
	begin
		insert into #z_tran07(gno,p,custno,comp,po,trandono,memo)values('0','0',@custno,@comp,@po,@trandono,@h1)
		insert into #z_tran07(gno,p,custno,comp,po,trandono,memo)values('0','1',@custno,@comp,@po,@trandono,@h2)
		insert into #z_tran07(gno,p,custno,po,trandono,memo)values('0','3',@custno,@po,@trandono,@h3)
		insert into #z_tran07(gno,p,custno,po,trandono,memo)values('0','4',@custno,@po,@trandono,'共'+right(space(5)+rtrim(CONVERT(char(5),@mount)),5)+' 只'+SPACE(11)+'合計金額：'+reverse(substring(reverse(convert(char(13),CONVERT(money,@money),1)),4,10)))
		insert into #z_tran07(gno,custno,po,trandono)values('1',@custno,@po,@trandono)
		fetch next from cursor_table
		into @custno,@comp,@po,@trandono,@mount,@money
	end
	close cursor_table
	deallocate cursor_table
	
	update  #z_tran07  set acomp=rtrim(@t_cno)+'【請款明細表】',  memo=REPLACE(memo,SPACE(1),'&nbsp'+char(59))
	
	if len(@t_bdate)>0
		set  @cmd  =  '登錄日期：'+@t_bdate+'～'+@t_edate
	else
		set  @cmd  =  '交運日期：'+@t_btrandate+'～'+@t_etrandate
	select @cmd titlea,* from #z_tran07 order by custno,po,trandono,gno,p,noa
	-------------------------------------------------------------------------------------------------------------------
	drop table #z_tran07
	drop table #carkind
	drop table #carteam
	drop table #calctype;

z_tran06:--z_tran06
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	declare @t_sort08  nvarchar(max)
	declare @t_field05  nvarchar(max)
	declare @t_sort03  nvarchar(max)
	declare @t_sort14  nvarchar(max)
	declare @t_bsalesno  nvarchar(20)
	declare @t_esalesno  nvarchar(20)
	declare @t_sort06 nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	set @t_sort08  = case when '#non'=[27] then '' else [27] end
	set @t_field05  = case when '#non'=[28] then '' else [28] end
	set @t_sort03 = case when '#non'=[29] then '' else [29] end
	set @t_sort14 = case when '#non'=[30] then '' else [30] end
	set @t_bsalesno = case when '#non'=[31] then '' else [31] end
	set @t_esalesno = case when '#non'=[32] then char(255) else [32] end
	set @t_sort06  = case when '#non'=[33] then '' else [33] end
	----------------------------------------------------------------------------------------------
	declare @minN int
	declare @string nvarchar(max)
	declare @n int
	declare @carno nvarchar(20)
	declare @datea nvarchar(10)
	declare @carkindno  nvarchar(20)
	declare @carkind	nvarchar(20)
	declare @miles float
	declare @tranmoney float
	declare @drivermoney float
	declare @reserve float 
	declare @mount float 
	declare @money float 
	declare @unit nvarchar(20)
	declare @custno nvarchar(20)
	declare @comp  nvarchar(max)
	declare @carteamno nvarchar(20)
	declare @team  nvarchar(20)
	----------------------------------------------------------------------------------------------
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	--記錄欄位
	declare @gkey  nvarchar(max)
	declare @gname  nvarchar(max)
	declare @fieldA nvarchar(max)
	declare @fieldB nvarchar(max)
	declare @fieldC nvarchar(max)
	declare @fieldD nvarchar(max)
	declare @result nvarchar(max)
	
	declare @field table(
		noa  nvarchar(20),
		team nvarchar(20),
		unit  nvarchar(20),
		field_mount_header nvarchar(10),
		field_mount nvarchar(10),
		field_money_header nvarchar(10),
		field_money nvarchar(10)
	)
	-------------------------------------------------------------------------------------------------------------
	set @minN=5
	-------------------------------------------------------------------------------------------------------------
	--暫存資料
	IF OBJECT_ID('tempdb..#z_tran06')is not null
	BEGIN
		set @cmd = 'drop table #z_tran06'
		EXECUTE sp_executesql @cmd
	END
	create table #z_tran06(
		gno nvarchar(3),
		custno nvarchar(20),
		comp nvarchar(40),
		primary key(custno,gno)
	)
	-------------------------------------------------------------------------------------------------------------
	
	-------------------------------------------------------------------------------------------------------------
	--出車單:客戶金額
	select @n= COUNT(1) from @field

	declare cursor_table cursor for
	select a.noa,a.team,a.unit from carteam a
	left join carteam b on a.noa=b.noa
	left join #carteam c on b.noa=c.noa
	where b.noa=c.noa
	group by a.noa,a.team,a.unit
	open cursor_table
	fetch next from cursor_table
	into @gkey,@gname,@unit
	while(@@FETCH_STATUS <> -1)
	begin
		set @n = @n + 1
		insert into @field
		select @gkey,@gname,@unit,
				"a"+right("00"+CONVERT(nvarchar(10),@n),3),
				"b"+right("00"+CONVERT(nvarchar(10),@n),3),
				"c"+right("00"+CONVERT(nvarchar(10),@n),3),
				"d"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @cmd = "alter table #z_tran06 add a"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran06 add b"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran06 add cb"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran06 add c"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran06 add d"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran06 add cd"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		fetch next from cursor_table
		into @gkey,@gname,@unit
	end
	close cursor_table
	deallocate cursor_table
	
	select @n= COUNT(1) from @field
	while(@n<@minN)
	begin
		set  @n = @n +  1
		insert into @field
		select null,null,null,
				"a"+right("00"+CONVERT(nvarchar(10),@n),3),
				"b"+right("00"+CONVERT(nvarchar(10),@n),3),
				"c"+right("00"+CONVERT(nvarchar(10),@n),3),
				"d"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @cmd = "alter table #z_tran06 add a"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran06 add b"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran06 add cb"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran06 add c"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran06 add d"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran06 add cd"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--------------------------------------------------------------------------------------------------------------------
	declare @tmp1 table(
		custno nvarchar(20),
		carteamno nvarchar(10),
		mount float,
		[money] float
	)

	set @cmd =" select a.custno,a.carteamno,"
	if  @t_option1='收金額'
		set  @cmd  =  @cmd  +  "sum(a.mount), sum(round(a.mount*a.price,0)) money"
	else
		set  @cmd  =  @cmd  +  "sum(a.mount2), sum(round(a.mount2*(a.price2+a.price3),0)) money"
	set @cmd =	@cmd  +
		" from view_trans"+@t_accy+" a"+
		" left join #calctype b on a.calctype=b.noa"+
		" left join calctype c on left(a.calctype,1)=c.noa"+
		" left join #carteam d on a.carteamno=d.noa"+
		" where a.calctype=b.noa  and  a.carteamno=d.noa"+
		" and (len(@t_carno)=0 or a.carno=@t_carno)"+
		" and (a.datea between @t_bdate and @t_edate)"+
		" and (a.trandate between @t_btrandate and @t_etrandate)"+
		" and (a.custno between @t_bcustno and @t_ecustno)"+
		" and (a.driverno between @t_bdriverno and @t_edriverno)"+
		" and (a.straddrno between @t_baddr and @t_eaddr)"+
		" and (len(@t_po)=0 or a.po=@t_po)"+
		" group by a.custno,a.carteamno"
	insert into @tmp1
	execute sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10),@t_bcustno nvarchar(20),@t_ecustno nvarchar(20),@t_bdriverno  nvarchar(20),@t_edriverno  nvarchar(20),@t_carno  nvarchar(20),@t_po  nvarchar(20),@t_baddr  nvarchar(20),@t_eaddr  nvarchar(20)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_po=@t_po,@t_baddr=@t_baddr,@t_eaddr=@t_eaddr
	
	-------------------------------------------------------------------------------------------------------------
	
	declare cursor_table cursor for
	select custno,carteamno,mount,[money] from @tmp1
	open cursor_table
	fetch next from cursor_table
	into @custno,@carteamno,@mount,@money
	while(@@FETCH_STATUS <> -1)
	begin
		if exists(select * from @field where noa=@carteamno)
		begin
			select @fieldB='',@fieldD=''
			select @fieldB=field_mount,@fieldD=field_money from @field where noa=@carteamno
			if not  exists(select  *  from  #z_tran06  where  custno=@custno)
			begin
				set @comp=''
				select @comp=nick from cust where noa=@custno
				insert  into  #z_tran06(gno,custno,comp)values('0',@custno,@comp)
			end
			set  @cmd="update #z_tran06 set "+@fieldB+"=@mount,"+@fieldD+"=@money where gno='0' and custno=@custno"
			execute sp_executesql @cmd,N'@custno nvarchar(20),@mount  float,@money float',@custno=@custno,@mount=@mount,@money=@money
		end
		fetch next from cursor_table
		into @custno,@carteamno,@mount,@money
	end
	close cursor_table
	deallocate cursor_table
	-------------------------------------------
	set @result="select '1',char(255),''"
	
	
	declare cursor_table cursor for
	select unit,team,field_mount_header,field_mount,field_money_header,field_money from  @field
	open cursor_table
	fetch next from cursor_table
	into @unit,@team,@fieldA,@fieldB,@fieldC,@fieldD
	while(@@FETCH_STATUS <> -1)
	begin
		set @result = @result+",'',sum("+@fieldB+"),'','',sum("+@fieldD+"),''"
		
		set @cmd = "update #z_tran06 set " +@fieldA+"=@unit,"+@fieldC+"=@team+'/$'"
		execute sp_executesql @cmd,N'@unit nvarchar(20),@team nvarchar(20)',@unit=@unit,@team=@team
		
		fetch next from cursor_table
		into @unit,@team,@fieldA,@fieldB,@fieldC,@fieldD
	end
	close cursor_table
	deallocate cursor_table
	set @result = @result+" from #z_tran06 group by gno"
	insert into #z_tran06
	execute sp_executesql @result
	----------------------------------------------------------------------------------------------------------------------
	declare cursor_table cursor for
	select field_mount,field_money from @field
	open cursor_table
	fetch next from cursor_table
	into @fieldB,@fieldD
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd="update #z_tran06 set c"+@fieldB+"=convert(nvarchar(15),CONVERT(money,"+@fieldB+"),1),"+
						" c"+@fieldD+"=reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,"+@fieldD+"),1)),4,12))"
		EXECUTE sp_executesql @cmd
		fetch next from cursor_table
		into @fieldB,@fieldD
	end
	close cursor_table
	deallocate cursor_table
	------------------------------------------------------------------------------------------------------------------------
	if len(@t_bdate)>0
		set  @cmd  =  '登錄日期：'+@t_bdate+'～'+@t_edate
	else
		set  @cmd  =  '交運日期：'+@t_btrandate+'～'+@t_etrandate
	set @string=''	
	select @string=field_money from @field where noa=@t_sort06
	if len(@string)=0
		set @string='d001'
	set @cmd="select '"+@cmd+"' titlea ,* from #z_tran06 order by gno,"+@string+" desc,custno"
	execute sp_executesql @cmd
	-------------------------------------------------------------------------------------------------------------------
	drop table #z_tran06
	drop table #carkind
	drop table #carteam
	drop table #calctype;

z_tran04:--z_tran04
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	----------------------------------------------------------------------------------------------
	declare @string nvarchar(max)
	declare @n int
	declare @carno nvarchar(20)
	declare @datea nvarchar(10)
	declare @carkindno  nvarchar(20)
	declare @carkind	nvarchar(20)
	declare @miles float
	declare @tranmoney float
	declare @drivermoney float
	declare @reserve float 
	declare @mount float 
	declare @money float 
	----------------------------------------------------------------------------------------------
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	declare @tmp table(
		gno nvarchar(3),
		driverno nvarchar(20),
		namea nvarchar(20),
		total float,
		total2 float,
		diff  float
	)
	
	set @cmd = " select  '0',a.driverno,b.namea,SUM(isnull(total,0)),"
	if  len(@t_option2)>0
		set @cmd = @cmd+" SUM(isnull(round(mount2*(price2+price3)*discount,0),0)),SUM(isnull(total,0)-isnull(round(mount2*(price2+price3)*discount,0),0))"
	else
		set @cmd = @cmd+" SUM(isnull(round(mount2*(price2+price3),0),0)),SUM(isnull(total,0)-isnull(round(mount2*(price2+price3),0),0))"
	set @cmd = @cmd+
		" from  view_trans"+@t_accy+"  a"+
		" left join driver b on a.driverno=b.noa"+
		" left join #carteam  c on a.carteamno=c.noa"+	
		" left join #calctype d on a.calctype=d.noa"+
		" where len(isnull(a.driverno,''))!=0  and  "+
		" (a.datea  between  @t_bdate  and  @t_edate) and "+
		" (a.trandate between  @t_btrandate and  @t_etrandate) and "+
		" (a.custno  between  @t_bcustno   and  @t_ecustno) and "+
		" (a.driverno  between  @t_bdriverno   and  @t_edriverno) and "+
		" (len(@t_carno)=0  or  a.carno=@t_carno) and "+
		" (len(@t_po)=0  or  a.po=@t_po) and "+
		" (a.straddrno between @t_baddr and @t_eaddr) and"+
		" (c.noa  is  not  null) and (d.noa  is  not  null)"+
		" group by a.driverno,b.namea"
	insert into @tmp
	execute sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10),@t_bcustno nvarchar(20),@t_ecustno nvarchar(20),@t_bdriverno  nvarchar(20),@t_edriverno  nvarchar(20),@t_carno  nvarchar(20),@t_po  nvarchar(20),@t_baddr  nvarchar(20),@t_eaddr  nvarchar(20)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_po=@t_po,@t_baddr=@t_baddr,@t_eaddr=@t_eaddr
	
	insert into @tmp
	select '1','','',SUM(total),SUM(total2),SUM(diff) from @tmp
	
	if len(@t_bdate)>0
		set  @cmd  =  '登錄日期：'+@t_bdate+'～'+@t_edate
	else
		set  @cmd  =  '交運日期：'+@t_btrandate+'～'+@t_etrandate
		
	select gno,@cmd titlea,driverno,namea,
		SUBSTRING(CONVERT(varchar,CAST(total as money),1 ),1, LEN(CONVERT(varchar,CAST(total as money),1 ))-3) total,
		SUBSTRING(CONVERT(varchar,CAST(total2 as money),1 ),1, LEN(CONVERT(varchar,CAST(total2 as money),1 ))-3) total2,
		SUBSTRING(CONVERT(varchar,CAST(diff as money),1 ),1, LEN(CONVERT(varchar,CAST(diff as money),1 ))-3) diff
	from @tmp order by gno,driverno
	-------------------------------------------------------------------------------------------------------------------
	drop table #carkind
	drop table #carteam
	drop table #calctype;

z_tran02:--z_tran02
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	----------------------------------------------------------------------------------------------
	declare @string nvarchar(max) 
	declare @n int 
	declare @carno nvarchar(20) 
	declare @datea nvarchar(10) 
	declare @carkindno nvarchar(20) 
	declare @carkind	nvarchar(20) 
	declare @miles float 
	declare @tranmoney float 
	declare @drivermoney float 
	declare @reserve float 
	declare @mount float 
	declare @money float 

	declare @custno nvarchar(20) 
	declare @comp nvarchar(20) 
	declare @total float 
	declare @total2 float 
	declare @total3 float 
	declare @diff float 
	declare @trdmoney1 float 
	declare @trdmoney2 float 
	declare @trdmoney3 float 
	declare @unpay float 
	declare @total4 float 
	declare @plusmoney float 
	declare @minusmoney float 
	---------------------------------------------------------------------------------------------- 
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	declare @tmp table(
		gno nvarchar(3),
		custno nvarchar(20),
		comp nvarchar(20),
		mon  nvarchar(10),
		total float,
		total2 float,--公司
		total3 float,--外車
		diff  float,
		trdmoney1  float,--當月請款
		trdmoney2  float,--上月請款 
		trdmoney3  float,--下月請款 
		unpay  float,		
		total4 float, --外車實發 
		plusmoney float,
		minusmoney float
	)
	
	set @cmd = " select  '0',a.custno,b.nick,left(a.datea,6),SUM(isnull(a.total,0)),"
	if  len(@t_option2)>0
		set @cmd = @cmd+" SUM(case when  e.isoutside=1 then 0 else isnull(a.total2,0) end),"+
						" SUM(case when  e.isoutside=1 then isnull(a.total2,0) else 0 end),"+
						" SUM(isnull(a.total,0)-isnull(a.total2,0)),"
	else
		set @cmd = @cmd+" SUM(case when  e.isoutside=1 then 0 else isnull(round(a.mount2*(a.price2+a.price3),0),0) end),"+
						" SUM(case when  e.isoutside=1 then isnull(round(a.mount2*(a.price2+a.price3),0),0) else 0 end),"+
						" SUM(isnull(a.total,0)-isnull(round(a.mount2*(a.price2+a.price3),0),0)),"
	set @cmd = @cmd+
		" sum(case  when isnull(g.mon,'')=left(a.datea,6) then isnull(f.tranmoney,0) else  0  end),"+
		" sum(case  when isnull(g.mon,'')<left(a.datea,6) then isnull(f.tranmoney,0) else  0  end),"+
		" sum(case  when isnull(g.mon,'')>left(a.datea,6) then isnull(f.tranmoney,0) else  0  end),"+
		" sum(case when len(isnull(f.noa,''))=0 then a.total else 0  end)  unpay,"+
		" SUM(case when  e.isoutside=1 then isnull(a.total2,0) else 0 end),"+
		" 0 plus,0 minus"+
		" from  view_trans a"+
		" left join cust b on a.custno=b.noa"+
		" left join #carteam  c on a.carteamno=c.noa"+	
		" left join #calctype d on a.calctype=d.noa"+
		" left join calctypes e on a.calctype=e.noa+e.noq"+
		" left join view_trds f on a.noa=f.tranno and a.noq=f.trannoq"+
		" left join view_trd g on f.accy=g.accy and f.noa=g.noa"+ 
		" where "+
		" (a.datea between  @t_bdate and  @t_edate) and "+
		" (a.trandate between  @t_btrandate and  @t_etrandate) and "+
		" (a.custno  between  @t_bcustno   and  @t_ecustno) and "+
		" (a.driverno  between  @t_bdriverno   and  @t_edriverno) and "+
		" (len(@t_carno)=0  or  a.carno=@t_carno) and "+
		" (len(@t_po)=0  or  a.po=@t_po) and "+
		" (a.straddrno between @t_baddr and @t_eaddr) and"+
		" (c.noa  is  not  null) and (d.noa  is  not  null)"+
		" group by a.custno,b.nick,left(a.datea,6)"
	insert into @tmp
	execute sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10),@t_bcustno nvarchar(20),@t_ecustno nvarchar(20),@t_bdriverno  nvarchar(20),@t_edriverno  nvarchar(20),@t_carno  nvarchar(20),@t_po  nvarchar(20),@t_baddr  nvarchar(20),@t_eaddr  nvarchar(20)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_po=@t_po,@t_baddr=@t_baddr,@t_eaddr=@t_eaddr
	-------------------------------------------------------------------------------------------------------------------
	declare cursor_table cursor for
	select custno,comp,count(1),sum(total),sum(total2),sum(total3),sum(diff) 
	,sum(trdmoney1),sum(trdmoney2),sum(trdmoney3),sum(unpay),sum(total4),sum(plusmoney),sum(minusmoney)
	from @tmp group by custno,comp
	open cursor_table
	fetch next from cursor_table
	into @custno,@comp,@n,@total,@total2,@total3,@diff,@trdmoney1,@trdmoney2,@trdmoney3,@unpay,@total4,@plusmoney,@minusmoney
	while(@@FETCH_STATUS <> -1)
	begin
		if @n>1
		begin
			insert into @tmp(gno,custno,comp,mon,total,total2,total3,diff,trdmoney1,trdmoney2,trdmoney3,unpay,total4,plusmoney,minusmoney)
			values('0',@custno,@comp,'小計：',@total,@total2,@total3,@diff,@trdmoney1,@trdmoney2,@trdmoney3,@unpay,@total4,@plusmoney,@minusmoney)	
		end
		insert into @tmp(gno,custno)values('1',@custno)
		fetch next from cursor_table
		into @custno,@comp,@n,@total,@total2,@total3,@diff,@trdmoney1,@trdmoney2,@trdmoney3,@unpay,@total4,@plusmoney,@minusmoney
	end
	close cursor_table
	deallocate cursor_table

	insert into @tmp select '2',CHAR(255),'',CHAR(255),SUM(total),SUM(total2),SUM(total3),SUM(diff),SUM(trdmoney1),SUM(trdmoney2),SUM(trdmoney3),SUM(unpay),SUM(total4),SUM(plusmoney),SUM(minusmoney) from @tmp where gno='0' and mon!='小計：'
	
	declare @noa nvarchar(20)
	declare @carteam nvarchar(20)
	set @cmd = ''
	declare cursor_table cursor for
	select a.noa,a.team from carteam a 
	left join #carteam b on a.noa=b.noa where b.noa is not null
	open cursor_table
	fetch next from cursor_table
	into @noa,@carteam
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd = @cmd+case when len(@cmd)>0 then ',' else '' end + @carteam
		fetch next from cursor_table
		into @noa,@carteam
	end
	close cursor_table
	deallocate cursor_table
	set @cmd = '【'+@cmd+'】'
	
	if len(@t_bdate)>0
		set  @cmd  =  '登錄日期：'+@t_bdate+'～'+@t_edate +'&nbsp'+char(59)+'&nbsp'+char(59)+ @cmd
	else
		set  @cmd  =  '交運日期：'+@t_btrandate+'～'+@t_etrandate+'&nbsp'+char(59)+'&nbsp'+char(59)+ @cmd
	select gno,@cmd titlea,custno cc,comp dd,mon,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total2),1)),4,12)) total2,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total3),1)),4,12)) total3,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,diff),1)),4,12)) diff,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,trdmoney1),1)),4,12)) trdm1,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,trdmoney2),1)),4,12)) trdm2,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,trdmoney3),1)),4,12)) trdm3,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,unpay),1)),4,12)) unpay,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total4),1)),4,12)) total4,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,@z_plusmoney),1)),4,12)) plusmoney,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,@z_minusmoney),1)),4,12)) minusmoney,
		(reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total4),1)),4,12))+' + '+
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,@z_plusmoney),1)),4,12))+' - '+
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,@z_minusmoney),1)),4,12))+' = '+
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total4+@z_plusmoney-@z_minusmoney),1)),4,12))) total5
	from @tmp order by custno,gno,mon
	
	-------------------------------------------------------------------------------------------------------------------
	drop table #carkind
	drop table #carteam
	drop table #calctype;
	
	
--*****************************************************************	
z_tran29:--z_tran29

SET QUOTED_IDENTIFIER OFF

declare @t_btrandate nvarchar(10)
declare @t_etrandate nvarchar(10)
declare @t_bdriverno nvarchar(20)
declare @t_edriverno nvarchar(20)
declare @t_carno nvarchar(20)
declare @t_po nvarchar(20)
declare @t_baddr nvarchar(20)
declare @t_eaddr nvarchar(20)
declare @t_cno nvarchar(20)
declare @t_product  nvarchar(max)

set @t_btrandate = case when '#non'=[4] then '' else [4] end
set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
set @t_bdriverno = case when '#non'=[8] then '' else [8] end
set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
set @t_carno = case when '#non'=[10] then '' else [10] end
set @t_po = case when '#non'=[11] then '' else [11] end
set @t_baddr = case when '#non'=[12] then '' else [12] end
set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
set @t_cno = case when '#non'=[14] then '' else [14] end
set @t_product = case when '#non'=[55] then '' else [55] end
---------------------------------------------------------------------
declare @tmp table( 
	gno nvarchar(1), 
	trandate nvarchar(10), 
	carno nvarchar(20), 
	straddrno nvarchar(max), 
	straddr nvarchar(max), 
	caseno nvarchar(20), 
	product nvarchar(20), 
	dtime nvarchar(10), 
	po nvarchar(20), 
	mount float, 
	total float, 
	memo nvarchar(max) 
) 

insert into @tmp 
select '0',trandate,carno,straddrno,straddr,caseno,product,dtime,po,mount,total,memo 
from view_trans 
where(trandate between @t_btrandate and @t_etrandate) and (LEN(@t_carno)=0 or carno=@t_carno) and (LEN(@t_po)=0 or po=@t_po) and 
	 (straddrno between @t_baddr and @t_eaddr) and (driverno between @t_bdriverno and @t_edriverno) and 
	 (custno = 'A239') and (LEN(@t_product)=0 or CHARINDEX(LEFT(@t_product,2),product)>0) 

insert into @tmp(gno,mount,total) 
select '1',SUM(mount),SUM(total) from @tmp 

select 
*,dbo.getComma(mount,0)mnt,dbo.getComma(total,0)ttl, 
'日期區間'+@t_btrandate+'至'+@t_etrandate btoe,RTRIM(@t_cno)+'請款明細表' cno 
from @tmp order by gno,trandate,straddrno,carno;



--*****************************************************************	
z_tran30:--z_tran30
declare @t_btrandate nvarchar(10)
declare @t_etrandate nvarchar(10)
declare @t_carno nvarchar(20)
declare @t_po nvarchar(20)
declare @t_baddr nvarchar(20)
declare @t_eaddr nvarchar(20)
declare @t_bnoa nvarchar(20)
declare @t_enoa nvarchar(20)
declare @t_caseno nvarchar(20)
declare @t_check nvarchar(20)

set @t_btrandate = case when '#non'=[4] then '' else [4] end
set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
set @t_carno = case when '#non'=[10] then '' else [10] end
set @t_po = case when '#non'=[11] then '' else [11] end
set @t_baddr = case when '#non'=[12] then '' else [12] end
set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
set @t_bnoa = case when '#non'=[51] then '' else [51] end
set @t_enoa = case when '#non'=[52] then CHAR(255) else [52] end
set @t_caseno = case when '#non'=[53] then '' else [53] end
set @t_check = case when '#non'=[54] then '' else [54] end
--------------------------------------------------------------------
declare @tmp table( 
	gno nvarchar(1), 
	trandate nvarchar(10), 
	carno nvarchar(20), 
	driver nvarchar(50), 
	nick nvarchar(20), 
	calctype nvarchar(20), 
	carteamno nvarchar(20), 
	straddr nvarchar(50), 
	product nvarchar(50), 
	caseno nvarchar(50), 
	validation bit, 
	chk nvarchar(10), 
	po nvarchar(50), 
	inmount float, 
	price float, 
	total float, 
	outmount float, 
	price2 float, 
	price3 float, 
	discount float, 
	total2 float, 
	dtime nvarchar(20), 
	tolls float, 
	reserve float, 
	gross float, 
	weight float, 
	bmiles float, 
	emiles float, 
	sales nvarchar(50), 
	memo nvarchar(max) 
) 

insert into @tmp 
select '0',b.trandate,b.carno,b.driver,b.nick,c.typea,d.team,b.straddr,b.product,b.caseno,b.validation,'',b.po, 
isnull(b.inmount,0),b.price,isnull(b.total,0),isnull(b.outmount,0),b.price2,b.price3,b.discount,isnull(b.total2,0),b.dtime,b.tolls,b.reserve, 
b.gross,b.weight,b.bmiles,b.emiles,b.sales,b.memo 
from twport a 
left join twports b on a.noa = b.noa 
left join calctypes c on b.calctype = c.noa+c.noq
left join carteam d on b.carteamno = d.noa
where (b.trandate between @t_btrandate and @t_etrandate) and (LEN(@t_carno)=0 or b.carno=@t_carno) and (LEN(@t_po)=0 or b.po=@t_po) and 
	  (isnull(b.straddrno,'') between @t_baddr and @t_eaddr) and (LEN(@t_caseno)=0 or b.caseno=@t_caseno) and 
	  (((b.validation=0 or b.validation=1) and LEN(@t_check)=0) or (b.validation=1 and CHARINDEX('yes',@t_check)>0) or (b.validation=0 and CHARINDEX('no',@t_check)>0)) 

update @tmp set chk = case when validation = 0 then 'x' 
when validation = 1 then 'v' end	

insert into @tmp(gno,total,total2) 
select '1',SUM(total),SUM(total2) 
from @tmp 


select 
*,ROW_NUMBER() over (order by gno,trandate,straddr,po,carno) rec,'日期區間'+@t_btrandate+'至'+@t_etrandate btoe,dbo.getComma(inmount,3)inmnt,dbo.getComma(price,3)prc,dbo.getComma(total,0)ttl, 
dbo.getComma(outmount,3)outmnt,dbo.getComma(price2,3)prc2,dbo.getComma(price3,3)prc3,dbo.getComma(total2,0)ttl2 
from @tmp order by gno,trandate,straddr,po,carno;