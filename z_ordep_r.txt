z_ordep_r1:--z_ordep_r1
declare @t_noa nvarchar(30)
set @t_noa = case when '#non' = [5] then '' else [5] end
--***********************************************************************************
declare @tmp table(
	gno nvarchar(10),
	noa nvarchar(30),
	custno nvarchar(30),
	comp nvarchar(200),
	conn nvarchar(50),
	addr nvarchar(Max),
	contract nvarchar(50),
	custorde nvarchar(50),
	tel nvarchar(50),
	fax nvarchar(50),
	odate nvarchar(20),
	datea nvarchar(20),
	payment nvarchar(MAX),
	shipment nvarchar(MAX),
	terms nvarchar(50),
	memo nvarchar(MAX),
	coin nvarchar(20),
	main nvarchar(MAX),
	side nvarchar(MAX),
	
	noq nvarchar(10),
	pno nvarchar(50),
	product nvarchar(MAX),
	mount float,
	unit nvarchar(30),
	price float,
	total float
)

insert @tmp
select '0',a.noa,a.custno,a.comp,c.conn
,case when isnull(a.addr2,'')!='' then isnull(a.post2,'')+' '+isnull(a.addr2,'') else isnull(a.post,'')+' '+isnull(a.addr,'') end
,a.contract,a.custorde,a.tel,a.fax,a.odate,a.datea,a.paytype
,a.trantype
+case when ISNULL(c.bdock,'')!='' then ' From:'+c.bdock else '' end
+case when ISNULL(c.edock,'')!='' then ' To:'+c.edock else '' end
,c.payterms,a.memo,case when isnull(a.coin,'')='' then 'NT' else a.coin end
,Replace(Replace(Replace(c.main,'chr(10)','</BR>'),'　','&nbsp&nbsp'),'~#$','''')
,Replace(Replace(Replace(c.side,'chr(10)','</BR>'),'　','&nbsp&nbsp'),'~#$','''')
,b.no2,SUBSTRING(b.productno,0,CHARINDEX('80',b.productno)+2)+'</BR>'+SUBSTRING(b.productno,CHARINDEX('80',b.productno)+2,len(b.productno)-CHARINDEX('80',b.productno))
,b.product+case when isnull(b.spec,'')!='' then '<BR>'+b.spec else '' end ,b.mount,b.unit,b.price,b.total
from view_orde a left join view_ordes b on a.noa=b.noa
left join view_ordei  c on a.noa=c.noa
where a.noa=@t_noa

if((select count(*) from @tmp)>0)
begin
	insert @tmp(gno,noa,noq,total,main,side,comp)
	select '1',noa,CHAR(255),SUM(total),MAX(main),MAX(side),MAX(comp) from @tmp group by noa
end

select
dbo.getComma(mount,-1) mount,
dbo.getComma(price,-1) price,
dbo.getComma(total,-1) total,
* from @tmp order by noa,gno,noq
;

--**********************************************************************************************
z_ordep_r2:--z_ordep_r2
declare @t_noa nvarchar(30)
set @t_noa = case when '#non' = [5] then '' else [5] end
--***********************************************************************************
declare @tmp table(
	gno nvarchar(10),
	noa nvarchar(30),
	custno nvarchar(30),
	comp nvarchar(200),
	conn nvarchar(50),
	addr nvarchar(Max),
	contract nvarchar(50),
	custorde nvarchar(50),
	tel nvarchar(50),
	fax nvarchar(50),
	odate nvarchar(20),
	datea nvarchar(20),
	payment nvarchar(MAX),
	shipment nvarchar(MAX),
	terms nvarchar(50),
	memo nvarchar(MAX),
	coin nvarchar(20),
	main nvarchar(MAX),
	side nvarchar(MAX),
	
	noq nvarchar(10),
	pno nvarchar(50),
	product nvarchar(MAX),
	mount float,
	unit nvarchar(30),
	price float,
	total float
)

insert @tmp
select '0',a.noa,a.custno,a.comp,c.conn
,case when isnull(a.addr2,'')!='' then isnull(a.post2,'')+' '+isnull(a.addr2,'') else isnull(a.post,'')+' '+isnull(a.addr,'') end
,a.contract,a.custorde,a.tel,a.fax,a.odate,a.datea,a.paytype
,a.trantype
+case when ISNULL(c.bdock,'')!='' then ' From:'+c.bdock else '' end
+case when ISNULL(c.edock,'')!='' then ' To:'+c.edock else '' end
,c.payterms,a.memo,case when isnull(a.coin,'')='' then 'NT' else a.coin end
,Replace(Replace(Replace(c.main,'chr(10)','</BR>'),'　','&nbsp&nbsp'),'~#$','''')
,Replace(Replace(Replace(c.side,'chr(10)','</BR>'),'　','&nbsp&nbsp'),'~#$','''')
,b.no2,SUBSTRING(b.productno,0,CHARINDEX('80',b.productno)+2)+'</BR>'+SUBSTRING(b.productno,CHARINDEX('80',b.productno)+2,len(b.productno)-CHARINDEX('80',b.productno))
,b.product+case when isnull(b.spec,'')!='' then '<BR>'+b.spec else '' end ,b.mount,b.unit,b.price,b.total
from view_orde a left join view_ordes b on a.noa=b.noa
left join view_ordei  c on a.noa=c.noa
where a.noa=@t_noa

if((select count(*) from @tmp)>0)
begin
	insert @tmp(gno,noa,noq,total,main,side,comp)
	select '1',noa,CHAR(255),SUM(total),MAX(main),MAX(side),MAX(comp) from @tmp group by noa
end

select
dbo.getComma(mount,-1) mount,
dbo.getComma(price,-1) price,
dbo.getComma(total,-1) total,
* from @tmp order by noa,gno,noq
;
--**********************************************************************************************
z_ordep_r3:--z_ordep_r3
declare @t_noa nvarchar(30)
--declare @t_showc nvarchar(30)
declare @t_target nvarchar(30)
set @t_noa = case when '#non' =[5]  then '' else [5]  end
--set @t_showc = case when '#non' =[6]  then '' else [6]  end
set @t_target = case when '#non' =[6]  then 'cust' else [6]  end
declare @t_ip nvarchar(50) = '[15]'
--***********************************************************************************
declare @tmp table(
	gno nvarchar(10),
	idno int identity(0,1),
	page int,
	pageno int,
	noa nvarchar(30),
	no2 nvarchar(30),
	custorde nvarchar(50),
	custno nvarchar(30),
	comp nvarchar(200),
	conn nvarchar(50),
	addr nvarchar(Max),
	contract nvarchar(50),
	tel nvarchar(50),
	fax nvarchar(50),
	odate nvarchar(20),
	datea nvarchar(20),
	payment nvarchar(MAX),
	shipment nvarchar(MAX),
	terms nvarchar(50),
	memo nvarchar(MAX),
	coin nvarchar(20),
	floata float,
	image1 nvarchar(max),
	
	pno nvarchar(50),
	product nvarchar(MAX),
	spec nvarchar(max),
	scoin nvarchar(50),
	aprice float,
	amount float,
	atotal float,
	mount float,
	unit nvarchar(30),
	price float,	
	total float,
	ototal nvarchar(max)
)

declare @noa nvarchar(50)
declare @no2 nvarchar(50)
declare @payterms nvarchar(50)
declare @pageline int = 40--每頁幾行
declare @page int=1 --頁數
declare @pagecount int=1 --目前行數
declare @tdatecount int=isnull((select count(*) from view_ordes where noa=@t_noa),0) --報價資料數
declare @datecount int=0 --目前已插入報價資料數

--表頭
insert into @tmp(gno,noa,page,pageno,custorde,custno,comp,addr,conn,tel,fax,odate,payment,shipment,terms)
select '1',a.noa,@page,@pagecount,a.custorde,a.custno,a.comp,a.addr,b.conn,a.tel,fax,a.odate,paytype,
a.trantype
+case when ISNULL(bdock,'')!='' then ' From:'+bdock else '' end
+case when ISNULL(edock,'')!='' then ' To:'+edock else '' end
,case when @t_target='cust' then REPLACE(a.payterms,'＆C','') else a.payterms end--,a.payterms
from view_orde a left join view_ordei b on a.noa=b.noa where a.noa=@t_noa 

set @pagecount=@pagecount+12

--資料行
declare cursor_table cursor for 
select noa,no2,payterms from view_ordes where noa=@t_noa order by noa,no2
open cursor_table
fetch next from cursor_table
into @noa,@no2,@payterms
while(@@FETCH_STATUS <> -1)
begin
	set @datecount=@datecount+1
	
	--if(right(@payterms,2)='＆C' and len(@t_showc)=0)
	--begin
	--	insert into @tmp
	--	select '0',@page,@pagecount,a.noa,b.no2,a.custorde,a.custno,a.comp,c.conn
	--	,case when isnull(a.addr2,'')!='' then isnull(a.post2,'')+' '+isnull(a.addr2,'') else isnull(a.post,'')+' '+isnull(a.addr,'') end
	--	,a.contract,a.tel,a.fax,a.odate,a.datea,a.paytype
	--	,a.trantype
	--	+case when ISNULL(c.bdock,'')!='' then ' From:'+c.bdock else '' end
	--	+case when ISNULL(c.edock,'')!='' then ' To:'+c.edock else '' end
	--	,b.size,a.memo,case when isnull(a.coin,'')='' then 'NT' else a.coin end+'$',isnull(a.floata,''),
	--	'<img width="300px" src="../images/upload/'+replace(b.productno,'/','CHR(47)')+'_01.jpg">'
	--	,b.productno,b.product+case when isnull(b.spec,'')!='' then '<BR>'+b.spec else '' end ,b.spec
	--	,':'+case when isnull(a.coin,'')='' then 'NT' else a.coin end+'$',b.radius,b.mount,isnull(b.radius,0)*isnull(b.mount,0),a.mount,b.unit,isnull(a.floata,'')*b.radius
	--	,a.total,''
	--	from view_orde a left join view_ordes b on a.noa=b.noa
	--	left join view_ordei c on a.noa=c.noa
	--	where a.noa=@noa and no2=@no2
	--end
	--else
	--begin
		insert into @tmp
		select '0',@page,@pagecount,a.noa,b.no2,a.custorde,a.custno,a.comp,c.conn
		,case when isnull(a.addr2,'')!='' then isnull(a.post2,'')+' '+isnull(a.addr2,'') else isnull(a.post,'')+' '+isnull(a.addr,'') end
		,a.contract,a.tel,a.fax,a.odate,a.datea,a.paytype
		,a.trantype
		+case when ISNULL(c.bdock,'')!='' then ' From:'+c.bdock else '' end
		+case when ISNULL(c.edock,'')!='' then ' To:'+c.edock else '' end
		,case when @t_target='cust' then REPLACE(a.payterms,'＆C','') else a.payterms end--,a.payterms
		,a.memo,case when isnull(a.coin,'')='' then 'NT' else a.coin end+'$',isnull(a.floata,''),
		'<img width="300" src="http://'+@t_ip+'/images/upload/'+replace(b.productno,'/','CHR(47)')+'_01.jpg">'
		,b.productno,b.product+case when isnull(b.spec,'')!='' then '<BR>'+b.spec else '' end ,b.spec
		,':'+case when isnull(a.coin,'')='' then 'NT' else a.coin end+'$',b.price,b.mount,isnull(b.price,0)*isnull(b.mount,0),a.mount,b.unit,isnull(a.floata,'')*b.price
		,a.total,''
		from view_orde a left join view_ordes b on a.noa=b.noa
		left join view_ordei c on a.noa=c.noa
		where a.noa=@noa and no2=@no2
	--end
	
	set @pagecount=@pagecount+13 --一個品項暫13行
	
	if(@tdatecount>1 and @tdatecount!=@datecount and @datecount%2=0)--資料筆數2以上 且 單行筆數
	begin
		--差入空白頁
		while (@pagecount%@pageline!=0)
		begin
			insert @tmp (gno,page,pageno,noa)
			select '2',@page,@pagecount,@noa
			
			set @pagecount=@pagecount+1
		end
		
		--插入分頁
		insert @tmp (gno,page,pageno,noa)
		select '3',@page,@pagecount,@noa
		
		set @pagecount=1
		set @page=@page+1
		
		--插入第二頁以上的 抬頭
		insert into @tmp(gno,noa,page,pageno,custno,comp,addr,conn,tel,fax,odate,payment,shipment,terms)
		select '4',a.noa,@page,@pagecount,a.custno,a.comp,a.addr,b.conn,a.tel,a.fax,a.odate,a.paytype,
		a.trantype
		+case when ISNULL(bdock,'')!='' then ' From:'+bdock else '' end
		+case when ISNULL(edock,'')!='' then ' To:'+edock else '' end	
		,case when @t_target='cust' then REPLACE(a.payterms,'＆C','') else a.payterms end--,a.payterms
		from view_orde a left join view_ordei b on a.noa=b.noa where a.noa=@t_noa 
		
		set @pagecount=@pagecount+4
	end
	else if (@tdatecount=@datecount) --最後一筆
	begin
		update a
		set total=isnull((select SUM(round(atotal,0)) from @tmp where noa=a.noa),0)
		from @tmp a
	
		--合計
		insert into @tmp(gno,page,pageno,noa,no2,mount,unit,coin,total)
		select '5',@page,@pagecount,noa,CHAR(255),mount,MAX(unit),coin,total
		from @tmp where gno='0' group by noa,mount,coin,total
		set @pagecount=@pagecount+2

		--合計(英文大寫)
		insert into @tmp(gno,page,pageno,noa,ototal)
		select '6',@page,@pagecount,noa,('SAY TOTAL U.S DOLLAR '+UPPER(dbo.currencyToEnglish(total))) 
		from @tmp where gno='0' group by noa,total
		set @pagecount=@pagecount+1
		
		--插入空白行
		while ((@pagecount+1)%@pageline!=0) --1行結束
		begin
			insert @tmp (gno,page,pageno,noa)
			select '7',@page,@pagecount,@noa
				
			set @pagecount=@pagecount+1
		end
			
		--結束
		insert into @tmp(gno,noa,page,pageno)
		select '8',noa,@page,@pagecount from @tmp where gno='0'
		group by noa,comp
		
		set @pagecount=1
		set @page=@page+1
	
	end
	
	fetch next from cursor_table
	into @noa,@no2,@payterms
end
close cursor_table
deallocate cursor_table

update a 
set mount =(select sum(amount) from @tmp where noa=a.noa and gno='0')
from @tmp a
where gno='5'

select
dbo.getComma(amount,0)amount,
dbo.getComma(mount,0) mount,
dbo.getComma(aprice,3)aprice,
dbo.getComma(atotal,3)atotal,
dbo.getComma(price,2)price,
dbo.getComma(total,2)total,
(select productno from ucccust where custno=a.custno and noa=a.pno)custpno,
* from @tmp a order by idno
;
--**********************************************************************************************
z_ordep_r4:--z_ordep_r4
declare @t_noa nvarchar(30)
--declare @t_showc nvarchar(30)
declare @t_target nvarchar(30)
set @t_noa = case when '#non' =[5]  then '' else [5]  end
--set @t_showc = case when '#non' =[6]  then '' else [6]  end
set @t_target = case when '#non' =[6]  then 'cust' else [6]  end
declare @t_ip nvarchar(50) = '[15]'
--***********************************************************************************
declare @tmp table(
	gno nvarchar(10),
	idno int identity(0,1),
	page int,
	pageno int,
	noa nvarchar(30),
	no2 nvarchar(30),
	custorde nvarchar(50),
	custno nvarchar(30),
	comp nvarchar(200),
	conn nvarchar(50),
	addr nvarchar(Max),
	contract nvarchar(50),
	tel nvarchar(50),
	fax nvarchar(50),
	odate nvarchar(20),
	datea nvarchar(20),
	payment nvarchar(MAX),
	shipment nvarchar(MAX),
	terms nvarchar(50),
	memo nvarchar(MAX),
	coin nvarchar(20),
	floata float,
	image1 nvarchar(max),
	image2 nvarchar(max),
	
	pno nvarchar(50),
	product nvarchar(MAX),
	spec nvarchar(max),
	custpno nvarchar(50),
	ucano nvarchar(50),
	pctn float,
	nw float,
	gw float,
	cuft float,
	cbm float,
	ctn float,
	needadd float,
	
	scoin nvarchar(50),
	aprice float,
	amount float,
	atotal float,
	mount float,
	unit nvarchar(30),
	price float,
	total float,
	
	tnw float,
	tgw float,
	tcuft float,
	tcbm float,
	tctn float,
	
	main nvarchar(MAX),
	side nvarchar(MAX),
	etotal nvarchar(max),
	ectn nvarchar(max)
)

declare @noa nvarchar(50)
declare @no2 nvarchar(50)
declare @payterms nvarchar(50)
declare @pageline int = 40--每頁幾行
declare @page int=1 --頁數
declare @pagecount int=1 --目前行數
declare @tdatecount int=isnull((select count(*) from view_ordes where noa=@t_noa),0) --報價資料數
declare @datecount int=0 --目前已插入報價資料數

--表頭
insert into @tmp(gno,noa,page,pageno,custorde,custno,comp,addr,conn,tel,fax,odate,payment,shipment,terms)
select '1',a.noa,@page,@pagecount,a.custorde,a.custno,a.comp,a.addr,b.conn,a.tel,fax,a.odate,paytype,
a.trantype
+case when ISNULL(bdock,'')!='' then ' From:'+bdock else '' end
+case when ISNULL(edock,'')!='' then ' To:'+edock else '' end
,case when @t_target='cust' then REPLACE(a.payterms,'＆C','') else a.payterms end--,a.payterms
from view_orde a left join view_ordei b on a.noa=b.noa where a.noa=@t_noa 

set @pagecount=@pagecount+9

--資料行
declare cursor_table cursor for 
select noa,no2,payterms from view_ordes where noa=@t_noa order by noa,no2
open cursor_table
fetch next from cursor_table
into @noa,@no2,@payterms
while(@@FETCH_STATUS <> -1)
begin
	set @datecount=@datecount+1
	
	--if(right(@payterms,2)='＆C' and len(@t_showc)=0)
	--begin
	--	insert into @tmp
	--	select '0',@page,@pagecount,a.noa,b.no2,a.custorde,a.custno,a.comp,c.conn
	--	,case when isnull(a.addr2,'')!='' then isnull(a.post2,'')+' '+isnull(a.addr2,'') else isnull(a.post,'')+' '+isnull(a.addr,'') end
	--	,a.contract,a.tel,a.fax,a.odate,a.datea,a.paytype,a.trantype
	--	+case when ISNULL(c.bdock,'')!='' then ' From:'+c.bdock else '' end
	--	+case when ISNULL(c.edock,'')!='' then ' To:'+c.edock else '' end
	--	,b.size,a.memo,case when isnull(a.coin,'')='' then 'NT' else a.coin end+'$',isnull(a.floata,'')
	--	,'<img width="180px" src="../images/upload/'+replace(b.productno,'/','CHR(47)')+'_01.jpg">'
	--	,'<img width="180px" src="../images/upload/'+replace(b.productno,'/','CHR(47)')+'_02.jpg">'
	--	,b.productno,b.product,b.spec,(select productno from ucccust where custno=a.custno and noa=b.productno)
	--	,(select case when ucano!='' then ucano else uccno end from ucx where noa=b.productno)
	--	,d.inmount*d.outmount,d.weight,d.gweight,d.cuft,d.cbm
	--	,case when isnull(d.inmount,0)*isnull(d.outmount,0)=0 then 1 else ceiling(b.mount/(d.inmount*d.outmount)) end
	--	,(b.mount-floor (b.mount/d.inmount*d.outmount)*(d.inmount*d.outmount))
	--	,':'+case when isnull(a.coin,'')='' then 'NT' else a.coin end+'$'
	--	,b.radius,b.mount,isnull(b.radius,0)*isnull(b.mount,0),0,b.unit,isnull(a.floata,'')*b.radius,a.total
	--	,b.mount*d.uweight
	--	,d.gweight*floor (b.mount/d.inmount*d.outmount)--整箱
	--	+(b.mount-floor (b.mount/d.inmount*d.outmount)*d.inmount*d.outmount)*d.uweight--散裝淨重
	--	+case when (b.mount-(floor(b.mount/(d.inmount*d.outmount))*(d.inmount*d.outmount)))>0 then d.outweight else 0 end --外包裝重
	--	+case when (b.mount-(floor(b.mount/(d.inmount*d.outmount))*(d.inmount*d.outmount)))>0 then ceiling((b.mount-(floor(b.mount/(d.inmount*d.outmount))*(d.inmount*d.outmount)))/d.inmount)*d.inweight else 0 end tgw --內包裝重
	--	,d.cuft*case when isnull(d.inmount,0)*isnull(d.outmount,0)=0 then 1 else ceiling(b.mount/(d.inmount*d.outmount)) end
	--	,d.cbm*case when isnull(d.inmount,0)*isnull(d.outmount,0)=0 then 1 else ceiling(b.mount/(d.inmount*d.outmount)) end
	--	,case when isnull(d.inmount,0)*isnull(d.outmount,0)=0 then 1 else ceiling(b.mount/(d.inmount*d.outmount)) end
	--	,Replace(Replace(Replace(e.main,'chr(10)','</BR>'),'　','&nbsp&nbsp'),'~#$','''')
	--	,Replace(Replace(Replace(e.side,'chr(10)','</BR>'),'　','&nbsp&nbsp'),'~#$','''')
	--	,'',''
	--	from view_orde a left join view_ordes b on a.noa=b.noa
	--	left join view_ordei c on a.noa=c.noa
	--	left join pack2s d on d.noa=b.productno and d.packway=b.packwayno
	--	left join view_ordei e on a.noa=e.noa
	--	where a.noa=@noa and no2=@no2
	--end
	--else
	--begin
		insert into @tmp
		select '0',@page,@pagecount,a.noa,b.no2,a.custorde,a.custno,a.comp,c.conn
		,case when isnull(a.addr2,'')!='' then isnull(a.post2,'')+' '+isnull(a.addr2,'') else isnull(a.post,'')+' '+isnull(a.addr,'') end
		,a.contract,a.tel,a.fax,a.odate,a.datea,a.paytype,a.trantype
		+case when ISNULL(c.bdock,'')!='' then ' From:'+c.bdock else '' end
		+case when ISNULL(c.edock,'')!='' then ' To:'+c.edock else '' end
		,case when @t_target='cust' then REPLACE(a.payterms,'＆C','') else a.payterms end--,a.payterms
		,a.memo,case when isnull(a.coin,'')='' then 'NT' else a.coin end+'$',isnull(a.floata,'')
		,'<img width="180" src="http://'+@t_ip+'/images/upload/'+replace(b.productno,'/','CHR(47)')+'_01.jpg">'
		,'<img width="180" src="http://'+@t_ip+'/images/upload/'+replace(b.productno,'/','CHR(47)')+'_02.jpg">'
		,b.productno,b.product,b.spec,(select productno from ucccust where custno=a.custno and noa=b.productno)
		,(select case when ucano!='' then ucano else uccno end from ucx where noa=b.productno)
		,d.inmount*d.outmount,d.weight,d.gweight,d.cuft,d.cbm
		,case when isnull(d.inmount,0)*isnull(d.outmount,0)=0 then 1 else ceiling(b.mount/(d.inmount*d.outmount)) end
		,case when d.inmount!=0 then (b.mount-floor (b.mount/d.inmount*d.outmount)*(d.inmount*d.outmount)) else '' end
		,':'+case when isnull(a.coin,'')='' then 'NT' else a.coin end+'$'
		,b.price,b.mount,isnull(b.price,0)*isnull(b.mount,0),0,b.unit,isnull(a.floata,'')*b.price,a.total
		,b.mount*d.uweight
		,case when d.inmount!=0 then d.gweight*floor (b.mount/nullif(d.inmount*d.outmount,0)) else '' end--整箱
		+case when d.inmount!=0 then (b.mount-floor (b.mount/nullif(d.inmount*d.outmount,0))*d.inmount*d.outmount)*d.uweight else '' end--散裝淨重
		+case when (case when d.inmount!=0 then (b.mount-(floor(b.mount/nullif((d.inmount*d.outmount),0))*(d.inmount*d.outmount)))else '' end)>0 then d.outweight else 0 end --外包裝重
		+case when (case when d.inmount!=0 then (b.mount-(floor(b.mount/nullif((d.inmount*d.outmount),0))*(d.inmount*d.outmount)))else'' end)>0 then ceiling((b.mount-(floor(b.mount/(d.inmount*d.outmount))*(d.inmount*d.outmount)))/d.inmount)*d.inweight else 0 end tgw --內包裝重
		,d.cuft*case when isnull(d.inmount,0)*isnull(d.outmount,0)=0 then 1 else ceiling(b.mount/nullif((d.inmount*d.outmount),0)) end
		,d.cbm*case when isnull(d.inmount,0)*isnull(d.outmount,0)=0 then 1 else ceiling(b.mount/nullif((d.inmount*d.outmount),0)) end
		,case when isnull(d.inmount,0)*isnull(d.outmount,0)=0 then 1 else ceiling(b.mount/nullif((d.inmount*d.outmount),0)) end
		,Replace(Replace(Replace(e.main,'chr(10)','</BR>'),'　','&nbsp&nbsp'),'~#$','''')
		,Replace(Replace(Replace(e.side,'chr(10)','</BR>'),'　','&nbsp&nbsp'),'~#$','''')
		,'',''
		from view_orde a left join view_ordes b on a.noa=b.noa
		left join view_ordei c on a.noa=c.noa
		left join pack2s d on d.noa=b.productno and d.packway=b.packwayno
		left join view_ordei e on a.noa=e.noa
		where a.noa=@noa and no2=@no2
	--end
	
	set @pagecount=@pagecount+15 --一個品項暫13行
	
	if(@tdatecount>1 and @tdatecount!=@datecount and @datecount%2=0)--資料筆數2以上 且 單行筆數
	begin
		--差入空白頁
		while (@pagecount%@pageline!=0)
		begin
			insert @tmp (gno,page,pageno,noa)
			select '2',@page,@pagecount,@noa
			
			set @pagecount=@pagecount+1
		end
		
		--插入分頁
		insert @tmp (gno,page,pageno,noa)
		select '3',@page,@pagecount,@noa
		
		set @pagecount=1
		set @page=@page+1
		
		--插入第二頁以上的 抬頭
		insert into @tmp(gno,noa,page,pageno,custno,comp,addr,conn,tel,fax,odate,payment,shipment,terms)
		select '4',a.noa,@page,@pagecount,a.custno,a.comp,a.addr,b.conn,a.tel,a.fax,a.odate,a.paytype,
		a.trantype
		+case when ISNULL(bdock,'')!='' then ' From:'+bdock else '' end
		+case when ISNULL(edock,'')!='' then ' To:'+edock else '' end
		,case when @t_target='cust' then REPLACE(a.payterms,'＆C','') else a.payterms end--,a.payterms
		from view_orde a left join view_ordei b on a.noa=b.noa where a.noa=@t_noa 
		
		set @pagecount=@pagecount+3
	end
	else if (@tdatecount=@datecount) --最後一筆
	begin
		update a
		set total=isnull((select SUM(round(atotal,0)) from @tmp where noa=a.noa),0)
		from @tmp a
	
		--合計
		insert into @tmp(gno,page,pageno,noa,no2,mount,unit,coin,total)
		select '5',@page,@pagecount,noa,CHAR(255),mount,MAX(unit),coin,total
		from @tmp where gno='0' group by noa,mount,coin,total
		set @pagecount=@pagecount+1
		
		if(@pagecount>25) --換頁
		begin
			--差入空白頁
			while (@pagecount%@pageline!=0)
			begin
				insert @tmp (gno,page,pageno,noa)
				select '2',@page,@pagecount,@noa
				
				set @pagecount=@pagecount+1
			end
			
			--插入分頁
			insert @tmp (gno,page,pageno,noa)
			select '3',@page,@pagecount,@noa
			
			set @pagecount=1
			set @page=@page+1
			
			--插入第二頁以上的 抬頭
			insert into @tmp(gno,noa,page,pageno,custno,comp,addr,conn,tel,fax,odate,payment,shipment,terms)
			select '4',a.noa,@page,@pagecount,a.custno,a.comp,a.addr,b.conn,a.tel,a.fax,a.odate,a.paytype,
			a.trantype
			+case when ISNULL(bdock,'')!='' then ' From:'+bdock else '' end
			+case when ISNULL(edock,'')!='' then ' To:'+edock else '' end
			,case when @t_target='cust' then REPLACE(a.payterms,'＆C','') else a.payterms end--,a.payterms
			from view_orde a left join view_ordei b on a.noa=b.noa where a.noa=@t_noa 
			
			set @pagecount=@pagecount+3
		end
		
		--合計
		insert into @tmp(gno,page,pageno,noa,main,side)
		select '6',@page,@pagecount,noa,MAX(main),MAX(side)
		from @tmp where gno='0' group by noa
		set @pagecount=@pagecount+7

		--合計(英文大寫)
		insert into @tmp(gno,page,pageno,noa,etotal)
		select '7',@page,@pagecount,noa,('SAY TOTAL U.S DOLLAR '+UPPER(dbo.currencyToEnglish(total))) 
		from @tmp where gno='0' group by noa,total
		set @pagecount=@pagecount+1
		
		--合計(英文大寫)
		insert into @tmp(gno,page,pageno,noa,ectn)
		select '8',@page,@pagecount,noa,''--('SAY TOTAL '+UPPER(dbo.currencyToEnglish(tctn))+'CARTONS') 
		from @tmp where gno='0' group by noa
		set @pagecount=@pagecount+1
		
		--插入空白行
		while ((@pagecount+5+1)%@pageline!=0) --5簽名+1行結束
		begin
			insert @tmp (gno,page,pageno,noa)
			select '2',@page,@pagecount,@noa
				
			set @pagecount=@pagecount+1
		end
		
		--簽名
		insert into @tmp(gno,noa,page,pageno,comp)
		select '9',noa,@page,@pagecount,comp from @tmp where gno='0'
		group by noa,comp
			
		--結束
		insert into @tmp(gno,noa,page,pageno)
		select '10',noa,@page,@pagecount from @tmp where gno='0'
		group by noa,comp
		
		set @pagecount=1
		set @page=@page+1
	
	end
	
	fetch next from cursor_table
	into @noa,@no2,@payterms
end
close cursor_table
deallocate cursor_table

update a 
set mount =(select sum(amount) from @tmp where noa=a.noa and gno='0')
,tnw=(select sum(tnw) from @tmp where noa=a.noa and gno='0')
,tgw=(select sum(tgw) from @tmp where noa=a.noa and gno='0')
,tcuft=(select sum(tcuft) from @tmp where noa=a.noa and gno='0')
,tcbm=(select sum(tcbm) from @tmp where noa=a.noa and gno='0')
,tctn =(select sum(tctn) from @tmp where noa=a.noa and gno='0')
from @tmp a
where gno='5' or gno='8'

update a 
set ectn =('SAY TOTAL '+UPPER(dbo.currencyToEnglish(tctn))+'CARTONS') 
from @tmp a where gno='8'

update a 
set ectn =('SAY TOTAL '+UPPER(dbo.currencyToEnglish(tctn))+'CARTONS') 
from @tmp a where gno='8'

select
dbo.getComma(amount,0)amount,
dbo.getComma(mount,0) mount,
dbo.getComma(aprice,3)aprice,
dbo.getComma(atotal,3)atotal,
dbo.getComma(price,2)price,
dbo.getComma(total,2)total,
dbo.getComma(isnull(pctn,0),0)pctn,
dbo.getComma(isnull(nw,0),3)nw,
dbo.getComma(isnull(gw,0),3)gw,
dbo.getComma(isnull(cuft,0),2)cuft,
dbo.getComma(isnull(cbm,0),2)cbm,
dbo.getComma(isnull(ctn,0),0)ctn,
dbo.getComma(isnull(tnw,0),3)tnw,
dbo.getComma(isnull(tgw,0),3)tgw,
dbo.getComma(isnull(tcuft,0),2)tcuft,
dbo.getComma(isnull(tcbm,0),2)tcbm,
dbo.getComma(isnull(tctn,0),0)tctn,
case when needadd>0 then '(Need To Add '+dbo.getComma(needadd,-1)+' '+case when len(unit)=0 then 'Pcs' else unit end+')' else '' end needadd,
* from @tmp a order by idno
;

--------------------------------------------------------------------------------------------------------------------

z_ordep_r5:--z_ordep_r5
declare @t_noa nvarchar(30)
--declare @t_showc nvarchar(30)
declare @t_target nvarchar(30)
set @t_noa = case when '#non' =[5]  then '' else [5]  end
--set @t_showc = case when '#non' =[6]  then '' else [6]  end
set @t_target = case when '#non' =[6]  then 'cust' else [6]  end
declare @t_ip nvarchar(50) = '[15]'
--***********************************************************************************
declare @tmp table(
	gno nvarchar(10),
	idno int identity(0,1),
	page int,
	pageno int,
	noa nvarchar(30),
	no2 nvarchar(30),
	custorde nvarchar(50),
	custno nvarchar(30),
	comp nvarchar(200),
	conn nvarchar(50),
	addr nvarchar(Max),
	contract nvarchar(50),
	tel nvarchar(50),
	fax nvarchar(50),
	odate nvarchar(20),
	datea nvarchar(20),
	payment nvarchar(MAX),
	shipment nvarchar(MAX),
	terms nvarchar(50),
	memo nvarchar(MAX),
	coin nvarchar(20),
	floata float,
	image1 nvarchar(max),
	
	pno nvarchar(50),
	product nvarchar(MAX),
	spec nvarchar(max),
	scoin nvarchar(50),
	aprice float,
	amount float,
	atotal float,
	mount float,
	unit nvarchar(30),
	price float,	
	total float,
	ototal nvarchar(max),
	pctn float,
	nw float,
	gw float,
	cuft float,
	cbm float,
	ctn float,
	needadd float,
	sdate nvarchar(10),
	smount float,
	
	tnw float,
	tgw float,
	tcuft float,
	tcbm float,
	tctn float,
	
	main nvarchar(MAX),
	side nvarchar(MAX),
	ectn nvarchar(max)
)

declare @noa nvarchar(50)
declare @no2 nvarchar(50)
declare @payterms nvarchar(50)
declare @pageline int = 40--每頁幾行
declare @page int=1 --頁數
declare @pagecount int=1 --目前行數
declare @tdatecount int=isnull((select count(*) from view_ordes where noa=@t_noa),0) --報價資料數
declare @datecount int=0 --目前已插入報價資料數

--表頭
insert into @tmp(gno,noa,page,pageno,custorde,custno,comp,addr,conn,tel,fax,odate,payment,shipment,terms)
select '1',a.noa,@page,@pagecount,a.custorde,a.custno,a.comp,a.addr,b.conn,a.tel,fax,a.odate,paytype,
a.trantype
+case when ISNULL(bdock,'')!='' then ' From:'+bdock else '' end
+case when ISNULL(edock,'')!='' then ' To:'+edock else '' end
,case when @t_target='cust' then REPLACE(a.payterms,'＆C','') else a.payterms end--,a.payterms
from view_orde a left join view_ordei b on a.noa=b.noa where a.noa=@t_noa 

set @pagecount=@pagecount+12

--資料行
declare cursor_table cursor for 
select noa,no2,payterms from view_ordes where noa=@t_noa order by noa,no2
open cursor_table
fetch next from cursor_table
into @noa,@no2,@payterms
while(@@FETCH_STATUS <> -1)
begin
	set @datecount=@datecount+1
	
	--if(right(@payterms,2)='＆C' and len(@t_showc)=0)
	--begin
	--	insert into @tmp
	--	select '0',@page,@pagecount,a.noa,b.no2,a.custorde,a.custno,a.comp,c.conn
	--	,case when isnull(a.addr2,'')!='' then isnull(a.post2,'')+' '+isnull(a.addr2,'') else isnull(a.post,'')+' '+isnull(a.addr,'') end
	--	,a.contract,a.tel,a.fax,a.odate,a.datea,a.paytype
	--	,a.trantype
	--	+case when ISNULL(c.bdock,'')!='' then ' From:'+c.bdock else '' end
	--	+case when ISNULL(c.edock,'')!='' then ' To:'+c.edock else '' end
	--	,b.size,a.memo,case when isnull(a.coin,'')='' then 'NT' else a.coin end+'$',isnull(a.floata,''),
	--	'<img width="300px" src="../images/upload/'+replace(b.productno,'/','CHR(47)')+'_01.jpg">'
	--	,b.productno,b.product+case when isnull(b.spec,'')!='' then '<BR>'+b.spec else '' end ,b.spec
	--	,':'+case when isnull(a.coin,'')='' then 'NT' else a.coin end+'$',b.radius,b.mount,isnull(b.radius,0)*isnull(b.mount,0),a.mount,b.unit,isnull(a.floata,'')*b.radius
	--	,a.total,''
	--	from view_orde a left join view_ordes b on a.noa=b.noa
	--	left join view_ordei c on a.noa=c.noa
	--	where a.noa=@noa and no2=@no2
	--end
	--else
		--begin
				insert into @tmp
		select '0',@page,@pagecount,a.noa,b.no2,a.custorde,a.custno,a.comp,c.conn
		,case when isnull(a.addr2,'')!='' then isnull(a.post2,'')+' '+isnull(a.addr2,'') else isnull(a.post,'')+' '+isnull(a.addr,'') end
		,a.contract,a.tel,a.fax,a.odate,a.datea,a.paytype
		,a.trantype
		+case when ISNULL(c.bdock,'')!='' then ' From:'+c.bdock else '' end
		+case when ISNULL(c.edock,'')!='' then ' To:'+c.edock else '' end
		,case when @t_target='cust' then REPLACE(a.payterms,'＆C','') else a.payterms end--,a.payterms
		,a.memo,case when isnull(a.coin,'')='' then 'NT' else a.coin end+'$',isnull(a.floata,''),
		'<img width="300" src="http://'+@t_ip+'/images/upload/'+replace(b.productno,'/','CHR(47)')+'_01.jpg">'
		,b.productno,b.product+case when isnull(b.spec,'')!='' then '<BR>'+b.spec else '' end ,b.spec
		,':'+case when isnull(a.coin,'')='' then 'NT' else a.coin end+'$',b.price,b.mount,isnull(b.price,0)*isnull(b.mount,0),a.mount,b.unit,isnull(a.floata,'')*b.price
		,a.total
		,''
		,d.inmount*d.outmount,d.weight,d.gweight,d.cuft,d.cbm
		,case when isnull(d.inmount,0)*isnull(d.outmount,0)=0 then 1 else ceiling(b.mount/nullif((d.inmount*d.outmount),0)) end
		,case when d.inmount!=0 then (b.mount-floor (b.mount/nullif(d.inmount*d.outmount,0))*(d.inmount*d.outmount)) else '' end
		,f.etd,g.quantity
		,b.mount*d.uweight
		,case when d.inmount!=0 then d.gweight*floor (b.mount/nullif(d.inmount*d.outmount,0)) else '' end--整箱
		+case when d.inmount!=0 then (b.mount-floor (b.mount/nullif(d.inmount*d.outmount,0))*d.inmount*d.outmount)*d.uweight else '' end--散裝淨重
		+case when (case when d.inmount!=0 then (b.mount-(floor(b.mount/nullif((d.inmount*d.outmount),0))*(d.inmount*d.outmount))) else '' end)>0 then d.outweight else 0 end --外包裝重
		+case when (case when d.inmount!=0 then (b.mount-(floor(b.mount/nullif((d.inmount*d.outmount),0))*(d.inmount*d.outmount))) else '' end)>0 then ceiling((b.mount-(floor(b.mount/(d.inmount*d.outmount))*(d.inmount*d.outmount)))/d.inmount)*d.inweight else 0 end tgw --內包裝重
		,d.cuft*case when isnull(d.inmount,0)*isnull(d.outmount,0)=0 then 1 else ceiling(b.mount/nullif((d.inmount*d.outmount),0)) end
		,d.cbm*case when isnull(d.inmount,0)*isnull(d.outmount,0)=0 then 1 else ceiling(b.mount/nullif((d.inmount*d.outmount),0)) end
		,case when isnull(d.inmount,0)*isnull(d.outmount,0)=0 then 1 else ceiling(b.mount/nullif((d.inmount*d.outmount),0)) end
		,Replace(Replace(Replace(c.main,'chr(10)','</BR>'),'　','&nbsp&nbsp'),'~#$','''')
		,Replace(Replace(Replace(c.side,'chr(10)','</BR>'),'　','&nbsp&nbsp'),'~#$','''')
		,''
		from view_orde a left join view_ordes b on a.noa=b.noa
		left join view_ordei c on a.noa=c.noa
		left join pack2s d on d.noa=b.productno and d.packway=b.packwayno
		left join invo f on a.noa=f.ordeno
		left join invos g on a.noa=g.ordeno and b.no2=g.no2
		where a.noa=@noa and b.no2=@no2
	--end
	
	set @pagecount=@pagecount+16 --一個品項暫13行
	
	if(@tdatecount>1 and @tdatecount!=@datecount and @datecount%4=0)--資料筆數4以上 且 單行筆數
	begin
		--差入空白頁
		while (@pagecount%@pageline!=0)
		begin
			insert @tmp (gno,page,pageno,noa)
			select '2',@page,@pagecount,@noa
			
			set @pagecount=@pagecount+1
		end
		
		--插入分頁
		insert @tmp (gno,page,pageno,noa)
		select '3',@page,@pagecount,@noa
		
		set @pagecount=1
		set @page=@page+1
		
		--插入第二頁以上的 抬頭
		insert into @tmp(gno,noa,page,pageno,custno,comp,addr,conn,tel,fax,odate,payment,shipment,terms)
		select '4',a.noa,@page,@pagecount,a.custno,a.comp,a.addr,b.conn,a.tel,a.fax,a.odate,a.paytype,
		a.trantype
		+case when ISNULL(bdock,'')!='' then ' From:'+bdock else '' end
		+case when ISNULL(edock,'')!='' then ' To:'+edock else '' end	
		,case when @t_target='cust' then REPLACE(a.payterms,'＆C','') else a.payterms end--,a.payterms
		from view_orde a left join view_ordei b on a.noa=b.noa where a.noa=@t_noa 
		
		set @pagecount=@pagecount+5
	end
	else if (@tdatecount=@datecount) --最後一筆
	begin
		update a
		set total=isnull((select SUM(round(atotal,0)) from @tmp where noa=a.noa),0)
		from @tmp a
	
		--合計
		insert into @tmp(gno,page,pageno,noa,no2,comp,mount,unit,coin,total,tnw,tgw,tcuft,tcbm,tctn)
		select '5',@page,@pagecount,noa,CHAR(255),comp,sum(amount),MAX(unit),coin,sum(atotal),sum(tnw),sum(tgw),sum(tcuft),sum(tcbm),sum(tctn)
		from @tmp where gno='0' group by noa,mount,coin,total,comp
		set @pagecount=@pagecount+1	


		--合計(英文大寫)
		insert into @tmp(gno,page,pageno,noa,ototal)
		select '6',@page,@pagecount,noa,('SAY TOTAL U.S DOLLAR '+UPPER(dbo.currencyToEnglish(total))) 
		from @tmp where gno='0' group by noa,total
		set @pagecount=@pagecount+1
		
		
		--合計(英文大寫)
		insert into @tmp(gno,page,pageno,noa,ectn)
		select '7',@page,@pagecount,noa,''--('SAY TOTAL '+UPPER(dbo.currencyToEnglish(tctn))+'CARTONS') 
		from @tmp where gno='0' group by noa
		set @pagecount=@pagecount+1
		
		--MARK
		insert into @tmp(gno,page,pageno,noa,main,side)
		select '8',@page,@pagecount,noa,main,side
		from @tmp where gno='0' 
		group by noa,main,side
		
		set @pagecount=@pagecount+10
		
		--插入空白行
		while ((@pagecount+1)%@pageline!=0) --1行結束
		begin
			insert @tmp (gno,page,pageno,noa)
			select '2',@page,@pagecount,@noa
				
			set @pagecount=@pagecount+1
		end
			
		--簽名
		insert into @tmp(gno,noa,page,pageno,comp)
		select '9',noa,@page,@pagecount,comp from @tmp where gno='0'
		group by noa,comp,main,side
			
		--結束
		insert into @tmp(gno,noa,page,pageno)
		select '10',noa,@page,@pagecount from @tmp where gno='0'
		group by noa,comp

		set @pagecount=1
		set @page=@page+1
	
	end
	
	fetch next from cursor_table
	into @noa,@no2,@payterms
end
close cursor_table
deallocate cursor_table

update a 
set mount =(select sum(amount) from @tmp where noa=a.noa and gno='0')
from @tmp a
where gno='5'

update a 
set mount =(select sum(amount) from @tmp where noa=a.noa and gno='0')
,tnw=(select sum(tnw) from @tmp where noa=a.noa and gno='0')
,tgw=(select sum(tgw) from @tmp where noa=a.noa and gno='0')
,tcuft=(select sum(tcuft) from @tmp where noa=a.noa and gno='0')
,tcbm=(select sum(tcbm) from @tmp where noa=a.noa and gno='0')
,tctn =(select sum(tctn) from @tmp where noa=a.noa and gno='0')
from @tmp a
where gno='5' or gno='7'

update a 
set ectn =('SAY TOTAL '+UPPER(dbo.currencyToEnglish(tctn))+'CARTONS') 
from @tmp a where gno='7'

update a 
set ectn =('SAY TOTAL '+UPPER(dbo.currencyToEnglish(tctn))+'CARTONS') 
from @tmp a where gno='7'

select
dbo.getComma(amount,0)amount,
dbo.getComma(mount,0) mount,
dbo.getComma(aprice,3)aprice,
dbo.getComma(atotal,3)atotal,
dbo.getComma(price,2)price,
dbo.getComma(total,2)total,
(select productno from ucccust where custno=a.custno and noa=a.pno)custpno,
* from @tmp a order by idno
;
--------------------------------------------------------------------------------------------------------------------
z_ordep_r6:--z_ordep_r6
declare @t_noa nvarchar(30)
--declare @t_showc nvarchar(30)
declare @t_target nvarchar(30)
set @t_noa = case when '#non' =[5]  then '' else [5]  end
--set @t_showc = case when '#non' =[6]  then '' else [6]  end
set @t_target = case when '#non' =[6]  then 'cust' else [6]  end
declare @t_ip nvarchar(50) = '[15]'
--***********************************************************************************
declare @tmp table(
	gno nvarchar(10),
	idno int identity(0,1),
	page int,
	pageno int,
	noa nvarchar(30),
	no2 nvarchar(30),
	custorde nvarchar(50),
	custno nvarchar(30),
	comp nvarchar(200),
	conn nvarchar(50),
	addr nvarchar(Max),
	contract nvarchar(50),
	tel nvarchar(50),
	fax nvarchar(50),
	odate nvarchar(20),
	datea nvarchar(20),
	payment nvarchar(MAX),
	shipment nvarchar(MAX),
	terms nvarchar(50),
	memo nvarchar(MAX),
	coin nvarchar(20),
	floata float,
	image1 nvarchar(max),
	image2 nvarchar(max),
	
	pno nvarchar(50),
	product nvarchar(MAX),
	spec nvarchar(max),
	custpno nvarchar(50),
	ucano nvarchar(50),
	pctn float,
	nw float,
	gw float,
	cuft float,
	cbm float,
	ctn float,
	needadd float,
	sdate nvarchar(10),
	smount float,
	
	
	scoin nvarchar(50),
	aprice float,
	amount float,
	atotal float,
	mount float,
	unit nvarchar(30),
	price float,
	total float,
	
	tnw float,
	tgw float,
	tcuft float,
	tcbm float,
	tctn float,
	
	main nvarchar(MAX),
	side nvarchar(MAX),
	etotal nvarchar(max),
	ectn nvarchar(max)
)

declare @noa nvarchar(50)
declare @no2 nvarchar(50)
declare @payterms nvarchar(50)
declare @pageline int = 40--每頁幾行
declare @page int=1 --頁數
declare @pagecount int=1 --目前行數
declare @tdatecount int=isnull((select count(*) from view_ordes where noa=@t_noa),0) --報價資料數
declare @datecount int=0 --目前已插入報價資料數

--表頭
insert into @tmp(gno,noa,page,pageno,custorde,custno,comp,addr,conn,tel,fax,odate,payment,shipment,terms,coin)
select '1',a.noa,@page,@pagecount,a.custorde,a.custno,a.comp,a.addr,b.conn,a.tel,fax,a.odate,paytype,
a.trantype
+case when ISNULL(bdock,'')!='' then ' From:'+bdock else '' end
+case when ISNULL(edock,'')!='' then ' To:'+edock else '' end
,case when @t_target='cust' then REPLACE(a.payterms,'＆C','') else a.payterms end--,a.payterms
,case when isnull(a.coin,'')='' then 'NT' else a.coin end+'$'
from view_orde a left join view_ordei b on a.noa=b.noa where a.noa=@t_noa 

set @pagecount=@pagecount+9

--資料行
declare cursor_table cursor for 
select noa,no2,payterms from view_ordes where noa=@t_noa order by noa,no2
open cursor_table
fetch next from cursor_table
into @noa,@no2,@payterms
while(@@FETCH_STATUS <> -1)
begin
	set @datecount=@datecount+1
	
	--if(right(@payterms,2)='＆C' and len(@t_showc)=0)
	--begin
	--	insert into @tmp
	--	select '0',@page,@pagecount,a.noa,b.no2,a.custorde,a.custno,a.comp,c.conn
	--	,case when isnull(a.addr2,'')!='' then isnull(a.post2,'')+' '+isnull(a.addr2,'') else isnull(a.post,'')+' '+isnull(a.addr,'') end
	--	,a.contract,a.tel,a.fax,a.odate,a.datea,a.paytype,a.trantype
	--	+case when ISNULL(c.bdock,'')!='' then ' From:'+c.bdock else '' end
	--	+case when ISNULL(c.edock,'')!='' then ' To:'+c.edock else '' end
	--	,b.size,a.memo,case when isnull(a.coin,'')='' then 'NT' else a.coin end+'$',isnull(a.floata,'')
	--	,'<img width="180px" src="../images/upload/'+replace(b.productno,'/','CHR(47)')+'_01.jpg">'
	--	,'<img width="180px" src="../images/upload/'+replace(b.productno,'/','CHR(47)')+'_02.jpg">'
	--	,b.productno,b.product,b.spec,(select productno from ucccust where custno=a.custno and noa=b.productno)
	--	,(select case when ucano!='' then ucano else uccno end from ucx where noa=b.productno)
	--	,d.inmount*d.outmount,d.weight,d.gweight,d.cuft,d.cbm
	--	,case when isnull(d.inmount,0)*isnull(d.outmount,0)=0 then 1 else ceiling(b.mount/(d.inmount*d.outmount)) end
	--	,(b.mount-floor (b.mount/d.inmount*d.outmount)*(d.inmount*d.outmount))
	--	,':'+case when isnull(a.coin,'')='' then 'NT' else a.coin end+'$'
	--	,b.radius,b.mount,isnull(b.radius,0)*isnull(b.mount,0),0,b.unit,isnull(a.floata,'')*b.radius,a.total
	--	,b.mount*d.uweight
	--	,d.gweight*floor (b.mount/d.inmount*d.outmount)--整箱
	--	+(b.mount-floor (b.mount/d.inmount*d.outmount)*d.inmount*d.outmount)*d.uweight--散裝淨重
	--	+case when (b.mount-(floor(b.mount/(d.inmount*d.outmount))*(d.inmount*d.outmount)))>0 then d.outweight else 0 end --外包裝重
	--	+case when (b.mount-(floor(b.mount/(d.inmount*d.outmount))*(d.inmount*d.outmount)))>0 then ceiling((b.mount-(floor(b.mount/(d.inmount*d.outmount))*(d.inmount*d.outmount)))/d.inmount)*d.inweight else 0 end tgw --內包裝重
	--	,d.cuft*case when isnull(d.inmount,0)*isnull(d.outmount,0)=0 then 1 else ceiling(b.mount/(d.inmount*d.outmount)) end
	--	,d.cbm*case when isnull(d.inmount,0)*isnull(d.outmount,0)=0 then 1 else ceiling(b.mount/(d.inmount*d.outmount)) end
	--	,case when isnull(d.inmount,0)*isnull(d.outmount,0)=0 then 1 else ceiling(b.mount/(d.inmount*d.outmount)) end
	--	,Replace(Replace(Replace(e.main,'chr(10)','</BR>'),'　','&nbsp&nbsp'),'~#$','''')
	--	,Replace(Replace(Replace(e.side,'chr(10)','</BR>'),'　','&nbsp&nbsp'),'~#$','''')
	--	,'',''
	--	from view_orde a left join view_ordes b on a.noa=b.noa
	--	left join view_ordei c on a.noa=c.noa
	--	left join pack2s d on d.noa=b.productno and d.packway=b.packwayno
	--	left join view_ordei e on a.noa=e.noa
	--	where a.noa=@noa and no2=@no2
	--end
	--else
	--begin
		insert into @tmp
		select '0',@page,@pagecount,a.noa,b.no2,a.custorde,a.custno,a.comp,c.conn
		,case when isnull(a.addr2,'')!='' then isnull(a.post2,'')+' '+isnull(a.addr2,'') else isnull(a.post,'')+' '+isnull(a.addr,'') end
		,a.contract,a.tel,a.fax,a.odate,a.datea,a.paytype,a.trantype
		+case when ISNULL(c.bdock,'')!='' then ' From:'+c.bdock else '' end
		+case when ISNULL(c.edock,'')!='' then ' To:'+c.edock else '' end
		,case when @t_target='cust' then REPLACE(a.payterms,'＆C','') else a.payterms end--,a.payterms
		,a.memo,case when isnull(a.coin,'')='' then 'NT' else a.coin end+'$',isnull(a.floata,'')
		,'<img width="180" src="http://'+@t_ip+'/images/upload/'+replace(b.productno,'/','CHR(47)')+'_01.jpg">'
		,'<img width="180" src="http://'+@t_ip+'/images/upload/'+replace(b.productno,'/','CHR(47)')+'_02.jpg">'
		,b.productno,b.product,b.spec,(select productno from ucccust where custno=a.custno and noa=b.productno)
		,(select case when ucano!='' then ucano else uccno end from ucx where noa=b.productno)
		,d.inmount*d.outmount,d.weight,d.gweight,d.cuft,d.cbm
		,case when isnull(d.inmount,0)*isnull(d.outmount,0)=0 then 1 else ceiling(b.mount/nullif((d.inmount*d.outmount),0)) end
		,case when d.inmount!=0 then (b.mount-floor (b.mount/nullif(d.inmount*d.outmount,0))*(d.inmount*d.outmount))else '' end
		,f.etd,g.quantity
		,':'+case when isnull(a.coin,'')='' then 'NT' else a.coin end+'$'
		,b.price,b.mount,isnull(b.price,0)*isnull(b.mount,0),0,b.unit,isnull(a.floata,'')*b.price,a.total
		,b.mount*d.uweight
		,case when d.inmount!=0 then d.gweight*floor (b.mount/nullif(d.inmount*d.outmount,0))else '' end--整箱
		+case when d.inmount!=0 then (b.mount-floor (b.mount/nullif(d.inmount*d.outmount,0))*d.inmount*d.outmount)*d.uweight else '' end--散裝淨重
		+case when (case when d.inmount!=0 then (b.mount-(floor(b.mount/nullif((d.inmount*d.outmount),0))*(d.inmount*d.outmount))) else '' end)>0 then d.outweight else 0 end --外包裝重
		+case when (case when d.inmount!=0 then (b.mount-(floor(b.mount/nullif((d.inmount*d.outmount),0))*(d.inmount*d.outmount))) else '' end)>0 then ceiling((b.mount-(floor(b.mount/(d.inmount*d.outmount))*(d.inmount*d.outmount)))/d.inmount)*d.inweight else 0 end tgw --內包裝重
		,d.cuft*case when isnull(d.inmount,0)*isnull(d.outmount,0)=0 then 1 else ceiling(b.mount/nullif((d.inmount*d.outmount),0)) end
		,d.cbm*case when isnull(d.inmount,0)*isnull(d.outmount,0)=0 then 1 else ceiling(b.mount/nullif((d.inmount*d.outmount),0)) end
		,case when isnull(d.inmount,0)*isnull(d.outmount,0)=0 then 1 else ceiling(b.mount/nullif((d.inmount*d.outmount),0)) end
		,Replace(Replace(Replace(e.main,'chr(10)','</BR>'),'　','&nbsp&nbsp'),'~#$','''')
		,Replace(Replace(Replace(e.side,'chr(10)','</BR>'),'　','&nbsp&nbsp'),'~#$','''')
		,'',''
		from view_orde a left join view_ordes b on a.noa=b.noa
		left join view_ordei c on a.noa=c.noa
		left join pack2s d on d.noa=b.productno and d.packway=b.packwayno
		left join view_ordei e on a.noa=e.noa
		left join invo f on a.noa=f.ordeno
		left join invos g on a.noa=g.ordeno and b.no2=g.no2
		where a.noa=@noa and b.no2=@no2
	--end
	
	set @pagecount=@pagecount+15 --一個品項暫13行
	
	if(@tdatecount>1 and @tdatecount!=@datecount and @datecount%4=0)--資料筆數2以上 且 單行筆數
	begin
		--差入空白頁
		while (@pagecount%@pageline!=0 and @pagecount<40)
		begin
			insert @tmp (gno,page,pageno,noa)
			select '2',@page,@pagecount,@noa
			
			set @pagecount=@pagecount+1
		end
		
		--插入分頁
		insert @tmp (gno,page,pageno,noa)
		select '3',@page,@pagecount,@noa
		
		set @pagecount=1
		set @page=@page+1
		
		--插入第二頁以上的 抬頭
		insert into @tmp(gno,noa,page,pageno,custno,comp,addr,conn,tel,fax,odate,payment,shipment,terms,coin)
		select '4',a.noa,@page,@pagecount,a.custno,a.comp,a.addr,b.conn,a.tel,a.fax,a.odate,a.paytype,
		a.trantype
		+case when ISNULL(bdock,'')!='' then ' From:'+bdock else '' end
		+case when ISNULL(edock,'')!='' then ' To:'+edock else '' end
		,case when @t_target='cust' then REPLACE(a.payterms,'＆C','') else a.payterms end--,a.payterms
		,case when isnull(a.coin,'')='' then 'NT' else a.coin end+'$'
		from view_orde a left join view_ordei b on a.noa=b.noa where a.noa=@t_noa 
		
		set @pagecount=@pagecount+3
	end
	else if (@tdatecount=@datecount) --最後一筆
	begin
		update a
		set total=isnull((select SUM(round(atotal,0)) from @tmp where noa=a.noa),0)
		from @tmp a
		
		
		--合計
		insert into @tmp(gno,page,pageno,noa,no2,comp,mount,unit,coin,total,tnw,tgw,tcuft,tcbm,tctn)
		select '5',@page,@pagecount,noa,CHAR(255),comp,sum(amount),MAX(unit),coin,sum(atotal),sum(tnw),sum(tgw),sum(tcuft),sum(tcbm),sum(tctn)
		from @tmp where gno='0' group by noa,mount,coin,total,comp
		set @pagecount=@pagecount+1	

		--合計(英文大寫)
		insert into @tmp(gno,page,pageno,noa,etotal)
		select '6',@page,@pagecount,noa,('SAY TOTAL U.S DOLLAR '+UPPER(dbo.currencyToEnglish(total))) 
		from @tmp where gno='0' group by noa,total
		set @pagecount=@pagecount+1
		
		--合計(英文大寫)
		insert into @tmp(gno,page,pageno,noa,ectn)
		select '7',@page,@pagecount,noa,''--('SAY TOTAL '+UPPER(dbo.currencyToEnglish(tctn))+'CARTONS') 
		from @tmp where gno='0' group by noa
		set @pagecount=@pagecount+1
		
		--MARK
		insert into @tmp(gno,page,pageno,noa,main,side)
		select '8',@page,@pagecount,noa,main,side
		from @tmp where gno='0' 
		group by noa,main,side
		
		set @pagecount=@pagecount+10
		
		
		--插入空白行
		while ((@pagecount+5+1)%@pageline!=0 and @pagecount<40) --5簽名+1行結束
		begin
			insert @tmp (gno,page,pageno,noa)
			select '2',@page,@pagecount,@noa
				
			set @pagecount=@pagecount+1
		end
		
		--簽名
		insert into @tmp(gno,noa,page,pageno,comp)
		select '9',noa,@page,@pagecount,comp from @tmp where gno='0'
		group by noa,comp,main,side
			
		--結束
		insert into @tmp(gno,noa,page,pageno)
		select '10',noa,@page,@pagecount from @tmp where gno='0'
		group by noa,comp
		
		set @pagecount=1
		set @page=@page+1
	
		
	
	
	end
	
	fetch next from cursor_table
	into @noa,@no2,@payterms
end
close cursor_table
deallocate cursor_table

update a 
set mount =(select sum(amount) from @tmp where noa=a.noa and gno='0')
,tnw=(select sum(tnw) from @tmp where noa=a.noa and gno='0')
,tgw=(select sum(tgw) from @tmp where noa=a.noa and gno='0')
,tcuft=(select sum(tcuft) from @tmp where noa=a.noa and gno='0')
,tcbm=(select sum(tcbm) from @tmp where noa=a.noa and gno='0')
,tctn =(select sum(tctn) from @tmp where noa=a.noa and gno='0')
from @tmp a
where gno='5' or gno='7'

update a 
set ectn =('SAY TOTAL '+UPPER(dbo.currencyToEnglish(tctn))+'CARTONS') 
from @tmp a where gno='7'

update a 
set ectn =('SAY TOTAL '+UPPER(dbo.currencyToEnglish(tctn))+'CARTONS') 
from @tmp a where gno='7'

select
dbo.getComma(amount,0)amount,
dbo.getComma(mount,0) mount,
dbo.getComma(aprice,3)aprice,
dbo.getComma(atotal,3)atotal,
dbo.getComma(price,2)price,
dbo.getComma(total,2)total,
dbo.getComma(isnull(pctn,0),0)pctn,
dbo.getComma(isnull(nw,0),3)nw,
dbo.getComma(isnull(gw,0),3)gw,
dbo.getComma(isnull(cuft,0),2)cuft,
dbo.getComma(isnull(cbm,0),2)cbm,
dbo.getComma(isnull(ctn,0),0)ctn,
dbo.getComma(isnull(tnw,0),3)tnw,
dbo.getComma(isnull(tgw,0),3)tgw,
dbo.getComma(isnull(tcuft,0),2)tcuft,
dbo.getComma(isnull(tcbm,0),2)tcbm,
dbo.getComma(isnull(tctn,0),0)tctn,
dbo.getComma(isnull(smount,0),0)smount,
case when needadd>0 then '(Need To Add '+dbo.getComma(needadd,-1)+' '+case when len(unit)=0 then 'Pcs' else unit end+')' else '' end needadd,
* from @tmp a order by idno
;

--------------------------------------------------------------------------------------------------------------------

z_ordep_r7:--z_ordep_r7
	declare @t_xnoa nvarchar(50)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcust nvarchar(50)
	declare @t_ecust nvarchar(50)

	set @t_xnoa = case when '#non' = [5] then '' else [5] end
	set @t_bdate = case when '#non'=[3] then '' else [3] end
	set @t_edate = case when '#non'=[4] then char(255) else [4] end
	set @t_bcust = case when '#non'=[7] then '' else  [7]  end
	set @t_ecust = case when '#non'=[8]  then char(255) else [8] end 


	declare @tmp table(
		gno nvarchar(1),
		datea nvarchar(10),
		noa nvarchar(50),
		coustno nvarchar(50),
		ordeno nvarchar(50),
		custorde nvarchar(50),
		invo nvarchar(50),
		productno nvarchar(50),
		custpno nvarchar(50),
		packway nvarchar(50),
		pcs float,
		cft float,
		cbm float,
		mount float,
		carton float,
		totalcft float
	)

	insert into @tmp
	select '0',a.datea,a.noa,a.custno,d.noa,d.custorde,a.invo,b.productno,e.productno,c.packway
	,case when isnull(f.inmount,0)=0 then 1 else f.inmount end*case when isnull(f.outmount,0)=0 then 1 else f.outmount end
	,f.cuft,f.cbm,c.mount,0,c.cuft
	from  view_vcce a left join view_vcces b on a.noa=b.noa 
	left join view_ordes c on b.ordeno=c.noa and b.no2=c.no2
	left join view_orde d on c.noa=d.noa
	left join ucccust e on b.productno=e.noa and e.custno=d.custno
	left join pack2s f on c.packwayno=f.packway and f.noa=c.productno
	where 
	(len(@t_xnoa)=0 or d.noa=@t_xnoa)
	and (a.datea between @t_bdate and @t_edate)
	and (a.custno between @t_bcust and @t_ecust)

	--carton
	update a set carton=round(mount/pcs,0) from @tmp a where gno='0'

	
	if((select count(*) from @tmp)>0)
	begin
		insert @tmp(gno,noa,pcs,cft,cbm,mount,carton,totalcft)
		select '1',noa,SUM(pcs),SUM(cft),SUM(cbm),SUM(mount),SUM(carton),SUM(totalcft)
		from @tmp
		group by noa
	end

	select 
	dbo.getComma(pcs,0)pcs,
	dbo.getComma(cft,-1)cft,
	dbo.getComma(cbm,-1)cbm,
	dbo.getComma(mount,-1)mount,
	dbo.getComma(carton,-1)carton,
	dbo.getComma(totalcft,1)totalcft,* 
	from @tmp order by noa,gno,datea,custorde,invo,ordeno
	;

------------------------------------------------------------------------------------------------------------------------------------------------------

z_ordep_r8:--z_ordep_r8
	SET QUOTED_IDENTIFIER OFF
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcust nvarchar(50)
	declare @t_ecust nvarchar(50)
	declare @t_bfdate nvarchar(10)
	declare @t_efdate nvarchar(10)
	declare @t_bonoa nvarchar(10)
	declare @t_eonoa nvarchar(10)

	set @t_bdate = case when '#non'=[3] then '' else [3] end
	set @t_edate = case when '#non'=[4] then char(255) else [4] end
	set @t_bonoa = case when '#non'=[7] then '' else [7] end
	set @t_eonoa = case when '#non'=[8] then char(255) else [8] end
	set @t_bcust = case when '#non'=[9] then '' else  [9]  end
	set @t_ecust = case when '#non'=[10]  then char(255) else [10] end 
	set @t_bfdate = case when '#non'=[13] then '' else [13] end
	set @t_efdate = case when '#non'=[14] then char(255) else [14] end

	declare @tmp table(
		gno nvarchar(1),
		noa nvarchar(100),
		custorde nvarchar(100),
		custno nvarchar(100),
		comp nvarchar(250),
		odate nvarchar(10),
		etd nvarchar(10),
		total float,
		deposit float,
		receivea float,
		bdate nvarchar(10),
		edate nvarchar(10),
		coin nvarchar(20)
	)
	

		insert @tmp
		select '0',a.noa,a.custorde,a.custno,a.nick,a.odate,b.etd,a.total,a.deposit,a.total-a.deposit,@t_bdate,@t_edate
			,(case when a.coin!='' then a.coin+'$' else 'US$' end)
		from view_orde a left join invo b on a.noa=b.ordeno
		where
		(a.noa between @t_bonoa and @t_eonoa)
		and (a.odate between @t_bdate and @t_edate)
		and (a.custno between @t_bcust and @t_ecust)
		and (a.date1 between @t_bfdate and @t_efdate)
		
		insert @tmp(gno,total,deposit,receivea,coin)
		select '1',SUM(total),SUM(deposit),sum(receivea),coin
		from @tmp
		group by coin
					
			
	select
	dbo.getComma(total,0)total,
	dbo.getComma(deposit,0)deposit,
	dbo.getComma(receivea,0)receivea,
	* from @tmp 
	;
-------------------------------------------------------------------------------------------------------------------------------------------

z_ordep_r9:--z_ordep_r9
	SET QUOTED_IDENTIFIER OFF
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcust nvarchar(50)
	declare @t_ecust nvarchar(50)
	declare @t_bfdate nvarchar(10)
	declare @t_efdate nvarchar(10)
	declare @t_bonoa nvarchar(10)
	declare @t_eonoa nvarchar(10)

	set @t_bdate = case when '#non'=[3] then '' else [3] end
	set @t_edate = case when '#non'=[4] then char(255) else [4] end
	set @t_bonoa = case when '#non'=[7] then '' else [7] end
	set @t_eonoa = case when '#non'=[8] then char(255) else [8] end
	set @t_bcust = case when '#non'=[9] then '' else  [9]  end
	set @t_ecust = case when '#non'=[10]  then char(255) else [10] end 
	set @t_bfdate = case when '#non'=[13] then '' else [13] end
	set @t_efdate = case when '#non'=[14] then char(255) else [14] end
	
	declare @tmp table(
		gno nvarchar(1),
		rr int,
		bdate nvarchar(10),
		edate nvarchar(10),
		noa nvarchar(100),
		custno nvarchar(100),
		comp nvarchar(200),
		odate nvarchar(10),
		custorde nvarchar(100),
		productno nvarchar(100),
		mount float,
		unit nvarchar(10),
		sales nvarchar(100)
	)
	
	insert @tmp 
	select '1','',@t_bdate,@t_edate,a.noa,a.custno,a.nick,a.odate,a.custorde,b.productno,b.mount,b.unit,a.sales
	from view_orde a left join view_ordes b on a.noa=b.noa
	where a.ordcno=''
	and (a.noa between @t_bonoa and @t_eonoa)
	and (a.odate between @t_bdate and @t_edate)
	and (a.custno between @t_bcust and @t_ecust)
	and (a.date1 between @t_bfdate and @t_efdate)
	
	update a
	set rr=rx
	from (select ROW_NUMBER() over (partition by noa order by gno,custno)rx,rr from @tmp)a

	update @tmp set gno=case when rr=1 then '1' else '2' end
	
	if ((select count(*) from @tmp)>0)
	begin
		insert @tmp (gno,noa)
		select '3',noa
		from @tmp
		group by noa
	end
	
	select 
	dbo.getComma(mount,0)mount,
	* from @tmp
	order by noa,gno
;
----------------------------------------------------------------------------------------------------------------------------------------

z_ordep_r10:--z_ordep_r10
	SET QUOTED_IDENTIFIER OFF
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcust nvarchar(50)
	declare @t_ecust nvarchar(50)
	declare @t_bfdate nvarchar(10)
	declare @t_efdate nvarchar(10)
	declare @t_bonoa nvarchar(10)
	declare @t_eonoa nvarchar(10)

	set @t_bdate = case when '#non'=[3] then '' else [3] end
	set @t_edate = case when '#non'=[4] then char(255) else [4] end
	set @t_bonoa = case when '#non'=[7] then '' else [7] end
	set @t_eonoa = case when '#non'=[8] then char(255) else [8] end
	set @t_bcust = case when '#non'=[9] then '' else  [9]  end
	set @t_ecust = case when '#non'=[10]  then char(255) else [10] end 
	set @t_bfdate = case when '#non'=[13] then '' else [13] end
	set @t_efdate = case when '#non'=[14] then char(255) else [14] end
	
	declare @tmp table(
		gno nvarchar(1),
		bdate nvarchar(10),
		edate nvarchar(10),
		noa nvarchar(100),
		custno nvarchar(100),
		comp nvarchar(200),
		odate nvarchar(10),
		date1 nvarchar(10),
		custorde nvarchar(100),
		coin nvarchar(20),
		total float,
		salesno nvarchar(100)
	)
	
	insert @tmp 
	select '0',@t_bdate,@t_edate,a.noa,a.custno,a.nick,a.odate,a.date1,a.custorde,(case when a.coin!='' then a.coin+'$' else 'US$' end),a.total,a.salesno
	from view_orde a 
	where a.apv=''
	and (a.noa between @t_bonoa and @t_eonoa)
	and (a.odate between @t_bdate and @t_edate)
	and (a.custno between @t_bcust and @t_ecust)
	and (a.date1 between @t_bfdate and @t_efdate)
	
	
	select 
	dbo.getComma(total,0)total,
	* from @tmp
	order by noa,gno
;
-----------------------------------------------------------------------------------------------------------------------------------------
z_ordep_r11:--z_ordep_r11
	SET QUOTED_IDENTIFIER OFF
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcust nvarchar(50)
	declare @t_ecust nvarchar(50)
	declare @t_bfdate nvarchar(10)
	declare @t_efdate nvarchar(10)
	declare @t_bonoa nvarchar(10)
	declare @t_eonoa nvarchar(10)
	declare @t_bproductno nvarchar(10)
	declare @t_eproductno nvarchar(10)

	set @t_bdate = case when '#non'=[3] then '' else [3] end
	set @t_edate = case when '#non'=[4] then char(255) else [4] end
	set @t_bonoa = case when '#non'=[7] then '' else [7] end
	set @t_eonoa = case when '#non'=[8] then char(255) else [8] end
	set @t_bcust = case when '#non'=[9] then '' else  [9]  end
	set @t_ecust = case when '#non'=[10]  then char(255) else [10] end 
	set @t_bproductno = case when '#non'=[11] then '' else [11] end
	set @t_eproductno = case when '#non'=[12] then char(255) else [12] end
	set @t_bfdate = case when '#non'=[13] then '' else [13] end
	set @t_efdate = case when '#non'=[14] then char(255) else [14] end

	declare @tmp table(
		gno nvarchar(1),
		rr int,
		bdate nvarchar(10),
		edate nvarchar(10),
		noa nvarchar(100),
		custno nvarchar(100),
		comp nvarchar(200),
		odate nvarchar(10),
		custorde nvarchar(100),
		productno nvarchar(100),
		product nvarchar(MAX),
		mount float,
		unit nvarchar(10),
		coin nvarchar(20),
		outmount float,
		cost3 float,
		date1 nvarchar(10),
		datea nvarchar(10),
		invo nvarchar(100),
		tranprice float,
		gweight float,
		cutf float,
		shupplier nvarchar(100)
	)
	
	insert @tmp 
	select '0','',@t_bdate,@t_edate,a.noa,a.custno,a.nick,a.odate,a.custorde,b.productno,b.product,isnull(b.mount,0),b.unit
			,(case when a.coin!='' then a.coin+'$' else 'US$' end)
			,isnull(d.ectn,0),isnull(b.price,0),a.date1,c.datea,c.noa,isnull(d.ectn*b.price,0)
			,e.gweight*d.ectn,e.cuft*d.ectn,f.tgg
	from view_orde a left join view_ordes b on a.noa=b.noa
	left join invo c on a.noa=c.noa
	left join packing d on b.productno=d.productno
	left join pack2s e on b.productno=e.noa
	left join ucc f on f.noa=b.productno
	where b.productno !=''
	and (a.noa between @t_bonoa and @t_eonoa)
	and (a.odate between @t_bdate and @t_edate)
	and (a.custno between @t_bcust and @t_ecust)
	and (b.productno between @t_bproductno and @t_eproductno)
	and (a.date1 between @t_bfdate and @t_efdate)
	
	update a
	set rr=rx
	from (select ROW_NUMBER() over (partition by noa order by gno,custno)rx,rr from @tmp)a

	update @tmp set gno=case when rr=1 then '1' else '2' end
		
	if ((select count(*) from @tmp)>0)
	begin
		insert @tmp(gno,rr,coin,noa,outmount,tranprice)
		select '3',9997,coin,noa,SUM(outmount),SUM(tranprice)
		from @tmp
		group by noa,coin
	end
	
	
	insert @tmp (gno,rr,gweight,cutf)
	select '4',9999,SUM(gweight),SUM(cutf)
	from @tmp
	
	select 
	dbo.getComma(isnull(mount,0),0)mount,
	dbo.getComma(isnull(outmount,0),2)outmount,
	dbo.getComma(isnull(tranprice,0),2)tranprice,
	'G.W.  '+dbo.getComma(isnull(gweight,0),2)gweight,
	dbo.getComma(isnull(cutf,0),2)cutf,
	dbo.getComma(isnull(cost3,0),3)cost3,
	* from @tmp
	order by noa desc,rr
;


---------------------------------------------------------------------------------------------------------------------
z_ordep_r12:--z_ordep_r12
	SET QUOTED_IDENTIFIER OFF
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bonoa nvarchar(10)
	declare @t_eonoa nvarchar(10)

	set @t_bdate = case when '#non'=[3] then '' else [3] end
	set @t_edate = case when '#non'=[4] then char(255) else [4] end
	set @t_bonoa = case when '#non'=[7] then '' else [7] end
	set @t_eonoa = case when '#non'=[8] then char(255) else [8] end

	declare @tmp table(
			gno nvarchar(1),
			bdate nvarchar(10),
			edate nvarchar(10),
			noa nvarchar(100),
			odate nvarchar(10),
			custno nvarchar(100),
			nick nvarchar(100),
			salesno nvarchar(100),
			sales nvarchar(100),
			coin nvarchar(20),
			moneya float,
			total float,
			rangea float,
			coins nvarchar(20)
		)
		
		insert @tmp
		select '0',@t_bdate,@t_edate,noa,odate,custno,nick,salesno,sales
				,case when coin!='' then coin+'$' else '' end,money,total,0,'US$'
		from view_orde
		where 
		(noa between @t_bonoa and @t_eonoa)
		and (odate between @t_bdate and @t_edate)
		
		select
		dbo.getComma(moneya,0)moneya,
		dbo.getComma(total,0)total,
		 * from @tmp
		;
-----------------------------------------------------------------------------------------------------------------------------------
z_ordep_r13:--z_ordep_r13
	SET QUOTED_IDENTIFIER OFF
	declare @t_xnoa nvarchar(50)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcust nvarchar(50)
	declare @t_ecust nvarchar(50)

	set @t_xnoa = case when '#non' = [5] then '' else [5] end
	set @t_bdate = case when '#non'=[3] then '' else [3] end
	set @t_edate = case when '#non'=[4] then char(255) else [4] end
	set @t_bcust = case when '#non'=[9] then '' else  [9]  end
	set @t_ecust = case when '#non'=[10]  then char(255) else [10] end

	declare @tmp table(
		gno nvarchar(1),
		rr  int,
		noa nvarchar(100),
		custno nvarchar(100),
		comp nvarchar(200),
		odate nvarchar(10),
		term nvarchar(100),
		custorde nvarchar(10),
		productno nvarchar(100),
		product nvarchar(MAX),
		mount float,
		radius float,
		floata float,
		coin nvarchar(50),
		total float,
		price float,
		sprice float,
		stotal float,
		profit float,
		ppercent float,
		ntotal float,
		acoin nvarchar(10),
		plus float,
		nplus float,
		noq nvarchar(100),
		chgitem nvarchar(100),
		nttotal float,
		sttotal float,
		tpercent float,
		spec nvarchar(100)
 	) 
 	
	insert @tmp
	select '0','',a.noa,a.custno,a.comp,a.odate
			,REPLACE(a.payterms,'&C','')
			,a.custorde,b.productno,b.product,b.mount,b.price
			,case when a.floata!=0 then a.floata else '' end,a.coin+'$',b.total
			,b.sprice*(a.floata*100),b.sprice*b.mount,round(b.sprice*(a.floata*100),3)*b.mount
			,b.total*(a.floata*100)-round(b.sprice*(a.floata*100),3)*b.mount
			,case when b.sprice!=0 and b.price!=0 then b.sprice/b.price*100 else '' end
			,'','NT$',case when b.productno='' then b.price else '' end
			,case when b.productno='' then b.price*a.floata else b.price end
			,'','','','','','SIZE：'+b.spec
	from view_orde a left join view_ordes b on a.noa=b.noa
	where 
	(len(@t_xnoa)=0 or a.noa=@t_xnoa)
	and (a.datea between @t_bdate and @t_edate)
	and (a.custno between @t_bcust and @t_ecust)
	
	insert @tmp(gno,noa,coin,total,stotal,profit,acoin,floata)
	select '1',noa,coin,SUM(total),SUM(stotal),SUM(profit),acoin,floata
	from @tmp
	group by noa,coin,acoin,floata

	update a
	set ppercent=case when profit!=0 and total!=0 then profit/(total*floata) else '' end
	from @tmp a
	where gno='1'
	
	insert @tmp(gno,rr,noa,coin,total,floata,ntotal,acoin,plus,nplus)
	select '2','9991',noa,coin,SUM(total),case when floata!=0 then floata*100 else 1 end,SUM(total)*(floata*100),acoin,sum(plus),(floata*100)*SUM(plus)
	from @tmp
	where gno='0'
	group by noa,coin,floata,acoin
	
	insert @tmp(gno,rr,noa,coin,total,floata,nttotal,acoin)
	select '3','9992',noa,coin,total+plus,floata,ntotal+nplus,acoin
	from @tmp
	where gno='2'
	group by noa,coin,floata,total,plus,nplus,ntotal,coin,acoin
	
	insert @tmp(gno,rr,noa,stotal,sprice,coin,acoin)
	select '4','9993',noa,SUM(stotal),SUM(sprice),coin,acoin
	from @tmp
	where gno='0'
	group by noa,coin,acoin
	
	insert @tmp(gno,rr,noa,noq,chgitem,stotal,floata,sprice,coin,acoin)
	select '5','9994',a.noa,b.noq,b.chgitem,(a.floata*100)*b.total,case when floata!=0 then floata*100 else 1 end,b.total,a.coin+'$','NT$'
	from view_orde a left join paybs b on a.noa=b.payno
	where 
	(a.noa=@t_xnoa)
	and (a.datea between @t_bdate and @t_edate)
	and (a.custno between @t_bcust and @t_ecust)
	group by a.noa,b.noq,b.chgitem,b.total,a.floata,a.coin
		
	insert @tmp(gno,rr,noa,sttotal,sprice,coin,acoin)
	select '6','9995',noa,sum(stotal),SUM(sprice),coin,acoin
	from @tmp
	where gno='4' or gno='5'
	group by noa,acoin,coin
	
	insert @tmp(gno,rr,noa,total,sprice,nttotal,sttotal,coin,acoin)
	select '9','9999',noa,sum(total),sum(sprice),sum(nttotal),sum(sttotal),coin,acoin
	from @tmp
	where gno='3'or gno='6'
	group by noa,acoin,coin
	
	insert @tmp(gno,rr,noa,nttotal,stotal,acoin,coin,total,tpercent)
	select '7','9996',noa,nttotal-sttotal,total-sprice,acoin,coin,total,tpercent
	from @tmp
	where gno='9'
	group by noa,nttotal,total,sttotal,sprice,acoin,coin,total,tpercent
	
	delete @tmp where gno='9'
	
	update a
	set tpercent=case when stotal!=0 and total !=0 then (stotal/total)*100 else '' end
	from @tmp a
	where gno='7'

	insert @tmp(gno,rr,noa)
	select '8','9997',noa
	from @tmp
	group by noa
	
	select 
	dbo.getComma(mount,0)mount,
	dbo.getComma(radius,2)radius,
	dbo.getComma(floata,2)floata,
	dbo.getComma(sprice,2)sprice,
	dbo.getComma(total,2)total,
	dbo.getComma(stotal,2)stotal,
	dbo.getComma(profit,0)profit,
	dbo.getComma(plus,2)plus,
	dbo.getComma(nplus,0)nplus,
	dbo.getComma(ntotal,0)ntotal,
	dbo.getComma(nttotal,0)nttotal,
	dbo.getComma(sttotal,0)sttotal,
	dbo.getComma(price,2)price,
	dbo.getComma(ppercent,2)ppercent,
	dbo.getComma(tpercent,2)tpercent,
	* from @tmp 
	order by noa,gno
	;

------------------------------------------------------------------------------------------------------------------------------------------------
z_ordep_r14:--z_ordep_r14
	SET QUOTED_IDENTIFIER OFF
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bonoa nvarchar(10)
	declare @t_eonoa nvarchar(10)

	set @t_bdate = case when '#non'=[3] then '' else [3] end
	set @t_edate = case when '#non'=[4] then char(255) else [4] end
	set @t_bonoa = case when '#non'=[7] then '' else [7] end
	set @t_eonoa = case when '#non'=[8] then char(255) else [8] end

	declare @tmp table(
		gno nvarchar(1),
		rr int,
		custno nvarchar(100),
		comp nvarchar(200),
		nick nvarchar(100),
		coin nvarchar(20),
		moneya float,
		total float,
		ttotal float,
		rtotal float,
		coins nvarchar(5),
		ppercent float
	)
	
	insert @tmp
	select '0',ROW_NUMBER()over(partition by custno order by custno),custno,b.comp,b.nick
			,case when coin!='' then coin+'$' else 'NT$' end,sum(total),sum(total)
			,case when coin!='' and floata!=0 then sum((isnull(floata,1)*100)*total) else sum(total) end
			,0,'US$',''
	from view_orde a
	left join cust b on a.custno=b.noa
	where(a.noa between @t_bonoa and @t_eonoa)
	and(odate between @t_bdate and @t_edate)
	group by custno,b.comp,b.nick,coin,floata
	
	update @tmp
	set gno=case when a.rr=1 then 1 else 2 end,rtotal=b.ttotal
	from @tmp a left join (select custno , SUM(ttotal)ttotal from @tmp group by custno)b on a.custno=b.custno
	
	insert @tmp(gno,coin,moneya,total,ttotal)
	select '3',coin,SUM(moneya),SUM(total),sum(ttotal)
	from @tmp
	group by coin
	
	insert @tmp(gno,coin,moneya,total,ttotal)
	select '5',coin,SUM(moneya),SUM(total),sum(ttotal)
	from @tmp
	where gno!='3'
	group by coin
	
	update a
	set rr=rx
	from (select ROW_NUMBER()over(partition by gno order by ttotal desc)rx,rr from @tmp where gno=3 or gno=5)a

	update @tmp
	set gno=case when rr=1 then 3 else 4 end
	where gno='3'
	
	update @tmp
	set gno=case when rr=1 then 5 else 6 end
	where gno='5'
	
	update @tmp
	set ppercent=a.total/nullif(b.total,0)*100
	from @tmp a left join (select coin,total from @tmp where gno=3 or gno=4)b on a.coin=b.coin
	
	update @tmp
	set rr=ra
	from @tmp a left join (select ROW_NUMBER()over(partition by gno order by rtotal desc,gno,rr)ra,custno from @tmp where gno=1)b on a.custno=b.custno
	
	select
	@t_bdate bdate,@t_edate edate,
	dbo.getComma(moneya,0)moneya,
	dbo.getComma(total,0)total,
	dbo.getComma(round(ppercent,0,2),0)+'%' ppercent,
	 * from @tmp
	 order by rtotal desc,gno,rr
	;