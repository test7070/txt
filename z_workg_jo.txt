z_workg_jo01:--z_workg_jo01
declare @t_noa nvarchar(30)
declare @t_noq nvarchar(30)
declare @t_unenda nvarchar(30)
declare @t_mount nvarchar(30)
set @t_noa = case when '#non' = [5] then '' else  [5] end
set @t_noq = case when '#non' = [6] then '' else  [6] end
set @t_unenda = case when '#non' = [7] then '0' else  [7] end
set @t_mount = case when '#non' = [10] then '0' else  [10] end

declare @x_mount float
set @x_mount=cast(@t_mount as float)

--*****************************************************************************************
--未完工排程
declare @noend table(
	cuano nvarchar(50),
	cuanoq nvarchar(50)
)

declare @tmp table(
	cuano nvarchar(50),
	cuanoq nvarchar(50),
	noa nvarchar(MAX),
	productno nvarchar(MAX),
	parent nvarchar(MAX)
)

if(@t_unenda='1')
begin
	insert @noend (cuano,cuanoq)
	select cuano,cuanoq from view_work where isnull(isfreeze,0)=0 and isnull(enda,0)=0 and isnull(mount,0)-isnull(inmount,0)>0
	group by cuano,cuanoq
	
	insert @tmp
	select a.cuano,a.cuanoq,noa,productno,case when previd='0' then 'root' else previd end
	from view_work a 
	where exists (select * from @noend where cuano=a.cuano and cuanoq=a.cuanoq) and isnull(processno,'')!=''
	and (len(@t_noa)=0 or a.cuano=@t_noa) and (len(@t_noq)=0 or a.cuanoq=@t_noq)
end
else
begin
	insert @tmp
	select a.cuano,a.cuanoq,noa,productno,case when previd='0' then 'root' else previd end
	from view_work a 
	where a.cuano=@t_noa and (len(@t_noq)=0 or a.cuanoq=@t_noq)
end

update a 
set parent=isnull(b.productno,'root')
from @tmp a outer apply (select * from @tmp where noa=a.parent)b

--update @tmp
--set parent=SUBSTRING(parent,0,CHARINDEX('_*',parent))
--where parent!='root'

declare @tmpa table(
	idno int identity(0,1),
	cuano nvarchar(50),
	cuanoq nvarchar(50),
	noa nvarchar(MAX),
	productno nvarchar(MAX),
	sortcol nvarchar(max),
	levels int
)
--製令bom表--------------------------------------------------------------
BEGIN TRY
	--遞迴
	WITH OrdersTable (cuano,cuanoq,noa,productno,sortcol,levels) as (
		Select cuano,cuanoq,noa,productno,productno,0
		from @tmp
		where parent='root'
		UNION ALL
		SELECT a.cuano,a.cuanoq,a.noa,a.productno,CONVERT(nvarchar(MAX),OrdersTable.sortcol+'*-*'+a.productno)
		,OrdersTable.levels+1
		FROM @tmp a, OrdersTable
		WHERE a.parent=OrdersTable.productno and a.cuano=OrdersTable.cuano and a.cuanoq=OrdersTable.cuanoq
	)
	
	insert into @tmpa
	Select a.cuano,a.cuanoq,a.noa,a.productno,a.sortcol,a.levels
	From OrdersTable a
	order by a.sortCol
END TRY
BEGIN CATCH
END CATCH
------------------------------------------------------------------
declare @noa nvarchar(50)
declare @cuano nvarchar(50)
declare @cuanoq nvarchar(50)
declare @processno nvarchar(50)
declare @process nvarchar(50)
declare @levels nvarchar(50)
declare @wdate nvarchar(50)
----------------------------
declare @t_cuano nvarchar(50)
declare @t_cuanoq nvarchar(50)
declare @titleno nvarchar(MAX)=''
declare @title nvarchar(MAX)=''
declare @workno nvarchar(MAX)=''
declare @t_levels nvarchar(50)=''
-----------------------------
declare @tmpb table(
	idno int identity(0,1),
	cuano nvarchar(50),
	cuanoq nvarchar(50),
	titleno nvarchar(MAX),
	title nvarchar(MAX),
	workno nvarchar(MAX),
	wdate nvarchar(10)
)

--流程合併----------------------------------------------------
declare cursor_table cursor for
select a.cuano,a.cuanoq,a.noa,b.processno,case when charindex(')',process)=0 then b.process else SUBSTRING(b.process,0,charindex('(',process)) end process,a.levels,b.cuadate
from @tmpa a left join view_work b on a.noa=b.noa order by sortcol
open cursor_table
fetch next from cursor_table
into @cuano,@cuanoq,@noa,@processno,@process,@levels,@wdate
while(@@FETCH_STATUS <> -1)
begin
	if(@t_levels>=@levels or @t_cuano!=@cuano or @t_cuanoq!=@cuanoq)
	begin
		insert @tmpb
		select @t_cuano,@t_cuanoq,@titleno,@title,@workno,@wdate
		set @titleno=''
		set @title=''
		set @workno=''
	end
	
	set @titleno=@processno+case when len(@titleno)>0 then '→' else '' end+@titleno
	set @title=@process+case when len(@title)>0 then '→' else '' end+@title
	set @workno=@noa+case when len(@workno)>0 then '→' else '' end+@workno
	
	set @t_levels=@levels
	set @t_cuano=@cuano
	set @t_cuanoq=@cuanoq
	fetch next from cursor_table
	into @cuano,@cuanoq,@noa,@processno,@process,@levels,@wdate
end
close cursor_table
deallocate cursor_table
--最後一筆
if(len(@t_cuano)>0)
begin
	insert @tmpb
	select @t_cuano,@t_cuanoq,@titleno,@title,@workno,@wdate
end
-----------------------------------------------------------------------
declare @tmpc table(
	idno int identity(0,1),
	cuano nvarchar(50),
	cuanoq nvarchar(50),
	titleno nvarchar(MAX),
	title nvarchar(MAX),
	workno nvarchar(MAX),
	wdate nvarchar(10)
)

--排除流程相同的資料
insert @tmpc
select cuano,cuanoq,titleno,title,STUFF(isnull((select ','+workno from @tmpb where cuano=a.cuano and cuanoq=a.cuanoq and ((titleno=a.titleno and title=a.title) or a.titleno like titleno+'%' ) for xml path('')),''),1,1,''),MIN(wdate)
from @tmpb a
group by cuano,cuanoq,titleno,title 
having not exists (select * from @tmpb where titleno like a.titleno+'%' and titleno!=a.titleno and cuano=a.cuano and cuanoq=a.cuanoq )
order by MIN(idno)
-------------------------------------
--所需原料
declare @tmpd table(
	idno int,
	cuano nvarchar(50),
	cuanoq nvarchar(50),
	titleno nvarchar(MAX),
	title nvarchar(MAX),
	ucano nvarchar(50),--製成品
	spec nvarchar(MAX),--型號
	productno nvarchar(MAX),--製程完工成品/半成品編號
	product nvarchar(MAX),--製程完工成品/半成品名稱
	--使用耗料
	sproductno nvarchar(50),
	sproduct nvarchar(MAX),
	smount nvarchar(50),
	sumount nvarchar(50),--單位用料
	workno nvarchar(50),
	worknoq nvarchar(50)
)

declare @idno int
declare @ordeno nvarchar(50)
declare @no2 nvarchar(50)

declare cursor_table cursor for
select idno,cuano,cuanoq,titleno,title,workno from @tmpc order by cuano,cuanoq,idno
open cursor_table
fetch next from cursor_table
into @idno,@cuano,@cuanoq,@titleno,@title,@workno
while(@@FETCH_STATUS <> -1)
begin
	set @processno=@titleno
	while CHARINDEX('→',@processno)>0
	begin
		set @processno=substring(@processno,CHARINDEX('→',@processno)+1,LEN(@processno))
	end
	
	insert @tmpd(idno,cuano,cuanoq,titleno,title,ucano,spec,productno,product
	,sproductno,sproduct,smount,sumount,workno,worknoq)
	select @idno,@cuano,@cuanoq,@titleno,@title,a.productno,a.spec
	,(select top 1 productno from view_work where cuano=a.noa and cuanoq=a.noq and processno=@processno and @workno like '%'+noa+'%' order by noa)
	,(select top 1 product from view_work where cuano=a.noa and cuanoq=a.noq and processno=@processno and @workno like '%'+noa+'%' order by noa)
	,c.productno,c.product,c.mount,case when isnull(b.mount,0)=0 then 0 else round(c.mount/b.mount,4) end,c.noa,c.noq
	from view_workgs a 
	left join view_work b on b.cuano=a.noa and b.cuanoq=a.noq
	left join view_works c on b.noa=c.noa
	where a.noa=@cuano and a.noq=@cuanoq and @workno like '%'+b.noa+'%'
	and not exists (select * from @tmpa where cuano=a.noa and cuanoq=a.noq and productno=c.productno)
	
	fetch next from cursor_table
	into @idno,@cuano,@cuanoq,@titleno,@title,@workno
end
close cursor_table
deallocate cursor_table

-----------------------------------------------------
--輸出結果
declare @tmpe table(
	gno nvarchar(50),
	idno int,
	idno2 int,
	cuano nvarchar(50),
	cuanoq nvarchar(50),
	titleno nvarchar(MAX),
	title nvarchar(MAX),
	workno nvarchar(MAX),
	ordeno nvarchar(50),
	no2 nvarchar(50),
	custno nvarchar(50),
	comp nvarchar(200),
	odate nvarchar(50),--訂單日
	wdate nvarchar(50),--預計開工日
	tdate nvarchar(50),--預交日
	ucano nvarchar(50),--製成品
	spec nvarchar(MAX),--型號
	omount float,--訂單量
	womount float,--製令產量
	wmount float,--生產量
	productno nvarchar(MAX),--製程完工成品/半成品名稱
	product nvarchar(MAX),--製程完工成品/半成品名稱
	memo nvarchar(MAX),--麥頭+工時
	pmemo nvarchar(MAX)--用量明細
)
if((select count(*) from @tmpc)>0)
begin
	insert @tmpe(gno,idno,idno2,cuano,cuanoq,titleno,title,workno,ordeno,wdate,ucano,spec,womount,wmount
	,productno,product,memo,pmemo,omount)
	select '0',a.idno,0,a.cuano,a.cuanoq,a.titleno,a.title,a.workno
	,b.ordeno,a.wdate,b.productno,b.spec,c.mount,c.mount
	,isnull((select top 1 productno from @tmpd where idno=a.idno),'')
	,isnull((select top 1 product from @tmpd where idno=a.idno),'')
	,'<BR>總工時：'+cast(round(isnull((select SUM(hours) from view_work where cuano=a.cuano and cuanoq=a.cuanoq and a.workno like '%'+noa+'%'),0)/60/60,4) as nvarchar(50))
	,replace(STUFF(isnull((select '#*#'+sproductno+', '+sproduct+', '+CAST(sumount as nvarchar(50))+', '+CAST(smount as nvarchar(50)) from @tmpd where idno=a.idno for xml path('')),''),1,3,''),'#*#','<BR>')
	,b.ordemount--106/08/24 改抓workgs.ordemount
	from @tmpc a left join view_workgs b on a.cuano=b.noa and a.cuanoq=b.noq
	left join view_work c on b.workno=c.noa

	update @tmpe
	set no2=substring(ordeno,CHARINDEX('-',ordeno)+1,LEN(ordeno))
	,ordeno=substring(ordeno,0,CHARINDEX('-',ordeno))
	where len(ordeno)>0 and CHARINDEX('-',ordeno)>0

	update a
	set custno=b.custno,comp=b.comp,odate=b.odate,tdate=c.datea--,omount=c.mount--106/08/24 改抓workgs.ordemount
	,memo='包裝說明及正側嘜：<BR>'+isnull(d.packinglistmemo,'')
	+case when len(isnull(d.main,''))>0 then '正嘜：'+REPLACE(d.main,'chr(10)','<BR>') else '' end
	+case when len(isnull(d.side,''))>0 then '側嘜：'+REPLACE(d.side,'chr(10)','<BR>') else '' end
	+a.memo
	,product=
	--106/08/24 加上半成品件號
	isnull('半成品件號:'+stuff((select ','+productno from view_work where a.workno like '%'+noa+'%' and productno!=a.productno order by noa desc FOR XML PATH('')),1,1,'')+'<BR>','')+
	-------------------------------------------------------------------------------------------
	case when a.ucano=a.productno then 
	isnull((select N'件號中文名稱：型號:'+xa.spec
	+isnull(N',車縫:'+(select mon from adsize where noa=xa.groupeno),'')
	+isnull(N',車縫線顏色:'+(select mon from adspec where noa=c.ucolor),'')
	+isnull(N',護片:'+(select mon from adsss where noa=xa.groupfno),'')
	+isnull(N',皮料1:'+(select mon from adly where noa=c.scolor),'')
	+isnull(N',皮料2:'+(select mon from adly where noa=c.class),'')
	+isnull(N',皮料3:'+(select mon from adly where noa=c.classa),'')
	+isnull(N',皮料4:'+(select mon from adly where noa=c.zinc),'')
	+isnull(N',網烙印:'+(select mon from adoth where noa=c.sizea),'')
	+isnull(N',轉印:'+(select mon from adpro where noa=c.source),'')
	+isnull(N',大弓:'+(select mon from adknife where noa=xa.groupgno),'')
	+isnull(N',中束:'+(select mon from adpipe where noa=xa.grouphno),'')
	+isnull(N',座管:'+(select mon from adtran where noa=xa.groupino),'')
	+isnull(N',電鍍:' +(select mon from addime where noa=c.hard),'')
	+N'<BR>件號越文名稱：Mã hàng:'+xa.spec
	+isnull(N',Đường may:'+(select memo2 from adsize where noa=xa.groupeno),'')
	+isnull(N',Màu chỉ may:'+(select memo2 from adspec where noa=c.ucolor),'')
	+isnull(N',Phụ kiện:'+(select memo2 from adsss where noa=xa.groupfno),'')
	+isnull(N',Da1:'+(select memo2 from adly where noa=c.scolor),'')
	+isnull(N',Da2:'+(select memo2 from adly where noa=c.class),'')
	+isnull(N',Da3:'+(select memo2 from adly where noa=c.classa),'')
	+isnull(N',Da4:'+(select memo2 from adly where noa=c.zinc),'')
	+isnull(N',In ép:'+(select memo2 from adoth where noa=c.sizea),'')
	+isnull(N',In ủi:'+(select memo2 from adpro where noa=c.source),'')
	+isnull(N',Gọng:'+(select memo2 from adknife where noa=xa.groupgno),'')
	+isnull(N',Bông:'+(select memo2 from adpipe where noa=xa.grouphno),'')
	+isnull(N',Ống yên:'+(select memo2 from adtran where noa=xa.groupino),'')
	+isnull(N',mạ:' +(select memo2 from addime where noa=c.hard),'')
	from uca xa where noa=a.ucano),'')
	else a.product end
	from @tmpe a left join view_orde b on a.ordeno=b.noa
	left join view_ordes c on a.ordeno=c.noa and a.no2=c.no2
	left join view_ordei d on b.noa=d.noa

	--依據移轉數量 增加流程卡張數
	if(@x_mount>0)
	begin
		declare @womount float
		declare @twmount float
		declare @idno2 int
		
		declare cursor_table cursor for
		select idno,womount from @tmpe where idno2=0 and womount>@x_mount
		open cursor_table
		fetch next from cursor_table
		into @idno,@womount
		while(@@FETCH_STATUS <> -1)
		begin
			update @tmpe 
			set wmount=@x_mount
			where idno=@idno and idno2=0
			
			set @twmount=@x_mount
			set @idno2=1
			while (@twmount<@womount)
			begin
				set @twmount=@twmount+@x_mount
				
				insert @tmpe(gno,idno,idno2,cuano,cuanoq,titleno,title,workno,ordeno,no2,custno,comp,odate,wdate,tdate,ucano,spec,omount,womount
				,wmount,productno,product,memo,pmemo)
				select gno,idno,@idno2,cuano,cuanoq,titleno,title,workno,ordeno,no2,custno,comp,odate,wdate,tdate,ucano,spec,omount,womount
				,case when  @twmount>@womount then @womount-(@x_mount*@idno2) else @x_mount end
				,productno,product,memo,pmemo
				from @tmpe where idno=@idno and idno2=0
				
				set @idno2=@idno2+1
			end
			
			fetch next from cursor_table
			into @idno,@womount
		end
		close cursor_table
		deallocate cursor_table
	end
	
end
-----------------------------------------------------
--select * from @tmpc
--select * from @tmpd
select case when title='' then titleno else title end+'　('+cast(idno2+1 as nvarchar(10))+'/'+cast((select MAX(idno2)+1 from @tmpe where idno=a.idno) as nvarchar(10))+')' title
,replace(convert(varchar, getdate(), 20),'-','/')q_datetime
,ROW_NUMBER() over (order by cuano,cuanoq,idno,idno2) q_page
,(select count(*) from @tmpe) q_totpage
,cuano+'-'+cuanoq xcuano
,* from @tmpe a
order by cuano,cuanoq,idno,idno2;

--*************************************************************************************************
z_workg_jo02:--z_workg_jo02
SET QUOTED_IDENTIFIER OFF 
declare @t_userno nvarchar(30)
declare @t_rank nvarchar(30)
declare @t_noa nvarchar(30)
declare @t_noq nvarchar(30)
declare @t_bstation nvarchar(50)
declare @t_estation nvarchar(50)

set @t_userno = case when '#non' = '[2]' then '' else  '[2]' end
set @t_rank = case when '#non' = '[4]' then '' else  '[4]' end
set @t_noa = case when '#non' = [5] then '' else  [5] end
set @t_noq = case when '#non' = [6] then '' else  [6] end
set @t_bstation = case when '#non' = [8] then '' else  [8] end
set @t_estation = case when '#non' = [9] then char(255) else  [9] end
--*****************************************************************************************

--未完工排程
declare @noend table(
	cuano nvarchar(50),
	cuanoq nvarchar(50)
)

insert @noend (cuano,cuanoq)
select cuano,cuanoq from view_work 
where isnull(isfreeze,0)=0 and isnull(enda,0)=0 and isnull(mount,0)-isnull(inmount,0)>0
and stationno between @t_bstation and @t_estation
and (len(@t_noa)=0 or cuano=@t_noa) and (len(@t_noq)=0 or cuanoq=@t_noq)  
group by cuano,cuanoq

declare @tmp table(
	cuano nvarchar(50),
	cuanoq nvarchar(50),
	noa nvarchar(MAX),
	productno nvarchar(MAX),
	parent nvarchar(MAX)
)
insert @tmp
select a.cuano,a.cuanoq,noa,productno,case when previd='0' then 'root' else previd end
from view_work a 
where exists (select * from @noend where cuano=a.cuano and cuanoq=a.cuanoq) and isnull(processno,'')!=''

update a 
set parent=isnull(b.productno,'root')
from @tmp a outer apply (select * from @tmp where noa=a.parent)b

--update @tmp
--set parent=SUBSTRING(parent,0,CHARINDEX('_*',parent))
--where parent!='root'

declare @tmpa table(
	idno int identity(0,1),
	cuano nvarchar(50),
	cuanoq nvarchar(50),
	noa nvarchar(MAX),
	productno nvarchar(MAX),
	sortcol nvarchar(max),
	levels int
)
--製令bom表--------------------------------------------------------------
BEGIN TRY
	--遞迴
	WITH OrdersTable (cuano,cuanoq,noa,productno,sortcol,levels) as (
		Select cuano,cuanoq,noa,productno,productno,0
		from @tmp
		where parent='root'
		UNION ALL
		SELECT a.cuano,a.cuanoq,a.noa,a.productno,CONVERT(nvarchar(MAX),OrdersTable.sortcol+'*-*'+a.productno)
		,OrdersTable.levels+1
		FROM @tmp a, OrdersTable
		WHERE a.parent=OrdersTable.productno and a.cuano=OrdersTable.cuano and a.cuanoq=OrdersTable.cuanoq
	)
	
	insert into @tmpa
	Select a.cuano,a.cuanoq,a.noa,a.productno,a.sortcol,a.levels
	From OrdersTable a
	order by a.sortCol
END TRY
BEGIN CATCH
END CATCH
------------------------------------------------------------------
declare @noa nvarchar(50)
declare @cuano nvarchar(50)
declare @cuanoq nvarchar(50)
declare @processno nvarchar(50)
declare @process nvarchar(50)
declare @levels nvarchar(50)
declare @wdate nvarchar(50)
----------------------------
declare @t_cuano nvarchar(50)
declare @t_cuanoq nvarchar(50)
declare @titleno nvarchar(MAX)=''
declare @title nvarchar(MAX)=''
declare @workno nvarchar(MAX)=''
declare @t_levels nvarchar(50)=''
-----------------------------
declare @tmpb table(
	idno int identity(0,1),
	cuano nvarchar(50),
	cuanoq nvarchar(50),
	titleno nvarchar(MAX),
	title nvarchar(MAX),
	workno nvarchar(MAX),
	wdate nvarchar(10)
)

--流程合併----------------------------------------------------
declare cursor_table cursor for
select a.cuano,a.cuanoq,a.noa,b.processno,case when charindex(')',process)=0 then b.process else SUBSTRING(b.process,0,charindex('(',process)) end process,a.levels,b.cuadate
from @tmpa a left join view_work b on a.noa=b.noa order by sortcol
open cursor_table
fetch next from cursor_table
into @cuano,@cuanoq,@noa,@processno,@process,@levels,@wdate
while(@@FETCH_STATUS <> -1)
begin
	if(@t_levels>=@levels or @t_cuano!=@cuano or @t_cuanoq!=@cuanoq)
	begin
		insert @tmpb
		select @t_cuano,@t_cuanoq,@titleno,@title,@workno,@wdate
		set @titleno=''
		set @title=''
		set @workno=''
	end
	
	set @titleno=@processno+case when len(@titleno)>0 then '→' else '' end+@titleno
	set @title=@process+case when len(@title)>0 then '→' else '' end+@title
	set @workno=@noa+case when len(@workno)>0 then '→' else '' end+@workno
	
	set @t_levels=@levels
	set @t_cuano=@cuano
	set @t_cuanoq=@cuanoq
	fetch next from cursor_table
	into @cuano,@cuanoq,@noa,@processno,@process,@levels,@wdate
end
close cursor_table
deallocate cursor_table
--最後一筆
if(len(@t_cuano)>0)
begin
	insert @tmpb
	select @t_cuano,@t_cuanoq,@titleno,@title,@workno,@wdate
end
-----------------------------------------------------------------------
declare @tmpc table(
	idno int identity(0,1),
	cuano nvarchar(50),
	cuanoq nvarchar(50),
	titleno nvarchar(MAX),
	title nvarchar(MAX),
	workno nvarchar(MAX),
	wdate nvarchar(10)
)

--刪除已完工流程 與被凍結流程
delete a from @tmpb a
outer apply (select count(*) counts from view_work where a.workno like '%'+noa+'%' and isnull(mount,0)-isnull(inmount,0)>0 and isnull(isfreeze,0)=0) b
where b.counts<=0

--排除流程相同的資料
insert @tmpc
select cuano,cuanoq,titleno,title,STUFF(isnull((select ','+workno from @tmpb where cuano=a.cuano and cuanoq=a.cuanoq and ((titleno=a.titleno and title=a.title) or a.titleno like titleno+'%' ) for xml path('')),''),1,1,''),MIN(wdate)
from @tmpb a
group by cuano,cuanoq,titleno,title 
having not exists (select * from @tmpb where titleno like a.titleno+'%' and titleno!=a.titleno and cuano=a.cuano and cuanoq=a.cuanoq )
order by MIN(idno)
-------------------------------------
--所需原料
declare @tmpd table(
	idno int,
	cuano nvarchar(50),
	cuanoq nvarchar(50),
	titleno nvarchar(MAX),
	title nvarchar(MAX),
	ucano nvarchar(50),--製成品
	spec nvarchar(MAX),--型號
	productno nvarchar(MAX),--製程完工成品/半成品編號
	product nvarchar(MAX),--製程完工成品/半成品名稱
	--使用耗料
	sproductno nvarchar(50),
	sproduct nvarchar(MAX),
	smount nvarchar(50),
	sumount nvarchar(50),--單位用料
	workno nvarchar(50),
	worknoq nvarchar(50)
)

declare @idno int
declare @ordeno nvarchar(50)
declare @no2 nvarchar(50)

declare cursor_table cursor for
select idno,cuano,cuanoq,titleno,title,workno from @tmpc order by cuano,cuanoq,idno
open cursor_table
fetch next from cursor_table
into @idno,@cuano,@cuanoq,@titleno,@title,@workno
while(@@FETCH_STATUS <> -1)
begin
	set @processno=@titleno
	while CHARINDEX('→',@processno)>0
	begin
		set @processno=substring(@processno,CHARINDEX('→',@processno)+1,LEN(@processno))
	end
	
	insert @tmpd(idno,cuano,cuanoq,titleno,title,ucano,spec,productno,product
	,sproductno,sproduct,smount,sumount,workno,worknoq)
	select @idno,@cuano,@cuanoq,@titleno,@title,a.productno,a.spec
	,(select top 1 productno from view_work where cuano=a.noa and cuanoq=a.noq and processno=@processno and @workno like '%'+noa+'%' order by noa)
	,(select top 1 product from view_work where cuano=a.noa and cuanoq=a.noq and processno=@processno and @workno like '%'+noa+'%' order by noa)
	,c.productno,c.product,c.mount,case when isnull(b.mount,0)=0 then 0 else round(c.mount/b.mount,4) end,c.noa,c.noq
	from view_workgs a 
	left join view_work b on b.cuano=a.noa and b.cuanoq=a.noq
	left join view_works c on b.noa=c.noa
	where a.noa=@cuano and a.noq=@cuanoq and @workno like '%'+b.noa+'%'
	and not exists (select * from @tmpa where cuano=a.noa and cuanoq=a.noq and productno=c.productno)
	
	fetch next from cursor_table
	into @idno,@cuano,@cuanoq,@titleno,@title,@workno
end
close cursor_table
deallocate cursor_table

-----------------------------------------------------
--輸出結果
declare @tmpe table(
	gno nvarchar(50),
	idno nvarchar(50),
	cuano nvarchar(50),
	cuanoq nvarchar(50),
	titleno nvarchar(MAX),
	title nvarchar(MAX),
	workno nvarchar(MAX),
	ordeno nvarchar(50),
	no2 nvarchar(50),
	custno nvarchar(50),
	comp nvarchar(200),
	odate nvarchar(50),--訂單日
	wdate nvarchar(50),--預計開工日
	tdate nvarchar(50),--預交日
	ucano nvarchar(50),--製成品
	spec nvarchar(MAX),--型號
	omount float,--訂單量
	wmount float,--生產量
	productno nvarchar(MAX),--製程完工成品/半成品名稱
	product nvarchar(MAX),--製程完工成品/半成品名稱
	memo nvarchar(MAX),--麥頭+工時
	pmemo nvarchar(MAX)--用量明細
)
if((select count(*) from @tmpc)>0)
begin
	insert @tmpe(gno,idno,cuano,cuanoq,titleno,title,workno,ordeno,wdate,ucano,spec,wmount
	,productno,product,memo,pmemo,omount)
	select '0',a.idno,a.cuano,a.cuanoq,a.titleno,a.title,a.workno
	,b.ordeno,a.wdate,b.productno,b.spec,c.mount
	,isnull((select top 1 productno from @tmpd where idno=a.idno),'')
	,isnull((select top 1 product from @tmpd where idno=a.idno),'')
	,'<BR>總工時：'+cast(round(isnull((select SUM(hours) from view_work where cuano=a.cuano and cuanoq=a.cuanoq and a.workno like '%'+noa+'%'),0)/60/60,4) as nvarchar(50))
	,replace(STUFF(isnull((select '#*#'+sproductno+', '+sproduct+', '+CAST(sumount as nvarchar(50))+', '+CAST(smount as nvarchar(50)) from @tmpd where idno=a.idno for xml path('')),''),1,3,''),'#*#','<BR>')
	,b.ordemount--106/08/24 改抓workgs.ordemount
	from @tmpc a left join view_workgs b on a.cuano=b.noa and a.cuanoq=b.noq
	left join view_work c on b.workno=c.noa

	update @tmpe
	set no2=substring(ordeno,CHARINDEX('-',ordeno)+1,LEN(ordeno))
	,ordeno=substring(ordeno,0,CHARINDEX('-',ordeno))
	where len(ordeno)>0 and CHARINDEX('-',ordeno)>0

	update a
	set custno=b.custno,comp=b.comp,odate=b.odate,tdate=c.datea--,omount=c.mount--106/08/24 改抓workgs.ordemount
	,memo='包裝說明及正側嘜：<BR>'+isnull(d.packinglistmemo,'')
	+case when len(isnull(d.main,''))>0 then '正嘜：'+REPLACE(d.main,'chr(10)','<BR>') else '' end
	+case when len(isnull(d.side,''))>0 then '側嘜：'+REPLACE(d.side,'chr(10)','<BR>') else '' end
	+a.memo
	,product=
	--106/08/24 加上半成品件號
	isnull('半成品件號:'+stuff((select ','+productno from view_work where a.workno like '%'+noa+'%' and productno!=a.productno order by noa desc FOR XML PATH('')),1,1,'')+'<BR>','')+
	---------------------------------------------------------------
	case when a.ucano=a.productno then 
	isnull((select N'件號中文名稱：型號:'+xa.spec
	+isnull(N',車縫:'+(select mon from adsize where noa=xa.groupeno),'')
	+isnull(N',車縫線顏色:'+(select mon from adspec where noa=c.ucolor),'')
	+isnull(N',護片:'+(select mon from adsss where noa=xa.groupfno),'')
	+isnull(N',皮料1:'+(select mon from adly where noa=c.scolor),'')
	+isnull(N',皮料2:'+(select mon from adly where noa=c.class),'')
	+isnull(N',皮料3:'+(select mon from adly where noa=c.classa),'')
	+isnull(N',皮料4:'+(select mon from adly where noa=c.zinc),'')
	+isnull(N',網烙印:'+(select mon from adoth where noa=c.sizea),'')
	+isnull(N',轉印:'+(select mon from adpro where noa=c.source),'')
	+isnull(N',大弓:'+(select mon from adknife where noa=xa.groupgno),'')
	+isnull(N',中束:'+(select mon from adpipe where noa=xa.grouphno),'')
	+isnull(N',座管:'+(select mon from adtran where noa=xa.groupino),'')
	+isnull(N',電鍍:' +(select mon from addime where noa=c.hard),'')
	+N'<BR>件號越文名稱：Mã hàng:'+xa.spec
	+isnull(N',Đường may:'+(select memo2 from adsize where noa=xa.groupeno),'')
	+isnull(N',Màu chỉ may:'+(select memo2 from adspec where noa=c.ucolor),'')
	+isnull(N',Phụ kiện:'+(select memo2 from adsss where noa=xa.groupfno),'')
	+isnull(N',Da1:'+(select memo2 from adly where noa=c.scolor),'')
	+isnull(N',Da2:'+(select memo2 from adly where noa=c.class),'')
	+isnull(N',Da3:'+(select memo2 from adly where noa=c.classa),'')
	+isnull(N',Da4:'+(select memo2 from adly where noa=c.zinc),'')
	+isnull(N',In ép:'+(select memo2 from adoth where noa=c.sizea),'')
	+isnull(N',In ủi:'+(select memo2 from adpro where noa=c.source),'')
	+isnull(N',Gọng:'+(select memo2 from adknife where noa=xa.groupgno),'')
	+isnull(N',Bông:'+(select memo2 from adpipe where noa=xa.grouphno),'')
	+isnull(N',Ống yên:'+(select memo2 from adtran where noa=xa.groupino),'')
	+isnull(N',mạ:' +(select memo2 from addime where noa=c.hard),'')
	from uca xa where noa=a.ucano),'')
	else a.product end
	from @tmpe a left join view_orde b on a.ordeno=b.noa
	left join view_ordes c on a.ordeno=c.noa and a.no2=c.no2
	left join view_ordei d on b.noa=d.noa
end
-----------------------------------------------------
select '' procs
--case when @t_rank>='8' then '' else isnull((select process from process where noa=@s_process),'') end procs
,replace(replace(replace((select "〈button id='"+noa+"' style='font-size: medium"+char(59)+"width: 190px"+char(59)+"white-space:pre-wrap"+char(59)+"' onclick='workin(this)' "+(case when isnull(isfreeze,0)=1 then "disabled=disabled" else '' end)+" 〉"+case when len(stationno)=0 then processno+(case when isnull(isfreeze,0)=1 then '(已凍結)' else '' end)+'◎@'+left(process,11) else stationno+(case when isnull(isfreeze,0)=1 then '(已凍結)' else '' end)+'◎@'+left(station,12) end+"◎@"+noa+"〈/button〉 " from view_work where a.workno like '%'+noa+'%' and (stationno between @t_bstation and @t_estation) and isnull(mount,0)-isnull(inmount,0)>0 order by noa desc for xml path('')),'〈','<'),'〉','>'),'◎@','&#010')btnlist
,case when title='' then titleno else title end title
,replace(convert(varchar, getdate(), 20),'-','/')q_datetime
,ROW_NUMBER() over (order by cuano,cuanoq,idno) q_page
,(select count(*) from @tmpe) q_totpage
,cuano+'-'+cuanoq xcuano
,* from @tmpe a 
where (select count(*) from view_work where a.workno like '%'+noa+'%' and (stationno between @t_bstation and @t_estation) and isnull(mount,0)-isnull(inmount,0)>0) >0
order by cuano,cuanoq,idno;
--*************************************************************************************************
z_workg_jo03:--z_workg_jo03
SET QUOTED_IDENTIFIER OFF
declare @t_datea nvarchar(10) --工作日
declare @t_stationno nvarchar(50) --工作線
declare @t_realwork nvarchar(10) --排除模擬製令
declare @t_xshownowork nvarchar(50) --未完工

set @t_datea = case when '#non' = [12] then '' else [12] end 
set @t_stationno = case when '#non' = [13] then '' else [13] end 
set @t_realwork = case when '#non' = [11] then '' else [11] end 
set @t_xshownowork = case when '#non' = [7] then '' else [7] end 

declare @tmp table(
	gno nvarchar(10),
	idno int,
	datea nvarchar(10),
	productno nvarchar(90),
	product nvarchar(max),
	stationno nvarchar(90),
	station nvarchar(max),
	gen nvarchar(max),
	ordeno nvarchar(max),
	workno nvarchar(max),
	mount float,
	c1 float,
	notv float,
	hours float,
	btime nvarchar(50),
	etime nvarchar(50),
	cuano nvarchar(50),
	cuanoq nvarchar(50),
	nom nvarchar(50),
	nos nvarchar(50),
	noq nvarchar(50)
)
insert @tmp
select '0' gen,0,a.datea,c.productno,c.product,a.stationno,b.station
	,case when isnull(d.minutes,0)=0 and isnull(d.sec,0)=0 then null when isnull(d.sec,0)>0 then cast(round(isnull(d.sec,0),3) as nvarchar) + ' Sec.' when isnull(d.minutes,0)>0 then cast(round(isnull(d.minutes,0),3) as nvarchar) + ' Min.' end
	+case when len(d.unit)>0 then '/ '+d.unit else '' end
	,e.ordeno,a.workno,a.mount,isnull(f.inmount,0) c1,a.mount-isnull(f.inmount,0) notv
	,a.hours,'','',e.cuano,e.cuanoq,a.nom,a.nos,a.noq
	from view_cugu a left join station b on (a.stationno=b.noa) left join view_work c on (a.workno=c.noa)
	outer apply(select case when isnull(minutes,0)>isnull(hminutes,0) then minutes else hminutes end minutes
	,case when isnull(sec,0)>isnull(hsec,0) then sec else hsec end sec
	,unit from uca where noa=c.productno) d
	--當天排產數量-當天或提前入庫數量(之後入庫的不算)
	--outer apply (select SUM(mount)inmount from view_workbs where workno=a.workno and datea<=a.datea)f
	--106/08/23 不管是甚麼時候入庫
	outer apply (select * from view_work where noa=a.workno)e
	outer apply (select SUM(mount)inmount from view_workbs where workno=a.workno)f
	where (a.datea=@t_datea) 
	and (a.stationno=@t_stationno) 
	and (len(@t_realwork)=0 or a.workno like 'W[0-9]%')
	and (left(isnull(c.productno,''),5)!='D4302')
	and (len(@t_xshownowork)=0 or isnull(c.enda,0)!=1 )

update a 
set idno=rr,btime=case when rr=1 then '08:00:00' else '' end
from (select idno,btime,ROW_NUMBER()over (partition by stationno order by stationno,workno)rr from @tmp) a

update a
set etime=RIGHT(CONVERT(NVARCHAR,DATEADD(SS,thours*60*60,CAST(CONVERT(NVARCHAR, GETDATE(), 111)+' 08:00' as DATETIME)),120),8)
from @tmp a outer apply (select SUM(hours)thours from @tmp where idno<=a.idno)b

update a
set btime=b.etime
from @tmp a outer apply (select etime from @tmp where idno=a.idno-1)b
where a.idno>1

--開工時間接近中午12點
update @tmp
set btime='12:00:00'
where left(btime,5)='11:59'

--中午增加1小時
update @tmp 
set btime=case when btime>='12:00' then 
cast(cast(LEFT(btime,2) as int)+1 as nvarchar(10))+RIGHT(btime,6) else btime end
,etime=case when etime>='12:00' then 
cast(cast(LEFT(etime,2) as int)+1 as nvarchar(10))+RIGHT(etime,6) else etime end
where ('12:00' between left(btime,5) and left(etime,5) 
or left(btime,5)>='12:00') and left(etime,5)!='12:00'

insert @tmp (gno,datea,stationno,station,mount,c1,notv,hours)
select '1',datea,stationno,MAX(station),SUM(mount),SUM(c1),SUM(notv),SUM(hours) 
from @tmp group by datea,stationno

select 
productno pno,
stationno sno,
dbo.getComma(hours,3)thours,
dbo.getComma(mount,-1)mount,
dbo.getComma(c1,-1)c1,
dbo.getComma(notv,-1)notv,
replace(replace(replace("〈button id='"+workno+"##"+datea+"##"+nos+"##"+nom+"##"+noq+"##"+btime+"##"+etime+"' style='font-size: medium"+char(59)+"width: 30px"+char(59)+"white-space:pre-wrap"+char(59)+"' onclick='workshow(this)' 〉→〈/button〉 " ,'〈','<'),'〉','>'),'◎@','&#010')btnwork,
replace(replace(replace("〈button id='"+workno+"' style='font-size: medium"+char(59)+"width: 30px"+char(59)+"white-space:pre-wrap"+char(59)+"' onclick='workin(this)' 〉↓〈/button〉 " ,'〈','<'),'〉','>'),'◎@','&#010')btnin,
* from @tmp order by datea,stationno,gno,idno
;
--*************************************************************************************************
showworkg:--showworkg --現場流程卡
SET QUOTED_IDENTIFIER OFF 
declare @t_workno nvarchar(50)=[1]
declare @t_datea nvarchar(50)=[2]
declare @t_nos nvarchar(50)=[3]
declare @t_nom nvarchar(50)=[4]
declare @t_noq nvarchar(50)=[5]

declare @tmp table(
	workno nvarchar(50),
	ordeno nvarchar(50),
	no2 nvarchar(50),
	ordedatea nvarchar(50),
	custno nvarchar(50),
	comp nvarchar(MAX),
	cuano nvarchar(50),
	ordeodate nvarchar(50),
	wdate nvarchar(50),
	productno nvarchar(50),--製成品
	spec nvarchar(MAX),--型號
	bmount float,
	omount float,
	productno2 nvarchar(50),--半成品
	uca nvarchar(MAX),
	memo1 nvarchar(MAX),
	memo2 nvarchar(MAX),
	processno nvarchar(MAX),
	process nvarchar(MAX),
	stationno nvarchar(MAX),
	station nvarchar(MAX)
)

insert @tmp
select a.workno,b.noa ordeno,b.no2,c.datea ordedatea,d.custno,d.comp,b.cuano+'-'+b.cuanoq cuano
,d.odate,a.datea,c.productno,c.spec,b.mount bmount,e.ordemount,b.productno,b.product
,'<BR>總工時：'+cast(round(isnull((select SUM(hours) from view_work where cuano=b.cuano and cuanoq=b.cuanoq and a.workno like '%'+noa+'%'),0)/60/60,4) as nvarchar(50))
,replace(STUFF(isnull((
select '#*#'+wb.productno+', '+wb.product+', '+CAST(case when isnull(wa.mount,0)=0 then 0 else round(wb.mount/wa.mount,4) end as nvarchar(50))+', '+CAST(wb.mount as nvarchar(50)) 
from view_work wa left join view_works wb on wa.noa=wb.noa 
where wa.noa=a.workno for xml path('')),''),1,3,''),'#*#','<BR>')
,b.processno,b.process,b.stationno,b.station
from view_cugu a left join view_work b on a.workno=b.noa
left join view_ordes c on b.ordeno=c.noa and b.no2=c.no2
left join view_orde d on c.noa=d.noa
outer apply (select SUM(mount)bmount,SUM(ordemount)ordemount from view_workgs where noa=b.cuano and noq=b.cuanoq)e

where a.workno=@t_workno and a.datea=@t_datea and a.nos=@t_nos and a.nom=@t_nom and a.noq=@t_noq

update a
	set memo1='包裝說明及正側嘜：<BR>'+isnull(d.packinglistmemo,'')
	+case when len(isnull(d.main,''))>0 then '正嘜：'+REPLACE(d.main,'chr(10)','<BR>') else '' end
	+case when len(isnull(d.side,''))>0 then '側嘜：'+REPLACE(d.side,'chr(10)','<BR>') else '' end
	+a.memo1
	,uca=
	isnull('半成品件號:'+stuff((select ','+productno from view_work where a.workno like '%'+noa+'%' and productno!=a.productno order by noa desc FOR XML PATH('')),1,1,'')+'<BR>','')+
	-------------------------------------------------------------------------------------------
	case when a.productno=a.productno2 then 
	isnull((select N'件號中文名稱：型號:'+xa.spec
	+isnull(N',車縫:'+(select mon from adsize where noa=xa.groupeno),'')
	+isnull(N',車縫線顏色:'+(select mon from adspec where noa=c.ucolor),'')
	+isnull(N',護片:'+(select mon from adsss where noa=xa.groupfno),'')
	+isnull(N',皮料1:'+(select mon from adly where noa=c.scolor),'')
	+isnull(N',皮料2:'+(select mon from adly where noa=c.class),'')
	+isnull(N',皮料3:'+(select mon from adly where noa=c.classa),'')
	+isnull(N',皮料4:'+(select mon from adly where noa=c.zinc),'')
	+isnull(N',網烙印:'+(select mon from adoth where noa=c.sizea),'')
	+isnull(N',轉印:'+(select mon from adpro where noa=c.source),'')
	+isnull(N',大弓:'+(select mon from adknife where noa=xa.groupgno),'')
	+isnull(N',中束:'+(select mon from adpipe where noa=xa.grouphno),'')
	+isnull(N',座管:'+(select mon from adtran where noa=xa.groupino),'')
	+isnull(N',電鍍:' +(select mon from addime where noa=c.hard),'')
	+N'<BR>件號越文名稱：Mã hàng:'+xa.spec
	+isnull(N',Đường may:'+(select memo2 from adsize where noa=xa.groupeno),'')
	+isnull(N',Màu chỉ may:'+(select memo2 from adspec where noa=c.ucolor),'')
	+isnull(N',Phụ kiện:'+(select memo2 from adsss where noa=xa.groupfno),'')
	+isnull(N',Da1:'+(select memo2 from adly where noa=c.scolor),'')
	+isnull(N',Da2:'+(select memo2 from adly where noa=c.class),'')
	+isnull(N',Da3:'+(select memo2 from adly where noa=c.classa),'')
	+isnull(N',Da4:'+(select memo2 from adly where noa=c.zinc),'')
	+isnull(N',In ép:'+(select memo2 from adoth where noa=c.sizea),'')
	+isnull(N',In ủi:'+(select memo2 from adpro where noa=c.source),'')
	+isnull(N',Gọng:'+(select memo2 from adknife where noa=xa.groupgno),'')
	+isnull(N',Bông:'+(select memo2 from adpipe where noa=xa.grouphno),'')
	+isnull(N',Ống yên:'+(select memo2 from adtran where noa=xa.groupino),'')
	+isnull(N',mạ:' +(select memo2 from addime where noa=c.hard),'')
	from uca xa where noa=a.productno),'')
	else a.uca end
	from @tmp a left join view_orde b on a.ordeno=b.noa
	left join view_ordes c on a.ordeno=c.noa and a.no2=c.no2
	left join view_ordei d on b.noa=d.noa

select * from @tmp;

--*************************************************************************************************
workg_jo_put:--workg_jo_put 流程卡入庫
SET QUOTED_IDENTIFIER OFF 
declare @t_workno nvarchar(50)=[1]
declare @t_mount nvarchar(50) = [2]
declare @datea nvarchar(50)=[3]
declare @timea nvarchar(50)=[4]
declare @t_year nvarchar(50)=[5]
declare @t_userno nvarchar(50) = [6]
declare @t_namea nvarchar(50) = [7]
declare @t_team nvarchar(50) = [8]
declare @t_inmount nvarchar(50) = [9]
declare @t_wmount nvarchar(50) = [10]
declare @t_fixmount nvarchar(50) = [11]
declare @t_qcmount nvarchar(50) = [12]
declare @t_err nvarchar(max)=''

declare @mount float = cast(@t_mount as float)
declare @inmount float = cast(@t_inmount as float)
declare @wmount float = cast(@t_wmount as float)
declare @fixmount float = cast(@t_fixmount as float)
declare @qcmount float = cast(@t_qcmount as float)
declare @t_wamount nvarchar(50)=cast(@mount+@wmount as nvarchar(50))
declare @accy nvarchar(50)=isnull((select accy from view_work where noa=@t_workno),@t_year)
declare @workano nvarchar(50)=isnull((select MAX(noa) from view_worka where noa like 'WA'+replace(@datea,'/','')+'%'),'000')
declare @workbno nvarchar(50)=isnull((select MAX(noa) from view_workb where noa like 'WB'+replace(@datea,'/','')+'%'),'000')
set @workano='WA'+replace(@datea,'/','')+right('000'+cast(cast(right(@workano,3) as int)+1 as nvarchar(50)),3)
set @workbno='WB'+replace(@datea,'/','')+right('000'+cast(cast(right(@workbno,3) as int)+1 as nvarchar(50)),3)

set @t_team = case when '#non' = @t_team then '' else  @t_team end

declare @stationno nvarchar(50)=isnull((select top 1 stationno from view_work where noa=@t_workno),'')
declare @storeno nvarchar(50)=isnull((select top 1 storeno from station where noa=@stationno),'')
declare @store nvarchar(100)=isnull((select top 1 store from station where noa=@stationno),'')
declare @storeinno nvarchar(50)=isnull((select top 1 storeinno from station where noa=@stationno),'')
declare @storein nvarchar(100)=isnull((select top 1 storein from station where noa=@stationno),'')

BEGIN TRY
	Begin Transaction

		--領料
		EXEC("
		insert worka"+@accy+"(noa,typea,datea,timea,stationno,station,processno,process,workno,worker,memo
		,storeno,store,modelno,model,mechno,mech,bdate,edate)
		select '"+@workano+"','1','"+@datea+"','"+@timea+"',stationno,station,processno,process,'"+@t_workno+"','"+@t_namea+"','由流程卡入庫產生'
		,'"+@storeno+"','"+@store+"','','','','','','' from view_work where noa='"+@t_workno+"'")

		EXEC("
		insert workas"+@accy+"(noa,noq,datea,productno,product,spec,style,unit,mount,workno,storeno,store,memo,uno)
		select  '"+@workano+"',b.noq,'"+@datea+"',b.productno,b.product,b.spec,b.style,b.unit
		,case when a.mount=0 then 0 else round((b.mount/a.mount)*"+@t_wamount+",2) end ,'"+@t_workno+"','"+@storeno+"','"+@store+"',''
		,case when len(isnull(c.uno,''))>0 and isnull(c.emount,0)>case when a.mount=0 then 0 else round((b.mount/a.mount)*"+@t_wamount+",2) end then c.uno
		when len(isnull(d.uno,''))>0 and isnull(d.emount,0)>case when a.mount=0 then 0 else round((b.mount/a.mount)*"+@t_wamount+",2) end then d.uno else '' end
		from view_work a left join view_works b on a.noa=b.noa 
		outer apply (select top 1 uno,emount from uccy where uno like b.ordeno+'-'+b.no2+'%' and emount>0)c
		outer apply (select top 1 uno,emount from uccy where uno like b.ordeno+'%' and emount>0)d
		where a.noa='"+@t_workno+"'")

		--入庫
		EXEC("
		insert workb"+@accy+"(noa,datea,worktime,stationno,station,workno,workano,worker,memo
		,storeno,store,mechno,mech,bdate,edate,team)
		select '"+@workbno+"','"+@datea+"','"+@timea+"',stationno,station,'"+@t_workno+"','"+@workano+"','"+@t_namea+"','由流程卡入庫產生'
		,'"+@storeinno+"','"+@storein+"','','','','','"+@t_team+"' from view_work where noa='"+@t_workno+"' ")

		EXEC("
		insert workbs"+@accy+"(noa,noq,datea,productno,product,spec,style,unit,mount,workno,storeno,store,memo,inmount,wmount,fixmount,qcmount)
		select  '"+@workbno+"','001','"+@datea+"',a.productno,a.product,a.spec,a.style,a.unit,"+@t_mount+",'"+@t_workno+"','"+@storeinno+"','"+@storein+"',''
		,"+@t_inmount+","+@t_wmount+","+@t_fixmount+","+@t_qcmount+"
		from view_work a where a.noa='"+@t_workno+"'")
		
		Commit Transaction
		
	END TRY
	BEGIN CATCH
		ROLLBACK
		set @t_err='入庫失敗，請聯絡工程師!!'
	END CATCH

select @workano workano,@workbno workbno,@t_err err

;
--*************************************************************************************************
workg_jo_pul:--workg_jo_pul 流程卡退件
SET QUOTED_IDENTIFIER OFF 
declare @t_workno nvarchar(50)=[1]
declare @t_mount nvarchar(50) = [2]
declare @datea nvarchar(50)=[3]
declare @timea nvarchar(50)=[4]
declare @t_year nvarchar(50)=[5]
declare @t_userno nvarchar(50) = [6]
declare @t_namea nvarchar(50) = [7]
declare @t_team nvarchar(50) = [8]
declare @t_memo nvarchar(50) = [9]
declare @t_err nvarchar(max)=''

declare @mount float = cast(@t_mount as float)
declare @accy nvarchar(50)=isnull((select accy from view_work where noa=@t_workno),@t_year)
declare @workano nvarchar(50)=isnull((select MAX(noa) from view_worka where noa like 'WA'+replace(@datea,'/','')+'%'),'000')
declare @workbno nvarchar(50)=isnull((select MAX(noa) from view_workb where noa like 'WB'+replace(@datea,'/','')+'%'),'000')
set @workano='WA'+replace(@datea,'/','')+right('000'+cast(cast(right(@workano,3) as int)+1 as nvarchar(50)),3)
set @workbno='WB'+replace(@datea,'/','')+right('000'+cast(cast(right(@workbno,3) as int)+1 as nvarchar(50)),3)

set @t_team = case when '#non' = @t_team then '' else  @t_team end
set @t_memo = case when '#non' = @t_memo then '' else  @t_memo end

declare @stationno nvarchar(50)=isnull((select top 1 stationno from view_work where noa=@t_workno),'')
declare @storeno nvarchar(50)=isnull((select top 1 storeno from station where noa=@stationno),'')
declare @store nvarchar(100)=isnull((select top 1 store from station where noa=@stationno),'')
declare @storeinno nvarchar(50)=isnull((select top 1 storeinno from station where noa=@stationno),'')
declare @storein nvarchar(100)=isnull((select top 1 storein from station where noa=@stationno),'')

BEGIN TRY
	Begin Transaction

		--領料
		EXEC("
		insert worka"+@accy+"(noa,typea,datea,timea,stationno,station,processno,process,workno,worker,memo
		,storeno,store,modelno,model,mechno,mech,bdate,edate)
		select '"+@workano+"','1','"+@datea+"','"+@timea+"',stationno,station,processno,process,'"+@t_workno+"','"+@t_namea+"','由流程卡退件產生'
		,'"+@storeno+"','"+@store+"','','','','','','' from view_work where noa='"+@t_workno+"'")

		EXEC("
		insert workas"+@accy+"(noa,noq,datea,productno,product,spec,style,unit,mount,workno,storeno,store,memo)
		select  '"+@workano+"',b.noq,'"+@datea+"',b.productno,b.product,b.spec,b.style,b.unit
		,case when a.mount=0 then 0 else round((b.mount/a.mount)*-1*"+@t_mount+",2) end ,'"+@t_workno+"','"+@storeno+"','"+@store+"','"+@t_memo+"'
		from view_work a left join view_works b on a.noa=b.noa where a.noa='"+@t_workno+"'")

		--入庫
		EXEC("
		insert workb"+@accy+"(noa,datea,worktime,stationno,station,workno,workano,worker,memo
		,storeno,store,mechno,mech,bdate,edate,team)
		select '"+@workbno+"','"+@datea+"','"+@timea+"',stationno,station,'"+@t_workno+"','"+@workano+"','"+@t_namea+"','由流程卡退件產生'
		,'"+@storeinno+"','"+@storein+"','','','','','"+@t_team+"' from view_work where noa='"+@t_workno+"' ")

		EXEC("
		insert workbs"+@accy+"(noa,noq,datea,productno,product,spec,style,unit,mount,workno,storeno,store,memo)
		select  '"+@workbno+"','001','"+@datea+"',a.productno,a.product,a.spec,a.style,a.unit,-1*"+@t_mount+",'"+@t_workno+"','"+@storeinno+"','"+@storein+"','"+@t_memo+"'
		from view_work a where a.noa='"+@t_workno+"'")
		
		Commit Transaction
		
	END TRY
	BEGIN CATCH
		ROLLBACK
		set @t_err='入庫失敗，請聯絡工程師!!'
	END CATCH

select @workano workano,@workbno workbno,@t_err err

;
