z_401:--z_401 ref.qac.z_401
declare @t_xbmon nvarchar(20)='' --資料月份
declare @t_xemon nvarchar(20)=''
declare @t_xdate nvarchar(20)='' --申報日期
declare @t_48 float=0 --106/08/01 不使用 進貨及費用
declare @t_49 float=0 --106/08/01 不使用 固定資產
declare @t_108 float=0 --上期(月)累積留抵稅額
declare @t_73 float=0 --進口免稅貨物
declare @t_74 float=0 --購買國外勞務
declare @t_82 float=0 --免稅出口免開立統一發票銷售額
declare @t_13 float=0 --106/08/01 不使用 免用發票銷售額
declare @t_14 float=0 --106/08/01 不使用 免用發票稅額

--106/08/01 新增
declare @t_105 float=0 --403用 中途歇業/年底調整 補徵應繳稅額
declare @t_109 float=0 --403用 中途歇業或年底調整應退稅額、 辦理現場小額退稅申報扣減金額
declare @t_4013 nvarchar(20)='1' --401=1 403=3

set @t_xbmon = case when '#non' = [1] then '' else [1] end
set @t_xemon = case when '#non' = [2] then '' else [2] end
set @t_xdate = case when '#non' = [3] then '' else [3] end
set @t_48 = CAST(REPLACE((case when '#non' = [4] then '0' else [4] end),',','') as float)
set @t_49 = CAST(REPLACE((case when '#non' = [5] then '0' else [5] end),',','') as float)
set @t_108 = CAST(REPLACE((case when '#non' = [6] then '0' else [6] end),',','') as float)
set @t_73 = CAST(REPLACE((case when '#non' = [7] then '0' else [7] end),',','') as float)
set @t_74 = CAST(REPLACE((case when '#non' = [8] then '0' else [8] end),',','') as float)
set @t_82 = CAST(REPLACE((case when '#non' = [7] then '0' else [9] end),',','') as float)
set @t_13 = CAST(REPLACE((case when '#non' = [10] then '0' else [10] end),',','') as float)
set @t_14 = CAST(REPLACE((case when '#non' = [11] then '0' else [11] end),',','') as float)
set @t_105 = CAST(REPLACE((case when '#non' = [12] then '0' else [12] end),',','') as float)
set @t_109 = CAST(REPLACE((case when '#non' = [13] then '0' else [13] end),',','') as float)
------------------------------------------------------------------------------------------------
declare @t_xmon nvarchar(20)
set @t_xmon=left(dbo.q_cdn(@t_xemon+'/01',45),6)

if(@t_xdate='')
begin
	set @t_xdate=CONVERT (VARCHAR(7), GETDATE(),12 )+0890000
	set @t_xdate=left(@t_xdate,3)+'/'+substring(@t_xdate,4,2)+'/'+right(@t_xdate,2)
end
--------------------------------------------------------------------------------------------------------------------
--發票內容
declare @ztax table(
	cno nvarchar(100),
	kind nvarchar(100),
	mon nvarchar(10),
	datea nvarchar(10),
	serial nvarchar(20),
	noa nvarchar(20),
	noq nvarchar(20),
	money float,
	taxtype nvarchar(10), --1應稅 2零稅率 3內含 4免稅
	tax float,
	total float,
	rem1 nvarchar(10),-- 扣抵代號
	specialtax nvarchar(10), --特種稅率
	dutymemo nvarchar(100),	--海關繳納證
	passtype nvarchar(100),	--通關方式
	isadd bit, --彙加
	notaxnote nvarchar(10),--銷售註記 1土地 2其他固定資產
	mount float --憑證張數
)
insert @ztax
select cno,kind,mon,datea,serial,noa,noq
,round(money,0),isnull(taxtype,'1'),round(isnull(tax,0),0),ISNULL(total,0)
,(case when typea='2' then ' ' 
when isnull(isasset,0)=0 and isnull(isnondeductible,0)=0 then '1' --可扣抵之進貨及費用
when isnull(isasset,0)=1 and isnull(isnondeductible,0)=0 then '2' --可扣抵之固定資產
when isnull(isasset,0)=0 and isnull(isnondeductible,0)=1 then '3' --不可扣抵之進貨及費用
when isnull(isasset,0)=1 and isnull(isnondeductible,0)=1 then '4' --不可扣抵之固定資產
else ' ' end)
,specialtax,isnull(dutymemo,''),passtype,isadd,notaxnote,mount
from vcct where mon=@t_xmon

--21 23 24 25 營業稅額應等於銷售金額*稅率
--22 27 營業稅額應等於零。
--26 營業稅額為彙加發票上之營業稅額之合計數但每張稅額應不大於伍百元
--28 海關代徵營業稅繳納證內之營業稅額
--29 海關退還溢繳之營業稅額

--31 35 36 售予營業人時：營業稅額應等於銷售金額*徵收率 非營業人時：營業稅額應等於零。
--32 營業稅額應等於零。
--33 34 營業稅額應等於銷售金額*徵收率。
--37 38 營業稅額一律為零

update @ztax set tax=0 where kind='37' or kind='38' or kind='32' or (kind='22' and len(dutymemo)=0) or kind='27'

--變更國稅局稅額 (系統 1應稅 2零稅率 4免稅 5自訂 6作廢 D空白 3 內含(已不使用)
--         對應 國稅局 1應稅 2零稅率 3免稅 1自訂 F作廢 D空白)

--避免早期資料還有內含發票將期轉成應稅(RB 105)
update @ztax set taxtype='1' where taxtype='3' and datea < '106/01/01'
--變更自訂
update @ztax set taxtype='1' where taxtype='5'
--變更免稅
update @ztax set taxtype='3' where taxtype='4'
--變更作廢
update @ztax set taxtype='F' where taxtype='6'

--稅額=0
--4免稅 2零稅率 6作廢 D空白
update @ztax set tax=0 where taxtype!='1' --非1應稅

--避免稅額與內含錯誤(與vfp不同 前端含稅會算完)--20160114 35 稅額空白自動算出
update @ztax 
set money=round(total/(1+0.05),0)
,tax=total-round(total/(1+0.05),0)
where ((kind='33' or kind='34' or kind='21' or kind='23' or kind='24' or kind='25') 
or((kind='31' or kind='35' or kind='36') and len(serial)>0)) --營業人
and tax=0 and total>0
and taxtype='1' --應稅
--------------------------------------------------------------------------
--TET 營業人銷售額與稅額申報書檔
declare @tmpa table(
	gno nvarchar(1),
	taxport nvarchar(90),
	taxportname nvarchar(90),
	cno nvarchar(50),
	years nvarchar(10),
	bmon nvarchar(10),
	emon nvarchar(10),
	acomp nvarchar(100),
	taxno nvarchar(100),
	serial nvarchar(50),
	boss nvarchar(50),
	acomp_addr nvarchar(200),
	typea nvarchar(200),
	code nvarchar(200),
	atype nvarchar(200),
	aname nvarchar(200),
	aid nvarchar(200),
	aarea nvarchar(50),
	atel nvarchar(50),
	aext nvarchar(50),
	ano nvarchar(200),
	
	t001 float,t002 float,t004 float,
	t005 float,t006 float,t007 float,t008 float,
	t009 float,t010 float,t012 float,
	t013 float,t014 float,t015 float,t016 float,
	t017 float,t018 float,t019 float,t020 float,
	t021 float,t022 float,t023 float,t024 float,
	t052 float,t053 float,
	t054 float,t055 float,
	t084 float,t085 float,
	t056 float,t057 float,
	t058 float,t059 float,
	t060 float,t061 float,t062 float,
	t063 float,t064 float,
	t065 float,t066 float,
	t067 float,t068 float,t069 float,
	t070 float,t071 float,t072 float,
	t025 float,t026 float,t027 float,
	t028 float,t029 float,
	t030 float,t031 float,
	t032 float,t033 float,
	t034 float,t035 float,
	t036 float,t037 float,
	t038 float,t039 float,
	t078 float,t079 float,
	t080 float,t081 float,t082 float,
	t040 float,t041 float,
	t042 float,t043 float,
	t044 float,t045 float,
	t046 float,t047 float,
	t048 float,t049 float,
	t050 float,t051 float,
	t073 float,t074 float,t075 float,t076 float,
	t101 float,t103 float,t104 float,t105 float,t106 float,t107 float,t108 float,t109 float,
	t110 float,t111 float,t112 float,t113 float,t114 float,t115 float,
	s1 float,s2 float,s3 float,s4 float,s5 float,s6 float,s7 float,s8 float,s9 float,s10 float,s11 float
)

insert @tmpa (gno,cno) select '0' gno,cno from @ztax group by cno

update @tmpa
set t073=@t_73,t074=@t_74,t105=@t_105,t108=@t_108,t109=@t_109,t082=@t_82

--,t048=@t_48,t049=@t_49,t013=@t_13,t014=@t_14


----------------------------------------------------------------------------------------------------------

declare @taxrate float=0.05 --徵收率
declare @cno nvarchar(50)
declare @kind nvarchar(50)
declare @rem1 float
declare @money float
declare @taxtype nvarchar(50)
declare @tax float
declare @total float
declare @tax2type nvarchar(50)
declare @passtype nvarchar(50)
declare @isadd bit
declare @business bit --營業人
declare @k36addtype nvarchar(1) --36彙加稅額分類
declare @specialtax nvarchar(50)
declare @dutymemo bit --憑證
declare @k227taxtype nvarchar(1) --22,27已含營業稅分類

declare cursor_table cursor for
select cno,kind,rem1,taxtype,isnull(passtype,'') passtype,isnull(isadd,0) isadd
,case when len(serial)>0 then 1 else 0 end business
,case when kind='36' and isnull(isadd,0)=1 and isnull(tax,0)>0 then '2'
when kind='36' and isnull(isadd,0)=1 and isnull(tax,0)=0 then '1' else '0' end k36addtype
,case when kind='37' or kind='38' then specialtax else '' end specialtax
,case when len(dutymemo)>0 then 1 else 0 end dutymemo
,case when kind='22' and len(dutymemo)>0 and tax=0 then '2'
when kind='22' and len(dutymemo)>0 and tax>0 then '1' else '0' end k22taxtype
,sum(money)money,sum(tax)tax,sum(money+tax)total from @ztax
group by cno,kind,rem1,taxtype,isnull(passtype,''),isnull(isadd,0)
,case when len(serial)>0 then 1 else 0 end
,case when kind='36' and isnull(isadd,0)=1 and isnull(tax,0)>0 then '2'
when kind='36' and isnull(isadd,0)=1 and isnull(tax,0)=0 then '1' else '0' end
,case when kind='37' or kind='38' then specialtax else '' end
,case when len(dutymemo)>0 then 1 else 0 end
,case when kind='22' and len(dutymemo)>0 and tax=0 then '2'
when kind='22' and len(dutymemo)>0 and tax>0 then '1' else '0' end
open cursor_table
fetch next from cursor_table
into @cno,@kind,@rem1,@taxtype,@passtype,@isadd,@business,@k36addtype,@specialtax
,@dutymemo,@k227taxtype,@money,@tax,@total
while(@@FETCH_STATUS <> -1)
begin
	--進項---------------------------------------------------------------------
	if(@kind='21' or @kind='26')
	begin
		if(@rem1='1')--可扣抵之進貨及費用
		begin
			--應稅
			if(@taxtype='1')
			begin
				update @tmpa
				set t028=isnull(t028,0)+@money,t029=isnull(t029,0)+@tax
				where cno=@cno
			end
		end
		if(@rem1='2')--可扣抵之固定資產
		begin
			--應稅
			if(@taxtype='1')
			begin
				update @tmpa
				set t030=isnull(t030,0)+@money,t031=isnull(t031,0)+@tax
				where cno=@cno
			end
		end
		if(@rem1='3')--不可扣抵之進貨及費用
		begin
			if(@taxtype='1' or @taxtype='2' or @taxtype='3')
			begin
				update @tmpa set t048=isnull(t048,0)+@total where cno=@cno
			end
		end
		if(@rem1='4')--不可扣抵之固定資產
		begin
			if(@taxtype='1' or @taxtype='2' or @taxtype='3')
			begin
				update @tmpa set t049=isnull(t049,0)+@total where cno=@cno
			end
		end
	end
	if(@kind='22' or @kind='27')
	begin
		if(@rem1='1')--可扣抵之進貨及費用
		begin
			--應稅
			if(@taxtype='1')
			begin
				if(@dutymemo=0)--二聯式
				begin
					update @tmpa
					set t036=isnull(t036,0)+round(@total/(1+@taxrate),0) --發票總計金額/(1+徵收率)
					,t037=isnull(t037,0)+round(@total*(@taxrate/(1+@taxrate)),0) --發票總計金額*(徵收率/(1+徵收率))
					where cno=@cno
				end
				else --載有稅額之其他憑證
				begin
					if(@k227taxtype='2')--已含稅
					begin
						update @tmpa
						set t036=isnull(t036,0)+round(@total/(1+@taxrate),0) --發票總計金額/(1+徵收率)
						,t037=isnull(t037,0)+round(@total*(@taxrate/(1+@taxrate)),0) --發票總計金額*(徵收率/(1+徵收率))
						where cno=@cno
					end
					if(@k227taxtype='1')--未含稅
					begin
						update @tmpa
						set t036=isnull(t036,0)+@money,t037=isnull(t037,0)+@tax
						where cno=@cno
					end
				end
			end
		end
		if(@rem1='2')--可扣抵之固定資產
		begin
			--應稅
			if(@taxtype='1')
			begin
				if(@dutymemo=0)--二聯式
				begin
					update @tmpa
					set t038=isnull(t038,0)+round(@total/(1+@taxrate),0) --發票總計金額/(1+徵收率)
					,t039=isnull(t039,0)+round(@total*(@taxrate/(1+@taxrate)),0) --發票總計金額*(徵收率/(1+徵收率))
					where cno=@cno
				end
				else --載有稅額之其他憑證
				begin
					if(@k227taxtype='2')--已含稅
					begin
						update @tmpa
						set t038=isnull(t038,0)+round(@total/(1+@taxrate),0) --發票總計金額/(1+徵收率)
						,t039=isnull(t039,0)+round(@total*(@taxrate/(1+@taxrate)),0) --發票總計金額*(徵收率/(1+徵收率))
						where cno=@cno
					end
					if(@k227taxtype='1')--未含稅
					begin
						update @tmpa
						set t038=isnull(t038,0)+@money,t039=isnull(t039,0)+@tax
						where cno=@cno
					end
				end
			end
		end
		if(@rem1='3')--不可扣抵之進貨及費用
		begin
			if(@taxtype='1' or @taxtype='2' or @taxtype='3')
			begin
				update @tmpa set t048=isnull(t048,0)+@total where cno=@cno
			end
		end
		if(@rem1='4')--不可扣抵之固定資產
		begin
			if(@taxtype='1' or @taxtype='2' or @taxtype='3')
			begin
				update @tmpa set t049=isnull(t049,0)+@total where cno=@cno
			end
		end
	end
	if(@kind='23' or @kind='24') 
	--***24載有稅額之其他憑證進貨退出或折讓證明單，其銷售額含營業稅額者，應自行計算***
	begin
		if(@rem1='1')--可扣抵之進貨及費用
		begin
			--應稅
			if(@taxtype='1')
			begin
				update @tmpa
				set t040=isnull(t040,0)+@money,t041=isnull(t041,0)+@tax
				where cno=@cno
			end
		end
		if(@rem1='2')--可扣抵之固定資產
		begin
			--應稅
			if(@taxtype='1')
			begin
				update @tmpa
				set t042=isnull(t042,0)+@money,t043=isnull(t043,0)+@tax
				where cno=@cno
			end
		end
		--當減項
		if(@rem1='3')--不可扣抵之進貨及費用
		begin
			if(@taxtype='1' or @taxtype='2' or @taxtype='3')
			begin
				update @tmpa set t048=isnull(t048,0)-@total where cno=@cno
			end
		end
		--當減項
		if(@rem1='4')--不可扣抵之固定資產
		begin
			if(@taxtype='1' or @taxtype='2' or @taxtype='3')
			begin
				update @tmpa set t049=isnull(t049,0)-@total where cno=@cno
			end
		end
	end
	if(@kind='25')
	begin
		if(@rem1='1')--可扣抵之進貨及費用
		begin
			--應稅
			if(@taxtype='1')
			begin
				update @tmpa
				set t032=isnull(t032,0)+@money,t033=isnull(t033,0)+@tax
				where cno=@cno
			end
		end
		if(@rem1='2')--可扣抵之固定資產
		begin
			--應稅
			if(@taxtype='1')
			begin
				update @tmpa
				set t034=isnull(t034,0)+@money,t035=isnull(t035,0)+@tax
				where cno=@cno
			end
		end
		if(@rem1='3')--不可扣抵之進貨及費用
		begin
			if(@taxtype='1' or @taxtype='2' or @taxtype='3')
			begin
				update @tmpa set t048=isnull(t048,0)+@total where cno=@cno
			end
		end
		if(@rem1='4')--不可扣抵之固定資產
		begin
			if(@taxtype='1' or @taxtype='2' or @taxtype='3')
			begin
				update @tmpa set t049=isnull(t049,0)+@total where cno=@cno
			end
		end
	end
	
	if(@kind='28')
	begin
		if(@rem1='1')--可扣抵之進貨及費用
		begin
			--應稅
			if(@taxtype='1')
			begin
				update @tmpa
				set t078=isnull(t078,0)+@money,t079=isnull(t079,0)+@tax
				where cno=@cno
			end
		end
		if(@rem1='2')--可扣抵之固定資產
		begin
			--應稅
			if(@taxtype='1')
			begin
				update @tmpa
				set t080=isnull(t080,0)+@money,t081=isnull(t081,0)+@tax
				where cno=@cno
			end
		end
		if(@rem1='3')--不可扣抵之進貨及費用
		begin
			if(@taxtype='1' or @taxtype='3')
			begin
				update @tmpa set t048=isnull(t048,0)+@total where cno=@cno
			end
		end
		if(@rem1='4')--不可扣抵之固定資產
		begin
			if(@taxtype='1' or @taxtype='3')
			begin
				update @tmpa set t049=isnull(t049,0)+@total where cno=@cno
			end
		end
	end
	
	if(@kind='29')
	begin
		if(@rem1='1')--可扣抵之進貨及費用
		begin
			--應稅
			if(@taxtype='1')
			begin
				update @tmpa
				set t040=isnull(t040,0)+@money,t041=isnull(t041,0)+@tax
				where cno=@cno
			end
		end
		if(@rem1='2')--可扣抵之固定資產
		begin
			--應稅
			if(@taxtype='1')
			begin
				update @tmpa
				set t042=isnull(t042,0)+@money,t043=isnull(t043,0)+@tax
				where cno=@cno
			end
		end
		--當減項
		if(@rem1='3')--不可扣抵之進貨及費用
		begin
			if(@taxtype='1')
			begin
				update @tmpa set t048=isnull(t048,0)-@total where cno=@cno
			end
		end
		--當減項
		if(@rem1='4')--不可扣抵之固定資產
		begin
			if(@taxtype='1')
			begin
				update @tmpa set t049=isnull(t049,0)-@total where cno=@cno
			end
		end
	end
	--銷項---------------------------------------------------------------------
	if(@kind='31')
	begin
		--應稅
		if(@taxtype='1')
		begin
			--未採彙加
			if(@isadd=0)
			begin
				if(@business=1) --營業人
				begin
					update @tmpa
					set t001=isnull(t001,0)+@money,t002=isnull(t002,0)+@tax
					where cno=@cno
				end
				else --非營業人
				begin
					update @tmpa
					set t001=isnull(t001,0)+round(@total/(1+@taxrate),0) --發票合計金額/(1+徵收率)
					,t002=isnull(t002,0)+(@total-round(@total/(1+@taxrate),0)) --發票合計金額－（發票合計金額/(1+徵收率)）
					where cno=@cno
				end
			end
			--彙加
			if(@isadd=1)
			begin
				update @tmpa
				set t001=isnull(t001,0)+round(@total/(1+@taxrate),0) --發票合計金額/(1+徵收率)
				,t002=isnull(t002,0)+(@total-round(@total/(1+@taxrate),0)) --發票合計金額－（發票合計金額/(1+徵收率)）
				where cno=@cno
			end
		end
		--零稅率
		if(@taxtype='2')
		begin
			--通關方式
			if(@passtype='1')
			begin
				update @tmpa set t007=isnull(t007,0)+@money where cno=@cno
			end
			if(@passtype='2')
			begin
				update @tmpa set t015=isnull(t015,0)+@money where cno=@cno
			end
		end
		--免稅
		if(@taxtype='3')
		begin
			update @tmpa set t004=isnull(t004,0)+@money where cno=@cno
		end
	end
	
	if(@kind='35')
	begin
		--應稅
		if(@taxtype='1')
		begin
			--未採彙加
			if(@isadd=0)
			begin
				if(@business=1) --營業人
				begin
					update @tmpa
					set t005=isnull(t005,0)+@money,t006=isnull(t006,0)+@tax
					where cno=@cno
				end
				else --非營業人
				begin
					update @tmpa
					set t005=isnull(t005,0)+round(@total/(1+@taxrate),0) --發票合計金額/(1+徵收率)
					,t006=isnull(t006,0)+(@total-round(@total/(1+@taxrate),0)) --發票合計金額－（發票合計金額/(1+徵收率)）
					where cno=@cno
				end
			end
			--彙加
			if(@isadd=1)
			begin
				update @tmpa
				set t005=isnull(t005,0)+round(@total/(1+@taxrate),0) --發票合計金額/(1+徵收率)
				,t006=isnull(t006,0)+(@total-round(@total/(1+@taxrate),0)) --發票合計金額－（發票合計金額/(1+徵收率)）
				where cno=@cno
			end
		end
		--零稅率
		if(@taxtype='2')
		begin
			--通關方式
			if(@passtype='1')
			begin
				update @tmpa set t007=isnull(t007,0)+@money where cno=@cno
			end
			if(@passtype='2')
			begin
				update @tmpa set t015=isnull(t015,0)+@money where cno=@cno
			end
		end
		--免稅
		if(@taxtype='3')
		begin
			update @tmpa set t008=isnull(t008,0)+@money where cno=@cno
		end
	end
	
	if(@kind='32')
	begin
		--應稅
		if(@taxtype='1')
		begin
			--未採彙加(營業人、非營業人)、彙加
			update @tmpa
			set t009=isnull(t009,0)+round(@total/(1+@taxrate),0) --發票合計金額/(1+徵收率)
			,t010=isnull(t010,0)+(@total-round(@total/(1+@taxrate),0)) --發票合計金額－（發票合計金額/(1+徵收率)）
			where cno=@cno
		end
		--零稅率
		if(@taxtype='2')
		begin
			--通關方式
			if(@passtype='1')
			begin
				update @tmpa set t007=isnull(t007,0)+@money where cno=@cno
			end
			if(@passtype='2')
			begin
				update @tmpa set t015=isnull(t015,0)+@money where cno=@cno
			end
		end
		--免稅
		if(@taxtype='3')
		begin
			update @tmpa set t012=isnull(t012,0)+@money where cno=@cno
		end
	end
	
	if(@kind='36')
	begin
		--應稅
		if(@taxtype='1')
		begin
			--未採彙加
			if(@isadd=0)
			begin
				if(@business=1) --營業人
				begin
					update @tmpa
					set t013=isnull(t013,0)+@money,t014=isnull(t014,0)+@tax
					where cno=@cno
				end
				else --非營業人
				begin
					update @tmpa
					set t013=isnull(t013,0)+round(@total/(1+@taxrate),0) --憑證合計金額/(1+徵收率)
					,t014=isnull(t014,0)+(@total-round(@total/(1+@taxrate),0)) --憑證合計金額－（憑證合計金額/(1+徵收率)）
					where cno=@cno
				end
			end
			--彙加
			if(@isadd=1)
			begin
				if(@k36addtype='1')--營業稅額為零者
				begin
					update @tmpa
					set t013=isnull(t013,0)+round(@total/(1+@taxrate),0) --憑證合計金額/(1+徵收率)
					,t014=isnull(t014,0)+(@total-round(@total/(1+@taxrate),0)) --憑證合計金額－（憑證合計金額/(1+徵收率)）
					where cno=@cno
				end
				
				if(@k36addtype='2')--營業稅額大於零者
				begin
					update @tmpa
					set t013=isnull(t013,0)+@money,t014=isnull(t014,0)+@tax
					where cno=@cno
				end
			end
		end
		--零稅率
		if(@taxtype='2')
		begin
			--通關方式
			if(@passtype='1')
			begin
				update @tmpa set t007=isnull(t007,0)+@money where cno=@cno
			end
			if(@passtype='2')
			begin
				update @tmpa set t015=isnull(t015,0)+@money where cno=@cno
			end
		end
		--免稅
		if(@taxtype='3')
		begin
			update @tmpa set t016=isnull(t016,0)+@money where cno=@cno
		end
	end
	
	if(@kind='33' or @kind='34')
	begin
		--應稅
		if(@taxtype='1')
		begin
			--營業人、非營業人
			update @tmpa
			set t017=isnull(t017,0)+@money,t018=isnull(t018,0)+@tax
			where cno=@cno
		end
		--零稅率
		if(@taxtype='2')
		begin
			update @tmpa set t019=isnull(t019,0)+@money where cno=@cno
		end
		--免稅
		if(@taxtype='3')
		begin
			update @tmpa set t020=isnull(t020,0)+@money where cno=@cno
		end
	end
	
	if(@kind='37')
	begin
		if(@specialtax='1')
		begin
			update @tmpa set t052=isnull(t052,0)+@money where cno=@cno
			update @tmpa set t053=round(t052*0.25,0) where cno=@cno
		end
		else if(@specialtax='2')
		begin
			update @tmpa set t054=isnull(t054,0)+@money where cno=@cno
			update @tmpa set t055=round(t054*0.15,0) where cno=@cno
		end
		else if(@specialtax='3')
		begin
			update @tmpa set t056=isnull(t056,0)+@money where cno=@cno
			update @tmpa set t057=round(t056*0.02,0) where cno=@cno
		end
		else if(@specialtax='4')
		begin
			update @tmpa set t060=isnull(t060,0)+@money where cno=@cno
			update @tmpa set t061=round(t060*0.01,0) where cno=@cno
		end
		else if(@specialtax='5')
		begin
			update @tmpa set t058=isnull(t058,0)+@money where cno=@cno
			update @tmpa set t059=round(t058*0.05,0) where cno=@cno
		end
		else if(@specialtax='6')
		begin
			update @tmpa set t084=isnull(t084,0)+@money where cno=@cno
			update @tmpa set t085=round(t084*0.05,0) where cno=@cno
		end
		else
		begin
			update @tmpa set t063=isnull(t063,0)+@money where cno=@cno
		end
	end
	
	if(@kind='38')
	begin
		if(@specialtax='1')
		begin
			update @tmpa set t063=isnull(t063,0)+@money where cno=@cno
			update @tmpa set t064=isnull(t064,0)+round(@money*0.25,0) where cno=@cno
		end
		else if(@specialtax='2')
		begin
			update @tmpa set t063=isnull(t063,0)+@money where cno=@cno
			update @tmpa set t064=isnull(t064,0)+round(@money*0.15,0) where cno=@cno
		end
		else if(@specialtax='3' or @specialtax='7')
		begin
			update @tmpa set t063=isnull(t063,0)+@money where cno=@cno
			update @tmpa set t064=isnull(t064,0)+round(@money*0.02,0) where cno=@cno
		end
		else if(@specialtax='4')
		begin
			update @tmpa set t063=isnull(t063,0)+@money where cno=@cno
			update @tmpa set t064=isnull(t064,0)+round(@money*0.01,0) where cno=@cno
		end
		else if(@specialtax='5' or @specialtax='6')
		begin
			update @tmpa set t063=isnull(t063,0)+@money where cno=@cno
			update @tmpa set t064=isnull(t064,0)+round(@money*0.05,0) where cno=@cno
		end
		else
		begin
			update @tmpa set t063=isnull(t063,0)+@money where cno=@cno
		end
	end
	
	fetch next from cursor_table
	into @cno,@kind,@rem1,@taxtype,@passtype,@isadd,@business,@k36addtype,@specialtax
	,@dutymemo,@k227taxtype,@money,@tax,@total
end
close cursor_table
deallocate cursor_table

----------------------------------------------------------------------------------------------------------

update @tmpa
set t001=isnull(t001,0),t002=isnull(t002,0),t004=isnull(t004,0),t005=isnull(t005,0),t006=isnull(t006,0)
,t007=isnull(t007,0),t008=isnull(t008,0),t009=isnull(t009,0),t010=isnull(t010,0),t012=isnull(t012,0)
,t013=isnull(t013,0),t014=isnull(t014,0),t015=isnull(t015,0),t016=isnull(t016,0),t017=isnull(t017,0)
,t018=isnull(t018,0),t019=isnull(t019,0),t020=isnull(t020,0),t021=isnull(t021,0),t022=isnull(t022,0),t023=isnull(t023,0)
,t024=isnull(t024,0),t028=isnull(t028,0)
,t029=isnull(t029,0),t030=isnull(t030,0),t031=isnull(t031,0),t032=isnull(t032,0),t033=isnull(t033,0)
,t034=isnull(t034,0),t035=isnull(t035,0),t036=isnull(t036,0),t037=isnull(t037,0),t038=isnull(t038,0)
,t039=isnull(t039,0),t040=isnull(t040,0),t041=isnull(t041,0),t042=isnull(t042,0),t043=isnull(t043,0)
,t048=isnull(t048,0)
,t049=isnull(t049,0),t052=isnull(t052,0),t053=isnull(t053,0),t054=isnull(t054,0),t055=isnull(t055,0)
,t056=isnull(t056,0),t057=isnull(t057,0),t058=isnull(t058,0),t059=isnull(t059,0),t060=isnull(t060,0)
,t061=isnull(t061,0),t062=isnull(t062,0),t063=isnull(t063,0),t064=isnull(t064,0)
,t067=isnull(t067,0),t068=isnull(t068,0),t069=isnull(t069,0)
,t070=isnull(t070,0),t071=isnull(t071,0),t072=isnull(t072,0)
,t073=isnull(t073,0),t074=isnull(t074,0),t078=isnull(t078,0),t079=isnull(t079,0)
,t080=isnull(t080,0),t081=isnull(t081,0),t082=isnull(t082,0),t084=isnull(t084,0),t085=isnull(t085,0)
,t105=isnull(t105,0),t107=isnull(t107,0),t108=isnull(t108,0),t110=isnull(t110,0),t111=isnull(t111,0)
,t112=isnull(t112,0),t113=isnull(t113,0),t114=isnull(t114,0),t115=isnull(t115,0)

update @tmpa
set t021=t001+t005+t009+t013-t017
,t022=t002+t006+t010+t014-t018
,t023=t007+t015-t019
,t024=t004+t008+t012+t016-t020

,t065=t052+t054+t084+t056+t060+t062-t063
,t066=t053+t055+t085+t057+t061-t064

--土地
,t026=isnull((select SUM(case when kind='33' or kind='34' or kind='38' then -1 else 1 end*money) 
from @ztax where left(kind,1)='3' and notaxnote='1' and (taxtype='1' or taxtype='2' or taxtype='3')),0)
--其他固定資產
,t027=isnull((select SUM(case when kind='33' or kind='34' or kind='38' then -1 else 1 end*money) 
from @ztax where left(kind,1)='3' and notaxnote='2' and (taxtype='1' or taxtype='2' or taxtype='3')),0)

,t044=t028+t032+t036+t078-t040
,t045=t029+t033+t037+t079-t041
,t046=t030+t034+t038+t080-t042
,t047=t031+t035+t039+t081-t043

--銷售額總計
update @tmpa
set t025=t021+t023+t024+t056

--進項總金額(可扣抵+不得扣抵)
update @tmpa
set t048=t044+t048
,t049=t046+t049

--不得扣抵比率
update @tmpa
set t050=floor(((t024+t065-t026)/(t025-t026))*100)

--得扣抵之進項稅額
update @tmpa set t051=round((t045+t047)*(1-(t050/100)),0)

--國外勞務營業稅額 
update @tmpa set t075=round(t074*0.05,0)

--國外勞務營業稅額應納稅額  
update @tmpa set t076=round(t075*(t050/100),0)

--代號
update @tmpa
set t101=t022
,t103=t076
,t104=t066
,t107=case when @t_4013='1' then  t045+t047 else t051 end

--代號6
update @tmpa
set t106=t101+t103+t104+t105

--代號10
update @tmpa set t110=t107+t108+t109

--代號11-13
update @tmpa set 
t111=case when @t_4013='1' then 
	case when t101-t110>=0 then t101-t110 else 0 end else 
	case when t106-t110>=0 then t106-t110 else 0 end end
,t112=case when @t_4013='1' then 
	case when t101-t110>=0 then 0 else t110-t101 end else 
	case when t110-t106>=0 then t110-t106 else 0 end end
,t113=ROUND((case when t023>0 then t023 else 0 end)*0.05+(case when t047>0 then t047 else 0 end),0)

--代號14
update @tmpa set t114=case when(t112>t113) then t113 else t112 end

--代號15
update @tmpa set t115=case when(t112-t114)>0 then t112-t114 else 0 end

--使用發票份數
update @tmpa set s1=(select count(*) from @ztax where left(kind,1)='3' and taxtype!='F' and taxtype!='D' and kind!='33' and kind!='34' and kind!='36' and kind!='38' )

--更新附件數量
update @tmpa
set 
--統一發票明細表 每50張1份
s2=(select count(*) from (select cast(right(noa,8) as int)/50 zcount from @ztax where left(kind,1)='3' and kind!='33' and kind!='34' and kind!='36' and kind!='38' group by cast(right(noa,8) as int)/50 )tmp)

--進項憑證 冊 (可扣抵)
,s3=
--稅額 >500 --進貨及費用
ceiling(isnull((select sum(case when isadd=1 then case when isnull(mount,0)=0 then 1 else mount end else 1 end) from @ztax where left(kind,1)='2' and tax>500 and rem1='1' and (kind!='23' and kind!='24' and kind!='29') and taxtype='1'),0)/100.0)
--稅額 <=500 --進貨及費用
+ceiling(isnull((select sum(case when isadd=1 then case when isnull(mount,0)=0 then 1 else mount end else 1 end) from @ztax where left(kind,1)='2' and tax<=500 and rem1='1' and (kind!='23' and kind!='24' and kind!='29') and taxtype='1'),0)/100.0)
--稅額 >500 固定資產
+ceiling(isnull((select sum(case when isadd=1 then case when isnull(mount,0)=0 then 1 else mount end else 1 end) from @ztax where left(kind,1)='2' and tax>500 and rem1='2' and (kind!='23' and kind!='24' and kind!='29') and taxtype='1'),0)/100.0)
--稅額 <=500 固定資產
+ceiling(isnull((select sum(case when isadd=1 then case when isnull(mount,0)=0 then 1 else mount end else 1 end) from @ztax where left(kind,1)='2' and tax<=500 and rem1='2' and (kind!='23' and kind!='24' and kind!='29') and taxtype='1'),0)/100.0)
--稅額 >500 折讓／退回
+ceiling((select count(*) from @ztax where left(kind,1)='2' and tax>500 and (rem1='1' or rem1='2') and (kind='23' or kind='24' or kind='29'))/100.0)
--稅額 <=500 折讓／退回
+ceiling((select count(*) from @ztax where left(kind,1)='2' and tax<=500 and (rem1='1' or rem1='2') and (kind='23' or kind='24' or kind='29'))/100.0)

--進項憑證 張 (可扣抵)
,s4=
--稅額 >500 --進貨及費用
isnull((select sum(case when isadd=1 then case when isnull(mount,0)=0 then 1 else mount end else 1 end) from @ztax where left(kind,1)='2' and tax>500 and rem1='1' and (kind!='23' and kind!='24' and kind!='29') and taxtype='1'),0)
--稅額 <=500 --進貨及費用
+isnull((select sum(case when isadd=1 then case when isnull(mount,0)=0 then 1 else mount end else 1 end) from @ztax where left(kind,1)='2' and tax<=500 and rem1='1' and (kind!='23' and kind!='24' and kind!='29') and taxtype='1'),0)
--稅額 >500 固定資產
+isnull((select sum(case when isadd=1 then case when isnull(mount,0)=0 then 1 else mount end else 1 end) from @ztax where left(kind,1)='2' and tax>500 and rem1='2' and (kind!='23' and kind!='24' and kind!='29') and taxtype='1'),0)
--稅額 <=500 固定資產
+isnull((select sum(case when isadd=1 then case when isnull(mount,0)=0 then 1 else mount end else 1 end) from @ztax where left(kind,1)='2' and tax<=500 and rem1='2' and (kind!='23' and kind!='24' and kind!='29') and taxtype='1'),0)
--稅額 >500 折讓／退回
+(select count(*) from @ztax where left(kind,1)='2' and tax>500 and (rem1='1' or rem1='2') and (kind='23' or kind='24' or kind='29'))
--稅額 <=500 折讓／退回
+(select count(*) from @ztax where left(kind,1)='2' and tax<=500 and (rem1='1' or rem1='2') and (kind='23' or kind='24' or kind='29'))

--海關代徵營業稅繳納證
,s5=(select count(*) from @ztax where kind='28')

--退回(出)及折讓證明單、海關退還溢繳營業稅申報單
,s6=(select count(*) from @ztax where (kind='23' or kind='24' or kind='29'))

--營業稅繳款書申報聯 (預設1)
,s7=1

--零稅率銷售額清單 1060801格式大約20~25 1頁 +最後一頁附註
,s8=ceiling((select count(*) from tax0 a where mon=@t_xmon)/25.0)+1

--100/07/01 目前客戶沒人使用暫不實作(外籍退稅使用)
--特定營業人辦理外籍旅客現場小額退稅代墊稅款及代為繳納稅款彙總表
,s9=0

--特定營業人辦理外籍旅客現場小額退稅之代墊稅款申報扣減清冊
,s10=0

--特定營業人為外籍旅客代為繳納稅款清冊
,s11=0

--更新公司
update a
set taxport=c.taxport,taxportname=c.taxportname
,years=left(@t_xbmon,3),bmon=right(@t_xbmon,2),emon=right(@t_xemon,2)
,acomp=b.acomp,taxno=c.taxno,serial=b.serial,boss=b.boss,acomp_addr=b.addr_invo
,typea=c.typea,code=c.code,atype=c.applytype,aname=c.applyname,aid=c.applyid
,atel=c.applytel,aarea=c.applyarea,aext=c.applyext,ano=c.applyno
from @tmpa a left join acomp b on a.cno=b.noa left join acompu c on b.noa=c.noa

update a
set t1=t001,t2=t002,t5=t005,t6=t006,t7=t007,t9=t009,t10=t010,t13=t013,t14=t014,t15=t015,t17=t017,t18=t018,t19=t019
,t21=t021,t22=t022,t23=t023,t25=t025,t27=t027,t28=t028,t29=t029,t30=t030,t31=t031,t32=t032,t33=t033,t34=t034
,t35=t035,t36=t036,t37=t037,t38=t038,t39=t039,t40=t040,t41=t041,t42=t042,t43=t043,t44=t044,t45=t045,t46=t046
,t47=t047,t48=t048,t49=t049,t73=t073,t74=t074,t78=t078,t79=t079,t80=t080,t81=t081,t82=t082,t101=b.t101,t107=b.t107
,t108=b.t108,t110=b.t110,t111=b.t111,t112=b.t112,t113=b.t113,t114=b.t114,t115=b.t115
from z401 a 
outer apply (select * from @tmpa where @t_xmon+'__'+cno=a.out_date+'__'+a.cno) b

insert z401 (out_date,cno,single,t1,t2,t5,t6,t7,t9,t10,t13,t14,t15,t17,t18,t19,t21,t22,t23,t25,t27,t28,t29,t30,t31,t32,t33,t34,t35,t36,t37,t38,t39,t40,t41,t42,t43,t44,t45,t46,t47,t48,t49,t73,t74,t78,t79,t80,t81,t82,t101,t107,t108,t110,t111,t112,t113,t114,t115)
select @t_xmon,cno,0,t001,t002,t005,t006,t007,t009,t010,t013,t014,t015,t017,t018,t019,t021,t022,t023,t025,t027,t028,t029,t030,t031,t032,t033,t034,t035,t036,t037,t038,t039,t040,t041,t042,t043,t044,t045,t046,t047,t048,t049,t073,t074,t078,t079,t080,t081,t082,t101,t107,t108,t110,t111,t112,t113,t114,t115
from @tmpa where @t_xmon+'__'+cno not in (select out_date+'__'+cno from z401)
 
select 
dbo.getComma(t001,0) t001,dbo.getComma(t002,0) t002,dbo.getComma(t004,0) t004,dbo.getComma(t005,0) t005
,dbo.getComma(t006,0) t006,dbo.getComma(t007,0) t007,dbo.getComma(t008,0) t008,dbo.getComma(t009,0) t009
,dbo.getComma(t010,0) t010,dbo.getComma(t012,0) t012,dbo.getComma(t013,0) t013,dbo.getComma(t014,0) t014
,dbo.getComma(t015,0) t015,dbo.getComma(t016,0) t016,dbo.getComma(t017,0) t017,dbo.getComma(t018,0) t018
,dbo.getComma(t019,0) t019,dbo.getComma(t020,0) t020,dbo.getComma(t021,0) t021,dbo.getComma(t022,0) t022
,dbo.getComma(t023,0) t023,dbo.getComma(t024,0) t024,dbo.getComma(t025,0) t025,dbo.getComma(t026,0) t026
,dbo.getComma(t027,0) t027,dbo.getComma(t028,0) t028,dbo.getComma(t029,0) t029,dbo.getComma(t030,0) t030
,dbo.getComma(t031,0) t031,dbo.getComma(t032,0) t032,dbo.getComma(t033,0) t033,dbo.getComma(t034,0) t034
,dbo.getComma(t035,0) t035,dbo.getComma(t036,0) t036,dbo.getComma(t037,0) t037,dbo.getComma(t038,0) t038
,dbo.getComma(t039,0) t039,dbo.getComma(t040,0) t040,dbo.getComma(t041,0) t041,dbo.getComma(t042,0) t042
,dbo.getComma(t043,0) t043,dbo.getComma(t044,0) t044,dbo.getComma(t045,0) t045,dbo.getComma(t046,0) t046
,dbo.getComma(t047,0) t047,dbo.getComma(t048,0) t048,dbo.getComma(t049,0) t049,dbo.getComma(t050,0) t050
,dbo.getComma(t051,0) t051,dbo.getComma(t052,0) t052,dbo.getComma(t053,0) t053,dbo.getComma(t054,0) t054
,dbo.getComma(t055,0) t055,dbo.getComma(t056,0) t056,dbo.getComma(t057,0) t057,dbo.getComma(t058,0) t058
,dbo.getComma(t059,0) t059,dbo.getComma(t060,0) t060,dbo.getComma(t061,0) t061,dbo.getComma(t062,0) t062
,dbo.getComma(t063,0) t063,dbo.getComma(t064,0) t064,dbo.getComma(t065,0) t065,dbo.getComma(t066,0) t066
,dbo.getComma(t067,0) t067,dbo.getComma(t068,0) t068,dbo.getComma(t069,0) t069,dbo.getComma(t070,0) t070
,dbo.getComma(t071,0) t071,dbo.getComma(t072,0) t072,dbo.getComma(t073,0) t073,dbo.getComma(t074,0) t074
,dbo.getComma(t075,0) t075,dbo.getComma(t076,0) t076,dbo.getComma(t078,0) t078,dbo.getComma(t079,0) t079
,dbo.getComma(t080,0) t080,dbo.getComma(t081,0) t081,dbo.getComma(t082,0) t082,dbo.getComma(t084,0) t084
,dbo.getComma(t085,0) t085,dbo.getComma(t101,0) t101,dbo.getComma(t103,0) t003,dbo.getComma(t104,0) t104
,dbo.getComma(t105,0) t105,dbo.getComma(t106,0) t106,dbo.getComma(t107,0) t107,dbo.getComma(t108,0) t108
,dbo.getComma(t109,0) t109,dbo.getComma(t110,0) t110,dbo.getComma(t111,0) t111,dbo.getComma(t112,0) t112
,dbo.getComma(t113,0) t113,dbo.getComma(t114,0) t114,dbo.getComma(t115,0) t115
,*,left(@t_xdate,3) y1,right(left(@t_xdate,6),2)m1,right(@t_xdate,2)d1
,case when typea='2' then 'V' else '' end n1
,case when code='1' then 'V' else '' end n2
,case when code='2' then 'V' else '' end n3
,case when atype='1' then aname else '' end a1
,case when atype='1' then aid else '' end a2
,case when atype='1' then (case when isnull(atel,'')='' then '' else aarea+case when isnull(aarea,'')='' then '' else '-' end+atel+(case when isnull(aext,'')='' then '' else '#' end)+aext end) else '' end a3
,case when atype='2' then aname else '' end a4
,case when atype='2' then aid else '' end a5
,case when atype='2' then (case when isnull(atel,'')='' then '' else aarea+case when isnull(aarea,'')='' then '' else '-' end+atel+(case when isnull(aext,'')='' then '' else '#' end)+aext end) else '' end a6
,case when atype='2' then ano else '' end a7
from @tmpa order by cno
;
-----------------------------------------------------------------------------------------------------------------------------------------------
z_403:--z_403 ref.qac.z_401
declare @t_xbmon nvarchar(20)='' --資料月份
declare @t_xemon nvarchar(20)=''
declare @t_xdate nvarchar(20)='' --申報日期
declare @t_48 float=0 --106/08/01 不使用 進貨及費用
declare @t_49 float=0 --106/08/01 不使用 固定資產
declare @t_108 float=0 --上期(月)累積留抵稅額
declare @t_73 float=0 --進口免稅貨物
declare @t_74 float=0 --購買國外勞務
declare @t_82 float=0 --免稅出口免開立統一發票銷售額
declare @t_13 float=0 --106/08/01 不使用 免用發票銷售額
declare @t_14 float=0 --106/08/01 不使用 免用發票稅額

--106/08/01 新增
declare @t_105 float=0 --403用 中途歇業/年底調整 補徵應繳稅額
declare @t_109 float=0 --403用 中途歇業或年底調整應退稅額、 辦理現場小額退稅申報扣減金額
declare @t_4013 nvarchar(20)='3' --401=1 403=3

set @t_xbmon = case when '#non' = [1] then '' else [1] end
set @t_xemon = case when '#non' = [2] then '' else [2] end
set @t_xdate = case when '#non' = [3] then '' else [3] end
set @t_48 = CAST(REPLACE((case when '#non' = [4] then '0' else [4] end),',','') as float)
set @t_49 = CAST(REPLACE((case when '#non' = [5] then '0' else [5] end),',','') as float)
set @t_108 = CAST(REPLACE((case when '#non' = [6] then '0' else [6] end),',','') as float)
set @t_73 = CAST(REPLACE((case when '#non' = [7] then '0' else [7] end),',','') as float)
set @t_74 = CAST(REPLACE((case when '#non' = [8] then '0' else [8] end),',','') as float)
set @t_82 = CAST(REPLACE((case when '#non' = [7] then '0' else [9] end),',','') as float)
set @t_13 = CAST(REPLACE((case when '#non' = [10] then '0' else [10] end),',','') as float)
set @t_14 = CAST(REPLACE((case when '#non' = [11] then '0' else [11] end),',','') as float)
set @t_105 = CAST(REPLACE((case when '#non' = [12] then '0' else [12] end),',','') as float)
set @t_109 = CAST(REPLACE((case when '#non' = [13] then '0' else [13] end),',','') as float)
------------------------------------------------------------------------------------------------
declare @t_xmon nvarchar(20)
set @t_xmon=left(dbo.q_cdn(@t_xemon+'/01',45),6)

if(@t_xdate='')
begin
	set @t_xdate=CONVERT (VARCHAR(7), GETDATE(),12 )+0890000
	set @t_xdate=left(@t_xdate,3)+'/'+substring(@t_xdate,4,2)+'/'+right(@t_xdate,2)
end
--------------------------------------------------------------------------------------------------------------------
--發票內容
declare @ztax table(
	cno nvarchar(100),
	kind nvarchar(100),
	mon nvarchar(10),
	datea nvarchar(10),
	serial nvarchar(20),
	noa nvarchar(20),
	noq nvarchar(20),
	money float,
	taxtype nvarchar(10), --1應稅 2零稅率 3內含 4免稅
	tax float,
	total float,
	rem1 nvarchar(10),-- 扣抵代號
	specialtax nvarchar(10), --特種稅率
	dutymemo nvarchar(100),	--海關繳納證
	passtype nvarchar(100),	--通關方式
	isadd bit, --彙加
	notaxnote nvarchar(10),--銷售註記 1土地 2其他固定資產
	mount float --憑證張數
)
insert @ztax
select cno,kind,mon,datea,serial,noa,noq
,round(money,0),isnull(taxtype,'1'),round(isnull(tax,0),0),ISNULL(total,0)
,(case when typea='2' then ' ' 
when isnull(isasset,0)=0 and isnull(isnondeductible,0)=0 then '1' --可扣抵之進貨及費用
when isnull(isasset,0)=1 and isnull(isnondeductible,0)=0 then '2' --可扣抵之固定資產
when isnull(isasset,0)=0 and isnull(isnondeductible,0)=1 then '3' --不可扣抵之進貨及費用
when isnull(isasset,0)=1 and isnull(isnondeductible,0)=1 then '4' --不可扣抵之固定資產
else ' ' end)
,specialtax,isnull(dutymemo,''),passtype,isadd,notaxnote,mount
from vcct where mon=@t_xmon

--21 23 24 25 營業稅額應等於銷售金額*稅率
--22 27 營業稅額應等於零。
--26 營業稅額為彙加發票上之營業稅額之合計數但每張稅額應不大於伍百元
--28 海關代徵營業稅繳納證內之營業稅額
--29 海關退還溢繳之營業稅額

--31 35 36 售予營業人時：營業稅額應等於銷售金額*徵收率 非營業人時：營業稅額應等於零。
--32 營業稅額應等於零。
--33 34 營業稅額應等於銷售金額*徵收率。
--37 38 營業稅額一律為零

update @ztax set tax=0 where kind='37' or kind='38' or kind='32' or (kind='22' and len(dutymemo)=0) or kind='27'

--變更國稅局稅額 (系統 1應稅 2零稅率 4免稅 5自訂 6作廢 D空白 3 內含(已不使用)
--         對應 國稅局 1應稅 2零稅率 3免稅 1自訂 F作廢 D空白)

--避免早期資料還有內含發票將期轉成應稅(RB 105)
update @ztax set taxtype='1' where taxtype='3' and datea < '106/01/01'
--變更自訂
update @ztax set taxtype='1' where taxtype='5'
--變更免稅
update @ztax set taxtype='3' where taxtype='4'
--變更作廢
update @ztax set taxtype='F' where taxtype='6'

--稅額=0
--4免稅 2零稅率 6作廢 D空白
update @ztax set tax=0 where taxtype!='1' --非1應稅

--避免稅額與內含錯誤(與vfp不同 前端含稅會算完)--20160114 35 稅額空白自動算出
update @ztax 
set money=round(total/(1+0.05),0)
,tax=total-round(total/(1+0.05),0)
where ((kind='33' or kind='34' or kind='21' or kind='23' or kind='24' or kind='25') 
or((kind='31' or kind='35' or kind='36') and len(serial)>0)) --營業人
and tax=0 and total>0
and taxtype='1' --應稅
--------------------------------------------------------------------------
--TET 營業人銷售額與稅額申報書檔
declare @tmpa table(
	gno nvarchar(1),
	taxport nvarchar(90),
	taxportname nvarchar(90),
	cno nvarchar(50),
	years nvarchar(10),
	bmon nvarchar(10),
	emon nvarchar(10),
	acomp nvarchar(100),
	taxno nvarchar(100),
	serial nvarchar(50),
	boss nvarchar(50),
	acomp_addr nvarchar(200),
	typea nvarchar(200),
	code nvarchar(200),
	atype nvarchar(200),
	aname nvarchar(200),
	aid nvarchar(200),
	aarea nvarchar(50),
	atel nvarchar(50),
	aext nvarchar(50),
	ano nvarchar(200),
	
	t001 float,t002 float,t004 float,
	t005 float,t006 float,t007 float,t008 float,
	t009 float,t010 float,t012 float,
	t013 float,t014 float,t015 float,t016 float,
	t017 float,t018 float,t019 float,t020 float,
	t021 float,t022 float,t023 float,t024 float,
	t052 float,t053 float,
	t054 float,t055 float,
	t084 float,t085 float,
	t056 float,t057 float,
	t058 float,t059 float,
	t060 float,t061 float,t062 float,
	t063 float,t064 float,
	t065 float,t066 float,
	t067 float,t068 float,t069 float,
	t070 float,t071 float,t072 float,
	t025 float,t026 float,t027 float,
	t028 float,t029 float,
	t030 float,t031 float,
	t032 float,t033 float,
	t034 float,t035 float,
	t036 float,t037 float,
	t038 float,t039 float,
	t078 float,t079 float,
	t080 float,t081 float,t082 float,
	t040 float,t041 float,
	t042 float,t043 float,
	t044 float,t045 float,
	t046 float,t047 float,
	t048 float,t049 float,
	t050 float,t051 float,
	t073 float,t074 float,t075 float,t076 float,
	t101 float,t103 float,t104 float,t105 float,t106 float,t107 float,t108 float,t109 float,
	t110 float,t111 float,t112 float,t113 float,t114 float,t115 float,
	s1 float,s2 float,s3 float,s4 float,s5 float,s6 float,s7 float,s8 float,s9 float,s10 float,s11 float
)

insert @tmpa (gno,cno) select '0' gno,cno from @ztax group by cno

update @tmpa
set t073=@t_73,t074=@t_74,t105=@t_105,t108=@t_108,t109=@t_109,t082=@t_82

--,t048=@t_48,t049=@t_49,t013=@t_13,t014=@t_14


----------------------------------------------------------------------------------------------------------

declare @taxrate float=0.05 --徵收率
declare @cno nvarchar(50)
declare @kind nvarchar(50)
declare @rem1 float
declare @money float
declare @taxtype nvarchar(50)
declare @tax float
declare @total float
declare @tax2type nvarchar(50)
declare @passtype nvarchar(50)
declare @isadd bit
declare @business bit --營業人
declare @k36addtype nvarchar(1) --36彙加稅額分類
declare @specialtax nvarchar(50)
declare @dutymemo bit --憑證
declare @k227taxtype nvarchar(1) --22,27已含營業稅分類

declare cursor_table cursor for
select cno,kind,rem1,taxtype,isnull(passtype,'') passtype,isnull(isadd,0) isadd
,case when len(serial)>0 then 1 else 0 end business
,case when kind='36' and isnull(isadd,0)=1 and isnull(tax,0)>0 then '2'
when kind='36' and isnull(isadd,0)=1 and isnull(tax,0)=0 then '1' else '0' end k36addtype
,case when kind='37' or kind='38' then specialtax else '' end specialtax
,case when len(dutymemo)>0 then 1 else 0 end dutymemo
,case when kind='22' and len(dutymemo)>0 and tax=0 then '2'
when kind='22' and len(dutymemo)>0 and tax>0 then '1' else '0' end k22taxtype
,sum(money)money,sum(tax)tax,sum(money+tax)total from @ztax
group by cno,kind,rem1,taxtype,isnull(passtype,''),isnull(isadd,0)
,case when len(serial)>0 then 1 else 0 end
,case when kind='36' and isnull(isadd,0)=1 and isnull(tax,0)>0 then '2'
when kind='36' and isnull(isadd,0)=1 and isnull(tax,0)=0 then '1' else '0' end
,case when kind='37' or kind='38' then specialtax else '' end
,case when len(dutymemo)>0 then 1 else 0 end
,case when kind='22' and len(dutymemo)>0 and tax=0 then '2'
when kind='22' and len(dutymemo)>0 and tax>0 then '1' else '0' end
open cursor_table
fetch next from cursor_table
into @cno,@kind,@rem1,@taxtype,@passtype,@isadd,@business,@k36addtype,@specialtax
,@dutymemo,@k227taxtype,@money,@tax,@total
while(@@FETCH_STATUS <> -1)
begin
	--進項---------------------------------------------------------------------
	if(@kind='21' or @kind='26')
	begin
		if(@rem1='1')--可扣抵之進貨及費用
		begin
			--應稅
			if(@taxtype='1')
			begin
				update @tmpa
				set t028=isnull(t028,0)+@money,t029=isnull(t029,0)+@tax
				where cno=@cno
			end
		end
		if(@rem1='2')--可扣抵之固定資產
		begin
			--應稅
			if(@taxtype='1')
			begin
				update @tmpa
				set t030=isnull(t030,0)+@money,t031=isnull(t031,0)+@tax
				where cno=@cno
			end
		end
		if(@rem1='3')--不可扣抵之進貨及費用
		begin
			if(@taxtype='1' or @taxtype='2' or @taxtype='3')
			begin
				update @tmpa set t048=isnull(t048,0)+@total where cno=@cno
			end
		end
		if(@rem1='4')--不可扣抵之固定資產
		begin
			if(@taxtype='1' or @taxtype='2' or @taxtype='3')
			begin
				update @tmpa set t049=isnull(t049,0)+@total where cno=@cno
			end
		end
	end
	if(@kind='22' or @kind='27')
	begin
		if(@rem1='1')--可扣抵之進貨及費用
		begin
			--應稅
			if(@taxtype='1')
			begin
				if(@dutymemo=0)--二聯式
				begin
					update @tmpa
					set t036=isnull(t036,0)+round(@total/(1+@taxrate),0) --發票總計金額/(1+徵收率)
					,t037=isnull(t037,0)+round(@total*(@taxrate/(1+@taxrate)),0) --發票總計金額*(徵收率/(1+徵收率))
					where cno=@cno
				end
				else --載有稅額之其他憑證
				begin
					if(@k227taxtype='2')--已含稅
					begin
						update @tmpa
						set t036=isnull(t036,0)+round(@total/(1+@taxrate),0) --發票總計金額/(1+徵收率)
						,t037=isnull(t037,0)+round(@total*(@taxrate/(1+@taxrate)),0) --發票總計金額*(徵收率/(1+徵收率))
						where cno=@cno
					end
					if(@k227taxtype='1')--未含稅
					begin
						update @tmpa
						set t036=isnull(t036,0)+@money,t037=isnull(t037,0)+@tax
						where cno=@cno
					end
				end
			end
		end
		if(@rem1='2')--可扣抵之固定資產
		begin
			--應稅
			if(@taxtype='1')
			begin
				if(@dutymemo=0)--二聯式
				begin
					update @tmpa
					set t038=isnull(t038,0)+round(@total/(1+@taxrate),0) --發票總計金額/(1+徵收率)
					,t039=isnull(t039,0)+round(@total*(@taxrate/(1+@taxrate)),0) --發票總計金額*(徵收率/(1+徵收率))
					where cno=@cno
				end
				else --載有稅額之其他憑證
				begin
					if(@k227taxtype='2')--已含稅
					begin
						update @tmpa
						set t038=isnull(t038,0)+round(@total/(1+@taxrate),0) --發票總計金額/(1+徵收率)
						,t039=isnull(t039,0)+round(@total*(@taxrate/(1+@taxrate)),0) --發票總計金額*(徵收率/(1+徵收率))
						where cno=@cno
					end
					if(@k227taxtype='1')--未含稅
					begin
						update @tmpa
						set t038=isnull(t038,0)+@money,t039=isnull(t039,0)+@tax
						where cno=@cno
					end
				end
			end
		end
		if(@rem1='3')--不可扣抵之進貨及費用
		begin
			if(@taxtype='1' or @taxtype='2' or @taxtype='3')
			begin
				update @tmpa set t048=isnull(t048,0)+@total where cno=@cno
			end
		end
		if(@rem1='4')--不可扣抵之固定資產
		begin
			if(@taxtype='1' or @taxtype='2' or @taxtype='3')
			begin
				update @tmpa set t049=isnull(t049,0)+@total where cno=@cno
			end
		end
	end
	if(@kind='23' or @kind='24') 
	--***24載有稅額之其他憑證進貨退出或折讓證明單，其銷售額含營業稅額者，應自行計算***
	begin
		if(@rem1='1')--可扣抵之進貨及費用
		begin
			--應稅
			if(@taxtype='1')
			begin
				update @tmpa
				set t040=isnull(t040,0)+@money,t041=isnull(t041,0)+@tax
				where cno=@cno
			end
		end
		if(@rem1='2')--可扣抵之固定資產
		begin
			--應稅
			if(@taxtype='1')
			begin
				update @tmpa
				set t042=isnull(t042,0)+@money,t043=isnull(t043,0)+@tax
				where cno=@cno
			end
		end
		--當減項
		if(@rem1='3')--不可扣抵之進貨及費用
		begin
			if(@taxtype='1' or @taxtype='2' or @taxtype='3')
			begin
				update @tmpa set t048=isnull(t048,0)-@total where cno=@cno
			end
		end
		--當減項
		if(@rem1='4')--不可扣抵之固定資產
		begin
			if(@taxtype='1' or @taxtype='2' or @taxtype='3')
			begin
				update @tmpa set t049=isnull(t049,0)-@total where cno=@cno
			end
		end
	end
	if(@kind='25')
	begin
		if(@rem1='1')--可扣抵之進貨及費用
		begin
			--應稅
			if(@taxtype='1')
			begin
				update @tmpa
				set t032=isnull(t032,0)+@money,t033=isnull(t033,0)+@tax
				where cno=@cno
			end
		end
		if(@rem1='2')--可扣抵之固定資產
		begin
			--應稅
			if(@taxtype='1')
			begin
				update @tmpa
				set t034=isnull(t034,0)+@money,t035=isnull(t035,0)+@tax
				where cno=@cno
			end
		end
		if(@rem1='3')--不可扣抵之進貨及費用
		begin
			if(@taxtype='1' or @taxtype='2' or @taxtype='3')
			begin
				update @tmpa set t048=isnull(t048,0)+@total where cno=@cno
			end
		end
		if(@rem1='4')--不可扣抵之固定資產
		begin
			if(@taxtype='1' or @taxtype='2' or @taxtype='3')
			begin
				update @tmpa set t049=isnull(t049,0)+@total where cno=@cno
			end
		end
	end
	
	if(@kind='28')
	begin
		if(@rem1='1')--可扣抵之進貨及費用
		begin
			--應稅
			if(@taxtype='1')
			begin
				update @tmpa
				set t078=isnull(t078,0)+@money,t079=isnull(t079,0)+@tax
				where cno=@cno
			end
		end
		if(@rem1='2')--可扣抵之固定資產
		begin
			--應稅
			if(@taxtype='1')
			begin
				update @tmpa
				set t080=isnull(t080,0)+@money,t081=isnull(t081,0)+@tax
				where cno=@cno
			end
		end
		if(@rem1='3')--不可扣抵之進貨及費用
		begin
			if(@taxtype='1' or @taxtype='3')
			begin
				update @tmpa set t048=isnull(t048,0)+@total where cno=@cno
			end
		end
		if(@rem1='4')--不可扣抵之固定資產
		begin
			if(@taxtype='1' or @taxtype='3')
			begin
				update @tmpa set t049=isnull(t049,0)+@total where cno=@cno
			end
		end
	end
	
	if(@kind='29')
	begin
		if(@rem1='1')--可扣抵之進貨及費用
		begin
			--應稅
			if(@taxtype='1')
			begin
				update @tmpa
				set t040=isnull(t040,0)+@money,t041=isnull(t041,0)+@tax
				where cno=@cno
			end
		end
		if(@rem1='2')--可扣抵之固定資產
		begin
			--應稅
			if(@taxtype='1')
			begin
				update @tmpa
				set t042=isnull(t042,0)+@money,t043=isnull(t043,0)+@tax
				where cno=@cno
			end
		end
		--當減項
		if(@rem1='3')--不可扣抵之進貨及費用
		begin
			if(@taxtype='1')
			begin
				update @tmpa set t048=isnull(t048,0)-@total where cno=@cno
			end
		end
		--當減項
		if(@rem1='4')--不可扣抵之固定資產
		begin
			if(@taxtype='1')
			begin
				update @tmpa set t049=isnull(t049,0)-@total where cno=@cno
			end
		end
	end
	--銷項---------------------------------------------------------------------
	if(@kind='31')
	begin
		--應稅
		if(@taxtype='1')
		begin
			--未採彙加
			if(@isadd=0)
			begin
				if(@business=1) --營業人
				begin
					update @tmpa
					set t001=isnull(t001,0)+@money,t002=isnull(t002,0)+@tax
					where cno=@cno
				end
				else --非營業人
				begin
					update @tmpa
					set t001=isnull(t001,0)+round(@total/(1+@taxrate),0) --發票合計金額/(1+徵收率)
					,t002=isnull(t002,0)+(@total-round(@total/(1+@taxrate),0)) --發票合計金額－（發票合計金額/(1+徵收率)）
					where cno=@cno
				end
			end
			--彙加
			if(@isadd=1)
			begin
				update @tmpa
				set t001=isnull(t001,0)+round(@total/(1+@taxrate),0) --發票合計金額/(1+徵收率)
				,t002=isnull(t002,0)+(@total-round(@total/(1+@taxrate),0)) --發票合計金額－（發票合計金額/(1+徵收率)）
				where cno=@cno
			end
		end
		--零稅率
		if(@taxtype='2')
		begin
			--通關方式
			if(@passtype='1')
			begin
				update @tmpa set t007=isnull(t007,0)+@money where cno=@cno
			end
			if(@passtype='2')
			begin
				update @tmpa set t015=isnull(t015,0)+@money where cno=@cno
			end
		end
		--免稅
		if(@taxtype='3')
		begin
			update @tmpa set t004=isnull(t004,0)+@money where cno=@cno
		end
	end
	
	if(@kind='35')
	begin
		--應稅
		if(@taxtype='1')
		begin
			--未採彙加
			if(@isadd=0)
			begin
				if(@business=1) --營業人
				begin
					update @tmpa
					set t005=isnull(t005,0)+@money,t006=isnull(t006,0)+@tax
					where cno=@cno
				end
				else --非營業人
				begin
					update @tmpa
					set t005=isnull(t005,0)+round(@total/(1+@taxrate),0) --發票合計金額/(1+徵收率)
					,t006=isnull(t006,0)+(@total-round(@total/(1+@taxrate),0)) --發票合計金額－（發票合計金額/(1+徵收率)）
					where cno=@cno
				end
			end
			--彙加
			if(@isadd=1)
			begin
				update @tmpa
				set t005=isnull(t005,0)+round(@total/(1+@taxrate),0) --發票合計金額/(1+徵收率)
				,t006=isnull(t006,0)+(@total-round(@total/(1+@taxrate),0)) --發票合計金額－（發票合計金額/(1+徵收率)）
				where cno=@cno
			end
		end
		--零稅率
		if(@taxtype='2')
		begin
			--通關方式
			if(@passtype='1')
			begin
				update @tmpa set t007=isnull(t007,0)+@money where cno=@cno
			end
			if(@passtype='2')
			begin
				update @tmpa set t015=isnull(t015,0)+@money where cno=@cno
			end
		end
		--免稅
		if(@taxtype='3')
		begin
			update @tmpa set t008=isnull(t008,0)+@money where cno=@cno
		end
	end
	
	if(@kind='32')
	begin
		--應稅
		if(@taxtype='1')
		begin
			--未採彙加(營業人、非營業人)、彙加
			update @tmpa
			set t009=isnull(t009,0)+round(@total/(1+@taxrate),0) --發票合計金額/(1+徵收率)
			,t010=isnull(t010,0)+(@total-round(@total/(1+@taxrate),0)) --發票合計金額－（發票合計金額/(1+徵收率)）
			where cno=@cno
		end
		--零稅率
		if(@taxtype='2')
		begin
			--通關方式
			if(@passtype='1')
			begin
				update @tmpa set t007=isnull(t007,0)+@money where cno=@cno
			end
			if(@passtype='2')
			begin
				update @tmpa set t015=isnull(t015,0)+@money where cno=@cno
			end
		end
		--免稅
		if(@taxtype='3')
		begin
			update @tmpa set t012=isnull(t012,0)+@money where cno=@cno
		end
	end
	
	if(@kind='36')
	begin
		--應稅
		if(@taxtype='1')
		begin
			--未採彙加
			if(@isadd=0)
			begin
				if(@business=1) --營業人
				begin
					update @tmpa
					set t013=isnull(t013,0)+@money,t014=isnull(t014,0)+@tax
					where cno=@cno
				end
				else --非營業人
				begin
					update @tmpa
					set t013=isnull(t013,0)+round(@total/(1+@taxrate),0) --憑證合計金額/(1+徵收率)
					,t014=isnull(t014,0)+(@total-round(@total/(1+@taxrate),0)) --憑證合計金額－（憑證合計金額/(1+徵收率)）
					where cno=@cno
				end
			end
			--彙加
			if(@isadd=1)
			begin
				if(@k36addtype='1')--營業稅額為零者
				begin
					update @tmpa
					set t013=isnull(t013,0)+round(@total/(1+@taxrate),0) --憑證合計金額/(1+徵收率)
					,t014=isnull(t014,0)+(@total-round(@total/(1+@taxrate),0)) --憑證合計金額－（憑證合計金額/(1+徵收率)）
					where cno=@cno
				end
				
				if(@k36addtype='2')--營業稅額大於零者
				begin
					update @tmpa
					set t013=isnull(t013,0)+@money,t014=isnull(t014,0)+@tax
					where cno=@cno
				end
			end
		end
		--零稅率
		if(@taxtype='2')
		begin
			--通關方式
			if(@passtype='1')
			begin
				update @tmpa set t007=isnull(t007,0)+@money where cno=@cno
			end
			if(@passtype='2')
			begin
				update @tmpa set t015=isnull(t015,0)+@money where cno=@cno
			end
		end
		--免稅
		if(@taxtype='3')
		begin
			update @tmpa set t016=isnull(t016,0)+@money where cno=@cno
		end
	end
	
	if(@kind='33' or @kind='34')
	begin
		--應稅
		if(@taxtype='1')
		begin
			--營業人、非營業人
			update @tmpa
			set t017=isnull(t017,0)+@money,t018=isnull(t018,0)+@tax
			where cno=@cno
		end
		--零稅率
		if(@taxtype='2')
		begin
			update @tmpa set t019=isnull(t019,0)+@money where cno=@cno
		end
		--免稅
		if(@taxtype='3')
		begin
			update @tmpa set t020=isnull(t020,0)+@money where cno=@cno
		end
	end
	
	if(@kind='37')
	begin
		if(@specialtax='1')
		begin
			update @tmpa set t052=isnull(t052,0)+@money where cno=@cno
			update @tmpa set t053=round(t052*0.25,0) where cno=@cno
		end
		else if(@specialtax='2')
		begin
			update @tmpa set t054=isnull(t054,0)+@money where cno=@cno
			update @tmpa set t055=round(t054*0.15,0) where cno=@cno
		end
		else if(@specialtax='3')
		begin
			update @tmpa set t056=isnull(t056,0)+@money where cno=@cno
			update @tmpa set t057=round(t056*0.02,0) where cno=@cno
		end
		else if(@specialtax='4')
		begin
			update @tmpa set t060=isnull(t060,0)+@money where cno=@cno
			update @tmpa set t061=round(t060*0.01,0) where cno=@cno
		end
		else if(@specialtax='5')
		begin
			update @tmpa set t058=isnull(t058,0)+@money where cno=@cno
			update @tmpa set t059=round(t058*0.05,0) where cno=@cno
		end
		else if(@specialtax='6')
		begin
			update @tmpa set t084=isnull(t084,0)+@money where cno=@cno
			update @tmpa set t085=round(t084*0.05,0) where cno=@cno
		end
		else
		begin
			update @tmpa set t063=isnull(t063,0)+@money where cno=@cno
		end
	end
	
	if(@kind='38')
	begin
		if(@specialtax='1')
		begin
			update @tmpa set t063=isnull(t063,0)+@money where cno=@cno
			update @tmpa set t064=isnull(t064,0)+round(@money*0.25,0) where cno=@cno
		end
		else if(@specialtax='2')
		begin
			update @tmpa set t063=isnull(t063,0)+@money where cno=@cno
			update @tmpa set t064=isnull(t064,0)+round(@money*0.15,0) where cno=@cno
		end
		else if(@specialtax='3' or @specialtax='7')
		begin
			update @tmpa set t063=isnull(t063,0)+@money where cno=@cno
			update @tmpa set t064=isnull(t064,0)+round(@money*0.02,0) where cno=@cno
		end
		else if(@specialtax='4')
		begin
			update @tmpa set t063=isnull(t063,0)+@money where cno=@cno
			update @tmpa set t064=isnull(t064,0)+round(@money*0.01,0) where cno=@cno
		end
		else if(@specialtax='5' or @specialtax='6')
		begin
			update @tmpa set t063=isnull(t063,0)+@money where cno=@cno
			update @tmpa set t064=isnull(t064,0)+round(@money*0.05,0) where cno=@cno
		end
		else
		begin
			update @tmpa set t063=isnull(t063,0)+@money where cno=@cno
		end
	end
	
	fetch next from cursor_table
	into @cno,@kind,@rem1,@taxtype,@passtype,@isadd,@business,@k36addtype,@specialtax
	,@dutymemo,@k227taxtype,@money,@tax,@total
end
close cursor_table
deallocate cursor_table

----------------------------------------------------------------------------------------------------------

update @tmpa
set t001=isnull(t001,0),t002=isnull(t002,0),t004=isnull(t004,0),t005=isnull(t005,0),t006=isnull(t006,0)
,t007=isnull(t007,0),t008=isnull(t008,0),t009=isnull(t009,0),t010=isnull(t010,0),t012=isnull(t012,0)
,t013=isnull(t013,0),t014=isnull(t014,0),t015=isnull(t015,0),t016=isnull(t016,0),t017=isnull(t017,0)
,t018=isnull(t018,0),t019=isnull(t019,0),t020=isnull(t020,0),t021=isnull(t021,0),t022=isnull(t022,0),t023=isnull(t023,0)
,t024=isnull(t024,0),t028=isnull(t028,0)
,t029=isnull(t029,0),t030=isnull(t030,0),t031=isnull(t031,0),t032=isnull(t032,0),t033=isnull(t033,0)
,t034=isnull(t034,0),t035=isnull(t035,0),t036=isnull(t036,0),t037=isnull(t037,0),t038=isnull(t038,0)
,t039=isnull(t039,0),t040=isnull(t040,0),t041=isnull(t041,0),t042=isnull(t042,0),t043=isnull(t043,0)
,t048=isnull(t048,0)
,t049=isnull(t049,0),t052=isnull(t052,0),t053=isnull(t053,0),t054=isnull(t054,0),t055=isnull(t055,0)
,t056=isnull(t056,0),t057=isnull(t057,0),t058=isnull(t058,0),t059=isnull(t059,0),t060=isnull(t060,0)
,t061=isnull(t061,0),t062=isnull(t062,0),t063=isnull(t063,0),t064=isnull(t064,0)
,t067=isnull(t067,0),t068=isnull(t068,0),t069=isnull(t069,0)
,t070=isnull(t070,0),t071=isnull(t071,0),t072=isnull(t072,0)
,t073=isnull(t073,0),t074=isnull(t074,0),t078=isnull(t078,0),t079=isnull(t079,0)
,t080=isnull(t080,0),t081=isnull(t081,0),t082=isnull(t082,0),t084=isnull(t084,0),t085=isnull(t085,0)
,t105=isnull(t105,0),t107=isnull(t107,0),t108=isnull(t108,0),t110=isnull(t110,0),t111=isnull(t111,0)
,t112=isnull(t112,0),t113=isnull(t113,0),t114=isnull(t114,0),t115=isnull(t115,0)

update @tmpa
set t021=t001+t005+t009+t013-t017
,t022=t002+t006+t010+t014-t018
,t023=t007+t015-t019
,t024=t004+t008+t012+t016-t020

,t065=t052+t054+t084+t056+t060+t062-t063
,t066=t053+t055+t085+t057+t061-t064

--土地
,t026=isnull((select SUM(case when kind='33' or kind='34' or kind='38' then -1 else 1 end*money) 
from @ztax where left(kind,1)='3' and notaxnote='1' and (taxtype='1' or taxtype='2' or taxtype='3')),0)
--其他固定資產
,t027=isnull((select SUM(case when kind='33' or kind='34' or kind='38' then -1 else 1 end*money) 
from @ztax where left(kind,1)='3' and notaxnote='2' and (taxtype='1' or taxtype='2' or taxtype='3')),0)

,t044=t028+t032+t036+t078-t040
,t045=t029+t033+t037+t079-t041
,t046=t030+t034+t038+t080-t042
,t047=t031+t035+t039+t081-t043

--銷售額總計
update @tmpa
set t025=t021+t023+t024+t056

--進項總金額(可扣抵+不得扣抵)
update @tmpa
set t048=t044+t048
,t049=t046+t049

--不得扣抵比率
update @tmpa
set t050=floor(((t024+t065-t026)/(t025-t026))*100)

--得扣抵之進項稅額
update @tmpa set t051=round((t045+t047)*(1-(t050/100)),0)

--國外勞務營業稅額 
update @tmpa set t075=round(t074*0.05,0)

--國外勞務營業稅額應納稅額  
update @tmpa set t076=round(t075*(t050/100),0)

--代號
update @tmpa
set t101=t022
,t103=t076
,t104=t066
,t107=case when @t_4013='1' then  t045+t047 else t051 end

--代號6
update @tmpa
set t106=t101+t103+t104+t105

--代號10
update @tmpa set t110=t107+t108+t109

--代號11-13
update @tmpa set 
t111=case when @t_4013='1' then 
	case when t101-t110>=0 then t101-t110 else 0 end else 
	case when t106-t110>=0 then t106-t110 else 0 end end
,t112=case when @t_4013='1' then 
	case when t101-t110>=0 then 0 else t110-t101 end else 
	case when t110-t106>=0 then t110-t106 else 0 end end
,t113=ROUND((case when t023>0 then t023 else 0 end)*0.05+(case when t047>0 then t047 else 0 end),0)

--代號14
update @tmpa set t114=case when(t112>t113) then t113 else t112 end

--代號15
update @tmpa set t115=case when(t112-t114)>0 then t112-t114 else 0 end

--使用發票份數
update @tmpa set s1=(select count(*) from @ztax where left(kind,1)='3' and taxtype!='F' and taxtype!='D' and kind!='33' and kind!='34' and kind!='36' and kind!='38' )

--更新附件數量
update @tmpa
set 
--統一發票明細表 每50張1份
s2=(select count(*) from (select cast(right(noa,8) as int)/50 zcount from @ztax where left(kind,1)='3' and kind!='33' and kind!='34' and kind!='36' and kind!='38' group by cast(right(noa,8) as int)/50 )tmp)

--進項憑證 冊 (可扣抵)
,s3=
--稅額 >500 --進貨及費用
ceiling(isnull((select sum(case when isadd=1 then case when isnull(mount,0)=0 then 1 else mount end else 1 end) from @ztax where left(kind,1)='2' and tax>500 and rem1='1' and (kind!='23' and kind!='24' and kind!='29') and taxtype='1'),0)/100.0)
--稅額 <=500 --進貨及費用
+ceiling(isnull((select sum(case when isadd=1 then case when isnull(mount,0)=0 then 1 else mount end else 1 end) from @ztax where left(kind,1)='2' and tax<=500 and rem1='1' and (kind!='23' and kind!='24' and kind!='29') and taxtype='1'),0)/100.0)
--稅額 >500 固定資產
+ceiling(isnull((select sum(case when isadd=1 then case when isnull(mount,0)=0 then 1 else mount end else 1 end) from @ztax where left(kind,1)='2' and tax>500 and rem1='2' and (kind!='23' and kind!='24' and kind!='29') and taxtype='1'),0)/100.0)
--稅額 <=500 固定資產
+ceiling(isnull((select sum(case when isadd=1 then case when isnull(mount,0)=0 then 1 else mount end else 1 end) from @ztax where left(kind,1)='2' and tax<=500 and rem1='2' and (kind!='23' and kind!='24' and kind!='29') and taxtype='1'),0)/100.0)
--稅額 >500 折讓／退回
+ceiling((select count(*) from @ztax where left(kind,1)='2' and tax>500 and (rem1='1' or rem1='2') and (kind='23' or kind='24' or kind='29'))/100.0)
--稅額 <=500 折讓／退回
+ceiling((select count(*) from @ztax where left(kind,1)='2' and tax<=500 and (rem1='1' or rem1='2') and (kind='23' or kind='24' or kind='29'))/100.0)

--進項憑證 張 (可扣抵)
,s4=
--稅額 >500 --進貨及費用
isnull((select sum(case when isadd=1 then case when isnull(mount,0)=0 then 1 else mount end else 1 end) from @ztax where left(kind,1)='2' and tax>500 and rem1='1' and (kind!='23' and kind!='24' and kind!='29') and taxtype='1'),0)
--稅額 <=500 --進貨及費用
+isnull((select sum(case when isadd=1 then case when isnull(mount,0)=0 then 1 else mount end else 1 end) from @ztax where left(kind,1)='2' and tax<=500 and rem1='1' and (kind!='23' and kind!='24' and kind!='29') and taxtype='1'),0)
--稅額 >500 固定資產
+isnull((select sum(case when isadd=1 then case when isnull(mount,0)=0 then 1 else mount end else 1 end) from @ztax where left(kind,1)='2' and tax>500 and rem1='2' and (kind!='23' and kind!='24' and kind!='29') and taxtype='1'),0)
--稅額 <=500 固定資產
+isnull((select sum(case when isadd=1 then case when isnull(mount,0)=0 then 1 else mount end else 1 end) from @ztax where left(kind,1)='2' and tax<=500 and rem1='2' and (kind!='23' and kind!='24' and kind!='29') and taxtype='1'),0)
--稅額 >500 折讓／退回
+(select count(*) from @ztax where left(kind,1)='2' and tax>500 and (rem1='1' or rem1='2') and (kind='23' or kind='24' or kind='29'))
--稅額 <=500 折讓／退回
+(select count(*) from @ztax where left(kind,1)='2' and tax<=500 and (rem1='1' or rem1='2') and (kind='23' or kind='24' or kind='29'))

--海關代徵營業稅繳納證
,s5=(select count(*) from @ztax where kind='28')

--退回(出)及折讓證明單、海關退還溢繳營業稅申報單
,s6=(select count(*) from @ztax where (kind='23' or kind='24' or kind='29'))

--營業稅繳款書申報聯 (預設1)
,s7=1

--零稅率銷售額清單 1060801格式大約20~25 1頁 +最後一頁附註
,s8=ceiling((select count(*) from tax0 a where mon=@t_xmon)/25.0)+1

--100/07/01 目前客戶沒人使用暫不實作(外籍退稅使用)
--特定營業人辦理外籍旅客現場小額退稅代墊稅款及代為繳納稅款彙總表
,s9=0

--特定營業人辦理外籍旅客現場小額退稅之代墊稅款申報扣減清冊
,s10=0

--特定營業人為外籍旅客代為繳納稅款清冊
,s11=0

--更新公司
update a
set taxport=c.taxport,taxportname=c.taxportname
,years=left(@t_xbmon,3),bmon=right(@t_xbmon,2),emon=right(@t_xemon,2)
,acomp=b.acomp,taxno=c.taxno,serial=b.serial,boss=b.boss,acomp_addr=b.addr_invo
,typea=c.typea,code=c.code,atype=c.applytype,aname=c.applyname,aid=c.applyid
,atel=c.applytel,aarea=c.applyarea,aext=c.applyext,ano=c.applyno
from @tmpa a left join acomp b on a.cno=b.noa left join acompu c on b.noa=c.noa

update a
set t1=t001,t2=t002,t5=t005,t6=t006,t7=t007,t9=t009,t10=t010,t13=t013,t14=t014,t15=t015,t17=t017,t18=t018,t19=t019
,t21=t021,t22=t022,t23=t023,t25=t025,t27=t027,t28=t028,t29=t029,t30=t030,t31=t031,t32=t032,t33=t033,t34=t034
,t35=t035,t36=t036,t37=t037,t38=t038,t39=t039,t40=t040,t41=t041,t42=t042,t43=t043,t44=t044,t45=t045,t46=t046
,t47=t047,t48=t048,t49=t049,t73=t073,t74=t074,t78=t078,t79=t079,t80=t080,t81=t081,t82=t082,t101=b.t101,t107=b.t107
,t108=b.t108,t110=b.t110,t111=b.t111,t112=b.t112,t113=b.t113,t114=b.t114,t115=b.t115
from z401 a 
outer apply (select * from @tmpa where @t_xmon+'__'+cno=a.out_date+'__'+a.cno) b

insert z401 (out_date,cno,single,t1,t2,t5,t6,t7,t9,t10,t13,t14,t15,t17,t18,t19,t21,t22,t23,t25,t27,t28,t29,t30,t31,t32,t33,t34,t35,t36,t37,t38,t39,t40,t41,t42,t43,t44,t45,t46,t47,t48,t49,t73,t74,t78,t79,t80,t81,t82,t101,t107,t108,t110,t111,t112,t113,t114,t115)
select @t_xmon,cno,0,t001,t002,t005,t006,t007,t009,t010,t013,t014,t015,t017,t018,t019,t021,t022,t023,t025,t027,t028,t029,t030,t031,t032,t033,t034,t035,t036,t037,t038,t039,t040,t041,t042,t043,t044,t045,t046,t047,t048,t049,t073,t074,t078,t079,t080,t081,t082,t101,t107,t108,t110,t111,t112,t113,t114,t115
from @tmpa where @t_xmon+'__'+cno not in (select out_date+'__'+cno from z401)
 
select 
dbo.getComma(t001,0) t001,dbo.getComma(t002,0) t002,dbo.getComma(t004,0) t004,dbo.getComma(t005,0) t005
,dbo.getComma(t006,0) t006,dbo.getComma(t007,0) t007,dbo.getComma(t008,0) t008,dbo.getComma(t009,0) t009
,dbo.getComma(t010,0) t010,dbo.getComma(t012,0) t012,dbo.getComma(t013,0) t013,dbo.getComma(t014,0) t014
,dbo.getComma(t015,0) t015,dbo.getComma(t016,0) t016,dbo.getComma(t017,0) t017,dbo.getComma(t018,0) t018
,dbo.getComma(t019,0) t019,dbo.getComma(t020,0) t020,dbo.getComma(t021,0) t021,dbo.getComma(t022,0) t022
,dbo.getComma(t023,0) t023,dbo.getComma(t024,0) t024,dbo.getComma(t025,0) t025,dbo.getComma(t026,0) t026
,dbo.getComma(t027,0) t027,dbo.getComma(t028,0) t028,dbo.getComma(t029,0) t029,dbo.getComma(t030,0) t030
,dbo.getComma(t031,0) t031,dbo.getComma(t032,0) t032,dbo.getComma(t033,0) t033,dbo.getComma(t034,0) t034
,dbo.getComma(t035,0) t035,dbo.getComma(t036,0) t036,dbo.getComma(t037,0) t037,dbo.getComma(t038,0) t038
,dbo.getComma(t039,0) t039,dbo.getComma(t040,0) t040,dbo.getComma(t041,0) t041,dbo.getComma(t042,0) t042
,dbo.getComma(t043,0) t043,dbo.getComma(t044,0) t044,dbo.getComma(t045,0) t045,dbo.getComma(t046,0) t046
,dbo.getComma(t047,0) t047,dbo.getComma(t048,0) t048,dbo.getComma(t049,0) t049,dbo.getComma(t050,0) t050
,dbo.getComma(t051,0) t051,dbo.getComma(t052,0) t052,dbo.getComma(t053,0) t053,dbo.getComma(t054,0) t054
,dbo.getComma(t055,0) t055,dbo.getComma(t056,0) t056,dbo.getComma(t057,0) t057,dbo.getComma(t058,0) t058
,dbo.getComma(t059,0) t059,dbo.getComma(t060,0) t060,dbo.getComma(t061,0) t061,dbo.getComma(t062,0) t062
,dbo.getComma(t063,0) t063,dbo.getComma(t064,0) t064,dbo.getComma(t065,0) t065,dbo.getComma(t066,0) t066
,dbo.getComma(t067,0) t067,dbo.getComma(t068,0) t068,dbo.getComma(t069,0) t069,dbo.getComma(t070,0) t070
,dbo.getComma(t071,0) t071,dbo.getComma(t072,0) t072,dbo.getComma(t073,0) t073,dbo.getComma(t074,0) t074
,dbo.getComma(t075,0) t075,dbo.getComma(t076,0) t076,dbo.getComma(t078,0) t078,dbo.getComma(t079,0) t079
,dbo.getComma(t080,0) t080,dbo.getComma(t081,0) t081,dbo.getComma(t082,0) t082,dbo.getComma(t084,0) t084
,dbo.getComma(t085,0) t085,dbo.getComma(t101,0) t101,dbo.getComma(t103,0) t003,dbo.getComma(t104,0) t104
,dbo.getComma(t105,0) t105,dbo.getComma(t106,0) t106,dbo.getComma(t107,0) t107,dbo.getComma(t108,0) t108
,dbo.getComma(t109,0) t109,dbo.getComma(t110,0) t110,dbo.getComma(t111,0) t111,dbo.getComma(t112,0) t112
,dbo.getComma(t113,0) t113,dbo.getComma(t114,0) t114,dbo.getComma(t115,0) t115
,*,left(@t_xdate,3) y1,right(left(@t_xdate,6),2)m1,right(@t_xdate,2)d1
,case when typea='2' then 'V' else '' end n1
,case when code='1' then 'V' else '' end n2
,case when code='2' then 'V' else '' end n3
,case when atype='1' then aname else '' end a1
,case when atype='1' then aid else '' end a2
,case when atype='1' then (case when isnull(atel,'')='' then '' else aarea+case when isnull(aarea,'')='' then '' else '-' end+atel+(case when isnull(aext,'')='' then '' else '#' end)+aext end) else '' end a3
,case when atype='2' then aname else '' end a4
,case when atype='2' then aid else '' end a5
,case when atype='2' then (case when isnull(atel,'')='' then '' else aarea+case when isnull(aarea,'')='' then '' else '-' end+atel+(case when isnull(aext,'')='' then '' else '#' end)+aext end) else '' end a6
,case when atype='2' then ano else '' end a7
from @tmpa order by cno
;
-----------------------------------------------------------------------------------------------------------------------------------------------
media:--產生電子檔
declare @t_xbmon nvarchar(20)='' --資料月份
declare @t_xemon nvarchar(20)=''
declare @t_xdate nvarchar(20)='' --申報日期
declare @t_48 float=0 --106/08/01 不使用 進貨及費用
declare @t_49 float=0 --106/08/01 不使用 固定資產
declare @t_108 float=0 --上期(月)累積留抵稅額
declare @t_73 float=0 --進口免稅貨物
declare @t_74 float=0 --購買國外勞務
declare @t_82 float=0 --免稅出口免開立統一發票銷售額
declare @t_13 float=0 --106/08/01 不使用 免用發票銷售額
declare @t_14 float=0 --106/08/01 不使用 免用發票稅額

--106/08/01 新增
declare @t_105 float=0 --403用 中途歇業/年底調整 補徵應繳稅額
declare @t_109 float=0 --403用 中途歇業或年底調整應退稅額、 辦理現場小額退稅申報扣減金額
declare @t_4013 nvarchar(20)='1' --401=1 403=3

set @t_xbmon = case when '#non' = [1] then '' else [1] end
set @t_xemon = case when '#non' = [2] then '' else [2] end
set @t_xdate = case when '#non' = [3] then '' else [3] end
set @t_48 = CAST(REPLACE((case when '#non' = [4] then '0' else [4] end),',','') as float)
set @t_49 = CAST(REPLACE((case when '#non' = [5] then '0' else [5] end),',','') as float)
set @t_108 = CAST(REPLACE((case when '#non' = [6] then '0' else [6] end),',','') as float)
set @t_73 = CAST(REPLACE((case when '#non' = [7] then '0' else [7] end),',','') as float)
set @t_74 = CAST(REPLACE((case when '#non' = [8] then '0' else [8] end),',','') as float)
set @t_82 = CAST(REPLACE((case when '#non' = [7] then '0' else [9] end),',','') as float)
set @t_13 = CAST(REPLACE((case when '#non' = [10] then '0' else [10] end),',','') as float)
set @t_14 = CAST(REPLACE((case when '#non' = [11] then '0' else [11] end),',','') as float)
set @t_105 = CAST(REPLACE((case when '#non' = [12] then '0' else [12] end),',','') as float)
set @t_109 = CAST(REPLACE((case when '#non' = [13] then '0' else [13] end),',','') as float)
set @t_4013 = case when '#non' = [14] then '1' else [14] end

------------------------------------------------------------------------------------------------
declare @t_xmon nvarchar(20)
set @t_xmon=left(dbo.q_cdn(@t_xemon+'/01',45),6)

if(@t_xdate='')
begin
	set @t_xdate=CONVERT (VARCHAR(7), GETDATE(),12 )+0890000
	set @t_xdate=left(@t_xdate,3)+'/'+substring(@t_xdate,4,2)+'/'+right(@t_xdate,2)
end
-----------------------------------------------------------------------------
--發票內容
declare @ztax table(
	cno nvarchar(100),
	kind nvarchar(100),
	mon nvarchar(10),
	datea nvarchar(10),
	serial nvarchar(20),
	noa nvarchar(20),
	noq nvarchar(20),
	money float,
	taxtype nvarchar(10), --1應稅 2零稅率 3內含 4免稅
	tax float,
	total float,
	rem1 nvarchar(10),-- 扣抵代號
	specialtax nvarchar(10), --特種稅率
	dutymemo nvarchar(100),	--海關繳納證
	passtype nvarchar(100),	--通關方式
	isadd bit, --彙加
	notaxnote nvarchar(10),--銷售註記 1土地 2其他固定資產
	mount float --憑證張數
)
insert @ztax
select cno,kind,mon,datea,serial,noa,noq
,round(money,0),isnull(taxtype,'1'),round(isnull(tax,0),0),ISNULL(total,0)
,(case when typea='2' then ' ' 
when isnull(isasset,0)=0 and isnull(isnondeductible,0)=0 then '1' --可扣抵之進貨及費用
when isnull(isasset,0)=1 and isnull(isnondeductible,0)=0 then '2' --可扣抵之固定資產
when isnull(isasset,0)=0 and isnull(isnondeductible,0)=1 then '3' --不可扣抵之進貨及費用
when isnull(isasset,0)=1 and isnull(isnondeductible,0)=1 then '4' --不可扣抵之固定資產
else ' ' end)
,specialtax,isnull(dutymemo,''),passtype,isadd,notaxnote,mount
from vcct where mon=@t_xmon

--21 23 24 25 營業稅額應等於銷售金額*稅率
--22 27 營業稅額應等於零。
--26 營業稅額為彙加發票上之營業稅額之合計數但每張稅額應不大於伍百元
--28 海關代徵營業稅繳納證內之營業稅額
--29 海關退還溢繳之營業稅額

--31 35 36 售予營業人時：營業稅額應等於銷售金額*徵收率 非營業人時：營業稅額應等於零。
--32 營業稅額應等於零。
--33 34 營業稅額應等於銷售金額*徵收率。
--37 38 營業稅額一律為零

update @ztax set tax=0 where kind='37' or kind='38' or kind='32' or (kind='22' and len(dutymemo)=0) or kind='27'

--變更國稅局稅額 (系統 1應稅 2零稅率 4免稅 5自訂 6作廢 D空白 3 內含(已不使用)
--         對應 國稅局 1應稅 2零稅率 3免稅 1自訂 F作廢 D空白)

--避免早期資料還有內含發票將期轉成應稅(RB 105)
update @ztax set taxtype='1' where taxtype='3' and datea < '106/01/01'
--變更自訂
update @ztax set taxtype='1' where taxtype='5'
--變更免稅
update @ztax set taxtype='3' where taxtype='4'
--變更作廢
update @ztax set taxtype='F' where taxtype='6'

--稅額=0
--4免稅 2零稅率 6作廢 D空白
update @ztax set tax=0 where taxtype!='1' --非1應稅

--避免稅額與內含錯誤(與vfp不同 前端含稅會算完)--20160114 35 稅額空白自動算出
update @ztax 
set money=round(total/(1+0.05),0)
,tax=total-round(total/(1+0.05),0)
where ((kind='33' or kind='34' or kind='21' or kind='23' or kind='24' or kind='25') 
or((kind='31' or kind='35' or kind='36') and len(serial)>0)) --營業人
and tax=0 and total>0
and taxtype='1' --應稅
-----------------------------------------------------------------------------
IF OBJECT_ID('tempdb..##tmp')is not null
BEGIN
   drop table ##tmp
END

create table ##tmp(
	serial nvarchar(20),
	extension nvarchar(20),
	txt nvarchar(2000)
)
-----------------------------------------------------------------------------
--TXT 營業人進銷項資料檔
insert ##tmp
select isnull(b.serial,'00000000'),'TXT',
--格式代號
right('00'+isnull(a.kind,''),2)
--稅籍編號
+right('000000000'+isnull(c.taxno,''),9)
--流水號
+RIGHT('0000000'+cast(ROW_NUMBER() over (order by a.noa) as nvarchar(7)),7)
--資料所屬年度--資料所屬月份
+right('00000'+REPLACE(@t_xemon,'/',''),5)
--欄位共用一
--買受人統一編號--發票訖號
+right('        '+REPLACE(case when d.typea='1' then b.serial else (case when a.taxtype in ('D','F') then '        ' else a.serial end) end,' ',''),8)
--欄位共用二
--空白4--海關代徵營業稅繳納證號碼
+case when a.kind in ('28','29') then	'    '
	+right('              '+isnull(a.dutymemo,''),14)
--彙總張數--空白4--其他憑證號碼或載具流水號
when a.kind in ('26','27') or (a.kind in ('22','25') and isnull(a.isadd,0)=1) then
	right('0000'+replace(dbo.getComma(isnull(a.mount,0),0),',',''),4)
	+'    '	+right('          '+case when (a.kind='27') or (a.kind='22' and isnull(a.dutymemo,'')>0) 
	or (a.kind='25' and isnull(iscarrier,0)=1 and isnull(a.dutymemo,'')>0) then isnull(a.dutymemo,'') else a.noa end,10)
--銷售人統一編號--公用事業載具流水號
when a.kind in ('23','25') and isnull(iscarrier,0)=1 then
	right('        '+REPLACE(case when d.typea='1' then (case when a.taxtype in ('D','F') then '        ' else a.serial end) else b.serial end,' ',''),8)
	+right('          '+right(isnull(a.dutymemo,''),10),10)
--銷售人統一編號--統一發票
else
	right('        '+REPLACE(case when d.typea='1' then (case when a.taxtype in ('D','F') then '        ' else a.serial end) else b.serial end,' ',''),8)--銷售人統一編號
	+right('          '+left(a.noa,10),10)
end
--欄位共用三
--銷售金額/營業稅稅基(28,29)
+right('000000000000'+replace(dbo.getComma(isnull((case when a.taxtype in ('D','F') then 0 when a.kind='22' or (a.kind='31' and len(a.serial)=0) or (a.kind='35' and len(a.serial)=0) then a.money+a.tax else a.money end),0),0),',',''),12)
--課稅別
+ISNULL(a.taxtype,' ')
--營業稅額
+right('0000000000'+replace(dbo.getComma(isnull((case when a.taxtype in ('D','F') then 0 when a.kind='22' or (a.kind='31' and len(a.serial)=0) or (a.kind='35' and len(a.serial)=0) then 0 else a.tax end),0),0),',',''),10)
--扣抵代號
+(case when d.typea='2' then ' ' 
when isnull(isasset,0)=0 and isnull(isnondeductible,0)=0 then '1'
when isnull(isasset,0)=1 and isnull(isnondeductible,0)=0 then '2'
when isnull(isasset,0)=0 and isnull(isnondeductible,0)=1 then '3'
when isnull(isasset,0)=1 and isnull(isnondeductible,0)=1 then '4' else ' ' end)
--空白(5)
+'     '
--特種稅額稅率
+case when a.kind in('37','38') then isnull(a.specialtax,' ') else ' ' end
--彙加註記 分攤 註記
+(case when isnull(a.isadd,0)=1 and a.kind in('22','25','26','27','31','32','35','36') then 'A' 
when isnull(isshare,0)=1 and a.kind='25' then 'B' else ' 'end)
--通關方式註記
+case when d.typea='2' and a.kind!='33'  and a.kind!='34' then ISNULL(a.passtype,' ') else ' ' end
txt
from @ztax a left join acomp b on a.cno=b.noa left join acompu c on a.cno=c.noa 
outer apply (select top 1 * from vcct where noa=a.noa and kind=a.kind and noq=a.noq)d
where a.mon=@t_xmon
-------------------------------------------------------------------------------------------------
--T01 營業人直接扣抵檔(不產生)
-------------------------------------------------------------------------------------------------
--T02 零稅率
insert ##tmp
select isnull(b.serial,'00000000'),'T02',
--銷售人統一編號
right('        '+isnull(b.serial,''),8)
--銷售人縣市別
+left(c.taxport,1)
--銷售人稅籍編號
+right('         '+c.taxno,9)
--資料所屬年月
+right('     '+replace(@t_xemon,'/',''),5)
--開立發票
	+right('     '+replace(left(a.datea,6),'/',''),5)--年月
	+right('          '+a.noa,10)--字軌號碼
--買受人統一編號
+right('        '+replace(isnull(a.serial,''),' ',''),8)
--適用零稅率規定
+RIGHT(' '+a.otype,1)
+(case when isnull(a.paper,'1')='2' then '2' else '1' end)--通關方式註記
--出口報單
	+RIGHT('  '+isnull(a.ptype,''),2)--類別
	+RIGHT('              '+isnull(a.pno,''),14)--號碼
+right('000000000000'+replace(dbo.getComma(isnull(money,0),0),',',''),12)--金額
+right('       '+replace(isnull(edate,''),'/',''),7)--輸出或結匯日期
txt
from tax0 a left join acomp b on a.cno=b.noa left join acompu c on a.cno=c.noa
where mon=@t_xmon

-------------------------------------------------------------------------------------------------
--T03 營業人購買舊乘人小汽車及機車進項憑證明細資料檔(不產生)
-------------------------------------------------------------------------------------------------
--TET 營業人銷售額與稅額申報書檔
declare @tmpa table(
	gno nvarchar(1),
	taxport nvarchar(90),
	taxportname nvarchar(90),
	cno nvarchar(50),
	years nvarchar(10),
	bmon nvarchar(10),
	emon nvarchar(10),
	acomp nvarchar(100),
	taxno nvarchar(100),
	serial nvarchar(50),
	boss nvarchar(50),
	acomp_addr nvarchar(200),
	typea nvarchar(200),
	code nvarchar(200),
	atype nvarchar(200),
	aname nvarchar(200),
	aid nvarchar(200),
	aarea nvarchar(50),
	atel nvarchar(50),
	aext nvarchar(50),
	ano nvarchar(200),
	
	t001 float,t002 float,t004 float,
	t005 float,t006 float,t007 float,t008 float,
	t009 float,t010 float,t012 float,
	t013 float,t014 float,t015 float,t016 float,
	t017 float,t018 float,t019 float,t020 float,
	t021 float,t022 float,t023 float,t024 float,
	t052 float,t053 float,
	t054 float,t055 float,
	t084 float,t085 float,
	t056 float,t057 float,
	t058 float,t059 float,
	t060 float,t061 float,t062 float,
	t063 float,t064 float,
	t065 float,t066 float,
	t067 float,t068 float,t069 float,
	t070 float,t071 float,t072 float,
	t025 float,t026 float,t027 float,
	t028 float,t029 float,
	t030 float,t031 float,
	t032 float,t033 float,
	t034 float,t035 float,
	t036 float,t037 float,
	t038 float,t039 float,
	t078 float,t079 float,
	t080 float,t081 float,t082 float,
	t040 float,t041 float,
	t042 float,t043 float,
	t044 float,t045 float,
	t046 float,t047 float,
	t048 float,t049 float,
	t050 float,t051 float,
	t073 float,t074 float,t075 float,t076 float,
	t101 float,t103 float,t104 float,t105 float,t106 float,t107 float,t108 float,t109 float,
	t110 float,t111 float,t112 float,t113 float,t114 float,t115 float,
	s1 float,s2 float,s3 float,s4 float,s5 float,s6 float,s7 float,s8 float,s9 float,s10 float,s11 float
)

insert @tmpa (gno,cno) select '0' gno,cno from @ztax group by cno

update @tmpa
set t073=@t_73,t074=@t_74,t105=@t_105,t108=@t_108,t109=@t_109,t082=@t_82

--,t048=@t_48,t049=@t_49,t013=@t_13,t014=@t_14

----------------------------------------------------------------------------------------------------------

declare @taxrate float=0.05 --徵收率
declare @cno nvarchar(50)
declare @kind nvarchar(50)
declare @rem1 float
declare @money float
declare @taxtype nvarchar(50)
declare @tax float
declare @total float
declare @tax2type nvarchar(50)
declare @passtype nvarchar(50)
declare @isadd bit
declare @business bit --營業人
declare @k36addtype nvarchar(1) --36彙加稅額分類
declare @specialtax nvarchar(50)
declare @dutymemo bit --憑證
declare @k227taxtype nvarchar(1) --22,27已含營業稅分類

declare cursor_table cursor for
select cno,kind,rem1,taxtype,isnull(passtype,'') passtype,isnull(isadd,0) isadd
,case when len(serial)>0 then 1 else 0 end business
,case when kind='36' and isnull(isadd,0)=1 and isnull(tax,0)>0 then '2'
when kind='36' and isnull(isadd,0)=1 and isnull(tax,0)=0 then '1' else '0' end k36addtype
,case when kind='37' or kind='38' then specialtax else '' end specialtax
,case when len(dutymemo)>0 then 1 else 0 end dutymemo
,case when kind='22' and len(dutymemo)>0 and tax=0 then '2'
when kind='22' and len(dutymemo)>0 and tax>0 then '1' else '0' end k22taxtype
,sum(money)money,sum(tax)tax,sum(money+tax)total from @ztax
group by cno,kind,rem1,taxtype,isnull(passtype,''),isnull(isadd,0)
,case when len(serial)>0 then 1 else 0 end
,case when kind='36' and isnull(isadd,0)=1 and isnull(tax,0)>0 then '2'
when kind='36' and isnull(isadd,0)=1 and isnull(tax,0)=0 then '1' else '0' end
,case when kind='37' or kind='38' then specialtax else '' end
,case when len(dutymemo)>0 then 1 else 0 end
,case when kind='22' and len(dutymemo)>0 and tax=0 then '2'
when kind='22' and len(dutymemo)>0 and tax>0 then '1' else '0' end
open cursor_table
fetch next from cursor_table
into @cno,@kind,@rem1,@taxtype,@passtype,@isadd,@business,@k36addtype,@specialtax
,@dutymemo,@k227taxtype,@money,@tax,@total
while(@@FETCH_STATUS <> -1)
begin
	--進項---------------------------------------------------------------------
	if(@kind='21' or @kind='26')
	begin
		if(@rem1='1')--可扣抵之進貨及費用
		begin
			--應稅
			if(@taxtype='1')
			begin
				update @tmpa
				set t028=isnull(t028,0)+@money,t029=isnull(t029,0)+@tax
				where cno=@cno
			end
		end
		if(@rem1='2')--可扣抵之固定資產
		begin
			--應稅
			if(@taxtype='1')
			begin
				update @tmpa
				set t030=isnull(t030,0)+@money,t031=isnull(t031,0)+@tax
				where cno=@cno
			end
		end
		if(@rem1='3')--不可扣抵之進貨及費用
		begin
			if(@taxtype='1' or @taxtype='2' or @taxtype='3')
			begin
				update @tmpa set t048=isnull(t048,0)+@total where cno=@cno
			end
		end
		if(@rem1='4')--不可扣抵之固定資產
		begin
			if(@taxtype='1' or @taxtype='2' or @taxtype='3')
			begin
				update @tmpa set t049=isnull(t049,0)+@total where cno=@cno
			end
		end
	end
	if(@kind='22' or @kind='27')
	begin
		if(@rem1='1')--可扣抵之進貨及費用
		begin
			--應稅
			if(@taxtype='1')
			begin
				if(@dutymemo=0)--二聯式
				begin
					update @tmpa
					set t036=isnull(t036,0)+round(@total/(1+@taxrate),0) --發票總計金額/(1+徵收率)
					,t037=isnull(t037,0)+round(@total*(@taxrate/(1+@taxrate)),0) --發票總計金額*(徵收率/(1+徵收率))
					where cno=@cno
				end
				else --載有稅額之其他憑證
				begin
					if(@k227taxtype='2')--已含稅
					begin
						update @tmpa
						set t036=isnull(t036,0)+round(@total/(1+@taxrate),0) --發票總計金額/(1+徵收率)
						,t037=isnull(t037,0)+round(@total*(@taxrate/(1+@taxrate)),0) --發票總計金額*(徵收率/(1+徵收率))
						where cno=@cno
					end
					if(@k227taxtype='1')--未含稅
					begin
						update @tmpa
						set t036=isnull(t036,0)+@money,t037=isnull(t037,0)+@tax
						where cno=@cno
					end
				end
			end
		end
		if(@rem1='2')--可扣抵之固定資產
		begin
			--應稅
			if(@taxtype='1')
			begin
				if(@dutymemo=0)--二聯式
				begin
					update @tmpa
					set t038=isnull(t038,0)+round(@total/(1+@taxrate),0) --發票總計金額/(1+徵收率)
					,t039=isnull(t039,0)+round(@total*(@taxrate/(1+@taxrate)),0) --發票總計金額*(徵收率/(1+徵收率))
					where cno=@cno
				end
				else --載有稅額之其他憑證
				begin
					if(@k227taxtype='2')--已含稅
					begin
						update @tmpa
						set t038=isnull(t038,0)+round(@total/(1+@taxrate),0) --發票總計金額/(1+徵收率)
						,t039=isnull(t039,0)+round(@total*(@taxrate/(1+@taxrate)),0) --發票總計金額*(徵收率/(1+徵收率))
						where cno=@cno
					end
					if(@k227taxtype='1')--未含稅
					begin
						update @tmpa
						set t038=isnull(t038,0)+@money,t039=isnull(t039,0)+@tax
						where cno=@cno
					end
				end
			end
		end
		if(@rem1='3')--不可扣抵之進貨及費用
		begin
			if(@taxtype='1' or @taxtype='2' or @taxtype='3')
			begin
				update @tmpa set t048=isnull(t048,0)+@total where cno=@cno
			end
		end
		if(@rem1='4')--不可扣抵之固定資產
		begin
			if(@taxtype='1' or @taxtype='2' or @taxtype='3')
			begin
				update @tmpa set t049=isnull(t049,0)+@total where cno=@cno
			end
		end
	end
	if(@kind='23' or @kind='24') 
	--***24載有稅額之其他憑證進貨退出或折讓證明單，其銷售額含營業稅額者，應自行計算***
	begin
		if(@rem1='1')--可扣抵之進貨及費用
		begin
			--應稅
			if(@taxtype='1')
			begin
				update @tmpa
				set t040=isnull(t040,0)+@money,t041=isnull(t041,0)+@tax
				where cno=@cno
			end
		end
		if(@rem1='2')--可扣抵之固定資產
		begin
			--應稅
			if(@taxtype='1')
			begin
				update @tmpa
				set t042=isnull(t042,0)+@money,t043=isnull(t043,0)+@tax
				where cno=@cno
			end
		end
		--當減項
		if(@rem1='3')--不可扣抵之進貨及費用
		begin
			if(@taxtype='1' or @taxtype='2' or @taxtype='3')
			begin
				update @tmpa set t048=isnull(t048,0)-@total where cno=@cno
			end
		end
		--當減項
		if(@rem1='4')--不可扣抵之固定資產
		begin
			if(@taxtype='1' or @taxtype='2' or @taxtype='3')
			begin
				update @tmpa set t049=isnull(t049,0)-@total where cno=@cno
			end
		end
	end
	if(@kind='25')
	begin
		if(@rem1='1')--可扣抵之進貨及費用
		begin
			--應稅
			if(@taxtype='1')
			begin
				update @tmpa
				set t032=isnull(t032,0)+@money,t033=isnull(t033,0)+@tax
				where cno=@cno
			end
		end
		if(@rem1='2')--可扣抵之固定資產
		begin
			--應稅
			if(@taxtype='1')
			begin
				update @tmpa
				set t034=isnull(t034,0)+@money,t035=isnull(t035,0)+@tax
				where cno=@cno
			end
		end
		if(@rem1='3')--不可扣抵之進貨及費用
		begin
			if(@taxtype='1' or @taxtype='2' or @taxtype='3')
			begin
				update @tmpa set t048=isnull(t048,0)+@total where cno=@cno
			end
		end
		if(@rem1='4')--不可扣抵之固定資產
		begin
			if(@taxtype='1' or @taxtype='2' or @taxtype='3')
			begin
				update @tmpa set t049=isnull(t049,0)+@total where cno=@cno
			end
		end
	end
	
	if(@kind='28')
	begin
		if(@rem1='1')--可扣抵之進貨及費用
		begin
			--應稅
			if(@taxtype='1')
			begin
				update @tmpa
				set t078=isnull(t078,0)+@money,t079=isnull(t079,0)+@tax
				where cno=@cno
			end
		end
		if(@rem1='2')--可扣抵之固定資產
		begin
			--應稅
			if(@taxtype='1')
			begin
				update @tmpa
				set t080=isnull(t080,0)+@money,t081=isnull(t081,0)+@tax
				where cno=@cno
			end
		end
		if(@rem1='3')--不可扣抵之進貨及費用
		begin
			if(@taxtype='1' or @taxtype='3')
			begin
				update @tmpa set t048=isnull(t048,0)+@total where cno=@cno
			end
		end
		if(@rem1='4')--不可扣抵之固定資產
		begin
			if(@taxtype='1' or @taxtype='3')
			begin
				update @tmpa set t049=isnull(t049,0)+@total where cno=@cno
			end
		end
	end
	
	if(@kind='29')
	begin
		if(@rem1='1')--可扣抵之進貨及費用
		begin
			--應稅
			if(@taxtype='1')
			begin
				update @tmpa
				set t040=isnull(t040,0)+@money,t041=isnull(t041,0)+@tax
				where cno=@cno
			end
		end
		if(@rem1='2')--可扣抵之固定資產
		begin
			--應稅
			if(@taxtype='1')
			begin
				update @tmpa
				set t042=isnull(t042,0)+@money,t043=isnull(t043,0)+@tax
				where cno=@cno
			end
		end
		--當減項
		if(@rem1='3')--不可扣抵之進貨及費用
		begin
			if(@taxtype='1')
			begin
				update @tmpa set t048=isnull(t048,0)-@total where cno=@cno
			end
		end
		--當減項
		if(@rem1='4')--不可扣抵之固定資產
		begin
			if(@taxtype='1')
			begin
				update @tmpa set t049=isnull(t049,0)-@total where cno=@cno
			end
		end
	end
	--銷項---------------------------------------------------------------------
	if(@kind='31')
	begin
		--應稅
		if(@taxtype='1')
		begin
			--未採彙加
			if(@isadd=0)
			begin
				if(@business=1) --營業人
				begin
					update @tmpa
					set t001=isnull(t001,0)+@money,t002=isnull(t002,0)+@tax
					where cno=@cno
				end
				else --非營業人
				begin
					update @tmpa
					set t001=isnull(t001,0)+round(@total/(1+@taxrate),0) --發票合計金額/(1+徵收率)
					,t002=isnull(t002,0)+(@total-round(@total/(1+@taxrate),0)) --發票合計金額－（發票合計金額/(1+徵收率)）
					where cno=@cno
				end
			end
			--彙加
			if(@isadd=1)
			begin
				update @tmpa
				set t001=isnull(t001,0)+round(@total/(1+@taxrate),0) --發票合計金額/(1+徵收率)
				,t002=isnull(t002,0)+(@total-round(@total/(1+@taxrate),0)) --發票合計金額－（發票合計金額/(1+徵收率)）
				where cno=@cno
			end
		end
		--零稅率
		if(@taxtype='2')
		begin
			--通關方式
			if(@passtype='1')
			begin
				update @tmpa set t007=isnull(t007,0)+@money where cno=@cno
			end
			if(@passtype='2')
			begin
				update @tmpa set t015=isnull(t015,0)+@money where cno=@cno
			end
		end
		--免稅
		if(@taxtype='3')
		begin
			update @tmpa set t004=isnull(t004,0)+@money where cno=@cno
		end
	end
	
	if(@kind='35')
	begin
		--應稅
		if(@taxtype='1')
		begin
			--未採彙加
			if(@isadd=0)
			begin
				if(@business=1) --營業人
				begin
					update @tmpa
					set t005=isnull(t005,0)+@money,t006=isnull(t006,0)+@tax
					where cno=@cno
				end
				else --非營業人
				begin
					update @tmpa
					set t005=isnull(t005,0)+round(@total/(1+@taxrate),0) --發票合計金額/(1+徵收率)
					,t006=isnull(t006,0)+(@total-round(@total/(1+@taxrate),0)) --發票合計金額－（發票合計金額/(1+徵收率)）
					where cno=@cno
				end
			end
			--彙加
			if(@isadd=1)
			begin
				update @tmpa
				set t005=isnull(t005,0)+round(@total/(1+@taxrate),0) --發票合計金額/(1+徵收率)
				,t006=isnull(t006,0)+(@total-round(@total/(1+@taxrate),0)) --發票合計金額－（發票合計金額/(1+徵收率)）
				where cno=@cno
			end
		end
		--零稅率
		if(@taxtype='2')
		begin
			--通關方式
			if(@passtype='1')
			begin
				update @tmpa set t007=isnull(t007,0)+@money where cno=@cno
			end
			if(@passtype='2')
			begin
				update @tmpa set t015=isnull(t015,0)+@money where cno=@cno
			end
		end
		--免稅
		if(@taxtype='3')
		begin
			update @tmpa set t008=isnull(t008,0)+@money where cno=@cno
		end
	end
	
	if(@kind='32')
	begin
		--應稅
		if(@taxtype='1')
		begin
			--未採彙加(營業人、非營業人)、彙加
			update @tmpa
			set t009=isnull(t009,0)+round(@total/(1+@taxrate),0) --發票合計金額/(1+徵收率)
			,t010=isnull(t010,0)+(@total-round(@total/(1+@taxrate),0)) --發票合計金額－（發票合計金額/(1+徵收率)）
			where cno=@cno
		end
		--零稅率
		if(@taxtype='2')
		begin
			--通關方式
			if(@passtype='1')
			begin
				update @tmpa set t007=isnull(t007,0)+@money where cno=@cno
			end
			if(@passtype='2')
			begin
				update @tmpa set t015=isnull(t015,0)+@money where cno=@cno
			end
		end
		--免稅
		if(@taxtype='3')
		begin
			update @tmpa set t012=isnull(t012,0)+@money where cno=@cno
		end
	end
	
	if(@kind='36')
	begin
		--應稅
		if(@taxtype='1')
		begin
			--未採彙加
			if(@isadd=0)
			begin
				if(@business=1) --營業人
				begin
					update @tmpa
					set t013=isnull(t013,0)+@money,t014=isnull(t014,0)+@tax
					where cno=@cno
				end
				else --非營業人
				begin
					update @tmpa
					set t013=isnull(t013,0)+round(@total/(1+@taxrate),0) --憑證合計金額/(1+徵收率)
					,t014=isnull(t014,0)+(@total-round(@total/(1+@taxrate),0)) --憑證合計金額－（憑證合計金額/(1+徵收率)）
					where cno=@cno
				end
			end
			--彙加
			if(@isadd=1)
			begin
				if(@k36addtype='1')--營業稅額為零者
				begin
					update @tmpa
					set t013=isnull(t013,0)+round(@total/(1+@taxrate),0) --憑證合計金額/(1+徵收率)
					,t014=isnull(t014,0)+(@total-round(@total/(1+@taxrate),0)) --憑證合計金額－（憑證合計金額/(1+徵收率)）
					where cno=@cno
				end
				
				if(@k36addtype='2')--營業稅額大於零者
				begin
					update @tmpa
					set t013=isnull(t013,0)+@money,t014=isnull(t014,0)+@tax
					where cno=@cno
				end
			end
		end
		--零稅率
		if(@taxtype='2')
		begin
			--通關方式
			if(@passtype='1')
			begin
				update @tmpa set t007=isnull(t007,0)+@money where cno=@cno
			end
			if(@passtype='2')
			begin
				update @tmpa set t015=isnull(t015,0)+@money where cno=@cno
			end
		end
		--免稅
		if(@taxtype='3')
		begin
			update @tmpa set t016=isnull(t016,0)+@money where cno=@cno
		end
	end
	
	if(@kind='33' or @kind='34')
	begin
		--應稅
		if(@taxtype='1')
		begin
			--營業人、非營業人
			update @tmpa
			set t017=isnull(t017,0)+@money,t018=isnull(t018,0)+@tax
			where cno=@cno
		end
		--零稅率
		if(@taxtype='2')
		begin
			update @tmpa set t019=isnull(t019,0)+@money where cno=@cno
		end
		--免稅
		if(@taxtype='3')
		begin
			update @tmpa set t020=isnull(t020,0)+@money where cno=@cno
		end
	end
	
	if(@kind='37')
	begin
		if(@specialtax='1')
		begin
			update @tmpa set t052=isnull(t052,0)+@money where cno=@cno
			update @tmpa set t053=round(t052*0.25,0) where cno=@cno
		end
		else if(@specialtax='2')
		begin
			update @tmpa set t054=isnull(t054,0)+@money where cno=@cno
			update @tmpa set t055=round(t054*0.15,0) where cno=@cno
		end
		else if(@specialtax='3')
		begin
			update @tmpa set t056=isnull(t056,0)+@money where cno=@cno
			update @tmpa set t057=round(t056*0.02,0) where cno=@cno
		end
		else if(@specialtax='4')
		begin
			update @tmpa set t060=isnull(t060,0)+@money where cno=@cno
			update @tmpa set t061=round(t060*0.01,0) where cno=@cno
		end
		else if(@specialtax='5')
		begin
			update @tmpa set t058=isnull(t058,0)+@money where cno=@cno
			update @tmpa set t059=round(t058*0.05,0) where cno=@cno
		end
		else if(@specialtax='6')
		begin
			update @tmpa set t084=isnull(t084,0)+@money where cno=@cno
			update @tmpa set t085=round(t084*0.05,0) where cno=@cno
		end
		else
		begin
			update @tmpa set t063=isnull(t063,0)+@money where cno=@cno
		end
	end
	
	if(@kind='38')
	begin
		if(@specialtax='1')
		begin
			update @tmpa set t063=isnull(t063,0)+@money where cno=@cno
			update @tmpa set t064=isnull(t064,0)+round(@money*0.25,0) where cno=@cno
		end
		else if(@specialtax='2')
		begin
			update @tmpa set t063=isnull(t063,0)+@money where cno=@cno
			update @tmpa set t064=isnull(t064,0)+round(@money*0.15,0) where cno=@cno
		end
		else if(@specialtax='3' or @specialtax='7')
		begin
			update @tmpa set t063=isnull(t063,0)+@money where cno=@cno
			update @tmpa set t064=isnull(t064,0)+round(@money*0.02,0) where cno=@cno
		end
		else if(@specialtax='4')
		begin
			update @tmpa set t063=isnull(t063,0)+@money where cno=@cno
			update @tmpa set t064=isnull(t064,0)+round(@money*0.01,0) where cno=@cno
		end
		else if(@specialtax='5' or @specialtax='6')
		begin
			update @tmpa set t063=isnull(t063,0)+@money where cno=@cno
			update @tmpa set t064=isnull(t064,0)+round(@money*0.05,0) where cno=@cno
		end
		else
		begin
			update @tmpa set t063=isnull(t063,0)+@money where cno=@cno
		end
	end
	
	fetch next from cursor_table
	into @cno,@kind,@rem1,@taxtype,@passtype,@isadd,@business,@k36addtype,@specialtax
	,@dutymemo,@k227taxtype,@money,@tax,@total
end
close cursor_table
deallocate cursor_table

----------------------------------------------------------------------------------------------------------

update @tmpa
set t001=isnull(t001,0),t002=isnull(t002,0),t004=isnull(t004,0),t005=isnull(t005,0),t006=isnull(t006,0)
,t007=isnull(t007,0),t008=isnull(t008,0),t009=isnull(t009,0),t010=isnull(t010,0),t012=isnull(t012,0)
,t013=isnull(t013,0),t014=isnull(t014,0),t015=isnull(t015,0),t016=isnull(t016,0),t017=isnull(t017,0)
,t018=isnull(t018,0),t019=isnull(t019,0),t020=isnull(t020,0),t021=isnull(t021,0),t022=isnull(t022,0),t023=isnull(t023,0)
,t024=isnull(t024,0),t028=isnull(t028,0)
,t029=isnull(t029,0),t030=isnull(t030,0),t031=isnull(t031,0),t032=isnull(t032,0),t033=isnull(t033,0)
,t034=isnull(t034,0),t035=isnull(t035,0),t036=isnull(t036,0),t037=isnull(t037,0),t038=isnull(t038,0)
,t039=isnull(t039,0),t040=isnull(t040,0),t041=isnull(t041,0),t042=isnull(t042,0),t043=isnull(t043,0)
,t048=isnull(t048,0)
,t049=isnull(t049,0),t052=isnull(t052,0),t053=isnull(t053,0),t054=isnull(t054,0),t055=isnull(t055,0)
,t056=isnull(t056,0),t057=isnull(t057,0),t058=isnull(t058,0),t059=isnull(t059,0),t060=isnull(t060,0)
,t061=isnull(t061,0),t062=isnull(t062,0),t063=isnull(t063,0),t064=isnull(t064,0)
,t067=isnull(t067,0),t068=isnull(t068,0),t069=isnull(t069,0)
,t070=isnull(t070,0),t071=isnull(t071,0),t072=isnull(t072,0)
,t073=isnull(t073,0),t074=isnull(t074,0),t078=isnull(t078,0),t079=isnull(t079,0)
,t080=isnull(t080,0),t081=isnull(t081,0),t082=isnull(t082,0),t084=isnull(t084,0),t085=isnull(t085,0)
,t105=isnull(t105,0),t107=isnull(t107,0),t108=isnull(t108,0),t110=isnull(t110,0),t111=isnull(t111,0)
,t112=isnull(t112,0),t113=isnull(t113,0),t114=isnull(t114,0),t115=isnull(t115,0)

update @tmpa
set t021=t001+t005+t009+t013-t017
,t022=t002+t006+t010+t014-t018
,t023=t007+t015-t019
,t024=t004+t008+t012+t016-t020

,t065=t052+t054+t084+t056+t060+t062-t063
,t066=t053+t055+t085+t057+t061-t064

--土地
,t026=isnull((select SUM(case when kind='33' or kind='34' or kind='38' then -1 else 1 end*money) 
from @ztax where left(kind,1)='3' and notaxnote='1' and (taxtype='1' or taxtype='2' or taxtype='3')),0)
--其他固定資產
,t027=isnull((select SUM(case when kind='33' or kind='34' or kind='38' then -1 else 1 end*money) 
from @ztax where left(kind,1)='3' and notaxnote='2' and (taxtype='1' or taxtype='2' or taxtype='3')),0)

,t044=t028+t032+t036+t078-t040
,t045=t029+t033+t037+t079-t041
,t046=t030+t034+t038+t080-t042
,t047=t031+t035+t039+t081-t043

--銷售額總計
update @tmpa
set t025=t021+t023+t024+t056

--進項總金額(可扣抵+不得扣抵)
update @tmpa
set t048=t044+t048
,t049=t046+t049

--不得扣抵比率
update @tmpa
set t050=floor(((t024+t065-t026)/(t025-t026))*100)

--得扣抵之進項稅額
update @tmpa set t051=round((t045+t047)*(1-(t050/100)),0)

--國外勞務營業稅額 
update @tmpa set t075=round(t074*0.05,0)

--國外勞務營業稅額應納稅額  
update @tmpa set t076=round(t075*(t050/100),0)

--代號
update @tmpa
set t101=t022
,t103=t076
,t104=t066
,t107=case when @t_4013='1' then  t045+t047 else t051 end

--代號6
update @tmpa
set t106=t101+t103+t104+t105

--代號10
update @tmpa set t110=t107+t108+t109

--代號11-13
update @tmpa set 
t111=case when @t_4013='1' then 
	case when t101-t110>=0 then t101-t110 else 0 end else 
	case when t106-t110>=0 then t106-t110 else 0 end end
,t112=case when @t_4013='1' then 
	case when t101-t110>=0 then 0 else t110-t101 end else 
	case when t110-t106>=0 then t110-t106 else 0 end end
,t113=ROUND((case when t023>0 then t023 else 0 end)*0.05+(case when t047>0 then t047 else 0 end),0)

--代號14
update @tmpa set t114=case when(t112>t113) then t113 else t112 end

--代號15
update @tmpa set t115=case when(t112-t114)>0 then t112-t114 else 0 end

--使用發票份數
update @tmpa set s1=(select count(*) from @ztax where left(kind,1)='3' and taxtype!='F' and taxtype!='D' and kind!='33' and kind!='34' and kind!='36' and kind!='38' )

--更新附件數量
update @tmpa
set 
--統一發票明細表 每50張1份
s2=(select count(*) from (select cast(right(noa,8) as int)/50 zcount from @ztax where left(kind,1)='3' and kind!='33' and kind!='34' and kind!='36' and kind!='38' group by cast(right(noa,8) as int)/50 )tmp)

--進項憑證 冊 (可扣抵)
,s3=
--稅額 >500 --進貨及費用
ceiling(isnull((select sum(case when isadd=1 then case when isnull(mount,0)=0 then 1 else mount end else 1 end) from @ztax where left(kind,1)='2' and tax>500 and rem1='1' and (kind!='23' and kind!='24' and kind!='29') and taxtype='1'),0)/100.0)
--稅額 <=500 --進貨及費用
+ceiling(isnull((select sum(case when isadd=1 then case when isnull(mount,0)=0 then 1 else mount end else 1 end) from @ztax where left(kind,1)='2' and tax<=500 and rem1='1' and (kind!='23' and kind!='24' and kind!='29') and taxtype='1'),0)/100.0)
--稅額 >500 固定資產
+ceiling(isnull((select sum(case when isadd=1 then case when isnull(mount,0)=0 then 1 else mount end else 1 end) from @ztax where left(kind,1)='2' and tax>500 and rem1='2' and (kind!='23' and kind!='24' and kind!='29') and taxtype='1'),0)/100.0)
--稅額 <=500 固定資產
+ceiling(isnull((select sum(case when isadd=1 then case when isnull(mount,0)=0 then 1 else mount end else 1 end) from @ztax where left(kind,1)='2' and tax<=500 and rem1='2' and (kind!='23' and kind!='24' and kind!='29') and taxtype='1'),0)/100.0)
--稅額 >500 折讓／退回
+ceiling((select count(*) from @ztax where left(kind,1)='2' and tax>500 and (rem1='1' or rem1='2') and (kind='23' or kind='24' or kind='29'))/100.0)
--稅額 <=500 折讓／退回
+ceiling((select count(*) from @ztax where left(kind,1)='2' and tax<=500 and (rem1='1' or rem1='2') and (kind='23' or kind='24' or kind='29'))/100.0)

--進項憑證 張 (可扣抵)
,s4=
--稅額 >500 --進貨及費用
isnull((select sum(case when isadd=1 then case when isnull(mount,0)=0 then 1 else mount end else 1 end) from @ztax where left(kind,1)='2' and tax>500 and rem1='1' and (kind!='23' and kind!='24' and kind!='29') and taxtype='1'),0)
--稅額 <=500 --進貨及費用
+isnull((select sum(case when isadd=1 then case when isnull(mount,0)=0 then 1 else mount end else 1 end) from @ztax where left(kind,1)='2' and tax<=500 and rem1='1' and (kind!='23' and kind!='24' and kind!='29') and taxtype='1'),0)
--稅額 >500 固定資產
+isnull((select sum(case when isadd=1 then case when isnull(mount,0)=0 then 1 else mount end else 1 end) from @ztax where left(kind,1)='2' and tax>500 and rem1='2' and (kind!='23' and kind!='24' and kind!='29') and taxtype='1'),0)
--稅額 <=500 固定資產
+isnull((select sum(case when isadd=1 then case when isnull(mount,0)=0 then 1 else mount end else 1 end) from @ztax where left(kind,1)='2' and tax<=500 and rem1='2' and (kind!='23' and kind!='24' and kind!='29') and taxtype='1'),0)
--稅額 >500 折讓／退回
+(select count(*) from @ztax where left(kind,1)='2' and tax>500 and (rem1='1' or rem1='2') and (kind='23' or kind='24' or kind='29'))
--稅額 <=500 折讓／退回
+(select count(*) from @ztax where left(kind,1)='2' and tax<=500 and (rem1='1' or rem1='2') and (kind='23' or kind='24' or kind='29'))

--海關代徵營業稅繳納證
,s5=(select count(*) from @ztax where kind='28')

--退回(出)及折讓證明單、海關退還溢繳營業稅申報單
,s6=(select count(*) from @ztax where (kind='23' or kind='24' or kind='29'))

--營業稅繳款書申報聯 (預設1)
,s7=1

--零稅率銷售額清單 1060801格式大約20~25 1頁 +最後一頁附註
,s8=ceiling((select count(*) from tax0 a where mon=@t_xmon)/25.0)+1

--100/07/01 目前客戶沒人使用暫不實作(外籍退稅使用)
--特定營業人辦理外籍旅客現場小額退稅代墊稅款及代為繳納稅款彙總表
,s9=0

--特定營業人辦理外籍旅客現場小額退稅之代墊稅款申報扣減清冊
,s10=0

--特定營業人為外籍旅客代為繳納稅款清冊
,s11=0

--更新公司
update a
set taxport=c.taxport,taxportname=c.taxportname
,years=left(@t_xbmon,3),bmon=right(@t_xbmon,2),emon=right(@t_xemon,2)
,acomp=b.acomp,taxno=c.taxno,serial=b.serial,boss=b.boss,acomp_addr=b.addr_invo
,typea=c.typea,code=c.code,atype=c.applytype,aname=c.applyname,aid=c.applyid
,atel=c.applytel,aarea=c.applyarea,aext=c.applyext,ano=c.applyno
from @tmpa a left join acomp b on a.cno=b.noa left join acompu c on b.noa=c.noa

insert ##tmp
select isnull(serial,'00000000'),'TET',
--資料別 1-401表 3-403表 4-404表
@t_4013
--空白
+'00'
--檔案編號
+'00000000'
--統一編號
+right('        '+isnull(serial,0),8)
--所屬年月
+replace(@t_xemon,'/','')
--申報代號
+case when code in ('0','2') then '1' else '5' end 
--稅籍編號
+right('         '+taxno,9)
+'00000'--空白
--總繳代號
+right('0'+isnull(code,'0'),1)
--空白
+'000000'
--使用發票份數
+right('0000000000'+replace(dbo.getComma(s1,0),',',''),10)

--一般稅額銷項金額
	--應稅銷售額
	+dbo.StrMinus2(t001,12)--三聯式電子計算機發票
	+dbo.StrMinus2(t005,12)--收銀機發票(三聯式)
	+dbo.StrMinus2(t009,12)--二聯式收銀機(二聯式)發票
	+dbo.StrMinus2(t013,12)--免用發票
	+dbo.StrMinus2(t017,12)--退回及折讓
	+dbo.StrMinus2(t021,12)--合計
	--應稅稅額	
	+dbo.StrMinus2(t002,10)--三聯式電子計算機發票
	+dbo.StrMinus2(t006,10)--收銀機發票(三聯式)
	+dbo.StrMinus2(t010,10)--二聯式收銀機(二聯式)發票
	+dbo.StrMinus2(t014,10)--免用發票
	+dbo.StrMinus2(t018,10)--退回及折讓
	+dbo.StrMinus2(t022,10)--合計
	+dbo.StrMinus2(t082,12)	--免稅出口區內之區內事業、科學工業園區內之園區事業及海關管理之保稅工廠、保稅倉庫或物流中心按進口報關程序銷售貨物至我國境內其他地區之免開立統一發票銷售額
	--零稅率銷售額	
	+dbo.StrMinus2(t007,12)--非經海關出口應附證明文件者
	+'000000000000'--空白(12)
	+dbo.StrMinus2(t015,12)--經海關出口免附證明文件者
	+dbo.StrMinus2(t019,12)--退回及折讓
	+dbo.StrMinus2(t023,12)--合計
	--免稅銷售額
	+dbo.StrMinus2(t004,12)--三聯式電子計算機發票4
	+dbo.StrMinus2(t008,12)--收銀機發票(三聯式)8
	+dbo.StrMinus2(t012,12)--二聯式收銀機(二聯式)發票12
	+dbo.StrMinus2(t016,12)--免用發票16
	+dbo.StrMinus2(t020,12)--退回及折讓20
	+dbo.StrMinus2(t024,12)--合計24
	
--特種稅額-特種飲食
	--25%
	+dbo.StrMinus2(t052,12)--銷售額52
	+dbo.StrMinus2(t053,10)--稅額53
	--15%
	+dbo.StrMinus2(t054,12)--銷售額54
	+dbo.StrMinus2(t055,10)--稅額55
	
--特種稅額-銀行、保險及信託投資業
	--專屬本業收入2%
	+dbo.StrMinus2(t056,12)--銷售額56
	+dbo.StrMinus2(t057,10)--稅額57
	--非專屬本業收入5%
	+dbo.StrMinus2(t058,12)--銷售額58
	+dbo.StrMinus2(t059,10)--稅額59
	
--特種稅額再保收入
	--1%
	+dbo.StrMinus2(t060,12)--銷售額60
	+dbo.StrMinus2(t061,10)--稅額61
	
--特種稅額
	--免稅收入
	+dbo.StrMinus2(t062,12)--銷售額62
	--退回及折讓
	+dbo.StrMinus2(t063,12)--銷售額63
	+dbo.StrMinus2(t064,10)--稅額64
	--合計
	+dbo.StrMinus2(t065,12)--銷售額65
	+dbo.StrMinus2(t066,10)--稅額66
	
--銷售額分析
+dbo.StrMinus2(t025,12)--銷售額總計
+dbo.StrMinus2(t026,12)--土地26
+dbo.StrMinus2(t027,12)--其他固定之資產
	
--應比例計算得扣抵進項金額
	--統一發票扣抵聯(包括電子計算機發票)
	+dbo.StrMinus2(t028,12)--進貨及費用
	+dbo.StrMinus2(t030,12)--固定資產
	--三聯式收銀機發票扣抵聯
	+dbo.StrMinus2(t032,12)--進貨及費用
	+dbo.StrMinus2(t034,12)--固定資產
	--載有稅額之其他憑證(包括二聯式收銀機發票)
	+dbo.StrMinus2(t036,12)--進貨及費用
	+dbo.StrMinus2(t038,12)--固定資產
	--退出及折讓
	+dbo.StrMinus2(t040,12)--進貨及費用
	+dbo.StrMinus2(t042,12)--固定資產
	--合計
	+dbo.StrMinus2(t044,12)--進貨及費用
	+dbo.StrMinus2(t046,12)--固定資產
	
--應比例計算得扣抵進項稅額
	--統一發票扣抵聯(包括電子計算機發票)
	+dbo.StrMinus2(t029,10)--進貨及費用
	+dbo.StrMinus2(t031,10)--固定資產
	--三聯式收銀機發票扣抵聯
	+dbo.StrMinus2(t033,10)--進貨及費用
	+dbo.StrMinus2(t035,10)--固定資產
	--載有稅額之其他憑證(包括二聯式收銀機發票)
	+dbo.StrMinus2(t037,10)--進貨及費用
	+dbo.StrMinus2(t039,10)--固定資產
	--退出及折讓
	+dbo.StrMinus2(t041,10)--進貨及費用
	+dbo.StrMinus2(t043,10)--固定資產
	--合計
	+dbo.StrMinus2(t045,10)--進貨及費用
	+dbo.StrMinus2(t047,10)--固定資產
	--進項總金額(包括不得扣抵憑證及普通收據)
	+dbo.StrMinus2(t048,12)--進貨及費用
	+dbo.StrMinus2(t049,12)--固定資產
	--兼營營業人查填
	+dbo.StrMinus2(t050,3)--不得扣抵比例50
	+dbo.StrMinus2(t051,10)--得扣抵之進項稅額51
	+dbo.StrMinus2(t078,12)--海關代徵營業稅繳納證扣抵聯進貨及費用金額
	+dbo.StrMinus2(t080,12)--海關代徵營業稅繳納證扣抵聯固定資產金額
	+dbo.StrMinus2(t073,12)--進口免稅貨物
	+dbo.StrMinus2(t074,12)--購買國外勞務給付額之購買國外勞務稅額計算 
	+dbo.StrMinus2(t079,10)--海關代徵營業稅繳納證扣抵聯進貨及費用稅額
	+dbo.StrMinus2(t081,10)--海關代徵營業稅繳納證扣抵聯固定資產稅額
	+dbo.StrMinus2(t075,10)--應比例計算進項稅額之購買國外勞務稅額計算75
	+'0000000000'--空白(10)
	+'0000000000'--空白(10)
	+dbo.StrMinus2(t076,10)--應納稅額之購買國外勞務稅額計算76

--稅額計算
+dbo.StrMinus2(t101,10)--本(期)月銷項稅額合計
+'0000000000'--空白
+dbo.StrMinus2(t103,10)--購買國外勞務應納稅額103
+dbo.StrMinus2(t104,10)--特種稅額計算應納稅額104
+dbo.StrMinus2(t105,10)--中途歇業年底調整補徵應繳稅額105
+dbo.StrMinus2(t106,10)--小計(1+3+4+5)106
+dbo.StrMinus2(t107,10)--得扣抵進項稅額合計
+dbo.StrMinus2(t108,10)--上期(月)累積留抵稅額
+dbo.StrMinus2(t109,10)--中途歇業或年底調整應退稅額、辦理現場小額退稅申報扣減金額t109
+dbo.StrMinus2(t110,10)--小計(7+8+9)
+dbo.StrMinus2(t111,10)--本期(月)應實繳稅額(6-10)
+dbo.StrMinus2(t112,10)--本期(月)申報留抵稅額(10-6)
+dbo.StrMinus2(t113,10)--得退稅限額合計
+dbo.StrMinus2(t114,10)--本期(月)應退稅額
+dbo.StrMinus2(t115,10)--本期(月)累積留抵稅額
+REPLICATE('0',23)--空白
+isnull(typea,'1')--申報種類
+'0'--空白
+left(taxport,1)--縣市別
+REPLICATE('0',6)--空白
+isnull(atype,'1')--自行或委託辦理申報註記
+left(isnull(aid,'')+'          ',10)--申報人身分證統一編號
+left(isnull(aname,'')+'            ',12)--申報人姓名
+left(isnull(aarea,'')+'    ',4)--申報人電話區域碼
+left(isnull(atel,'')+'           ',11)--申報人電話
+left(isnull(aext,'')+'     ',5)--申報人電話分機
+left(isnull(ano,'')+'                                                  ',50)--代理申報人登錄（文）字號
--購買國外勞務項目(404)
+dbo.StrMinus2(t067,12)--外國保險業再保費收入給付金額 67
+dbo.StrMinus2(t069,12)--第11 條各業專屬本業勞務給付金額 69
+dbo.StrMinus2(t071,12)--其他給付金額 71
+dbo.StrMinus2(t068,10)--外國保險業再保費收入稅額 68
+dbo.StrMinus2(t070,10)--第11 條各業專屬本業勞務稅額 70
+dbo.StrMinus2(t072,10)--其他稅額 72
--銀行業、保險業經營銀行、保險本業收入5%
+dbo.StrMinus2(t084,12)--銷售額 84
+dbo.StrMinus2(t085,10)--稅額 85
+REPLICATE('0',4) --空白
txt
from @tmpa

--select * from ##tmp

-------------------------------------------------------------------------------------------------
declare @string varchar(500)=''
declare @path varchar(500)=''
declare @serial nvarchar(MAX)=''
declare @extension nvarchar(MAX)=''

select serial from ##tmp group by serial

--電子檔
declare cursor_table cursor for
select serial,extension from ##tmp group by serial,extension
open cursor_table
fetch next from cursor_table
into @serial,@extension
while(@@FETCH_STATUS <> -1)
begin
	--產生檔案
	set @path='C:\inetpub\wwwroot\htm\htm\'+@serial+'.'+@extension
	set @string='bcp "SELECT txt FROM ##tmp a where serial='''+@serial+''' and extension='''+@extension+''' " queryout "C:\inetpub\wwwroot\htm\htm\'+@serial+'.'+@extension+'" -S"localhost,1799" -U"sa" -P"artsql963" -T -c -t'
	
	EXEC master..xp_cmdshell @string
	
	--產生壓縮檔
	set @string='"C:\Program Files\WinRAR\WinRAR.exe" a -ep C:\inetpub\wwwroot\htm\htm\'+@serial+'.rar '+@path
	EXEC master..xp_cmdshell @string
	
	--刪除檔案
	set @string='del '+@path
	EXEC master..xp_cmdshell @string
		
	fetch next from cursor_table
	into @serial,@extension
end
close cursor_table
deallocate cursor_table

IF OBJECT_ID('tempdb..##tmp')is not null
BEGIN
   drop table ##tmp
END
;
