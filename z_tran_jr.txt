z_tran_jr1:--z_tran_jr1
declare @t_bdate nvarchar(20) = case when '#non'=[2] then '' else [2] end
declare @t_edate nvarchar(20) = case when '#non'=[3] then char(255) else [3] end
declare @t_bcustno nvarchar(20) = case when '#non'=[6] then '' else [6] end
declare @t_ecustno nvarchar(20) = case when '#non'=[7] then char(255) else [7] end
declare @t_bcarno nvarchar(20) = case when '#non'=[8] then '' else [8] end
declare @t_ecarno nvarchar(20) = case when '#non'=[9] then char(255) else [9] end
declare @t_baddr nvarchar(20) = case when '#non'=[10] then '' else [10] end 
declare @t_eaddr nvarchar(20) = case when '#non'=[11] then char(255) else [11] end 

declare @tmp table(
	rr int,
	gno nvarchar(1),
	datea nvarchar(10),
	trandate nvarchar(10),
	custno nvarchar(100),
	comp nvarchar(200),
	uccno nvarchar(50),
	weight nvarchar(50),
	weight2 nvarchar(50),
	po nvarchar(100),
	carno nvarchar(50),
	straddrno nvarchar(100),
	straddr nvarchar(100),
	chk1 nvarchar(2),
	memo nvarchar(max),
	cno nvarchar(50),
	acomp nvarchar(max)
)
insert @tmp
select ROW_NUMBER()over(partition by time1,time2,memo2,custno,addrno,chk1 order by productno),'0',time1,time2,custno,cust,productno,sum(weight),sum(uweight),memo2,carno,addrno
,addr,case chk1 when '1' then 'V' else ' ' end chk1,memo,cno,acomp
from view_tranvcces
where (time1 between @t_bdate and @t_edate)
and (custno between @t_bcustno and @t_ecustno)
and (carno between @t_bcarno and @t_ecarno)
and (addrno between @t_baddr and @t_eaddr)
group by time1,time2,custno,cust,productno,memo2,carno,addrno,addr,chk1,memo,cno,acomp

update @tmp
set gno=case when rr=1 then 0 else 1 end

insert @tmp(gno,cno)
select '2',cno
from @tmp
group by cno

select 
dbo.getComma(weight,2) weight
,dbo.getComma(weight2,2) weight2
,* from @tmp
order by cno,gno,datea,trandate,custno,uccno,straddrno
;
------------------------------------------------------------------------------------------------
z_tran_jr2:--z_tran_jr2
declare @t_bdate nvarchar(20) = case when '#non'=[2] then '' else [2] end
declare @t_edate nvarchar(20) = case when '#non'=[3] then char(255) else [3] end
declare @t_bcustno nvarchar(20) = case when '#non'=[6] then '' else [6] end
declare @t_ecustno nvarchar(20) = case when '#non'=[7] then char(255) else [7] end
declare @t_bcarno nvarchar(20) = case when '#non'=[8] then '' else [8] end
declare @t_ecarno nvarchar(20) = case when '#non'=[9] then char(255) else [9] end
declare @t_baddr nvarchar(20) = case when '#non'=[10] then '' else [10] end 
declare @t_eaddr nvarchar(20) = case when '#non'=[11] then char(255) else [11] end 

declare @tmp table(
	gno nvarchar(1),
	rr int,
	straddrno nvarchar(50),
	straddr nvarchar(100),
	trandate nvarchar(10),
	carno nvarchar(50),
	weight nvarchar(50),
	weight2 float,
	price float,
	total float,
	po nvarchar(100),
	uccno nvarchar(50),
	custno nvarchar(100),
	comp nvarchar(200),
	total2 float,
	total3 float,
	cno nvarchar(100),
	acomp nvarchar(100)
)
insert @tmp (gno,rr,straddrno,straddr,trandate,carno,weight,weight2,price,total,po,uccno,custno,comp,cno,acomp)
select '0',ROW_NUMBER()over(partition by straddrno order by b.trandate),straddrno,straddr,b.trandate,b.carno,b.weight,weight2,price,b.total,po,uccno,custno,nick,a.cno,a.acomp
from view_trans b
left join view_tran a on a.noa=b.noa
where (b.trandate between @t_bdate and @t_edate)
and (custno between @t_bcustno and @t_ecustno)
and (b.carno between @t_bcarno and @t_ecarno)
and (straddrno between @t_baddr and @t_eaddr)


insert @tmp(gno,cno,straddrno,weight2,total,total2,total3)
select '1',cno,straddrno,SUM(weight2),SUM(total),SUM(total*0.05),SUM(total+total*0.05)
from @tmp group by straddrno,cno

insert @tmp(gno,cno,straddrno)
select '2',cno,straddrno from @tmp
group by straddrno,cno

select 
straddr+'噸數統計' title
,straddr+'噸數' custwn
,dbo.getComma(weight,2) weight
,dbo.getComma(weight2,2) weight2
,'$'+dbo.getComma(price,0) price
,'$'+dbo.getComma(total,0) total
,'$'+dbo.getComma(total2,0) total2
,'$'+dbo.getComma(total3,0) total3
,* from @tmp
order by cno,straddrno,gno,trandate
;
-------------------------------------------------------------------------------------------------
z_tran_jr3:--z_tran_jr3
declare @t_bdate nvarchar(20) = case when '#non'=[2] then '' else [2] end
declare @t_edate nvarchar(20) = case when '#non'=[3] then char(255) else [3] end
declare @t_bcustno nvarchar(20) = case when '#non'=[6] then '' else [6] end
declare @t_ecustno nvarchar(20) = case when '#non'=[7] then char(255) else [7] end
declare @t_bcarno nvarchar(20) = case when '#non'=[8] then '' else [8] end
declare @t_ecarno nvarchar(20) = case when '#non'=[9] then char(255) else [9] end
declare @t_baddr nvarchar(20) = case when '#non'=[10] then '' else [10] end 
declare @t_eaddr nvarchar(20) = case when '#non'=[11] then char(255) else [11] end 

declare @tmp table(
	rr int,
	gno nvarchar(1),
	vccano nvarchar(50),
	noa nvarchar(20),
	custno nvarchar(100),
	comp nvarchar(100),
	datea nvarchar(10),
	uccno nvarchar(50),
	weight float,
	price float,
	money float,
	carno nvarchar(50),
	po nvarchar(50),
	straddrno nvarchar(50),
	straddr nvarchar(50),
	qhref nvarchar(max),
	tax float,--5%稅
	total float,--請款金額
	cno nvarchar(50),
	acomp nvarchar(50)
)
--tran
insert @tmp
select '1','0',isnull(departure,''),a.noa,custno,c.nick,b.trandate,uccno,b.weight,price,b.total,b.carno,po,b.straddrno,b.saddr,'tran_jr?noa=$noa?'+a.accy,0,0,b.cno,b.acomp
from view_tran a left join view_trans b on a.noa=b.noa
left join cust c on b.custno=c.noa
where (a.datea between @t_bdate and @t_edate)
and (custno between @t_bcustno and @t_ecustno)

--custchg(聯單加項)
insert @tmp
select '2','0',a.vccano,b.noa,a.custno,a.comp,b.datea,plusitem,1,plusmoney,plusmoney,a.carno,a.po,a.straddrno,a.straddr,'custchg?noa=$noa?',0,0,b.cno,b.acomp
from @tmp a left join custchg b on a.po=b.po
where len(isnull(b.po,''))!=0 and len(b.plusitem)!=0

--custchg(聯單減項)
insert @tmp
select '3','0',a.vccano,b.noa,a.custno,a.comp,b.datea,minusitem,1,minusmoney,minusmoney,a.carno,a.po,a.straddrno,a.straddr,'custchg?noa=$noa?',0,0,b.cno,b.acomp
from @tmp a left join custchg b on a.po=b.po
where len(isnull(b.po,''))!=0 and len(b.minusitem)!=0
and a.rr='1'

update a
set rr=rx
from(select ROW_NUMBER()over(partition by vccano,custno,noa order by datea)rx,rr from @tmp)a

insert @tmp(gno,rr,vccano,datea,custno,money,tax,total,cno)
select '1',9997,vccano,CHAR(255),custno,SUM(money),SUM(money)*0.05,SUM(money)*0.05+SUM(money),cno
from @tmp
group by vccano,custno,cno,acomp

insert @tmp(gno,rr,datea,vccano,custno,cno)
select '2',9998,CHAR(255),vccano,custno,cno
from @tmp
group by vccano,custno,cno

select 
@t_bdate+' ~ '+@t_edate date
,case when rr!=1 then '' else noa end noa
,dbo.getComma(weight,2)weight
,dbo.getComma(price,-1)price
,dbo.getComma(money,-1)money
,dbo.getComma(tax,2)tax
,dbo.getComma(total,0)total
,* from @tmp a
order by cno,custno,vccano,datea,rr
;
-----------------------------------------------------------------------------------------------------
z_tran_jr4:--z_tran_jr4
declare @t_bdate nvarchar(20) = case when '#non'=[2] then '' else [2] end
declare @t_edate nvarchar(20) = case when '#non'=[3] then char(255) else [3] end
declare @t_bcustno nvarchar(20) = case when '#non'=[6] then '' else [6] end
declare @t_ecustno nvarchar(20) = case when '#non'=[7] then char(255) else [7] end

declare @tmp table(
	gno varchar(1),
	cno nvarchar(50),
	vccadate nvarchar(10),
	vccano nvarchar(50),
	noa nvarchar(50),
	custno nvarchar(50),
	trandate nvarchar(10),
	straddrno nvarchar(50),
	straddr nvarchar(100),
	uccno nvarchar(50),
	product nvarchar(100),
	weight float,
	po nvarchar(50),
	price float,
	total float,
	worker nvarchar(50)
)
--明細
insert @tmp 
select '9',isnull(a.cno,''),a.datea,isnull(a.departure,''),a.noa,isnull(a.addrno,''),b.trandate,b.straddrno,b.straddr,b.uccno,b.product,b.weight2,b.po,b.price,b.total,a.worker
from view_tran a left join view_trans b on a.noa=b.noa
where (a.datea between @t_bdate and @t_edate)
and (a.addrno between @t_bcustno and @t_ecustno)

--加項
insert @tmp(gno,cno,vccano,noa,custno,straddrno,straddr,trandate,uccno,product,po,total)
select '8',b.cno,a.vccano,a.noa,b.custno,straddrno,straddr,char(255),b.plusitemno,b.plusitem,b.po,b.plusmoney
from @tmp a left join custchg b on a.po=b.po
where len(a.po)!=0 and b.plusmoney!=0
group by a.vccano,a.noa,b.custno,a.straddrno,a.straddr,b.plusitemno,b.plusitem,b.po,b.plusmoney,b.cno

--減項
insert @tmp(gno,cno,vccano,noa,custno,straddrno,straddr,trandate,uccno,product,po,total)
select '8',b.cno,a.vccano,a.noa,b.custno,straddrno,straddr,char(255),b.minusitemno,b.minusitem,b.po,b.minusmoney
from @tmp a left join custchg b on a.po=b.po
where len(a.po)!=0 and b.minusmoney!=0
group by a.vccano,a.noa,b.custno,a.straddrno,a.straddr,b.minusitemno,b.minusitem,b.po,b.minusmoney,b.cno

declare @result table(
	gno varchar(1),
	rr int,
	page int,
	cno nvarchar(50),
	acomp nvarchar(100),
	vccadate nvarchar(10),
	vccano nvarchar(50),
	noa nvarchar(50),
	worker nvarchar(50),
	tel nvarchar(50),
	fax nvarchar(50),
	custno nvarchar(50),
	comp nvarchar(50),
	serial nvarchar(50),
	ctel nvarchar(50),--客戶電話
	cfax nvarchar(50),--客戶傳真
	addr nvarchar(max),--客戶地址
	trandate nvarchar(10),
	straddrno nvarchar(50),
	straddr nvarchar(100),
	uccno nvarchar(50),
	product nvarchar(100),
	weight float,
	po nvarchar(50),
	price float,
	total float,
	tax float,
	money float
)
insert @result(gno,cno,vccadate,vccano,noa,worker,custno,trandate,straddrno,straddr,uccno,product,weight,po,price,total)
select '1',cno,vccadate,vccano,noa,worker,custno,trandate,straddrno,straddr,uccno,product,sum(weight),po,price,sum(total)
from @tmp
where gno='9'
group by cno,vccadate,vccano,noa,worker,custno,trandate,straddrno,straddr,uccno,product,po,price

insert @result(gno,cno,vccano,noa,custno,trandate,straddrno,straddr,uccno,product,weight,po,price,total)
select '2',cno,vccano,noa,custno,trandate,straddrno,straddr,uccno,product,weight,po,price,total
from @tmp
where gno='8'

update a
set rr=rx
from (select ROW_NUMBER()over(partition by vccano,noa order by noa,trandate,straddrno)rx,rr from @result)a

--插入換頁
declare @pageline float=16

--更新頁數
update a
set page=ceiling(cast(rr as float)/@pageline)
from (select page,rr from @result)a

insert @result(gno,page,cno,acomp,vccadate,vccano,noa,worker,tel,fax,custno,comp,serial,ctel,cfax,addr)
select '0',page,a.cno,b.acomp,vccadate,vccano,a.noa,a.worker,b.tel,b.fax,a.custno,c.comp,c.serial,c.tel,c.fax,c.addr_comp
from @result a left join acomp b on a.cno=b.noa
left join cust c on a.custno=c.noa
where gno='1'
group by page,a.cno,b.acomp,vccadate,vccano,a.noa,a.worker,b.tel,b.fax,a.custno,c.comp,c.serial,c.tel,c.fax,c.addr_comp

insert @result(gno,rr,page,cno,vccano,noa,custno,weight,total)
select '3',9997,page,cno,vccano,noa,custno,SUM(weight),SUM(total)
from @result
where gno='1' or gno='2'
group by page,vccano,noa,custno,cno

update @result
set tax=b.tax,money=b.money
from @result a outer apply(select SUM(total)*0.05 tax,SUM(total)*0.05+SUM(total)money,MAX(page)page from @result where gno='3' and vccano=a.vccano and noa=a.noa)b
where a.gno='3' and a.page=b.page

update @result
set tel=b.tel,fax=b.fax
from @result a left join acomp b on a.cno=b.noa
where gno='3'

insert @result(gno,rr,page,cno,vccano,noa,custno)
select '4','9998',page,cno,vccano,noa,custno
from @result
group by page,cno,vccano,noa,custno

select
'中華民國'+LEFT(vccadate,3)+'年'+SUBSTRING(vccadate,5,2)+'月' year
,case when trandate=CHAR(255) then '-' else trandate end trandate
,dbo.getComma(weight,3) weight
,dbo.getComma(price,-1)price
,dbo.getComma(tax,0)tax
,dbo.getComma(total,0)total
,dbo.getComma(money,0)money
,* from @result order by vccano,noa,page,rr
;
------------------------------------------------------------------------------------------------------
z_tran_jr5:--z_tran_jr5
declare @t_mon nvarchar(10)
declare @t_bdriverno nvarchar(20)
declare @t_edriverno nvarchar(20)

set @t_mon = case when '#non'=[12] then '' else [12] end
set @t_bdriverno = case when '#non'=[13] then '' else [13] end
set @t_edriverno = case when '#non'=[14] then char(255) else [14] end	
	
declare @tmp table(
	gno nvarchar(1),
	rr int,
	carno nvarchar(50),
	driverno nvarchar(50),
	driver nvarchar(50),
	con nvarchar(max),
	mon nvarchar(10),
	money float,
	memo nvarchar(max),
	counta float
)
insert @tmp(gno,driverno,driver)
select '9',driverno,driver
from carsals
where noa='104/10'

--應領tran
insert @tmp
select '1','1',b.carno,b.driverno,b.driver,b.carno+'總收入',@t_mon,sum(b.total),'',''
from view_trans b left join  view_tran a on a.noa=b.noa
where (LEFT(b.datea,6)=@t_mon)
and exists(select * from @tmp where b.driverno=driverno)
and isnull(b.driverno,'')!=''
group by b.carno,b.driverno,b.driver,b.carno

update @tmp
set counta=b.carno
from @tmp a
outer apply(select count(carno)carno,driverno from @tmp where a.driverno=driverno group by driverno)b

--應領carchg
insert @tmp
select '1','2',carno,driverno,driver,plusitem,@t_mon,sum(plusmoney),'',''
from carchg a
where (LEFT(datea,6)=@t_mon)
and exists(select * from @tmp where a.driverno=driverno and gno='9')
group by carno,driverno,driver,plusitem

--應扣carchg
insert @tmp
select '2','3',carno,driverno,driver,minusitem,@t_mon,sum(minusmoney),'',''
from carchg a
where (LEFT(datea,6)=@t_mon)
and exists(select * from @tmp where a.driverno=driverno and gno='9')
group by carno,driverno,driver,minusitem

--應扣carborr
insert @tmp
select '2','4',carno,driverno,driver,'私人借支('+datea+')',b.mon,b.money,dbo.getcomma(a.driverpay,0)+' '+cast(mount as nvarchar(50))+'期',''
from carborr a left join carborrs b on a.noa=b.noa
where b.mon=@t_mon
and exists(select * from @tmp where a.driverno=driverno and gno='9')

update a
set rr=rx
from (select ROW_NUMBER()over(partition by gno,driverno,driver order by rr,gno)rx,rr from @tmp where ISNULL(money,0)!=0)a

delete @tmp where gno='9' or ISNULL(money,0)=0

declare @result table(
	gno nvarchar(1),
	rr int,
	counta nvarchar(50),
	driverno nvarchar(50),
	driver nvarchar(50),
	con1 nvarchar(max),
	mon1 nvarchar(10),
	money1 float,
	memo1 nvarchar(max),
	con2 nvarchar(max),
	mon2 nvarchar(10),
	money2 float,
	memo2 nvarchar(max)
)
insert @result(gno,rr,driverno,driver)
select '0',rr,driverno,driver
from @tmp a
group by rr,driverno,driver

update @result
set con1=b.con,mon1=b.mon,money1=b.money,memo1=b.memo,counta=b.counta
from @result a left join @tmp b on a.driverno=b.driverno and a.driver=b.driver and a.rr=b.rr
where b.gno='1'

update @result
set con2=b.con,mon2=b.mon,money2=b.money,memo2=b.memo
from @result a left join @tmp b on a.driverno=b.driverno and a.driver=b.driver and a.rr=b.rr
where b.gno='2'

insert @result(gno,rr,driverno,driver,money1,money2)
select '1',9998,driverno,driver,sum(money1),sum(money2)
from @result
group by driverno,driver

insert @result(gno,rr,driverno,driver,money1)
select '2',9998,driverno,driver,sum(money1-money2)
from @result
where gno='1'
group by driverno,driver

insert @result(gno,rr,driverno,driver)
select '3',9998,driverno,driver
from @result
group by driverno,driver

select 
left(@t_mon,3)+'年'+right(@t_mon,2)+'月份薪資表' title
,dbo.getComma(money1,0) money1
,dbo.getComma(money2,0) money2
,counta+'台車收入金額' counta
,* from @result order by driverno,driver,rr,gno
;
------------------------------------------------------------------------------------
z_tran_jr6:--z_tran_jr6
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20) 
declare @t_bdriverno nvarchar(20)
declare @t_edriverno nvarchar(20)

set @t_bdate = case when '#non'=[2] then '' else [2] end
set @t_edate = case when '#non'=[3] then char(255) else [3] end
set @t_bdriverno = case when '#non'=[13] then '' else [13] end
set @t_edriverno = case when '#non'=[14] then char(255) else [14] end

declare @tmp table(
	gno nvarchar(2),
	rr int,
	carno nvarchar(50),
	driverno nvarchar(50),
	driver nvarchar(50),
	datea nvarchar(10),
	custno nvarchar(50),
	nick nvarchar(50),
	straddrno nvarchar(50),
	straddr nvarchar(50),
	productno nvarchar(50),
	product nvarchar(100),
	mount float,
	unit nvarchar(50),
	price float,
	total float,
	memo nvarchar(max),
	tax float,
	btotal float,
	ttotal float,
	stotal float,
	ntotal float,
	nbtotal float,
	nttotal float
)
insert @tmp
select '02','1',carno,driverno,driver,trandate,custno,nick,straddrno,straddr,uccno,product,sum(weight),unit,price,sum(total),memo,'','','','','','',''
from view_trans
where (trandate between @t_bdate and @t_edate)
and (driverno between @t_bdriverno and @t_edriverno)
group by carno,driverno,driver,trandate,custno,nick,straddrno,straddr,uccno,product,unit,price,memo

--carchg 
insert @tmp(gno,rr,carno,driverno,driver,datea,product,total,memo)
select '02','2',a.carno,a.driverno,a.driver,b.datea,plusitem,sum(plusmoney),b.memo
from @tmp a left join carchg b on a.carno=b.carno and a.driverno=b.driverno and a.driver=b.driver
where (b.datea between @t_bdate and @t_edate)
group by a.carno,a.driverno,a.driver,b.datea,plusitem,b.memo

insert @tmp(gno,carno,driverno,driver)
select '01',carno,driverno,driver
from @tmp
group by carno,driverno,driver

insert @tmp(gno,carno,driverno,driver,total)
select '03',carno,driverno,driver,sum(total)
from @tmp
group by carno,driverno,driver

insert @tmp(gno,carno,driverno,driver)
select '04',carno,driverno,driver
from @tmp
group by carno,driverno,driver

--carchg 
insert @tmp(gno,rr,carno,driverno,driver,datea,product,stotal,memo)
select '06','1',a.carno,a.driverno,a.driver,b.datea,minusitem,sum(minusmoney),b.memo
from @tmp a left join carchg b on a.carno=b.carno and a.driverno=b.driverno and a.driver=b.driver
where (b.datea between @t_bdate and @t_edate)
and (minusitem not like '%助手%' and minusitem not like '%加班%') and gno='01'
group by a.carno,a.driverno,a.driver,b.datea,minusitem,b.memo

insert @tmp(gno,carno,driverno,driver,stotal)
select '06',carno,driverno,driver,sum(stotal)
from @tmp
where gno='05'
group by carno,driverno,driver

insert @tmp(gno,carno,driverno,driver)
select '07',carno,driverno,driver
from @tmp
group by carno,driverno,driver

--carchg 
insert @tmp(gno,rr,carno,driverno,driver,datea,product,stotal,memo)
select '08','1',a.carno,a.driverno,a.driver,b.datea,minusitem,sum(minusmoney),b.memo
from @tmp a left join carchg b on a.carno=b.carno and a.driverno=b.driverno and a.driver=b.driver
where (b.datea between @t_bdate and @t_edate)
and (minusitem like '%助手%') and gno='01'
group by a.carno,a.driverno,a.driver,b.datea,minusitem,b.memo

insert @tmp(gno,carno,driverno,driver,stotal)
select '09',carno,driverno,driver,sum(stotal)
from @tmp
where gno='08'
group by carno,driverno,driver

insert @tmp(gno,carno,driverno,driver)
select '10',carno,driverno,driver
from @tmp
group by carno,driverno,driver

--carchg 
insert @tmp(gno,rr,carno,driverno,driver,datea,product,stotal,memo)
select '11','1',a.carno,a.driverno,a.driver,b.datea,minusitem,sum(minusmoney),b.memo
from @tmp a left join carchg b on a.carno=b.carno and a.driverno=b.driverno and a.driver=b.driver
where (b.datea between @t_bdate and @t_edate)
and (minusitem like '%加班%')
group by a.carno,a.driverno,a.driver,b.datea,minusitem,b.memo

insert @tmp(gno,carno,driverno,driver,stotal)
select '12',carno,driverno,driver,sum(stotal)
from @tmp
where gno='11'
group by carno,driverno,driver

--insert @tmp(gno,rr,carno,driverno,driver,btotal)
--select '00','1',a.carno,a.driverno,a.driver,SUM(isnull(b.total,0))
--from @tmp a left join view_tre b on a.carno=b.carno and a.driverno=b.driverno and a.driver=b.driver
--where isnull(rc2ano,'')='' and left(mon,3)='103' and gno='01'
--group by a.carno,a.driverno,a.driver

insert @tmp(gno,carno,driverno,driver,tax,total)
select '13',carno,driverno,driver,sum(total)*0.03,sum(total)+sum(total)*0.03
from @tmp
where gno='03'
group by carno,driverno,driver

update @tmp
set stotal=b.stotal
from @tmp a 
outer apply(select SUM(stotal)stotal from @tmp where (gno='06' or gno='09' or gno='12') and a.carno=carno and a.driverno=driverno and a.driver=driver)b
where gno='13'

update @tmp
set stotal=b.btotal
from @tmp a 
outer apply(select SUM(btotal)btotal from @tmp where (gno='00') and a.carno=carno and a.driverno=driverno and a.driver=driver)b
where gno='13'

update @tmp
set ttotal=isnull(total,0)+isnull(btotal,0)
where gno='13'

insert @tmp(gno,carno,driverno,driver,total,btotal,ttotal,ntotal,nbtotal,nttotal)
select '14',carno,driverno,driver,total*0.6,btotal*0.6,(total+btotal)*0.6,total*0.4,btotal*0.4,(total+btotal)*0.4
from @tmp
where gno='13'

insert @tmp(gno,carno,driverno,driver)
select '15',carno,driverno,driver
from @tmp
group by carno,driverno,driver

select 
carno+'(收入+支出)報表' title
,dbo.getComma(mount,-1) mount
,dbo.getComma(price,0) price
,dbo.getComma(total,0) total
,dbo.getComma(tax,0) tax
,dbo.getComma(btotal,0)btotal
,dbo.getComma(ttotal,0)ttotal
,dbo.getComma(stotal,0)stotal
,dbo.getComma(stotal,0)stotal
,dbo.getComma(ntotal,0) ntotal
,dbo.getComma(nbtotal,0)nbtotal
,dbo.getComma(nttotal,0)nttotal
,* 
from @tmp order by carno,driverno,gno,datea,rr
;