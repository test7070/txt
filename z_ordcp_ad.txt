z_ordcp_ad01:--z_ordcp_ad01
declare @t_bnoa nvarchar(30) = case when '#non' = [4] then '' else [4] end
declare @t_enoa nvarchar(30) = case when '#non' = [5] then CHAR(255) else [5] end
declare @tmp table(
	gno nvarchar(1),
	rr int,
	page nvarchar(10),
	ordcno nvarchar(100),
	tno nvarchar(100),
	tgg nvarchar(100),
	cno nvarchar(100),
	cust nvarchar(100),
	noa nvarchar(100),
	datea nvarchar(10),
	addr2 nvarchar(max),
	coin nvarchar(10),
	ordeno nvarchar(50),
	
	pronoa nvarchar(50),
	custprono nvarchar(50),
	rc2no nvarchar(50),
	spec nvarchar(50),
	groupdno nvarchar(50),
	groupeno nvarchar(50),
	ucolor nvarchar(50),
	groupfno nvarchar(50),
	groupf nvarchar(50),
	scolor nvarchar(50),
	class nvarchar(50),
	classa nvarchar(50),
	zinc nvarchar(50),
	sizeano nvarchar(50),
	sizea nvarchar(250),
	sourceno nvarchar(50),
	[source] nvarchar(50),
	groupgno nvarchar(50),
	groupg nvarchar(50),
	groupino nvarchar(50),
	groupi nvarchar(50),
	grouphno nvarchar(50),
	grouph nvarchar(50),
	price float,
	mount float,
	unit nvarchar(10),
	total float,
	ctn float,
	trandate nvarchar(10),
	memoa nvarchar(max),
	cuft float,
	mark nvarchar(max),
	image1 nvarchar(max),
	nw float,
	gw float,
	memo nvarchar(max),
	worker nvarchar(50),
	wdate nvarchar(10),
	gwn nvarchar(10),
	boss nvarchar(100)
)

insert @tmp
select '0','','',a.noa,a.tggno,a.tgg,b.custno,b.comp,b.noa,b.datea,b.addr2,b.coin,b.custorde
		,c.productno,e.productno,'',f.spec,f.groupdno,f.groupeno,(select top 1 mon from adspec where noa=d.ucolor)
		,f.groupfno,(select top 1 mon from adsss where noa=f.groupfno)
		,d.scolor,d.class,d.classa,d.zinc
		,d.sizea,(select top 1 mon from adoth where noa=d.sizea)
		,d.source,(select top 1 mon from adpro where noa=d.source)
		,f.groupgno,(select top 1 mon from adknife where noa=f.groupgno)
		,f.groupino,(select top 1 mon from adtran where noa=f.groupino)
		,f.grouphno,(select top 1 mon from adpipe where noa=f.grouphno)
		,c.price,c.mount,c.unit,c.total
		,case when isnull(g.inmount,0)*isnull(g.outmount,0)=0 then 1 else ceiling(c.mount/nullif((g.inmount*g.outmount),0)) end
		,d.datea,d.memo
		,g.cuft*case when isnull(g.inmount,0)*isnull(g.outmount,0)=0 then 1 else ceiling(c.mount/nullif((g.inmount*g.outmount),0)) end
		,Replace(h.main+h.side,'chr(10)','</BR>')
		,'<img width="100px" src="../images/upload/'+replace(c.productno,'/','CHR(47)')+'_01.jpg">'
		,c.mount*g.uweight
		,case when g.inmount!=0 then g.gweight*floor (c.mount/nullif(g.inmount*g.outmount,0)) else '' end--整箱
		+case when g.inmount!=0 then (c.mount-floor (c.mount/nullif(g.inmount*g.outmount,0))*g.inmount*g.outmount)*g.uweight else '' end--散裝淨重
		+case when (case when g.inmount!=0 then (c.mount-(floor(c.mount/nullif((g.inmount*g.outmount),0))*(g.inmount*g.outmount))) else '' end)>0 then g.outweight else 0 end --外包裝重
		+case when (case when g.inmount!=0 then (c.mount-(floor(c.mount/nullif((g.inmount*g.outmount),0))*(g.inmount*g.outmount))) else '' end)>0 then ceiling((c.mount-(floor(b.mount/(g.inmount*g.outmount))*(g.inmount*g.outmount)))/g.inmount)*g.inweight else 0 end tgw --內包裝重
		,b.memo,a.worker,a.datea,'G.W.',i.boss
from view_ordc a left join view_orde b on b.ordcno=a.noa
left join view_ordcs c on a.noa=c.noa
left join view_ordes d on b.noa=d.noa and c.productno=d.productno
left join ucccust e on b.custno=e.custno and e.noa=c.productno
left join uca f on c.productno=f.noa
left join pack2s g on d.productno=g.noa and d.packwayno=g.packway
left join view_ordei h on b.noa=h.noa
left join tgg i on a.tggno=i.noa
where a.noa between @t_bnoa and @t_enoa

declare @tmpa table(
	noa nvarchar(100),
	cno nvarchar(100),
	productno nvarchar(100)
)

insert @tmpa
select a.noa,a.custno,b.productno
from view_ordes b left join view_orde a on a.noa=b.noa where a.stype=4 

update @tmp 
set rc2no=b.rc2no
from @tmp a left join(
SELECT cno,productno,(SELECT cast(noa AS NVARCHAR ) + 'cht(10)/' from @tmpa
where cno = ord.cno and productno = ord.productno
FOR XML PATH('')) as rc2no
from @tmpa ord) b on a.cno=b.cno and a.pronoa=b.productno

declare @pageline int =4

update a
set rr=rx,page=ceiling(cast(rx as float)/@pageline)
from(select page,ROW_NUMBER()over(partition by ordcno order by tno,noa,pronoa)rx,rr from @tmp)a

insert @tmp(gno,page,ordcno,tno,cno,mount,total,ctn,cuft,nw,gw,worker,wdate,memo,gwn,tgg,boss)
select '1',MAX(page),ordcno,tno,cno,SUM(mount),sum(total),SUM(ctn),SUM(cuft),SUM(isnull(nw,0)),SUM(isnull(gw,0)),worker,wdate,memo,'G.W.',tgg,boss
from @tmp
group by ordcno,tno,cno,worker,wdate,memo,tgg,boss

insert @tmp(gno,page,ordcno,tno,cno)
select '2',page,ordcno,tno,cno
from @tmp
group by page,ordcno,tno,cno

select
dbo.charbr(pronoa,12)pronoa
,dbo.charbr(scolor,6)scolor
,dbo.charbr(class,6)class
,dbo.charbr(classa,6)classa
,dbo.charbr(zinc,6)zinc
,dbo.getComma(price,3)price
,dbo.getComma(mount,0)mount
,dbo.getComma(total,0)total
,dbo.getComma(ctn,0)ctn
,dbo.getComma(cuft,0) cuft
,dbo.getComma(nw,2)nw
,dbo.getComma(gw,2)gw
,replace(SUBSTRING(rc2no,1,len(rc2no)-1),'cht(10)','</BR>')rc2no
,* from @tmp
order by ordcno,page,gno,rr
;