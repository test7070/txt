post:--deli
--報關轉進貨單
SET QUOTED_IDENTIFIER OFF
declare @year nvarchar(20)=[1]--年度[1]
declare @noa nvarchar(20)=[2]--單據編號[2]
declare @condition nvarchar(20)=[3]--動作 0 刪除, 1 新增[3]
declare @t_err nvarchar(200)=''
-----------------------------------------------------------------------
declare @nowdate nvarchar(30) --今天日期
set @nowdate=CONVERT (VARCHAR(7), GETDATE(),12 )+0890000
set @nowdate=left(@nowdate,3)+'/'+substring(@nowdate,4,2)+'/'+right(@nowdate,2)

--104/07/16依報關日
set @nowdate=isnull((select top 1 datea from deli where noa=@noa),@nowdate)

declare @cmd nvarchar(max)
declare @rc2no nvarchar(50)
declare @accy nvarchar(20) --rc2的年度

set @rc2no=isnull((select rc2no from deli where noa=@noa),'')
set @accy=isnull((select top 1 accy from view_rc2 where noa=@rc2no),@year)

if(@condition='0')
begin
	--刪除產生的rc2
	set @cmd="delete rc2"+@accy+" where noa='"+@rc2no+"'"
	EXECUTE sp_executesql @cmd
	set @cmd="delete rc2s"+@accy+" where noa='"+@rc2no+"'"
	EXECUTE sp_executesql @cmd
end

declare @n_rc2no nvarchar(50) --新的rc2no

if(@condition='1')
begin
	--檢查deli的rc2no是否已有編號(表示修改)
	if(LEN(@rc2no)=0)
	begin
		--取得當天最後一個出貨單號
		select @n_rc2no=MAX(noa) from view_rc2 where noa like 'B'+REPLACE(@nowdate,'/','')+'%'
		--新的出貨單號(後面號碼+1)
		set @n_rc2no='B'+REPLACE(@nowdate,'/','')+right('000'+cast(cast(RIGHT(isnull(@n_rc2no,'000'),3) as int)+1 as nvarchar(10)),3)
	end
	else
	begin
		set @n_rc2no=@rc2no
	end
	
	--將deli的內容轉至rc2
	set @cmd="insert rc2"+@accy+"(noa,ordeno,typea,kind,datea,tggno,comp,nick,tel,post,addr,salesno,sales
	,cno,acomp,paytype,trantype,floata,coin,taxtype,worker,worker2,memo,mon
	,money,tax,total,unpay,payed)
	select '"+@n_rc2no+"' noa,a.noa ordeno,'1','1','"+@nowdate+"',a.tggno,a.comp,b.nick,b.tel,b.zip_fact,b.addr_fact,b.salesno,b.sales
	,a.cno,a.acomp,b.paytype,b.trantype,a.floata,a.coin,'',''
	,case when a.worker2!='' then a.worker2 else a.worker end,a.memo,left('"+@nowdate+"',6)
	,0,0,0,0,0
	from deli a left join tgg b on a.tggno=b.noa where a.noa='"+@noa+"'"
	EXECUTE sp_executesql @cmd
	
	set @cmd="insert rc2s"+@accy+"(noa,noq,datea,typea,productno,product,unit
	,spec,style,uno,uno2,class,dime,width,lengthb,size,dime2,lengthc,source	,memo,ordeno,no2,tggno,storeno,store
	,mount,weight,price,sprice,total)
	select '"+@n_rc2no+"' noa,a.noq,'"+@nowdate+"','1' typea,a.productno,a.product,a.unit
	,a.spec,a.style,a.uno,a.uno2,a.class,a.dime,a.width,a.lengthb,a.size,a.dime2,a.lengthc,a.source,a.memo,a.ordcno,a.no2,b.tggno,a.storeno,a.store
	,a.mount,a.weight
	,a.price
	,case when upper(isnull(a.unit,'')) in ('','KG','MT','公斤','噸','頓') then round(a.cost/a.weight/(case when b.floata!=0 then b.floata else 1 end),3) else round(a.cost/a.mount/(case when b.floata!=0 then b.floata else 1 end),3) end--a.price
	,a.total
	from delis a left join deli b on a.noa=b.noa where a.noa='"+@noa+"'"
	EXECUTE sp_executesql @cmd
	
	EXEC("update rc2"+@accy+" 
	set money=isnull((select sum(total) from view_rc2s where noa='"+@n_rc2no+"'),0)
	,total=isnull((select sum(total) from view_rc2s where noa='"+@n_rc2no+"'),0)
	,unpay=isnull((select sum(total) from view_rc2s where noa='"+@n_rc2no+"'),0)-isnull((select sum(paysale) from pays where rc2no='"+@n_rc2no+"'),0)
	,payed=isnull((select sum(paysale) from pays where rc2no='"+@n_rc2no+"'),0)
	where noa='"+@n_rc2no+"' ")
	
	if(LEN(@rc2no)=0)
	begin
		--資料寫入dno 避免下次自動產生出現問題
		insert dno(tablea,noa,usera)
		select 'rc2',@n_rc2no,'z001'
		
		--更新rc2no
		set @cmd="update deli set rc2no='"+@n_rc2no+"' where noa='"+@noa+"'"
		EXECUTE sp_executesql @cmd
	end
	
	set @rc2no=@n_rc2no
	
end

	select @rc2no rc2no
;
-------------------------------------------------------------------------------------------------------------------------------------------------------