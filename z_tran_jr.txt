z_tran_jr1:--z_tran_jr1
declare @t_bdate nvarchar(20) = case when '#non'=[2] then '' else [2] end
declare @t_edate nvarchar(20) = case when '#non'=[3] then char(255) else [3] end
declare @t_bcustno nvarchar(20) = case when '#non'=[6] then '' else [6] end
declare @t_ecustno nvarchar(20) = case when '#non'=[7] then char(255) else [7] end
declare @t_bcarno nvarchar(20) = case when '#non'=[8] then '' else [8] end
declare @t_ecarno nvarchar(20) = case when '#non'=[9] then char(255) else [9] end
declare @t_baddr nvarchar(20) = case when '#non'=[10] then '' else [10] end 
declare @t_eaddr nvarchar(20) = case when '#non'=[11] then char(255) else [11] end 

declare @tmp table(
	rr int,
	gno nvarchar(1),
	datea nvarchar(10),
	trandate nvarchar(10),
	custno nvarchar(100),
	comp nvarchar(200),
	uccno nvarchar(50),
	weight nvarchar(50),
	weight2 nvarchar(50),
	po nvarchar(100),
	carno nvarchar(50),
	straddrno nvarchar(100),
	straddr nvarchar(100),
	chk1 nvarchar(2),
	memo nvarchar(max)
)
insert @tmp
select ROW_NUMBER()over(partition by datea,trandate,po,custno,straddrno,chk1 order by uccno),'0',datea,trandate,custno,nick,uccno,weight,weight2,po,carno,straddrno
,straddr,case chk1 when '1' then 'V' else ' ' end chk1,memo
from view_trans
where (datea between @t_bdate and @t_edate)
and (custno between @t_bcustno and @t_ecustno)
and (carno between @t_bcarno and @t_ecarno)
and (straddrno between @t_baddr and @t_eaddr)

update @tmp
set gno=case when rr=1 then 0 else 1 end

select 
dbo.getComma(weight,2) weight
,dbo.getComma(weight2,2) weight2
,* from @tmp
order by datea,trandate,custno,uccno,straddrno
;
------------------------------------------------------------------------------------------------
z_tran_jr2:--z_tran_jr2
declare @t_bdate nvarchar(20) = case when '#non'=[2] then '' else [2] end
declare @t_edate nvarchar(20) = case when '#non'=[3] then char(255) else [3] end
declare @t_bcustno nvarchar(20) = case when '#non'=[6] then '' else [6] end
declare @t_ecustno nvarchar(20) = case when '#non'=[7] then char(255) else [7] end
declare @t_bcarno nvarchar(20) = case when '#non'=[8] then '' else [8] end
declare @t_ecarno nvarchar(20) = case when '#non'=[9] then char(255) else [9] end
declare @t_baddr nvarchar(20) = case when '#non'=[10] then '' else [10] end 
declare @t_eaddr nvarchar(20) = case when '#non'=[11] then char(255) else [11] end 

declare @tmp table(
	gno nvarchar(1),
	rr int,
	straddrno nvarchar(50),
	straddr nvarchar(100),
	trandate nvarchar(10),
	carno nvarchar(50),
	weight nvarchar(50),
	weight2 float,
	price float,
	total float,
	po nvarchar(100),
	uccno nvarchar(50),
	custno nvarchar(100),
	comp nvarchar(200),
	total2 float,
	total3 float,
	acomp nvarchar(100)
)
insert @tmp (gno,rr,straddrno,straddr,trandate,carno,weight,weight2,price,total,po,uccno,custno,comp)
select '0',ROW_NUMBER()over(partition by straddrno order by trandate),straddrno,straddr,trandate,carno,weight,weight2,price,total,po,uccno,custno,nick
from view_trans
where (trandate between @t_bdate and @t_edate)
and (custno between @t_bcustno and @t_ecustno)
and (carno between @t_bcarno and @t_ecarno)
and (straddrno between @t_baddr and @t_eaddr)

update @tmp
set acomp=(select top 1 nick from acomp)

insert @tmp(gno,straddrno,weight2,total,total2,total3)
select '1',straddrno,SUM(weight2),SUM(total),SUM(total*0.05),SUM(total+total*0.05)
from @tmp group by straddrno

insert @tmp(gno,straddrno)
select '2',straddrno from @tmp
group by straddrno

select 
straddr+'噸數統計' title
,straddr+'噸數' custwn
,dbo.getComma(weight,2) weight
,dbo.getComma(weight2,2) weight2
,'$'+dbo.getComma(price,0) price
,'$'+dbo.getComma(total,0) total
,'$'+dbo.getComma(total2,0) total2
,'$'+dbo.getComma(total3,0) total3
,* from @tmp
order by straddrno,gno,trandate
;
-------------------------------------------------------------------------------------------------
z_tran_jr3:--z_tran_jr3
declare @t_bdate nvarchar(20) = case when '#non'=[2] then '' else [2] end
declare @t_edate nvarchar(20) = case when '#non'=[3] then char(255) else [3] end
declare @t_bcustno nvarchar(20) = case when '#non'=[6] then '' else [6] end
declare @t_ecustno nvarchar(20) = case when '#non'=[7] then char(255) else [7] end
declare @t_bcarno nvarchar(20) = case when '#non'=[8] then '' else [8] end
declare @t_ecarno nvarchar(20) = case when '#non'=[9] then char(255) else [9] end
declare @t_baddr nvarchar(20) = case when '#non'=[10] then '' else [10] end 
declare @t_eaddr nvarchar(20) = case when '#non'=[11] then char(255) else [11] end 

declare @tmp table(
	rr int,
	gno nvarchar(1),
	mon nvarchar(20),
	custno nvarchar(100),
	comp nvarchar(200),
	addr nvarchar(max),
	serial nvarchar(50),
	tel nvarchar(50),
	datea nvarchar(10),
	uccno nvarchar(50),
	weight float,
	price float,
	money float,
	carno nvarchar(50),
	po nvarchar(50),
	straddrno nvarchar(50),
	straddr nvarchar(50),
	tax float,
	total float
)

insert @tmp
select ROW_NUMBER()over(partition by custno,b.trandate,b.carno,po,straddrno order by b.trandate),'0',replace(LEFT(a.datea,6),'/','-')+'月份',b.custno,c.comp,c.addr_comp
,c.serial,c.tel,b.trandate,b.uccno,b.weight2,b.price,b.total,b.carno,b.po
,b.straddrno,b.straddr,0,0
from view_tran a left join view_trans b on a.noa=b.noa
left join cust c on b.custno=c.noa
where (a.datea between @t_bdate and @t_edate)
and (custno between @t_bcustno and @t_ecustno)

update @tmp
set gno=case when rr=1 then 0 else 1 end

insert @tmp(gno,custno,money,tax,total)
select '2',custno,SUM(money),SUM(money)*0.05,SUM(money)*0.05+SUM(money)
from @tmp
group by custno

insert @tmp(gno,custno)
select '3',custno
from @tmp
group by custno

select 
dbo.getComma(weight,2)weight
,dbo.getComma(price,0)price
,dbo.getComma(money,0)money
,dbo.getComma(tax,0)tax
,'$'+dbo.getComma(total,0)total
,* from @tmp
order by custno,gno,datea
;
