z_custprice01:--z_custprice01
SET QUOTED_IDENTIFIER OFF
declare @t_datea  nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bagentno nvarchar(20)
declare @t_eagentno nvarchar(20)
declare @t_bproductno nvarchar(20)
declare @t_eproductno  nvarchar(20)



set @t_datea = case when '#non'=[1] then '' else [1] end
set @t_bcustno = case when '#non'=[2] then '' else [2] end
set @t_ecustno = case when '#non'=[3] then char(255) else [3] end
set @t_bagentno = case when '#non'=[4] then '' else [4] end
set @t_eagentno = case when '#non'=[5] then char(255) else [5] end
set @t_bproductno = case when '#non'=[6] then '' else [6] end
set @t_eproductno = case when '#non'=[7] then char(255) else [7] end

declare  @tmp table(
		gno nvarchar(1),
		rr int,
		qdate nvarchar(20),
		bdate nvarchar(10),
		agentno nvarchar(20),
		agent nvarchar(50),
		custno nvarchar(20),
		comp nvarchar(50),
		productno nvarchar(10),
		product nvarchar(50),
		unit nvarchar(8),
		oprice float,
		discount float,
		notaxprice float,
		taxrate float,
		price float,
		payterms nvarchar(20),
		commission float,
		total float,
		memo nvarchar(200)
)

insert into @tmp
select '0','',@t_datea,MAX(b.bdate),isnull(a.agentno,''),isnull(d.agent,''),b.custno,a.comp,b.productno,b.product,b.unit
		,MAX(b.oprice),MAX(b.discount),MAX(b.notaxprice),MAX(b.taxrate),MAX(b.price),b.payterms,MAX(b.commission),'',b.memo
from custprice a left join custprices b on a.noa=b.noa
left join agent d on a.agentno=d.noa 
outer apply(select top 1 sb.bdate,sb.oprice,sb.discount,sb.notaxprice,sb.taxrate,sb.price,sb.commission
	from custprice sa left join custprices sb on sa.noa=sb.noa where sa.custno=a.custno and sa.agentno=a.agentno and sb.productno=b.productno and sb.payterms=b.payterms and sb.bdate<=@t_datea order by b.bdate desc)c
where b.bdate<=@t_datea
and (b.custno between @t_bcustno and @t_ecustno)
and (isnull(a.agentno,'') between @t_bagentno and @t_eagentno)
and (b.productno between @t_bproductno and @t_eproductno)
group by b.custno,a.comp,b.unit,b.productno,b.product,b.payterms,b.memo,a.agentno,d.agent



update a set rr=rx
from (select ROW_NUMBER() over (partition by custno order by productno)rx,rr from @tmp) a

if((select count(*) from @tmp)>0)
begin
	insert @tmp(gno,custno)
	select '1',custno
	from @tmp
	group by custno
end


	
select
dbo.getComma(oprice,2)oprice,
dbo.getComma(discount,2)discount,
dbo.getComma(notaxprice,2)notaxprice,
dbo.getComma(taxrate,2)taxrate,
dbo.getComma(price,2)price,
dbo.getComma(commission,2)commission,
* from  @tmp order by custno,gno
;