z_acbej07:--z_acbej07	預算總表-部門
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	
	declare @t_bmon nvarchar(10) = case when '#non' = [7] then ' '+'/01' else [7]+'/01' end
	declare @t_emon nvarchar(10) = case when '#non' = [8] then CHAR(255)+'/12' else [8]+'/12' end
	declare @t_bacc1 nvarchar(20) = case when '#non' = [3] then ' ' else [3] end
	declare @t_eacc1 nvarchar(20) = case when '#non' = [4] then CHAR(255) else [4] end
	declare @t_proj nvarchar(max) = case when '#non' = [5] then ' ' else [5] end
	declare @t_part nvarchar(max) = case when '#non' = [6] then ' ' else [6] end
	--------------------------------------------------------------------------------------------
	declare @listaccc table(
		tablea nvarchar(20),
		accy nvarchar(20),
		yy nvarchar(10)
	)
	--------------------------------------------------------------------------------------------
	declare @tmpa table(
		accy nvarchar(10),
		proj nvarchar(20),
		cproj nvarchar(20),
		part nvarchar(20),
		cpart nvarchar(20),
		datea nvarchar(10),
		acc1 nvarchar(20),
		acc2 nvarchar(50),
		memo nvarchar(max),
		dmoney float,
		cmoney float
	)
	
	IF OBJECT_ID('tempdb..#z_acbej_accu')is not null
	BEGIN
		drop table #z_acbej_accu	
	END
	create table #z_acbej_accu(
		sel int identity(1,1),
		mon nvarchar(10),
		proj nvarchar(20),
		cproj nvarchar(20),
		part nvarchar(20),
		cpart nvarchar(20),
		acc1 nvarchar(20),
		acc2 nvarchar(50),
		[money] float
	)
	insert into #z_acbej_accu(mon,proj,cproj,part,cpart,acc1,acc2,[money])
	select b.mon,'','',isnull(a.partno,''),isnull(a.part,''),a.acc1,a.acc2,a.[money]
	from accus a
	left join accu b on a.noa=b.noa
	where b.[mon] between @t_bmon and @t_emon
		and isnull(a.acc1,'') between @t_bacc1 and @t_eacc1
		 and (len(@t_part)=0 or charindex(','+a.partno+',',','+@t_part+',')>0)
	---------------------------------------------------------------------------------
	declare @tablea nvarchar(20)
	declare @accy nvarchar(10)
	declare @yy nvarchar(10)
	
	declare cursor_table cursor for
	select tablea,accy,yy from @listaccc
	open cursor_table
	fetch next from cursor_table
	into @tablea,@accy,@yy
	while(@@FETCH_STATUS <> -1)
	begin		
		set @cmd ="select @accy,'','',isnull(a.part,''),isnull(c.part,''),b.accc2,a.accc5,a.accc6,a.accc7,a.dmoney,a.cmoney
		 from acccs"+@accy+" a
		 left join accc"+@accy+" b on a.accc3=b.accc3
		 left join acpart"+@accy+" c on a.part=c.noa 
		 left join proj d on a.proj=d.noa
		 where exists(select top 1* from #z_acbej_accu 
			where mon=@yy+'/'+left(b.accc2,2) 
				and part=isnull(a.part,'')
				and acc1=isnull(a.accc5,''))"
		insert into @tmpa(accy,proj,cproj,part,cpart,datea,acc1,acc2,memo,dmoney,cmoney)
		execute sp_executesql @cmd,N'@yy nvarchar(10),@accy nvarchar(10),@t_bmon nvarchar(10),@t_emon nvarchar(10),@t_bacc1 nvarchar(20),@t_eacc1 nvarchar(20),@t_proj nvarchar(max),@t_part nvarchar(max)'
		,@yy=@yy,@accy=@accy,@t_bmon=@t_bmon,@t_emon=@t_emon,@t_proj=@t_proj,@t_part=@t_part,@t_bacc1=@t_bacc1,@t_eacc1=@t_eacc1
		
		fetch next from cursor_table
		into @tablea,@accy,@yy
	end
	close cursor_table
	deallocate cursor_table
	------------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_acbej01')is not null
	BEGIN
		drop table #z_acbej01	
	END
	create table #z_acbej01(
		gno nvarchar(10),
		pno int identity(1,1),
		recno int,
		typea nvarchar(10),
		accy nvarchar(10),
		proj nvarchar(20),
		part nvarchar(20),	
		acc1 nvarchar(20),
		acc2 nvarchar(50),
		memo nvarchar(max),
		mon01 float,
		mon02 float,
		mon03 float,
		mon04 float,
		mon05 float,
		mon06 float,
		mon07 float,
		mon08 float,
		mon09 float,
		mon10 float,
		mon11 float,
		mon12 float,
		total float,
		cproj nvarchar(50),
		cpart nvarchar(50),
		smon01 float,
		smon02 float,
		smon03 float,
		smon04 float,
		smon05 float,
		smon06 float,
		smon07 float,
		smon08 float,
		smon09 float,
		smon10 float,
		smon11 float,
		smon12 float,
		stotal float
	)
	create index acc1 on #z_acbej01(accy,acc1)
	declare @field nvarchar(20)
	declare @datea nvarchar(10)
	declare @proj nvarchar(20)
	declare @part nvarchar(20)
	declare @cproj nvarchar(50)
	declare @cpart nvarchar(50)
	declare @acc1 nvarchar(20)
	declare @acc2 nvarchar(50)
	declare @memo nvarchar(max)
	declare @dmoney float
	declare @cmoney float
	
	declare cursor_table cursor for
	select accy,proj,cproj,part,cpart,datea,acc1,acc2,memo,dmoney,cmoney from @tmpa
	open cursor_table
	fetch next from cursor_table
	into @accy,@proj,@cproj,@part,@cpart,@datea,@acc1,@acc2,@memo,@dmoney,@cmoney
	while(@@FETCH_STATUS <> -1)
	begin		
		set @field = 'mon'+LEFT(@datea,2)
	
		if exists(select * from #z_acbej01 where accy=@accy and acc1=@acc1)
		begin
			set @cmd =
			" update #z_acbej01 set "+@field+"=isnull(a."+@field+",0)+case when a.typea='A' then @cmoney-@dmoney else @dmoney-@cmoney end
			  from #z_acbej01 a 
			  where accy=@accy and acc1=@acc1"
			execute sp_executesql @cmd,N'@dmoney float,@cmoney float,@accy nvarchar(10),@acc1 nvarchar(20)'
			,@accy=@accy,@acc1=@acc1,@dmoney=@dmoney,@cmoney=@cmoney
		end
		else
		begin
			set @cmd =
			" insert into #z_acbej01(gno,typea,accy,proj,cproj,part,cpart,acc1,acc2,memo,"+@field+")
			  values('1',case when left(@acc1,1)='1' or left(@acc1,1)='4' or left(@acc1,1)='7' then 'A' else 'B' end 
			  ,@accy,@proj,@cproj,@part,@cpart,@acc1,@acc2,@memo
			  ,case when left(@acc1,1)='1' or left(@acc1,1)='4' or left(@acc1,1)='7' then @cmoney-@dmoney else @dmoney-@cmoney end)"
			  
			execute sp_executesql @cmd,N'@accy nvarchar(10),@acc1 nvarchar(20),@acc2 nvarchar(50),@memo nvarchar(max),@dmoney float,@cmoney float,@part nvarchar(20),@proj nvarchar(20),@cproj nvarchar(50),@cpart nvarchar(50)'
			,@accy=@accy,@acc1=@acc1,@acc2=@acc2,@dmoney=@dmoney,@cmoney=@cmoney,@memo=@memo,@part=@part,@proj=@proj,@cproj=@cproj,@cpart=@cpart
		end
		fetch next from cursor_table
		into @accy,@proj,@cproj,@part,@cpart,@datea,@acc1,@acc2,@memo,@dmoney,@cmoney
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------- accu
	declare @mon nvarchar(10)
	declare @money float

	declare cursor_table cursor for
	select mon,proj,cproj,part,cpart,acc1,acc2,[money] from #z_acbej_accu
	open cursor_table
	fetch next from cursor_table
	into @mon,@proj,@cproj,@part,@cpart,@acc1,@acc2,@money
	while(@@FETCH_STATUS <> -1)
	begin		
		set @field = 'smon'+right(@mon,2)
	
		if exists(select * from #z_acbej01 where accy=left(@mon,3)+'_1' and acc1=@acc1)
		begin
			set @cmd =
			" update #z_acbej01 set "+@field+"=isnull(a."+@field+",0)+@money
			  from #z_acbej01 a 
			  where accy=left(@mon,3)+'_1' and acc1=@acc1"
			execute sp_executesql @cmd,N'@money float,@mon nvarchar(10),@acc1 nvarchar(20)'
			,@mon=@mon,@acc1=@acc1,@money=@money
		end
		else
		begin
			set @cmd =
			" insert into #z_acbej01(gno,typea,accy,proj,cproj,part,cpart,acc1,acc2,"+@field+")
			  values('1',case when left(@acc1,1)='4' or left(@acc1,1)='7' then 'A' else 'B' end ,left(@mon,3)+'_1',@proj,@cproj,@part,@cpart,@acc1,@acc2,@money)"
			execute sp_executesql @cmd,N'@mon nvarchar(10),@acc1 nvarchar(20),@acc2 nvarchar(50),@money float,@part nvarchar(20),@proj nvarchar(20),@cproj nvarchar(50),@cpart nvarchar(50)'
			,@mon=@mon,@acc1=@acc1,@acc2=@acc2,@money=@money,@part=@part,@proj=@proj,@cproj=@cproj,@cpart=@cpart
		end
		fetch next from cursor_table
		into @mon,@proj,@cproj,@part,@cpart,@acc1,@acc2,@money
	end
	close cursor_table
	deallocate cursor_table

	update #z_acbej01 set total = ISNULL(mon01,0)+ISNULL(mon02,0)+ISNULL(mon03,0)+ISNULL(mon04,0)
		+ISNULL(mon05,0)+ISNULL(mon06,0)+ISNULL(mon07,0)+ISNULL(mon08,0)
		+ISNULL(mon09,0)+ISNULL(mon10,0)+ISNULL(mon11,0)+ISNULL(mon12,0)
		,stotal = ISNULL(smon01,0)+ISNULL(smon02,0)+ISNULL(smon03,0)+ISNULL(smon04,0)
		+ISNULL(smon05,0)+ISNULL(smon06,0)+ISNULL(smon07,0)+ISNULL(smon08,0)
		+ISNULL(smon09,0)+ISNULL(smon10,0)+ISNULL(smon11,0)+ISNULL(smon12,0)
	insert into #z_acbej01(gno,accy,proj,cproj,part,cpart,acc1,mon01,mon02,mon03,mon04,mon05,mon06,mon07,mon08,mon09,mon10,mon11,mon12,total
		,smon01,smon02,smon03,smon04,smon05,smon06,smon07,smon08,smon09,smon10,smon11,smon12,stotal)
	select '2',accy,proj,cproj,part,cpart,LEFT(acc1,1)+CHAR(255)
		,SUM(ISNULL(mon01,0)),SUM(ISNULL(mon02,0)),SUM(ISNULL(mon03,0)),SUM(ISNULL(mon04,0)),SUM(ISNULL(mon05,0)),SUM(ISNULL(mon06,0))
		,SUM(ISNULL(mon07,0)),SUM(ISNULL(mon08,0)),SUM(ISNULL(mon09,0)),SUM(ISNULL(mon10,0)),SUM(ISNULL(mon11,0)),SUM(ISNULL(mon12,0))
		,SUM(ISNULL(total,0))
		,SUM(ISNULL(smon01,0)),SUM(ISNULL(smon02,0)),SUM(ISNULL(smon03,0)),SUM(ISNULL(smon04,0)),SUM(ISNULL(smon05,0)),SUM(ISNULL(smon06,0))
		,SUM(ISNULL(smon07,0)),SUM(ISNULL(smon08,0)),SUM(ISNULL(smon09,0)),SUM(ISNULL(smon10,0)),SUM(ISNULL(smon11,0)),SUM(ISNULL(smon12,0))
		,SUM(ISNULL(stotal,0))
	from #z_acbej01 where gno='1' group by accy,proj,cproj,part,cpart,LEFT(acc1,1) 
	
	insert into #z_acbej01(gno,accy,proj,cproj,part,cpart,acc1,mon01,mon02,mon03,mon04,mon05,mon06,mon07,mon08,mon09,mon10,mon11,mon12,total
		,smon01,smon02,smon03,smon04,smon05,smon06,smon07,smon08,smon09,smon10,smon11,smon12,stotal)
	select '3',accy,proj,cproj,part,MAX(cpart),CHAR(255)
		,SUM(ISNULL(mon01,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon02,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon03,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon04,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon05,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon06,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon07,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon08,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon09,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon10,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon11,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon12,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(total,0)*case when typea='A' then 1 else -1 end)
		
		,SUM(ISNULL(smon01,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon02,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon03,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon04,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon05,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon06,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon07,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon08,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon09,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon10,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon11,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon12,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(stotal,0)*case when typea='A' then 1 else -1 end)
	from #z_acbej01 where gno='2' group by accy,proj,cproj,part
	
	update #z_acbej01 set recno=b.recno
	from #z_acbej01 a
	left join (select pno,ROW_NUMBER()over(partition by accy,proj,part order by acc1) recno from #z_acbej01) b on a.pno=b.pno
	----------------------------------------------------------------------------------------------------
	declare @t_page int = 40
	declare @n int = 0
	declare @recno int = 0
	
	declare cursor_table cursor for
	select accy,proj,cproj,part,cpart,count(1),max(recno) from #z_acbej01 group by accy,proj,cproj,part,cpart
	open cursor_table
	fetch next from cursor_table
	into @accy,@proj,@cproj,@part,@cpart,@n,@recno
	while(@@FETCH_STATUS <> -1)
	begin		
		while @n%@t_page!=0
		begin
			insert into #z_acbej01(gno,accy,proj,cproj,part,cpart,recno)values('4',@accy,@proj,@cproj,@part,@cpart,@recno+1)
			set @n = @n +1
		end
		
		fetch next from cursor_table
		into @accy,@proj,@cproj,@part,@cpart,@n,@recno
	end
	close cursor_table
	deallocate cursor_table
	
	insert into #z_acbej01(gno,accy,part,stotal)
	select '5',accy,'zzz',SUM(stotal) from #z_acbej01 where gno = '3'
	group by accy 

	select LEFT(accy,3) yy,cpart,dbo.getComma(stotal,0) b13,* 
	from #z_acbej01 where gno = '3' or gno = '5'
	order by accy,part

	drop table #z_acbej01 
	drop table #z_acbej_accu;

z_acbej06:--z_acbej06	預算管制表-專案部門
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	
	declare @t_bmon nvarchar(10) = case when '#non' = [1] then ' ' else [1] end
	declare @t_emon nvarchar(10) = case when '#non' = [2] then CHAR(255) else [2] end
	declare @t_bacc1 nvarchar(20) = case when '#non' = [3] then ' ' else [3] end
	declare @t_eacc1 nvarchar(20) = case when '#non' = [4] then CHAR(255) else [4] end
	declare @t_proj nvarchar(max) = case when '#non' = [5] then ' ' else [5] end
	declare @t_part nvarchar(max) = case when '#non' = [6] then ' ' else [6] end
	--------------------------------------------------------------------------------------------
	declare @listaccc table(
		tablea nvarchar(20),
		accy nvarchar(20),
		yy nvarchar(10)
	)
	insert into @listaccc(tablea,accy,yy)
	SELECT TABLE_NAME 
	,replace(TABLE_NAME,'accc','')
	,substring(replace(TABLE_NAME,'accc',''),1,CHARINDEX('_',replace(TABLE_NAME,'accc',''))-1)
	FROM INFORMATION_SCHEMA.TABLES 
	where TABLE_NAME like 'accc[0-9][0-9][0-9]%' 
	
	delete @listaccc where not(yy between LEFT(@t_bmon,3) and LEFT(@t_emon,3))
	--------------------------------------------------------------------------------------------
	declare @tmpa table(
		accy nvarchar(10),
		proj nvarchar(20),
		cproj nvarchar(20),
		part nvarchar(20),
		cpart nvarchar(20),
		datea nvarchar(10),
		acc1 nvarchar(20),
		acc2 nvarchar(50),
		memo nvarchar(max),
		dmoney float,
		cmoney float
	)
	
	IF OBJECT_ID('tempdb..#z_acbej_accu')is not null
	BEGIN
		drop table #z_acbej_accu	
	END
	create table #z_acbej_accu(
		sel int identity(1,1),
		mon nvarchar(10),
		proj nvarchar(20),
		cproj nvarchar(20),
		part nvarchar(20),
		cpart nvarchar(20),
		acc1 nvarchar(20),
		acc2 nvarchar(50),
		[money] float
	)
	insert into #z_acbej_accu(mon,proj,cproj,part,cpart,acc1,acc2,[money])
	select b.mon,isnull(a.projno,''),isnull(a.proj,''),isnull(a.partno,''),isnull(a.part,''),a.acc1,a.acc2,a.[money]
	from accus a
	left join accu b on a.noa=b.noa
	where b.[mon] between @t_bmon and @t_emon
		and isnull(a.acc1,'') between @t_bacc1 and @t_eacc1
		 and (len(@t_proj)=0 or charindex(','+a.projno+',',','+@t_proj+',')>0)
		 and (len(@t_part)=0 or charindex(','+a.partno+',',','+@t_part+',')>0)
	---------------------------------------------------------------------------------
	declare @tablea nvarchar(20)
	declare @accy nvarchar(10)
	declare @yy nvarchar(10)
	
	declare cursor_table cursor for
	select tablea,accy,yy from @listaccc
	open cursor_table
	fetch next from cursor_table
	into @tablea,@accy,@yy
	while(@@FETCH_STATUS <> -1)
	begin		
		set @cmd ="select @accy,isnull(a.proj,''),isnull(d.proj,''),isnull(a.part,''),isnull(c.part,''),b.accc2,a.accc5,a.accc6,a.accc7,a.dmoney,a.cmoney
		 from acccs"+@accy+" a
		 left join accc"+@accy+" b on a.accc3=b.accc3
		 left join acpart"+@accy+" c on a.part=c.noa 
		 left join proj d on a.proj=d.noa
		 where exists(select top 1* from #z_acbej_accu 
			where mon=@yy+'/'+left(b.accc2,2) 
				and proj=isnull(a.proj,'')
				and part=isnull(a.part,'')
				and acc1=isnull(a.accc5,''))"
		insert into @tmpa(accy,proj,cproj,part,cpart,datea,acc1,acc2,memo,dmoney,cmoney)
		execute sp_executesql @cmd,N'@yy nvarchar(10),@accy nvarchar(10),@t_bmon nvarchar(10),@t_emon nvarchar(10),@t_bacc1 nvarchar(20),@t_eacc1 nvarchar(20),@t_proj nvarchar(max),@t_part nvarchar(max)'
		,@yy=@yy,@accy=@accy,@t_bmon=@t_bmon,@t_emon=@t_emon,@t_proj=@t_proj,@t_part=@t_part,@t_bacc1=@t_bacc1,@t_eacc1=@t_eacc1
		
		fetch next from cursor_table
		into @tablea,@accy,@yy
	end
	close cursor_table
	deallocate cursor_table
	------------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_acbej01')is not null
	BEGIN
		drop table #z_acbej01	
	END
	create table #z_acbej01(
		gno nvarchar(10),
		pno int identity(1,1),
		recno int,
		typea nvarchar(10),
		accy nvarchar(10),
		proj nvarchar(20),
		part nvarchar(20),	
		acc1 nvarchar(20),
		acc2 nvarchar(50),
		memo nvarchar(max),
		mon01 float,
		mon02 float,
		mon03 float,
		mon04 float,
		mon05 float,
		mon06 float,
		mon07 float,
		mon08 float,
		mon09 float,
		mon10 float,
		mon11 float,
		mon12 float,
		total float,
		cproj nvarchar(50),
		cpart nvarchar(50),
		smon01 float,
		smon02 float,
		smon03 float,
		smon04 float,
		smon05 float,
		smon06 float,
		smon07 float,
		smon08 float,
		smon09 float,
		smon10 float,
		smon11 float,
		smon12 float,
		stotal float
	)
	create index acc1 on #z_acbej01(accy,acc1)
	declare @field nvarchar(20)
	declare @datea nvarchar(10)
	declare @proj nvarchar(20)
	declare @part nvarchar(20)
	declare @cproj nvarchar(50)
	declare @cpart nvarchar(50)
	declare @acc1 nvarchar(20)
	declare @acc2 nvarchar(50)
	declare @memo nvarchar(max)
	declare @dmoney float
	declare @cmoney float
	
	declare cursor_table cursor for
	select accy,proj,cproj,part,cpart,datea,acc1,acc2,memo,dmoney,cmoney from @tmpa
	open cursor_table
	fetch next from cursor_table
	into @accy,@proj,@cproj,@part,@cpart,@datea,@acc1,@acc2,@memo,@dmoney,@cmoney
	while(@@FETCH_STATUS <> -1)
	begin		
		set @field = 'mon'+LEFT(@datea,2)
	
		if exists(select * from #z_acbej01 where accy=@accy and acc1=@acc1)
		begin
			set @cmd =
			" update #z_acbej01 set "+@field+"=isnull(a."+@field+",0)+case when a.typea='A' then @cmoney-@dmoney else @dmoney-@cmoney end
			  from #z_acbej01 a 
			  where accy=@accy and acc1=@acc1"
			execute sp_executesql @cmd,N'@dmoney float,@cmoney float,@accy nvarchar(10),@acc1 nvarchar(20)'
			,@accy=@accy,@acc1=@acc1,@dmoney=@dmoney,@cmoney=@cmoney
		end
		else
		begin
			set @cmd =
			" insert into #z_acbej01(gno,typea,accy,proj,cproj,part,cpart,acc1,acc2,memo,"+@field+")
			  values('1',case when left(@acc1,1)='1' or left(@acc1,1)='4' or left(@acc1,1)='7' then 'A' else 'B' end 
			  ,@accy,@proj,@cproj,@part,@cpart,@acc1,@acc2,@memo
			  ,case when left(@acc1,1)='1' or left(@acc1,1)='4' or left(@acc1,1)='7' then @cmoney-@dmoney else @dmoney-@cmoney end)"
			  
			execute sp_executesql @cmd,N'@accy nvarchar(10),@acc1 nvarchar(20),@acc2 nvarchar(50),@memo nvarchar(max),@dmoney float,@cmoney float,@part nvarchar(20),@proj nvarchar(20),@cproj nvarchar(50),@cpart nvarchar(50)'
			,@accy=@accy,@acc1=@acc1,@acc2=@acc2,@dmoney=@dmoney,@cmoney=@cmoney,@memo=@memo,@part=@part,@proj=@proj,@cproj=@cproj,@cpart=@cpart
		end
		fetch next from cursor_table
		into @accy,@proj,@cproj,@part,@cpart,@datea,@acc1,@acc2,@memo,@dmoney,@cmoney
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------- accu
	declare @mon nvarchar(10)
	declare @money float

	declare cursor_table cursor for
	select mon,proj,cproj,part,cpart,acc1,acc2,[money] from #z_acbej_accu
	open cursor_table
	fetch next from cursor_table
	into @mon,@proj,@cproj,@part,@cpart,@acc1,@acc2,@money
	while(@@FETCH_STATUS <> -1)
	begin		
		set @field = 'smon'+right(@mon,2)
	
		if exists(select * from #z_acbej01 where accy=left(@mon,3)+'_1' and acc1=@acc1)
		begin
			set @cmd =
			" update #z_acbej01 set "+@field+"=isnull(a."+@field+",0)+@money
			  from #z_acbej01 a 
			  where accy=left(@mon,3)+'_1' and acc1=@acc1"
			execute sp_executesql @cmd,N'@money float,@mon nvarchar(10),@acc1 nvarchar(20)'
			,@mon=@mon,@acc1=@acc1,@money=@money
		end
		else
		begin
			set @cmd =
			" insert into #z_acbej01(gno,typea,accy,proj,cproj,part,cpart,acc1,acc2,"+@field+")
			  values('1',case when left(@acc1,1)='4' or left(@acc1,1)='7' then 'A' else 'B' end ,left(@mon,3)+'_1',@proj,@cproj,@part,@cpart,@acc1,@acc2,@money)"
			execute sp_executesql @cmd,N'@mon nvarchar(10),@acc1 nvarchar(20),@acc2 nvarchar(50),@money float,@part nvarchar(20),@proj nvarchar(20),@cproj nvarchar(50),@cpart nvarchar(50)'
			,@mon=@mon,@acc1=@acc1,@acc2=@acc2,@money=@money,@part=@part,@proj=@proj,@cproj=@cproj,@cpart=@cpart
		end
		fetch next from cursor_table
		into @mon,@proj,@cproj,@part,@cpart,@acc1,@acc2,@money
	end
	close cursor_table
	deallocate cursor_table

	update #z_acbej01 set total = ISNULL(mon01,0)+ISNULL(mon02,0)+ISNULL(mon03,0)+ISNULL(mon04,0)
		+ISNULL(mon05,0)+ISNULL(mon06,0)+ISNULL(mon07,0)+ISNULL(mon08,0)
		+ISNULL(mon09,0)+ISNULL(mon10,0)+ISNULL(mon11,0)+ISNULL(mon12,0)
		,stotal = ISNULL(smon01,0)+ISNULL(smon02,0)+ISNULL(smon03,0)+ISNULL(smon04,0)
		+ISNULL(smon05,0)+ISNULL(smon06,0)+ISNULL(smon07,0)+ISNULL(smon08,0)
		+ISNULL(smon09,0)+ISNULL(smon10,0)+ISNULL(smon11,0)+ISNULL(smon12,0)
	insert into #z_acbej01(gno,accy,proj,cproj,part,cpart,acc1,mon01,mon02,mon03,mon04,mon05,mon06,mon07,mon08,mon09,mon10,mon11,mon12,total
		,smon01,smon02,smon03,smon04,smon05,smon06,smon07,smon08,smon09,smon10,smon11,smon12,stotal)
	select '2',accy,proj,cproj,part,cpart,LEFT(acc1,1)+CHAR(255)
		,SUM(ISNULL(mon01,0)),SUM(ISNULL(mon02,0)),SUM(ISNULL(mon03,0)),SUM(ISNULL(mon04,0)),SUM(ISNULL(mon05,0)),SUM(ISNULL(mon06,0))
		,SUM(ISNULL(mon07,0)),SUM(ISNULL(mon08,0)),SUM(ISNULL(mon09,0)),SUM(ISNULL(mon10,0)),SUM(ISNULL(mon11,0)),SUM(ISNULL(mon12,0))
		,SUM(ISNULL(total,0))
		,SUM(ISNULL(smon01,0)),SUM(ISNULL(smon02,0)),SUM(ISNULL(smon03,0)),SUM(ISNULL(smon04,0)),SUM(ISNULL(smon05,0)),SUM(ISNULL(smon06,0))
		,SUM(ISNULL(smon07,0)),SUM(ISNULL(smon08,0)),SUM(ISNULL(smon09,0)),SUM(ISNULL(smon10,0)),SUM(ISNULL(smon11,0)),SUM(ISNULL(smon12,0))
		,SUM(ISNULL(stotal,0))
	from #z_acbej01 where gno='1' group by accy,proj,cproj,part,cpart,LEFT(acc1,1) 
	
	insert into #z_acbej01(gno,accy,proj,cproj,part,cpart,acc1,mon01,mon02,mon03,mon04,mon05,mon06,mon07,mon08,mon09,mon10,mon11,mon12,total
		,smon01,smon02,smon03,smon04,smon05,smon06,smon07,smon08,smon09,smon10,smon11,smon12,stotal)
	select '3',accy,proj,cproj,part,cpart,CHAR(255)
		,SUM(ISNULL(mon01,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon02,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon03,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon04,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon05,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon06,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon07,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon08,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon09,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon10,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon11,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon12,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(total,0)*case when typea='A' then 1 else -1 end)
		
		,SUM(ISNULL(smon01,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon02,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon03,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon04,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon05,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon06,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon07,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon08,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon09,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon10,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon11,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon12,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(stotal,0)*case when typea='A' then 1 else -1 end)
	from #z_acbej01 where gno='2' group by accy,proj,cproj,part,cpart
	
	update #z_acbej01 set recno=b.recno
	from #z_acbej01 a
	left join (select pno,ROW_NUMBER()over(partition by accy,proj,part order by acc1) recno from #z_acbej01) b on a.pno=b.pno
	----------------------------------------------------------------------------------------------------
	declare @t_page int = 40
	declare @n int = 0
	declare @recno int = 0
	
	declare cursor_table cursor for
	select accy,proj,cproj,part,cpart,count(1),max(recno) from #z_acbej01 group by accy,proj,cproj,part,cpart
	open cursor_table
	fetch next from cursor_table
	into @accy,@proj,@cproj,@part,@cpart,@n,@recno
	while(@@FETCH_STATUS <> -1)
	begin		
		while @n%@t_page!=0
		begin
			insert into #z_acbej01(gno,accy,proj,cproj,part,cpart,recno)values('4',@accy,@proj,@cproj,@part,@cpart,@recno+1)
			set @n = @n +1
		end
		
		fetch next from cursor_table
		into @accy,@proj,@cproj,@part,@cpart,@n,@recno
	end
	close cursor_table
	deallocate cursor_table
	
	select *
		,dbo.getComma(mon01,0) a01 
		,dbo.getComma(mon02,0) a02 
		,dbo.getComma(mon03,0) a03 
		,dbo.getComma(mon04,0) a04 
		,dbo.getComma(mon05,0) a05 
		,dbo.getComma(mon06,0) a06 
		,dbo.getComma(mon07,0) a07 
		,dbo.getComma(mon08,0) a08 
		,dbo.getComma(mon09,0) a09 
		,dbo.getComma(mon10,0) a10 
		,dbo.getComma(mon11,0) a11 
		,dbo.getComma(mon12,0) a12
		,dbo.getComma(total,0) a13 
		
		,dbo.getComma(smon01,0) b01 
		,dbo.getComma(smon02,0) b02 
		,dbo.getComma(smon03,0) b03 
		,dbo.getComma(smon04,0) b04 
		,dbo.getComma(smon05,0) b05 
		,dbo.getComma(smon06,0) b06 
		,dbo.getComma(smon07,0) b07 
		,dbo.getComma(smon08,0) b08 
		,dbo.getComma(smon09,0) b09 
		,dbo.getComma(smon10,0) b10 
		,dbo.getComma(smon11,0) b11 
		,dbo.getComma(smon12,0) b12
		,dbo.getComma(stotal,0) b13 
		,dbo.getComma(total-stotal,0) diff 
	from #z_acbej01 
	order by accy,proj,part,recno
	drop table #z_acbej01
	drop table #z_acbej_accu;
	
z_acbej05:--z_acbej05	預算管制表-專案
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	
	declare @t_bmon nvarchar(10) = case when '#non' = [1] then ' ' else [1] end
	declare @t_emon nvarchar(10) = case when '#non' = [2] then CHAR(255) else [2] end
	declare @t_bacc1 nvarchar(20) = case when '#non' = [3] then ' ' else [3] end
	declare @t_eacc1 nvarchar(20) = case when '#non' = [4] then CHAR(255) else [4] end
	declare @t_proj nvarchar(max) = case when '#non' = [5] then ' ' else [5] end
	declare @t_part nvarchar(max) = case when '#non' = [6] then ' ' else [6] end
	--------------------------------------------------------------------------------------------
	declare @listaccc table(
		tablea nvarchar(20),
		accy nvarchar(20),
		yy nvarchar(10)
	)
	insert into @listaccc(tablea,accy,yy)
	SELECT TABLE_NAME 
	,replace(TABLE_NAME,'accc','')
	,substring(replace(TABLE_NAME,'accc',''),1,CHARINDEX('_',replace(TABLE_NAME,'accc',''))-1)
	FROM INFORMATION_SCHEMA.TABLES 
	where TABLE_NAME like 'accc[0-9][0-9][0-9]%' 
	
	delete @listaccc where not(yy between LEFT(@t_bmon,3) and LEFT(@t_emon,3))
	--------------------------------------------------------------------------------------------
	declare @tmpa table(
		accy nvarchar(10),
		proj nvarchar(20),
		cproj nvarchar(20),
		part nvarchar(20),
		cpart nvarchar(20),
		datea nvarchar(10),
		acc1 nvarchar(20),
		acc2 nvarchar(50),
		memo nvarchar(max),
		dmoney float,
		cmoney float
	)
	
	IF OBJECT_ID('tempdb..#z_acbej_accu')is not null
	BEGIN
		drop table #z_acbej_accu	
	END
	create table #z_acbej_accu(
		sel int identity(1,1),
		mon nvarchar(10),
		proj nvarchar(20),
		cproj nvarchar(20),
		part nvarchar(20),
		cpart nvarchar(20),
		acc1 nvarchar(20),
		acc2 nvarchar(50),
		[money] float
	)
	insert into #z_acbej_accu(mon,proj,cproj,part,cpart,acc1,acc2,[money])
	select b.mon,isnull(a.projno,''),isnull(a.proj,''),'','',a.acc1,a.acc2,a.[money]
	from accus a
	left join accu b on a.noa=b.noa
	where b.[mon] between @t_bmon and @t_emon
		and isnull(a.acc1,'') between @t_bacc1 and @t_eacc1
		 and (len(@t_proj)=0 or charindex(','+a.projno+',',','+@t_proj+',')>0)
	---------------------------------------------------------------------------------
	declare @tablea nvarchar(20)
	declare @accy nvarchar(10)
	declare @yy nvarchar(10)
	
	declare cursor_table cursor for
	select tablea,accy,yy from @listaccc
	open cursor_table
	fetch next from cursor_table
	into @tablea,@accy,@yy
	while(@@FETCH_STATUS <> -1)
	begin		
		set @cmd ="select @accy,isnull(a.proj,''),isnull(d.proj,''),'','',b.accc2,a.accc5,a.accc6,a.accc7,a.dmoney,a.cmoney
		 from acccs"+@accy+" a
		 left join accc"+@accy+" b on a.accc3=b.accc3
		 left join acpart"+@accy+" c on a.part=c.noa 
		 left join proj d on a.proj=d.noa
		 where exists(select top 1* from #z_acbej_accu 
			where mon=@yy+'/'+left(b.accc2,2) 
				and proj=isnull(a.proj,'')
				and acc1=isnull(a.accc5,''))"
		insert into @tmpa(accy,proj,cproj,part,cpart,datea,acc1,acc2,memo,dmoney,cmoney)
		execute sp_executesql @cmd,N'@yy nvarchar(10),@accy nvarchar(10),@t_bmon nvarchar(10),@t_emon nvarchar(10),@t_bacc1 nvarchar(20),@t_eacc1 nvarchar(20),@t_proj nvarchar(max),@t_part nvarchar(max)'
		,@yy=@yy,@accy=@accy,@t_bmon=@t_bmon,@t_emon=@t_emon,@t_proj=@t_proj,@t_part=@t_part,@t_bacc1=@t_bacc1,@t_eacc1=@t_eacc1
		
		fetch next from cursor_table
		into @tablea,@accy,@yy
	end
	close cursor_table
	deallocate cursor_table
	------------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_acbej01')is not null
	BEGIN
		drop table #z_acbej01	
	END
	create table #z_acbej01(
		gno nvarchar(10),
		pno int identity(1,1),
		recno int,
		typea nvarchar(10),
		accy nvarchar(10),
		proj nvarchar(20),
		part nvarchar(20),	
		acc1 nvarchar(20),
		acc2 nvarchar(50),
		memo nvarchar(max),
		mon01 float,
		mon02 float,
		mon03 float,
		mon04 float,
		mon05 float,
		mon06 float,
		mon07 float,
		mon08 float,
		mon09 float,
		mon10 float,
		mon11 float,
		mon12 float,
		total float,
		cproj nvarchar(50),
		cpart nvarchar(50),
		smon01 float,
		smon02 float,
		smon03 float,
		smon04 float,
		smon05 float,
		smon06 float,
		smon07 float,
		smon08 float,
		smon09 float,
		smon10 float,
		smon11 float,
		smon12 float,
		stotal float
	)
	create index acc1 on #z_acbej01(accy,acc1)
	declare @field nvarchar(20)
	declare @datea nvarchar(10)
	declare @proj nvarchar(20)
	declare @part nvarchar(20)
	declare @cproj nvarchar(50)
	declare @cpart nvarchar(50)
	declare @acc1 nvarchar(20)
	declare @acc2 nvarchar(50)
	declare @memo nvarchar(max)
	declare @dmoney float
	declare @cmoney float
	
	declare cursor_table cursor for
	select accy,proj,cproj,part,cpart,datea,acc1,acc2,memo,dmoney,cmoney from @tmpa
	open cursor_table
	fetch next from cursor_table
	into @accy,@proj,@cproj,@part,@cpart,@datea,@acc1,@acc2,@memo,@dmoney,@cmoney
	while(@@FETCH_STATUS <> -1)
	begin		
		set @field = 'mon'+LEFT(@datea,2)
	
		if exists(select * from #z_acbej01 where accy=@accy and acc1=@acc1)
		begin
			set @cmd =
			" update #z_acbej01 set "+@field+"=isnull(a."+@field+",0)+case when a.typea='A' then @cmoney-@dmoney else @dmoney-@cmoney end
			  from #z_acbej01 a 
			  where accy=@accy and acc1=@acc1"
			execute sp_executesql @cmd,N'@dmoney float,@cmoney float,@accy nvarchar(10),@acc1 nvarchar(20)'
			,@accy=@accy,@acc1=@acc1,@dmoney=@dmoney,@cmoney=@cmoney
		end
		else
		begin
			set @cmd =
			" insert into #z_acbej01(gno,typea,accy,proj,cproj,part,cpart,acc1,acc2,memo,"+@field+")
			  values('1',case when left(@acc1,1)='1' or left(@acc1,1)='4' or left(@acc1,1)='7' then 'A' else 'B' end 
			  ,@accy,@proj,@cproj,@part,@cpart,@acc1,@acc2,@memo
			  ,case when left(@acc1,1)='1' or left(@acc1,1)='4' or left(@acc1,1)='7' then @cmoney-@dmoney else @dmoney-@cmoney end)"
			  
			execute sp_executesql @cmd,N'@accy nvarchar(10),@acc1 nvarchar(20),@acc2 nvarchar(50),@memo nvarchar(max),@dmoney float,@cmoney float,@part nvarchar(20),@proj nvarchar(20),@cproj nvarchar(50),@cpart nvarchar(50)'
			,@accy=@accy,@acc1=@acc1,@acc2=@acc2,@dmoney=@dmoney,@cmoney=@cmoney,@memo=@memo,@part=@part,@proj=@proj,@cproj=@cproj,@cpart=@cpart
		end
		fetch next from cursor_table
		into @accy,@proj,@cproj,@part,@cpart,@datea,@acc1,@acc2,@memo,@dmoney,@cmoney
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------- accu
	declare @mon nvarchar(10)
	declare @money float

	declare cursor_table cursor for
	select mon,proj,cproj,part,cpart,acc1,acc2,[money] from #z_acbej_accu
	open cursor_table
	fetch next from cursor_table
	into @mon,@proj,@cproj,@part,@cpart,@acc1,@acc2,@money
	while(@@FETCH_STATUS <> -1)
	begin		
		set @field = 'smon'+right(@mon,2)
	
		if exists(select * from #z_acbej01 where accy=left(@mon,3)+'_1' and acc1=@acc1)
		begin
			set @cmd =
			" update #z_acbej01 set "+@field+"=isnull(a."+@field+",0)+@money
			  from #z_acbej01 a 
			  where accy=left(@mon,3)+'_1' and acc1=@acc1"
			execute sp_executesql @cmd,N'@money float,@mon nvarchar(10),@acc1 nvarchar(20)'
			,@mon=@mon,@acc1=@acc1,@money=@money
		end
		else
		begin
			set @cmd =
			" insert into #z_acbej01(gno,typea,accy,proj,cproj,part,cpart,acc1,acc2,"+@field+")
			  values('1',case when left(@acc1,1)='4' or left(@acc1,1)='7' then 'A' else 'B' end ,left(@mon,3)+'_1',@proj,@cproj,@part,@cpart,@acc1,@acc2,@money)"
			execute sp_executesql @cmd,N'@mon nvarchar(10),@acc1 nvarchar(20),@acc2 nvarchar(50),@money float,@part nvarchar(20),@proj nvarchar(20),@cproj nvarchar(50),@cpart nvarchar(50)'
			,@mon=@mon,@acc1=@acc1,@acc2=@acc2,@money=@money,@part=@part,@proj=@proj,@cproj=@cproj,@cpart=@cpart
		end
		fetch next from cursor_table
		into @mon,@proj,@cproj,@part,@cpart,@acc1,@acc2,@money
	end
	close cursor_table
	deallocate cursor_table

	update #z_acbej01 set total = ISNULL(mon01,0)+ISNULL(mon02,0)+ISNULL(mon03,0)+ISNULL(mon04,0)
		+ISNULL(mon05,0)+ISNULL(mon06,0)+ISNULL(mon07,0)+ISNULL(mon08,0)
		+ISNULL(mon09,0)+ISNULL(mon10,0)+ISNULL(mon11,0)+ISNULL(mon12,0)
		,stotal = ISNULL(smon01,0)+ISNULL(smon02,0)+ISNULL(smon03,0)+ISNULL(smon04,0)
		+ISNULL(smon05,0)+ISNULL(smon06,0)+ISNULL(smon07,0)+ISNULL(smon08,0)
		+ISNULL(smon09,0)+ISNULL(smon10,0)+ISNULL(smon11,0)+ISNULL(smon12,0)
	insert into #z_acbej01(gno,accy,proj,cproj,part,cpart,acc1,mon01,mon02,mon03,mon04,mon05,mon06,mon07,mon08,mon09,mon10,mon11,mon12,total
		,smon01,smon02,smon03,smon04,smon05,smon06,smon07,smon08,smon09,smon10,smon11,smon12,stotal)
	select '2',accy,proj,cproj,part,cpart,LEFT(acc1,1)+CHAR(255)
		,SUM(ISNULL(mon01,0)),SUM(ISNULL(mon02,0)),SUM(ISNULL(mon03,0)),SUM(ISNULL(mon04,0)),SUM(ISNULL(mon05,0)),SUM(ISNULL(mon06,0))
		,SUM(ISNULL(mon07,0)),SUM(ISNULL(mon08,0)),SUM(ISNULL(mon09,0)),SUM(ISNULL(mon10,0)),SUM(ISNULL(mon11,0)),SUM(ISNULL(mon12,0))
		,SUM(ISNULL(total,0))
		,SUM(ISNULL(smon01,0)),SUM(ISNULL(smon02,0)),SUM(ISNULL(smon03,0)),SUM(ISNULL(smon04,0)),SUM(ISNULL(smon05,0)),SUM(ISNULL(smon06,0))
		,SUM(ISNULL(smon07,0)),SUM(ISNULL(smon08,0)),SUM(ISNULL(smon09,0)),SUM(ISNULL(smon10,0)),SUM(ISNULL(smon11,0)),SUM(ISNULL(smon12,0))
		,SUM(ISNULL(stotal,0))
	from #z_acbej01 where gno='1' group by accy,proj,cproj,part,cpart,LEFT(acc1,1) 
	
	insert into #z_acbej01(gno,accy,proj,cproj,part,cpart,acc1,mon01,mon02,mon03,mon04,mon05,mon06,mon07,mon08,mon09,mon10,mon11,mon12,total
		,smon01,smon02,smon03,smon04,smon05,smon06,smon07,smon08,smon09,smon10,smon11,smon12,stotal)
	select '3',accy,proj,cproj,part,cpart,CHAR(255)
		,SUM(ISNULL(mon01,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon02,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon03,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon04,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon05,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon06,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon07,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon08,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon09,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon10,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon11,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon12,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(total,0)*case when typea='A' then 1 else -1 end)
		
		,SUM(ISNULL(smon01,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon02,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon03,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon04,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon05,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon06,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon07,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon08,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon09,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon10,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon11,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon12,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(stotal,0)*case when typea='A' then 1 else -1 end)
	from #z_acbej01 where gno='2' group by accy,proj,cproj,part,cpart
	
	update #z_acbej01 set recno=b.recno
	from #z_acbej01 a
	left join (select pno,ROW_NUMBER()over(partition by accy,proj,part order by acc1) recno from #z_acbej01) b on a.pno=b.pno
	----------------------------------------------------------------------------------------------------
	declare @t_page int = 40
	declare @n int = 0
	declare @recno int = 0
	
	declare cursor_table cursor for
	select accy,proj,cproj,part,cpart,count(1),max(recno) from #z_acbej01 group by accy,proj,cproj,part,cpart
	open cursor_table
	fetch next from cursor_table
	into @accy,@proj,@cproj,@part,@cpart,@n,@recno
	while(@@FETCH_STATUS <> -1)
	begin		
		while @n%@t_page!=0
		begin
			insert into #z_acbej01(gno,accy,proj,cproj,part,cpart,recno)values('4',@accy,@proj,@cproj,@part,@cpart,@recno+1)
			set @n = @n +1
		end
		
		fetch next from cursor_table
		into @accy,@proj,@cproj,@part,@cpart,@n,@recno
	end
	close cursor_table
	deallocate cursor_table
	
	select *
		,dbo.getComma(mon01,0) a01 
		,dbo.getComma(mon02,0) a02 
		,dbo.getComma(mon03,0) a03 
		,dbo.getComma(mon04,0) a04 
		,dbo.getComma(mon05,0) a05 
		,dbo.getComma(mon06,0) a06 
		,dbo.getComma(mon07,0) a07 
		,dbo.getComma(mon08,0) a08 
		,dbo.getComma(mon09,0) a09 
		,dbo.getComma(mon10,0) a10 
		,dbo.getComma(mon11,0) a11 
		,dbo.getComma(mon12,0) a12
		,dbo.getComma(total,0) a13 
		
		,dbo.getComma(smon01,0) b01 
		,dbo.getComma(smon02,0) b02 
		,dbo.getComma(smon03,0) b03 
		,dbo.getComma(smon04,0) b04 
		,dbo.getComma(smon05,0) b05 
		,dbo.getComma(smon06,0) b06 
		,dbo.getComma(smon07,0) b07 
		,dbo.getComma(smon08,0) b08 
		,dbo.getComma(smon09,0) b09 
		,dbo.getComma(smon10,0) b10 
		,dbo.getComma(smon11,0) b11 
		,dbo.getComma(smon12,0) b12
		,dbo.getComma(stotal,0) b13 
		,dbo.getComma(total-stotal,0) diff 
	from #z_acbej01 
	order by accy,proj,part,recno
	drop table #z_acbej01
	drop table #z_acbej_accu;

z_acbej04:--z_acbej04	預算管制表-部門
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	
	declare @t_bmon nvarchar(10) = case when '#non' = [1] then ' ' else [1] end
	declare @t_emon nvarchar(10) = case when '#non' = [2] then CHAR(255) else [2] end
	declare @t_bacc1 nvarchar(20) = case when '#non' = [3] then ' ' else [3] end
	declare @t_eacc1 nvarchar(20) = case when '#non' = [4] then CHAR(255) else [4] end
	declare @t_proj nvarchar(max) = case when '#non' = [5] then ' ' else [5] end
	declare @t_part nvarchar(max) = case when '#non' = [6] then ' ' else [6] end
	--------------------------------------------------------------------------------------------
	declare @listaccc table(
		tablea nvarchar(20),
		accy nvarchar(20),
		yy nvarchar(10)
	)
	insert into @listaccc(tablea,accy,yy)
	SELECT TABLE_NAME 
	,replace(TABLE_NAME,'accc','')
	,substring(replace(TABLE_NAME,'accc',''),1,CHARINDEX('_',replace(TABLE_NAME,'accc',''))-1)
	FROM INFORMATION_SCHEMA.TABLES 
	where TABLE_NAME like 'accc[0-9][0-9][0-9]%' 
	
	delete @listaccc where not(yy between LEFT(@t_bmon,3) and LEFT(@t_emon,3))
	--------------------------------------------------------------------------------------------
	declare @tmpa table(
		accy nvarchar(10),
		proj nvarchar(20),
		cproj nvarchar(20),
		part nvarchar(20),
		cpart nvarchar(20),
		datea nvarchar(10),
		acc1 nvarchar(20),
		acc2 nvarchar(50),
		memo nvarchar(max),
		dmoney float,
		cmoney float
	)
	
	IF OBJECT_ID('tempdb..#z_acbej_accu')is not null
	BEGIN
		drop table #z_acbej_accu	
	END
	create table #z_acbej_accu(
		sel int identity(1,1),
		mon nvarchar(10),
		proj nvarchar(20),
		cproj nvarchar(20),
		part nvarchar(20),
		cpart nvarchar(20),
		acc1 nvarchar(20),
		acc2 nvarchar(50),
		[money] float
	)
	insert into #z_acbej_accu(mon,proj,cproj,part,cpart,acc1,acc2,[money])
	select b.mon,'','',isnull(a.partno,''),isnull(a.part,''),a.acc1,a.acc2,a.[money]
	from accus a
	left join accu b on a.noa=b.noa
	where b.[mon] between @t_bmon and @t_emon
		and isnull(a.acc1,'') between @t_bacc1 and @t_eacc1
		 and (len(@t_part)=0 or charindex(','+a.partno+',',','+@t_part+',')>0)
	---------------------------------------------------------------------------------
	declare @tablea nvarchar(20)
	declare @accy nvarchar(10)
	declare @yy nvarchar(10)
	
	declare cursor_table cursor for
	select tablea,accy,yy from @listaccc
	open cursor_table
	fetch next from cursor_table
	into @tablea,@accy,@yy
	while(@@FETCH_STATUS <> -1)
	begin		
		set @cmd ="select @accy,'','',isnull(a.part,''),isnull(c.part,''),b.accc2,a.accc5,a.accc6,a.accc7,a.dmoney,a.cmoney
		 from acccs"+@accy+" a
		 left join accc"+@accy+" b on a.accc3=b.accc3
		 left join acpart"+@accy+" c on a.part=c.noa 
		 left join proj d on a.proj=d.noa
		 where exists(select top 1* from #z_acbej_accu 
			where mon=@yy+'/'+left(b.accc2,2) 
				and part=isnull(a.part,'')
				and acc1=isnull(a.accc5,''))"
		insert into @tmpa(accy,proj,cproj,part,cpart,datea,acc1,acc2,memo,dmoney,cmoney)
		execute sp_executesql @cmd,N'@yy nvarchar(10),@accy nvarchar(10),@t_bmon nvarchar(10),@t_emon nvarchar(10),@t_bacc1 nvarchar(20),@t_eacc1 nvarchar(20),@t_proj nvarchar(max),@t_part nvarchar(max)'
		,@yy=@yy,@accy=@accy,@t_bmon=@t_bmon,@t_emon=@t_emon,@t_proj=@t_proj,@t_part=@t_part,@t_bacc1=@t_bacc1,@t_eacc1=@t_eacc1
		
		fetch next from cursor_table
		into @tablea,@accy,@yy
	end
	close cursor_table
	deallocate cursor_table
	------------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_acbej01')is not null
	BEGIN
		drop table #z_acbej01	
	END
	create table #z_acbej01(
		gno nvarchar(10),
		pno int identity(1,1),
		recno int,
		typea nvarchar(10),
		accy nvarchar(10),
		proj nvarchar(20),
		part nvarchar(20),	
		acc1 nvarchar(20),
		acc2 nvarchar(50),
		memo nvarchar(max),
		mon01 float,
		mon02 float,
		mon03 float,
		mon04 float,
		mon05 float,
		mon06 float,
		mon07 float,
		mon08 float,
		mon09 float,
		mon10 float,
		mon11 float,
		mon12 float,
		total float,
		cproj nvarchar(50),
		cpart nvarchar(50),
		smon01 float,
		smon02 float,
		smon03 float,
		smon04 float,
		smon05 float,
		smon06 float,
		smon07 float,
		smon08 float,
		smon09 float,
		smon10 float,
		smon11 float,
		smon12 float,
		stotal float
	)
	create index acc1 on #z_acbej01(accy,acc1)
	declare @field nvarchar(20)
	declare @datea nvarchar(10)
	declare @proj nvarchar(20)
	declare @part nvarchar(20)
	declare @cproj nvarchar(50)
	declare @cpart nvarchar(50)
	declare @acc1 nvarchar(20)
	declare @acc2 nvarchar(50)
	declare @memo nvarchar(max)
	declare @dmoney float
	declare @cmoney float
	
	declare cursor_table cursor for
	select accy,proj,cproj,part,cpart,datea,acc1,acc2,memo,dmoney,cmoney from @tmpa
	open cursor_table
	fetch next from cursor_table
	into @accy,@proj,@cproj,@part,@cpart,@datea,@acc1,@acc2,@memo,@dmoney,@cmoney
	while(@@FETCH_STATUS <> -1)
	begin		
		set @field = 'mon'+LEFT(@datea,2)
	
		if exists(select * from #z_acbej01 where accy=@accy and acc1=@acc1)
		begin
			set @cmd =
			" update #z_acbej01 set "+@field+"=isnull(a."+@field+",0)+case when a.typea='A' then @cmoney-@dmoney else @dmoney-@cmoney end
			  from #z_acbej01 a 
			  where accy=@accy and acc1=@acc1"
			execute sp_executesql @cmd,N'@dmoney float,@cmoney float,@accy nvarchar(10),@acc1 nvarchar(20)'
			,@accy=@accy,@acc1=@acc1,@dmoney=@dmoney,@cmoney=@cmoney
		end
		else
		begin
			set @cmd =
			" insert into #z_acbej01(gno,typea,accy,proj,cproj,part,cpart,acc1,acc2,memo,"+@field+")
			  values('1',case when left(@acc1,1)='1' or left(@acc1,1)='4' or left(@acc1,1)='7' then 'A' else 'B' end 
			  ,@accy,@proj,@cproj,@part,@cpart,@acc1,@acc2,@memo
			  ,case when left(@acc1,1)='1' or left(@acc1,1)='4' or left(@acc1,1)='7' then @cmoney-@dmoney else @dmoney-@cmoney end)"
			  
			execute sp_executesql @cmd,N'@accy nvarchar(10),@acc1 nvarchar(20),@acc2 nvarchar(50),@memo nvarchar(max),@dmoney float,@cmoney float,@part nvarchar(20),@proj nvarchar(20),@cproj nvarchar(50),@cpart nvarchar(50)'
			,@accy=@accy,@acc1=@acc1,@acc2=@acc2,@dmoney=@dmoney,@cmoney=@cmoney,@memo=@memo,@part=@part,@proj=@proj,@cproj=@cproj,@cpart=@cpart
		end
		fetch next from cursor_table
		into @accy,@proj,@cproj,@part,@cpart,@datea,@acc1,@acc2,@memo,@dmoney,@cmoney
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------- accu
	declare @mon nvarchar(10)
	declare @money float

	declare cursor_table cursor for
	select mon,proj,cproj,part,cpart,acc1,acc2,[money] from #z_acbej_accu
	open cursor_table
	fetch next from cursor_table
	into @mon,@proj,@cproj,@part,@cpart,@acc1,@acc2,@money
	while(@@FETCH_STATUS <> -1)
	begin		
		set @field = 'smon'+right(@mon,2)
	
		if exists(select * from #z_acbej01 where accy=left(@mon,3)+'_1' and acc1=@acc1)
		begin
			set @cmd =
			" update #z_acbej01 set "+@field+"=isnull(a."+@field+",0)+@money
			  from #z_acbej01 a 
			  where accy=left(@mon,3)+'_1' and acc1=@acc1"
			execute sp_executesql @cmd,N'@money float,@mon nvarchar(10),@acc1 nvarchar(20)'
			,@mon=@mon,@acc1=@acc1,@money=@money
		end
		else
		begin
			set @cmd =
			" insert into #z_acbej01(gno,typea,accy,proj,cproj,part,cpart,acc1,acc2,"+@field+")
			  values('1',case when left(@acc1,1)='4' or left(@acc1,1)='7' then 'A' else 'B' end ,left(@mon,3)+'_1',@proj,@cproj,@part,@cpart,@acc1,@acc2,@money)"
			execute sp_executesql @cmd,N'@mon nvarchar(10),@acc1 nvarchar(20),@acc2 nvarchar(50),@money float,@part nvarchar(20),@proj nvarchar(20),@cproj nvarchar(50),@cpart nvarchar(50)'
			,@mon=@mon,@acc1=@acc1,@acc2=@acc2,@money=@money,@part=@part,@proj=@proj,@cproj=@cproj,@cpart=@cpart
		end
		fetch next from cursor_table
		into @mon,@proj,@cproj,@part,@cpart,@acc1,@acc2,@money
	end
	close cursor_table
	deallocate cursor_table

	update #z_acbej01 set total = ISNULL(mon01,0)+ISNULL(mon02,0)+ISNULL(mon03,0)+ISNULL(mon04,0)
		+ISNULL(mon05,0)+ISNULL(mon06,0)+ISNULL(mon07,0)+ISNULL(mon08,0)
		+ISNULL(mon09,0)+ISNULL(mon10,0)+ISNULL(mon11,0)+ISNULL(mon12,0)
		,stotal = ISNULL(smon01,0)+ISNULL(smon02,0)+ISNULL(smon03,0)+ISNULL(smon04,0)
		+ISNULL(smon05,0)+ISNULL(smon06,0)+ISNULL(smon07,0)+ISNULL(smon08,0)
		+ISNULL(smon09,0)+ISNULL(smon10,0)+ISNULL(smon11,0)+ISNULL(smon12,0)
	insert into #z_acbej01(gno,accy,proj,cproj,part,cpart,acc1,mon01,mon02,mon03,mon04,mon05,mon06,mon07,mon08,mon09,mon10,mon11,mon12,total
		,smon01,smon02,smon03,smon04,smon05,smon06,smon07,smon08,smon09,smon10,smon11,smon12,stotal)
	select '2',accy,proj,cproj,part,cpart,LEFT(acc1,1)+CHAR(255)
		,SUM(ISNULL(mon01,0)),SUM(ISNULL(mon02,0)),SUM(ISNULL(mon03,0)),SUM(ISNULL(mon04,0)),SUM(ISNULL(mon05,0)),SUM(ISNULL(mon06,0))
		,SUM(ISNULL(mon07,0)),SUM(ISNULL(mon08,0)),SUM(ISNULL(mon09,0)),SUM(ISNULL(mon10,0)),SUM(ISNULL(mon11,0)),SUM(ISNULL(mon12,0))
		,SUM(ISNULL(total,0))
		,SUM(ISNULL(smon01,0)),SUM(ISNULL(smon02,0)),SUM(ISNULL(smon03,0)),SUM(ISNULL(smon04,0)),SUM(ISNULL(smon05,0)),SUM(ISNULL(smon06,0))
		,SUM(ISNULL(smon07,0)),SUM(ISNULL(smon08,0)),SUM(ISNULL(smon09,0)),SUM(ISNULL(smon10,0)),SUM(ISNULL(smon11,0)),SUM(ISNULL(smon12,0))
		,SUM(ISNULL(stotal,0))
	from #z_acbej01 where gno='1' group by accy,proj,cproj,part,cpart,LEFT(acc1,1) 
	
	insert into #z_acbej01(gno,accy,proj,cproj,part,cpart,acc1,mon01,mon02,mon03,mon04,mon05,mon06,mon07,mon08,mon09,mon10,mon11,mon12,total
		,smon01,smon02,smon03,smon04,smon05,smon06,smon07,smon08,smon09,smon10,smon11,smon12,stotal)
	select '3',accy,proj,cproj,part,cpart,CHAR(255)
		,SUM(ISNULL(mon01,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon02,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon03,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon04,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon05,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon06,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon07,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon08,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon09,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon10,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon11,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon12,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(total,0)*case when typea='A' then 1 else -1 end)
		
		,SUM(ISNULL(smon01,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon02,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon03,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon04,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon05,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon06,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon07,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon08,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon09,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon10,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon11,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon12,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(stotal,0)*case when typea='A' then 1 else -1 end)
	from #z_acbej01 where gno='2' group by accy,proj,cproj,part,cpart
	
	update #z_acbej01 set recno=b.recno
	from #z_acbej01 a
	left join (select pno,ROW_NUMBER()over(partition by accy,proj,part order by acc1) recno from #z_acbej01) b on a.pno=b.pno
	----------------------------------------------------------------------------------------------------
	declare @t_page int = 40
	declare @n int = 0
	declare @recno int = 0
	
	declare cursor_table cursor for
	select accy,proj,cproj,part,cpart,count(1),max(recno) from #z_acbej01 group by accy,proj,cproj,part,cpart
	open cursor_table
	fetch next from cursor_table
	into @accy,@proj,@cproj,@part,@cpart,@n,@recno
	while(@@FETCH_STATUS <> -1)
	begin		
		while @n%@t_page!=0
		begin
			insert into #z_acbej01(gno,accy,proj,cproj,part,cpart,recno)values('4',@accy,@proj,@cproj,@part,@cpart,@recno+1)
			set @n = @n +1
		end
		
		fetch next from cursor_table
		into @accy,@proj,@cproj,@part,@cpart,@n,@recno
	end
	close cursor_table
	deallocate cursor_table
	
	select *
		,dbo.getComma(mon01,0) a01 
		,dbo.getComma(mon02,0) a02 
		,dbo.getComma(mon03,0) a03 
		,dbo.getComma(mon04,0) a04 
		,dbo.getComma(mon05,0) a05 
		,dbo.getComma(mon06,0) a06 
		,dbo.getComma(mon07,0) a07 
		,dbo.getComma(mon08,0) a08 
		,dbo.getComma(mon09,0) a09 
		,dbo.getComma(mon10,0) a10 
		,dbo.getComma(mon11,0) a11 
		,dbo.getComma(mon12,0) a12
		,dbo.getComma(total,0) a13 
		
		,dbo.getComma(smon01,0) b01 
		,dbo.getComma(smon02,0) b02 
		,dbo.getComma(smon03,0) b03 
		,dbo.getComma(smon04,0) b04 
		,dbo.getComma(smon05,0) b05 
		,dbo.getComma(smon06,0) b06 
		,dbo.getComma(smon07,0) b07 
		,dbo.getComma(smon08,0) b08 
		,dbo.getComma(smon09,0) b09 
		,dbo.getComma(smon10,0) b10 
		,dbo.getComma(smon11,0) b11 
		,dbo.getComma(smon12,0) b12
		,dbo.getComma(stotal,0) b13 
		,dbo.getComma(total-stotal,0) diff 
	from #z_acbej01 
	order by accy,proj,part,recno
	drop table #z_acbej01
	drop table #z_acbej_accu;

z_acbej03:--z_acbej03	預算總表-專案部門
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	
	declare @t_bmon nvarchar(10) = case when '#non' = [1] then ' ' else [1] end
	declare @t_emon nvarchar(10) = case when '#non' = [2] then CHAR(255) else [2] end
	declare @t_bacc1 nvarchar(20) = case when '#non' = [3] then ' ' else [3] end
	declare @t_eacc1 nvarchar(20) = case when '#non' = [4] then CHAR(255) else [4] end
	declare @t_proj nvarchar(max) = case when '#non' = [5] then ' ' else [5] end
	declare @t_part nvarchar(max) = case when '#non' = [6] then ' ' else [6] end
	--------------------------------------------------------------------------------------------
	declare @listaccc table(
		tablea nvarchar(20),
		accy nvarchar(20),
		yy nvarchar(10)
	)
	--------------------------------------------------------------------------------------------
	declare @tmpa table(
		accy nvarchar(10),
		proj nvarchar(20),
		cproj nvarchar(20),
		part nvarchar(20),
		cpart nvarchar(20),
		datea nvarchar(10),
		acc1 nvarchar(20),
		acc2 nvarchar(50),
		memo nvarchar(max),
		dmoney float,
		cmoney float
	)
	
	IF OBJECT_ID('tempdb..#z_acbej_accu')is not null
	BEGIN
		drop table #z_acbej_accu	
	END
	create table #z_acbej_accu(
		sel int identity(1,1),
		mon nvarchar(10),
		proj nvarchar(20),
		cproj nvarchar(20),
		part nvarchar(20),
		cpart nvarchar(20),
		acc1 nvarchar(20),
		acc2 nvarchar(50),
		[money] float
	)
	insert into #z_acbej_accu(mon,proj,cproj,part,cpart,acc1,acc2,[money])
	select b.mon,isnull(a.projno,''),isnull(a.proj,''),isnull(a.partno,''),isnull(a.part,''),a.acc1,a.acc2,a.[money]
	from accus a
	left join accu b on a.noa=b.noa
	where b.[mon] between @t_bmon and @t_emon
		and isnull(a.acc1,'') between @t_bacc1 and @t_eacc1
		 and (len(@t_proj)=0 or charindex(','+a.projno+',',','+@t_proj+',')>0)
		 and (len(@t_part)=0 or charindex(','+a.partno+',',','+@t_part+',')>0)
	---------------------------------------------------------------------------------
	declare @tablea nvarchar(20)
	declare @accy nvarchar(10)
	declare @yy nvarchar(10)
	
	declare cursor_table cursor for
	select tablea,accy,yy from @listaccc
	open cursor_table
	fetch next from cursor_table
	into @tablea,@accy,@yy
	while(@@FETCH_STATUS <> -1)
	begin		
		set @cmd ="select @accy,isnull(a.proj,''),isnull(d.proj,''),isnull(a.part,''),isnull(c.part,''),b.accc2,a.accc5,a.accc6,a.accc7,a.dmoney,a.cmoney
		 from acccs"+@accy+" a
		 left join accc"+@accy+" b on a.accc3=b.accc3
		 left join acpart"+@accy+" c on a.part=c.noa 
		 left join proj d on a.proj=d.noa
		 where exists(select top 1* from #z_acbej_accu 
			where mon=@yy+'/'+left(b.accc2,2) 
				and proj=isnull(a.proj,'')
				and part=isnull(a.part,'')
				and acc1=isnull(a.accc5,''))"
		insert into @tmpa(accy,proj,cproj,part,cpart,datea,acc1,acc2,memo,dmoney,cmoney)
		execute sp_executesql @cmd,N'@yy nvarchar(10),@accy nvarchar(10),@t_bmon nvarchar(10),@t_emon nvarchar(10),@t_bacc1 nvarchar(20),@t_eacc1 nvarchar(20),@t_proj nvarchar(max),@t_part nvarchar(max)'
		,@yy=@yy,@accy=@accy,@t_bmon=@t_bmon,@t_emon=@t_emon,@t_proj=@t_proj,@t_part=@t_part,@t_bacc1=@t_bacc1,@t_eacc1=@t_eacc1
		
		fetch next from cursor_table
		into @tablea,@accy,@yy
	end
	close cursor_table
	deallocate cursor_table
	------------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_acbej01')is not null
	BEGIN
		drop table #z_acbej01	
	END
	create table #z_acbej01(
		gno nvarchar(10),
		pno int identity(1,1),
		recno int,
		typea nvarchar(10),
		accy nvarchar(10),
		proj nvarchar(20),
		part nvarchar(20),	
		acc1 nvarchar(20),
		acc2 nvarchar(50),
		memo nvarchar(max),
		mon01 float,
		mon02 float,
		mon03 float,
		mon04 float,
		mon05 float,
		mon06 float,
		mon07 float,
		mon08 float,
		mon09 float,
		mon10 float,
		mon11 float,
		mon12 float,
		total float,
		cproj nvarchar(50),
		cpart nvarchar(50),
		smon01 float,
		smon02 float,
		smon03 float,
		smon04 float,
		smon05 float,
		smon06 float,
		smon07 float,
		smon08 float,
		smon09 float,
		smon10 float,
		smon11 float,
		smon12 float,
		stotal float
	)
	create index acc1 on #z_acbej01(accy,acc1)
	declare @field nvarchar(20)
	declare @datea nvarchar(10)
	declare @proj nvarchar(20)
	declare @part nvarchar(20)
	declare @cproj nvarchar(50)
	declare @cpart nvarchar(50)
	declare @acc1 nvarchar(20)
	declare @acc2 nvarchar(50)
	declare @memo nvarchar(max)
	declare @dmoney float
	declare @cmoney float
	
	declare cursor_table cursor for
	select accy,proj,cproj,part,cpart,datea,acc1,acc2,memo,dmoney,cmoney from @tmpa
	open cursor_table
	fetch next from cursor_table
	into @accy,@proj,@cproj,@part,@cpart,@datea,@acc1,@acc2,@memo,@dmoney,@cmoney
	while(@@FETCH_STATUS <> -1)
	begin		
		set @field = 'mon'+LEFT(@datea,2)
	
		if exists(select * from #z_acbej01 where accy=@accy and acc1=@acc1)
		begin
			set @cmd =
			" update #z_acbej01 set "+@field+"=isnull(a."+@field+",0)+case when a.typea='A' then @cmoney-@dmoney else @dmoney-@cmoney end
			  from #z_acbej01 a 
			  where accy=@accy and acc1=@acc1"
			execute sp_executesql @cmd,N'@dmoney float,@cmoney float,@accy nvarchar(10),@acc1 nvarchar(20)'
			,@accy=@accy,@acc1=@acc1,@dmoney=@dmoney,@cmoney=@cmoney
		end
		else
		begin
			set @cmd =
			" insert into #z_acbej01(gno,typea,accy,proj,cproj,part,cpart,acc1,acc2,memo,"+@field+")
			  values('1',case when left(@acc1,1)='1' or left(@acc1,1)='4' or left(@acc1,1)='7' then 'A' else 'B' end 
			  ,@accy,@proj,@cproj,@part,@cpart,@acc1,@acc2,@memo
			  ,case when left(@acc1,1)='1' or left(@acc1,1)='4' or left(@acc1,1)='7' then @cmoney-@dmoney else @dmoney-@cmoney end)"
			  
			execute sp_executesql @cmd,N'@accy nvarchar(10),@acc1 nvarchar(20),@acc2 nvarchar(50),@memo nvarchar(max),@dmoney float,@cmoney float,@part nvarchar(20),@proj nvarchar(20),@cproj nvarchar(50),@cpart nvarchar(50)'
			,@accy=@accy,@acc1=@acc1,@acc2=@acc2,@dmoney=@dmoney,@cmoney=@cmoney,@memo=@memo,@part=@part,@proj=@proj,@cproj=@cproj,@cpart=@cpart
		end
		fetch next from cursor_table
		into @accy,@proj,@cproj,@part,@cpart,@datea,@acc1,@acc2,@memo,@dmoney,@cmoney
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------- accu
	declare @mon nvarchar(10)
	declare @money float

	declare cursor_table cursor for
	select mon,proj,cproj,part,cpart,acc1,acc2,[money] from #z_acbej_accu
	open cursor_table
	fetch next from cursor_table
	into @mon,@proj,@cproj,@part,@cpart,@acc1,@acc2,@money
	while(@@FETCH_STATUS <> -1)
	begin		
		set @field = 'smon'+right(@mon,2)
	
		if exists(select * from #z_acbej01 where accy=left(@mon,3)+'_1' and acc1=@acc1)
		begin
			set @cmd =
			" update #z_acbej01 set "+@field+"=isnull(a."+@field+",0)+@money
			  from #z_acbej01 a 
			  where accy=left(@mon,3)+'_1' and acc1=@acc1"
			execute sp_executesql @cmd,N'@money float,@mon nvarchar(10),@acc1 nvarchar(20)'
			,@mon=@mon,@acc1=@acc1,@money=@money
		end
		else
		begin
			set @cmd =
			" insert into #z_acbej01(gno,typea,accy,proj,cproj,part,cpart,acc1,acc2,"+@field+")
			  values('1',case when left(@acc1,1)='4' or left(@acc1,1)='7' then 'A' else 'B' end ,left(@mon,3)+'_1',@proj,@cproj,@part,@cpart,@acc1,@acc2,@money)"
			execute sp_executesql @cmd,N'@mon nvarchar(10),@acc1 nvarchar(20),@acc2 nvarchar(50),@money float,@part nvarchar(20),@proj nvarchar(20),@cproj nvarchar(50),@cpart nvarchar(50)'
			,@mon=@mon,@acc1=@acc1,@acc2=@acc2,@money=@money,@part=@part,@proj=@proj,@cproj=@cproj,@cpart=@cpart
		end
		fetch next from cursor_table
		into @mon,@proj,@cproj,@part,@cpart,@acc1,@acc2,@money
	end
	close cursor_table
	deallocate cursor_table

	update #z_acbej01 set total = ISNULL(mon01,0)+ISNULL(mon02,0)+ISNULL(mon03,0)+ISNULL(mon04,0)
		+ISNULL(mon05,0)+ISNULL(mon06,0)+ISNULL(mon07,0)+ISNULL(mon08,0)
		+ISNULL(mon09,0)+ISNULL(mon10,0)+ISNULL(mon11,0)+ISNULL(mon12,0)
		,stotal = ISNULL(smon01,0)+ISNULL(smon02,0)+ISNULL(smon03,0)+ISNULL(smon04,0)
		+ISNULL(smon05,0)+ISNULL(smon06,0)+ISNULL(smon07,0)+ISNULL(smon08,0)
		+ISNULL(smon09,0)+ISNULL(smon10,0)+ISNULL(smon11,0)+ISNULL(smon12,0)
	insert into #z_acbej01(gno,accy,proj,cproj,part,cpart,acc1,mon01,mon02,mon03,mon04,mon05,mon06,mon07,mon08,mon09,mon10,mon11,mon12,total
		,smon01,smon02,smon03,smon04,smon05,smon06,smon07,smon08,smon09,smon10,smon11,smon12,stotal)
	select '2',accy,proj,cproj,part,cpart,LEFT(acc1,1)+CHAR(255)
		,SUM(ISNULL(mon01,0)),SUM(ISNULL(mon02,0)),SUM(ISNULL(mon03,0)),SUM(ISNULL(mon04,0)),SUM(ISNULL(mon05,0)),SUM(ISNULL(mon06,0))
		,SUM(ISNULL(mon07,0)),SUM(ISNULL(mon08,0)),SUM(ISNULL(mon09,0)),SUM(ISNULL(mon10,0)),SUM(ISNULL(mon11,0)),SUM(ISNULL(mon12,0))
		,SUM(ISNULL(total,0))
		,SUM(ISNULL(smon01,0)),SUM(ISNULL(smon02,0)),SUM(ISNULL(smon03,0)),SUM(ISNULL(smon04,0)),SUM(ISNULL(smon05,0)),SUM(ISNULL(smon06,0))
		,SUM(ISNULL(smon07,0)),SUM(ISNULL(smon08,0)),SUM(ISNULL(smon09,0)),SUM(ISNULL(smon10,0)),SUM(ISNULL(smon11,0)),SUM(ISNULL(smon12,0))
		,SUM(ISNULL(stotal,0))
	from #z_acbej01 where gno='1' group by accy,proj,cproj,part,cpart,LEFT(acc1,1) 
	
	insert into #z_acbej01(gno,accy,proj,cproj,part,cpart,acc1,mon01,mon02,mon03,mon04,mon05,mon06,mon07,mon08,mon09,mon10,mon11,mon12,total
		,smon01,smon02,smon03,smon04,smon05,smon06,smon07,smon08,smon09,smon10,smon11,smon12,stotal)
	select '3',accy,proj,cproj,part,cpart,CHAR(255)
		,SUM(ISNULL(mon01,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon02,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon03,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon04,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon05,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon06,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon07,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon08,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon09,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon10,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon11,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon12,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(total,0)*case when typea='A' then 1 else -1 end)
		
		,SUM(ISNULL(smon01,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon02,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon03,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon04,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon05,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon06,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon07,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon08,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon09,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon10,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon11,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon12,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(stotal,0)*case when typea='A' then 1 else -1 end)
	from #z_acbej01 where gno='2' group by accy,proj,cproj,part,cpart
	
	update #z_acbej01 set recno=b.recno
	from #z_acbej01 a
	left join (select pno,ROW_NUMBER()over(partition by accy,proj,part order by acc1) recno from #z_acbej01) b on a.pno=b.pno
	----------------------------------------------------------------------------------------------------
	declare @t_page int = 40
	declare @n int = 0
	declare @recno int = 0
	
	declare cursor_table cursor for
	select accy,proj,cproj,part,cpart,count(1),max(recno) from #z_acbej01 group by accy,proj,cproj,part,cpart
	open cursor_table
	fetch next from cursor_table
	into @accy,@proj,@cproj,@part,@cpart,@n,@recno
	while(@@FETCH_STATUS <> -1)
	begin		
		while @n%@t_page!=0
		begin
			insert into #z_acbej01(gno,accy,proj,cproj,part,cpart,recno)values('4',@accy,@proj,@cproj,@part,@cpart,@recno+1)
			set @n = @n +1
		end
		
		fetch next from cursor_table
		into @accy,@proj,@cproj,@part,@cpart,@n,@recno
	end
	close cursor_table
	deallocate cursor_table
	
	select *
		,dbo.getComma(mon01,0) a01 
		,dbo.getComma(mon02,0) a02 
		,dbo.getComma(mon03,0) a03 
		,dbo.getComma(mon04,0) a04 
		,dbo.getComma(mon05,0) a05 
		,dbo.getComma(mon06,0) a06 
		,dbo.getComma(mon07,0) a07 
		,dbo.getComma(mon08,0) a08 
		,dbo.getComma(mon09,0) a09 
		,dbo.getComma(mon10,0) a10 
		,dbo.getComma(mon11,0) a11 
		,dbo.getComma(mon12,0) a12
		,dbo.getComma(total,0) a13 
		
		,dbo.getComma(smon01,0) b01 
		,dbo.getComma(smon02,0) b02 
		,dbo.getComma(smon03,0) b03 
		,dbo.getComma(smon04,0) b04 
		,dbo.getComma(smon05,0) b05 
		,dbo.getComma(smon06,0) b06 
		,dbo.getComma(smon07,0) b07 
		,dbo.getComma(smon08,0) b08 
		,dbo.getComma(smon09,0) b09 
		,dbo.getComma(smon10,0) b10 
		,dbo.getComma(smon11,0) b11 
		,dbo.getComma(smon12,0) b12
		,dbo.getComma(stotal,0) b13 
		,dbo.getComma(total-stotal,0) diff 
	from #z_acbej01 
	order by accy,proj,part,recno
	drop table #z_acbej01
	drop table #z_acbej_accu;
	
z_acbej02:--z_acbej02	預算總表-專案
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	
	declare @t_bmon nvarchar(10) = case when '#non' = [1] then ' ' else [1] end
	declare @t_emon nvarchar(10) = case when '#non' = [2] then CHAR(255) else [2] end
	declare @t_bacc1 nvarchar(20) = case when '#non' = [3] then ' ' else [3] end
	declare @t_eacc1 nvarchar(20) = case when '#non' = [4] then CHAR(255) else [4] end
	declare @t_proj nvarchar(max) = case when '#non' = [5] then ' ' else [5] end
	declare @t_part nvarchar(max) = case when '#non' = [6] then ' ' else [6] end
	--------------------------------------------------------------------------------------------
	declare @listaccc table(
		tablea nvarchar(20),
		accy nvarchar(20),
		yy nvarchar(10)
	)
	--------------------------------------------------------------------------------------------
	declare @tmpa table(
		accy nvarchar(10),
		proj nvarchar(20),
		cproj nvarchar(20),
		part nvarchar(20),
		cpart nvarchar(20),
		datea nvarchar(10),
		acc1 nvarchar(20),
		acc2 nvarchar(50),
		memo nvarchar(max),
		dmoney float,
		cmoney float
	)
	
	IF OBJECT_ID('tempdb..#z_acbej_accu')is not null
	BEGIN
		drop table #z_acbej_accu	
	END
	create table #z_acbej_accu(
		sel int identity(1,1),
		mon nvarchar(10),
		proj nvarchar(20),
		cproj nvarchar(20),
		part nvarchar(20),
		cpart nvarchar(20),
		acc1 nvarchar(20),
		acc2 nvarchar(50),
		[money] float
	)
	insert into #z_acbej_accu(mon,proj,cproj,part,cpart,acc1,acc2,[money])
	select b.mon,isnull(a.projno,''),isnull(a.proj,''),'','',a.acc1,a.acc2,a.[money]
	from accus a
	left join accu b on a.noa=b.noa
	where b.[mon] between @t_bmon and @t_emon
		and isnull(a.acc1,'') between @t_bacc1 and @t_eacc1
		 and (len(@t_proj)=0 or charindex(','+a.projno+',',','+@t_proj+',')>0)
	---------------------------------------------------------------------------------
	declare @tablea nvarchar(20)
	declare @accy nvarchar(10)
	declare @yy nvarchar(10)
	
	declare cursor_table cursor for
	select tablea,accy,yy from @listaccc
	open cursor_table
	fetch next from cursor_table
	into @tablea,@accy,@yy
	while(@@FETCH_STATUS <> -1)
	begin		
		set @cmd ="select @accy,isnull(a.proj,''),isnull(d.proj,''),'','',b.accc2,a.accc5,a.accc6,a.accc7,a.dmoney,a.cmoney
		 from acccs"+@accy+" a
		 left join accc"+@accy+" b on a.accc3=b.accc3
		 left join acpart"+@accy+" c on a.part=c.noa 
		 left join proj d on a.proj=d.noa
		 where exists(select top 1* from #z_acbej_accu 
			where mon=@yy+'/'+left(b.accc2,2) 
				and proj=isnull(a.proj,'')
				and acc1=isnull(a.accc5,''))"
		insert into @tmpa(accy,proj,cproj,part,cpart,datea,acc1,acc2,memo,dmoney,cmoney)
		execute sp_executesql @cmd,N'@yy nvarchar(10),@accy nvarchar(10),@t_bmon nvarchar(10),@t_emon nvarchar(10),@t_bacc1 nvarchar(20),@t_eacc1 nvarchar(20),@t_proj nvarchar(max),@t_part nvarchar(max)'
		,@yy=@yy,@accy=@accy,@t_bmon=@t_bmon,@t_emon=@t_emon,@t_proj=@t_proj,@t_part=@t_part,@t_bacc1=@t_bacc1,@t_eacc1=@t_eacc1
		
		fetch next from cursor_table
		into @tablea,@accy,@yy
	end
	close cursor_table
	deallocate cursor_table
	------------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_acbej01')is not null
	BEGIN
		drop table #z_acbej01	
	END
	create table #z_acbej01(
		gno nvarchar(10),
		pno int identity(1,1),
		recno int,
		typea nvarchar(10),
		accy nvarchar(10),
		proj nvarchar(20),
		part nvarchar(20),	
		acc1 nvarchar(20),
		acc2 nvarchar(50),
		memo nvarchar(max),
		mon01 float,
		mon02 float,
		mon03 float,
		mon04 float,
		mon05 float,
		mon06 float,
		mon07 float,
		mon08 float,
		mon09 float,
		mon10 float,
		mon11 float,
		mon12 float,
		total float,
		cproj nvarchar(50),
		cpart nvarchar(50),
		smon01 float,
		smon02 float,
		smon03 float,
		smon04 float,
		smon05 float,
		smon06 float,
		smon07 float,
		smon08 float,
		smon09 float,
		smon10 float,
		smon11 float,
		smon12 float,
		stotal float
	)
	create index acc1 on #z_acbej01(accy,acc1)
	declare @field nvarchar(20)
	declare @datea nvarchar(10)
	declare @proj nvarchar(20)
	declare @part nvarchar(20)
	declare @cproj nvarchar(50)
	declare @cpart nvarchar(50)
	declare @acc1 nvarchar(20)
	declare @acc2 nvarchar(50)
	declare @memo nvarchar(max)
	declare @dmoney float
	declare @cmoney float
	
	declare cursor_table cursor for
	select accy,proj,cproj,part,cpart,datea,acc1,acc2,memo,dmoney,cmoney from @tmpa
	open cursor_table
	fetch next from cursor_table
	into @accy,@proj,@cproj,@part,@cpart,@datea,@acc1,@acc2,@memo,@dmoney,@cmoney
	while(@@FETCH_STATUS <> -1)
	begin		
		set @field = 'mon'+LEFT(@datea,2)
	
		if exists(select * from #z_acbej01 where accy=@accy and acc1=@acc1)
		begin
			set @cmd =
			" update #z_acbej01 set "+@field+"=isnull(a."+@field+",0)+case when a.typea='A' then @cmoney-@dmoney else @dmoney-@cmoney end
			  from #z_acbej01 a 
			  where accy=@accy and acc1=@acc1"
			execute sp_executesql @cmd,N'@dmoney float,@cmoney float,@accy nvarchar(10),@acc1 nvarchar(20)'
			,@accy=@accy,@acc1=@acc1,@dmoney=@dmoney,@cmoney=@cmoney
		end
		else
		begin
			set @cmd =
			" insert into #z_acbej01(gno,typea,accy,proj,cproj,part,cpart,acc1,acc2,memo,"+@field+")
			  values('1',case when left(@acc1,1)='1' or left(@acc1,1)='4' or left(@acc1,1)='7' then 'A' else 'B' end 
			  ,@accy,@proj,@cproj,@part,@cpart,@acc1,@acc2,@memo
			  ,case when left(@acc1,1)='1' or left(@acc1,1)='4' or left(@acc1,1)='7' then @cmoney-@dmoney else @dmoney-@cmoney end)"
			  
			execute sp_executesql @cmd,N'@accy nvarchar(10),@acc1 nvarchar(20),@acc2 nvarchar(50),@memo nvarchar(max),@dmoney float,@cmoney float,@part nvarchar(20),@proj nvarchar(20),@cproj nvarchar(50),@cpart nvarchar(50)'
			,@accy=@accy,@acc1=@acc1,@acc2=@acc2,@dmoney=@dmoney,@cmoney=@cmoney,@memo=@memo,@part=@part,@proj=@proj,@cproj=@cproj,@cpart=@cpart
		end
		fetch next from cursor_table
		into @accy,@proj,@cproj,@part,@cpart,@datea,@acc1,@acc2,@memo,@dmoney,@cmoney
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------- accu
	declare @mon nvarchar(10)
	declare @money float

	declare cursor_table cursor for
	select mon,proj,cproj,part,cpart,acc1,acc2,[money] from #z_acbej_accu
	open cursor_table
	fetch next from cursor_table
	into @mon,@proj,@cproj,@part,@cpart,@acc1,@acc2,@money
	while(@@FETCH_STATUS <> -1)
	begin		
		set @field = 'smon'+right(@mon,2)
	
		if exists(select * from #z_acbej01 where accy=left(@mon,3)+'_1' and acc1=@acc1)
		begin
			set @cmd =
			" update #z_acbej01 set "+@field+"=isnull(a."+@field+",0)+@money
			  from #z_acbej01 a 
			  where accy=left(@mon,3)+'_1' and acc1=@acc1"
			execute sp_executesql @cmd,N'@money float,@mon nvarchar(10),@acc1 nvarchar(20)'
			,@mon=@mon,@acc1=@acc1,@money=@money
		end
		else
		begin
			set @cmd =
			" insert into #z_acbej01(gno,typea,accy,proj,cproj,part,cpart,acc1,acc2,"+@field+")
			  values('1',case when left(@acc1,1)='4' or left(@acc1,1)='7' then 'A' else 'B' end ,left(@mon,3)+'_1',@proj,@cproj,@part,@cpart,@acc1,@acc2,@money)"
			execute sp_executesql @cmd,N'@mon nvarchar(10),@acc1 nvarchar(20),@acc2 nvarchar(50),@money float,@part nvarchar(20),@proj nvarchar(20),@cproj nvarchar(50),@cpart nvarchar(50)'
			,@mon=@mon,@acc1=@acc1,@acc2=@acc2,@money=@money,@part=@part,@proj=@proj,@cproj=@cproj,@cpart=@cpart
		end
		fetch next from cursor_table
		into @mon,@proj,@cproj,@part,@cpart,@acc1,@acc2,@money
	end
	close cursor_table
	deallocate cursor_table

	update #z_acbej01 set total = ISNULL(mon01,0)+ISNULL(mon02,0)+ISNULL(mon03,0)+ISNULL(mon04,0)
		+ISNULL(mon05,0)+ISNULL(mon06,0)+ISNULL(mon07,0)+ISNULL(mon08,0)
		+ISNULL(mon09,0)+ISNULL(mon10,0)+ISNULL(mon11,0)+ISNULL(mon12,0)
		,stotal = ISNULL(smon01,0)+ISNULL(smon02,0)+ISNULL(smon03,0)+ISNULL(smon04,0)
		+ISNULL(smon05,0)+ISNULL(smon06,0)+ISNULL(smon07,0)+ISNULL(smon08,0)
		+ISNULL(smon09,0)+ISNULL(smon10,0)+ISNULL(smon11,0)+ISNULL(smon12,0)
	insert into #z_acbej01(gno,accy,proj,cproj,part,cpart,acc1,mon01,mon02,mon03,mon04,mon05,mon06,mon07,mon08,mon09,mon10,mon11,mon12,total
		,smon01,smon02,smon03,smon04,smon05,smon06,smon07,smon08,smon09,smon10,smon11,smon12,stotal)
	select '2',accy,proj,cproj,part,cpart,LEFT(acc1,1)+CHAR(255)
		,SUM(ISNULL(mon01,0)),SUM(ISNULL(mon02,0)),SUM(ISNULL(mon03,0)),SUM(ISNULL(mon04,0)),SUM(ISNULL(mon05,0)),SUM(ISNULL(mon06,0))
		,SUM(ISNULL(mon07,0)),SUM(ISNULL(mon08,0)),SUM(ISNULL(mon09,0)),SUM(ISNULL(mon10,0)),SUM(ISNULL(mon11,0)),SUM(ISNULL(mon12,0))
		,SUM(ISNULL(total,0))
		,SUM(ISNULL(smon01,0)),SUM(ISNULL(smon02,0)),SUM(ISNULL(smon03,0)),SUM(ISNULL(smon04,0)),SUM(ISNULL(smon05,0)),SUM(ISNULL(smon06,0))
		,SUM(ISNULL(smon07,0)),SUM(ISNULL(smon08,0)),SUM(ISNULL(smon09,0)),SUM(ISNULL(smon10,0)),SUM(ISNULL(smon11,0)),SUM(ISNULL(smon12,0))
		,SUM(ISNULL(stotal,0))
	from #z_acbej01 where gno='1' group by accy,proj,cproj,part,cpart,LEFT(acc1,1) 
	
	insert into #z_acbej01(gno,accy,proj,cproj,part,cpart,acc1,mon01,mon02,mon03,mon04,mon05,mon06,mon07,mon08,mon09,mon10,mon11,mon12,total
		,smon01,smon02,smon03,smon04,smon05,smon06,smon07,smon08,smon09,smon10,smon11,smon12,stotal)
	select '3',accy,proj,cproj,part,cpart,CHAR(255)
		,SUM(ISNULL(mon01,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon02,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon03,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon04,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon05,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon06,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon07,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon08,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon09,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon10,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon11,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon12,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(total,0)*case when typea='A' then 1 else -1 end)
		
		,SUM(ISNULL(smon01,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon02,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon03,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon04,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon05,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon06,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon07,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon08,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon09,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon10,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon11,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon12,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(stotal,0)*case when typea='A' then 1 else -1 end)
	from #z_acbej01 where gno='2' group by accy,proj,cproj,part,cpart
	
	update #z_acbej01 set recno=b.recno
	from #z_acbej01 a
	left join (select pno,ROW_NUMBER()over(partition by accy,proj,part order by acc1) recno from #z_acbej01) b on a.pno=b.pno
	----------------------------------------------------------------------------------------------------
	declare @t_page int = 40
	declare @n int = 0
	declare @recno int = 0
	
	declare cursor_table cursor for
	select accy,proj,cproj,part,cpart,count(1),max(recno) from #z_acbej01 group by accy,proj,cproj,part,cpart
	open cursor_table
	fetch next from cursor_table
	into @accy,@proj,@cproj,@part,@cpart,@n,@recno
	while(@@FETCH_STATUS <> -1)
	begin		
		while @n%@t_page!=0
		begin
			insert into #z_acbej01(gno,accy,proj,cproj,part,cpart,recno)values('4',@accy,@proj,@cproj,@part,@cpart,@recno+1)
			set @n = @n +1
		end
		
		fetch next from cursor_table
		into @accy,@proj,@cproj,@part,@cpart,@n,@recno
	end
	close cursor_table
	deallocate cursor_table
	
	select *
		,dbo.getComma(mon01,0) a01 
		,dbo.getComma(mon02,0) a02 
		,dbo.getComma(mon03,0) a03 
		,dbo.getComma(mon04,0) a04 
		,dbo.getComma(mon05,0) a05 
		,dbo.getComma(mon06,0) a06 
		,dbo.getComma(mon07,0) a07 
		,dbo.getComma(mon08,0) a08 
		,dbo.getComma(mon09,0) a09 
		,dbo.getComma(mon10,0) a10 
		,dbo.getComma(mon11,0) a11 
		,dbo.getComma(mon12,0) a12
		,dbo.getComma(total,0) a13 
		
		,dbo.getComma(smon01,0) b01 
		,dbo.getComma(smon02,0) b02 
		,dbo.getComma(smon03,0) b03 
		,dbo.getComma(smon04,0) b04 
		,dbo.getComma(smon05,0) b05 
		,dbo.getComma(smon06,0) b06 
		,dbo.getComma(smon07,0) b07 
		,dbo.getComma(smon08,0) b08 
		,dbo.getComma(smon09,0) b09 
		,dbo.getComma(smon10,0) b10 
		,dbo.getComma(smon11,0) b11 
		,dbo.getComma(smon12,0) b12
		,dbo.getComma(stotal,0) b13 
		,dbo.getComma(total-stotal,0) diff 
	from #z_acbej01 
	order by accy,proj,part,recno
	drop table #z_acbej01
	drop table #z_acbej_accu;

z_acbej01:--z_acbej01	預算總表-部門
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	
	declare @t_bmon nvarchar(10) = case when '#non' = [1] then ' ' else [1] end
	declare @t_emon nvarchar(10) = case when '#non' = [2] then CHAR(255) else [2] end
	declare @t_bacc1 nvarchar(20) = case when '#non' = [3] then ' ' else [3] end
	declare @t_eacc1 nvarchar(20) = case when '#non' = [4] then CHAR(255) else [4] end
	declare @t_proj nvarchar(max) = case when '#non' = [5] then ' ' else [5] end
	declare @t_part nvarchar(max) = case when '#non' = [6] then ' ' else [6] end
	--------------------------------------------------------------------------------------------
	declare @listaccc table(
		tablea nvarchar(20),
		accy nvarchar(20),
		yy nvarchar(10)
	)
	--------------------------------------------------------------------------------------------
	declare @tmpa table(
		accy nvarchar(10),
		proj nvarchar(20),
		cproj nvarchar(20),
		part nvarchar(20),
		cpart nvarchar(20),
		datea nvarchar(10),
		acc1 nvarchar(20),
		acc2 nvarchar(50),
		memo nvarchar(max),
		dmoney float,
		cmoney float
	)
	
	IF OBJECT_ID('tempdb..#z_acbej_accu')is not null
	BEGIN
		drop table #z_acbej_accu	
	END
	create table #z_acbej_accu(
		sel int identity(1,1),
		mon nvarchar(10),
		proj nvarchar(20),
		cproj nvarchar(20),
		part nvarchar(20),
		cpart nvarchar(20),
		acc1 nvarchar(20),
		acc2 nvarchar(50),
		[money] float
	)
	insert into #z_acbej_accu(mon,proj,cproj,part,cpart,acc1,acc2,[money])
	select b.mon,'','',isnull(a.partno,''),isnull(a.part,''),a.acc1,a.acc2,a.[money]
	from accus a
	left join accu b on a.noa=b.noa
	where b.[mon] between @t_bmon and @t_emon
		and isnull(a.acc1,'') between @t_bacc1 and @t_eacc1
		 and (len(@t_part)=0 or charindex(','+a.partno+',',','+@t_part+',')>0)
	---------------------------------------------------------------------------------
	declare @tablea nvarchar(20)
	declare @accy nvarchar(10)
	declare @yy nvarchar(10)
	
	declare cursor_table cursor for
	select tablea,accy,yy from @listaccc
	open cursor_table
	fetch next from cursor_table
	into @tablea,@accy,@yy
	while(@@FETCH_STATUS <> -1)
	begin		
		set @cmd ="select @accy,'','',isnull(a.part,''),isnull(c.part,''),b.accc2,a.accc5,a.accc6,a.accc7,a.dmoney,a.cmoney
		 from acccs"+@accy+" a
		 left join accc"+@accy+" b on a.accc3=b.accc3
		 left join acpart"+@accy+" c on a.part=c.noa 
		 left join proj d on a.proj=d.noa
		 where exists(select top 1* from #z_acbej_accu 
			where mon=@yy+'/'+left(b.accc2,2) 
				and part=isnull(a.part,'')
				and acc1=isnull(a.accc5,''))"
		insert into @tmpa(accy,proj,cproj,part,cpart,datea,acc1,acc2,memo,dmoney,cmoney)
		execute sp_executesql @cmd,N'@yy nvarchar(10),@accy nvarchar(10),@t_bmon nvarchar(10),@t_emon nvarchar(10),@t_bacc1 nvarchar(20),@t_eacc1 nvarchar(20),@t_proj nvarchar(max),@t_part nvarchar(max)'
		,@yy=@yy,@accy=@accy,@t_bmon=@t_bmon,@t_emon=@t_emon,@t_proj=@t_proj,@t_part=@t_part,@t_bacc1=@t_bacc1,@t_eacc1=@t_eacc1
		
		fetch next from cursor_table
		into @tablea,@accy,@yy
	end
	close cursor_table
	deallocate cursor_table
	------------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_acbej01')is not null
	BEGIN
		drop table #z_acbej01	
	END
	create table #z_acbej01(
		gno nvarchar(10),
		pno int identity(1,1),
		recno int,
		typea nvarchar(10),
		accy nvarchar(10),
		proj nvarchar(20),
		part nvarchar(20),	
		acc1 nvarchar(20),
		acc2 nvarchar(50),
		memo nvarchar(max),
		mon01 float,
		mon02 float,
		mon03 float,
		mon04 float,
		mon05 float,
		mon06 float,
		mon07 float,
		mon08 float,
		mon09 float,
		mon10 float,
		mon11 float,
		mon12 float,
		total float,
		cproj nvarchar(50),
		cpart nvarchar(50),
		smon01 float,
		smon02 float,
		smon03 float,
		smon04 float,
		smon05 float,
		smon06 float,
		smon07 float,
		smon08 float,
		smon09 float,
		smon10 float,
		smon11 float,
		smon12 float,
		stotal float
	)
	create index acc1 on #z_acbej01(accy,acc1)
	declare @field nvarchar(20)
	declare @datea nvarchar(10)
	declare @proj nvarchar(20)
	declare @part nvarchar(20)
	declare @cproj nvarchar(50)
	declare @cpart nvarchar(50)
	declare @acc1 nvarchar(20)
	declare @acc2 nvarchar(50)
	declare @memo nvarchar(max)
	declare @dmoney float
	declare @cmoney float
	
	declare cursor_table cursor for
	select accy,proj,cproj,part,cpart,datea,acc1,acc2,memo,dmoney,cmoney from @tmpa
	open cursor_table
	fetch next from cursor_table
	into @accy,@proj,@cproj,@part,@cpart,@datea,@acc1,@acc2,@memo,@dmoney,@cmoney
	while(@@FETCH_STATUS <> -1)
	begin		
		set @field = 'mon'+LEFT(@datea,2)
	
		if exists(select * from #z_acbej01 where accy=@accy and acc1=@acc1)
		begin
			set @cmd =
			" update #z_acbej01 set "+@field+"=isnull(a."+@field+",0)+case when a.typea='A' then @cmoney-@dmoney else @dmoney-@cmoney end
			  from #z_acbej01 a 
			  where accy=@accy and acc1=@acc1"
			execute sp_executesql @cmd,N'@dmoney float,@cmoney float,@accy nvarchar(10),@acc1 nvarchar(20)'
			,@accy=@accy,@acc1=@acc1,@dmoney=@dmoney,@cmoney=@cmoney
		end
		else
		begin
			set @cmd =
			" insert into #z_acbej01(gno,typea,accy,proj,cproj,part,cpart,acc1,acc2,memo,"+@field+")
			  values('1',case when left(@acc1,1)='1' or left(@acc1,1)='4' or left(@acc1,1)='7' then 'A' else 'B' end 
			  ,@accy,@proj,@cproj,@part,@cpart,@acc1,@acc2,@memo
			  ,case when left(@acc1,1)='1' or left(@acc1,1)='4' or left(@acc1,1)='7' then @cmoney-@dmoney else @dmoney-@cmoney end)"
			  
			execute sp_executesql @cmd,N'@accy nvarchar(10),@acc1 nvarchar(20),@acc2 nvarchar(50),@memo nvarchar(max),@dmoney float,@cmoney float,@part nvarchar(20),@proj nvarchar(20),@cproj nvarchar(50),@cpart nvarchar(50)'
			,@accy=@accy,@acc1=@acc1,@acc2=@acc2,@dmoney=@dmoney,@cmoney=@cmoney,@memo=@memo,@part=@part,@proj=@proj,@cproj=@cproj,@cpart=@cpart
		end
		fetch next from cursor_table
		into @accy,@proj,@cproj,@part,@cpart,@datea,@acc1,@acc2,@memo,@dmoney,@cmoney
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------- accu
	declare @mon nvarchar(10)
	declare @money float

	declare cursor_table cursor for
	select mon,proj,cproj,part,cpart,acc1,acc2,[money] from #z_acbej_accu
	open cursor_table
	fetch next from cursor_table
	into @mon,@proj,@cproj,@part,@cpart,@acc1,@acc2,@money
	while(@@FETCH_STATUS <> -1)
	begin		
		set @field = 'smon'+right(@mon,2)
	
		if exists(select * from #z_acbej01 where accy=left(@mon,3)+'_1' and acc1=@acc1)
		begin
			set @cmd =
			" update #z_acbej01 set "+@field+"=isnull(a."+@field+",0)+@money
			  from #z_acbej01 a 
			  where accy=left(@mon,3)+'_1' and acc1=@acc1"
			execute sp_executesql @cmd,N'@money float,@mon nvarchar(10),@acc1 nvarchar(20)'
			,@mon=@mon,@acc1=@acc1,@money=@money
		end
		else
		begin
			set @cmd =
			" insert into #z_acbej01(gno,typea,accy,proj,cproj,part,cpart,acc1,acc2,"+@field+")
			  values('1',case when left(@acc1,1)='4' or left(@acc1,1)='7' then 'A' else 'B' end ,left(@mon,3)+'_1',@proj,@cproj,@part,@cpart,@acc1,@acc2,@money)"
			execute sp_executesql @cmd,N'@mon nvarchar(10),@acc1 nvarchar(20),@acc2 nvarchar(50),@money float,@part nvarchar(20),@proj nvarchar(20),@cproj nvarchar(50),@cpart nvarchar(50)'
			,@mon=@mon,@acc1=@acc1,@acc2=@acc2,@money=@money,@part=@part,@proj=@proj,@cproj=@cproj,@cpart=@cpart
		end
		fetch next from cursor_table
		into @mon,@proj,@cproj,@part,@cpart,@acc1,@acc2,@money
	end
	close cursor_table
	deallocate cursor_table

	update #z_acbej01 set total = ISNULL(mon01,0)+ISNULL(mon02,0)+ISNULL(mon03,0)+ISNULL(mon04,0)
		+ISNULL(mon05,0)+ISNULL(mon06,0)+ISNULL(mon07,0)+ISNULL(mon08,0)
		+ISNULL(mon09,0)+ISNULL(mon10,0)+ISNULL(mon11,0)+ISNULL(mon12,0)
		,stotal = ISNULL(smon01,0)+ISNULL(smon02,0)+ISNULL(smon03,0)+ISNULL(smon04,0)
		+ISNULL(smon05,0)+ISNULL(smon06,0)+ISNULL(smon07,0)+ISNULL(smon08,0)
		+ISNULL(smon09,0)+ISNULL(smon10,0)+ISNULL(smon11,0)+ISNULL(smon12,0)
	insert into #z_acbej01(gno,accy,proj,cproj,part,cpart,acc1,mon01,mon02,mon03,mon04,mon05,mon06,mon07,mon08,mon09,mon10,mon11,mon12,total
		,smon01,smon02,smon03,smon04,smon05,smon06,smon07,smon08,smon09,smon10,smon11,smon12,stotal)
	select '2',accy,proj,cproj,part,cpart,LEFT(acc1,1)+CHAR(255)
		,SUM(ISNULL(mon01,0)),SUM(ISNULL(mon02,0)),SUM(ISNULL(mon03,0)),SUM(ISNULL(mon04,0)),SUM(ISNULL(mon05,0)),SUM(ISNULL(mon06,0))
		,SUM(ISNULL(mon07,0)),SUM(ISNULL(mon08,0)),SUM(ISNULL(mon09,0)),SUM(ISNULL(mon10,0)),SUM(ISNULL(mon11,0)),SUM(ISNULL(mon12,0))
		,SUM(ISNULL(total,0))
		,SUM(ISNULL(smon01,0)),SUM(ISNULL(smon02,0)),SUM(ISNULL(smon03,0)),SUM(ISNULL(smon04,0)),SUM(ISNULL(smon05,0)),SUM(ISNULL(smon06,0))
		,SUM(ISNULL(smon07,0)),SUM(ISNULL(smon08,0)),SUM(ISNULL(smon09,0)),SUM(ISNULL(smon10,0)),SUM(ISNULL(smon11,0)),SUM(ISNULL(smon12,0))
		,SUM(ISNULL(stotal,0))
	from #z_acbej01 where gno='1' group by accy,proj,cproj,part,cpart,LEFT(acc1,1) 
	
	insert into #z_acbej01(gno,accy,proj,cproj,part,cpart,acc1,mon01,mon02,mon03,mon04,mon05,mon06,mon07,mon08,mon09,mon10,mon11,mon12,total
		,smon01,smon02,smon03,smon04,smon05,smon06,smon07,smon08,smon09,smon10,smon11,smon12,stotal)
	select '3',accy,proj,cproj,part,cpart,CHAR(255)
		,SUM(ISNULL(mon01,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon02,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon03,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon04,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon05,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon06,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon07,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon08,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon09,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon10,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon11,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(mon12,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(total,0)*case when typea='A' then 1 else -1 end)
		
		,SUM(ISNULL(smon01,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon02,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon03,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon04,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon05,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon06,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon07,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon08,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon09,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon10,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon11,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(smon12,0)*case when typea='A' then 1 else -1 end)
		,SUM(ISNULL(stotal,0)*case when typea='A' then 1 else -1 end)
	from #z_acbej01 where gno='2' group by accy,proj,cproj,part,cpart
	
	update #z_acbej01 set recno=b.recno
	from #z_acbej01 a
	left join (select pno,ROW_NUMBER()over(partition by accy,proj,part order by acc1) recno from #z_acbej01) b on a.pno=b.pno
	----------------------------------------------------------------------------------------------------
	declare @t_page int = 40
	declare @n int = 0
	declare @recno int = 0
	
	declare cursor_table cursor for
	select accy,proj,cproj,part,cpart,count(1),max(recno) from #z_acbej01 group by accy,proj,cproj,part,cpart
	open cursor_table
	fetch next from cursor_table
	into @accy,@proj,@cproj,@part,@cpart,@n,@recno
	while(@@FETCH_STATUS <> -1)
	begin		
		while @n%@t_page!=0
		begin
			insert into #z_acbej01(gno,accy,proj,cproj,part,cpart,recno)values('4',@accy,@proj,@cproj,@part,@cpart,@recno+1)
			set @n = @n +1
		end
		
		fetch next from cursor_table
		into @accy,@proj,@cproj,@part,@cpart,@n,@recno
	end
	close cursor_table
	deallocate cursor_table
	
	select *
		,dbo.getComma(mon01,0) a01 
		,dbo.getComma(mon02,0) a02 
		,dbo.getComma(mon03,0) a03 
		,dbo.getComma(mon04,0) a04 
		,dbo.getComma(mon05,0) a05 
		,dbo.getComma(mon06,0) a06 
		,dbo.getComma(mon07,0) a07 
		,dbo.getComma(mon08,0) a08 
		,dbo.getComma(mon09,0) a09 
		,dbo.getComma(mon10,0) a10 
		,dbo.getComma(mon11,0) a11 
		,dbo.getComma(mon12,0) a12
		,dbo.getComma(total,0) a13 
		
		,dbo.getComma(smon01,0) b01 
		,dbo.getComma(smon02,0) b02 
		,dbo.getComma(smon03,0) b03 
		,dbo.getComma(smon04,0) b04 
		,dbo.getComma(smon05,0) b05 
		,dbo.getComma(smon06,0) b06 
		,dbo.getComma(smon07,0) b07 
		,dbo.getComma(smon08,0) b08 
		,dbo.getComma(smon09,0) b09 
		,dbo.getComma(smon10,0) b10 
		,dbo.getComma(smon11,0) b11 
		,dbo.getComma(smon12,0) b12
		,dbo.getComma(stotal,0) b13 
		,dbo.getComma(total-stotal,0) diff 
	from #z_acbej01 
	order by accy,proj,part,recno
	drop table #z_acbej01
	drop table #z_acbej_accu;