z_ordep_r1:--z_ordep_r1
declare @t_noa nvarchar(30)
set @t_noa = case when '#non' = [5] then '' else [5] end
--***********************************************************************************
declare @tmp table(
	gno nvarchar(10),
	noa nvarchar(30),
	custno nvarchar(30),
	comp nvarchar(200),
	conn nvarchar(50),
	addr nvarchar(Max),
	contract nvarchar(50),
	custorde nvarchar(50),
	tel nvarchar(50),
	fax nvarchar(50),
	odate nvarchar(20),
	datea nvarchar(20),
	payment nvarchar(MAX),
	shipment nvarchar(MAX),
	terms nvarchar(50),
	memo nvarchar(MAX),
	coin nvarchar(20),
	main nvarchar(MAX),
	side nvarchar(MAX),
	
	noq nvarchar(10),
	pno nvarchar(30),
	product nvarchar(MAX),
	mount float,
	unit nvarchar(30),
	price float,
	total float
)

insert @tmp
select '0',a.noa,a.custno,a.comp,c.conn
,case when isnull(a.addr2,'')!='' then isnull(a.post2,'')+' '+isnull(a.addr2,'') else isnull(a.post,'')+' '+isnull(a.addr,'') end
,a.contract,a.custorde,a.tel,a.fax,a.odate,a.datea,a.paytype
,a.trantype
+case when ISNULL(c.bdock,'')!='' then ' From:'+c.bdock else '' end
+case when ISNULL(c.edock,'')!='' then ' To:'+c.edock else '' end
,c.payterms,a.memo,case when isnull(a.coin,'')='' then 'NT' else a.coin end
,Replace(Replace(Replace(c.main,'chr(10)','</BR>'),'　','&nbsp&nbsp'),'~#$','''')
,Replace(Replace(Replace(c.side,'chr(10)','</BR>'),'　','&nbsp&nbsp'),'~#$','''')
,b.no2,b.productno,b.product+case when isnull(b.spec,'')!='' then '<BR>'+b.spec else '' end ,b.mount,b.unit,b.price,b.total
from view_orde a left join view_ordes b on a.noa=b.noa
left join view_ordei  c on a.noa=c.noa
where a.noa=@t_noa

if((select count(*) from @tmp)>0)
begin
	insert @tmp(gno,noa,noq,total,main,side,comp)
	select '1',noa,CHAR(255),SUM(total),MAX(main),MAX(side),MAX(comp) from @tmp group by noa
end

select
dbo.getComma(mount,-1) mount,
dbo.getComma(price,-1) price,
dbo.getComma(total,-1) total,
* from @tmp order by noa,gno,noq
;

--**********************************************************************************************
z_ordep_r2:--z_ordep_r2
declare @t_noa nvarchar(30)
set @t_noa = case when '#non' = [5] then '' else [5] end
--***********************************************************************************
declare @tmp table(
	gno nvarchar(10),
	noa nvarchar(30),
	custno nvarchar(30),
	comp nvarchar(200),
	conn nvarchar(50),
	addr nvarchar(Max),
	contract nvarchar(50),
	custorde nvarchar(50),
	tel nvarchar(50),
	fax nvarchar(50),
	odate nvarchar(20),
	datea nvarchar(20),
	payment nvarchar(MAX),
	shipment nvarchar(MAX),
	terms nvarchar(50),
	memo nvarchar(MAX),
	coin nvarchar(20),
	main nvarchar(MAX),
	side nvarchar(MAX),
	
	noq nvarchar(10),
	pno nvarchar(30),
	product nvarchar(MAX),
	mount float,
	unit nvarchar(30),
	price float,
	total float
)

insert @tmp
select '0',a.noa,a.custno,a.comp,c.conn
,case when isnull(a.addr2,'')!='' then isnull(a.post2,'')+' '+isnull(a.addr2,'') else isnull(a.post,'')+' '+isnull(a.addr,'') end
,a.contract,a.custorde,a.tel,a.fax,a.odate,a.datea,a.paytype
,a.trantype
+case when ISNULL(c.bdock,'')!='' then ' From:'+c.bdock else '' end
+case when ISNULL(c.edock,'')!='' then ' To:'+c.edock else '' end
,c.payterms,a.memo,case when isnull(a.coin,'')='' then 'NT' else a.coin end
,Replace(Replace(Replace(c.main,'chr(10)','</BR>'),'　','&nbsp&nbsp'),'~#$','''')
,Replace(Replace(Replace(c.side,'chr(10)','</BR>'),'　','&nbsp&nbsp'),'~#$','''')
,b.no2,b.productno,b.product+case when isnull(b.spec,'')!='' then '<BR>'+b.spec else '' end ,b.mount,b.unit,b.price,b.total
from view_orde a left join view_ordes b on a.noa=b.noa
left join view_ordei  c on a.noa=c.noa
where a.noa=@t_noa

if((select count(*) from @tmp)>0)
begin
	insert @tmp(gno,noa,noq,total,main,side,comp)
	select '1',noa,CHAR(255),SUM(total),MAX(main),MAX(side),MAX(comp) from @tmp group by noa
end

select
dbo.getComma(mount,-1) mount,
dbo.getComma(price,-1) price,
dbo.getComma(total,-1) total,
* from @tmp order by noa,gno,noq
;
--**********************************************************************************************
z_ordep_r3:--z_ordep_r3
declare @t_noa nvarchar(30)
set @t_noa = case when '#non' =[5]  then '' else [5]  end
--***********************************************************************************
declare @tmp table(
	gno nvarchar(10),
	idno int identity(0,1),
	page int,
	pageno int,
	noa nvarchar(30),
	no2 nvarchar(30),
	custorde nvarchar(50),
	custno nvarchar(30),
	comp nvarchar(200),
	conn nvarchar(50),
	addr nvarchar(Max),
	contract nvarchar(50),
	tel nvarchar(50),
	fax nvarchar(50),
	odate nvarchar(20),
	datea nvarchar(20),
	payment nvarchar(MAX),
	shipment nvarchar(MAX),
	terms nvarchar(50),
	memo nvarchar(MAX),
	coin nvarchar(20),
	floata float,
	image1 nvarchar(max),
	
	pno nvarchar(30),
	product nvarchar(MAX),
	spec nvarchar(max),
	scoin nvarchar(50),
	aprice float,
	amount float,
	atotal float,
	mount float,
	unit nvarchar(30),
	price float,	
	total float,
	ototal nvarchar(max)
)

declare @noa nvarchar(50)
declare @no2 nvarchar(50)
declare @pageline int = 40--每頁幾行
declare @page int=1 --頁數
declare @pagecount int=1 --目前行數
declare @tdatecount int=isnull((select count(*) from view_ordes where noa=@t_noa),0) --報價資料數
declare @datecount int=0 --目前已插入報價資料數

--表頭
insert into @tmp(gno,noa,page,pageno,custorde,custno,comp,addr,conn,tel,fax,odate,payment,shipment,terms)
select '1',a.noa,@page,@pagecount,a.custorde,a.custno,a.comp,a.addr,b.conn,a.tel,fax,a.odate,paytype,
a.trantype
+case when ISNULL(bdock,'')!='' then ' From:'+bdock else '' end
+case when ISNULL(edock,'')!='' then ' To:'+edock else '' end,a.payterms
from view_orde a left join view_ordei b on a.noa=b.noa where a.noa=@t_noa 

set @pagecount=@pagecount+12

--資料行
declare cursor_table cursor for 
select noa,no2 from view_ordes where noa=@t_noa order by noa,no2
open cursor_table
fetch next from cursor_table
into @noa,@no2
while(@@FETCH_STATUS <> -1)
begin
	set @datecount=@datecount+1
	
	insert into @tmp
	select '0',@page,@pagecount,a.noa,b.no2,a.custorde,a.custno,a.comp,c.conn
	,case when isnull(a.addr2,'')!='' then isnull(a.post2,'')+' '+isnull(a.addr2,'') else isnull(a.post,'')+' '+isnull(a.addr,'') end
	,a.contract,a.tel,a.fax,a.odate,a.datea,a.paytype
	,a.trantype
	+case when ISNULL(c.bdock,'')!='' then ' From:'+c.bdock else '' end
	+case when ISNULL(c.edock,'')!='' then ' To:'+c.edock else '' end
	,a.payterms,a.memo,case when isnull(a.coin,'')='' then 'NT' else a.coin end+'$',isnull(a.floata,''),
	'<img width="300px" src="../images/upload/'+replace(b.productno,'/','CHR(47)')+'_01.jpg">'
	,b.productno,b.product+case when isnull(b.spec,'')!='' then '<BR>'+b.spec else '' end ,b.spec
	,':'+case when isnull(a.coin,'')='' then 'NT' else a.coin end+'$',b.price,b.mount,isnull(b.price,0)*isnull(b.mount,0),a.mount,b.unit,isnull(a.floata,'')*b.price
	,a.total,''
	from view_orde a left join view_ordes b on a.noa=b.noa
	left join view_ordei c on a.noa=c.noa
	where a.noa=@noa and no2=@no2
	
	set @pagecount=@pagecount+13 --一個品項暫13行
	
	if(@tdatecount>1 and @tdatecount!=@datecount and @datecount%2=1)--資料筆數2以上 且 單行筆數
	begin
		--差入空白頁
		while (@pagecount%@pageline!=0)
		begin
			insert @tmp (gno,page,pageno,noa)
			select '2',@page,@pagecount,@noa
			
			set @pagecount=@pagecount+1
		end
		
		--插入分頁
		insert @tmp (gno,page,pageno,noa)
		select '3',@page,@pagecount,@noa
		
		set @pagecount=1
		set @page=@page+1
		
		--插入第二頁以上的 抬頭
		insert into @tmp(gno,noa,page,pageno,custno,comp,addr,conn,tel,fax,odate,payment,shipment,terms)
		select '4',a.noa,@page,@pagecount,a.custno,a.comp,a.addr,b.conn,a.tel,a.fax,a.odate,a.paytype,
		a.trantype
		+case when ISNULL(bdock,'')!='' then ' From:'+bdock else '' end
		+case when ISNULL(edock,'')!='' then ' To:'+edock else '' end	,a.payterms
		from view_orde a left join view_ordei b on a.noa=b.noa where a.noa=@t_noa 
		
		set @pagecount=@pagecount+4
	end
	else if (@tdatecount=@datecount) --最後一筆
	begin
		--合計
		insert into @tmp(gno,page,pageno,noa,no2,mount,unit,coin,total)
		select '5',@page,@pagecount,noa,CHAR(255),mount,MAX(unit),coin,total
		from @tmp where gno='0' group by noa,mount,coin,total
		set @pagecount=@pagecount+2

		--合計(英文大寫)
		insert into @tmp(gno,page,pageno,noa,ototal)
		select '6',@page,@pagecount,noa,('SAY TOTAL U.S DOLLAR '+UPPER(dbo.currencyToEnglish(total))) 
		from @tmp where gno='0' group by noa,total
		set @pagecount=@pagecount+1
		
		--插入空白行
		while ((@pagecount+1)%@pageline!=0) --1行結束
		begin
			insert @tmp (gno,page,pageno,noa)
			select '7',@page,@pagecount,@noa
				
			set @pagecount=@pagecount+1
		end
			
		--結束
		insert into @tmp(gno,noa,page,pageno)
		select '8',noa,@page,@pagecount from @tmp where gno='0'
		group by noa,comp
		
		set @pagecount=1
		set @page=@page+1
	
	end
	
	fetch next from cursor_table
	into @noa,@no2
end
close cursor_table
deallocate cursor_table

update a 
set mount =(select sum(amount) from @tmp where noa=a.noa and gno='0')
from @tmp a
where gno='5'

select
dbo.getComma(amount,0)amount,
dbo.getComma(mount,0) mount,
dbo.getComma(aprice,3)aprice,
dbo.getComma(atotal,3)atotal,
dbo.getComma(price,2)price,
dbo.getComma(total,2)total,
(select productno from ucccust where custno=a.custno and noa=a.pno)custpno,
* from @tmp a order by idno
;
--**********************************************************************************************
z_ordep_r4:--z_ordep_r4
declare @t_noa nvarchar(30)
set @t_noa = case when '#non' =[5]  then '' else [5]  end
--***********************************************************************************
declare @tmp table(
	gno nvarchar(10),
	idno int identity(0,1),
	page int,
	pageno int,
	noa nvarchar(30),
	no2 nvarchar(30),
	custorde nvarchar(50),
	custno nvarchar(30),
	comp nvarchar(200),
	conn nvarchar(50),
	addr nvarchar(Max),
	contract nvarchar(50),
	tel nvarchar(50),
	fax nvarchar(50),
	odate nvarchar(20),
	datea nvarchar(20),
	payment nvarchar(MAX),
	shipment nvarchar(MAX),
	terms nvarchar(50),
	memo nvarchar(MAX),
	coin nvarchar(20),
	floata float,
	image1 nvarchar(max),
	image2 nvarchar(max),
	
	pno nvarchar(30),
	product nvarchar(MAX),
	spec nvarchar(max),
	custpno nvarchar(50),
	ucano nvarchar(50),
	pctn float,
	nw float,
	gw float,
	cuft float,
	cbm float,
	ctn float,
	
	scoin nvarchar(50),
	aprice float,
	amount float,
	atotal float,
	mount float,
	unit nvarchar(30),
	price float,
	total float,
	
	tnw float,
	tgw float,
	tcuft float,
	tcbm float,
	tctn float,
	
	main nvarchar(MAX),
	side nvarchar(MAX),
	etotal nvarchar(max),
	ectn nvarchar(max)
)

declare @noa nvarchar(50)
declare @no2 nvarchar(50)
declare @pageline int = 40--每頁幾行
declare @page int=1 --頁數
declare @pagecount int=1 --目前行數
declare @tdatecount int=isnull((select count(*) from view_ordes where noa=@t_noa),0) --報價資料數
declare @datecount int=0 --目前已插入報價資料數

--表頭
insert into @tmp(gno,noa,page,pageno,custorde,custno,comp,addr,conn,tel,fax,odate,payment,shipment,terms)
select '1',a.noa,@page,@pagecount,a.custorde,a.custno,a.comp,a.addr,b.conn,a.tel,fax,a.odate,paytype,
a.trantype
+case when ISNULL(bdock,'')!='' then ' From:'+bdock else '' end
+case when ISNULL(edock,'')!='' then ' To:'+edock else '' end,a.payterms
from view_orde a left join view_ordei b on a.noa=b.noa where a.noa=@t_noa 

set @pagecount=@pagecount+9

--資料行
declare cursor_table cursor for 
select noa,no2 from view_ordes where noa=@t_noa order by noa,no2
open cursor_table
fetch next from cursor_table
into @noa,@no2
while(@@FETCH_STATUS <> -1)
begin
	set @datecount=@datecount+1
	
	insert into @tmp
	select '0',@page,@pagecount,a.noa,b.no2,a.custorde,a.custno,a.comp,c.conn
	,case when isnull(a.addr2,'')!='' then isnull(a.post2,'')+' '+isnull(a.addr2,'') else isnull(a.post,'')+' '+isnull(a.addr,'') end
	,a.contract,a.tel,a.fax,a.odate,a.datea,a.paytype,a.trantype
	+case when ISNULL(c.bdock,'')!='' then ' From:'+c.bdock else '' end
	+case when ISNULL(c.edock,'')!='' then ' To:'+c.edock else '' end
	,a.payterms,a.memo,case when isnull(a.coin,'')='' then 'NT' else a.coin end+'$',isnull(a.floata,'')
	,'<img width="180px" src="../images/upload/'+replace(b.productno,'/','CHR(47)')+'_01.jpg">'
	,'<img width="180px" src="../images/upload/'+replace(b.productno,'/','CHR(47)')+'_02.jpg">'
	,b.productno,b.product,b.spec,(select productno from ucccust where custno=a.custno and noa=b.productno)
	,(select case when ucano!='' then ucano else uccno end from ucx where noa=b.productno)
	,d.inmount*d.outmount,d.weight,d.gweight,d.cuft,d.cbm
	,case when isnull(d.inmount,0)*isnull(d.outmount,0)=0 then 1 else ceiling(b.mount/(d.inmount*d.outmount)) end
	,':'+case when isnull(a.coin,'')='' then 'NT' else a.coin end+'$'
	,b.price,b.mount,isnull(b.price,0)*isnull(b.mount,0),0,b.unit,isnull(a.floata,'')*b.price,a.total
	,b.mount*d.uweight
	,d.gweight*floor (b.mount/d.inmount*d.outmount)--整箱
	+(b.mount-floor (b.mount/d.inmount*d.outmount)*d.inmount*d.outmount)*d.uweight--散裝淨重
	+case when (b.mount-(floor(b.mount/(d.inmount*d.outmount))*(d.inmount*d.outmount)))>0 then d.outweight else 0 end --外包裝重
	+case when (b.mount-(floor(b.mount/(d.inmount*d.outmount))*(d.inmount*d.outmount)))>0 then ceiling((b.mount-(floor(b.mount/(d.inmount*d.outmount))*(d.inmount*d.outmount)))/d.inmount)*d.inweight else 0 end tgw --內包裝重
	,d.cuft*case when isnull(d.inmount,0)*isnull(d.outmount,0)=0 then 1 else ceiling(b.mount/(d.inmount*d.outmount)) end
	,d.cbm*case when isnull(d.inmount,0)*isnull(d.outmount,0)=0 then 1 else ceiling(b.mount/(d.inmount*d.outmount)) end
	,case when isnull(d.inmount,0)*isnull(d.outmount,0)=0 then 1 else ceiling(b.mount/(d.inmount*d.outmount)) end
	,Replace(Replace(Replace(e.main,'chr(10)','</BR>'),'　','&nbsp&nbsp'),'~#$','''')
	,Replace(Replace(Replace(e.side,'chr(10)','</BR>'),'　','&nbsp&nbsp'),'~#$','''')
	,'',''
	from view_orde a left join view_ordes b on a.noa=b.noa
	left join view_ordei c on a.noa=c.noa
	left join pack2s d on d.noa=b.productno and d.packway=b.packwayno
	left join view_ordei e on a.noa=e.noa
	where a.noa=@noa and no2=@no2
	
	set @pagecount=@pagecount+15 --一個品項暫13行
	
	if(@tdatecount>1 and @tdatecount!=@datecount and @datecount%2=1)--資料筆數2以上 且 單行筆數
	begin
		--差入空白頁
		while (@pagecount%@pageline!=0)
		begin
			insert @tmp (gno,page,pageno,noa)
			select '2',@page,@pagecount,@noa
			
			set @pagecount=@pagecount+1
		end
		
		--插入分頁
		insert @tmp (gno,page,pageno,noa)
		select '3',@page,@pagecount,@noa
		
		set @pagecount=1
		set @page=@page+1
		
		--插入第二頁以上的 抬頭
		insert into @tmp(gno,noa,page,pageno,custno,comp,addr,conn,tel,fax,odate,payment,shipment,terms)
		select '4',a.noa,@page,@pagecount,a.custno,a.comp,a.addr,b.conn,a.tel,a.fax,a.odate,a.paytype,
		a.trantype
		+case when ISNULL(bdock,'')!='' then ' From:'+bdock else '' end
		+case when ISNULL(edock,'')!='' then ' To:'+edock else '' end	,a.payterms
		from view_orde a left join view_ordei b on a.noa=b.noa where a.noa=@t_noa 
		
		set @pagecount=@pagecount+3
	end
	else if (@tdatecount=@datecount) --最後一筆
	begin
		--合計
		insert into @tmp(gno,page,pageno,noa,no2,mount,unit,coin,total)
		select '5',@page,@pagecount,noa,CHAR(255),mount,MAX(unit),coin,total
		from @tmp where gno='0' group by noa,mount,coin,total
		set @pagecount=@pagecount+1
		
		if(@pagecount>25) --換頁
		begin
			--差入空白頁
			while (@pagecount%@pageline!=0)
			begin
				insert @tmp (gno,page,pageno,noa)
				select '2',@page,@pagecount,@noa
				
				set @pagecount=@pagecount+1
			end
			
			--插入分頁
			insert @tmp (gno,page,pageno,noa)
			select '3',@page,@pagecount,@noa
			
			set @pagecount=1
			set @page=@page+1
			
			--插入第二頁以上的 抬頭
			insert into @tmp(gno,noa,page,pageno,custno,comp,addr,conn,tel,fax,odate,payment,shipment,terms)
			select '4',a.noa,@page,@pagecount,a.custno,a.comp,a.addr,b.conn,a.tel,a.fax,a.odate,a.paytype,
			a.trantype
			+case when ISNULL(bdock,'')!='' then ' From:'+bdock else '' end
			+case when ISNULL(edock,'')!='' then ' To:'+edock else '' end	,a.payterms
			from view_orde a left join view_ordei b on a.noa=b.noa where a.noa=@t_noa 
			
			set @pagecount=@pagecount+3
		end
		
		--合計
		insert into @tmp(gno,page,pageno,noa,main,side)
		select '6',@page,@pagecount,noa,MAX(main),MAX(side)
		from @tmp where gno='0' group by noa
		set @pagecount=@pagecount+7

		--合計(英文大寫)
		insert into @tmp(gno,page,pageno,noa,etotal)
		select '7',@page,@pagecount,noa,('SAY TOTAL U.S DOLLAR '+UPPER(dbo.currencyToEnglish(total))) 
		from @tmp where gno='0' group by noa,total
		set @pagecount=@pagecount+1
		
		--合計(英文大寫)
		insert into @tmp(gno,page,pageno,noa,ectn)
		select '8',@page,@pagecount,noa,''--('SAY TOTAL '+UPPER(dbo.currencyToEnglish(tctn))+'CARTONS') 
		from @tmp where gno='0' group by noa
		set @pagecount=@pagecount+1
		
		--插入空白行
		while ((@pagecount+5+1)%@pageline!=0) --5簽名+1行結束
		begin
			insert @tmp (gno,page,pageno,noa)
			select '2',@page,@pagecount,@noa
				
			set @pagecount=@pagecount+1
		end
		
		--簽名
		insert into @tmp(gno,noa,page,pageno,comp)
		select '9',noa,@page,@pagecount,comp from @tmp where gno='0'
		group by noa,comp
			
		--結束
		insert into @tmp(gno,noa,page,pageno)
		select '10',noa,@page,@pagecount from @tmp where gno='0'
		group by noa,comp
		
		set @pagecount=1
		set @page=@page+1
	
	end
	
	fetch next from cursor_table
	into @noa,@no2
end
close cursor_table
deallocate cursor_table

update a 
set mount =(select sum(amount) from @tmp where noa=a.noa and gno='0')
,tnw=(select sum(tnw) from @tmp where noa=a.noa and gno='0')
,tgw=(select sum(tgw) from @tmp where noa=a.noa and gno='0')
,tcuft=(select sum(tcuft) from @tmp where noa=a.noa and gno='0')
,tcbm=(select sum(tcbm) from @tmp where noa=a.noa and gno='0')
,tctn =(select sum(tctn) from @tmp where noa=a.noa and gno='0')
from @tmp a
where gno='5' or gno='8'

update a 
set ectn =('SAY TOTAL '+UPPER(dbo.currencyToEnglish(tctn))+'CARTONS') 
from @tmp a where gno='8'

update a 
set ectn =('SAY TOTAL '+UPPER(dbo.currencyToEnglish(tctn))+'CARTONS') 
from @tmp a where gno='8'

select
dbo.getComma(amount,0)amount,
dbo.getComma(mount,0) mount,
dbo.getComma(aprice,3)aprice,
dbo.getComma(atotal,3)atotal,
dbo.getComma(price,2)price,
dbo.getComma(total,2)total,
dbo.getComma(isnull(pctn,0),0)pctn,
dbo.getComma(isnull(nw,0),3)nw,
dbo.getComma(isnull(gw,0),3)gw,
dbo.getComma(isnull(cuft,0),2)cuft,
dbo.getComma(isnull(cbm,0),2)cbm,
dbo.getComma(isnull(ctn,0),0)ctn,
dbo.getComma(isnull(tnw,0),3)tnw,
dbo.getComma(isnull(tgw,0),3)tgw,
dbo.getComma(isnull(tcuft,0),2)tcuft,
dbo.getComma(isnull(tcbm,0),2)tcbm,
dbo.getComma(isnull(tctn,0),0)tctn,
* from @tmp a order by idno
;