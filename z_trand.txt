z_trand1:--z_trand1
declare @t_accy nvarchar(20)
declare @t_year int
declare @t_mon nvarchar(10)
declare @t_days nvarchar(10)
set @t_mon = case when '#non'=[2] then '103/01' else [2] end
set @t_accy = left(ltrim(@t_mon),3)
set @t_year = CAST(@t_accy as int) + 1911
set @t_mon = right(ltrim(@t_mon),2)
declare @tmp table(
	gno nvarchar(1),
	idno int,
	pageno int,
	orderno int,
	nick nvarchar(max),
	mon nvarchar(10),
	datea01 float,
	datea02 float,
	datea03 float,
	datea04 float,
	datea05 float,
	datea06 float,
	datea07 float,
	datea08 float,
	datea09 float,
	datea10 float,
	datea11 float,
	datea12 float,
	datea13 float,
	datea14 float,
	datea15 float,
	datea16 float,
	datea17 float,
	datea18 float,
	datea19 float,
	datea20 float,
	datea21 float,
	datea22 float,
	datea23 float,
	datea24 float,
	datea25 float,
	datea26 float,
	datea27 float,
	datea28 float,
	datea29 float,
	datea30 float,
	datea31 float,
	total float,
	maxday nvarchar(10)
)

---判斷最後一日(開始)
if (@t_mon = 2)
begin
	if (((@t_year % 4 = 0) and (@t_year % 100 != 0)) or (@t_year % 400 = 0) )
		begin
			set @t_days = 29
		end
	else
		begin
			set @t_days = 28
		end
end
else if ((@t_mon = 4) or (@t_mon = 6) or (@t_mon = 9) or (@t_mon = 11))
	begin
		set @t_days = 30
	end
else
	begin
		set @t_days = 31
	end
---判斷最後一日(結束)
---取得該月假日(六日)(開始)
declare @freeday table(
	gno nvarchar(1),
	datea nvarchar(10),
	value int ----1=假日 0=非假日
)
insert into @freeday
	select '1',rtrim(ltrim(noa)),1 from holiday where isnull(iswork,0)=0
declare @findDay nvarchar(15)
declare @maxday nvarchar(10)
set @maxday = @t_days
while(@maxday > 0)
begin
	set @findDay = cast(@t_year as nvarchar)+cast(@t_mon as nvarchar)+RIGHT(REPLICATE('0', 2) + CAST(@maxday as NVARCHAR), 2)
	if((select DATEDIFF(DAY, '17530101', @findDay) % 7 / 5) = 1)
	begin
		insert into @freeday
			select '1',cast(@t_accy as nvarchar)+'/'+cast(@t_mon as nvarchar)+'/'+RIGHT(REPLICATE('0', 2) + CAST(@maxday as NVARCHAR), 2),1
	end
	set @maxday -=1
end
insert into @freeday(datea,value,gno)
	select distinct datea,value,'0' from @freeday order by datea
delete @freeday where gno='1'
---取得該月假日(六日)(結束)
insert into @tmp
	select 
		'1' gno,0 idno,0 pageno,0 orderno,b.nick,@t_mon,
		case when RIGHT(rtrim(a.trandate),2) = '01' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.trandate),2) = '02' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.trandate),2) = '03' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.trandate),2) = '04' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.trandate),2) = '05' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.trandate),2) = '06' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.trandate),2) = '07' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.trandate),2) = '08' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.trandate),2) = '09' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.trandate),2) = '10' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.trandate),2) = '11' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.trandate),2) = '12' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.trandate),2) = '13' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.trandate),2) = '14' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.trandate),2) = '15' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.trandate),2) = '16' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.trandate),2) = '17' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.trandate),2) = '18' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.trandate),2) = '19' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.trandate),2) = '20' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.trandate),2) = '21' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.trandate),2) = '22' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.trandate),2) = '23' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.trandate),2) = '24' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.trandate),2) = '25' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.trandate),2) = '26' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.trandate),2) = '27' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.trandate),2) = '28' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.trandate),2) = '29' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.trandate),2) = '30' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.trandate),2) = '31' then sum(a.mount) else null end,
		sum(a.mount),@t_days
	from view_trans a
	left join cust b on a.custno = b.noa
	where (carteamno = '01') and (len(ltrim(rtrim(a.trandate))) = 9)
		and (substring(a.trandate, charindex('/', ltrim(rtrim(a.trandate)))+1,2) = @t_mon)
		and (substring(a.trandate,1, charindex('/', rtrim(a.trandate))-1) = @t_accy)
	group by b.nick,RIGHT(rtrim(a.trandate),2)
insert into @tmp
	select 
		'0' gno,row_number()over(order by nick),0 pageno,1 orderno,nick,@t_mon,
		sum(datea01),sum(datea02),sum(datea03),sum(datea04),sum(datea05),sum(datea06),sum(datea07),sum(datea08),
		sum(datea09),sum(datea10),sum(datea11),sum(datea12),sum(datea13),sum(datea14),sum(datea15),sum(datea16),
		sum(datea17),sum(datea18),sum(datea19),sum(datea20),sum(datea21),sum(datea22),sum(datea23),sum(datea24),
		sum(datea25),sum(datea26),sum(datea27),sum(datea28),sum(datea29),sum(datea30),sum(datea31),sum(total),
		@t_days
	from @tmp
	where gno ='1'
	group by nick
delete @tmp where gno = '1'
declare @pageline int = 25 
update @tmp set pageno = ceiling(idno/cast(@pageline as float)) 

declare @nowPage int = ceiling((select count(*) from @tmp where gno =0)/cast(@pageline as float)) 
if(@nowPage=0 or ((select count(*) from @tmp where gno =0)-(@pageline*@nowPage)=0)) set @nowPage+=1 
while(@nowPage>0)
begin
	insert into @tmp(gno,pageno,orderno,nick,mon,maxday)
		select '1',@nowPage,@nowPage-1,'標題',@t_mon,@t_days 
	set @nowPage -= 1
end
insert into @tmp
	select 
		'2' gno,max(idno)+1,0 pageno,2 orderno,'總計' nick,@t_mon,
		isnull(sum(datea01),0),isnull(sum(datea02),0),isnull(sum(datea03),0),isnull(sum(datea04),0),isnull(sum(datea05),0),isnull(sum(datea06),0),isnull(sum(datea07),0),isnull(sum(datea08),0),
		isnull(sum(datea09),0),isnull(sum(datea10),0),isnull(sum(datea11),0),isnull(sum(datea12),0),isnull(sum(datea13),0),isnull(sum(datea14),0),isnull(sum(datea15),0),isnull(sum(datea16),0),
		isnull(sum(datea17),0),isnull(sum(datea18),0),isnull(sum(datea19),0),isnull(sum(datea20),0),isnull(sum(datea21),0),isnull(sum(datea22),0),isnull(sum(datea23),0),isnull(sum(datea24),0),
		isnull(sum(datea25),0),isnull(sum(datea26),0),isnull(sum(datea27),0),isnull(sum(datea28),0),
		isnull(sum(datea29),case when @t_days>= 29 then 0 else null end),
		isnull(sum(datea30),case when @t_days>= 30 then 0 else null end),
		isnull(sum(datea31),case when @t_days>= 31 then 0 else null end),
		isnull(sum(total),0),
		@t_days
	from @tmp where gno = '0'
declare @t_htmldiva nvarchar(max) = char(60)+'div style="width:100%'+char(59)+'background: #FF6E6E'+char(59)+'"'+char(62)
declare @t_htmldiva2 nvarchar(max) = char(60)+'div style="color: Maroon'+char(59)+'"'+char(62)
declare @t_htmlPadding nvarchar(max) = char(60)+'div style="padding-right: 2px'+char(59)+'"'+char(62)
declare @t_htmldivb nvarchar(max) = char(60)+'/div'+char(62)
select
	a.gno,a.pageno,a.orderno,a.nick,@t_accy + '年' +@t_mon + '月' m01,
	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'01') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 1) then '01日' else cast(a.datea01 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'01') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d01,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'02') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 2) then '02日' else cast(a.datea02 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'02') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d02,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'03') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 3) then '03日' else cast(a.datea03 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'03') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d03,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'04') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 4) then '04日' else cast(a.datea04 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'04') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d04,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'05') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 5) then '05日' else cast(a.datea05 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'05') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d05,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'06') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 6) then '06日' else cast(a.datea06 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'06') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d06,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'07') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 7) then '07日' else cast(a.datea07 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'07') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d07,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'08') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 8) then '08日' else cast(a.datea08 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'08') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d08,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'09') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 9) then '09日' else cast(a.datea09 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'09') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d09,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'10') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 10) then '10日' else cast(a.datea10 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'10') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d10,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'11') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 11) then '11日' else cast(a.datea11 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'11') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d11,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'12') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 12) then '12日' else cast(a.datea12 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'12') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d12,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'13') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 13) then '13日' else cast(a.datea13 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'13') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d13,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'14') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 14) then '14日' else cast(a.datea14 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'14') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d14,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'15') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 15) then '15日' else cast(a.datea15 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'15') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d15,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'16') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 16) then '16日' else cast(a.datea16 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'16') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d16,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'17') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 17) then '17日' else cast(a.datea17 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'17') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d17,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'18') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 18) then '18日' else cast(a.datea18 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'18') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d18,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'19') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 19) then '19日' else cast(a.datea19 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'19') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d19,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'20') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 20) then '20日' else cast(a.datea20 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'20') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d20,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'21') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 21) then '21日' else cast(a.datea21 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'21') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d21,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'22') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 22) then '22日' else cast(a.datea22 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'22') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d22,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'23') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 23) then '23日' else cast(a.datea23 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'23') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d23,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'24') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 24) then '24日' else cast(a.datea24 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'24') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d24,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'25') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 25) then '25日' else cast(a.datea25 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'25') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d25,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'26') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 26) then '26日' else cast(a.datea26 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'26') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d26,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'27') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 27) then '27日' else cast(a.datea27 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'27') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d27,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'28') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 28) then '28日' else cast(a.datea28 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'28') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d28,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'29') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 29) then '29日' else cast(a.datea29 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'29') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d29,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'30') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 30) then '30日' else cast(a.datea30 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'30') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d30,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'31') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 31) then '31日' else cast(a.datea31 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'31') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d31,
	(case when (a.gno='1') then '合計' else @t_htmlPadding + cast(a.total as nvarchar) end) + @t_htmldivb total,maxday
from @tmp a
order by a.orderno,a.pageno,a.nick,a.gno;
--*********************************************************************************************
z_trand2:--z_trand2 
declare @t_accy nvarchar(20)
declare @t_year int
set @t_accy = [12]
set @t_year = CAST(@t_accy as int) + 1911
declare @tmp table(
	gno nvarchar(1),
	pageno int,
	orderno int,
	nick nvarchar(max),
	m01 float,
	m02 float,
	m03 float,
	m04 float,
	m05 float,
	m06 float,
	m07 float,
	m08 float,
	m09 float,
	m10 float,
	m11 float,
	m12 float,
	total float
)
insert into @tmp
	select 
		'1' gno,0 pageno,0 orderno,b.nick,
		case when substring(a.trandate, charindex('/', rtrim(a.trandate))+1,2) = '01' then sum(a.mount) else null end,
		case when substring(a.trandate, charindex('/', rtrim(a.trandate))+1,2) = '02' then sum(a.mount) else null end,
		case when substring(a.trandate, charindex('/', rtrim(a.trandate))+1,2) = '03' then sum(a.mount) else null end,
		case when substring(a.trandate, charindex('/', rtrim(a.trandate))+1,2) = '04' then sum(a.mount) else null end,
		case when substring(a.trandate, charindex('/', rtrim(a.trandate))+1,2) = '05' then sum(a.mount) else null end,
		case when substring(a.trandate, charindex('/', rtrim(a.trandate))+1,2) = '06' then sum(a.mount) else null end,
		case when substring(a.trandate, charindex('/', rtrim(a.trandate))+1,2) = '07' then sum(a.mount) else null end,
		case when substring(a.trandate, charindex('/', rtrim(a.trandate))+1,2) = '08' then sum(a.mount) else null end,
		case when substring(a.trandate, charindex('/', rtrim(a.trandate))+1,2) = '09' then sum(a.mount) else null end,
		case when substring(a.trandate, charindex('/', rtrim(a.trandate))+1,2) = '10' then sum(a.mount) else null end,
		case when substring(a.trandate, charindex('/', rtrim(a.trandate))+1,2) = '11' then sum(a.mount) else null end,
		case when substring(a.trandate, charindex('/', rtrim(a.trandate))+1,2) = '12' then sum(a.mount) else null end,
		sum(a.mount)
	from view_trans a
	left join cust b on a.custno = b.noa
	where (carteamno = '01') and left(ltrim(rtrim(a.trandate)),3) = @t_accy
	and ((a.mount=1) or (caseno like '[A-Z][A-Z][A-Z][A-Z][0-9][0-9][0-9][0-9][0-9][0-9][0-9]'))
	group by b.nick,substring(a.trandate, charindex('/', rtrim(a.trandate))+1,2)
insert into @tmp
	select 
		'0' gno,0 pageno,0 orderno,nick,
		sum(m01),sum(m02),sum(m03),sum(m04),sum(m05),sum(m06),sum(m07),sum(m08),
		sum(m09),sum(m10),sum(m11),sum(m12),sum(total)
	from @tmp
	where gno ='1'
	group by nick
delete @tmp where gno = '1'

insert into @tmp
	select 
		'1' gno,0 pageno,1 orderno,'總計' nick,
		sum(m01),sum(m02),sum(m03),sum(m04),sum(m05),sum(m06),sum(m07),sum(m08),
		sum(m09),sum(m10),sum(m11),sum(m12),sum(total)
	from @tmp where gno = '0'
select
	gno,pageno,orderno,nick,@t_accy + '年' m01,
	case when (gno='2') then '01月' else cast(m01 as nvarchar) end d01,
	case when (gno='2') then '02月' else cast(m02 as nvarchar) end d02,
	case when (gno='2') then '03月' else cast(m03 as nvarchar) end d03,
	case when (gno='2') then '04月' else cast(m04 as nvarchar) end d04,
	case when (gno='2') then '05月' else cast(m05 as nvarchar) end d05,
	case when (gno='2') then '06月' else cast(m06 as nvarchar) end d06,
	case when (gno='2') then '07月' else cast(m07 as nvarchar) end d07,
	case when (gno='2') then '08月' else cast(m08 as nvarchar) end d08,
	case when (gno='2') then '09月' else cast(m09 as nvarchar) end d09,
	case when (gno='2') then '10月' else cast(m10 as nvarchar) end d10,
	case when (gno='2') then '11月' else cast(m11 as nvarchar) end d11,
	case when (gno='2') then '12月' else cast(m12 as nvarchar) end d12,
	case when (gno='2') then '合計' else cast(total as nvarchar) end total
from @tmp order by orderno,pageno,nick,gno;
--*********************************************************************************************
z_trand3:--z_trand3
declare @t_btrandate nvarchar(10) 
declare @t_etrandate nvarchar(10) 
declare @t_uccno nvarchar(20) 
declare @t_bcust nvarchar(10) 
declare @t_ecust nvarchar(10) 
declare @t_caseno nvarchar(20)
declare @t_xcarnos nvarchar(20)
set @t_btrandate = case when '#non'=[5] then '' else [5] end
set @t_etrandate = case when '#non'=[6] then char(255) else [6] end
set @t_uccno = case when '#non'=[7] then '' else [7] end
set @t_bcust = case when '#non'=[8] then '' else [8] end
set @t_ecust = case when '#non'=[9] then char(255) else [9] end
set @t_caseno = case when '#non'=[10] then '' else [10] end
set @t_xcarnos = case when '#non'=[11] then '' else [11] end
declare @tmp table( 
	gno nvarchar(1), 
	trandate nvarchar(10), 
	driver nvarchar(20), 
	carno nvarchar(20), 
	nick nvarchar(20), 
	uccno nvarchar(20), 
	product nvarchar(50), 
	straddr nvarchar(max), 
	caseno nvarchar(200), 
	mount float,
	ordeno nvarchar(90),
	docketno nvarchar(90)
) 
insert into @tmp 
	select 
	'0',a.trandate,a.driver,a.carno,a.nick,a.uccno,a.product,a.straddr,
	cast(a.caseno as nvarchar) + cast(a.caseno2 as nvarchar) as caseno,a.mount,
	c.ordeno,case when c.ordeno is null then a.po else  d.docketno2 end
	from view_trans[1] a
	left join view_transvcce2trans[1] b on a.noa = b.tranno
	left join view_transvcce[1] c on b.transvcceno = c.noa 
	left join view_tranorde[1] d on c.ordeno =d.noa
	where (a.trandate between @t_btrandate and @t_etrandate) and 
	((len(@t_uccno) = 0) or a.uccno = @t_uccno) and 
	((len(@t_caseno) = 0) or a.caseno = @t_caseno) and 
	(a.custno between @t_bcust and @t_ecust) and a.carteamno = '01' and 
	(LEN(@t_xcarnos) = 0 or @t_xcarnos = a.carno) 
update a
	set ordeno = (select top 1 c.ordeno from view_transvcces[1] b left join view_transvcce[1] c on c.noa=b.noa where (b.carno=a.carno) and substring(b.taskcontent,charindex(a.caseno,b.taskcontent),len(a.caseno))=a.caseno)
from @tmp a where ordeno is null
insert into @tmp(gno,mount) 
	select '1',SUM(mount) from @tmp 
select *,caseno as bcno from @tmp order by gno;
--*********************************************************************************************
z_trand4:--z_trand4
declare @t_btrandate nvarchar(10) 
declare @t_etrandate nvarchar(10) 
declare @trandate nvarchar(10)
declare @moa nvarchar(10)
declare @mob nvarchar(10)
declare @carno nvarchar(20) 
declare @driver nvarchar(20)
declare @i int
declare @countrecord int
set @t_btrandate = case when '#non'=[5] then '' else [5] end
set @t_etrandate = case when '#non'=[6] then char(255) else [6] end
set @trandate = ''
set @moa = ''
set @mob = ''
set @carno = ''
set @driver = ''
set @i = 0
set @countrecord = 0
declare @tmp table( 
	gno nvarchar(1), 
	idno int identity(0,1),
	trandate nvarchar(10), 
	moa nvarchar(10), 
	mob nvarchar(10), 
	carno nvarchar(20), 
	driver nvarchar(20), 
	nick nvarchar(20), 
	straddr nvarchar(max), 
	product nvarchar(20), 
	caseno nvarchar(20), 
	caseno2 nvarchar(20), 
	casetype nvarchar(20), 
	po nvarchar(20)
) 
insert into @tmp 
select 
	'0',trandate,a.mon,mon2,carno,driver,c.nick,straddr,product, 
	caseno,caseno2,casetype,po
	from trans[1] a
	left join calctypes b on a.calctype = b.noa + b.noq
	left join cust c on a.caseuse = c.comp
	where (carteamno = '01') and (trandate between @t_btrandate and @t_etrandate) 
	order by a.trandate,a.mon,a.mon2,a.carno,a.driver
update @tmp set casetype = substring(casetype,1, charindex('~#$~#$', casetype)-1) + CHAR(39) + CHAR(39) where casetype like '%~#$~#$%' 
select @countrecord = COUNT(*) from @tmp 
while(@i < @countrecord)
begin
	---處理 trandate
	if(@trandate = '')
	begin select @trandate = trandate from @tmp where idno = @i end
	else if(@trandate = (select trandate from @tmp where idno = @i))
	begin update @tmp set trandate = '' where idno = @i end
	else
	begin select @trandate = trandate from @tmp where idno = @i end
	---處理 moa
	if(@moa = '')
	begin select @moa = moa from @tmp where idno = @i end
	else if(@moa = (select moa from @tmp where idno = @i))
	begin update @tmp set moa = '' where idno = @i end
	else
	begin select @moa = moa from @tmp where idno = @i end
	---處理 mob
	if(@mob = '')
	begin select @mob = mob from @tmp where idno = @i end
	else if(@mob = (select mob from @tmp where idno = @i))
	begin update @tmp set mob = '' where idno = @i end
	else
	begin select @mob = mob from @tmp where idno = @i end
	---處理 carno
	if(@carno = '')
	begin select @carno = carno from @tmp where idno = @i end
	else if(@carno = (select carno from @tmp where idno = @i))
	begin update @tmp set carno = '' where idno = @i end
	else
	begin select @carno = carno from @tmp where idno = @i end
	---處理 driver
	if(@driver = '')
	begin select @driver = driver from @tmp where idno = @i end
	else if(@driver = (select driver from @tmp where idno = @i))
	begin update @tmp set driver = '' where idno = @i end
	else
	begin select @driver = driver from @tmp where idno = @i end
	set @i +=1
end
select *,cast(caseno as nvarchar) + cast(caseno2 as nvarchar) as bcno from @tmp order by idno;
--*********************************************************************************************
z_trand1A:--z_trand1A
declare @t_accy nvarchar(20)
declare @t_year int
declare @t_mon nvarchar(10)
declare @t_days nvarchar(10)
set @t_mon = case when '#non'=[2] then '103/01' else [2] end
set @t_accy = left(ltrim(@t_mon),3)
set @t_year = CAST(@t_accy as int) + 1911
set @t_mon = right(ltrim(@t_mon),2)
declare @tmp table(
	gno nvarchar(1),
	idno int,
	pageno int,
	orderno int,
	custno nvarchar(max),
	nick nvarchar(max),
	mon nvarchar(10),
	datea01 float,
	datea02 float,
	datea03 float,
	datea04 float,
	datea05 float,
	datea06 float,
	datea07 float,
	datea08 float,
	datea09 float,
	datea10 float,
	datea11 float,
	datea12 float,
	datea13 float,
	datea14 float,
	datea15 float,
	datea16 float,
	datea17 float,
	datea18 float,
	datea19 float,
	datea20 float,
	datea21 float,
	datea22 float,
	datea23 float,
	datea24 float,
	datea25 float,
	datea26 float,
	datea27 float,
	datea28 float,
	datea29 float,
	datea30 float,
	datea31 float,
	total float,
	maxday nvarchar(10)
)

---判斷最後一日(開始)
if (@t_mon = 2)
begin
	if (((@t_year % 4 = 0) and (@t_year % 100 != 0)) or (@t_year % 400 = 0) )
		begin
			set @t_days = 29
		end
	else
		begin
			set @t_days = 28
		end
end
else if ((@t_mon = 4) or (@t_mon = 6) or (@t_mon = 9) or (@t_mon = 11))
	begin
		set @t_days = 30
	end
else
	begin
		set @t_days = 31
	end
---判斷最後一日(結束)
---取得該月假日(六日)(開始)
declare @freeday table(
	gno nvarchar(1),
	datea nvarchar(10),
	value int ----1=假日 0=非假日
)
insert into @freeday
	select '1',rtrim(ltrim(noa)),1 from holiday where isnull(iswork,0)=0
declare @findDay nvarchar(15)
declare @maxday nvarchar(10)
set @maxday = @t_days
while(@maxday > 0)
begin
	set @findDay = cast(@t_year as nvarchar)+cast(@t_mon as nvarchar)+RIGHT(REPLICATE('0', 2) + CAST(@maxday as NVARCHAR), 2)
	if((select DATEDIFF(DAY, '17530101', @findDay) % 7 / 5) = 1)
	begin
		insert into @freeday
			select '1',cast(@t_accy as nvarchar)+'/'+cast(@t_mon as nvarchar)+'/'+RIGHT(REPLICATE('0', 2) + CAST(@maxday as NVARCHAR), 2),1
	end
	set @maxday -=1
end
insert into @freeday(datea,value,gno)
	select distinct datea,value,'0' from @freeday order by datea
delete @freeday where gno='1'
---取得該月假日(六日)(結束)
insert into @tmp
	select 
		'1' gno,0 idno,0 pageno,0 orderno,b.noa,b.nick,@t_mon,
		case when RIGHT(rtrim(a.datea),2) = '01' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.datea),2) = '02' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.datea),2) = '03' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.datea),2) = '04' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.datea),2) = '05' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.datea),2) = '06' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.datea),2) = '07' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.datea),2) = '08' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.datea),2) = '09' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.datea),2) = '10' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.datea),2) = '11' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.datea),2) = '12' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.datea),2) = '13' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.datea),2) = '14' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.datea),2) = '15' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.datea),2) = '16' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.datea),2) = '17' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.datea),2) = '18' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.datea),2) = '19' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.datea),2) = '20' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.datea),2) = '21' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.datea),2) = '22' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.datea),2) = '23' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.datea),2) = '24' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.datea),2) = '25' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.datea),2) = '26' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.datea),2) = '27' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.datea),2) = '28' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.datea),2) = '29' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.datea),2) = '30' then sum(a.mount) else null end,
		case when RIGHT(rtrim(a.datea),2) = '31' then sum(a.mount) else null end,
		sum(a.mount),@t_days
	from view_transvcce a
	left join cust b on a.custno = b.noa
	where (len(ltrim(rtrim(a.datea))) = 9)
		and (substring(a.datea, charindex('/', ltrim(rtrim(a.datea)))+1,2) = @t_mon)
		and (substring(a.datea,1, charindex('/', rtrim(a.datea))-1) = @t_accy)
	group by b.noa,b.nick,RIGHT(rtrim(a.datea),2)
insert into @tmp(gno,idno,pageno,orderno,custno,nick,total,maxday)
	select
		'1' gno,0 idno,0 pageno,0 orderno,a.custno,b.nick,0 total,@t_days
	from view_transvcce a
	left join cust b on a.custno = b.noa
	outer apply(select custno,left(datea,6) mon,sum(mount) mount from view_transvcce where a.custno=custno and (len(ltrim(rtrim(a.datea))) = 9) group by custno,left(datea,6)) c
	where (len(ltrim(rtrim(a.datea))) = 9)
		and (a.custno not in (select custno from @tmp))
		and (
			((cast(@t_mon as int)<4) and (c.mon >= cast((cast(@t_accy as int)-1) as nvarchar)+'/'+(cast(cast(substring(a.datea, charindex('/', ltrim(rtrim(a.datea)))+1,2) as int)+(cast(right(@t_mon,2) as int)-3) as nvarchar))) and c.mount > 0)
			or
			((cast(@t_mon as int)>=4) and (c.mon >= @t_accy+'/'+RIGHT(REPLICATE('0', 2) + CAST((cast(@t_mon as int)-3) as NVARCHAR), 2)) and c.mount > 0)
		)
		and (left(a.datea,6) != @t_accy+'/'+@t_mon)
insert into @tmp
	select 
		'0' gno,row_number()over(order by nick),0 pageno,1 orderno,custno,nick,@t_mon,
		sum(datea01),sum(datea02),sum(datea03),sum(datea04),sum(datea05),sum(datea06),sum(datea07),sum(datea08),
		sum(datea09),sum(datea10),sum(datea11),sum(datea12),sum(datea13),sum(datea14),sum(datea15),sum(datea16),
		sum(datea17),sum(datea18),sum(datea19),sum(datea20),sum(datea21),sum(datea22),sum(datea23),sum(datea24),
		sum(datea25),sum(datea26),sum(datea27),sum(datea28),sum(datea29),sum(datea30),sum(datea31),sum(total),
		@t_days
	from @tmp
	where gno ='1'
	group by custno,nick
delete @tmp where gno = '1'
declare @pageline int = 25 
update @tmp set pageno = ceiling(idno/cast(@pageline as float)) 

declare @nowPage int = ceiling((select count(*) from @tmp where gno =0)/cast(@pageline as float))
if(@nowPage=0 or ((select count(*) from @tmp where gno =0)-(@pageline*@nowPage)=0)) set @nowPage+=1 
while(@nowPage>0)
begin
	insert into @tmp(gno,pageno,orderno,nick,mon,maxday)
		select '1',@nowPage,0,'標題',@t_mon,@t_days 
	set @nowPage -= 1
end
insert into @tmp
	select 
		'2' gno,0 idno,999 pageno,2 orderno,'' custno,'總計' nick,@t_mon,
		isnull(sum(datea01),0),isnull(sum(datea02),0),isnull(sum(datea03),0),isnull(sum(datea04),0),isnull(sum(datea05),0),isnull(sum(datea06),0),isnull(sum(datea07),0),isnull(sum(datea08),0),
		isnull(sum(datea09),0),isnull(sum(datea10),0),isnull(sum(datea11),0),isnull(sum(datea12),0),isnull(sum(datea13),0),isnull(sum(datea14),0),isnull(sum(datea15),0),isnull(sum(datea16),0),
		isnull(sum(datea17),0),isnull(sum(datea18),0),isnull(sum(datea19),0),isnull(sum(datea20),0),isnull(sum(datea21),0),isnull(sum(datea22),0),isnull(sum(datea23),0),isnull(sum(datea24),0),
		isnull(sum(datea25),0),isnull(sum(datea26),0),isnull(sum(datea27),0),isnull(sum(datea28),0),
		isnull(sum(datea29),case when @t_days>= 29 then 0 else null end),
		isnull(sum(datea30),case when @t_days>= 30 then 0 else null end),
		isnull(sum(datea31),case when @t_days>= 31 then 0 else null end),
		isnull(sum(total),0),
		@t_days
	from @tmp where gno = '0'
declare @t_htmldiva nvarchar(max) = char(60)+'div style="width:100%'+char(59)+'background: #FF6E6E'+char(59)+'"'+char(62)
declare @t_htmldiva2 nvarchar(max) = char(60)+'div style="color: Maroon'+char(59)+'"'+char(62)
declare @t_htmlPadding nvarchar(max) = char(60)+'div style="padding-right: 2px'+char(59)+'"'+char(62)
declare @t_htmldivb nvarchar(max) = char(60)+'/div'+char(62)
select
	a.gno,a.pageno,a.orderno,a.nick,@t_accy + '年' +@t_mon + '月' m01,
	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'01') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 1) then '01日' else cast(a.datea01 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'01') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d01,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'02') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 2) then '02日' else cast(a.datea02 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'02') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d02,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'03') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 3) then '03日' else cast(a.datea03 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'03') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d03,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'04') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 4) then '04日' else cast(a.datea04 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'04') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d04,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'05') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 5) then '05日' else cast(a.datea05 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'05') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d05,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'06') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 6) then '06日' else cast(a.datea06 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'06') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d06,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'07') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 7) then '07日' else cast(a.datea07 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'07') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d07,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'08') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 8) then '08日' else cast(a.datea08 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'08') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d08,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'09') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 9) then '09日' else cast(a.datea09 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'09') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d09,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'10') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 10) then '10日' else cast(a.datea10 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'10') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d10,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'11') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 11) then '11日' else cast(a.datea11 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'11') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d11,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'12') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 12) then '12日' else cast(a.datea12 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'12') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d12,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'13') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 13) then '13日' else cast(a.datea13 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'13') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d13,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'14') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 14) then '14日' else cast(a.datea14 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'14') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d14,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'15') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 15) then '15日' else cast(a.datea15 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'15') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d15,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'16') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 16) then '16日' else cast(a.datea16 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'16') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d16,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'17') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 17) then '17日' else cast(a.datea17 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'17') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d17,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'18') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 18) then '18日' else cast(a.datea18 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'18') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d18,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'19') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 19) then '19日' else cast(a.datea19 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'19') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d19,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'20') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 20) then '20日' else cast(a.datea20 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'20') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d20,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'21') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 21) then '21日' else cast(a.datea21 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'21') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d21,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'22') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 22) then '22日' else cast(a.datea22 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'22') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d22,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'23') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 23) then '23日' else cast(a.datea23 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'23') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d23,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'24') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 24) then '24日' else cast(a.datea24 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'24') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d24,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'25') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 25) then '25日' else cast(a.datea25 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'25') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d25,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'26') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 26) then '26日' else cast(a.datea26 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'26') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d26,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'27') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 27) then '27日' else cast(a.datea27 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'27') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d27,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'28') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 28) then '28日' else cast(a.datea28 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'28') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d28,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'29') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 29) then '29日' else cast(a.datea29 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'29') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d29,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'30') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 30) then '30日' else cast(a.datea30 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'30') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d30,

	case when (a.gno!='1') then @t_htmlPadding else '' end + case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'31') = 1 then case when (a.gno='1') then @t_htmldiva else @t_htmldiva2 end else '' end
		+ (case when (a.gno='1') and (cast(a.maxday as int) >= 31) then '31日' else cast(a.datea31 as nvarchar) end)
		+ case when (select value from @freeday where datea=@t_accy+'/'+@t_mon+'/'+'31') = 1 then @t_htmldivb else '' end + case when (a.gno!='1') then @t_htmldivb else '' end d31,
	(case when (a.gno='1') then '合計' else @t_htmlPadding + cast(a.total as nvarchar) end) + @t_htmldivb total,maxday
from @tmp a
order by a.pageno,a.orderno,a.nick,a.gno;
--*********************************************************************************************
z_trand2A:--z_trand2A
declare @t_accy nvarchar(20)
declare @t_year int
set @t_accy = [12]
set @t_year = CAST(@t_accy as int) + 1911
declare @tmp table(
	gno nvarchar(1),
	pageno int,
	orderno int,
	nick nvarchar(max),
	m01 float,
	m02 float,
	m03 float,
	m04 float,
	m05 float,
	m06 float,
	m07 float,
	m08 float,
	m09 float,
	m10 float,
	m11 float,
	m12 float,
	total float
)
insert into @tmp
	select 
		'1' gno,0 pageno,0 orderno,b.nick,
		case when substring(a.datea, charindex('/', rtrim(a.datea))+1,2) = '01' then sum(a.mount) else null end,
		case when substring(a.datea, charindex('/', rtrim(a.datea))+1,2) = '02' then sum(a.mount) else null end,
		case when substring(a.datea, charindex('/', rtrim(a.datea))+1,2) = '03' then sum(a.mount) else null end,
		case when substring(a.datea, charindex('/', rtrim(a.datea))+1,2) = '04' then sum(a.mount) else null end,
		case when substring(a.datea, charindex('/', rtrim(a.datea))+1,2) = '05' then sum(a.mount) else null end,
		case when substring(a.datea, charindex('/', rtrim(a.datea))+1,2) = '06' then sum(a.mount) else null end,
		case when substring(a.datea, charindex('/', rtrim(a.datea))+1,2) = '07' then sum(a.mount) else null end,
		case when substring(a.datea, charindex('/', rtrim(a.datea))+1,2) = '08' then sum(a.mount) else null end,
		case when substring(a.datea, charindex('/', rtrim(a.datea))+1,2) = '09' then sum(a.mount) else null end,
		case when substring(a.datea, charindex('/', rtrim(a.datea))+1,2) = '10' then sum(a.mount) else null end,
		case when substring(a.datea, charindex('/', rtrim(a.datea))+1,2) = '11' then sum(a.mount) else null end,
		case when substring(a.datea, charindex('/', rtrim(a.datea))+1,2) = '12' then sum(a.mount) else null end,
		sum(a.mount)
	from view_transvcce a
	left join cust b on a.custno = b.noa
	where left(ltrim(rtrim(a.datea)),3) = @t_accy
	group by b.nick,substring(a.datea, charindex('/', rtrim(a.datea))+1,2)
insert into @tmp
	select 
		'0' gno,0 pageno,0 orderno,nick,
		sum(m01),sum(m02),sum(m03),sum(m04),sum(m05),sum(m06),sum(m07),sum(m08),
		sum(m09),sum(m10),sum(m11),sum(m12),sum(total)
	from @tmp
	where gno ='1'
	group by nick
delete @tmp where gno = '1'

insert into @tmp
	select 
		'1' gno,0 pageno,1 orderno,'總計' nick,
		sum(m01),sum(m02),sum(m03),sum(m04),sum(m05),sum(m06),sum(m07),sum(m08),
		sum(m09),sum(m10),sum(m11),sum(m12),sum(total)
	from @tmp where gno = '0'
select
	gno,pageno,orderno,nick,@t_accy + '年' m01,
	case when (gno='2') then '01月' else cast(m01 as nvarchar) end d01,
	case when (gno='2') then '02月' else cast(m02 as nvarchar) end d02,
	case when (gno='2') then '03月' else cast(m03 as nvarchar) end d03,
	case when (gno='2') then '04月' else cast(m04 as nvarchar) end d04,
	case when (gno='2') then '05月' else cast(m05 as nvarchar) end d05,
	case when (gno='2') then '06月' else cast(m06 as nvarchar) end d06,
	case when (gno='2') then '07月' else cast(m07 as nvarchar) end d07,
	case when (gno='2') then '08月' else cast(m08 as nvarchar) end d08,
	case when (gno='2') then '09月' else cast(m09 as nvarchar) end d09,
	case when (gno='2') then '10月' else cast(m10 as nvarchar) end d10,
	case when (gno='2') then '11月' else cast(m11 as nvarchar) end d11,
	case when (gno='2') then '12月' else cast(m12 as nvarchar) end d12,
	case when (gno='2') then '合計' else cast(total as nvarchar) end total
from @tmp order by orderno,pageno,nick,gno;
--*********************************************************************************************
z_trand99:--z_trand99
declare @t_date nvarchar(10)
declare @t_carno nvarchar(10)
declare @carno nvarchar(20)
declare	@driver nvarchar(20)
declare	@product nvarchar(20)
declare @nick nvarchar(20)
declare @b_year nvarchar(10)
declare @b_mon nvarchar(10)
declare @b_day nvarchar(10)
declare @i int
declare @Count int
set @t_date = case when '#non' = [3] then '' else [3] end
set @t_carno = case when '#non' = [4] then '%' else [4] end
set @carno = ''
set @driver = ''
set @product = ''
set @nick = ''
set @b_year = ''
set @b_mon = ''
set @b_day = ''
set @i = 0
declare @tmp table(
	gno nvarchar(1),
	idno int identity(0,1),
	b_year nvarchar(10),
	b_mon nvarchar(10),
	b_day nvarchar(10),
	carno nvarchar(20),
	driver nvarchar(20),
	product nvarchar(20),
	nick nvarchar(20)
)

insert into @tmp
	select '1',
	substring(trandate,1, charindex('/', trandate)-1) b_year,
	substring(trandate, charindex('/', trandate)+1,2) b_mon,
	RIGHT(trandate,2) b_day,
	carno,driver,product,nick 
	from view_trans[1]
	where (carteamno = '01') and ((trandate = @t_date) and (carno like @t_carno))
	order by b_year,b_mon,b_day,a.carno,nick,product
select @Count = COUNT(*) from @tmp
while(@i < (@Count+1))
begin
	if(@carno = '' and @driver = '' and @product = '' and @nick = '')
	begin
		select @carno = carno from @tmp where idno = @i
		select @driver = driver from @tmp where idno = @i
		select @product = product from @tmp where idno = @i
		select @nick = nick from @tmp where idno = @i
		select @b_year = b_year from @tmp where idno = @i
		select @b_mon = b_mon from @tmp where idno = @i
		select @b_day = b_day from @tmp where idno = @i
	end
	else
	begin
		if(
		@b_year = (select b_year from @tmp where idno = @i) and 
		@b_mon = (select b_mon from @tmp where idno = @i) and 
		@b_day = (select b_day from @tmp where idno = @i) and 
		@carno = (select carno from @tmp where idno = @i) and 
		@nick = (select nick from @tmp where idno = @i)
		)
		begin
			set @product +='/'
			select @product += product from @tmp where idno = @i
		end
		else
		begin
			insert into @tmp
				select '0',@b_year,@b_mon,@b_day,@carno,@driver,@product,@nick		
			set @carno = ''
			set @driver = ''
			set @product = ''
			set @nick = ''
			set @b_year = ''
			set @b_mon = ''
			set @b_day = ''	
			set @i -= 1	
		end
	end
	set @i +=1
end
select * from @tmp;