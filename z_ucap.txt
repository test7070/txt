z_ucap1:--z_ucap1
--declare @productno nvarchar(50)
declare @t_bspno nvarchar(50)
declare @t_espno nvarchar(50)
declare @t_style nvarchar(50)
declare @t_groupano nvarchar(50)
declare @parent nvarchar(20)
declare @t_mon nvarchar(20)
declare @t_typea nvarchar(50)
declare @t_isprice nvarchar(20)
declare @t_groupbno nvarchar(50)

--set @productno = case when '#non'=[2] then '' else [2] end
set @t_bspno = case when '#non' = [3] then '' else [3] end
set @t_espno = case when '#non' = [4] then CHAR(255) else [4] end
set @t_mon = case when '#non' = [5] then '' else [5] end
set @t_typea = case when '#non' = [6] then '' else [6] end
set @t_groupano = case when '#non' = [7] then '' else [7] end
set @t_isprice = case when '#non'=[9] then '' else [9] end
set @t_style = case when '#non' = [12] then '' else [12] end
set @t_groupbno = case when '#non' = [47] then '' else [47] end
set @parent='root'
------------報表設定<<Start>>------------
declare @pageline int = 23 --每頁幾行
------------報表設定<<End>>------------
IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
	drop table #tmp
END

create table #tmp(
	productno nvarchar(MAX),
	product nvarchar(MAX),
	parent nvarchar(255),
	mount float,
	dividea int,
	mul int,
	price float,
	costb float,--人工
	costc float,--製造費用
	costd float,
	hours float,
	minutes float,
	hminutes float,
	sec float,
	hsec float,
	preday float,
	pretime float,
	noq nvarchar(MAX)
)
declare @result table(
	gno nvarchar(10),
	idno int identity(0,1),
	pageno int,
	uno nvarchar(MAX),
	pno nvarchar(max),
	product nvarchar(max),
	level int,
	sortcol nvarchar(max),
	mount float,
	dividea nvarchar(max),
	mul nvarchar(max),
	costa float,
	costb float,
	costc float,
	costd float,
	hours float,
	minutes float,
	hminutes float,
	sec float,
	hsec float,
	preday float,
	pretime float,
	ucccost float,
	stationno nvarchar(max),
	stations nvarchar(max),
	tggno nvarchar(max),
	tggs nvarchar(max)
)

insert into #tmp
select a.productno,a.product,a.noa,(isnull(a.mount,0)*(case when isnull(a.mul,0) =0 then 1 else isnull(a.mul,0) end)),a.dividea,a.mul
,isnull(c.price,0)
,isnull(b.wages*((b.minutes+(b.hsec/60))/60),0)
,isnull(b.makes*((b.minutes+(b.sec/60))/60),0)
,isnull(b.price,0)
,isnull(b.hours,0),isnull(b.minutes,0),isnull(b.hminutes,0),isnull(b.sec,0),isnull(b.hsec,0)
,isnull(b.preday,0),isnull(b.pretime,0)
,noq
from ucas a outer apply (select * from uca where noa=a.productno) b
outer apply (select * from view_costs where mon=@t_mon and productno=a.productno)c

insert into #tmp
select a.noa,a.product,@parent,1,0,0
,isnull(b.price,0)
,isnull(a.wages*((a.minutes+(a.sec/60))/60),0)
,isnull(a.makes*((a.minutes+(a.sec/60))/60),0)
,isnull(a.price,0)
,isnull(a.hours,0)
,isnull(a.minutes,0)
,isnull(a.hminutes,0)
,isnull(a.sec,0)
,isnull(a.hsec,0)
,isnull(a.preday,0)
,isnull(a.pretime,0)
,'000' from uca a 
outer apply (select * from view_costs where mon=@t_mon and productno=a.noa)b
where a.noa between @t_bspno and @t_espno 
and (len(@t_groupano)=0 or a.groupano=@t_groupano)
and (len(@t_groupbno)=0 or a.groupbno=@t_groupbno)
and (len(@t_style)=0 or charindex(@t_style,a.style)>0) 
and (len(@t_typea)=0 or a.typea=@t_typea)

CREATE INDEX tmpindex1 ON #tmp (parent)

BEGIN TRY
	--遞迴
	WITH OrdersTable (uno,productno,product,noa,Level,sortCol,mount,dividea,mul,price,costb,costc,costd,hours,minutes,hminutes,sec,hsec,preday,pretime) as (
		Select
			productno,productno,product,parent,0, CONVERT(nvarchar(MAX),productno),mount,dividea,mul,price,costb,costc,costd,hours,minutes,hminutes,sec,hsec,preday,pretime
		from #tmp
		where parent=@parent
		UNION ALL
		SELECT
			OrdersTable.uno,a.productno,a.product,a.parent,OrdersTable.Level+1,CONVERT(nvarchar(MAX)
			,OrdersTable.SortCol+'-'+CONVERT(nvarchar(128),a.productno)+'**'+a.noq),a.mount,a.dividea,a.mul,a.price,a.costb,a.costc,a.costd,a.hours,a.minutes,a.hminutes,a.sec,a.hsec,a.preday,a.pretime
		FROM #tmp a, OrdersTable
		WHERE a.parent=OrdersTable.productno
	)
	insert into @result
		Select
			case when @t_isprice='1' then '2' else '5' end gno,0 pageno,a.uno,
			a.productno pno,a.product, a.level, a.sortcol,round(a.mount,4) mount,
			case when isnull(a.dividea,0)=0 or isnull(a.dividea,0)=1 then null else ' / '+CAST(a.dividea as nvarchar(10)) end dividea,
			case when isnull(a.mul,0)=0 or isnull(a.mul,0)=0 then null else ' * '+CAST(a.mul as nvarchar(10)) end mul,
			case when @t_isprice='1' then isnull(a.price*a.mount,0) else null end costa,a.costb,a.costc,a.costd,a.hours,a.minutes,a.hminutes,a.sec,a.hsec,a.preday,a.pretime,
			case when @t_isprice='1' then
				(select SUM(price*mount+costb+costc+costd) from OrdersTable where left(sortcol,len(a.sortcol))=a.sortcol)
			else null end ucccost,
			b.stationno stationno,
			b.station stations,
			case when (isnull(b.tggno,'')='') and (b.isoutsource='1') then 'V' else b.tggno end tggno,
			case when (isnull(b.comp,'')='') and (b.isoutsource='1') then '' else b.comp end tggs
		From OrdersTable a
		left join uca b on (a.productno=b.noa)
		order by a.sortCol
END TRY
BEGIN CATCH
	select @@ERROR productno
	return
END CATCH

insert @result(uno,gno,pageno,sortcol)
select uno,case when @t_isprice='1' then '2' else '5' end,0,MAX(sortcol)+'ZZZZ' from @result group by uno

--------gno-> 1=顯示單價的表頭,2=有顯示單價的表身,3=有顯示單價的表尾,4=沒顯示單價的表頭,5=沒顯示單價的表身,6=沒顯示單價的表尾
------------更新頁數<<Start>>------------
declare @idno int
declare @pageno int
declare @recCount int = 1
declare @pageno_int int = 0
declare @lastnoa nvarchar(max) = ''
declare @nextidno int
declare @nextnoa nvarchar(max)
declare @nextnoq nvarchar(10)
declare @nextproductno nvarchar(max)
declare cursor_table cursor for
	select
		a.idno
	from @result a order by a.sortcol
open cursor_table
fetch next from cursor_table
into @idno
while(@@FETCH_STATUS <> -1)
begin
	if((@recCount > @pageline))
	begin
		set @recCount = 1
		set @pageno_int = @pageno_int+1
	end
	if(@recCount = @pageline)
	begin
		set @nextidno = @idno+1
	end
	update @result set pageno=@pageno_int where idno=@idno
	set @recCount = @recCount+1
	fetch next from cursor_table
	into @idno
end
close cursor_table
deallocate cursor_table
------------更新頁數<<End>>-------------
------------插入表頭及表尾<<Start>>-------------
insert into @result(gno,pageno)
select case when @t_isprice='1' then '1' else '4' end gno,pageno
from @result group by pageno

insert into @result(gno,pageno)
select case when @t_isprice='1' then '7' else '8' end gno,pageno
from @result where pageno!=@pageno_int group by pageno

insert into @result(gno,pageno)
select case when @t_isprice='1' then '3' else '6' end gno,pageno
from @result where pageno=@pageno_int group by pageno

------------插入表頭及表尾<<End>>-------------
select uno,
	case when a.pno IS NULL and a.gno='2' then '9' when a.pno IS NULL and a.gno='5' then '10' else a.gno end  gno
	,a.gno xgno,a.idno,a.pageno,a.pno,a.product,REPLICATE('--',a.Level) +cast(a.level as nvarchar(10))level
	,a.sortcol,a.mount,a.dividea,a.mul,a.costa,a.costb,
	a.costc,a.costd,a.hours,a.minutes,a.hminutes,a.sec,a.hsec,
	case a.preday when 0 then null else a.preday end preday,
	case a.pretime when 0 then null else a.pretime end pretime,
	a.ucccost,a.stationno,a.stations,a.tggno
	,(select top 1 (case when isnull(nick,'')!='' then nick when isnull(comp,'')!='' then left(comp,4) else left(a.tggs,4) end) from tgg where noa=a.tggno) tggs
	, case when stuff(isnull(dividea,''),1,3,'')=stuff(isnull(mul,''),1,3,'') then cast(a.mount as nvarchar) else cast(a.mount as nvarchar)+isnull(dividea,'')+isnull(mul,'') end modiv
	--,case when (a.hours=0 and a.minutes=0) then null when (a.minutes>0) then cast(a.minutes as nvarchar)+' Min'	else cast(a.hours as nvarchar)+' Hr' end usetime
	--105/03/31 顯示分秒
	,case when (a.sec=0 and a.minutes=0) then null when (a.minutes>0) then cast(a.minutes as nvarchar)+' Min'	else cast(a.sec as nvarchar)+' Sec' end usetime
	,case when (a.hsec=0 and a.hminutes=0) then null when (a.hminutes>0) then cast(a.hminutes as nvarchar)+' Min'	else cast(a.hsec as nvarchar)+' Sec' end husetime
	,case when (select COUNT(*) from ucc where noa= replace(a.pno,'　　',''))>0 then 'v' else '' end isucc
	,'uca?left(noa,'+cast(len(a.pno) as nvarchar)+')=$pno?' ghref
from @result a
order by a.pageno,xgno,a.sortCol

IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
	drop table #tmp
END
;
------------------------------------------------------------------------------------------------------------
z_ucap2:--z_ucap2
SET QUOTED_IDENTIFIER OFF
declare @t_bspno nvarchar(50)
declare @t_espno nvarchar(50)
declare @t_mon nvarchar(20)
declare @t_typea nvarchar(50)
declare @t_groupano nvarchar(50)
declare @t_style nvarchar(50)
declare @t_sbcost nvarchar(50)
declare @t_order nvarchar(50)
declare @t_brate nvarchar(50)
declare @t_erate nvarchar(50)
declare @t_showgno0 nvarchar(50)
declare @t_groupbno nvarchar(50)
declare @t_xcoin nvarchar(50)
declare @t_floata float

set @t_bspno = case when '#non' = [3] then '' else [3] end
set @t_espno = case when '#non' = [4] then CHAR(255) else [4] end
set @t_mon = case when '#non' = [5] then '' else [5] end
set @t_typea = case when '#non' = [6] then '' else [6] end
set @t_groupano = case when '#non' = [7] then '' else [7] end
set @t_style = case when '#non' = [12] then '' else [12] end
set @t_sbcost = case when '#non' = [39] then '' else [39] end
set @t_order = case when '#non' = [40] then '' else [40] end
set @t_brate = case when '#non' = [41] then '-9999' else [41] end
set @t_erate = case when '#non' = [42] then '99999' else [42] end
set @t_showgno0 = case when '#non' = [43] then '' else [43] end
set @t_groupbno = case when '#non' = [47] then '' else [47] end
set @t_xcoin = case when '#non' = [48] then '' else [48] end
set @t_floata=case when @t_xcoin='' then 1 else isnull((select top 1 floata from flors where coin=@t_xcoin order by bdate desc),0) end
-----------------------------------------------------------------------------------------------------------------------------------------
declare @parent nvarchar(20)
set @parent='root'

IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
	drop table #tmp
END

IF OBJECT_ID('tempdb..#tmpa')is not null
BEGIN
	drop table #tmpa
END

create table #tmp(
	xnoa nvarchar(MAX),
	productno nvarchar(MAX),
	product nvarchar(MAX),
	parent nvarchar(255),
	unit nvarchar(MAX),
	mount float,
	badperc float,
	price float,
	costa float,--材料
	costb float,--人工
	costc float,--製造費用
	costd float,--託工費用
	coste float, --管銷費用
	costf float, --失敗成本
	costg float, --機器折舊
	costh float, --模具費用
)

create table #tmpa(
	gno nvarchar(1),
	xnoa nvarchar(MAX),
	sortcol nvarchar(MAX),
	productno nvarchar(MAX),
	product nvarchar(MAX),
	levels int,
	mount float,
	unit nvarchar(20),
	badperc float,
	stpr float,----材料單價(子)
	costa float,----直接材料(子)
	costb float,----直接人工(子)
	costd float,---託工費用(子)
	adpr float,----加扣款(子)
	costc float,----製造費用(子)
	total float,---總成本(子)
	
	stcost float, --標準成本
	accost float, --實際成本
	diff float, --比較 +-
	coste float, --管銷費用
	costf float, --失敗成本
	costg float, --機器折舊
	costh float, --模具費用
	vprice float,--最近銷售價
	rate float --毛利
)

if(@t_showgno0!='1') --106/03/20 子階
begin
	insert #tmpa(gno,xnoa,productno,product,unit,levels,sortcol,mount,badperc,stpr,costa,costb,costc,costd,adpr,coste,costf,costg,costh)
	select '0' gno,a.noa,a.noa,a.product,a.unit,0,a.noa,1,a.badperc,b.price
	,isnull(d.costa,0)/case when ISNULL(d.cmount,0)=0 then 1 else d.cmount end
	,isnull(d.costb,0)/case when ISNULL(d.cmount,0)=0 then 1 else d.cmount end
	,isnull(d.costc,0)/case when ISNULL(d.cmount,0)=0 then 1 else d.cmount end
	,isnull(d.costd,0)/case when ISNULL(d.cmount,0)=0 then 1 else d.cmount end
	,isnull((select avg(wages_fee+makes_fee) from ucap where noa=a.noa and left(datea,len(bmon)-3)=left(bmon,len(bmon)-3)),0) plus
	,isnull(d.coste,0)/case when ISNULL(d.cmount,0)=0 then 1 else d.cmount end
	,isnull(d.costf,0)/case when ISNULL(d.cmount,0)=0 then 1 else d.cmount end
	,isnull(d.costg,0)/case when ISNULL(d.cmount,0)=0 then 1 else d.cmount end
	,isnull(d.costh,0)/case when ISNULL(d.cmount,0)=0 then 1 else d.cmount end
	From uca a 
	outer apply (select top 1 price from view_costs where productno=a.noa order by mon desc)b --mon=@t_mon and
	outer apply (select MAX(mon) mon from view_wcost where productno=a.noa)e
	outer apply (select SUM(costa)costa,SUM(costb)costb,SUM(costc)costc,SUM(costd)costd 
	,SUM(coste) coste,SUM(costf) costf,SUM(costg) costg,SUM(costh)costh,SUM(mount) cmount
	from view_wcost where mon=e.mon and productno=a.noa)d --@t_mon
	outer apply (select MAX(datea) bmon from ucap where noa=a.noa)f
	where a.noa between @t_bspno and @t_espno
	and (len(@t_typea)=0 or a.typea=@t_typea)
	and (len(@t_groupano)=0 or a.groupano=@t_groupano)
	and (len(@t_groupbno)=0 or a.groupbno=@t_groupbno)
	and (len(@t_style)=0 or charindex(@t_style,a.style)>0) 
end
else
begin
	--106/02/20 costb-d 抓wcost
	insert into #tmp
	select '',a.productno,a.product,a.noa,a.unit
	,(isnull(a.mount,0)*(case when isnull(a.mul,0) =0 then 1 else isnull(a.mul,0) end))
	/(case when isnull(a.dividea,0) =0 then 1 else isnull(a.dividea,0) end),a.loss
	,isnull(c.price,0)
	--,isnull(b.wages*((b.minutes+(b.hsec/60))/60),0)
	--,isnull(b.makes*((b.minutes+(b.sec/60))/60),0)
	--,isnull(b.price,0)
	,isnull(d.costa,0)/case when ISNULL(d.cmount,0)=0 then 1 else d.cmount end
	,isnull(d.costb,0)/case when ISNULL(d.cmount,0)=0 then 1 else d.cmount end
	,isnull(d.costc,0)/case when ISNULL(d.cmount,0)=0 then 1 else d.cmount end
	,isnull(d.costd,0)/case when ISNULL(d.cmount,0)=0 then 1 else d.cmount end
	,isnull(d.coste,0)/case when ISNULL(d.cmount,0)=0 then 1 else d.cmount end
	,isnull(d.costf,0)/case when ISNULL(d.cmount,0)=0 then 1 else d.cmount end
	,isnull(d.costg,0)/case when ISNULL(d.cmount,0)=0 then 1 else d.cmount end
	,isnull(d.costh,0)/case when ISNULL(d.cmount,0)=0 then 1 else d.cmount end
	from ucas a outer apply (select * from uca where noa=a.productno)b
	outer apply (select top 1 price from view_costs where productno=a.productno order by mon desc) c --mon=@t_mon and
	outer apply (select MAX(mon) mon from view_wcost where productno=a.productno)e
	outer apply (select SUM(costa)costa,SUM(costb)costb,SUM(costc)costc,SUM(costd)costd 
	,SUM(coste)coste,SUM(costf)costf,SUM(costg)costg,SUM(costh)costh,SUM(mount) cmount
	from view_wcost where mon=e.mon and productno=a.productno)d --@t_mon
	where isnull(mount,0)!=0
	
	insert into #tmp
	select a.noa,a.noa,a.product,@parent
	,isnull(a.unit,''),1,a.badperc
	,isnull(b.price,0)
	--,isnull(a.wages*((isnull(a.minutes,0)+(isnull(a.hsec,0)/60))/60),10)
	--,isnull(a.makes*((isnull(a.minutes,0)+(isnull(a.sec,0)/60))/60),10)
	--,isnull(a.price,0)
	,isnull(d.costa,0)/case when ISNULL(d.cmount,0)=0 then 1 else d.cmount end
	,isnull(d.costb,0)/case when ISNULL(d.cmount,0)=0 then 1 else d.cmount end
	,isnull(d.costc,0)/case when ISNULL(d.cmount,0)=0 then 1 else d.cmount end
	,isnull(d.costd,0)/case when ISNULL(d.cmount,0)=0 then 1 else d.cmount end
	,isnull(d.coste,0)/case when ISNULL(d.cmount,0)=0 then 1 else d.cmount end
	,isnull(d.costf,0)/case when ISNULL(d.cmount,0)=0 then 1 else d.cmount end
	,isnull(d.costg,0)/case when ISNULL(d.cmount,0)=0 then 1 else d.cmount end
	,isnull(d.costh,0)/case when ISNULL(d.cmount,0)=0 then 1 else d.cmount end
	from uca a outer apply (select top 1 price from view_costs where productno=a.noa order by mon desc)b --mon=@t_mon and
	outer apply (select MAX(mon) mon from view_wcost where productno=a.noa)e
	outer apply (select SUM(costa)costa,SUM(costb)costb,SUM(costc)costc,SUM(costd)costd 
	,SUM(coste)coste,SUM(costf)costf,SUM(costg)costg,SUM(costh)costh,SUM(mount) cmount
	from view_wcost where mon=e.mon and productno=a.noa)d --@t_mon
	where a.noa between @t_bspno and @t_espno
	and (len(@t_typea)=0 or a.typea=@t_typea)
	and (len(@t_groupano)=0 or a.groupano=@t_groupano)
	and (len(@t_groupbno)=0 or groupbno=@t_groupbno)
	and (len(@t_style)=0 or charindex(@t_style,a.style)>0) 
	
	CREATE INDEX tmpindex1 ON #tmp (parent)
	
	BEGIN TRY
	--遞迴
		WITH OrdersTable (xnoa,productno,product,unit,noa,Level,sortCol,mount,badperc,price,costa,costb,costc,costd,coste,costf,costg,costh) as (
			Select xnoa,productno,product,unit,parent,0, CONVERT(nvarchar(128),productno),mount,badperc,price,costa,costb,costc,costd,coste,costf,costg,costh
			from #tmp
			where parent=@parent
			UNION ALL
			SELECT OrdersTable.xnoa,a.productno,a.product,a.unit,a.parent,OrdersTable.Level+1,CONVERT(nvarchar(128)
			,OrdersTable.SortCol+'-'+CONVERT(nvarchar(128),a.productno)),a.mount,a.badperc,a.price,a.costa,a.costb,a.costc,a.costd,a.coste,a.costf,a.costg,a.costh
			FROM #tmp a, OrdersTable
			WHERE a.parent=OrdersTable.productno and a.parent!=@parent
		)
		
		insert #tmpa(gno,xnoa,productno,product,unit,levels,sortcol,mount,badperc,stpr,costa,costb,costc,costd,coste,costf,costg,costh,adpr)
		select '2' gno,xnoa,productno,product,unit, level, sortcol
		,mount,badperc,price,costa,costb,costc,costd,coste,costf,costg,costh
		--,isnull((select avg(wages_fee+makes_fee) from ucap where noa=a.productno and left(datea,6)=@t_mon),0) plus
		,isnull((select avg(wages_fee+makes_fee) from ucap where noa=a.productno and left(datea,len(bmon)-3)=left(bmon,len(bmon)-3)),0) plus
		From OrdersTable a 
		outer apply (select MAX(datea) bmon from ucap where noa=a.productno)b
		order by sortCol
		
	END TRY
	BEGIN CATCH
	select @@ERROR productno
	END CATCH
end
------------------------------------------------------------------------------------------------------------
update #tmpa
set total=costa+costb+costc+costd+adpr

if(@t_showgno0='1')--106/03/20 子階
begin
	insert #tmpa (gno,xnoa,sortcol,productno,levels,costa,costb,costd,adpr,costc,total)
	select '3',xnoa,productno+'ZZZZZZZ',productno,99
	,(select sum(costa) from #tmpa x where xnoa=a.productno and exists (select noa from ucc where noa=x.productno))
	,(select sum(costb) from #tmpa x where xnoa=a.productno)
	,(select sum(costd) from #tmpa x where xnoa=a.productno)
	,(select sum(adpr) from #tmpa x where xnoa=a.productno)
	,(select sum(costc) from #tmpa x where xnoa=a.productno)
	,0
	from #tmpa a where levels=0
	
	update a
	set total=ISNULL(costa,0)+ISNULL(costb,0)+ISNULL(costd,0)+ISNULL(adpr,0)+ISNULL(costc,0) 
	from #tmpa a
	where gno='3'
end

update #tmpa set gno='0' where levels=0

-------------------------------------------------------------
IF OBJECT_ID('tempdb..#tmpacc')is not null
BEGIN
	drop table #tmpacc
END

IF OBJECT_ID('tempdb..#tmpworkb')is not null
BEGIN
	drop table #tmpworkb
END

IF OBJECT_ID('tempdb..#tmpvcc')is not null
BEGIN
	drop table #tmpvcc
END

declare @t_accy nvarchar(20)='106' 
declare @t_stbaccy nvarchar(20)=@t_accy 
declare @t_steaccy nvarchar(20)=@t_accy 
declare @t_stbdate nvarchar(20)='2016/02/01' 
declare @t_stedate nvarchar(20)='2017/01/31' 

create table #tmpacc(
	datea nvarchar(50),
	acc1 nvarchar(50),
	acc2 nvarchar(150),
	partno nvarchar(50),
	money float
)

/*if(@t_stbdate!='')
begin
	if(len(@t_stbdate)=10)
		set @t_stbaccy=right('000'+cast(CAST(left(@t_stbdate,4) as int)-1911 as nvarchar(50)),3)
	else
		set @t_stbaccy=left(@t_stbdate,3)
end
EXEC("
	insert #tmpacc select accc2,accc5,accc6,part,dmoney from acccs"+@t_stbaccy+"_1 
	where left(accc5,1) ='6' or left(accc5,1) ='8' or left(accc5,1) ='9'
	and accc2>=right('"+@t_stbdate+"',5)
")

if(@t_stedate!='')
begin
	if(len(@t_stedate)=10)
		set @t_steaccy=right('000'+cast(CAST(left(@t_stedate,4) as int)-1911 as nvarchar(50)),3)
	else
		set @t_steaccy=left(@t_stedate,3)
end
--同年度不重複插入
if(@t_stbaccy!=@t_steaccy)
begin
	EXEC("
		insert #tmpacc select accc2,accc5,accc6,part,dmoney from acccs"+@t_steaccy+"_1 
		where left(accc5,1) ='6' or left(accc5,1) ='8' or left(accc5,1) ='9'
		and accc2 <=right('"+@t_steaccy+"',5)
	")
end*/

create table #tmpworkb(
	productno nvarchar(255),
	mount float,
	xmin float,
	xsec float,	
	totalsec float,
	stcost float,
	stationno nvarchar(50),
	partno nvarchar(50)
)

/*insert #tmpworkb(productno,mount,stationno)
select b.productno,SUM(isnull(mount,0)+isnull(wmount,0)),a.stationno
from view_workb a left join view_workbs b on a.noa=b.noa
where a.datea between @t_stbdate and @t_stedate
group by b.productno,a.stationno

update a 
set xsec=case when isnull(b.sec,0)>isnull(b.hsec,0) then isnull(b.hsec,0) else isnull(b.sec,0) end
,xmin=case when isnull(b.minutes,0)>isnull(b.hminutes,0) then isnull(b.hminutes,0) else isnull(b.minutes,0) end
from #tmpworkb a left join uca b on a.productno=b.noa

update a 
set totalsec=mount*case when ISNULL(xmin,0)!=0 then xmin*60 else xsec end
from #tmpworkb a left join uca b on a.productno=b.noa

delete #tmpworkb where totalsec=0

update a 
set partno=isnull(b.partno,'')
from #tmpworkb a outer apply (select * from station where noa=a.stationno) b

update a
set stcost=isnull((select SUM(money) from #tmpacc where acc2 like '製造費用-%' and acc2 not like '%物料%' and partno=a.partno),0)
*(a.totalsec/isnull((select SUM(totalsec) from #tmpworkb where a.partno=a.partno),0))
from #tmpworkb a*/


--毛利=case when 實際>0 then 實際 else 標準 end 目前 先撈 標準
update a
set stcost=isnull(b.stcost,0)
,accost=0 --報工時間，先不管
,diff=isnull(b.stcost,0)-0
,vprice=case when isnull(e.vprice,0)!=0 then ISNULL(e.vprice,0) else ISNULL(d.oprice,0) end
-- 無實際成本時，以 標準成本 算 
,rate=case when case when isnull(e.vprice,0)!=0 then ISNULL(e.vprice,0) else ISNULL(d.oprice,0) end=0 then 0 else (case when isnull(e.vprice,0)!=0 then ISNULL(e.vprice,0) else ISNULL(d.oprice,0) end-isnull(a.total,0))/case when isnull(e.vprice,0)!=0 then ISNULL(e.vprice,0) else ISNULL(d.oprice,0) end end *100
from #tmpa a
outer apply (select stcost from #tmpworkb where productno=a.productno) b
outer apply (select top 1 ISNULL(ob.price,0) *case when isnull(oa.floata,0)=0 then 1 else oa.floata end oprice 
from view_ordes ob left join view_orde oa on oa.noa=ob.noa
where ob.productno=a.productno order by ob.odate desc)d
outer apply (select top 1 isnull(vb.price,0)*case when isnull(oa.floata,0)=0 then 1 else oa.floata end vprice 
from view_vccs vb left join view_orde oa on oa.noa=vb.ordeno
where vb.productno=a.productno order by vb.datea desc)e

update a
set stcost=(select SUM(stcost) from #tmpa where xnoa=a.xnoa and gno='2')
,accost=(select SUM(accost) from #tmpa where xnoa=a.xnoa and gno='2')
,diff=(select SUM(diff) from #tmpa where xnoa=a.xnoa and gno='2')
from #tmpa a where gno='3'

update a
set rate=case when ISNULL(vprice,0)=0 then 0 else (ISNULL(vprice,0)-isnull(total,0))/ISNULL(vprice,0) end *100
from #tmpa a where gno='3'

if(@t_sbcost='1')
	delete #tmpa where accost<stcost and gno='2'
	
delete #tmpa where gno='2' and rate not between cast(@t_brate as float) and cast(@t_erate as float)

update #tmpa 
set badperc=case when badperc=0 then null else badperc end
,stpr=case when stpr=0 then null else stpr end
,costa=case when costa=0 then null else costa end
,costb=case when costb=0 then null else costb end
,costc=case when costc=0 then null else costc end
,costd=case when costd=0 then null else costd end
,adpr=case when adpr=0 then null else adpr end
,total=case when total=0 then null else total end
,stcost=case when stcost=0 then null else stcost end
,accost=case when accost=0 then null else accost end
,diff=case when diff=0 then null else diff end
,coste=case when coste=0 then null else coste end
,costf=case when costf=0 then null else costf end
,costg=case when costg=0 then null else costg end
,costh=case when costh=0 then null else costh end
,vprice=case when vprice=0 then null else vprice end
,rate=case when rate=0 then null else rate end
where gno='2'

if(@t_showgno0='1')
begin
	update #tmpa set stcost=null,accost=null,diff=null,coste=null,costf=null,costg=null,costh=null --,vprice=null,rate=null
	where gno='0'
	
	insert #tmpa(gno,xnoa)
	select '1',xnoa from #tmpa where gno='2' group by xnoa
end

select gno,sortcol,productno,product xproduct,REPLICATE('&nbsp&nbsp',(levels-1))+cast(levels as nvarchar(20)) levels,unit
,dbo.getComma(mount,5) mount
,dbo.getComma(badperc,-1) badperc
,dbo.getComma(stpr/case when @t_floata=0 then 1 else @t_floata end,2) stpr
,dbo.getComma(costa/case when @t_floata=0 then 1 else @t_floata end,2) costa
,dbo.getComma(costb/case when @t_floata=0 then 1 else @t_floata end,2) costb
,dbo.getComma(costc/case when @t_floata=0 then 1 else @t_floata end,2) costc
,dbo.getComma(costd/case when @t_floata=0 then 1 else @t_floata end,2) costd
,dbo.getComma(adpr/case when @t_floata=0 then 1 else @t_floata end,2) adpr
,dbo.getComma(coste/case when @t_floata=0 then 1 else @t_floata end,2) coste
,dbo.getComma(costf/case when @t_floata=0 then 1 else @t_floata end,2) costf
,dbo.getComma(costg/case when @t_floata=0 then 1 else @t_floata end,2) costg
,dbo.getComma(costh/case when @t_floata=0 then 1 else @t_floata end,2) costh
,dbo.getComma(total/case when @t_floata=0 then 1 else @t_floata end,2) total
,(case when @t_typea='2' then '製成品' when @t_typea='3' then '半成品' else '製成品、半成品' end) typea
,(case when len(@t_groupano)=0 then '全部' else (select namea from uccga where noa=@t_groupano) end) groupa

,dbo.getComma(stcost/case when @t_floata=0 then 1 else @t_floata end,2) stcost
,dbo.getComma(accost/case when @t_floata=0 then 1 else @t_floata end,2) accost --報工時間，先不管
,dbo.getComma(diff/case when @t_floata=0 then 1 else @t_floata end,2) diff
,dbo.getComma(coste/case when @t_floata=0 then 1 else @t_floata end,2) coste
,dbo.getComma(vprice/case when @t_floata=0 then 1 else @t_floata end,2) vprice
,dbo.getComma(rate,2) rate
from #tmpa
order by case when @t_showgno0='1' then xnoa else '0' end
,gno
,case when @t_order='rate' then rate else 0 end desc
,sortcol,levels

IF OBJECT_ID('tempdb..#tmpacc')is not null
BEGIN
	drop table #tmpacc
END

IF OBJECT_ID('tempdb..#tmpworkb')is not null
BEGIN
	drop table #tmpworkb
END

IF OBJECT_ID('tempdb..#tmpvcc')is not null
BEGIN
	drop table #tmpvcc
END

IF OBJECT_ID('tempdb..#tmpa')is not null
BEGIN
	drop table #tmpa
END

IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
	drop table #tmp
END
;
---**********************************************************************************************
z_ucap3:--z_ucap3
declare @productno nvarchar(50)
declare @t_style nvarchar(50)
set @productno = case when '#non'=[2] then '' else [2] end
set @t_style = case when '#non' = [12] then '' else [12] end
SET QUOTED_IDENTIFIER OFF

select '0' gno, case when a.noa=@productno then "<font color='red'>"+a.noa+"</font>" else a.noa end bpno,a.product bps,a.style bstyle,a.unit bunit,a.badperc bloss,a.memo bmemo
,case when b.productno=@productno then "<font color='red'>"+b.productno+"</font>" else b.productno end epno,b.product eps
,(select top 1 style from (select style from uca where noa=b.productno union all select style from ucc where noa=b.productno)tmp) estyle
,b.unit eunit,b.mount mount,b.loss eloss,b.memo ememo
from uca a left join ucas b on a.noa=b.noa
where (len(@productno)=0 or (a.noa=@productno or b.productno=@productno))
and ((len(@t_style)=0 or charindex(@t_style,a.style)>0) 
or (len(@t_style)=0 or charindex(@t_style,(select top 1 style from (select style from uca where noa=b.productno union all select style from ucc where noa=b.productno)tmp))>0))
order by b.noa,b.noq
;
------------------------------------------------------------*
z_ucap4:--z_ucap4
declare @t_bpno nvarchar(50)
declare @t_epno nvarchar(50)
declare @t_bsgno nvarchar(50)
declare @t_esgno nvarchar(50)
declare @t_style nvarchar(50)

set @t_bpno = case when '#non' = [3] then '' else [3] end
set @t_epno = case when '#non' = [4] then CHAR(255) else [4] end
set @t_bsgno = case when '#non' = [10] then '' else [10] end
set @t_esgno = case when '#non' = [11] then CHAR(255) else [11] end
set @t_style = case when '#non' = [12] then '' else [12] end
-----------------------------------------------------------------------------
declare @tmp table(
	gno nvarchar(10),
	productno nvarchar(90),
	products nvarchar(max),
	style nvarchar(90),
	hours float,
	minutes float,
	sec float,
	stationno nvarchar(max),
	stations nvarchar(max),
	tggno nvarchar(max),
	comp nvarchar(max),
	BBsCount float,
	memo nvarchar(max),
	primary key(productno)
)
insert into @tmp
	select
		'0' gno,noa,product,style,isnull(hours,0) hours,isnull(minutes,0) minutes,isnull(sec,0),
		isnull(stationno,'')stationno,isnull(station,'')station,isnull(tggno,'')tggno,isnull(comp,'')comp,
		(select count(*) from ucas where ucas.noa=uca.noa) BBsCount,'' memo
	from uca where (noa between @t_bpno and @t_epno) and (isnull(stationgno,'') between @t_bsgno and @t_esgno) 
	and (len(@t_style)=0 or charindex(@t_style,style)>0) 
	
declare @productno nvarchar(max)
declare @products nvarchar(max)
declare @hours float
declare @minutes float
declare @sec float
declare @stationno nvarchar(max)
declare @stations nvarchar(max)
declare @tggno nvarchar(max)
declare @comp nvarchar(max)
declare @BBsCount float
declare cursor_table cursor for
	select productno,products,hours,minutes,sec,stationno,stations,tggno,comp,BBsCount from @tmp
open cursor_table
fetch next from cursor_table
into @productno,@products,@hours,@minutes,@sec,@stationno,@stations,@tggno,@comp,@BBsCount
while(@@FETCH_STATUS <> -1)
begin
	declare @status nvarchar(max) = ''
	if(@BBsCount=0)
		set @status = '沒有表身'+char(59)+@status
	if(@hours=0 and @minutes=0)
		set @status = '沒有標時'+char(59)+@status
	if(@stationno='' and @tggno='')
		set @status = '沒有工作中心也無委外廠商'+char(59)+@status
	update @tmp set memo = @status where productno = @productno
	fetch next from cursor_table
	into @productno,@products,@hours,@minutes,@sec,@stationno,@stations,@tggno,@comp,@BBsCount
end
close cursor_table
deallocate cursor_table

select
	ROW_NUMBER()over(order by a.productno asc)recno,
	a.gno,a.productno,a.products,a.style,a.hours,a.minutes,a.sec,a.stationno,a.stations,a.tggno,a.comp,a.BBsCount,a.memo,
	'uca?left(noa,'+cast(len(a.productno) as nvarchar)+')=$productno?' qhref
from @tmp a
where (len(isnull(a.memo,0)) > 0)
order by a.productno;
---**********************************************************************************************
z_ucap5:--z_ucap5
declare @t_bpno nvarchar(50)
declare @t_epno nvarchar(50)
declare @t_typea nvarchar(50)
declare @t_groupano nvarchar(50)
declare @t_style nvarchar(50)
declare @t_groupbno nvarchar(50)

set @t_bpno = case when '#non' = [3] then '' else [3] end
set @t_epno = case when '#non' = [4] then CHAR(255) else [4] end
set @t_typea = case when '#non' = [6] then '' else [6] end
set @t_groupano = case when '#non' = [7] then '' else [7] end
set @t_style = case when '#non' = [12] then '' else [12] end
set @t_groupbno = case when '#non' = [47] then '' else [47] end

select '0' gno
,ROW_NUMBER()over(order by groupano,typea,noa)recno
,case when typea='2' then '製成品' else '半成品' end typea
,(select top 1 namea from uccga where noa=uca.groupano) xgroups,stationg statiog
,dbo.getComma(price,2)  price
,dbo.getComma(isnull(hours,0),3)  hours
,dbo.getComma(isnull(minutes,0),3)  minutes
,dbo.getComma(isnull(sec,0),3)  sec
,dbo.getComma(pretime,2)  pretime
,dbo.getComma(badperc,2)  badperc
,dbo.getComma(uweight,2)  uweight
,dbo.getComma(makes,2)  makes
,dbo.getComma(packs,2)  packs
,dbo.getComma(wages,2)  wages
,dbo.getComma(safemount,2)  safemount
,case when len(dbo.split(images+char(59),char(59),0))>0 then '<img class="img" onclick="imgshow(this)" src="../images/upload/'+REPLACE(noa,'/','CHR(47)')+'_'+dbo.split(images+char(59),char(59),0)+'" width="100px" >' else '' end img1
,case when len(dbo.split(images+char(59),char(59),1))>0 then '<img class="img" onclick="imgshow(this)" src="../images/upload/'+REPLACE(noa,'/','CHR(47)')+'_'+dbo.split(images+char(59),char(59),1)+'" width="100px" >' else '' end img2
,case when len(dbo.split(images+char(59),char(59),2))>0 then '<img class="img" onclick="imgshow(this)" src="../images/upload/'+REPLACE(noa,'/','CHR(47)')+'_'+dbo.split(images+char(59),char(59),2)+'" width="100px" >' else '' end img3
,case when len(dbo.split(images+char(59),char(59),3))>0 then '<img class="img" onclick="imgshow(this)" src="../images/upload/'+REPLACE(noa,'/','CHR(47)')+'_'+dbo.split(images+char(59),char(59),3)+'" width="100px" >' else '' end img4
,case when len(dbo.split(images+char(59),char(59),4))>0 then '<img class="img" onclick="imgshow(this)" src="../images/upload/'+REPLACE(noa,'/','CHR(47)')+'_'+dbo.split(images+char(59),char(59),4)+'" width="100px" >' else '' end img5
,case when len(dbo.split(images+char(59),char(59),5))>0 then '<img class="img" onclick="imgshow(this)" src="../images/upload/'+REPLACE(noa,'/','CHR(47)')+'_'+dbo.split(images+char(59),char(59),5)+'" width="100px" >' else '' end img6
,*
from uca
where noa between @t_bpno and @t_epno
and (len(@t_typea)=0 or typea=@t_typea) and (len(@t_groupano)=0 or groupano=@t_groupano)
and (len(@t_style)=0 or charindex(@t_style,style)>0) 
and (len(@t_groupbno)=0 or groupbno=@t_groupbno)
order by groupano,typea,noa

;
-----------------------------------------------------------------------------------------------
z_ucap6:--z_ucap6
declare @t_bpno nvarchar(50)
declare @t_epno nvarchar(50)
declare @t_typea nvarchar(50)
declare @t_groupano nvarchar(50)
declare @t_style nvarchar(50)
declare @t_proserch nvarchar(50)
declare @t_groupbno nvarchar(50)

set @t_bpno = case when '#non' = [3] then '' else [3] end
set @t_epno = case when '#non' = [4] then CHAR(255) else [4] end
set @t_typea = case when '#non' = [6] then '' else [6] end
set @t_groupano = case when '#non' = [7] then '' else [7] end
set @t_style = case when '#non' = [12] then '' else [12] end
set @t_proserch = case when '#non' = [46] then '' else [46] end
set @t_groupbno = case when '#non' = [47] then '' else [47] end

declare @t_spec nvarchar(50) = case when '#non' = [13] then '' else [13] end
declare @t_groupe nvarchar(50) = case when '#non' = [14] then '' else [14] end
declare @t_groupf nvarchar(50) = case when '#non' = [15] then '' else [15] end
declare @t_groupg nvarchar(50) = case when '#non' = [16] then '' else [16] end
declare @t_grouph nvarchar(50) = case when '#non' = [17] then '' else [17] end
declare @t_groupi nvarchar(50) = case when '#non' = [18] then '' else [18] end
declare @t_ucolor nvarchar(50) = case when '#non' = [19] then '' else [19] end
declare @t_scolor nvarchar(50) = case when '#non' = [20] then '' else [20] end
declare @t_class nvarchar(50) = case when '#non' = [21] then '' else [21] end
declare @t_classa nvarchar(50) = case when '#non' = [22] then '' else [22] end
declare @t_zinc nvarchar(50) = case when '#non' = [23] then '' else [23] end
declare @t_sizea nvarchar(50) = case when '#non' = [24] then '' else [24] end
declare @t_source nvarchar(50) = case when '#non' = [25] then '' else [25] end
declare @t_hard nvarchar(50) = case when '#non' = [26] then '' else [26] end
declare @t_groupd nvarchar(50) = case when '#non' = [27] then '' else [27] end
declare @t_size1a nvarchar(50) = case when '#non' = [28] then '0' else [28] end
declare @t_size1b nvarchar(50) = case when '#non' = [29] then '99999' else [29] end
declare @t_size2a nvarchar(50) = case when '#non' = [30] then '0' else [30] end
declare @t_size2b nvarchar(50) = case when '#non' = [31] then '99999' else [31] end
declare @t_btgg nvarchar(50) = case when '#non' = [32] then '' else [32] end
declare @t_etgg nvarchar(50) = case when '#non' = [33] then CHAR(255) else [33] end
declare @t_bprocess nvarchar(50) = case when '#non' = [34] then '' else [34] end
declare @t_eprocess nvarchar(50) = case when '#non' = [35] then CHAR(255) else [35] end
declare @t_bstation nvarchar(50) = case when '#non' = [36] then '' else [36] end
declare @t_estation nvarchar(50) = case when '#non' = [37] then CHAR(255) else [37] end
declare @t_xproduct nvarchar(50) = case when '#non' = [38] then '' else [38] end


if(@t_proserch='1')
begin
	select '0' gno
	,ROW_NUMBER()over(order by noa)recno
	,case when typea='2' then '製成品' else '半成品' end typea
	,stationg statiog
	,dbo.getComma(price,-1)  price
	,dbo.getComma(pretime,-1)  pretime
	,dbo.getComma(badperc,-1)  badperc
	,dbo.getComma(uweight,-1)  uweight
	,dbo.getComma(makes,-1)  makes
	,dbo.getComma(packs,-1)  packs
	,dbo.getComma(wages,-1)  wages
	,dbo.getComma(safemount,-1)  safemount
	,case when isnull(hours,0)!=0 then dbo.getComma(hours,-1)+' HR' when isnull(minutes,0)!=0 then dbo.getComma(minutes,-1)+' Min.' else dbo.getComma(sec,-1)+' Sec.' end minutes
	,case when isnull(hminutes,0)=0 then dbo.getComma(hminutes,-1)+' Min.' else dbo.getComma(hsec,-1)+' Sec.' end hminutes
	,(select top 1 namea from uccga where noa=uca.groupano) tgroupas
	,(select top 1 namea from uccgb where noa=uca.groupbno) tgroupbs
	,(select top 1 namea from uccgc where noa=uca.groupcno) tgroupcs
	,(select top 1 mon from adsize where noa=uca.groupeno) tgroupes
	,(select top 1 mon from adsss where noa=uca.groupfno) tgroupfs
	,(select top 1 mon from adknife where noa=uca.groupgno) tgroupgs
	,(select top 1 mon from adpipe where noa=uca.grouphno) tgrouphs
	,(select top 1 mon from adtran where noa=uca.groupino) tgroupis
	,case when len(dbo.split(images+char(59),char(59),0))>0 then '<img class="img" onclick="imgshow(this)" src="../images/upload/'+REPLACE(noa,'/','CHR(47)')+'_'+dbo.split(images+char(59),char(59),0)+'" width="100px" >' else '' end img1
	,case when len(dbo.split(images+char(59),char(59),1))>0 then '<img class="img" onclick="imgshow(this)" src="../images/upload/'+REPLACE(noa,'/','CHR(47)')+'_'+dbo.split(images+char(59),char(59),1)+'" width="100px" >' else '' end img2
	,case when len(dbo.split(images+char(59),char(59),2))>0 then '<img class="img" onclick="imgshow(this)" src="../images/upload/'+REPLACE(noa,'/','CHR(47)')+'_'+dbo.split(images+char(59),char(59),2)+'" width="100px" >' else '' end img3
	,case when len(dbo.split(images+char(59),char(59),3))>0 then '<img class="img" onclick="imgshow(this)" src="../images/upload/'+REPLACE(noa,'/','CHR(47)')+'_'+dbo.split(images+char(59),char(59),3)+'" width="100px" >' else '' end img4
	,case when len(dbo.split(images+char(59),char(59),4))>0 then '<img class="img" onclick="imgshow(this)" src="../images/upload/'+REPLACE(noa,'/','CHR(47)')+'_'+dbo.split(images+char(59),char(59),4)+'" width="100px" >' else '' end img5
	,case when len(dbo.split(images+char(59),char(59),5))>0 then '<img class="img" onclick="imgshow(this)" src="../images/upload/'+REPLACE(noa,'/','CHR(47)')+'_'+dbo.split(images+char(59),char(59),5)+'" width="100px" >' else '' end img6
	,*
	from uca
	where noa between @t_bpno and @t_epno
	and (len(@t_typea)=0 or typea=@t_typea) 
	and (len(@t_groupano)=0 or groupano=@t_groupano)
	and (len(@t_groupbno)=0 or groupbno=@t_groupbno)
	and (len(@t_style)=0 or charindex(@t_style,style)>0) 
	and (len(@t_spec)=0 or charindex(@t_spec,spec)>0 or charindex('型號:'+@t_spec,product)>0)
	and (len(@t_groupe)=0 or charindex(@t_groupe,groupeno)>0 or charindex('車縫:'+@t_groupe,product)>0)
	and (len(@t_groupf)=0 or charindex(@t_groupf,groupfno)>0 or charindex('護片:'+@t_groupf,product)>0)
	and (len(@t_groupg)=0 or charindex(@t_groupg,groupgno)>0 or charindex('大弓:'+@t_groupg,product)>0)
	and (len(@t_grouph)=0 or charindex(@t_grouph,grouphno)>0 or charindex('中束:'+@t_grouph,product)>0)
	and (len(@t_groupi)=0 or charindex(@t_groupi,groupino)>0 or charindex('座管:'+@t_groupi,product)>0)
	and (len(@t_ucolor)=0 or charindex('車縫線顏色:'+@t_ucolor,product)>0)
	and (len(@t_scolor)=0 or charindex('皮料:'+@t_scolor,product)>0 or charindex('皮料1:'+@t_scolor,product)>0)
	and (len(@t_class)=0 or charindex('皮料2:'+@t_class,product)>0)
	and (len(@t_classa)=0 or charindex('皮料3:'+@t_classa,product)>0)
	and (len(@t_zinc)=0 or charindex('皮料4:'+@t_zinc,product)>0)
	and (len(@t_sizea)=0 or charindex('網烙印:'+@t_sizea,product)>0)
	and (len(@t_source)=0 or charindex('轉印:'+@t_source,product)>0)
	and (len(@t_hard)=0 or charindex('電鍍:'+@t_hard,product)>0)
	and (len(@t_groupd)=0 or groupdno=@t_groupd)
	and ((len(@t_size1a)=0 and len(@t_size1b)=0) or (cast(dbo.get_num(substring(size,0,CHARINDEX('*',size))) as float) between cast(@t_size1a as float) and cast(@t_size1b as float)))
	and ((len(@t_size2a)=0 and len(@t_size2b)=0) or (cast(dbo.get_num(substring(size,CHARINDEX('*',size)+1,len(size)))as float) between cast(@t_size2a as float) and cast(@t_size2b as float)))
	and isnull(tggno,'') between @t_btgg and @t_etgg
	and isnull(processno,'') between @t_bprocess and @t_eprocess
	and isnull(stationno,'') between @t_bstation and @t_estation
	and (len(@t_xproduct)=0 or charindex(@t_xproduct,product)>0)
	order by noa
end
else
begin
	select '0' gno
	,ROW_NUMBER()over(order by noa)recno
	,case when typea='2' then '製成品' else '半成品' end typea
	,stationg statiog
	,dbo.getComma(price,-1)  price
	,dbo.getComma(pretime,-1)  pretime
	,dbo.getComma(badperc,-1)  badperc
	,dbo.getComma(uweight,-1)  uweight
	,dbo.getComma(makes,-1)  makes
	,dbo.getComma(packs,-1)  packs
	,dbo.getComma(wages,-1)  wages
	,dbo.getComma(safemount,-1)  safemount
	,case when isnull(hours,0)!=0 then dbo.getComma(hours,-1)+' HR' when isnull(minutes,0)!=0 then dbo.getComma(minutes,-1)+' Min.' else dbo.getComma(sec,-1)+' Sec.' end minutes
	,case when isnull(hminutes,0)=0 then dbo.getComma(hminutes,-1)+' Min.' else dbo.getComma(hsec,-1)+' Sec.' end hminutes
	,(select top 1 namea from uccga where noa=uca.groupano) tgroupas
	,(select top 1 namea from uccgb where noa=uca.groupbno) tgroupbs
	,(select top 1 namea from uccgc where noa=uca.groupcno) tgroupcs
	,(select top 1 mon from adsize where noa=uca.groupeno) tgroupes
	,(select top 1 mon from adsss where noa=uca.groupfno) tgroupfs
	,(select top 1 mon from adknife where noa=uca.groupgno) tgroupgs
	,(select top 1 mon from adpipe where noa=uca.grouphno) tgrouphs
	,(select top 1 mon from adtran where noa=uca.groupino) tgroupis
	,case when len(dbo.split(images+char(59),char(59),0))>0 then '<img class="img" onclick="imgshow(this)" src="../images/upload/'+REPLACE(noa,'/','CHR(47)')+'_'+dbo.split(images+char(59),char(59),0)+'" width="100px" >' else '' end img1
	,case when len(dbo.split(images+char(59),char(59),1))>0 then '<img class="img" onclick="imgshow(this)" src="../images/upload/'+REPLACE(noa,'/','CHR(47)')+'_'+dbo.split(images+char(59),char(59),1)+'" width="100px" >' else '' end img2
	,case when len(dbo.split(images+char(59),char(59),2))>0 then '<img class="img" onclick="imgshow(this)" src="../images/upload/'+REPLACE(noa,'/','CHR(47)')+'_'+dbo.split(images+char(59),char(59),2)+'" width="100px" >' else '' end img3
	,case when len(dbo.split(images+char(59),char(59),3))>0 then '<img class="img" onclick="imgshow(this)" src="../images/upload/'+REPLACE(noa,'/','CHR(47)')+'_'+dbo.split(images+char(59),char(59),3)+'" width="100px" >' else '' end img4
	,case when len(dbo.split(images+char(59),char(59),4))>0 then '<img class="img" onclick="imgshow(this)" src="../images/upload/'+REPLACE(noa,'/','CHR(47)')+'_'+dbo.split(images+char(59),char(59),4)+'" width="100px" >' else '' end img5
	,case when len(dbo.split(images+char(59),char(59),5))>0 then '<img class="img" onclick="imgshow(this)" src="../images/upload/'+REPLACE(noa,'/','CHR(47)')+'_'+dbo.split(images+char(59),char(59),5)+'" width="100px" >' else '' end img6
	,*
	from uca
	where noa between @t_bpno and @t_epno
	and (len(@t_typea)=0 or typea=@t_typea) 
	and (len(@t_groupano)=0 or groupano=@t_groupano)
	and (len(@t_groupbno)=0 or groupbno=@t_groupbno)
	and (len(@t_style)=0 or charindex(@t_style,style)>0) 
	and (len(@t_spec)=0 or charindex(@t_spec,spec)>0)
	and (len(@t_groupe)=0 or charindex(@t_groupe,groupeno)>0)
	and (len(@t_groupf)=0 or charindex(@t_groupf,groupfno)>0)
	and (len(@t_groupg)=0 or charindex(@t_groupg,groupgno)>0)
	and (len(@t_grouph)=0 or charindex(@t_grouph,grouphno)>0)
	and (len(@t_groupi)=0 or charindex(@t_groupi,groupino)>0)
	and (len(@t_ucolor)=0 or charindex('車縫線顏色:'+@t_ucolor,product)>0)
	and (len(@t_scolor)=0 or charindex('皮料:'+@t_scolor,product)>0 or charindex('皮料1:'+@t_scolor,product)>0)
	and (len(@t_class)=0 or charindex('皮料2:'+@t_class,product)>0)
	and (len(@t_classa)=0 or charindex('皮料3:'+@t_classa,product)>0)
	and (len(@t_zinc)=0 or charindex('皮料4:'+@t_zinc,product)>0)
	and (len(@t_sizea)=0 or charindex('網烙印:'+@t_sizea,product)>0)
	and (len(@t_source)=0 or charindex('轉印:'+@t_source,product)>0)
	and (len(@t_hard)=0 or charindex('電鍍:'+@t_hard,product)>0)
	and (len(@t_groupd)=0 or groupdno=@t_groupd)
	and ((len(@t_size1a)=0 and len(@t_size1b)=0) or (cast(dbo.get_num(substring(size,0,CHARINDEX('*',size))) as float) between cast(@t_size1a as float) and cast(@t_size1b as float)))
	and ((len(@t_size2a)=0 and len(@t_size2b)=0) or (cast(dbo.get_num(substring(size,CHARINDEX('*',size)+1,len(size)))as float) between cast(@t_size2a as float) and cast(@t_size2b as float)))
	and isnull(tggno,'') between @t_btgg and @t_etgg
	and isnull(processno,'') between @t_bprocess and @t_eprocess
	and isnull(stationno,'') between @t_bstation and @t_estation
	and (len(@t_xproduct)=0 or charindex(@t_xproduct,product)>0)
	order by noa
end
;
