z_gen1:--z_gen1
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bpno nvarchar(20)
	declare @t_epno nvarchar(20)
	declare @t_aberrant nvarchar(20)

	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bpno = case when '#non'=[4] then '' else [4] end
	set @t_epno = case when '#non'=[5] then char(255) else [5] end
	set @t_aberrant = case when '#non'=[13] then '' else [13] end
	
	--*****************************************************************************************	
declare @tmp table( 
	gno nvarchar(1), 
	pno nvarchar(50), 
	product nvarchar(50), 
	unit nvarchar(10), 
	bmount float, 
	bweight float, 
	bprice float, 
	bmoney float, 
	rcmount float, 
	rcweight float, 
	rcmoney float, 
	gmount float, 
	gweight float, 
	gcost float, 
	vcmount float, 
	vcweight float, 
	vcmoney float, 
	vccost float, 
	lmount float, 
	lweight float, 
	lprice float, 
	lmoney float 
) 

--ina,get做調整用
--worka,workc,cut,cubt領料 
--workb,workd,cuts,cubu生產 
--rc2進貨--vcc銷貨 

--期初
declare @tmpa table( 
	tablea nvarchar(50),
	datea nvarchar(10),
	pno nvarchar(50),
	storeno nvarchar(50),
	mount float, 
	weight float,
	money float
) 

--ucc.typea 4 原料 5 物料

--期初抓ucce
insert @tmpa--插入期初最後盤點(以查詢日的最後一次盤存)
select 'ucce',a.datea,b.productno,b.storeno,b.mount,b.eweight,b.total 
from view_ucce a left join view_ucces b on a.noa=b.noa 
left join ucc c on b.productno=c.noa
where a.datea<@t_edate and a.datea+'_'+b.productno+'_'+b.storeno in(
select MAX(a.datea)+'_'+b.productno+'_'+b.storeno
from view_ucce a left join view_ucces b on a.noa=b.noa where a.datea<@t_edate
group by b.productno,b.storeno) and (c.typea='4' or c.typea='5')

--有盤點-插入盤點之後且資料起始日之前的資料
--進料
insert @tmpa
select 'rc2',ra.datea,rb.productno,rb.storeno
,(case when ra.typea='1' then 1 else -1 end)*rb.mount
,(case when ra.typea='1' then 1 else -1 end)*rb.weight
,(case when ra.typea='1' then 1 else -1 end)*rb.total/(case when ra.taxtype='3' then 1.05 else 1 end) 
from view_rc2 ra left join view_rc2s rb on ra.noa=rb.noa 
left join ucc c on rb.productno=c.noa where
rb.storeno+'_'+rb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ra.datea<@t_bdate and ra.datea>=(select datea from @tmpa where pno=rb.productno and storeno=rb.storeno and tablea='ucce')
and rb.productno!='' and (c.typea='4' or c.typea='5')

--銷售
insert @tmpa
select 'vcc',va.datea,vb.productno,vb.storeno
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount
,-1*(case when va.typea='1' then 1 else -1 end)*vb.weight
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount*
isnull((select price from view_costs where productno=vb.productno and mon=left(va.datea,6)),0) 
from view_vcc va left join view_vccs vb on va.noa=vb.noa 
left join ucc c on vb.productno=c.noa where
vb.storeno+'_'+vb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and va.datea<@t_bdate and va.datea>=(select datea from @tmpa where pno=vb.productno and storeno=vb.storeno and tablea='ucce')
and vb.productno!='' and (c.typea='4' or c.typea='5')

--調整
insert @tmpa
select 'ina',ia.datea,ib.productno,ia.storeno,ib.mount,ib.weight,ib.total
from view_ina ia left join view_inas ib on ia.noa=ib.noa 
left join ucc c on ib.productno=c.noa where
ia.storeno+'_'+ib.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ia.datea<@t_bdate and ia.datea>=(select datea from @tmpa where pno=ib.productno and storeno=ia.storeno and tablea='ucce')
and ib.productno!='' and (c.typea='4' or c.typea='5')

insert @tmpa
select 'get',ga.datea,gb.productno,ga.storeno,-1*gb.mount,-1*gb.weight,-1*gb.mount
*isnull((select price from view_costs where productno=gb.productno and mon=left(ga.datea,6)),0) 
from view_get ga left join view_gets gb on ga.noa=gb.noa 
left join ucc c on gb.productno=c.noa where
ga.storeno+'_'+gb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ga.datea<@t_bdate and ga.datea>=(select datea from @tmpa where pno=gb.productno and storeno=ga.storeno and tablea='ucce')
and gb.productno!='' and (c.typea='4' or c.typea='5')

--領料
insert @tmpa 
select 'worka',wa.datea,wb.productno,wb.storeno,(case when wa.typea='1' then -1 else 1 end)*wb.mount,(case when wa.typea='1' then -1 else 1 end)*wb.weight,(case when wa.typea='1' then -1 else 1 end)*wb.mount 
*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0) 
from view_worka wa left join view_workas wb on wa.noa=wb.noa 
left join ucc c on wb.productno=c.noa where 
wb.storeno+'_'+wb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce') 
and wa.datea<@t_bdate and wa.datea>=(select datea from @tmpa where pno=wb.productno and storeno=wb.storeno and tablea='ucce') 
and wb.productno!='' and (c.typea='4' or c.typea='5') 

insert @tmpa 
select 'workc',wa.datea,wb.productno,wb.storeno,(case when wa.typea='1' then -1 else 1 end)*wb.mount,(case when wa.typea='1' then -1 else 1 end)*wb.weight,(case when wa.typea='1' then -1 else 1 end)*wb.mount 
*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0) 
from view_workc wa left join view_workcs wb on wa.noa=wb.noa 
left join ucc c on wb.productno=c.noa where 
wb.storeno+'_'+wb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce') 
and wa.datea<@t_bdate and wa.datea>=(select datea from @tmpa where pno=wb.productno and storeno=wb.storeno and tablea='ucce') 
and wb.productno!='' and (c.typea='4' or c.typea='5') 

insert @tmpa
select 'cut',ca.datea,ca.productno,ca.storeno,-1*ca.mount,-1*ca.gweight,-1*ca.mount
*isnull((select price from view_costs where productno=ca.productno and mon=left(ca.datea,6)),0) 
from view_cut ca left join ucc c on ca.productno=c.noa where
ca.storeno+'_'+ca.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ca.datea<@t_bdate and ca.datea>=(select datea from @tmpa where pno=ca.productno and storeno=ca.storeno and tablea='ucce')
and ca.productno!='' and (c.typea='4' or c.typea='5')

insert @tmpa
select 'cubt',ca.datea,cb.productno,cb.storeno,-1*cb.mount,-1*cb.weight,-1*cb.mount
*isnull((select price from view_costs where productno=cb.productno and mon=left(ca.datea,6)),0) 
from view_cub ca left join view_cubt cb on ca.noa=cb.noa 
left join ucc c on cb.productno=c.noa where
cb.storeno+'_'+cb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ca.datea<@t_bdate and ca.datea>=(select datea from @tmpa where pno=cb.productno and storeno=cb.storeno and tablea='ucce')
and cb.productno!='' and (c.typea='4' or c.typea='5')

--無盤點-插入資料起始日之前的資料
--進料
insert @tmpa
select 'rc2',ra.datea,rb.productno,rb.storeno
,(case when ra.typea='1' then 1 else -1 end)*rb.mount
,(case when ra.typea='1' then 1 else -1 end)*rb.weight
,(case when ra.typea='1' then 1 else -1 end)*rb.total/(case when ra.taxtype='3' then 1.05 else 1 end) 
from view_rc2 ra left join view_rc2s rb on ra.noa=rb.noa 
left join ucc c on rb.productno=c.noa where
rb.storeno+'_'+rb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ra.datea<@t_bdate and rb.productno!='' and (c.typea='4' or c.typea='5')

--銷售
insert @tmpa
select 'vcc',va.datea,vb.productno,vb.storeno
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount
,-1*(case when va.typea='1' then 1 else -1 end)*vb.weight
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount*
isnull((select price from view_costs where productno=vb.productno and mon=left(va.datea,6)),0) 
from view_vcc va left join view_vccs vb on va.noa=vb.noa 
left join ucc c on vb.productno=c.noa where
vb.storeno+'_'+vb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and va.datea<@t_bdate and vb.productno!='' and (c.typea='4' or c.typea='5')

--調整
insert @tmpa
select 'ina',ia.datea,ib.productno,ia.storeno,ib.mount,ib.weight,ib.total
from view_ina ia left join view_inas ib on ia.noa=ib.noa 
left join ucc c on ib.productno=c.noa where
ia.storeno+'_'+ib.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ia.datea<@t_bdate and ib.productno!='' and (c.typea='4' or c.typea='5')

insert @tmpa
select 'get',ga.datea,gb.productno,ga.storeno,-1*gb.mount,-1*gb.weight,-1*gb.mount
*isnull((select price from view_costs where productno=gb.productno and mon=left(ga.datea,6)),0) 
from view_get ga left join view_gets gb on ga.noa=gb.noa 
left join ucc c on gb.productno=c.noa where
ga.storeno+'_'+gb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ga.datea<@t_bdate and gb.productno!='' and (c.typea='4' or c.typea='5')

--領料
insert @tmpa 
select 'worka',wa.datea,wb.productno,wb.storeno,(case when wa.typea='1' then -1 else 1 end)*wb.mount,(case when wa.typea='1' then -1 else 1 end)*wb.weight,(case when wa.typea='1' then -1 else 1 end)*wb.mount 
*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0) 
from view_worka wa left join view_workas wb on wa.noa=wb.noa 
left join ucc c on wb.productno=c.noa where 
wb.storeno+'_'+wb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce') 
and wa.datea<@t_bdate and wb.productno!='' and (c.typea='4' or c.typea='5') 

insert @tmpa 
select 'workc',wa.datea,wb.productno,wb.storeno,(case when wa.typea='1' then -1 else 1 end)*wb.mount,(case when wa.typea='1' then -1 else 1 end)*wb.weight,(case when wa.typea='1' then -1 else 1 end)*wb.mount 
*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0) 
from view_workc wa left join view_workcs wb on wa.noa=wb.noa 
left join ucc c on wb.productno=c.noa where 
wb.storeno+'_'+wb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce') 
and wa.datea<@t_bdate and wb.productno!='' and (c.typea='4' or c.typea='5') 

insert @tmpa
select 'cut',ca.datea,ca.productno,ca.storeno,-1*ca.mount,-1*ca.gweight,-1*ca.mount
*isnull((select price from view_costs where productno=ca.productno and mon=left(ca.datea,6)),0) 
from view_cut ca left join ucc c on ca.productno=c.noa where
ca.storeno+'_'+ca.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ca.datea<@t_bdate and ca.productno!='' and (c.typea='4' or c.typea='5')

insert @tmpa
select 'cubt',ca.datea,cb.productno,cb.storeno,-1*cb.mount,-1*cb.weight,-1*cb.mount
*isnull((select price from view_costs where productno=cb.productno and mon=left(ca.datea,6)),0) 
from view_cub ca left join view_cubt cb on ca.noa=cb.noa 
left join ucc c on cb.productno=c.noa where
cb.storeno+'_'+cb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ca.datea<@t_bdate and cb.productno!='' and (c.typea='4' or c.typea='5')

---------------------------------------------------
declare @pno nvarchar(90)
declare @MAXMON nvarchar(50)
declare @MINMON nvarchar(50)
declare cursor_table cursor for
--檢查每個月數量為0 則清空金額
select pno,MAX(LEFT(datea,6)),MIN(LEFT(datea,6)) from @tmpa group by pno
open cursor_table
fetch next from cursor_table
into @pno,@MAXMON,@MINMON
while(@@FETCH_STATUS <> -1)
begin
	while (@MINMON<=@MAXMON)
	begin
		if(select sum(mount) mount
		from @tmpa where pno=@pno and left(datea,6)<=@MINMON)<=0
		begin
			update @tmpa
			set money=0
			where pno=@pno and left(datea,6)<=@MINMON
		end
		
		set @MINMON=cast(cast(LEFT(@MINMON,3)as int)+1911 as nvarchar(20))+'/'+right(@MINMON,2)+'/01'
		set @MINMON=CONVERT (VARCHAR(7),DATEADD(m,+1,@MINMON),12 )+0890000
		set @MINMON=left(@MINMON,3)+'/'+substring(@MINMON,4,2)
		
	end
	
	fetch next from cursor_table
	into @pno,@MAXMON,@MINMON
end
close cursor_table
deallocate cursor_table

--插入期初庫存
insert into @tmp(gno,pno,product,unit,bmount,bweight,bmoney)
select '0',a.pno,MAX(b.product),MAX(b.unit)
,sum(a.mount),sum(a.weight),sum(a.money) 
from @tmpa a left join ucc b on a.pno=b.noa
where (a.pno between @t_bpno and @t_epno) and (b.typea='4' or b.typea='5')
group by a.pno

--計算期初單價 
update @tmp set bprice=case when bmount=0 then 0 else bmoney/ bmount end
------------------------------------------------------------------
declare @tmpr table( 
	pno nvarchar(50),
	product nvarchar(100),
	unit nvarchar(50),
	rmount float, 
	rweight float,
	rmoney float
) 

--插入有盤存的進料數量
insert into @tmpr
select rb.productno,MAX(c.product),MAX(c.unit)
,sum((case when ra.typea='1' then 1 else -1 end)*rb.mount)
,sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) 
,sum((case when ra.typea='1' then 1 else -1 end)*rb.total/(case when ra.taxtype='3' then 1.05 else 1 end))
from view_rc2 ra left join view_rc2s rb on ra.noa=rb.noa 
left join ucc c on rb.productno=c.noa
where rb.productno in(select pno from @tmpa where tablea='ucce')
and ra.datea>(select MAX(datea) from @tmpa where pno=rb.productno)
and ra.datea<=@t_edate and (rb.productno between @t_bpno and @t_epno) and rb.productno!=''
and (c.typea='4' or c.typea='5') group by rb.productno

insert into @tmpr
select ib.productno,MAX(c.product),MAX(c.unit),sum(ib.mount),sum(ib.weight) ,sum(ib.total)
from view_ina ia left join view_inas ib on ia.noa=ib.noa 
left join ucc c on ib.productno=c.noa
where ib.productno in(select pno from @tmpa where tablea='ucce')
and ia.datea>(select MAX(datea) from @tmpa where pno=ib.productno)
and ia.datea<=@t_edate and (ib.productno between @t_bpno and @t_epno) and ib.productno!=''
and (c.typea='4' or c.typea='5') group by ib.productno


--插入沒有盤存的進料數量
insert into @tmpr
select rb.productno,MAX(c.product),MAX(c.unit)
,sum((case when ra.typea='1' then 1 else -1 end)*rb.mount)
,sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) 
,sum((case when ra.typea='1' then 1 else -1 end)*rb.total/(case when ra.taxtype='3' then 1.05 else 1 end))
from view_rc2 ra left join view_rc2s rb on ra.noa=rb.noa 
left join ucc c on rb.productno=c.noa
where rb.productno not in(select pno from @tmpa where tablea='ucce')
and (ra.datea between @t_bdate and @t_edate)
and (rb.productno between @t_bpno and @t_epno)  and rb.productno!=''
and (c.typea='4' or c.typea='5') group by rb.productno

insert into @tmpr
select ib.productno,MAX(c.product),MAX(c.unit),sum(ib.mount),sum(ib.weight) ,sum(ib.total)
from view_ina ia left join view_inas ib on ia.noa=ib.noa 
left join ucc c on ib.productno=c.noa
where ib.productno not in(select pno from @tmpa where tablea='ucce')
and (ia.datea between @t_bdate and @t_edate)
and (ib.productno between @t_bpno and @t_epno) and ib.productno!=''
and (c.typea='4' or c.typea='5') group by ib.productno

------------------------------------------------------------------
declare @tmpv table( 
	pno nvarchar(50),
	product nvarchar(100),
	unit nvarchar(50),
	vmount float, 
	vweight float,
	vmoney float
) 

--插入有盤存的銷售數量
insert into @tmpv
select vb.productno,MAX(c.product),MAX(c.unit)
,sum((case when va.typea='1' then 1 else -1 end)*vb.mount)
,sum((case when va.typea='1' then 1 else -1 end)*vb.weight) 
,sum((case when va.typea='1' then 1 else -1 end)*vb.total/(case when va.taxtype='3' then 1.05 else 1 end))
from view_vcc va left join view_vccs vb on va.noa=vb.noa 
left join ucc c on vb.productno=c.noa
where vb.productno in(select pno from @tmpa where tablea='ucce')
and va.datea>(select MAX(datea) from @tmpa where pno=vb.productno)
and va.datea<=@t_edate and (vb.productno between @t_bpno and @t_epno) and vb.productno!=''
and (c.typea='4' or c.typea='5') group by vb.productno

--插入沒有盤存的銷售數量
insert into @tmpv
select vb.productno,MAX(c.product),MAX(c.unit)
,sum((case when va.typea='1' then 1 else -1 end)*vb.mount)
,sum((case when va.typea='1' then 1 else -1 end)*vb.weight) 
,sum((case when va.typea='1' then 1 else -1 end)*vb.total/(case when va.taxtype='3' then 1.05 else 1 end))
from view_vcc va left join view_vccs vb on va.noa=vb.noa 
left join ucc c on vb.productno=c.noa
where vb.productno not in(select pno from @tmpa where tablea='ucce')
and (va.datea between @t_bdate and @t_edate)
and (vb.productno between @t_bpno and @t_epno)  and vb.productno!=''
and (c.typea='4' or c.typea='5') group by vb.productno


----------------------------------------------------------
declare @tmpw table( 
	pno nvarchar(50),
	product nvarchar(100),
	unit nvarchar(50),
	wmount float, 
	wweight float
) 

--插入有盤存的調整數量
insert into @tmpw
select gb.productno,MAX(c.product),MAX(c.unit),sum(gb.mount),sum(gb.weight)
from view_get ga left join view_gets gb on ga.noa=gb.noa 
left join ucc c on gb.productno=c.noa
where gb.productno in(select pno from @tmpa where tablea='ucce')
and ga.datea>(select MAX(datea) from @tmpa where pno=gb.productno)
and ga.datea<=@t_edate and (gb.productno between @t_bpno and @t_epno) and gb.productno!=''
and (c.typea='4' or c.typea='5') group by gb.productno

--插入沒有盤存的調整數量
insert into @tmpw
select gb.productno,MAX(c.product),MAX(c.unit),sum(gb.mount),sum(gb.weight)
from view_get ga left join view_gets gb on ga.noa=gb.noa 
left join ucc c on gb.productno=c.noa
where gb.productno not in(select pno from @tmpa where tablea='ucce')
and (ga.datea between @t_bdate and @t_edate)
and (gb.productno between @t_bpno and @t_epno) and gb.productno!=''
and (c.typea='4' or c.typea='5') group by gb.productno

--插入有盤存的領料數量
insert into @tmpw
select wb.productno,MAX(c.product),MAX(c.unit),sum((case when wa.typea='1' then 1 else -1 end)*wb.mount),sum((case when wa.typea='1' then 1 else -1 end)*wb.weight)
from view_worka wa left join view_workas wb on wa.noa=wb.noa 
left join ucc c on wb.productno=c.noa 
where wb.productno in(select pno from @tmpa where tablea='ucce')
and wa.datea>(select MAX(datea) from @tmpa where pno=wb.productno)
and wa.datea<=@t_edate and (wb.productno between @t_bpno and @t_epno) and wb.productno!=''
and (c.typea='4' or c.typea='5') group by wb.productno

insert into @tmpw
select wb.productno,MAX(c.product),MAX(c.unit),sum((case when wa.typea='1' then 1 else -1 end)*wb.mount),sum((case when wa.typea='1' then 1 else -1 end)*wb.weight)
from view_workc wa left join view_workcs wb on wa.noa=wb.noa 
left join ucc c on wb.productno=c.noa 
where wb.productno in(select pno from @tmpa where tablea='ucce')
and wa.datea>(select MAX(datea) from @tmpa where pno=wb.productno)
and wa.datea<=@t_edate and (wb.productno between @t_bpno and @t_epno) and wb.productno!=''
and (c.typea='4' or c.typea='5') group by wb.productno

insert into @tmpw
select ca.productno,MAX(c.product),MAX(c.unit),sum(ca.mount),sum(ca.gweight)
from view_cut ca left join ucc c on ca.productno=c.noa 
where ca.productno in(select pno from @tmpa where tablea='ucce')
and ca.datea>(select MAX(datea) from @tmpa where pno=ca.productno)
and ca.datea<=@t_edate and (ca.productno between @t_bpno and @t_epno) and ca.productno!=''
and (c.typea='4' or c.typea='5') group by ca.productno

insert into @tmpw
select cb.productno,MAX(c.product),MAX(c.unit),sum(cb.mount),sum(cb.weight)
from view_cub ca left join view_cubt cb on ca.noa=cb.noa 
left join ucc c on cb.productno=c.noa 
where cb.productno in(select pno from @tmpa where tablea='ucce')
and ca.datea>(select MAX(datea) from @tmpa where pno=cb.productno)
and ca.datea<=@t_edate and (cb.productno between @t_bpno and @t_epno) and cb.productno!=''
and (c.typea='4' or c.typea='5') group by cb.productno

--插入沒有盤存的領料數量
insert into @tmpw
select wb.productno,MAX(c.product),MAX(c.unit),sum((case when wa.typea='1' then 1 else -1 end)*wb.mount),sum((case when wa.typea='1' then 1 else -1 end)*wb.weight)
from view_worka wa left join view_workas wb on wa.noa=wb.noa 
left join ucc c on wb.productno=c.noa 
where wb.productno not in(select pno from @tmpa where tablea='ucce')
and (wa.datea between @t_bdate and @t_edate)
and (wb.productno between @t_bpno and @t_epno) and wb.productno!=''
and (c.typea='4' or c.typea='5') group by wb.productno

insert into @tmpw
select wb.productno,MAX(c.product),MAX(c.unit),sum((case when wa.typea='1' then 1 else -1 end)*wb.mount),sum((case when wa.typea='1' then 1 else -1 end)*wb.weight)
from view_workc wa left join view_workcs wb on wa.noa=wb.noa 
left join ucc c on wb.productno=c.noa 
where wb.productno not in(select pno from @tmpa where tablea='ucce')
and (wa.datea between @t_bdate and @t_edate)
and (wb.productno between @t_bpno and @t_epno) and wb.productno!=''
and (c.typea='4' or c.typea='5') group by wb.productno

insert into @tmpw
select ca.productno,MAX(c.product),MAX(c.unit),sum(ca.mount),sum(ca.gweight)
from view_cut ca left join ucc c on ca.productno=c.noa 
where ca.productno not in(select pno from @tmpa where tablea='ucce')
and (ca.datea between @t_bdate and @t_edate)
and (ca.productno between @t_bpno and @t_epno) and ca.productno!=''
and (c.typea='4' or c.typea='5') group by ca.productno

insert into @tmpw
select cb.productno,MAX(c.product),MAX(c.unit),sum(cb.mount),sum(cb.weight)
from view_cub ca left join view_cubt cb on ca.noa=cb.noa 
left join ucc c on cb.productno=c.noa 
where cb.productno not in (select pno from @tmpa where tablea='ucce')
and (ca.datea between @t_bdate and @t_edate)
and (cb.productno between @t_bpno and @t_epno) and cb.productno!=''
and (c.typea='4' or c.typea='5') group by cb.productno

----------------------------------------------------------
--插入沒有期初的資料
insert into @tmp(gno,pno,product,unit,bmount,bweight,bmoney)
select '0',*,0,0,0 from 
(select pno,product,unit from @tmpr union
select pno,product,unit from @tmpv union 
select pno,product,unit from @tmpw)tmps where pno not in (select pno from @tmp)

--更新資料
update a
set a.rcmount=isnull((select rmount from @tmpr where pno=a.pno),0)
,a.rcweight=isnull((select rweight from @tmpr where pno=a.pno),0)
,a.rcmoney=isnull((select rmoney from @tmpr where pno=a.pno),0)
,a.vcmount=isnull((select vmount from @tmpv where pno=a.pno),0)
,a.vcweight=isnull((select vweight from @tmpv where pno=a.pno),0)
,a.vcmoney=isnull((select vmoney from @tmpv where pno=a.pno),0)
,a.gmount=isnull((select wmount from @tmpw where pno=a.pno),0)
,a.gweight=isnull((select wweight from @tmpw where pno=a.pno),0)
from @tmp a

update @tmp set bmoney=0 where bmount<=0
update @tmp set bmoney=0 where bmoney<=0

--計算成本
update @tmp
set vccost=case when bmount+rcmount=0 then 0 else round((bmoney+rcmoney)/(bmount+rcmount),2)*vcmount end
,gcost=case when bmount+rcmount=0 then 0 else round((bmoney+rcmoney)/(bmount+rcmount),2)*gmount end

--計算期末 
update @tmp 
set lmount=bmount+rcmount-vcmount-gmount,lweight=bweight+rcweight-vcweight-gweight 
,lmoney=case when (bmoney+rcmoney-vccost-gcost)<=0 then 0 else (bmoney+rcmoney-vccost-gcost) end 

update @tmp set lprice=case when lmount=0 then 0 else lmoney/lmount end 
update @tmp set lmoney=0 where lprice<=0

--刪除全部資料都為0
delete @tmp 
where bmount=0 and bmoney=0 and rcmount=0 and rcmoney=0 and gmount=0 and gcost=0 and vcmount=0 and vcmoney=0 --and bweight=0 and rcweight=0 and gweight=0 and vcweight=0 

--異常
if(len(@t_aberrant)!=0) 
delete @tmp where lmount>=0 and lmoney>=0 --and lweight>=0 

insert into @tmp 
select '1','','','',sum(bmount),sum(bweight),0,sum(bmoney) 
,sum(rcmount),sum(rcweight),sum(rcmoney) 
,sum(gmount),sum(gweight),sum(gcost) 
,sum(vcmount),sum(vcweight),sum(vcmoney),sum(vccost) 
,sum(lmount),sum(lweight),0,sum(lmoney) 
from @tmp 

select 
gno,pno,product,unit 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(bmount,2)),1)),0,30)) bmount 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(bweight,2)),1)),0,30)) bweight 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(bmoney,2)),1)),0,30)) bmoney 

,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcmount,2)),1)),0,30)) rcmount 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcweight,2)),1)),0,30)) rcweight 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcmoney,2)),1)),0,30)) rcmoney 

,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(gmount,2)),1)),0,30)) gmount 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(gweight,2)),1)),0,30)) gweight 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(gcost,2)),1)),0,30)) gcost 

,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcmount,2)),1)),0,30)) vcmount 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcweight,2)),1)),0,30)) vcweight 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcmoney,2)),1)),0,30)) vcmoney 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vccost,2)),1)),0,30)) vccost 

,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lmount,2)),1)),0,30)) lmount 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lweight,2)),1)),0,30)) lweight 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lprice,2)),1)),0,30)) lprice 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lmoney,2)),1)),0,30)) lmoney 

from @tmp order by gno,pno ;
--*********************************************************************************************
z_gen2:--z_gen2
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bpno nvarchar(20)
	declare @t_epno nvarchar(20)
	declare @t_aberrant nvarchar(20)

	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bpno = case when '#non'=[4] then '' else [4] end
	set @t_epno = case when '#non'=[5] then char(255) else [5] end
	set @t_aberrant = case when '#non'=[13] then '' else [13] end
	
	--*****************************************************************************************	
declare @tmp table( 
	gno nvarchar(1),
	pno nvarchar(50),
	product nvarchar(50),
	unit nvarchar(10),
	bmount float, 
	bweight float, 
	bprice float,
	bmoney float, 
	brmount float, 
	brweight float, 
	brmoney float, 
	rcmount float, 
	rcweight float, 
	rcmoney float, 
	vcmount float, 
	vcweight float, 
	vcmoney float, 
	vccost float,
	profit float, 
	lmount float, 
	lweight float, 
	lprice float, 
	lmoney float
) 

--ina,get做調整用
--worka,workc,cut,cubt領料 
--workb,workd,cuts,cubu生產 
--rc2進貨--vcc銷貨 

--期初
declare @tmpa table( 
	tablea nvarchar(50),
	datea nvarchar(10),
	pno nvarchar(50),
	storeno nvarchar(50),
	mount float, 
	weight float,
	money float
) 

--ucc.typea 2 製成品 6 下腳品 --7 加工

--期初抓ucce
insert @tmpa--插入期初最後盤點(以查詢日的最後一次盤存)
select 'ucce',a.datea,b.productno,b.storeno,b.mount,b.eweight,b.total 
from view_ucce a left join view_ucces b on a.noa=b.noa 
left join view_ucaucc c on b.productno=c.noa
where a.datea<@t_edate and a.datea+'_'+b.productno+'_'+b.storeno in(
select MAX(a.datea)+'_'+b.productno+'_'+b.storeno
from view_ucce a left join view_ucces b on a.noa=b.noa where a.datea<@t_edate
group by b.productno,b.storeno) and (c.typea='2' or c.typea='6' )

--有盤點-插入盤點之後且資料起始日之前的資料

--進貨
insert @tmpa
select 'rc2',ra.datea,rb.productno,rb.storeno
,(case when ra.typea='1' then 1 else -1 end)*rb.mount
,(case when ra.typea='1' then 1 else -1 end)*rb.weight
,(case when ra.typea='1' then 1 else -1 end)*rb.total/(case when ra.taxtype='3' then 1.05 else 1 end) 
from view_rc2 ra left join view_rc2s rb on ra.noa=rb.noa 
left join view_ucaucc c on rb.productno=c.noa where
rb.storeno+'_'+rb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ra.datea<@t_bdate and ra.datea>=(select datea from @tmpa where pno=rb.productno and storeno=rb.storeno and tablea='ucce')
and rb.productno!='' and (c.typea='2' or c.typea='6' )

--銷售
insert @tmpa
select 'vcc',va.datea,vb.productno,vb.storeno
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount
,-1*(case when va.typea='1' then 1 else -1 end)*vb.weight
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount*
isnull((select price from view_costs where productno=vb.productno and mon=left(va.datea,6)),0) 
from view_vcc va left join view_vccs vb on va.noa=vb.noa 
left join view_ucaucc c on vb.productno=c.noa where
vb.storeno+'_'+vb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and va.datea<@t_bdate and va.datea>=(select datea from @tmpa where pno=vb.productno and storeno=vb.storeno and tablea='ucce')
and vb.productno!='' and (c.typea='2' or c.typea='6' )

--調整
insert @tmpa
select 'ina',ia.datea,ib.productno,ia.storeno,ib.mount,ib.weight,ib.total
from view_ina ia left join view_inas ib on ia.noa=ib.noa 
left join view_ucaucc c on ib.productno=c.noa where
ia.storeno+'_'+ib.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ia.datea<@t_bdate and ia.datea>=(select datea from @tmpa where pno=ib.productno and storeno=ia.storeno and tablea='ucce')
and ib.productno!='' and (c.typea='2' or c.typea='6' )

insert @tmpa
select 'get',ga.datea,gb.productno,ga.storeno,-1*gb.mount,-1*gb.weight,-1*gb.mount
*isnull((select price from view_costs where productno=gb.productno and mon=left(ga.datea,6)),0) 
from view_get ga left join view_gets gb on ga.noa=gb.noa 
left join view_ucaucc c on gb.productno=c.noa where
ga.storeno+'_'+gb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ga.datea<@t_bdate and ga.datea>=(select datea from @tmpa where pno=gb.productno and storeno=ga.storeno and tablea='ucce')
and gb.productno!='' and (c.typea='2' or c.typea='6')


--生產
insert @tmpa
select 'workb',wa.datea,wb.productno,wb.storeno,wb.mount,wb.weight
,isnull((select (costa+costb+costc+costd) from view_wcost where noa=wb.noa and productno=wb.productno and workno=wb.workno),0) 
from view_workb wa left join view_workbs wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa where
wb.storeno+'_'+wb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and wa.datea<@t_bdate and wa.datea>=(select datea from @tmpa where pno=wb.productno and storeno=wb.storeno and tablea='ucce')
and wb.productno!='' and (c.typea='2' or c.typea='6' )

insert @tmpa
select 'workd',wa.datea,wb.productno,wb.storeno,wb.mount,wb.weight
,isnull((select (costa+costb+costc+costd) from view_wcost where noa=wb.noa and productno=wb.productno and workno=wb.workno),0)  
from view_workd wa left join view_workds wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa where
wb.storeno+'_'+wb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and wa.datea<@t_bdate and wa.datea>=(select datea from @tmpa where pno=wb.productno and storeno=wb.storeno and tablea='ucce')
and wb.productno!='' and (c.typea='2' or c.typea='6' )

insert @tmpa
select 'cuts',ca.datea,cb.productno,cb.storeno,cb.mount,cb.weight,cb.mount
*isnull((select price from view_costs where productno=cb.productno and mon=left(ca.datea,6)),0) 
from view_cut ca left join view_cuts cb on ca.noa=cb.noa left join view_ucaucc c on cb.productno=c.noa where
ca.storeno+'_'+cb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ca.datea<@t_bdate and ca.datea>=(select datea from @tmpa where pno=cb.productno and storeno=ca.storeno and tablea='ucce')
and cb.productno!='' and (c.typea='2' or c.typea='6' )

insert @tmpa
select 'cubu',ca.datea,cb.productno,cb.storeno,cb.mount,cb.weight,cb.mount
*isnull((select price from view_costs where productno=cb.productno and mon=left(ca.datea,6)),0) 
from view_cub ca left join view_cubu cb on ca.noa=cb.noa left join view_ucaucc c on cb.productno=c.noa where
cb.storeno+'_'+cb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ca.datea<@t_bdate and ca.datea>=(select datea from @tmpa where pno=cb.productno and storeno=cb.storeno and tablea='ucce')
and cb.productno!='' and (c.typea='2' or c.typea='6' )

--報廢
insert @tmpa
select 'workb',wa.datea,wb.productno,wb.storeno,-1*wb.wmount,0
,-1*wb.wmount*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0)  
from view_workb wa left join view_workbs wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa where
wb.storeno+'_'+wb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and wa.datea<@t_bdate and wa.datea>=(select datea from @tmpa where pno=wb.productno and storeno=wb.storeno and tablea='ucce')
and wb.productno!='' and (c.typea='2' or c.typea='6' )

insert @tmpa
select 'workd',wa.datea,wb.productno,wb.storeno,-1*wb.wmount,0
,-1*wb.wmount*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0)   
from view_workd wa left join view_workds wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa where
wb.storeno+'_'+wb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and wa.datea<@t_bdate and wa.datea>=(select datea from @tmpa where pno=wb.productno and storeno=wb.storeno and tablea='ucce')
and wb.productno!='' and (c.typea='2' or c.typea='6' )

--無盤點-插入資料起始日之前的資料
--進貨
insert @tmpa
select 'rc2',ra.datea,rb.productno,rb.storeno
,(case when ra.typea='1' then 1 else -1 end)*rb.mount
,(case when ra.typea='1' then 1 else -1 end)*rb.weight
,(case when ra.typea='1' then 1 else -1 end)*rb.total/(case when ra.taxtype='3' then 1.05 else 1 end) 
from view_rc2 ra left join view_rc2s rb on ra.noa=rb.noa 
left join view_ucaucc c on rb.productno=c.noa where
rb.storeno+'_'+rb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ra.datea<@t_bdate and rb.productno!='' and (c.typea='2' or c.typea='6' )

--銷售
insert @tmpa
select 'vcc',va.datea,vb.productno,vb.storeno
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount
,-1*(case when va.typea='1' then 1 else -1 end)*vb.weight
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount*
isnull((select price from view_costs where productno=vb.productno and mon=left(va.datea,6)),0) 
from view_vcc va left join view_vccs vb on va.noa=vb.noa 
left join view_ucaucc c on vb.productno=c.noa where
vb.storeno+'_'+vb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and va.datea<@t_bdate and vb.productno!='' and (c.typea='2' or c.typea='6' )

--調整
insert @tmpa
select 'ina',ia.datea,ib.productno,ia.storeno,ib.mount,ib.weight,ib.total
from view_ina ia left join view_inas ib on ia.noa=ib.noa 
left join view_ucaucc c on ib.productno=c.noa where
ia.storeno+'_'+ib.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ia.datea<@t_bdate and ib.productno!='' and (c.typea='2' or c.typea='6' )

insert @tmpa
select 'get',ga.datea,gb.productno,ga.storeno,-1*gb.mount,-1*gb.weight,-1*gb.mount
*isnull((select price from view_costs where productno=gb.productno and mon=left(ga.datea,6)),0) 
from view_get ga left join view_gets gb on ga.noa=gb.noa 
left join view_ucaucc c on gb.productno=c.noa where
ga.storeno+'_'+gb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ga.datea<@t_bdate and gb.productno!='' and (c.typea='2' or c.typea='6' )

--生產
insert @tmpa
select 'workb',wa.datea,wb.productno,wb.storeno,wb.mount,wb.weight
,isnull((select (costa+costb+costc+costd) from view_wcost where noa=wb.noa and productno=wb.productno and workno=wb.workno),0) 
from view_workb wa left join view_workbs wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa where
wb.storeno+'_'+wb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and wa.datea<@t_bdate and wb.productno!='' and (c.typea='2' or c.typea='6' )

insert @tmpa
select 'workd',wa.datea,wb.productno,wb.storeno,wb.mount,wb.weight
,isnull((select (costa+costb+costc+costd) from view_wcost where noa=wb.noa and productno=wb.productno and workno=wb.workno),0) 
from view_workd wa left join view_workds wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa where
wb.storeno+'_'+wb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and wa.datea<@t_bdate and wb.productno!='' and (c.typea='2' or c.typea='6' )

insert @tmpa
select 'cuts',ca.datea,cb.productno,cb.storeno,cb.mount,cb.weight,cb.mount
*isnull((select price from view_costs where productno=cb.productno and mon=left(ca.datea,6)),0) 
from view_cut ca left join view_cuts cb on ca.noa=cb.noa left join view_ucaucc c on cb.productno=c.noa where
cb.storeno+'_'+cb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ca.datea<@t_bdate and cb.productno!='' and (c.typea='2' or c.typea='6')

insert @tmpa
select 'cubu',ca.datea,cb.productno,cb.storeno,cb.mount,cb.weight,cb.mount
*isnull((select price from view_costs where productno=cb.productno and mon=left(ca.datea,6)),0) 
from view_cub ca left join view_cubu cb on ca.noa=cb.noa 
left join view_ucaucc c on cb.productno=c.noa where
cb.storeno+'_'+cb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ca.datea<@t_bdate and cb.productno!='' and (c.typea='2' or c.typea='6' )

--報廢
insert @tmpa
select 'workb',wa.datea,wb.productno,wb.storeno,-1*wb.wmount,0
,-1*wb.wmount*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0)  
from view_workb wa left join view_workbs wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa where
wb.storeno+'_'+wb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and wa.datea<@t_bdate and wa.datea>=(select datea from @tmpa where pno=wb.productno and storeno=wb.storeno and tablea='ucce')
and wb.productno!='' and (c.typea='2' or c.typea='6' )

insert @tmpa
select 'workd',wa.datea,wb.productno,wb.storeno,-1*wb.wmount,0
,-1*wb.wmount*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0)   
from view_workd wa left join view_workds wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa where
wb.storeno+'_'+wb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and wa.datea<@t_bdate and wa.datea>=(select datea from @tmpa where pno=wb.productno and storeno=wb.storeno and tablea='ucce')
and wb.productno!='' and (c.typea='2' or c.typea='6' )

---------------------------------------------------
declare @pno nvarchar(90)
declare @MAXMON nvarchar(50)
declare @MINMON nvarchar(50)
declare cursor_table cursor for
--檢查每個月數量為0 則清空金額
select pno,MAX(LEFT(datea,6)),MIN(LEFT(datea,6)) from @tmpa group by pno
open cursor_table
fetch next from cursor_table
into @pno,@MAXMON,@MINMON
while(@@FETCH_STATUS <> -1)
begin
	while (@MINMON<=@MAXMON)
	begin
		if(select sum(mount) mount
		from @tmpa where pno=@pno and left(datea,6)<=@MINMON)<=0
		begin
			update @tmpa
			set money=0
			where pno=@pno and left(datea,6)<=@MINMON
		end
		
		set @MINMON=cast(cast(LEFT(@MINMON,3)as int)+1911 as nvarchar(20))+'/'+right(@MINMON,2)+'/01'
		set @MINMON=CONVERT (VARCHAR(7),DATEADD(m,+1,@MINMON),12 )+0890000
		set @MINMON=left(@MINMON,3)+'/'+substring(@MINMON,4,2)
		
	end
	
	fetch next from cursor_table
	into @pno,@MAXMON,@MINMON
end
close cursor_table
deallocate cursor_table

--插入期初庫存
insert into @tmp(gno,pno,product,unit,bmount,bweight,bmoney)
select '0',a.pno,MAX(b.product),MAX(b.unit)
,sum(a.mount),sum(a.weight),sum(a.money) 
from @tmpa a left join view_ucaucc b on a.pno=b.noa
where (a.pno between @t_bpno and @t_epno) and (b.typea='2' or b.typea='6' )
group by a.pno

--計算期初單價 
update @tmp set bprice=case when bmount=0 then 0 else bmoney/ bmount end
------------------------------------------------------------------
declare @tmpr table( 
	pno nvarchar(50),
	product nvarchar(100),
	unit nvarchar(50),
	rmount float, 
	rweight float,
	rmoney float
) 

--插入有盤存的進料數量
insert into @tmpr
select rb.productno,MAX(c.product),MAX(c.unit)
,sum((case when ra.typea='1' then 1 else -1 end)*rb.mount)
,sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) 
,sum((case when ra.typea='1' then 1 else -1 end)*rb.total/(case when ra.taxtype='3' then 1.05 else 1 end))
from view_rc2 ra left join view_rc2s rb on ra.noa=rb.noa 
left join view_ucaucc c on rb.productno=c.noa
where rb.productno in(select pno from @tmpa where tablea='ucce')
and ra.datea>(select MAX(datea) from @tmpa where pno=rb.productno)
and ra.datea<=@t_edate and (rb.productno between @t_bpno and @t_epno) and rb.productno!=''
and (c.typea='2' or c.typea='6') group by rb.productno

insert into @tmpr
select ib.productno,MAX(c.product),MAX(c.unit),sum(ib.mount),sum(ib.weight) ,sum(ib.total)
from view_ina ia left join view_inas ib on ia.noa=ib.noa 
left join view_ucaucc c on ib.productno=c.noa
where ib.productno in(select pno from @tmpa where tablea='ucce')
and ia.datea>(select MAX(datea) from @tmpa where pno=ib.productno)
and ia.datea<=@t_edate and (ib.productno between @t_bpno and @t_epno) and ib.productno!=''
and (c.typea='2' or c.typea='6' ) group by ib.productno

--插入沒有盤存的進料數量
insert into @tmpr
select rb.productno,MAX(c.product),MAX(c.unit)
,sum((case when ra.typea='1' then 1 else -1 end)*rb.mount)
,sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) 
,sum((case when ra.typea='1' then 1 else -1 end)*rb.total/(case when ra.taxtype='3' then 1.05 else 1 end))
from view_rc2 ra left join view_rc2s rb on ra.noa=rb.noa 
left join view_ucaucc c on rb.productno=c.noa
where rb.productno not in(select pno from @tmpa where tablea='ucce')
and (ra.datea between @t_bdate and @t_edate)
and (rb.productno between @t_bpno and @t_epno)  and rb.productno!=''
and (c.typea='2' or c.typea='6' ) group by rb.productno

insert into @tmpr
select ib.productno,MAX(c.product),MAX(c.unit),sum(ib.mount),sum(ib.weight) ,sum(ib.total)
from view_ina ia left join view_inas ib on ia.noa=ib.noa 
left join view_ucaucc c on ib.productno=c.noa
where ib.productno not in(select pno from @tmpa where tablea='ucce')
and (ia.datea between @t_bdate and @t_edate)
and (ib.productno between @t_bpno and @t_epno) and ib.productno!=''
and (c.typea='2' or c.typea='6' ) group by ib.productno

------------------------------------------------------------------
declare @tmpv table( 
	pno nvarchar(50),
	product nvarchar(100),
	unit nvarchar(50),
	vmount float, 
	vweight float,
	vmoney float,
	vcost float
) 

--插入有盤存的銷售數量
insert into @tmpv
select vb.productno,c.product,c.unit
,(case when va.typea='1' then 1 else -1 end)*vb.mount
,(case when va.typea='1' then 1 else -1 end)*vb.weight 
,(case when va.typea='1' then 1 else -1 end)*vb.total/(case when va.taxtype='3' then 1.05 else 1 end)
,(case when va.typea='1' then 1 else -1 end)*vb.mount*isnull((select price from view_costs where productno=vb.productno and mon=left(va.datea,6)),0)
from view_vcc va left join view_vccs vb on va.noa=vb.noa 
left join view_ucaucc c on vb.productno=c.noa
where vb.productno in(select pno from @tmpa where tablea='ucce')
and va.datea>(select MAX(datea) from @tmpa where pno=vb.productno)
and va.datea<=@t_edate and (vb.productno between @t_bpno and @t_epno) and vb.productno!=''
and (c.typea='2' or c.typea='6' ) --group by vb.productno

--有盤存報廢
insert into @tmpv
select wb.productno,c.product,c.unit,wb.wmount,wb.weight
,wb.wmount*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0) 
,wb.wmount*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0) 
from view_workb wa left join view_workbs wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa
where wb.productno in(select pno from @tmpa where tablea='ucce')
and wa.datea>(select MAX(datea) from @tmpa where pno=wb.productno)
and wa.datea<=@t_edate and (wb.productno between @t_bpno and @t_epno) and wb.productno!=''
and (c.typea='2' or c.typea='6' ) --group by wb.productno

insert into @tmpv
select wb.productno,c.product,c.unit,wb.wmount,wb.weight
,wb.wmount*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0) 
,wb.wmount*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0) 
from view_workd wa left join view_workds wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa
where wb.productno in(select pno from @tmpa where tablea='ucce')
and wa.datea>(select MAX(datea) from @tmpa where pno=wb.productno)
and wa.datea<=@t_edate and (wb.productno between @t_bpno and @t_epno) and wb.productno!=''
and (c.typea='2' or c.typea='6' ) --group by wb.productno

--插入沒有盤存的銷售數量
insert into @tmpv
select vb.productno,c.product,c.unit
,(case when va.typea='1' then 1 else -1 end)*vb.mount
,(case when va.typea='1' then 1 else -1 end)*vb.weight
,(case when va.typea='1' then 1 else -1 end)*vb.total/(case when va.taxtype='3' then 1.05 else 1 end)
,(case when va.typea='1' then 1 else -1 end)*vb.mount*isnull((select price from view_costs where productno=vb.productno and mon=left(va.datea,6)),0)
from view_vcc va left join view_vccs vb on va.noa=vb.noa 
left join view_ucaucc c on vb.productno=c.noa
where vb.productno not in(select pno from @tmpa where tablea='ucce')
and (va.datea between @t_bdate and @t_edate)
and (vb.productno between @t_bpno and @t_epno) and vb.productno!=''
and (c.typea='2' or c.typea='6' ) --group by vb.productno

--沒有盤存報廢
insert into @tmpv
select wb.productno,c.product,c.unit,wb.wmount,wb.weight
,wb.wmount*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0) 
,wb.wmount*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0) 
from view_workb wa left join view_workbs wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa
where wb.productno not in(select pno from @tmpa where tablea='ucce')
and (wa.datea between @t_bdate and @t_edate) and (wb.productno between @t_bpno and @t_epno) and wb.productno!=''
and (c.typea='2' or c.typea='6' ) --group by wb.productno

insert into @tmpv
select wb.productno,c.product,c.unit,wb.wmount,wb.weight
,wb.wmount*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0) 
,wb.wmount*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0) 
from view_workd wa left join view_workds wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa
where wb.productno not in(select pno from @tmpa where tablea='ucce')
and (wa.datea between @t_bdate and @t_edate) and (wb.productno between @t_bpno and @t_epno) and wb.productno!=''
and (c.typea='2' or c.typea='6' ) --group by wb.productno

--插入有盤存的調整數量
insert into @tmpv
select gb.productno,c.product,c.unit,gb.mount,gb.weight
,gb.mount*isnull((select price from view_costs where productno=gb.productno and mon=left(ga.datea,6)),0)
,gb.mount*isnull((select price from view_costs where productno=gb.productno and mon=left(ga.datea,6)),0)
from view_get ga left join view_gets gb on ga.noa=gb.noa 
left join view_ucaucc c on gb.productno=c.noa
where gb.productno in(select pno from @tmpa where tablea='ucce')
and ga.datea>(select MAX(datea) from @tmpa where pno=gb.productno)
and ga.datea<=@t_edate and (gb.productno between @t_bpno and @t_epno) and gb.productno!=''
and (c.typea='2' or c.typea='6' ) --group by gb.productno

--插入沒有盤存的調整數量
insert into @tmpv
select gb.productno,c.product,c.unit,gb.mount,gb.weight
,gb.mount*isnull((select price from view_costs where productno=gb.productno and mon=left(ga.datea,6)),0)
,gb.mount*isnull((select price from view_costs where productno=gb.productno and mon=left(ga.datea,6)),0)
from view_get ga left join view_gets gb on ga.noa=gb.noa 
left join view_ucaucc c on gb.productno=c.noa
where gb.productno not in(select pno from @tmpa where tablea='ucce')
and (ga.datea between @t_bdate and @t_edate)
and (gb.productno between @t_bpno and @t_epno) and gb.productno!=''
and (c.typea='2' or c.typea='6' ) --group by gb.productno

----------------------------------------------------------
declare @tmpb table( 
	pno nvarchar(50),
	product nvarchar(100),
	unit nvarchar(50),
	bmount float, 
	bweight float,
	bmoney float
) 


--插入有盤存的生產數量
insert into @tmpb
select wb.productno,c.product,c.unit,wb.mount,wb.weight
,isnull((select (costa+costb+costc+costd) from view_wcost where noa=wb.noa and productno=wb.productno and workno=wb.workno),0)
from view_workb wa left join view_workbs wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa 
where wb.productno in(select pno from @tmpa where tablea='ucce')
and wa.datea>(select MAX(datea) from @tmpa where pno=wb.productno)
and wa.datea<=@t_edate and (wb.productno between @t_bpno and @t_epno) and wb.productno!=''
and (c.typea='2' or c.typea='6' ) --group by wb.productno

insert into @tmpb
select wb.productno,c.product,c.unit,wb.mount,wb.weight
,isnull((select (costa+costb+costc+costd) from view_wcost where noa=wb.noa and productno=wb.productno and workno=wb.workno),0)
from view_workd wa left join view_workds wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa 
where wb.productno in(select pno from @tmpa where tablea='ucce')
and wa.datea>(select MAX(datea) from @tmpa where pno=wb.productno)
and wa.datea<=@t_edate and (wb.productno between @t_bpno and @t_epno) and wb.productno!=''
and (c.typea='2' or c.typea='6' ) --group by wb.productno

insert into @tmpb
select cb.productno,c.product,c.unit,cb.mount,cb.weight
,cb.mount*isnull((select price from view_costs where productno=cb.productno and mon=left(ca.datea,6)),0)
from view_cut ca left join view_cuts cb on ca.noa=cb.noa left join view_ucaucc c on cb.productno=c.noa 
where cb.productno in(select pno from @tmpa where tablea='ucce')
and ca.datea>(select MAX(datea) from @tmpa where pno=cb.productno)
and ca.datea<=@t_edate and (cb.productno between @t_bpno and @t_epno) and cb.productno!=''
and (c.typea='2' or c.typea='6' ) --group by cb.productno

insert into @tmpb
select cb.productno,c.product,c.unit,cb.mount,cb.weight
,cb.mount*isnull((select price from view_costs where productno=cb.productno and mon=left(ca.datea,6)),0)
from view_cub ca left join view_cubu cb on ca.noa=cb.noa 
left join view_ucaucc c on cb.productno=c.noa 
where cb.productno in(select pno from @tmpa where tablea='ucce')
and ca.datea>(select MAX(datea) from @tmpa where pno=cb.productno)
and ca.datea<=@t_edate and (cb.productno between @t_bpno and @t_epno) and cb.productno!=''
and (c.typea='2' or c.typea='6' ) --group by cb.productno

--插入沒有盤存的領料數量
insert into @tmpb
select wb.productno,c.product,c.unit,wb.mount,wb.weight
,isnull((select (costa+costb+costc+costd) from view_wcost where noa=wb.noa and productno=wb.productno and workno=wb.workno),0)
from view_workb wa left join view_workbs wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa 
where wb.productno not in(select pno from @tmpa where tablea='ucce')
and (wa.datea between @t_bdate and @t_edate)
and (wb.productno between @t_bpno and @t_epno) and wb.productno!=''
and (c.typea='2' or c.typea='6' ) --group by wb.productno

insert into @tmpb
select wb.productno,c.product,c.unit,wb.mount,wb.weight
,isnull((select (costa+costb+costc+costd) from view_wcost where noa=wb.noa and productno=wb.productno and workno=wb.workno),0)
from view_workd wa left join view_workds wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa 
where wb.productno not in(select pno from @tmpa where tablea='ucce')
and (wa.datea between @t_bdate and @t_edate)
and (wb.productno between @t_bpno and @t_epno) and wb.productno!=''
and (c.typea='2' or c.typea='6' ) --group by wb.productno

insert into @tmpb
select cb.productno,c.product,c.unit,cb.mount,cb.weight
,cb.mount*isnull((select price from view_costs where productno=cb.productno and mon=left(ca.datea,6)),0)
from view_cut ca left join view_cuts cb on ca.noa=cb.noa left join view_ucaucc c on cb.productno=c.noa 
where cb.productno not in(select pno from @tmpa where tablea='ucce')
and (ca.datea between @t_bdate and @t_edate)
and (cb.productno between @t_bpno and @t_epno) and cb.productno!=''
and (c.typea='2' or c.typea='6' ) --group by cb.productno

insert into @tmpb
select cb.productno,c.product,c.unit,cb.mount,cb.weight
,cb.mount*isnull((select price from view_costs where productno=cb.productno and mon=left(ca.datea,6)),0)
from view_cub ca left join view_cubt cb on ca.noa=cb.noa 
left join view_ucaucc c on cb.productno=c.noa 
where cb.productno in(select pno from @tmpa where tablea='ucce')
and (ca.datea between @t_bdate and @t_edate)
and (cb.productno between @t_bpno and @t_epno) and cb.productno!=''
and (c.typea='2' or c.typea='6' ) --group by cb.productno

----------------------------------------------------------
--插入沒有期初的資料
insert into @tmp(gno,pno,product,unit,bmount,bweight,bmoney)
select '0',*,0,0,0 from 
(select pno,product,unit from @tmpr union
select pno,product,unit from @tmpv union 
select pno,product,unit from @tmpb)tmps where pno not in (select pno from @tmp)

--更新資料
update a
set a.rcmount=isnull((select sum(rmount) from @tmpr where pno=a.pno),0)
,a.rcweight=isnull((select sum(rweight) from @tmpr where pno=a.pno),0)
,a.rcmoney=isnull((select sum(rmoney) from @tmpr where pno=a.pno),0)
,a.vcmount=isnull((select sum(vmount) from @tmpv where pno=a.pno),0)
,a.vcweight=isnull((select sum(vweight) from @tmpv where pno=a.pno),0)
,a.vcmoney=isnull((select sum(vmoney) from @tmpv where pno=a.pno),0)
,a.vccost=isnull((select sum(vcost) from @tmpv where pno=a.pno),0)
,a.brmount=isnull((select sum(bmount) from @tmpb where pno=a.pno),0)
,a.brweight=isnull((select sum(bweight) from @tmpb where pno=a.pno),0)
,a.brmoney=isnull((select sum(bmoney) from @tmpb where pno=a.pno),0)
from @tmp a

update @tmp set bmoney=0 where bmount<=0
update @tmp set bmoney=0 where bmoney<=0

--毛利率
update @tmp
set profit=case when vcmoney=0 then 0 else ((vcmoney-vccost)/vcmoney)*100 end

--計算期末 
update @tmp 
set lmount=bmount+brmount+rcmount-vcmount,lweight=bweight+brweight+rcweight-vcweight
,lmoney=case when (bmoney+brmoney+rcmoney-vccost)<=0 then 0 else (bmoney+brmoney+rcmoney-vccost) end

update @tmp set lprice=case when lmount=0 then 0 else lmoney/lmount end 
update @tmp set lmoney=0 where lprice<=0

--刪除全部資料都為0
delete @tmp
where bmount=0 and bmoney=0 and brmoney=0 and brmount=0 and brmoney=0 and rcmount=0 and rcmoney=0 and vcmount=0 and vcmoney=0 and vccost=0-- and bweight=0 and brweight=0 and rcweight=0 and vcweight=0

--異常
if(len(@t_aberrant)!=0) 
delete @tmp where lmount>=0 and lmoney>=0 --and lweight>=0 

insert into @tmp
select '1','','','',sum(bmount),sum(bweight),0,sum(bmoney)
,sum(brmount),sum(brweight),sum(brmoney)
,sum(rcmount),sum(rcweight),sum(rcmoney)
,sum(vcmount),sum(vcweight),sum(vcmoney),sum(vccost),case when sum(vcmoney)=0 then 0 else ((sum(vcmoney)-sum(vccost))/sum(vcmoney))*100 end
,sum(lmount),sum(lweight),0,sum(lmoney)
from @tmp

select 
gno,pno,product,unit
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(bmount,2)),1)),0,30)) bmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(bweight,2)),1)),0,30)) bweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(bmoney,2)),1)),0,30)) bmoney

,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(brmount,2)),1)),0,30)) brmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(brweight,2)),1)),0,30)) brweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(brmoney,2)),1)),0,30)) brmoney

,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcmount,2)),1)),0,30)) rcmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcweight,2)),1)),0,30)) rcweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcmoney,2)),1)),0,30)) rcmoney

,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcmount,2)),1)),0,30)) vcmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcweight,2)),1)),0,30)) vcweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcmoney,2)),1)),0,30)) vcmoney
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vccost,2)),1)),0,30)) vccost
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(profit,2)),1)),0,30)) profit

,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lmount,2)),1)),0,30)) lmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lweight,2)),1)),0,30)) lweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lprice,2)),1)),0,30)) lprice
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lmoney,2)),1)),0,30)) lmoney

from @tmp order by gno,pno;
--*********************************************************************************************
z_gen3:--z_gen3
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bpno nvarchar(20)
	declare @t_epno nvarchar(20)
	declare @t_aberrant nvarchar(20)

	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bpno = case when '#non'=[4] then '' else [4] end
	set @t_epno = case when '#non'=[5] then char(255) else [5] end
	set @t_aberrant = case when '#non'=[13] then '' else [13] end
	
	--*****************************************************************************************	
declare @tmp table( 
	gno nvarchar(1),
	pno nvarchar(50),
	product nvarchar(50),
	unit nvarchar(10),
	bmount float, 
	bweight float, 
	bmoney float, 
	rcmount float, 
	rcweight float, 
	rcmoney float, 
	vcmount float, 
	vcweight float, 
	vcmoney float, 
	vccost float,
	profit float, 
	lmount float, 
	lweight float, 
	lprice float, 
	lmoney float
) 

--ina,get做調整用
--worka,workc,cut,cubt領料 
--workb,workd,cuts,cubu生產 
--rc2進貨--vcc銷貨 

--期初
declare @tmpa table( 
	tablea nvarchar(50),
	datea nvarchar(10),
	pno nvarchar(50),
	storeno nvarchar(50),
	mount float, 
	weight float,
	money float
) 

--ucc.typea 1 產品

--期初抓ucce
insert @tmpa--插入期初最後盤點(以查詢日的最後一次盤存)
select 'ucce',a.datea,b.productno,b.storeno,b.mount,b.eweight,b.total 
from view_ucce a left join view_ucces b on a.noa=b.noa 
left join view_ucaucc c on b.productno=c.noa
where a.datea<@t_edate and a.datea+'_'+b.productno+'_'+b.storeno in(
select MAX(a.datea)+'_'+b.productno+'_'+b.storeno
from view_ucce a left join view_ucces b on a.noa=b.noa where a.datea<@t_edate
group by b.productno,b.storeno) and (c.typea='1')

--有盤點-插入盤點之後且資料起始日之前的資料

--進貨
insert @tmpa
select 'rc2',ra.datea,rb.productno,rb.storeno
,(case when ra.typea='1' then 1 else -1 end)*rb.mount
,(case when ra.typea='1' then 1 else -1 end)*rb.weight
,(case when ra.typea='1' then 1 else -1 end)*rb.total/(case when ra.taxtype='3' then 1.05 else 1 end) 
from view_rc2 ra left join view_rc2s rb on ra.noa=rb.noa 
left join view_ucaucc c on rb.productno=c.noa where
rb.storeno+'_'+rb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ra.datea<@t_bdate and ra.datea>=(select datea from @tmpa where pno=rb.productno and storeno=rb.storeno and tablea='ucce')
and rb.productno!='' and (c.typea='1')

--銷售
insert @tmpa
select 'vcc',va.datea,vb.productno,vb.storeno
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount
,-1*(case when va.typea='1' then 1 else -1 end)*vb.weight
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount*
isnull((select price from view_costs where productno=vb.productno and mon=left(va.datea,6)),0) 
from view_vcc va left join view_vccs vb on va.noa=vb.noa 
left join view_ucaucc c on vb.productno=c.noa where
vb.storeno+'_'+vb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and va.datea<@t_bdate and va.datea>=(select datea from @tmpa where pno=vb.productno and storeno=vb.storeno and tablea='ucce')
and vb.productno!='' and (c.typea='1')

--調整
insert @tmpa
select 'ina',ia.datea,ib.productno,ia.storeno,ib.mount,ib.weight,ib.total
from view_ina ia left join view_inas ib on ia.noa=ib.noa 
left join view_ucaucc c on ib.productno=c.noa where
ia.storeno+'_'+ib.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ia.datea<@t_bdate and ia.datea>=(select datea from @tmpa where pno=ib.productno and storeno=ia.storeno and tablea='ucce')
and ib.productno!='' and (c.typea='1')

insert @tmpa
select 'get',ga.datea,gb.productno,ga.storeno,-1*gb.mount,-1*gb.weight,-1*gb.mount
*isnull((select price from view_costs where productno=gb.productno and mon=left(ga.datea,6)),0) 
from view_get ga left join view_gets gb on ga.noa=gb.noa 
left join view_ucaucc c on gb.productno=c.noa where
ga.storeno+'_'+gb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ga.datea<@t_bdate and ga.datea>=(select datea from @tmpa where pno=gb.productno and storeno=ga.storeno and tablea='ucce')
and gb.productno!='' and (c.typea='1')


--無盤點-插入資料起始日之前的資料
--進貨
insert @tmpa
select 'rc2',ra.datea,rb.productno,rb.storeno
,(case when ra.typea='1' then 1 else -1 end)*rb.mount
,(case when ra.typea='1' then 1 else -1 end)*rb.weight
,(case when ra.typea='1' then 1 else -1 end)*rb.total/(case when ra.taxtype='3' then 1.05 else 1 end) 
from view_rc2 ra left join view_rc2s rb on ra.noa=rb.noa 
left join view_ucaucc c on rb.productno=c.noa where
rb.storeno+'_'+rb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ra.datea<@t_bdate and rb.productno!='' and (c.typea='1')

--銷售
insert @tmpa
select 'vcc',va.datea,vb.productno,vb.storeno
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount
,-1*(case when va.typea='1' then 1 else -1 end)*vb.weight
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount*
isnull((select price from view_costs where productno=vb.productno and mon=left(va.datea,6)),0) 
from view_vcc va left join view_vccs vb on va.noa=vb.noa 
left join view_ucaucc c on vb.productno=c.noa where
vb.storeno+'_'+vb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and va.datea<@t_bdate and vb.productno!='' and (c.typea='1')

--調整
insert @tmpa
select 'ina',ia.datea,ib.productno,ia.storeno,ib.mount,ib.weight,ib.total
from view_ina ia left join view_inas ib on ia.noa=ib.noa 
left join view_ucaucc c on ib.productno=c.noa where
ia.storeno+'_'+ib.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ia.datea<@t_bdate and ib.productno!='' and (c.typea='1')

insert @tmpa
select 'get',ga.datea,gb.productno,ga.storeno,-1*gb.mount,-1*gb.weight,-1*gb.mount
*isnull((select price from view_costs where productno=gb.productno and mon=left(ga.datea,6)),0) 
from view_get ga left join view_gets gb on ga.noa=gb.noa 
left join view_ucaucc c on gb.productno=c.noa where
ga.storeno+'_'+gb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ga.datea<@t_bdate and gb.productno!='' and (c.typea='1')

---------------------------------------------------
declare @pno nvarchar(90)
declare @MAXMON nvarchar(50)
declare @MINMON nvarchar(50)
declare cursor_table cursor for
--檢查每個月數量為0 則清空金額
select pno,MAX(LEFT(datea,6)),MIN(LEFT(datea,6)) from @tmpa group by pno
open cursor_table
fetch next from cursor_table
into @pno,@MAXMON,@MINMON
while(@@FETCH_STATUS <> -1)
begin
	while (@MINMON<=@MAXMON)
	begin
		if(select sum(mount) mount
		from @tmpa where pno=@pno and left(datea,6)<=@MINMON)<=0
		begin
			update @tmpa
			set money=0
			where pno=@pno and left(datea,6)<=@MINMON
		end
		
		set @MINMON=cast(cast(LEFT(@MINMON,3)as int)+1911 as nvarchar(20))+'/'+right(@MINMON,2)+'/01'
		set @MINMON=CONVERT (VARCHAR(7),DATEADD(m,+1,@MINMON),12 )+0890000
		set @MINMON=left(@MINMON,3)+'/'+substring(@MINMON,4,2)
		
	end
	
	fetch next from cursor_table
	into @pno,@MAXMON,@MINMON
end
close cursor_table
deallocate cursor_table

--插入期初庫存
insert into @tmp(gno,pno,product,unit,bmount,bweight,bmoney)
select '0',a.pno,MAX(b.product),MAX(b.unit)
,sum(a.mount),sum(a.weight),sum(a.money) 
from @tmpa a left join view_ucaucc b on a.pno=b.noa
where (a.pno between @t_bpno and @t_epno) and (b.typea='1')
group by a.pno

------------------------------------------------------------------
declare @tmpr table( 
	pno nvarchar(50),
	product nvarchar(100),
	unit nvarchar(50),
	rmount float, 
	rweight float,
	rmoney float
) 

--插入有盤存的進料數量
insert into @tmpr
select rb.productno,MAX(c.product),MAX(c.unit)
,sum((case when ra.typea='1' then 1 else -1 end)*rb.mount)
,sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) 
,sum((case when ra.typea='1' then 1 else -1 end)*rb.total/(case when ra.taxtype='3' then 1.05 else 1 end))
from view_rc2 ra left join view_rc2s rb on ra.noa=rb.noa 
left join view_ucaucc c on rb.productno=c.noa
where rb.productno in(select pno from @tmpa where tablea='ucce')
and ra.datea>(select MAX(datea) from @tmpa where pno=rb.productno)
and ra.datea<=@t_edate and (rb.productno between @t_bpno and @t_epno) and rb.productno!=''
and (c.typea='1') group by rb.productno

insert into @tmpr
select ib.productno,MAX(c.product),MAX(c.unit),sum(ib.mount),sum(ib.weight) ,sum(ib.total)
from view_ina ia left join view_inas ib on ia.noa=ib.noa 
left join view_ucaucc c on ib.productno=c.noa
where ib.productno in(select pno from @tmpa where tablea='ucce')
and ia.datea>(select MAX(datea) from @tmpa where pno=ib.productno)
and ia.datea<=@t_edate and (ib.productno between @t_bpno and @t_epno) and ib.productno!=''
and (c.typea='1') group by ib.productno

--插入沒有盤存的進料數量
insert into @tmpr
select rb.productno,MAX(c.product),MAX(c.unit)
,sum((case when ra.typea='1' then 1 else -1 end)*rb.mount)
,sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) 
,sum((case when ra.typea='1' then 1 else -1 end)*rb.total/(case when ra.taxtype='3' then 1.05 else 1 end))
from view_rc2 ra left join view_rc2s rb on ra.noa=rb.noa 
left join view_ucaucc c on rb.productno=c.noa
where rb.productno not in(select pno from @tmpa where tablea='ucce')
and (ra.datea between @t_bdate and @t_edate)
and (rb.productno between @t_bpno and @t_epno)  and rb.productno!=''
and (c.typea='1') group by rb.productno

insert into @tmpr
select ib.productno,MAX(c.product),MAX(c.unit),sum(ib.mount),sum(ib.weight) ,sum(ib.total)
from view_ina ia left join view_inas ib on ia.noa=ib.noa 
left join view_ucaucc c on ib.productno=c.noa
where ib.productno not in(select pno from @tmpa where tablea='ucce')
and (ia.datea between @t_bdate and @t_edate)
and (ib.productno between @t_bpno and @t_epno) and ib.productno!=''
and (c.typea='1') group by ib.productno

------------------------------------------------------------------
declare @tmpv table( 
	pno nvarchar(50),
	product nvarchar(100),
	unit nvarchar(50),
	vmount float, 
	vweight float,
	vmoney float
) 

--插入有盤存的銷售數量
insert into @tmpv
select vb.productno,MAX(c.product),MAX(c.unit)
,sum((case when va.typea='1' then 1 else -1 end)*vb.mount)
,sum((case when va.typea='1' then 1 else -1 end)*vb.weight) 
,sum((case when va.typea='1' then 1 else -1 end)*vb.total/(case when va.taxtype='3' then 1.05 else 1 end))
from view_vcc va left join view_vccs vb on va.noa=vb.noa 
left join view_ucaucc c on vb.productno=c.noa
where vb.productno in(select pno from @tmpa where tablea='ucce')
and va.datea>(select MAX(datea) from @tmpa where pno=vb.productno)
and va.datea<=@t_edate and (vb.productno between @t_bpno and @t_epno) and vb.productno!=''
and (c.typea='1') group by vb.productno

--插入沒有盤存的銷售數量
insert into @tmpv
select vb.productno,MAX(c.product),MAX(c.unit)
,sum((case when va.typea='1' then 1 else -1 end)*vb.mount)
,sum((case when va.typea='1' then 1 else -1 end)*vb.weight) 
,sum((case when va.typea='1' then 1 else -1 end)*vb.total/(case when va.taxtype='3' then 1.05 else 1 end))
from view_vcc va left join view_vccs vb on va.noa=vb.noa 
left join view_ucaucc c on vb.productno=c.noa
where vb.productno not in(select pno from @tmpa where tablea='ucce')
and (va.datea between @t_bdate and @t_edate)
and (vb.productno between @t_bpno and @t_epno) and vb.productno!=''
and (c.typea='1') group by vb.productno

--插入有盤存的調整數量
insert into @tmpv
select gb.productno,c.product,c.unit,gb.mount,gb.weight
,gb.mount*isnull((select price from view_costs where productno=gb.productno and mon=left(ga.datea,6)),0)
from view_get ga left join view_gets gb on ga.noa=gb.noa 
left join view_ucaucc c on gb.productno=c.noa
where gb.productno in(select pno from @tmpa where tablea='ucce')
and ga.datea>(select MAX(datea) from @tmpa where pno=gb.productno)
and ga.datea<=@t_edate and (gb.productno between @t_bpno and @t_epno) and gb.productno!=''
and (c.typea='1') --group by gb.productno

--插入沒有盤存的調整數量
insert into @tmpv
select gb.productno,c.product,c.unit,gb.mount,gb.weight
,gb.mount*isnull((select price from view_costs where productno=gb.productno and mon=left(ga.datea,6)),0)
from view_get ga left join view_gets gb on ga.noa=gb.noa 
left join view_ucaucc c on gb.productno=c.noa
where gb.productno not in(select pno from @tmpa where tablea='ucce')
and (ga.datea between @t_bdate and @t_edate)
and (gb.productno between @t_bpno and @t_epno) and gb.productno!=''
and (c.typea='1') --group by gb.productno

----------------------------------------------------------
--插入沒有期初的資料
insert into @tmp(gno,pno,product,unit,bmount,bweight,bmoney)
select '0',*,0,0,0 from 
(select pno,product,unit from @tmpr union
select pno,product,unit from @tmpv )tmps where pno not in (select pno from @tmp)

--更新資料
update a
set a.rcmount=isnull((select sum(rmount) from @tmpr where pno=a.pno),0)
,a.rcweight=isnull((select sum(rweight) from @tmpr where pno=a.pno),0)
,a.rcmoney=isnull((select sum(rmoney) from @tmpr where pno=a.pno),0)
,a.vcmount=isnull((select sum(vmount) from @tmpv where pno=a.pno),0)
,a.vcweight=isnull((select sum(vweight) from @tmpv where pno=a.pno),0)
,a.vcmoney=isnull((select sum(vmoney) from @tmpv where pno=a.pno),0)
from @tmp a

update @tmp set bmoney=0 where bmount<=0
update @tmp set bmoney=0 where bmoney<=0

--計算成本
update @tmp
set vccost=
case when bmount+rcmount=0 then 0 else round((bmoney+rcmoney)/(bmount+rcmount),2)*vcmount end

--毛利率
update @tmp
set profit=case when vcmoney=0 then 0 else ((vcmoney-vccost)/vcmoney)*100 end

--計算期末 
update @tmp 
set lmount=bmount+rcmount-vcmount,lweight=bweight+rcweight-vcweight
,lmoney=case when (bmoney+rcmoney-vccost)<=0 then 0 else (bmoney+rcmoney-vccost) end

update @tmp set lprice=case when lmount=0 then 0 else lmoney/lmount end 
update @tmp set lmoney=0 where lprice<=0

--刪除全部資料都為0
delete @tmp
where bmount=0 and bmoney=0  and rcmount=0 and rcmoney=0 and vcmount=0 and vcmoney=0 and vccost=0-- and bweight=0 and brweight=0 and rcweight=0 and vcweight=0

--異常
if(len(@t_aberrant)!=0) 
delete @tmp where lmount>=0 and lmoney>=0 --and lweight>=0 

insert into @tmp
select '1','','','',sum(bmount),sum(bweight),sum(bmoney)
,sum(rcmount),sum(rcweight),sum(rcmoney)
,sum(vcmount),sum(vcweight),sum(vcmoney),sum(vccost),case when sum(vcmoney)=0 then 0 else ((sum(vcmoney)-sum(vccost))/sum(vcmoney))*100 end
,sum(lmount),sum(lweight),0,sum(lmoney)
from @tmp

select 
gno,pno,product,unit
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(bmount,0)),1)),4,12)) bmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(bweight,2)),1)),0,30)) bweight
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(bmoney,0)),1)),4,12)) bsmoney

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(rcmount,0)),1)),4,12)) rcmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcweight,2)),1)),0,30)) rcweight
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(rcmoney,0)),1)),4,12)) rcmoney

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(vcmount,0)),1)),4,12)) vcmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcweight,2)),1)),0,30)) vcweight
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(vcmoney,0)),1)),4,12)) vcmoney
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(vccost,0)),1)),4,12)) vccost
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(profit,2)),1)),0,30)) profit

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(lmount,0)),1)),4,12)) lmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lweight,2)),1)),0,30)) lweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lprice,2)),1)),0,30)) lprice
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(lmoney,0)),1)),4,12)) lmoney

from @tmp order by gno,pno;
--*********************************************************************************************
z_gen4:--z_gen4
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bpno nvarchar(20)
	declare @t_epno nvarchar(20)

	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bpno = case when '#non'=[4] then '' else [4] end
	set @t_epno = case when '#non'=[5] then char(255) else [5] end
	
	--*****************************************************************************************	
declare @tmp table( 
	gno nvarchar(1),
	pno nvarchar(50),
	product nvarchar(50),
	unit nvarchar(10),
	mon nvarchar(10),
	datea nvarchar(10),
	item nvarchar(10),--排序用
	memo nvarchar(MAX),
	
	rcmount float, 
	rcweight float,
	rcprice float,
	rcmoney float,
	
	vcgmount float, 
	vcgweight float, 
	vcgcost float, 
	vcmoney float, 
	vcprice float,
	
	lmount float, 
	lweight float, 
	lprice float, 
	lmoney float
) 

--期初
declare @tmpa table( 
	tablea nvarchar(50),
	datea nvarchar(10),
	pno nvarchar(50),
	storeno nvarchar(50),
	mount float, 
	weight float,
	money float
) 

--ucc.typea 4 原料 5 物料

--期初抓ucce
insert @tmpa--插入期初最後盤點(以查詢日的最後一次盤存)
select 'ucce',a.datea,b.productno,b.storeno,b.mount,b.eweight,b.total 
from view_ucce a left join view_ucces b on a.noa=b.noa 
left join ucc c on b.productno=c.noa
where a.datea<@t_edate and a.datea+'_'+b.productno+'_'+b.storeno in(
select MAX(a.datea)+'_'+b.productno+'_'+b.storeno
from view_ucce a left join view_ucces b on a.noa=b.noa where a.datea<@t_edate
group by b.productno,b.storeno) and (c.typea='4' or c.typea='5')

--有盤點-插入盤點之後且資料起始日之前的資料
--進料
insert @tmpa
select 'rc2',ra.datea,rb.productno,rb.storeno
,(case when ra.typea='1' then 1 else -1 end)*rb.mount
,(case when ra.typea='1' then 1 else -1 end)*rb.weight
,(case when ra.typea='1' then 1 else -1 end)*rb.total/(case when ra.taxtype='3' then 1.05 else 1 end) 
from view_rc2 ra left join view_rc2s rb on ra.noa=rb.noa 
left join ucc c on rb.productno=c.noa where
rb.storeno+'_'+rb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ra.datea<@t_bdate and ra.datea>=(select datea from @tmpa where pno=rb.productno and storeno=rb.storeno and tablea='ucce')
and rb.productno!='' and (c.typea='4' or c.typea='5')

--銷售
insert @tmpa
select 'vcc',va.datea,vb.productno,vb.storeno
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount
,-1*(case when va.typea='1' then 1 else -1 end)*vb.weight
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount*
isnull((select price from view_costs where productno=vb.productno and mon=left(va.datea,6)),0) 
from view_vcc va left join view_vccs vb on va.noa=vb.noa 
left join ucc c on vb.productno=c.noa where
vb.storeno+'_'+vb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and va.datea<@t_bdate and va.datea>=(select datea from @tmpa where pno=vb.productno and storeno=vb.storeno and tablea='ucce')
and vb.productno!='' and (c.typea='4' or c.typea='5')

--調整
insert @tmpa
select 'ina',ia.datea,ib.productno,ia.storeno,ib.mount,ib.weight,ib.total
from view_ina ia left join view_inas ib on ia.noa=ib.noa 
left join ucc c on ib.productno=c.noa where
ia.storeno+'_'+ib.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ia.datea<@t_bdate and ia.datea>=(select datea from @tmpa where pno=ib.productno and storeno=ia.storeno and tablea='ucce')
and ib.productno!='' and (c.typea='4' or c.typea='5')

insert @tmpa
select 'get',ga.datea,gb.productno,ga.storeno,-1*gb.mount,-1*gb.weight,-1*gb.mount
*isnull((select price from view_costs where productno=gb.productno and mon=left(ga.datea,6)),0) 
from view_get ga left join view_gets gb on ga.noa=gb.noa 
left join ucc c on gb.productno=c.noa where
ga.storeno+'_'+gb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ga.datea<@t_bdate and ga.datea>=(select datea from @tmpa where pno=gb.productno and storeno=ga.storeno and tablea='ucce')
and gb.productno!='' and (c.typea='4' or c.typea='5')

--領料
insert @tmpa
select 'worka',wa.datea,wb.productno,wb.storeno,(case when wa.typea='1' then -1 else 1 end)*wb.mount,(case when wa.typea='1' then -1 else 1 end)*wb.weight,(case when wa.typea='1' then -1 else 1 end)*wb.mount
*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0) 
from view_worka wa left join view_workas wb on wa.noa=wb.noa 
left join ucc c on wb.productno=c.noa where
wb.storeno+'_'+wb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and wa.datea<@t_bdate and wa.datea>=(select datea from @tmpa where pno=wb.productno and storeno=wb.storeno and tablea='ucce')
and wb.productno!='' and (c.typea='4' or c.typea='5')

insert @tmpa
select 'workc',wa.datea,wb.productno,wb.storeno,(case when wa.typea='1' then -1 else 1 end)*wb.mount,(case when wa.typea='1' then -1 else 1 end)*wb.weight,(case when wa.typea='1' then -1 else 1 end)*wb.mount
*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0) 
from view_workc wa left join view_workcs wb on wa.noa=wb.noa 
left join ucc c on wb.productno=c.noa where
wb.storeno+'_'+wb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and wa.datea<@t_bdate and wa.datea>=(select datea from @tmpa where pno=wb.productno and storeno=wb.storeno and tablea='ucce')
and wb.productno!='' and (c.typea='4' or c.typea='5')

insert @tmpa
select 'cut',ca.datea,ca.productno,ca.storeno,-1*ca.mount,-1*ca.gweight,-1*ca.mount
*isnull((select price from view_costs where productno=ca.productno and mon=left(ca.datea,6)),0) 
from view_cut ca left join ucc c on ca.productno=c.noa where
ca.storeno+'_'+ca.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ca.datea<@t_bdate and ca.datea>=(select datea from @tmpa where pno=ca.productno and storeno=ca.storeno and tablea='ucce')
and ca.productno!='' and (c.typea='4' or c.typea='5')

insert @tmpa
select 'cubt',ca.datea,cb.productno,cb.storeno,-1*cb.mount,-1*cb.weight,-1*cb.mount
*isnull((select price from view_costs where productno=cb.productno and mon=left(ca.datea,6)),0) 
from view_cub ca left join view_cubt cb on ca.noa=cb.noa 
left join ucc c on cb.productno=c.noa where
cb.storeno+'_'+cb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ca.datea<@t_bdate and ca.datea>=(select datea from @tmpa where pno=cb.productno and storeno=cb.storeno and tablea='ucce')
and cb.productno!='' and (c.typea='4' or c.typea='5')

--無盤點-插入資料起始日之前的資料
--進料
insert @tmpa
select 'rc2',ra.datea,rb.productno,rb.storeno
,(case when ra.typea='1' then 1 else -1 end)*rb.mount
,(case when ra.typea='1' then 1 else -1 end)*rb.weight
,(case when ra.typea='1' then 1 else -1 end)*rb.total/(case when ra.taxtype='3' then 1.05 else 1 end) 
from view_rc2 ra left join view_rc2s rb on ra.noa=rb.noa 
left join ucc c on rb.productno=c.noa where
rb.storeno+'_'+rb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ra.datea<@t_bdate and rb.productno!='' and (c.typea='4' or c.typea='5')

--銷售
insert @tmpa
select 'vcc',va.datea,vb.productno,vb.storeno
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount
,-1*(case when va.typea='1' then 1 else -1 end)*vb.weight
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount*
isnull((select price from view_costs where productno=vb.productno and mon=left(va.datea,6)),0) 
from view_vcc va left join view_vccs vb on va.noa=vb.noa 
left join ucc c on vb.productno=c.noa where
vb.storeno+'_'+vb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and va.datea<@t_bdate and vb.productno!='' and (c.typea='4' or c.typea='5')

--調整
insert @tmpa
select 'ina',ia.datea,ib.productno,ia.storeno,ib.mount,ib.weight,ib.total
from view_ina ia left join view_inas ib on ia.noa=ib.noa 
left join ucc c on ib.productno=c.noa where
ia.storeno+'_'+ib.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ia.datea<@t_bdate and ib.productno!='' and (c.typea='4' or c.typea='5')

insert @tmpa
select 'get',ga.datea,gb.productno,ga.storeno,-1*gb.mount,-1*gb.weight,-1*gb.mount
*isnull((select price from view_costs where productno=gb.productno and mon=left(ga.datea,6)),0) 
from view_get ga left join view_gets gb on ga.noa=gb.noa 
left join ucc c on gb.productno=c.noa where
ga.storeno+'_'+gb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ga.datea<@t_bdate and gb.productno!='' and (c.typea='4' or c.typea='5')

--領料
insert @tmpa
select 'worka',wa.datea,wb.productno,wb.storeno,(case when wa.typea='1' then -1 else 1 end)*wb.mount,(case when wa.typea='1' then -1 else 1 end)*wb.weight,(case when wa.typea='1' then -1 else 1 end)*wb.mount
*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0) 
from view_worka wa left join view_workas wb on wa.noa=wb.noa 
left join ucc c on wb.productno=c.noa where
wb.storeno+'_'+wb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and wa.datea<@t_bdate and wb.productno!='' and (c.typea='4' or c.typea='5')

insert @tmpa
select 'workc',wa.datea,wb.productno,wb.storeno,(case when wa.typea='1' then -1 else 1 end)*wb.mount,(case when wa.typea='1' then -1 else 1 end)*wb.weight,(case when wa.typea='1' then -1 else 1 end)*wb.mount
*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0) 
from view_workc wa left join view_workcs wb on wa.noa=wb.noa 
left join ucc c on wb.productno=c.noa where
wb.storeno+'_'+wb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and wa.datea<@t_bdate and wb.productno!='' and (c.typea='4' or c.typea='5')

insert @tmpa
select 'cut',ca.datea,ca.productno,ca.storeno,-1*ca.mount,-1*ca.gweight,-1*ca.mount
*isnull((select price from view_costs where productno=ca.productno and mon=left(ca.datea,6)),0) 
from view_cut ca left join ucc c on ca.productno=c.noa where
ca.storeno+'_'+ca.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ca.datea<@t_bdate and ca.productno!='' and (c.typea='4' or c.typea='5')

insert @tmpa
select 'cubt',ca.datea,cb.productno,cb.storeno,-1*cb.mount,-1*cb.weight,-1*cb.mount
*isnull((select price from view_costs where productno=cb.productno and mon=left(ca.datea,6)),0) 
from view_cub ca left join view_cubt cb on ca.noa=cb.noa 
left join ucc c on cb.productno=c.noa where
cb.storeno+'_'+cb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ca.datea<@t_bdate and cb.productno!='' and (c.typea='4' or c.typea='5')

---------------------------------------------------
declare @pno nvarchar(90)
declare @MAXMON nvarchar(50)
declare @MINMON nvarchar(50)
declare cursor_table cursor for
--檢查每個月數量為0 則清空金額
select pno,MAX(LEFT(datea,6)),MIN(LEFT(datea,6)) from @tmpa group by pno
open cursor_table
fetch next from cursor_table
into @pno,@MAXMON,@MINMON
while(@@FETCH_STATUS <> -1)
begin
	while (@MINMON<=@MAXMON)
	begin
		if(select sum(mount) mount
		from @tmpa where pno=@pno and left(datea,6)<=@MINMON)<=0
		begin
			update @tmpa
			set money=0
			where pno=@pno and left(datea,6)<=@MINMON
		end
		
		set @MINMON=cast(cast(LEFT(@MINMON,3)as int)+1911 as nvarchar(20))+'/'+right(@MINMON,2)+'/01'
		set @MINMON=CONVERT (VARCHAR(7),DATEADD(m,+1,@MINMON),12 )+0890000
		set @MINMON=left(@MINMON,3)+'/'+substring(@MINMON,4,2)
		
	end
	
	fetch next from cursor_table
	into @pno,@MAXMON,@MINMON
end
close cursor_table
deallocate cursor_table
-------------------------------------------

--插入期初
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,rcmount,rcweight,rcmoney)
select '0',a.pno,MAX(b.product),MAX(b.unit),'000/00','000/00/00','1','上期結轉'
,sum(a.mount),sum(a.weight),sum(a.money) 
from @tmpa a left join ucc b on a.pno=b.noa
where (a.pno between @t_bpno and @t_epno) and (b.typea='4' or b.typea='5')
group by a.pno

insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,rcmount,rcweight,rcmoney)
select '0',a.noa,a.product,a.unit,'000/00','000/00/00','1','上期結轉',0,0,0 
from ucc a where (a.noa between @t_bpno and @t_epno) and (a.typea='4' or a.typea='5')
and noa not in (select pno from @tmpa)

--更新單價
update @tmp
set rcprice=case when rcmount=0 then 0 else round(rcmoney/rcmount,2) end

update @tmp
set lmount=rcmount,lweight=rcweight,lmoney=rcmoney,lprice=rcprice

----插入進料
--ina調整用
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,rcmount,rcweight,rcprice,rcmoney)
select '1'gno,u.noa,u.product,u.unit,left(ia.datea,6),ia.datea,2,'進料 '+ia.noa,ib.mount,ib.weight,ib.price,ib.total
from view_ina ia left join view_inas ib on ia.noa=ib.noa left join ucc u on ib.productno=u.noa
where (u.typea='4' or u.typea='5') --原物料
and (u.noa between @t_bpno and @t_epno) 
and (ia.datea between @t_bdate and @t_edate)
--rc2
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,rcmount,rcweight,rcprice,rcmoney)
select '1'gno,u.noa,u.product,u.unit,left(ra.datea,6),ra.datea,2,'進料 '+ra.noa,rb.mount,rb.weight,rb.price,rb.total
from view_rc2 ra left join view_rc2s rb on ra.noa=rb.noa left join ucc u on rb.productno=u.noa
where (u.typea='4' or u.typea='5') --原物料
and (u.noa between @t_bpno and @t_epno) 
and (ra.datea between @t_bdate and @t_edate)
and ra.typea='1'

insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,rcmount,rcweight,rcprice,rcmoney)
select '1'gno,u.noa,u.product,u.unit,left(ra.datea,6),ra.datea,3,'進料退出 '+ra.noa,-1*rb.mount,-1*rb.weight,rb.price,-1*rb.total
from view_rc2 ra left join view_rc2s rb on ra.noa=rb.noa left join ucc u on rb.productno=u.noa
where (u.typea='4' or u.typea='5') --原物料
and (u.noa between @t_bpno and @t_epno) 
and (ra.datea between @t_bdate and @t_edate)
and ra.typea!='1' and rb.mount!=0 and rb.weight!=0

insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,rcmount,rcweight,rcprice,rcmoney)
select '1'gno,u.noa,u.product,u.unit,left(ra.datea,6),ra.datea,3,'進料折讓 '+ra.noa,rb.mount,rb.weight,rb.price,-1*rb.total
from view_rc2 ra left join view_rc2s rb on ra.noa=rb.noa left join ucc u on rb.productno=u.noa
where (u.typea='4' or u.typea='5') --原物料
and (u.noa between @t_bpno and @t_epno) 
and (ra.datea between @t_bdate and @t_edate)
and ra.typea!='1' and rb.mount=0 and rb.weight=0

--插入領用
--get調整用
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,vcgmount,vcgweight,vcgcost)
select '1'gno,u.noa,u.product,u.unit,left(ga.datea,6),ga.datea,5,'領料 '+ga.noa,gb.mount,gb.weight
,gb.mount*isnull((select price from view_costs where productno=gb.productno and mon=left(ga.datea,6)),0) 
from view_get ga left join view_gets gb on ga.noa=gb.noa left join ucc u on gb.productno=u.noa
where (u.typea='4' or u.typea='5') --原物料
and (u.noa between @t_bpno and @t_epno) 
and (ga.datea between @t_bdate and @t_edate)
--worka
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,vcgmount,vcgweight,vcgcost)
select '1'gno,u.noa,u.product,u.unit,left(wa.datea,6),wa.datea,5,'領料 '+wa.noa
,(case when wa.typea='1' then 1 else -1 end)*wb.mount,(case when wa.typea='1' then 1 else -1 end)*wb.weight
,(case when wa.typea='1' then 1 else -1 end)*wb.mount
*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0) 
from view_worka wa left join view_workas wb on wa.noa=wb.noa left join ucc u on wb.productno=u.noa
where (u.typea='4' or u.typea='5') --原物料
and wa.typea='1'
and (u.noa between @t_bpno and @t_epno) 
and (wa.datea between @t_bdate and @t_edate)
--workc
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,vcgmount,vcgweight,vcgcost)
select '1'gno,u.noa,u.product,u.unit,left(wa.datea,6),wa.datea,5,'領料 '+wa.noa
,(case when wa.typea='1' then 1 else -1 end)*wb.mount,(case when wa.typea='1' then 1 else -1 end)*wb.weight
,(case when wa.typea='1' then 1 else -1 end)*wb.mount
*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0) 
from view_workc wa left join view_workcs wb on wa.noa=wb.noa left join ucc u on wb.productno=u.noa
where (u.typea='4' or u.typea='5') --原物料
and wa.typea='1'
and (u.noa between @t_bpno and @t_epno) 
and (wa.datea between @t_bdate and @t_edate)
--cut
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,vcgmount,vcgweight,vcgcost)
select '1'gno,u.noa,u.product,u.unit,left(ca.datea,6),ca.datea,5,'領料 '+ca.noa,ca.mount,ca.gweight
,ca.mount*isnull((select price from view_costs where productno=ca.productno and mon=left(ca.datea,6)),0) 
from view_cut ca left join ucc u on ca.productno=u.noa
where (u.typea='4' or u.typea='5') --原物料
and (u.noa between @t_bpno and @t_epno) 
and (ca.datea between @t_bdate and @t_edate)
--cubt
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,vcgmount,vcgweight,vcgcost)
select '1'gno,u.noa,u.product,u.unit,left(ca.datea,6),ca.datea,5,'領料 '+ca.noa,cb.mount,cb.gweight
,cb.mount*isnull((select price from view_costs where productno=cb.productno and mon=left(ca.datea,6)),0) 
from view_cub ca left join view_cubt cb on ca.noa=cb.noa left join ucc u on cb.productno=u.noa
where (u.typea='4' or u.typea='5') --原物料
and (u.noa between @t_bpno and @t_epno) 
and (ca.datea between @t_bdate and @t_edate)
--vcc
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,vcgmount,vcgweight,vcmoney,vcprice,vcgcost)
select '1'gno,u.noa,u.product,u.unit,left(va.datea,6),va.datea,6,'直接銷售 '+va.noa,vb.mount,vb.weight,vb.total,vb.price
,vb.mount*isnull((select price from view_costs where productno=vb.productno and mon=left(va.datea,6)),0) 
from view_vcc va left join view_vccs vb on va.noa=vb.noa left join ucc u on vb.productno=u.noa
where (u.typea='4' or u.typea='5') --原物料
and (u.noa between @t_bpno and @t_epno) 
and (va.datea between @t_bdate and @t_edate)
and va.typea='1'

insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,vcgmount,vcgweight,vcmoney,vcprice,vcgcost)
select '1'gno,u.noa,u.product,u.unit,left(va.datea,6),va.datea,6,'銷售退回 '+va.noa,-1*vb.mount,-1*vb.weight,-1*vb.total,-1*vb.price
,-1*vb.mount*isnull((select price from view_costs where productno=vb.productno and mon=left(va.datea,6)),0) 
from view_vcc va left join view_vccs vb on va.noa=vb.noa left join ucc u on vb.productno=u.noa
where (u.typea='4' or u.typea='5') --原物料
and (u.noa between @t_bpno and @t_epno) 
and (va.datea between @t_bdate and @t_edate)
and va.typea!='1'

--插入月份合計
insert into @tmp
select '2',pno,product,unit,mon,'','','本月合計'
,SUM(rcmount),SUM(rcweight),null,SUM(rcmoney) 
,SUM(vcgmount),SUM(vcgweight),SUM(vcgcost),SUM(vcmoney),null,null,null,null,null
from @tmp where gno='1' group by pno,product,unit,mon

--插入產品合計
insert into @tmp 
select '3',pno,product,unit,'999/99','','','合計' 
,SUM(rcmount),SUM(rcweight),null,SUM(rcmoney) 
,SUM(vcgmount),SUM(vcgweight),SUM(vcgcost),SUM(vcmoney),null,null,null,null,null 
from @tmp where gno='2' group by pno,product,unit 

insert into @tmp 
select '3',pno,product,unit,'999/99','','','合計' 
,SUM(rcmount),SUM(rcweight),null,SUM(rcmoney) 
,SUM(vcgmount),SUM(vcgweight),SUM(vcgcost),SUM(vcmoney),null,null,null,null,null 
from @tmp where gno='0'
and isnull(pno,'')+'-'+isnull(product,'')+'-'+isnull(unit,'')
not in (select isnull(pno,'')+'-'+isnull(product,'')+'-'+isnull(unit,'') from @tmp where gno='3')
group by pno,product,unit 


declare @gno nvarchar(1),@product nvarchar(50),@unit nvarchar(10),--@pno nvarchar(50)
	@mon nvarchar(10),@datea nvarchar(10),@item nvarchar(10),@memo nvarchar(max),
	@rcmount float,@rcweight float,@rcprice float,@rcmoney float,
	@vcgmount float,@vcgweight float,@vcgcost float,@vcmoney float,@vcprice float,
	@lmount float,@lweight float,@lprice float,@lmoney float
	
declare @t_price float,@t_mount float,@t_weight float,@t_money float

declare cursor_table cursor for 
select * from @tmp order by pno,mon,gno,datea,item
open cursor_table 
fetch next from cursor_table 
into @gno,@pno,@product,@unit,@mon,@datea,@item,@memo,@rcmount,@rcweight,@rcprice,@rcmoney,
@vcgmount,@vcgweight,@vcgcost,@vcmoney,@vcprice,@lmount,@lweight,@lprice,@lmoney
while(@@FETCH_STATUS <> -1) 
begin 
	if(@gno=0)
	begin
		set @t_price=@lprice
		set @t_mount=@lmount
		set @t_weight=@lweight
		set @t_money=@lmoney
	end
	else
	begin
		if(charindex('進料',@memo)>0)
		begin
			set @t_mount=@t_mount+@rcmount
			set @t_weight=@t_weight+@rcweight
			set @t_money=case when @t_mount<=0 then 0 else (@t_money+@rcmoney) end
			set @t_price=case when @t_mount=0 then 0 else @t_money/@t_mount end
			
			update @tmp
			set lmount=@t_mount,lweight=@t_weight,lmoney=@t_money,lprice=@t_price
			where datea=@datea and pno=@pno and memo=@memo and mon=@mon
		end
		
		if(charindex('領料',@memo)>0 or charindex('銷售',@memo)>0)
		begin
			set @t_mount=@t_mount-@vcgmount
			set @t_weight=@t_weight-@vcgweight
			set @vcgcost=@t_price* @vcgmount
			set @t_money=case when @t_mount<=0 then 0 else @t_money-@vcgcost end
			set @t_price=case when @t_money=0 then 0 else @t_money/@t_mount end
			
			update @tmp
			set lmount=@t_mount,lweight=@t_weight,lmoney=@t_money,lprice=@t_price,vcgcost=@vcgcost
			where datea=@datea and pno=@pno and memo=@memo and mon=@mon
		end
		
		if(@gno='3' or @gno='2')
		begin
			update @tmp
			set lmount=@t_mount,lweight=@t_weight,lmoney=@t_money,lprice=@t_price,vcgcost=@vcgcost
			where datea=@datea and pno=@pno and memo=@memo and mon=@mon
		end
		
	end
	
	fetch next from cursor_table 
	into @gno,@pno,@product,@unit,@mon,@datea,@item,@memo,@rcmount,@rcweight,@rcprice,@rcmoney,
	@vcgmount,@vcgweight,@vcgcost,@vcmoney,@vcprice,@lmount,@lweight,@lprice,@lmoney
end 
close cursor_table 
deallocate cursor_table 


select gno,pno,product,unit,mon,datea,item,memo

,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcmount,2)),1)),0,30)) rcmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcweight,2)),1)),0,30)) rcweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcprice,2)),1)),0,30)) rcprice
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcmoney,2)),1)),0,30)) rcmoney

,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcgmount,2)),1)),0,30)) vcgmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcgweight,2)),1)),0,30)) vcgweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcgcost,2)),1)),0,30)) vcgcost
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcmoney,2)),1)),0,30)) vcmoney
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcprice,2)),1)),0,30)) vcprice

,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lmount,2)),1)),0,30)) lmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lweight,2)),1)),0,30)) lweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lprice,2)),1)),0,30)) lprice
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lmoney,2)),1)),0,30)) lmoney

from @tmp order by pno,mon,gno,datea,item;
--*********************************************************************************************
z_gen5:--z_gen5
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bpno nvarchar(20)
	declare @t_epno nvarchar(20)

	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bpno = case when '#non'=[4] then '' else [4] end
	set @t_epno = case when '#non'=[5] then char(255) else [5] end
	
	--*****************************************************************************************	
declare @tmp table( 
	gno nvarchar(1),
	pno nvarchar(50),
	product nvarchar(50),
	unit nvarchar(10),
	mon nvarchar(10),
	datea nvarchar(10),
	item nvarchar(10),--排序用
	memo nvarchar(MAX),
	
	bmount float, 
	bweight float,
	bprice float,
	bmoney float,
	
	vcmount float, 
	vcweight float, 
	vccost float, 
	vcmoney float, 
	vcprice float,
	
	lmount float, 
	lweight float, 
	lprice float, 
	lmoney float
) 

--期初
declare @tmpa table( 
	tablea nvarchar(50),
	datea nvarchar(10),
	pno nvarchar(50),
	storeno nvarchar(50),
	mount float, 
	weight float,
	money float
) 

--ucc.typea 2 製成品 6 下腳品 7 加工

--期初抓ucce
insert @tmpa--插入期初最後盤點(以查詢日的最後一次盤存)
select 'ucce',a.datea,b.productno,b.storeno,b.mount,b.eweight,b.total 
from view_ucce a left join view_ucces b on a.noa=b.noa 
left join view_ucaucc c on b.productno=c.noa
where a.datea<@t_edate and a.datea+'_'+b.productno+'_'+b.storeno in(
select MAX(a.datea)+'_'+b.productno+'_'+b.storeno
from view_ucce a left join view_ucces b on a.noa=b.noa where a.datea<@t_edate
group by b.productno,b.storeno) and (c.typea='2' or c.typea='6' )

--有盤點-插入盤點之後且資料起始日之前的資料

--進貨
insert @tmpa
select 'rc2',ra.datea,rb.productno,rb.storeno
,(case when ra.typea='1' then 1 else -1 end)*rb.mount
,(case when ra.typea='1' then 1 else -1 end)*rb.weight
,(case when ra.typea='1' then 1 else -1 end)*rb.total/(case when ra.taxtype='3' then 1.05 else 1 end) 
from view_rc2 ra left join view_rc2s rb on ra.noa=rb.noa 
left join view_ucaucc c on rb.productno=c.noa where
rb.storeno+'_'+rb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ra.datea<@t_bdate and ra.datea>=(select datea from @tmpa where pno=rb.productno and storeno=rb.storeno and tablea='ucce')
and rb.productno!='' and (c.typea='2' or c.typea='6' )

--銷售
insert @tmpa
select 'vcc',va.datea,vb.productno,vb.storeno
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount
,-1*(case when va.typea='1' then 1 else -1 end)*vb.weight
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount*
isnull((select price from view_costs where productno=vb.productno and mon=left(va.datea,6)),0) 
from view_vcc va left join view_vccs vb on va.noa=vb.noa 
left join view_ucaucc c on vb.productno=c.noa where
vb.storeno+'_'+vb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and va.datea<@t_bdate and va.datea>=(select datea from @tmpa where pno=vb.productno and storeno=vb.storeno and tablea='ucce')
and vb.productno!='' and (c.typea='2' or c.typea='6' )

--調整
insert @tmpa
select 'ina',ia.datea,ib.productno,ia.storeno,ib.mount,ib.weight,ib.total
from view_ina ia left join view_inas ib on ia.noa=ib.noa 
left join view_ucaucc c on ib.productno=c.noa where
ia.storeno+'_'+ib.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ia.datea<@t_bdate and ia.datea>=(select datea from @tmpa where pno=ib.productno and storeno=ia.storeno and tablea='ucce')
and ib.productno!='' and (c.typea='2' or c.typea='6' )

insert @tmpa
select 'get',ga.datea,gb.productno,ga.storeno,-1*gb.mount,-1*gb.weight,-1*gb.mount
*isnull((select price from view_costs where productno=gb.productno and mon=left(ga.datea,6)),0) 
from view_get ga left join view_gets gb on ga.noa=gb.noa 
left join view_ucaucc c on gb.productno=c.noa where
ga.storeno+'_'+gb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ga.datea<@t_bdate and ga.datea>=(select datea from @tmpa where pno=gb.productno and storeno=ga.storeno and tablea='ucce')
and gb.productno!='' and (c.typea='2' or c.typea='6' )


--生產
insert @tmpa
select 'workb',wa.datea,wb.productno,wb.storeno,wb.mount,wb.weight
,isnull((select (costa+costb+costc+costd) from view_wcost where noa=wb.noa and productno=wb.productno and workno=wb.workno),0) 
from view_workb wa left join view_workbs wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa where
wa.storeno+'_'+wb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and wa.datea<@t_bdate and wa.datea>=(select datea from @tmpa where pno=wb.productno and storeno=wb.storeno and tablea='ucce')
and wb.productno!='' and (c.typea='2' or c.typea='6' )

insert @tmpa
select 'workd',wa.datea,wb.productno,wb.storeno,wb.mount,wb.weight
,isnull((select (costa+costb+costc+costd) from view_wcost where noa=wb.noa and productno=wb.productno and workno=wb.workno),0)  
from view_workd wa left join view_workds wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa where
wa.storeno+'_'+wb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and wa.datea<@t_bdate and wa.datea>=(select datea from @tmpa where pno=wb.productno and storeno=wb.storeno and tablea='ucce')
and wb.productno!='' and (c.typea='2' or c.typea='6' )

insert @tmpa
select 'cuts',ca.datea,cb.productno,cb.storeno,cb.mount,cb.weight,cb.mount
*isnull((select price from view_costs where productno=cb.productno and mon=left(ca.datea,6)),0) 
from view_cut ca left join view_cuts cb on ca.noa=cb.noa left join view_ucaucc c on cb.productno=c.noa where
ca.storeno+'_'+cb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ca.datea<@t_bdate and ca.datea>=(select datea from @tmpa where pno=cb.productno and storeno=ca.storeno and tablea='ucce')
and cb.productno!='' and (c.typea='2' or c.typea='6' )

insert @tmpa
select 'cubu',ca.datea,cb.productno,cb.storeno,cb.mount,cb.weight,cb.mount
*isnull((select price from view_costs where productno=cb.productno and mon=left(ca.datea,6)),0) 
from view_cub ca left join view_cubu cb on ca.noa=cb.noa left join view_ucaucc c on cb.productno=c.noa where
cb.storeno+'_'+cb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ca.datea<@t_bdate and ca.datea>=(select datea from @tmpa where pno=cb.productno and storeno=cb.storeno and tablea='ucce')
and cb.productno!='' and (c.typea='2' or c.typea='6' )


--報廢
insert @tmpa
select 'workb',wa.datea,wb.productno,wb.storeno,-1*wb.wmount,0
,-1*wb.wmount*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0)
from view_workb wa left join view_workbs wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa where
wa.storeno+'_'+wb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and wa.datea<@t_bdate and wa.datea>=(select datea from @tmpa where pno=wb.productno and storeno=wb.storeno and tablea='ucce')
and wb.productno!='' and (c.typea='2' or c.typea='6' )

insert @tmpa
select 'workd',wa.datea,wb.productno,wb.storeno,-1*wb.wmount,0
,-1*wb.wmount*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0)
from view_workd wa left join view_workds wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa where
wa.storeno+'_'+wb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and wa.datea<@t_bdate and wa.datea>=(select datea from @tmpa where pno=wb.productno and storeno=wb.storeno and tablea='ucce')
and wb.productno!='' and (c.typea='2' or c.typea='6' )

--無盤點-插入資料起始日之前的資料
--進貨
insert @tmpa
select 'rc2',ra.datea,rb.productno,rb.storeno
,(case when ra.typea='1' then 1 else -1 end)*rb.mount
,(case when ra.typea='1' then 1 else -1 end)*rb.weight
,(case when ra.typea='1' then 1 else -1 end)*rb.total/(case when ra.taxtype='3' then 1.05 else 1 end) 
from view_rc2 ra left join view_rc2s rb on ra.noa=rb.noa 
left join view_ucaucc c on rb.productno=c.noa where
rb.storeno+'_'+rb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ra.datea<@t_bdate and rb.productno!='' and (c.typea='2' or c.typea='6' )

--銷售
insert @tmpa
select 'vcc',va.datea,vb.productno,vb.storeno
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount
,-1*(case when va.typea='1' then 1 else -1 end)*vb.weight
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount*
isnull((select price from view_costs where productno=vb.productno and mon=left(va.datea,6)),0) 
from view_vcc va left join view_vccs vb on va.noa=vb.noa 
left join view_ucaucc c on vb.productno=c.noa where
vb.storeno+'_'+vb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and va.datea<@t_bdate and vb.productno!='' and (c.typea='2' or c.typea='6' )

--調整
insert @tmpa
select 'ina',ia.datea,ib.productno,ia.storeno,ib.mount,ib.weight,ib.total
from view_ina ia left join view_inas ib on ia.noa=ib.noa 
left join view_ucaucc c on ib.productno=c.noa where
ia.storeno+'_'+ib.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ia.datea<@t_bdate and ib.productno!='' and (c.typea='2' or c.typea='6' )

insert @tmpa
select 'get',ga.datea,gb.productno,ga.storeno,-1*gb.mount,-1*gb.weight,-1*gb.mount
*isnull((select price from view_costs where productno=gb.productno and mon=left(ga.datea,6)),0) 
from view_get ga left join view_gets gb on ga.noa=gb.noa 
left join view_ucaucc c on gb.productno=c.noa where
ga.storeno+'_'+gb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ga.datea<@t_bdate and gb.productno!='' and (c.typea='2' or c.typea='6' )

--生產
insert @tmpa
select 'workb',wa.datea,wb.productno,wb.storeno,wb.mount,wb.weight
,isnull((select (costa+costb+costc+costd) from view_wcost where noa=wb.noa and productno=wb.productno and workno=wb.workno),0) 
from view_workb wa left join view_workbs wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa where
wa.storeno+'_'+wb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and wa.datea<@t_bdate and wb.productno!='' and (c.typea='2' or c.typea='6' )

insert @tmpa
select 'workd',wa.datea,wb.productno,wb.storeno,wb.mount,wb.weight
,isnull((select (costa+costb+costc+costd) from view_wcost where noa=wb.noa and productno=wb.productno and workno=wb.workno),0) 
from view_workd wa left join view_workds wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa where
wa.storeno+'_'+wb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and wa.datea<@t_bdate and wb.productno!='' and (c.typea='2' or c.typea='6' )

insert @tmpa
select 'cuts',ca.datea,cb.productno,cb.storeno,cb.mount,cb.weight,cb.mount
*isnull((select price from view_costs where productno=cb.productno and mon=left(ca.datea,6)),0) 
from view_cut ca left join view_cuts cb on ca.noa=cb.noa left join view_ucaucc c on cb.productno=c.noa where
cb.storeno+'_'+cb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ca.datea<@t_bdate and cb.productno!='' and (c.typea='2' or c.typea='6' )

insert @tmpa
select 'cubu',ca.datea,cb.productno,cb.storeno,cb.mount,cb.weight,cb.mount
*isnull((select price from view_costs where productno=cb.productno and mon=left(ca.datea,6)),0) 
from view_cub ca left join view_cubu cb on ca.noa=cb.noa 
left join view_ucaucc c on cb.productno=c.noa where
cb.storeno+'_'+cb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ca.datea<@t_bdate and cb.productno!='' and (c.typea='2' or c.typea='6' )

--報廢
insert @tmpa
select 'workb',wa.datea,wb.productno,wb.storeno,-1*wb.wmount,0
,-1*wb.wmount*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0) 
from view_workb wa left join view_workbs wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa where
wa.storeno+'_'+wb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and wa.datea<@t_bdate and wa.datea>=(select datea from @tmpa where pno=wb.productno and storeno=wb.storeno and tablea='ucce')
and wb.productno!='' and (c.typea='2' or c.typea='6' )

insert @tmpa
select 'workd',wa.datea,wb.productno,wb.storeno,-1*wb.wmount,0
,-1*wb.wmount*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0)
from view_workd wa left join view_workds wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa where
wa.storeno+'_'+wb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and wa.datea<@t_bdate and wa.datea>=(select datea from @tmpa where pno=wb.productno and storeno=wb.storeno and tablea='ucce')
and wb.productno!='' and (c.typea='2' or c.typea='6' )

---------------------------------------------------
declare @pno nvarchar(90)
declare @MAXMON nvarchar(50)
declare @MINMON nvarchar(50)
declare cursor_table cursor for
--檢查每個月數量為0 則清空金額
select pno,MAX(LEFT(datea,6)),MIN(LEFT(datea,6)) from @tmpa group by pno
open cursor_table
fetch next from cursor_table
into @pno,@MAXMON,@MINMON
while(@@FETCH_STATUS <> -1)
begin
	while (@MINMON<=@MAXMON)
	begin
		if(select sum(mount) mount
		from @tmpa where pno=@pno and left(datea,6)<=@MINMON)<=0
		begin
			update @tmpa
			set money=0
			where pno=@pno and left(datea,6)<=@MINMON
		end
		
		set @MINMON=cast(cast(LEFT(@MINMON,3)as int)+1911 as nvarchar(20))+'/'+right(@MINMON,2)+'/01'
		set @MINMON=CONVERT (VARCHAR(7),DATEADD(m,+1,@MINMON),12 )+0890000
		set @MINMON=left(@MINMON,3)+'/'+substring(@MINMON,4,2)
		
	end
	
	fetch next from cursor_table
	into @pno,@MAXMON,@MINMON
end
close cursor_table
deallocate cursor_table
------------------------------------------- 

--插入期初 
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,bmount,bweight,bmoney) 
select '0',a.pno,MAX(b.product),MAX(b.unit),'000/00','000/00/00','1','上期結轉' 
,sum(a.mount),sum(a.weight),sum(a.money) 
from @tmpa a left join view_ucaucc b on a.pno=b.noa 
where (a.pno between @t_bpno and @t_epno) and (b.typea='2' or b.typea='6' ) 
group by a.pno 

insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,bmount,bweight,bmoney) 
select '0',a.noa,a.product,a.unit,'000/00','000/00/00','1','上期結轉',0,0,0 
from view_ucaucc a where (a.noa between @t_bpno and @t_epno) and (a.typea='2' or a.typea='6' ) 
and noa not in (select pno from @tmpa) 

--更新單價 
update @tmp 
set bprice= case when bmount =0 then 0 else round(bmoney/bmount,2) end

update @tmp
set lmount=bmount,lmoney=bmoney,lprice=bprice

----插入生產
--workb
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,bmount,bweight,bprice,bmoney)
select '1'gno,u.noa,u.product,u.unit,left(wa.datea,6),wa.datea,2,'生產 '+wa.noa,wb.mount,wb.weight
,isnull((select (wc.costa+wc.costb+wc.costc+wc.costd)/wc.mount from view_wcost wc where wc.noa=wb.noa and wc.productno=wb.productno and wc.workno=wb.workno),0) price
,isnull((select (wc.costa+wc.costb+wc.costc+wc.costd) from view_wcost wc where wc.noa=wb.noa and wc.productno=wb.productno and wc.workno=wb.workno),0)
from view_workb wa left join view_workbs wb on wa.noa=wb.noa left join view_ucaucc u on wb.productno=u.noa
where (u.typea='2' or u.typea='6' ) --製成品&下腳品&加工
and (u.noa between @t_bpno and @t_epno) 
and (wa.datea between @t_bdate and @t_edate)

--workd
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,bmount,bweight,bprice,bmoney)
select '1'gno,u.noa,u.product,u.unit,left(wa.datea,6),wa.datea,2,'委外生產 '+wa.noa,wb.mount+wb.inmount-wb.outmount,wb.weight
,isnull((select (wc.costa+wc.costb+wc.costc+wc.costd)/wc.mount from view_wcost wc where wc.noa=wb.noa and wc.productno=wb.productno and wc.workno=wb.workno),0) price
,isnull((select (wc.costa+wc.costb+wc.costc+wc.costd) from view_wcost wc where wc.noa=wb.noa and wc.productno=wb.productno and wc.workno=wb.workno),0)
from view_workd wa left join view_workds wb on wa.noa=wb.noa left join view_ucaucc u on wb.productno=u.noa
where (u.typea='2' or u.typea='6' ) --製成品&下腳品&加工
and (u.noa between @t_bpno and @t_epno) 
and (wa.datea between @t_bdate and @t_edate)

--cuts
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,bmount,bweight,bprice,bmoney)
select '1'gno,u.noa,u.product,u.unit,left(ca.datea,6),ca.datea,2,'裁剪生產 '+ca.noa,cb.mount,cb.weight
,(select price from view_costs cs where cs.mon=left(ca.datea,6) and cs.productno=u.noa) price
,cb.mount*(select price from view_costs cs where cs.mon=left(ca.datea,6) and cs.productno=u.noa)
from view_cut ca left join view_cuts cb on ca.noa=cb.noa left join view_ucaucc u on cb.productno=u.noa
where (u.typea='2' or u.typea='6' ) --製成品&下腳品&加工
and (u.noa between @t_bpno and @t_epno) 
and (ca.datea between @t_bdate and @t_edate)

--cubu
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,bmount,bweight,bprice,bmoney)
select '1'gno,u.noa,u.product,u.unit,left(ca.datea,6),ca.datea,2,'配料生產 '+ca.noa,cb.mount,cb.weight
,(select price from view_costs cs where cs.mon=left(ca.datea,6) and cs.productno=u.noa) price
,cb.mount *(select price from view_costs cs where cs.mon=left(ca.datea,6) and cs.productno=u.noa)
from view_cub ca left join view_cubu cb on ca.noa=cb.noa left join view_ucaucc u on cb.productno=u.noa
where (u.typea='2' or u.typea='6' ) --製成品&下腳品&加工
and (u.noa between @t_bpno and @t_epno) 
and (ca.datea between @t_bdate and @t_edate)

----插入報廢
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,bmount,bweight,bprice,bmoney)
select '1'gno,u.noa,u.product,u.unit,left(wa.datea,6),wa.datea,6,'報廢 '+wa.noa,-1*wa.discardmount,-1*wa.discardmount
,(select price from view_costs cs where cs.mon=left(wa.datea,6) and cs.productno=u.noa)
, -1*wa.discardmount *(select price from view_costs cs where cs.mon=left(wa.datea,6) and cs.productno=u.noa) money
from view_workx wa left join view_ucaucc u on wa.productno=u.noa
where (u.typea='2' or u.typea='6' ) --製成品&下腳品&加工
and (u.noa between @t_bpno and @t_epno) 
and (wa.datea between @t_bdate and @t_edate)

----插入銷售
--vcc
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,vcmount,vcweight,vcmoney,vcprice)
select '1'gno,u.noa,u.product,u.unit,left(va.datea,6),va.datea,3,'銷售 '+va.noa,vb.mount,vb.weight,vb.total,vb.price
from view_vcc va left join view_vccs vb on va.noa=vb.noa left join view_ucaucc u on vb.productno=u.noa
where (u.typea='2' or u.typea='6' ) --製成品&下腳品&加工
and (u.noa between @t_bpno and @t_epno) 
and (va.datea between @t_bdate and @t_edate)
and va.typea='1' and vb.mount!=0 --and vb.weight!=0

insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,vcmount,vcweight,vcmoney,vcprice)
select '1'gno,u.noa,u.product,u.unit,left(va.datea,6),va.datea,4,'退回 '+va.noa,-1*vb.mount,-1*vb.weight,-1*vb.total,vb.price
from view_vcc va left join view_vccs vb on va.noa=vb.noa left join view_ucaucc u on vb.productno=u.noa
where (u.typea='2' or u.typea='6' ) --製成品&下腳品&加工
and (u.noa between @t_bpno and @t_epno) 
and (va.datea between @t_bdate and @t_edate)
and va.typea!='1' and vb.mount!=0 --and vb.weight!=0

insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,vcmount,vcweight,vcmoney,vcprice)
select '1'gno,u.noa,u.product,u.unit,left(va.datea,6),va.datea,5,'折讓 '+va.noa,-1*vb.mount,-1*vb.weight,-1*vb.total,vb.price
from view_vcc va left join view_vccs vb on va.noa=vb.noa left join view_ucaucc u on vb.productno=u.noa
where (u.typea='2' or u.typea='6' ) --製成品&下腳品&加工
and (u.noa between @t_bpno and @t_epno) 
and (va.datea between @t_bdate and @t_edate)
and va.typea!='1' and vb.mount=0 --and vb.weight=0

--插入月份合計
insert into @tmp
select '2',pno,product,unit,mon,'','','本月合計'
,SUM(bmount),SUM(bweight),null,SUM(bmoney) 
,SUM(vcmount),SUM(vcweight),SUM(vccost),SUM(vcmoney),null,null,null,null,null
from @tmp where gno='1' group by pno,product,unit,mon

--插入產品合計
insert into @tmp 
select '3',pno,product,unit,'999/99','','','合計' 
,SUM(bmount),SUM(bweight),null,SUM(bmoney) 
,SUM(vcmount),SUM(vcweight),SUM(vccost),SUM(vcmoney),null,null,null,null,null 
from @tmp where gno='2' group by pno,product,unit 

insert into @tmp 
select '3',pno,product,unit,'999/99','','','合計' 
,SUM(bmount),SUM(bweight),null,SUM(bmoney) 
,SUM(vcmount),SUM(vcweight),SUM(vccost),SUM(vcmoney),null,null,null,null,null 
from @tmp where gno='0'
and isnull(pno,'')+'-'+isnull(product,'')+'-'+isnull(unit,'')
not in (select isnull(pno,'')+'-'+isnull(product,'')+'-'+isnull(unit,'') from @tmp where gno='3')
group by pno,product,unit 


declare @gno nvarchar(1),@product nvarchar(50),@unit nvarchar(10),
	@mon nvarchar(10),@datea nvarchar(10),@item nvarchar(10),@memo nvarchar(max),
	@bmount float,@bweight float,@bprice float,@bmoney float,
	@vcmount float,@vcweight float,@vccost float,@vcmoney float,@vcprice float,
	@lmount float,@lweight float,@lprice float,@lmoney float
	
declare @t_price float,@t_mount float,@t_weight float,@t_money float

declare cursor_table cursor for 
select * from @tmp order by pno,mon,gno,datea,item
open cursor_table 
fetch next from cursor_table 
into @gno,@pno,@product,@unit,@mon,@datea,@item,@memo,@bmount,@bweight,@bprice,@bmoney,
@vcmount,@vcweight,@vccost,@vcmoney,@vcprice,@lmount,@lweight,@lprice,@lmoney
while(@@FETCH_STATUS <> -1) 
begin 
	if(@gno=0)
	begin
		set @t_price=@lprice
		set @t_mount=@lmount
		set @t_weight=@lweight
		set @t_money=@lmoney
	end
	else
	begin
		if(charindex('生產',@memo)>0 or charindex('報廢',@memo)>0)
		begin
			set @t_mount=@t_mount+@bmount
			set @t_weight=@t_weight+@bweight
			set @t_money=case when @t_mount<=0 then 0 else @t_money+@bmoney end
			set @t_price=case when @t_money=0 then 0 else @t_money/@t_mount  end
			
			update @tmp
			set lmount=@t_mount,lweight=@t_weight,lmoney=@t_money,lprice=@t_price
			where datea=@datea and pno=@pno and memo=@memo and mon=@mon
		end
		
		if(charindex('銷售',@memo)>0 or charindex('退回',@memo)>0 or charindex('折讓',@memo)>0)
		begin
			set @t_mount=@t_mount-@vcmount
			set @t_weight=@t_weight-@vcweight
			set @vccost=@t_price*@vcmount
			set @t_money=case when @t_mount<=0 then 0 else @t_money-@vccost end
			set @t_price=case when @t_money=0 then 0 else @t_money/@t_mount end
			
			update @tmp
			set lmount=@t_mount,lweight=@t_weight,lmoney=@t_money,lprice=@t_price,vccost=@vccost
			where datea=@datea and pno=@pno and memo=@memo and mon=@mon
		end
	
		if(@gno='3' or @gno='2')
		begin
			update @tmp
			set lmount=@t_mount,lweight=@t_weight,lmoney=@t_money,lprice=@t_price,vccost=@vccost
			where mon=@mon and pno=@pno and memo=@memo and mon=@mon
		end
	end
	
	fetch next from cursor_table 
	into @gno,@pno,@product,@unit,@mon,@datea,@item,@memo,@bmount,@bweight,@bprice,@bmoney,
	@vcmount,@vcweight,@vccost,@vcmoney,@vcprice,@lmount,@lweight,@lprice,@lmoney
end 
close cursor_table 
deallocate cursor_table 

select gno,pno,product,unit,mon,datea,item,memo

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(bmount,0)),1)),4,12)) bmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(bweight,2)),1)),0,30)) bweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(bprice,2)),1)),0,30)) bprice
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(bmoney,0)),1)),4,12)) bmoney

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(vcmount,0)),1)),4,12)) vcmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcweight,2)),1)),0,30)) vcweight
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(vccost,0)),1)),4,12)) vccost
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(vcmoney,0)),1)),4,12)) vcmoney
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcprice,2)),1)),0,30)) vcprice

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(lmount,0)),1)),4,12)) lmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lweight,2)),1)),0,30)) lweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lprice,2)),1)),0,30)) lprice
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(lmoney,0)),1)),4,12)) lmoney

from @tmp order by pno,mon,gno,datea,item;
--*********************************************************************************************
z_gen6:--z_gen6
declare @bordeno nvarchar(30) 
declare @eordeno nvarchar(30) 

set @bordeno = case when '#non'=[6] then '' else [6] end
set @eordeno = case when '#non'=[7] then char(255) else [7] end

declare @end table(
	recno int identity(0,1),
	gno nvarchar(50),
	ordeno nvarchar(50),
	no2 nvarchar(50),
	workno nvarchar(50), 
	productno nvarchar(50),
	product nvarchar(50),
	mount float,
	total float,
	inmount float,--入庫
	acost float,--原料成本
	bcost float,--人工成本
	ccost float,--費用成本
	dcost float,--委外成本
	cost float--成本
)

insert into @end
select '0',ob.noa,ob.no2,c.noa,ob.productno,ob.product,ob.mount,ob.total,0,0,0,0,0,0
from view_orde oa left join view_ordes ob on oa.noa=ob.noa 
outer apply(select noa from view_work  where charindex(ob.noa+'-'+ob.no2,ordeno)>0 and ob.productno=productno)c 
where oa.noa between @bordeno and @eordeno and ob.noa!=''

--更新入庫數量
update a
set inmount=isnull(c.mount,0)
from @end a
--left JOIN view_work b on a.ordeno=b.ordeno and a.no2=b.no2 and a.productno=b.productno
left JOIN (
select workno,productno,SUM(mount)mount from(
select workno,productno,mount from view_workbs union all select workno,productno,mount+inmount-outmount from view_workds
)tmp group by workno,productno
)c on a.workno=c.workno and a.productno=c.productno

--更新原料成本
update a
set acost=isnull(c.costa,0)
from @end a
--left JOIN view_work b on a.ordeno=b.ordeno and a.no2=b.no2 and a.productno=b.productno
left JOIN (select workno,productno,SUM(costa)costa from view_wcost group by workno,productno) c on a.workno=c.workno and a.productno=c.productno

--更新人工成本
update a
set bcost=isnull(c.costb,0)
from @end a
--left JOIN view_work b on a.ordeno=b.ordeno and a.no2=b.no2 and a.productno=b.productno
left JOIN (select workno,productno,SUM(costb)costb from view_wcost group by workno,productno) c on a.workno=c.workno and a.productno=c.productno

--更新費用成本
update a
set ccost=isnull(c.costc,0)
from @end a
--left JOIN view_work b on a.ordeno=b.ordeno and a.no2=b.no2 and a.productno=b.productno
left JOIN (select workno,productno,SUM(costc)costc from view_wcost group by workno,productno) c on a.workno=c.workno and a.productno=c.productno

--更新委外成本
update a
set dcost=isnull(c.costd,0)
from @end a
--left JOIN view_work b on a.ordeno=b.ordeno and a.no2=b.no2 and a.productno=b.productno
left JOIN (select workno,productno,SUM(costd)costd from view_wcost group by workno,productno) c on a.workno=c.workno and a.productno=c.productno

update @end
set cost=acost+bcost+ccost+dcost

select gno,ordeno,no2,productno pno,product
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),0,30)) mount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,inmount),1)),0,30)) inmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount-inmount),1)),0,30)) unmount
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(acost,2)),1)),0,30)) acost
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(bcost,2)),1)),0,30)) bcost
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(ccost,2)),1)),0,30)) ccost
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(dcost,2)),1)),0,30)) dcost
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(cost,2)),1)),0,30)) cost
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(total-cost,0)),1)),4,30)) rate
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(case when total!=0 then ((total-cost)/total)*100 else 0 end,2)),1)),0,30)) prate
from @end order by ordeno
;
----*******************************************************************************************
z_gen7:--z_gen7
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bpno nvarchar(20)
	declare @t_epno nvarchar(20)
	declare @t_bordeno nvarchar(20)
	declare @t_eordeno nvarchar(20)
	declare @t_bcuano nvarchar(20)
	declare @t_ecuano nvarchar(20)
	declare @t_bworkno nvarchar(20)
	declare @t_eworkno nvarchar(20)
	declare @t_bmon nvarchar(10)
	declare @t_emon nvarchar(10)

	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bpno = case when '#non'=[4] then '' else [4] end
	set @t_epno = case when '#non'=[5] then char(255) else [5] end
	set @t_bordeno = case when '#non'=[6] then '' else [6] end
	set @t_eordeno = case when '#non'=[7] then char(255) else [7] end
	set @t_bcuano = case when '#non'=[8] then '' else [8] end
	set @t_ecuano = case when '#non'=[9] then char(255) else [9] end
	set @t_bworkno = case when '#non'=[10] then '' else [10] end
	set @t_eworkno = case when '#non'=[11] then char(255) else [11] end
	set @t_bmon = case when '#non'=[15] then '' else [15] end
	set @t_emon = case when '#non'=[16] then char(255) else [16] end
	
	--*****************************************************************************************	
	declare @tmp table(
		gno nvarchar(50),
		seq nvarchar(MAX),
		datea nvarchar(50),
		ordeno nvarchar(MAX),
		workno nvarchar(MAX), 
		noa nvarchar(MAX),
		typea nvarchar(MAX),
		pno nvarchar(MAX), 
		product nvarchar(MAX),
		mount nvarchar(MAX),
		costa nvarchar(MAX),
		costb nvarchar(MAX), 
		costc nvarchar(MAX),
		costd nvarchar(MAX),
		memo nvarchar(MAX),
		costt nvarchar(MAX)
	)
	
	insert @tmp
	select '0'gno,a.seq,a.datea,b.ordeno,a.workno,a.noa
	,(case when a.seq='1' then '領料' when a.seq='2' then '委出' when a.seq='3' then '入庫' when a.seq='4' then '委入' else '' end) typea
	,a.productno pno,u.product
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,a.mount),1)),0,30)) mount
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,a.costa),1)),0,30)) costa
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,a.costb),1)),0,30)) costb
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,a.costc),1)),0,30)) costc
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,a.costd),1)),0,30)) costd
	,REPLACE(REPLACE(REPLACE(a.memo,'B','</BR> B'),'C','</BR>C'),'D','</BR>D') memo
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,a.costa+a.costb+a.costc+a.costd),1)),0,30)) costt
	from view_wcost a left join view_work b on a.workno=b.noa
	left join (select noa,product from ucc union select noa,product from uca where noa not in (select noa from ucc) union select productno noa,productno+'在製品' from ucat where productno not in (select noa from uca)) u on a.productno=u.noa
	where (a.datea between @t_bdate and @t_edate) 
	and (a.productno between @t_bpno and @t_epno)
	--and (b.ordeno between @t_bordeno and @t_eordeno)
	and (b.cuano between @t_bcuano and @t_ecuano)
	and (a.workno between @t_bworkno and @t_eworkno)
	and (a.mon between @t_bmon and @t_emon)
	order by a.datea,case when a.seq='2' then '3' when a.seq='3' then '2' else a.seq end,a.productno
	
	if(@t_bordeno!='' or @t_eordeno!=char(255))
		delete @tmp where workno not in (
			select wa.noa from view_work wa left join view_orde ob on CHARINDEX(ob.noa,wa.ordeno)>0 
			where ob.noa between @t_bordeno and @t_eordeno group by wa.noa
		)
	
	select * from @tmp order by datea,case when seq='2' then '3' when seq='3' then '2' else seq end,pno
;
	--*****************************************************************************************	
	z_gen8:--z_gen8
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bpno nvarchar(20)
	declare @t_epno nvarchar(20)

	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bpno = case when '#non'=[4] then '' else [4] end
	set @t_epno = case when '#non'=[5] then char(255) else [5] end
	
	--*****************************************************************************************	
declare @tmp table( 
	gno nvarchar(1),
	pno nvarchar(50),
	product nvarchar(50),
	unit nvarchar(10),
	mon nvarchar(10),
	datea nvarchar(10),
	item nvarchar(10),--排序用
	memo nvarchar(MAX),
	
	rcmount float, 
	rcweight float,
	rcprice float,
	rcmoney float,

	vcmount float, 
	vcweight float, 
	vccost float, 
	vcmoney float, 
	vcprice float,
	
	lmount float, 
	lweight float, 
	lprice float, 
	lmoney float
) 

--期初
declare @tmpa table( 
	tablea nvarchar(50),
	datea nvarchar(10),
	pno nvarchar(50),
	storeno nvarchar(50),
	mount float, 
	weight float,
	money float
) 

--ucc.typea 1 產品

--期初抓ucce
insert @tmpa--插入期初最後盤點(以查詢日的最後一次盤存)
select 'ucce',a.datea,b.productno,b.storeno,b.mount,b.eweight,b.total 
from view_ucce a left join view_ucces b on a.noa=b.noa 
left join view_ucaucc c on b.productno=c.noa
where a.datea<@t_edate and a.datea+'_'+b.productno+'_'+b.storeno in(
select MAX(a.datea)+'_'+b.productno+'_'+b.storeno
from view_ucce a left join view_ucces b on a.noa=b.noa where a.datea<@t_edate
group by b.productno,b.storeno) and (c.typea='1')

--有盤點-插入盤點之後且資料起始日之前的資料

--進貨
insert @tmpa
select 'rc2',ra.datea,rb.productno,rb.storeno
,(case when ra.typea='1' then 1 else -1 end)*rb.mount
,(case when ra.typea='1' then 1 else -1 end)*rb.weight
,(case when ra.typea='1' then 1 else -1 end)*rb.total/(case when ra.taxtype='3' then 1.05 else 1 end) 
from view_rc2 ra left join view_rc2s rb on ra.noa=rb.noa 
left join view_ucaucc c on rb.productno=c.noa where
rb.storeno+'_'+rb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ra.datea<@t_bdate and ra.datea>=(select datea from @tmpa where pno=rb.productno and storeno=rb.storeno and tablea='ucce')
and rb.productno!='' and (c.typea='1')

--銷售
insert @tmpa
select 'vcc',va.datea,vb.productno,vb.storeno
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount
,-1*(case when va.typea='1' then 1 else -1 end)*vb.weight
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount*
isnull((select price from view_costs where productno=vb.productno and mon=left(va.datea,6)),0) 
from view_vcc va left join view_vccs vb on va.noa=vb.noa 
left join view_ucaucc c on vb.productno=c.noa where
vb.storeno+'_'+vb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and va.datea<@t_bdate and va.datea>=(select datea from @tmpa where pno=vb.productno and storeno=vb.storeno and tablea='ucce')
and vb.productno!='' and (c.typea='1')

--調整
insert @tmpa
select 'ina',ia.datea,ib.productno,ia.storeno,ib.mount,ib.weight,ib.total
from view_ina ia left join view_inas ib on ia.noa=ib.noa 
left join view_ucaucc c on ib.productno=c.noa where
ia.storeno+'_'+ib.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ia.datea<@t_bdate and ia.datea>=(select datea from @tmpa where pno=ib.productno and storeno=ia.storeno and tablea='ucce')
and ib.productno!='' and (c.typea='1')

insert @tmpa
select 'get',ga.datea,gb.productno,ga.storeno,-1*gb.mount,-1*gb.weight,-1*gb.mount
*isnull((select price from view_costs where productno=gb.productno and mon=left(ga.datea,6)),0) 
from view_get ga left join view_gets gb on ga.noa=gb.noa 
left join view_ucaucc c on gb.productno=c.noa where
ga.storeno+'_'+gb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ga.datea<@t_bdate and ga.datea>=(select datea from @tmpa where pno=gb.productno and storeno=ga.storeno and tablea='ucce')
and gb.productno!='' and (c.typea='1')


--無盤點-插入資料起始日之前的資料
--進貨
insert @tmpa
select 'rc2',ra.datea,rb.productno,rb.storeno
,(case when ra.typea='1' then 1 else -1 end)*rb.mount
,(case when ra.typea='1' then 1 else -1 end)*rb.weight
,(case when ra.typea='1' then 1 else -1 end)*rb.total/(case when ra.taxtype='3' then 1.05 else 1 end) 
from view_rc2 ra left join view_rc2s rb on ra.noa=rb.noa 
left join view_ucaucc c on rb.productno=c.noa where
rb.storeno+'_'+rb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ra.datea<@t_bdate and rb.productno!='' and (c.typea='1')

--銷售
insert @tmpa
select 'vcc',va.datea,vb.productno,vb.storeno
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount
,-1*(case when va.typea='1' then 1 else -1 end)*vb.weight
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount*
isnull((select price from view_costs where productno=vb.productno and mon=left(va.datea,6)),0) 
from view_vcc va left join view_vccs vb on va.noa=vb.noa 
left join view_ucaucc c on vb.productno=c.noa where
vb.storeno+'_'+vb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and va.datea<@t_bdate and vb.productno!='' and (c.typea='1')

--調整
insert @tmpa
select 'ina',ia.datea,ib.productno,ia.storeno,ib.mount,ib.weight,ib.total
from view_ina ia left join view_inas ib on ia.noa=ib.noa 
left join view_ucaucc c on ib.productno=c.noa where
ia.storeno+'_'+ib.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ia.datea<@t_bdate and ib.productno!='' and (c.typea='1')

insert @tmpa
select 'get',ga.datea,gb.productno,ga.storeno,-1*gb.mount,-1*gb.weight,-1*gb.mount
*isnull((select price from view_costs where productno=gb.productno and mon=left(ga.datea,6)),0) 
from view_get ga left join view_gets gb on ga.noa=gb.noa 
left join view_ucaucc c on gb.productno=c.noa where
ga.storeno+'_'+gb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ga.datea<@t_bdate and gb.productno!='' and (c.typea='1')

---------------------------------------------------
declare @pno nvarchar(90)
declare @MAXMON nvarchar(50)
declare @MINMON nvarchar(50)
declare cursor_table cursor for
--檢查每個月數量為0 則清空金額
select pno,MAX(LEFT(datea,6)),MIN(LEFT(datea,6)) from @tmpa group by pno
open cursor_table
fetch next from cursor_table
into @pno,@MAXMON,@MINMON
while(@@FETCH_STATUS <> -1)
begin
	while (@MINMON<=@MAXMON)
	begin
		if(select sum(mount) mount
		from @tmpa where pno=@pno and left(datea,6)<=@MINMON)<=0
		begin
			update @tmpa
			set money=0
			where pno=@pno and left(datea,6)<=@MINMON
		end
		
		set @MINMON=cast(cast(LEFT(@MINMON,3)as int)+1911 as nvarchar(20))+'/'+right(@MINMON,2)+'/01'
		set @MINMON=CONVERT (VARCHAR(7),DATEADD(m,+1,@MINMON),12 )+0890000
		set @MINMON=left(@MINMON,3)+'/'+substring(@MINMON,4,2)
		
	end
	
	fetch next from cursor_table
	into @pno,@MAXMON,@MINMON
end
close cursor_table
deallocate cursor_table
------------------------------------------- 

--插入期初 
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,rcmount,rcweight,rcmoney) 
select '0',a.pno,MAX(b.product),MAX(b.unit),'000/00','000/00/00','1','上期結轉' 
,sum(a.mount),sum(a.weight),sum(a.money) 
from @tmpa a left join view_ucaucc b on a.pno=b.noa 
where (a.pno between @t_bpno and @t_epno) and (b.typea='1') 
group by a.pno 

insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,rcmount,rcweight,rcmoney) 
select '0',a.noa,a.product,a.unit,'000/00','000/00/00','1','上期結轉',0,0,0 
from view_ucaucc a where (a.noa between @t_bpno and @t_epno) and (a.typea='1') 
and noa not in (select pno from @tmpa) 

--更新金額
update @tmp
set rcprice=case when rcmount=0 then 0 else round(rcmoney/rcmount,2) end

update @tmp
set lmount=rcmount,lweight=rcweight,lmoney=rcmoney,lprice=rcprice

--插入進貨
--rc2
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,rcmount,rcweight,rcprice,rcmoney)
select '1'gno,u.noa,u.product,u.unit,left(ra.datea,6),ra.datea,2,'進貨 '+ra.noa,rb.mount,rb.weight,rb.price,rb.total
from view_rc2 ra left join view_rc2s rb on ra.noa=rb.noa left join ucc u on rb.productno=u.noa
where (u.typea='1' ) --商品
and (u.noa between @t_bpno and @t_epno) 
and (ra.datea between @t_bdate and @t_edate)
and ra.typea='1' and rb.mount!=0

insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,rcmount,rcweight,rcprice,rcmoney)
select '1'gno,u.noa,u.product,u.unit,left(ra.datea,6),ra.datea,3,'進貨退出 '+ra.noa,-1*rb.mount,-1*rb.weight,rb.price,-1*rb.total
from view_rc2 ra left join view_rc2s rb on ra.noa=rb.noa left join ucc u on rb.productno=u.noa
where (u.typea='1' ) --商品
and (u.noa between @t_bpno and @t_epno) 
and (ra.datea between @t_bdate and @t_edate)
and ra.typea!='1' and rb.mount!=0 --and rb.weight!=0

insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,rcmount,rcweight,rcprice,rcmoney)
select '1'gno,u.noa,u.product,u.unit,left(ra.datea,6),ra.datea,3,'進貨折讓 '+ra.noa,rb.mount,rb.weight,rb.price,-1*rb.total
from view_rc2 ra left join view_rc2s rb on ra.noa=rb.noa left join ucc u on rb.productno=u.noa
where (u.typea='1' ) --商品
and (u.noa between @t_bpno and @t_epno) 
and (ra.datea between @t_bdate and @t_edate)
and ra.typea!='1' and rb.mount=0 --and rb.weight=0

----插入銷售
--vcc
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,vcmount,vcweight,vcmoney,vcprice)
select '1'gno,u.noa,u.product,u.unit,left(va.datea,6),va.datea,3,'銷售 '+va.noa,vb.mount,vb.weight,vb.total,vb.price
from view_vcc va left join view_vccs vb on va.noa=vb.noa left join 
ucc u on vb.productno=u.noa
where (u.typea='1') --商品
and (u.noa between @t_bpno and @t_epno) 
and (va.datea between @t_bdate and @t_edate)
and va.typea='1' and vb.mount!=0 --and vb.weight!=0

insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,vcmount,vcweight,vcmoney,vcprice)
select '1'gno,u.noa,u.product,u.unit,left(va.datea,6),va.datea,4,'退回 '+va.noa,-1*vb.mount,-1*vb.weight,-1*vb.total,vb.price
from view_vcc va left join view_vccs vb on va.noa=vb.noa left join 
ucc u on vb.productno=u.noa
where (u.typea='1') --商品
and (u.noa between @t_bpno and @t_epno) 
and (va.datea between @t_bdate and @t_edate)
and va.typea!='1' and vb.mount!=0 --and vb.weight!=0

insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,vcmount,vcweight,vcmoney,vcprice)
select '1'gno,u.noa,u.product,u.unit,left(va.datea,6),va.datea,5,'折讓 '+va.noa,-1*vb.mount,-1*vb.weight,-1*vb.total,vb.price
from view_vcc va left join view_vccs vb on va.noa=vb.noa left join 
ucc u on vb.productno=u.noa
where (u.typea='1') --商品
and (u.noa between @t_bpno and @t_epno) 
and (va.datea between @t_bdate and @t_edate)
and va.typea!='1' and vb.mount=0 --and vb.weight=0

--插入月份合計
insert into @tmp
select '2',pno,product,unit,mon,'','','本月合計'
,SUM(rcmount),SUM(rcweight),null,SUM(rcmoney) 
,SUM(vcmount),SUM(vcweight),SUM(vccost),SUM(vcmoney),null,null,null,null,null
from @tmp where gno='1' group by pno,product,unit,mon

--插入產品合計
insert into @tmp 
select '3',pno,product,unit,'999/99','','','合計' 
,SUM(rcmount),SUM(rcweight),null,SUM(rcmoney) 
,SUM(vcmount),SUM(vcweight),SUM(vccost),SUM(vcmoney),null,null,null,null,null 
from @tmp where gno='2' group by pno,product,unit 

insert into @tmp 
select '3',pno,product,unit,'999/99','','','合計' 
,SUM(rcmount),SUM(rcweight),null,SUM(rcmoney) 
,SUM(vcmount),SUM(vcweight),SUM(vccost),SUM(vcmoney),null,null,null,null,null 
from @tmp where gno='0'
and pno+product+unit not in (select pno+product+unit from @tmp where gno='3')
group by pno,product,unit 

declare @gno nvarchar(1),@product nvarchar(50),@unit nvarchar(10),
	@mon nvarchar(10),@datea nvarchar(10),@item nvarchar(10),@memo nvarchar(max),
	@bmount float,@bweight float,@bprice float,@bmoney float,
	@vcmount float,@vcweight float,@vccost float,@vcmoney float,@vcprice float,
	@lmount float,@lweight float,@lprice float,@lmoney float
	
declare @t_price float,@t_mount float,@t_weight float,@t_money float

declare cursor_table cursor for 
select * from @tmp order by pno,mon,gno,datea,item
open cursor_table 
fetch next from cursor_table 
into @gno,@pno,@product,@unit,@mon,@datea,@item,@memo,@bmount,@bweight,@bprice,@bmoney,
@vcmount,@vcweight,@vccost,@vcmoney,@vcprice,@lmount,@lweight,@lprice,@lmoney
while(@@FETCH_STATUS <> -1) 
begin 
	if(@gno=0)
	begin
		set @t_price=@lprice
		set @t_mount=@lmount
		set @t_weight=@lweight
		set @t_money=@lmoney
	end
	else
	begin
		if(charindex('進貨',@memo)>0 )
		begin
			set @t_mount=@t_mount+@bmount
			set @t_weight=@t_weight+@bweight
			set @t_money=case when @t_mount<=0 then 0 else @t_money+@bmoney end
			set @t_price=case when @t_money=0 then 0 else @t_money/@t_mount  end
			
			update @tmp
			set lmount=@t_mount,lweight=@t_weight,lmoney=@t_money,lprice=@t_price
			where datea=@datea and pno=@pno and memo=@memo and mon=@mon
		end
		
		if(charindex('銷售',@memo)>0 or charindex('退回',@memo)>0 or charindex('折讓',@memo)>0)
		begin
			set @t_mount=@t_mount-@vcmount
			set @t_weight=@t_weight-@vcweight
			set @vccost=@t_price*@vcmount
			set @t_money=case when @t_mount<=0 then 0 else @t_money-@vccost end
			set @t_price=case when @t_money=0 then 0 else @t_money/@t_mount end
			
			update @tmp
			set lmount=@t_mount,lweight=@t_weight,lmoney=@t_money,lprice=@t_price,vccost=@vccost
			where datea=@datea and pno=@pno and memo=@memo and mon=@mon
		end
	
		if(@gno='3' or @gno='2')
		begin
			update @tmp
			set lmount=@t_mount,lweight=@t_weight,lmoney=@t_money,lprice=@t_price,vccost=@vccost
			where datea=@datea and pno=@pno and memo=@memo and mon=@mon
		end
	end
	
	fetch next from cursor_table 
	into @gno,@pno,@product,@unit,@mon,@datea,@item,@memo,@bmount,@bweight,@bprice,@bmoney,
	@vcmount,@vcweight,@vccost,@vcmoney,@vcprice,@lmount,@lweight,@lprice,@lmoney
end 
close cursor_table 
deallocate cursor_table 

select gno,pno,product,unit,mon,datea,item,memo

,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcmount,2)),1)),0,30)) rcmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcweight,2)),1)),0,30)) rcweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcprice,2)),1)),0,30)) rcprice
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcmoney,2)),1)),0,30)) rcmoney

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(vcmount,0)),1)),4,12)) vcmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcweight,2)),1)),0,30)) vcweight
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(vccost,0)),1)),4,12)) vccost
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(vcmoney,0)),1)),4,12)) vcmoney
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcprice,2)),1)),0,30)) vcprice

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(lmount,0)),1)),4,12)) lmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lweight,2)),1)),0,30)) lweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lprice,2)),1)),0,30)) lprice
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(lmoney,0)),1)),4,12)) lmoney

from @tmp order by pno,mon,gno,datea,item;

--*****************************************************************************************	
	z_gen9:--z_gen9
	declare @t_bpno nvarchar(20)
	declare @t_epno nvarchar(20)
	declare @t_xall nvarchar(10)
	declare @t_xdate nvarchar(10)

	set @t_bpno = case when '#non'=[4] then '' else [4] end
	set @t_epno = case when '#non'=[5] then char(255) else [5] end
	set @t_xall = case when '#non'=[12] then char(255) else [12] end
	set @t_xdate = case when '#non'=[14] then '' else [14] end
	
--期初
declare @tmpa table( 
	tablea nvarchar(50),
	datea nvarchar(10),
	pno nvarchar(50),
	storeno nvarchar(50),
	mount float, 
	weight float,
	money float
) 


--期初抓ucce
insert @tmpa--插入期初最後盤點(以查詢日的最後一次盤存)
select DISTINCT  'ucce',a.datea,b.productno,b.storeno,b.mount,b.eweight,b.total 
from view_ucce a left join view_ucces b on a.noa=b.noa 
left join view_ucaucc c on b.productno=c.noa
where a.datea<=@t_xdate and a.datea+'_'+b.productno+'_'+b.storeno in(
select MAX(a.datea)+'_'+b.productno+'_'+b.storeno
from view_ucce a left join view_ucces b on a.noa=b.noa where a.datea<=@t_xdate
group by b.productno,b.storeno) and b.productno between @t_bpno and @t_epno

--有盤點-插入盤點之後且資料起始日之前的資料
--進料
insert @tmpa
select 'rc2',ra.datea,rb.productno,rb.storeno
,(case when ra.typea='1' then 1 else -1 end)*rb.mount
,(case when ra.typea='1' then 1 else -1 end)*rb.weight
,(case when ra.typea='1' then 1 else -1 end)*rb.total/(case when ra.taxtype='3' then 1.05 else 1 end) 
from view_rc2 ra left join view_rc2s rb on ra.noa=rb.noa 
left join view_ucaucc c on rb.productno=c.noa where
rb.storeno+'_'+rb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ra.datea<=@t_xdate and ra.datea>=(select datea from @tmpa where pno=rb.productno and storeno=rb.storeno and tablea='ucce')
and rb.productno!='' and rb.productno between @t_bpno and @t_epno

--銷售
insert @tmpa
select 'vcc',va.datea,vb.productno,vb.storeno
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount
,-1*(case when va.typea='1' then 1 else -1 end)*vb.weight
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount*
isnull((select price from view_costs where productno=vb.productno and mon=left(va.datea,6)),0) 
from view_vcc va left join view_vccs vb on va.noa=vb.noa 
left join view_ucaucc c on vb.productno=c.noa where
vb.storeno+'_'+vb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and va.datea<=@t_xdate and va.datea>=(select datea from @tmpa where pno=vb.productno and storeno=vb.storeno and tablea='ucce')
and vb.productno!='' and vb.productno between @t_bpno and @t_epno

--調整
insert @tmpa
select 'ina',ia.datea,ib.productno,ia.storeno,ib.mount,ib.weight,ib.total
from view_ina ia left join view_inas ib on ia.noa=ib.noa 
left join view_ucaucc c on ib.productno=c.noa where
ia.storeno+'_'+ib.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ia.datea<=@t_xdate and ia.datea>=(select datea from @tmpa where pno=ib.productno and storeno=ia.storeno and tablea='ucce')
and ib.productno!='' and ib.productno between @t_bpno and @t_epno

insert @tmpa
select 'get',ga.datea,gb.productno,ga.storeno,-1*gb.mount,-1*gb.weight,-1*gb.mount
*isnull((select price from view_costs where productno=gb.productno and mon=left(ga.datea,6)),0) 
from view_get ga left join view_gets gb on ga.noa=gb.noa 
left join view_ucaucc c on gb.productno=c.noa where
ga.storeno+'_'+gb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ga.datea<=@t_xdate and ga.datea>=(select datea from @tmpa where pno=gb.productno and storeno=ga.storeno and tablea='ucce')
and gb.productno!='' and gb.productno between @t_bpno and @t_epno

--領料
insert @tmpa
select 'worka',wa.datea,wb.productno,wb.storeno,(case when wa.typea='1' then -1 else 1 end)*wb.mount,(case when wa.typea='1' then -1 else 1 end)*wb.weight,(case when wa.typea='1' then -1 else 1 end)*wb.mount
*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0) 
from view_worka wa left join view_workas wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa where
wb.storeno+'_'+wb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and wa.datea<=@t_xdate and wa.datea>=(select datea from @tmpa where pno=wb.productno and storeno=wb.storeno and tablea='ucce')
and wb.productno!='' and wb.productno between @t_bpno and @t_epno

insert @tmpa
select 'workc',wa.datea,wb.productno,wb.storeno,(case when wa.typea='1' then -1 else 1 end)*wb.mount,(case when wa.typea='1' then -1 else 1 end)*wb.weight,(case when wa.typea='1' then -1 else 1 end)*wb.mount
*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0) 
from view_workc wa left join view_workcs wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa where
wb.storeno+'_'+wb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and wa.datea<=@t_xdate and wa.datea>=(select datea from @tmpa where pno=wb.productno and storeno=wb.storeno and tablea='ucce')
and wb.productno!='' and wb.productno between @t_bpno and @t_epno

insert @tmpa
select 'cut',ca.datea,ca.productno,ca.storeno,-1*ca.mount,-1*ca.gweight,-1*ca.mount
*isnull((select price from view_costs where productno=ca.productno and mon=left(ca.datea,6)),0) 
from view_cut ca left join view_ucaucc c on ca.productno=c.noa where
ca.storeno+'_'+ca.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ca.datea<=@t_xdate and ca.datea>=(select datea from @tmpa where pno=ca.productno and storeno=ca.storeno and tablea='ucce')
and ca.productno!='' and ca.productno between @t_bpno and @t_epno

insert @tmpa
select 'cubt',ca.datea,cb.productno,cb.storeno,-1*cb.mount,-1*cb.weight,-1*cb.mount
*isnull((select price from view_costs where productno=cb.productno and mon=left(ca.datea,6)),0) 
from view_cub ca left join view_cubt cb on ca.noa=cb.noa 
left join view_ucaucc c on cb.productno=c.noa where
cb.storeno+'_'+cb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ca.datea<=@t_xdate and ca.datea>=(select datea from @tmpa where pno=cb.productno and storeno=cb.storeno and tablea='ucce')
and cb.productno!=''  and cb.productno between @t_bpno and @t_epno

--生產
insert @tmpa
select 'workb',wa.datea,wb.productno,wb.storeno,wb.mount,wb.weight
,isnull((select (costa+costb+costc+costd) from view_wcost where noa=wb.noa and productno=wb.productno and workno=wb.workno),0) 
from view_workb wa left join view_workbs wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa where
wb.storeno+'_'+wb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and wa.datea<=@t_xdate and wa.datea>=(select datea from @tmpa where pno=wb.productno and storeno=wb.storeno and tablea='ucce')
and wb.productno!='' and wb.productno between @t_bpno and @t_epno

insert @tmpa
select 'workd',wa.datea,wb.productno,wb.storeno,wb.mount,wb.weight
,isnull((select (costa+costb+costc+costd) from view_wcost where noa=wb.noa and productno=wb.productno and workno=wb.workno),0)  
from view_workd wa left join view_workds wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa where
wb.storeno+'_'+wb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and wa.datea<=@t_xdate and wa.datea>=(select datea from @tmpa where pno=wb.productno and storeno=wb.storeno and tablea='ucce')
and wb.productno!='' and wb.productno between @t_bpno and @t_epno

insert @tmpa
select 'cuts',ca.datea,cb.productno,cb.storeno,cb.mount,cb.weight,cb.mount
*isnull((select price from view_costs where productno=cb.productno and mon=left(ca.datea,6)),0) 
from view_cut ca left join view_cuts cb on ca.noa=cb.noa left join view_ucaucc c on cb.productno=c.noa where
ca.storeno+'_'+cb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ca.datea<=@t_xdate and ca.datea>=(select datea from @tmpa where pno=cb.productno and storeno=ca.storeno and tablea='ucce')
and cb.productno!='' and cb.productno between @t_bpno and @t_epno

insert @tmpa
select 'cubu',ca.datea,cb.productno,cb.storeno,cb.mount,cb.weight,cb.mount
*isnull((select price from view_costs where productno=cb.productno and mon=left(ca.datea,6)),0) 
from view_cub ca left join view_cubu cb on ca.noa=cb.noa left join view_ucaucc c on cb.productno=c.noa where
cb.storeno+'_'+cb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ca.datea<=@t_xdate and ca.datea>=(select datea from @tmpa where pno=cb.productno and storeno=cb.storeno and tablea='ucce')
and cb.productno!='' and cb.productno between @t_bpno and @t_epno


--報廢
insert @tmpa
select 'workb',wa.datea,wb.productno,wb.storeno,-1*wb.wmount,0
,-1*wb.wmount*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0)  
from view_workb wa left join view_workbs wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa where
wb.storeno+'_'+wb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and wa.datea<=@t_xdate and wa.datea>=(select datea from @tmpa where pno=wb.productno and storeno=wb.storeno and tablea='ucce')
and wb.productno!='' and wb.productno between @t_bpno and @t_epno

insert @tmpa
select 'workd',wa.datea,wb.productno,wb.storeno,-1*wb.wmount,0
,-1*wb.wmount*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0)   
from view_workd wa left join view_workds wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa where
wb.storeno+'_'+wb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and wa.datea<=@t_xdate and wa.datea>=(select datea from @tmpa where pno=wb.productno and storeno=wb.storeno and tablea='ucce')
and wb.productno!='' and wb.productno between @t_bpno and @t_epno

--無盤點-插入資料起始日之前的資料
--進料
insert @tmpa
select 'rc2',ra.datea,rb.productno,rb.storeno
,(case when ra.typea='1' then 1 else -1 end)*rb.mount
,(case when ra.typea='1' then 1 else -1 end)*rb.weight
,(case when ra.typea='1' then 1 else -1 end)*rb.total/(case when ra.taxtype='3' then 1.05 else 1 end) 
from view_rc2 ra left join view_rc2s rb on ra.noa=rb.noa 
left join view_ucaucc c on rb.productno=c.noa where
rb.storeno+'_'+rb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ra.datea<=@t_xdate and rb.productno!='' and rb.productno between @t_bpno and @t_epno

--銷售
insert @tmpa
select 'vcc',va.datea,vb.productno,vb.storeno
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount
,-1*(case when va.typea='1' then 1 else -1 end)*vb.weight
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount*
isnull((select price from view_costs where productno=vb.productno and mon=left(va.datea,6)),0) 
from view_vcc va left join view_vccs vb on va.noa=vb.noa 
left join view_ucaucc c on vb.productno=c.noa where
vb.storeno+'_'+vb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and va.datea<=@t_xdate and vb.productno!='' and vb.productno between @t_bpno and @t_epno

--調整
insert @tmpa
select 'ina',ia.datea,ib.productno,ia.storeno,ib.mount,ib.weight,ib.total
from view_ina ia left join view_inas ib on ia.noa=ib.noa 
left join view_ucaucc c on ib.productno=c.noa where
ia.storeno+'_'+ib.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ia.datea<=@t_xdate and ib.productno!='' and ib.productno between @t_bpno and @t_epno

insert @tmpa
select 'get',ga.datea,gb.productno,ga.storeno,-1*gb.mount,-1*gb.weight,-1*gb.mount
*isnull((select price from view_costs where productno=gb.productno and mon=left(ga.datea,6)),0) 
from view_get ga left join view_gets gb on ga.noa=gb.noa 
left join view_ucaucc c on gb.productno=c.noa where
ga.storeno+'_'+gb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ga.datea<=@t_xdate and gb.productno!='' and gb.productno between @t_bpno and @t_epno

--領料
insert @tmpa
select 'worka',wa.datea,wb.productno,wb.storeno,(case when wa.typea='1' then -1 else 1 end)*wb.mount,(case when wa.typea='1' then -1 else 1 end)*wb.weight,(case when wa.typea='1' then -1 else 1 end)*wb.mount
*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0) 
from view_worka wa left join view_workas wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa where
wb.storeno+'_'+wb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and wa.datea<=@t_xdate and wb.productno!='' and wb.productno between @t_bpno and @t_epno

insert @tmpa
select 'workc',wa.datea,wb.productno,wb.storeno,(case when wa.typea='1' then -1 else 1 end)*wb.mount,(case when wa.typea='1' then -1 else 1 end)*wb.weight,(case when wa.typea='1' then -1 else 1 end)*wb.mount
*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0) 
from view_workc wa left join view_workcs wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa where
wb.storeno+'_'+wb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and wa.datea<=@t_xdate and wb.productno!='' and wb.productno between @t_bpno and @t_epno

insert @tmpa
select 'cut',ca.datea,ca.productno,ca.storeno,-1*ca.mount,-1*ca.gweight,-1*ca.mount
*isnull((select price from view_costs where productno=ca.productno and mon=left(ca.datea,6)),0) 
from view_cut ca left join view_ucaucc c on ca.productno=c.noa where
ca.storeno+'_'+ca.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ca.datea<=@t_xdate and ca.productno!='' and ca.productno between @t_bpno and @t_epno

insert @tmpa
select 'cubt',ca.datea,cb.productno,cb.storeno,-1*cb.mount,-1*cb.weight,-1*cb.mount
*isnull((select price from view_costs where productno=cb.productno and mon=left(ca.datea,6)),0) 
from view_cub ca left join view_cubt cb on ca.noa=cb.noa 
left join view_ucaucc c on cb.productno=c.noa where
cb.storeno+'_'+cb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ca.datea<=@t_xdate and cb.productno!='' and cb.productno between @t_bpno and @t_epno

--生產
insert @tmpa
select 'workb',wa.datea,wb.productno,wb.storeno,wb.mount,wb.weight
,isnull((select (costa+costb+costc+costd) from view_wcost where noa=wb.noa and productno=wb.productno and workno=wb.workno),0) 
from view_workb wa left join view_workbs wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa where
wb.storeno+'_'+wb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and wa.datea<=@t_xdate and wb.productno!='' and wb.productno between @t_bpno and @t_epno

insert @tmpa
select 'workd',wa.datea,wb.productno,wb.storeno,wb.mount,wb.weight
,isnull((select (costa+costb+costc+costd) from view_wcost where noa=wb.noa and productno=wb.productno and workno=wb.workno),0) 
from view_workd wa left join view_workds wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa where
wb.storeno+'_'+wb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and wa.datea<=@t_xdate and wb.productno!='' and wb.productno between @t_bpno and @t_epno

insert @tmpa
select 'cuts',ca.datea,cb.productno,cb.storeno,cb.mount,cb.weight,cb.mount
*isnull((select price from view_costs where productno=cb.productno and mon=left(ca.datea,6)),0) 
from view_cut ca left join view_cuts cb on ca.noa=cb.noa left join view_ucaucc c on cb.productno=c.noa where
cb.storeno+'_'+cb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ca.datea<=@t_xdate and cb.productno!='' and cb.productno between @t_bpno and @t_epno

insert @tmpa
select 'cubu',ca.datea,cb.productno,cb.storeno,cb.mount,cb.weight,cb.mount
*isnull((select price from view_costs where productno=cb.productno and mon=left(ca.datea,6)),0) 
from view_cub ca left join view_cubu cb on ca.noa=cb.noa 
left join view_ucaucc c on cb.productno=c.noa where
cb.storeno+'_'+cb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and ca.datea<=@t_xdate and cb.productno!='' and cb.productno between @t_bpno and @t_epno

--報廢
insert @tmpa
select 'workb',wa.datea,wb.productno,wb.storeno,-1*wb.wmount,0
,-1*wb.wmount*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0)  
from view_workb wa left join view_workbs wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa where
wb.storeno+'_'+wb.productno not in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and wa.datea<=@t_xdate and wa.datea>=(select datea from @tmpa where pno=wb.productno and storeno=wb.storeno and tablea='ucce')
and wb.productno!='' and wb.productno between @t_bpno and @t_epno

insert @tmpa
select 'workd',wa.datea,wb.productno,wb.storeno,-1*wb.wmount,0
,-1*wb.wmount*isnull((select price from view_costs where productno=wb.productno and mon=left(wa.datea,6)),0)   
from view_workd wa left join view_workds wb on wa.noa=wb.noa 
left join view_ucaucc c on wb.productno=c.noa where
wa.storeno+'_'+wb.productno in(select storeno+'_'+pno from @tmpa where tablea='ucce')
and wa.datea<=@t_xdate and wa.datea>=(select datea from @tmpa where pno=wb.productno and storeno=wb.storeno and tablea='ucce')
and wb.productno!='' and wb.productno between @t_bpno and @t_epno

---------------------------------------------------
declare @pno nvarchar(90)
declare @MAXMON nvarchar(50)
declare @MINMON nvarchar(50)
declare cursor_table cursor for
--檢查每個月數量為0 則清空金額
select pno,MAX(LEFT(datea,6)),MIN(LEFT(datea,6)) from @tmpa group by pno
open cursor_table
fetch next from cursor_table
into @pno,@MAXMON,@MINMON
while(@@FETCH_STATUS <> -1)
begin
	while (@MINMON<=@MAXMON)
	begin
		if(select sum(mount) mount
		from @tmpa where pno=@pno and left(datea,6)<=@MINMON)<=0
		begin
			update @tmpa
			set money=0
			where pno=@pno and left(datea,6)<=@MINMON
		end
		
		set @MINMON=cast(cast(LEFT(@MINMON,3)as int)+1911 as nvarchar(20))+'/'+right(@MINMON,2)+'/01'
		set @MINMON=CONVERT (VARCHAR(7),DATEADD(m,+1,@MINMON),12 )+0890000
		set @MINMON=left(@MINMON,3)+'/'+substring(@MINMON,4,2)
		
	end
	
	fetch next from cursor_table
	into @pno,@MAXMON,@MINMON
end
close cursor_table
deallocate cursor_table

declare @tmp table( 
	gno nvarchar(1), 
	typea nvarchar(50), 
	pno nvarchar(50), 
	product nvarchar(50), 
	unit nvarchar(10), 
	mount float, 
	weight float, 
	price float, 
	money float 
) 

if(@t_xall='全部' or @t_xall='原物料')
begin
	insert @tmp select '0','原物料'
	,a.pno,b.product,b.unit,sum(a.mount),sum(a.weight),0,sum(a.money)
	from @tmpa a left join view_ucaucc b on a.pno=b.noa
	where b.typea='4' or b.typea='5'
	group by a.pno,b.product,b.unit
end
if(@t_xall='全部' or @t_xall='製成品')
begin
	insert @tmp select '0','製成品'
	,a.pno ,b.product,b.unit,sum(a.mount),sum(a.weight),0,sum(a.money)
	from @tmpa a left join view_ucaucc b on a.pno=b.noa
	where b.typea='2' or b.typea='6' 
	group by a.pno,b.product,b.unit
end
if(@t_xall='全部' or @t_xall='商品')
begin
	insert @tmp select '0','商品'
	,a.pno ,b.product,b.unit,sum(a.mount),sum(a.weight),0,sum(a.money)
	from @tmpa a left join view_ucaucc b on a.pno=b.noa
	where b.typea='1'
	group by a.pno,b.product,b.unit
end

--更新單價
update @tmp set price=case when mount=0 then 0 else round(money/mount,2) end

select gno,typea,pno,product,unit 
,case when @t_xall='全部' then '' else '('+@t_xall+')' end xtall 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(mount,2)),1)),0,30)) mount 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(weight,2)),1)),0,30)) weight 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(price,2)),1)),0,30)) price 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(money,2)),1)),0,30)) money 
from @tmp order by pno ;
-------------------------------------------------------------------------------------------------------------------------------
z_gena:--z_gena
	declare @t_bpno nvarchar(20)
	declare @t_epno nvarchar(20)
	declare @t_bmon nvarchar(10)
	declare @t_emon nvarchar(10)

	set @t_bpno = case when '#non'=[4] then '' else [4] end
	set @t_epno = case when '#non'=[5] then char(255) else [5] end
	set @t_bmon = case when '#non'=[15] then '' else [15] end
	set @t_emon = case when '#non'=[16] then char(255) else [16] end
	
	declare @tmp table( 
		gno nvarchar(1),
		mon nvarchar(10),
		pno nvarchar(50),
		product nvarchar(150),
		unit nvarchar(10),
		mount float, 
		amoney float,
		aprice float,
		bmoney float,
		bprice float,
		cmoney float,
		cprice float,
		price float, 
		total float
	) 
	
	insert into @tmp (gno,mon,pno,mount,amoney,bmoney,cmoney)
	select '9',mon,(select productno from view_work where noa=a.workno)
	,(select mount from view_work where noa=a.workno)
	,SUM(costa),SUM(costb),SUM(costc) 
	from view_wcost a 
	where a.mon between @t_bmon  and @t_emon  group by workno,mon
	
	insert into @tmp (gno,mon,pno,mount,amoney,bmoney,cmoney)
	select '0',mon,pno,sum(mount),SUM(amoney),SUM(bmoney),SUM(cmoney) 
	 from @tmp where pno between @t_bpno and @t_epno group by mon,pno

	delete @tmp where gno='9'

	update a 
	set product=(select top 1 product from view_ucaucc where noa=a.pno) 
	,unit=(select top 1 unit from view_ucaucc where noa=a.pno) 
	,aprice=round(amoney/mount,2) 
	,bprice=round(bmoney/mount,2) 
	,cprice=round(cmoney/mount,2) 
	,total=amoney+bmoney+cmoney 
	,price=round((amoney+bmoney+cmoney)/mount,2) 
	from @tmp a 
	
	insert into @tmp (gno,mon)
	select '1',mon from @tmp group by mon
	
	select gno,mon,pno,product,unit
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),0,30)) mount
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,amoney),1)),0,30)) amoney
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,aprice),1)),0,30)) aprice
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,bmoney),1)),0,30)) bmoney
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,bprice),1)),0,30)) bprice
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,cmoney),1)),0,30)) cmoney
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,cprice),1)),0,30)) cprice
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),0,30)) total
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,price),1)),0,30)) price
	from @tmp order by mon,gno,pno

;
------------------------------------------------------------------------------------------------------------------------------------
z_gene:--z_gene
	declare @t_bpno nvarchar(20)
	declare @t_epno nvarchar(20)
	declare @t_bmon nvarchar(10)
	declare @t_emon nvarchar(10)

	set @t_bpno = case when '#non'=[4] then '' else [4] end
	set @t_epno = case when '#non'=[5] then char(255) else [5] end
	set @t_bmon = case when '#non'=[15] then '' else [15] end
	set @t_emon = case when '#non'=[16] then char(255) else [16] end
	
	declare @tmp table( 
		gno nvarchar(1),
		mon nvarchar(10),
		pno nvarchar(50),
		product nvarchar(150),
		unit nvarchar(10),
		mount float, 
		spno nvarchar(50),
		sproduct nvarchar(150),
		amount float,
		amoney float
	) 
	
	insert into @tmp (gno,mon,pno,mount,spno,amount,amoney)
	select '9',mon,(select productno from view_work where noa=a.workno)
	,(select mount from view_work where noa=a.workno)
	,productno,mount,costa 
	from view_wcost a 
	where a.mon between @t_bmon  and @t_emon 
	
	insert into @tmp (gno,mon,pno,spno,mount,amount,amoney)
	select '0',mon,pno,spno,sum(mount),SUM(amount),SUM(amoney)
	 from @tmp where pno between @t_bpno and @t_epno 
	 group by mon,pno,spno

	delete @tmp where gno='9'

	update a 
	set product=(select top 1 product from view_ucaucc where noa=a.pno) 
	,unit=(select top 1 unit from view_ucaucc where noa=a.pno) 
	,sproduct=(select top 1 product from view_ucaucc where noa=a.spno) 
	from @tmp a 
	
	insert into @tmp (gno,mon)
	select '1',mon from @tmp group by mon
	
	select gno,mon,pno,product,unit,spno,sproduct
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),0,30)) mount
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,amount),1)),0,30)) amount
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,amoney),1)),0,30)) amoney
	from @tmp order by mon,gno,pno,spno
;
--**************************************************************************************************
z_gen10:--z_gen10 ref. z_uca1

declare @bpno nvarchar(30)
declare @epno nvarchar(30)
declare @enddate nvarchar(30)
declare @bordeno nvarchar(30)
declare @eordeno nvarchar(30)
declare @outtype nvarchar(30)

set @bpno = case when '#non'=[4] then '' else [4] end
set @epno = case when '#non'=[5] then char(255) else [5] end

set @enddate=case when '#non'=[14] then '' else [14] end

set @bordeno = case when '#non'=[6] then '' else [6] end
set @eordeno = case when '#non'=[7] then char(255) else [7] end

set @outtype=case when '#non'=[17] then '' else [17] end

--儲存在製品的製令單//避免一個製令被領料或入庫兩次以上
declare @work table(
	workno nvarchar(30)
)

declare @end table(
	recno int identity(0,1),
	gno nvarchar(50),
	custno nvarchar(50),
	compnick nvarchar(50),
	ordeno nvarchar(50),
	no2 nvarchar(50),
	gnoworkno nvarchar(50),
	workno nvarchar(50),
	cuano nvarchar(50),
	productno nvarchar(50),
	product nvarchar(50),
	mount float,
	inmount float,
	productno2 nvarchar(50),
	product2 nvarchar(50),
	mount2 float,
	outmount float,
	acost float,
	bcost float,
	ccost float,
	dcost float,
	cost float
)


--插入在截止日之前有領料的製令單
if(@outtype='all')
	insert into @work
	select DISTINCT a.noa from view_work a left join view_workas b on a.noa=b.workno left join view_workcs c on a.noa=c.workno
	where ((b.datea<=@enddate and c.datea is null) or (c.datea<=@enddate and b.datea is null)) and (a.ordeno between @bordeno and @eordeno)
	and (b.mount>0 or c.mount>0)

if(@outtype='out')
	insert into @work
	select DISTINCT a.noa from view_work a left join view_workas b on a.noa=b.workno left join view_workcs c on a.noa=c.workno
	where ((b.datea<=@enddate and c.datea is null) or (c.datea<=@enddate and b.datea is null)) and (a.ordeno between @bordeno and @eordeno)
	and (b.mount>0 or c.mount>0)
	and a.tggno!=''

if(@outtype='notout')
	insert into @work
	select DISTINCT a.noa from view_work a left join view_workas b on a.noa=b.workno left join view_workcs c on a.noa=c.workno
	where ((b.datea<=@enddate and c.datea is null) or (c.datea<=@enddate and b.datea is null)) and (a.ordeno between @bordeno and @eordeno)
	and (b.mount>0 or c.mount>0)
	and (a.tggno='' or a.tggno is null)

--刪除在截止日之前已"全部"入庫的製令單
delete @work
where workno in(
	select a.workno from @work a left join view_work b on a.workno=b.noa
	left join(
	--workb
	select b.workno,b.productno,b.product,SUM(b.mount) mount 
	from view_workb a left join view_workbs b on a.noa=b.noa 
	where b.datea <=@enddate
	group by b.workno,b.productno,b.product
	union
	--workd
	select b.workno,b.productno,b.product,SUM(b.mount+b.inmount-b.outmount) mount 
	from view_workd a left join view_workds b on a.noa=b.noa 
	where b.datea <=@enddate
	group by b.workno,b.productno,b.product
)c on b.noa=c.workno
where b.mount=c.mount)


insert into @end
select '0'gno,oe.custno,ct.nick,wb.ordeno,wb.no2,wa.workno,wa.workno,ca.noa,wb.productno,wb.product product,wb.mount mount,
(case when len(wb.tggno)=0  then 
isnull((select SUM(b.mount) mount 
from view_workb a left join view_workbs b on a.noa=b.noa 
where b.datea <=@enddate and b.workno=wa.workno and b.productno=wb.productno
group by b.workno,b.productno),0)
else
isnull((select SUM(b.mount+b.inmount-b.outmount) mount 
from view_workd a left join view_workds b on a.noa=b.noa 
where b.datea <=@enddate and b.workno=wa.workno and b.productno=wb.productno
group by b.workno,b.productno),0)
end) inmount,
wc.productno productno2,wc.product product2,wc.mount mount2,
(case when len(wb.tggno)=0  then 
isnull((select SUM(b.mount) mount 
from view_worka a left join view_workas b on a.noa=b.noa 
where b.datea <=@enddate and b.workno=wa.workno and b.productno=wc.productno
group by b.workno,b.productno),0)
else
isnull((select SUM(b.mount) mount 
from view_workc a left join view_workcs b on a.noa=b.noa 
where b.datea <=@enddate and b.workno=wa.workno and b.productno=wc.productno
group by b.workno,b.productno),0)
end) outmount,

(case when len(wb.tggno)=0  then 
isnull((select SUM(b.costa) mount 
from view_workas a LEFT join view_wcost b on a.noa=b.noa and a.workno=b.workno and a.productno=b.productno
where a.datea <=@enddate and a.workno=wa.workno and a.productno=wc.productno
group by a.workno,a.productno),0)
else
isnull((select SUM(b.costa) mount 
from view_workcs a LEFT join view_wcost b on a.noa=b.noa and a.workno=b.workno and a.productno=b.productno
where a.datea <=@enddate and a.workno=wa.workno and a.productno=wc.productno
group by a.workno,a.productno),0)
end) acost,
isnull((select SUM(b.costb) mount 
from view_workbs a LEFT join view_wcost b on a.noa=b.noa and a.workno=b.workno and a.productno=b.productno
where a.datea <=@enddate and a.workno=wa.workno and a.productno=wc.productno
group by a.workno,a.productno),0) bcost,
isnull((select SUM(b.costc) mount 
from view_workbs a LEFT join view_wcost b on a.noa=b.noa and a.workno=b.workno and a.productno=b.productno
where a.datea <=@enddate and a.workno=wa.workno and a.productno=wc.productno
group by a.workno,a.productno),0) ccost,
isnull((select SUM(b.costd) mount 
from view_workds a LEFT join view_wcost b on a.noa=b.noa and a.workno=b.workno and a.productno=b.productno
where a.datea <=@enddate and a.workno=wa.workno and a.productno=wc.productno
group by a.workno,a.productno),0) dcost,
0 cost
from @work wa left join view_work wb on wa.workno=wb.noa left join view_works wc on wb.noa=wc.noa
left join view_orde oe on wb.ordeno=oe.noa left join cust ct on oe.custno=ct.noa
left join view_workg ca on ca.noa=wb.cuano 
where wb.productno between @bpno and @epno and ca.noa!=''
order by wa.workno,wb.productno,wc.productno

--from @work wa left join view_work wb on wa.workno=wb.noa left join view_works wc on wb.noa=wc.noa
--left join view_orde oe on wb.ordeno=oe.noa left join cust ct on oe.custno=ct.noa
--where wb.productno between @bpno and @epno
--order by wa.workno,wb.productno,wc.productno

update @end
set cost=isnull(acost,0)+isnull(bcost,0)+isnull(ccost,0)+isnull(dcost,0)
--------------------------------------------------------------------

insert into @end --製令
select '1',custno,compnick,ordeno,no2,gnoworkno,'',cuano,'','',null,null,'','',null,null,SUM(acost),SUM(bcost),SUM(ccost),SUM(dcost),SUM(cost) from @end where gno='0' group by custno,compnick,ordeno,no2,gnoworkno,cuano

insert into @end --訂單
select '2',custno,compnick,ordeno,char(255),char(255),'','','','',null,null,'','',null,null,SUM(acost),SUM(bcost),SUM(ccost),SUM(dcost),SUM(cost) from @end where gno='0' group by custno,compnick,ordeno

insert into @end --客戶
select '3',custno,compnick,char(255),char(255),char(255),'','','','',null,null,'','',null,null,SUM(acost),SUM(bcost),SUM(ccost),SUM(dcost),SUM(cost) from @end where gno='0' group by custno,compnick

insert into @end --全部
select '4',char(255),char(255),'','','','','','','',null,null,'','',null,null,SUM(acost),SUM(bcost),SUM(ccost),SUM(dcost),SUM(cost) from @end where gno='0'


select recno,gno,custno,compnick,ordeno,no2,ordeno+' '+no2 orde2,gnoworkno,workno,cuano,productno productnoa,product producta
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),0,30)) mounta
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,inmount),1)),0,30)) inmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount-inmount),1)),0,30)) uninmount
,productno2 productnob,product2 productb
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount2),1)),0,30)) mountb
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,outmount),1)),0,30)) outmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount2-outmount),1)),0,30)) unoutmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,acost),1)),0,30)) acost
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,bcost),1)),0,30)) bcost
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,ccost),1)),0,30)) ccost
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,dcost),1)),0,30)) dcost 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,cost),1)),0,30)) cost
,@bpno bpno,@epno epno ,@enddate enddate
from @end order by custno,ordeno,gnoworkno,gno
;