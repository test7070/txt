z_tran_wj1:
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcarno nvarchar(10)
declare @t_ecarno nvarchar(10)
declare @t_bdriverno nvarchar(10)
declare @t_edriverno nvarchar(10)
set @t_bdate = case when '#non'=[2] then '' else [2] end
set @t_edate = case when '#non'=[3] then char(255) else [3] end
set @t_bcarno = case when '#non'=[6] then '' else [6] end
set @t_ecarno = case when '#non'=[7] then char(255) else [7] end
set @t_bdriverno = case when '#non'=[8] then '' else [8] end
set @t_edriverno = case when '#non'=[9] then char(255) else [9] end
declare @tmp table(
	gno nvarchar(10),
	noa nvarchar(200),
	roc nvarchar(10),
	mon nvarchar(10),
	day nvarchar(10),
	carno nvarchar(100),
	fcar nvarchar(100),
	driver nvarchar(100),
	driverno nvarchar(100),
	datea nvarchar(50),
	trandate nvarchar(50),
	cust nvarchar(50),
	product nvarchar(50),
	price float,
	mount float,
	mount2 float,
	weight nvarchar(50),
	straddr nvarchar(max),
	endaddr nvarchar(max),
	carplateno nvarchar(50),
	carplateno2 nvarchar(50),
	ltime nvarchar(50),
	stime nvarchar(50),
	iCar float,
	vCar float,
	miles float,
	total float,
	total2 float,
	
	oilproduct nvarchar(50),
	--b_oilmount float,
	t_oiladd float,
	t_oilcost float,
	--t_oilmount float,
	bmiles float,
	emiles float,
	rate float,
	
	--b_etcmount float,
	--t_etccost float,
	--t_etcmount float,
	etccost float,
	
	--b_carcost float,
	fixcarcost float,
	t_carcost float,
	--ml float,
	g_fixcarcost float,
	--other float,
	b_fixcarcost float,
	total3 float,
	o_fixcarcost float
	--t_carcostmount float
)

insert into @tmp (gno,roc,mon,day,
		  datea,trandate,cust,product,price,mount,weight,straddr,endaddr,carplateno,iCar,vCar,miles,total,ltime,stime,total2,
		  driverno,driver,carno,carplateno2,fcar)
select '0',''+SUBSTRING(a.datea,1,3),''+SUBSTRING(a.datea,5,2),''+SUBSTRING(a.datea,8,2),a.datea
	  ,b.trandate,b.comp,b.product,b.price,b.mount,b.weight,b.straddr,b.endaddr
	  ,b.carno,b.bmiles,b.emiles,b.miles,b.reserve,b.ltime,b.stime,b.total
	  ,a.driverno,a.driver,a.carno,a.etime,a.btime
from tran106 a
left join trans106 b on a.datea = b.datea
where (a.datea BETWEEN @t_bdate  and  @t_edate)
and a.driver !=''
and (a.carno BETWEEN @t_bcarno and @t_ecarno)
and (a.driverno BETWEEN @t_bdriverno and @t_edriverno)

insert into @tmp (gno,datea,total,total2)
select '1',datea,total3,total
from tran106
where (datea BETWEEN @t_bdate  and  @t_edate)
and driver !=''
and (carno BETWEEN @t_bcarno and @t_ecarno)
and (driverno BETWEEN @t_bdriverno and @t_edriverno)

insert into @tmp (gno,datea,oilproduct,t_oiladd,t_oilcost,bmiles,emiles,miles,rate,
				etccost,
				fixcarcost,t_carcost,g_fixcarcost,b_fixcarcost,total3,o_fixcarcost)
select '2',a.datea,b.product,b.mount,(b.miles/b.rate),b.bmiles,b.emiles,b.miles,b.rate,
			c.money,
			case when charindex(d.minusitem,'修車費')>0 then d.plusmoney - d.minusmoney end,
			case when charindex(d.minusitem,'修車費')>0 then d.plusmoney - d.minusmoney end,
			case when charindex(d.minusitem,'修車費')>0 then d.plusmoney - d.minusmoney end,
			case when charindex(d.minusitem,'修車費')>0 then d.plusmoney - d.minusmoney end,
			case when charindex(d.minusitem,'修車費')>0 then d.plusmoney - d.minusmoney end,
			case when charindex(d.minusitem,'修車費')>0 then d.plusmoney - d.minusmoney end
from tran106 a
left join oil b on (a.trandate = b.oildate) and (a.carno = b.carno)
left join etc c on (b.oildate = c.datea) and (b.carno = c.carno)
left join carchg d on (c.datea = d.datea) and (c.carno = d.carno)
where (a.datea BETWEEN @t_bdate  and  @t_edate)
and (a.carno BETWEEN @t_bcarno and @t_ecarno)
and (a.driverno BETWEEN @t_bdriverno and @t_edriverno)
and a.driver !=''

insert into @tmp (gno,datea)
select '3',datea from @tmp
group by datea

select gno,roc,mon,day,carno,fcar,driver,driverno,datea,trandate,cust,product,price,mount,weight,straddr,endaddr,carplateno,carplateno2,ltime,stime,iCar,vCAR,miles,total,total2,oilproduct,t_oiladd,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,t_oilcost),1)),0,30)) t_oilcost
,bmiles,emiles,rate,
etccost,
fixcarcost,t_carcost,g_fixcarcost,b_fixcarcost,total3,o_fixcarcost
from @tmp order by datea,gno,carno;
---------------------------------------------------------------------------------------------------------------------------------
declare @pageline int = 7 --每頁幾行 
declare @pageno_int int = 0 
declare @recCount int
declare @lastCarno nvarchar(max) = '' 

declare @Trandate nvarchar(50)
declare @cust nvarchar(100)
declare @Product nvarchar(100) 
declare @Price float
declare @Mount float
declare @Weight nvarchar(50)
declare @Straddr nvarchar(max)
declare @Endaddr nvarchar(max)
declare @Carplateno nvarchar(10)
declare @Icar float
declare @Vcar float
declare @Miles float
declare @Total float
declare @ltime nvarchar(10)
declare @stime nvarchar(10)
declare @Total2 float

declare @nextTrandate nvarchar(50)
declare @nextProduct nvarchar(100) 
declare @nextCust nvarchar(100)
declare @nextPrice float
declare @nextMount float
declare @nextWeight nvarchar(50)
declare @nextStraddr nvarchar(max)
declare @nextEndaddr nvarchar(max)
declare @nextCarplateno nvarchar(10)
declare @nextIcar float
declare @nextVcar float
declare @nextMiles float
declare @nextTotal float
declare @nextltime nvarchar(10)
declare @nextstime nvarchar(10)
declare @nextTotal2 float
--------------------------------------------------------------------------------------------------------------------------------------------
declare cursor_table cursor for 
select 
trandate,cust,product,price,mount,weight,straddr,endaddr,carplateno,iCar,vCar,miles,total,ltime,stime,total2
from @tmp order by carno
open cursor_table 
fetch next from cursor_table 
into @Trandate,@cust,@Product,@Price,@Mount,@Weight,@Straddr,@Endaddr,@Carplateno,@Icar,@vCar,@Miles,@Total,@ltime,@stime,@Total2
while(@@FETCH_STATUS <> -1) 
begin 
if(@recCount > @pageline) 
begin
set @recCount = 1 
set @pageno_int = @pageno_int+1 
end
if(@recCount = @pageline)
begin 
if((select count(*) from @tmp where (trandate=@trandate) and (cust=@cust) and (product=@product)) > 1) 
begin 
set @nextTrandate = (select top 1 Trandate from @tmp)-- where Trandate=@nextTrandate) 
set @nextProduct = (select top 1 Product from @tmp)-- where Product=@nextProduct) 
set @nextCust = (select top 1 Cust from @tmp)-- where Cust=@nextCust) 
set @nextPrice = (select top 1 Price from @tmp)-- where Price=@nextPrice) 
set @nextMount = (select top 1 Mount from @tmp)-- where Mount=@nextMount) 
set @nextWeight = (select top 1 Weight from @tmp)-- where Weight=@nextWeight) 
set @nextStraddr = (select top 1 Straddr from @tmp)-- where Straddr=@Straddr) 
set @nextEndaddr = (select top 1 Endaddr from @tmp)-- where Endaddr=@nextEndaddr) 
set @nextCarplateno = (select top 1 Carplateno from @tmp)-- where Carplateno=@nextCarplateno) 
set @nextIcar = (select top 1 Icar from @tmp)-- where Icar=@nextIcar) 
set @nextVcar = (select top 1 Vcar from @tmp)-- where Vcar=@nextVcar) 
set @nextMiles = (select top 1 Miles from @tmp)-- where Miles=@nextMiles) 
set @nextTotal = (select top 1 Total from @tmp)-- where Total=@nextTotal) 
set @nextltime = (select top 1 ltime from @tmp)-- where ltime=@nextltime) 
set @nextstime = (select top 1 stime from @tmp)-- where stime=@nextstime) 
set @nextTotal2 = (select top 1 Total2 from @tmp)-- where Total2=@nextTotal2) 

if((@Trandate=@nextTrandate) and (@Product=@nextProduct) and (@cust=@nextCust)) 
begin 
set @recCount = 1 
set @pageno_int = @pageno_int+1 
end 
end 
end

if(@recCount!=2)
set @recCount = @recCount+1 
fetch next from cursor_table 
into @Trandate,@cust,@Product,@Price,@Mount,@Weight,@Straddr,@Endaddr,@Carplateno,@Icar,@vCar,@Miles,@Total,@ltime,@stime,@Total2
end 

close cursor_table 
deallocate cursor_table 
--------------------------------------------------------------------------------------------------------------------------------------------