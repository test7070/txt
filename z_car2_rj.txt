z_car2_rj1:--z_car2_rj1 ref z_car28車籍資料列印
	declare @t_bcarno nvarchar(20)
	declare @t_ecarno nvarchar(20)
	declare @t_sssno nvarchar(20)

	set @t_bcarno = case when '#non'=[12] then '' else [12] end
	set @t_ecarno  = case when '#non'=[13] then char(255) else [13] end
	set @t_sssno  = case when '#non'=[19] then char(255) else [19] end
--************************************************************************************
declare @result table(
		gno nvarchar(1),
		noa nvarchar(20),
		carno nvarchar(20),
		carownerno nvarchar(20),
		carowner nvarchar(20),
		cardealno nvarchar(20),
		cardeal nvarchar(20),
		sex nvarchar(1),
		idno nvarchar(50),
		birthday nvarchar(10),
		tel1 nvarchar(50),
		tel2 nvarchar(50),
		fax nvarchar(50),
		mobile nvarchar(50),
		addr_conn nvarchar(MAX),
		addr_home nvarchar(MAX),
		indate nvarchar(10),
		inmoney int,
		inplace nvarchar(50),
		outdate nvarchar(10),
		outmoney int,
		outplace nvarchar(50),
		passdate nvarchar(10),
		caryear nvarchar(10),
		ton nvarchar(20),
		carbrandno nvarchar(20),
		carbrand nvarchar(50),
		caryeartw nvarchar(20),
		engineno nvarchar(20),
		passno nvarchar(20),
		weight1 float,
		weight2 float,
		carspecno nvarchar(20),
		carspec nvarchar(20),
		carmode nvarchar(20),
		memo nvarchar(MAX),
		sxdate nvarchar(10),
		wasted nvarchar(10),
		oldcarno nvarchar(10)
)
declare @cmd nvarchar(MAX)

set @cmd='select ''0'' gno,a.noa,a.carno,a.carownerno,b.namea,a.cardealno,isnull(c.nick,''''),b.sex,b.idno,b.birthday,b.tel1, 
b.tel2,b.fax,b.mobile,b.addr_conn,b.addr_home,a.indate,a.inmoney,a.inplace,a.outdate,a.outmoney,a.outplace,a.passdate,a.caryear,a.ton, 
a.carbrandno,isnull(d.brand,''''),a.caryeartw,a.engineno,/*a.passno*/ '''',a.weight1,a.weight2,a.carspecno,f.spec,a.carmode,a.memo, 
ISNULL(a.suspdate,''''),ISNULL(a.enddate,''''),ISNULL(a.oldnoa,'''') 
from car2 a 
left join carowner b on b.noa = a.carownerno 
left join cardeal c on c.noa = a.cardealno 
left join carbrand d on d.noa = a.carbrandno 
left join carspec f on a.carspecno = f.noa 
where a.carno between @t_bcarno and @t_ecarno and a.carownerno!='''' and (a.enddate='''' or a.enddate is null) and (a.outdate='''' or a.outdate is null)'

declare @ssscount int
set @ssscount=0

if(@t_sssno!=char(255))
begin
	while(PATINDEX('%,%',@t_sssno)>0)
	begin
		if (@ssscount=0)
			set @cmd=@cmd+' and (a.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		else
			set @cmd=@cmd+' or a.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		set @t_sssno=RIGHT(@t_sssno,LEN(@t_sssno)-PATINDEX('%,%',@t_sssno))
		set @ssscount=@ssscount+1
	end
	if (@ssscount=0)
		set @cmd=@cmd+' and a.sssno='''+@t_sssno+''''
	else
		set @cmd=@cmd+' or a.sssno='''+@t_sssno+''')'
end

insert into @result 
execute sp_executesql @cmd,N'@t_bcarno nvarchar(20),@t_ecarno nvarchar(20)',
		@t_bcarno=@t_bcarno,@t_ecarno=@t_ecarno

update @result
set sex=(case when sex='M' then '男' else '女' end)

select *
from @result order by noa;
--*****************************************************************************************
z_car2_rj2:--z_car2_rj1 ref z_cara2
declare @t_bcarownerno nvarchar(20)
declare @t_ecarownerno nvarchar(20)
declare @t_bcarno nvarchar(20)
declare @t_ecarno nvarchar(20)
declare @t_xcarnos nvarchar(MAX) 
declare @sql_carnos nvarchar(MAX)
declare @cmd nvarchar(max)
SET QUOTED_IDENTIFIER OFF
	
set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
set @t_ecarownerno = case when '#non'=[8] then char(255) else [8] end	
set @t_bcarno = case when '#non'=[12] then '' else [12] end
	set @t_ecarno = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_xcarnos = case when '#non'=[20] then '' else [20] end
	set @sql_carnos=''
	
if(RIGHT(@t_xcarnos,1)='.')
set @t_xcarnos=left(@t_xcarnos,len(@t_xcarnos)-1)
	
while(LEN(@t_xcarnos)>0)
begin
	if(CHARINDEX('.',@t_xcarnos)=0)
	begin
		set @sql_carnos=@sql_carnos+' a.carno='''+@t_xcarnos+''' and'
		set @t_xcarnos=''
	end
	if(CHARINDEX('.',@t_xcarnos)>0)
	begin
		set @sql_carnos=@sql_carnos+' a.carno='''+left(@t_xcarnos,CHARINDEX('.',@t_xcarnos)-1)+''' or'
		set @t_xcarnos=RIGHT(@t_xcarnos,LEN(@t_xcarnos)-CHARINDEX('.',@t_xcarnos))
	end
end

declare @tmp table(
     gno nvarchar(1),
     carownerno nvarchar(20), 
     namea nvarchar(20),
     zip nvarchar(50),
     addr nvarchar(50)
)

set @cmd ="select DISTINCT '0' gno,carownerno,namea,zip_conn,addr_conn "+
"from car2 a left join carOwner b on a.carownerno=b.noa "+
"where a.carownerno!='''' and (b.noa between @t_bcarownerno and @t_ecarownerno) "+
"and (a.noa between @t_bcarno and @t_ecarno) and ("+@sql_carnos+" 1=1)"

insert into @tmp 
execute sp_executesql @cmd,N'@t_bcarno nvarchar(20),@t_ecarno nvarchar(20),@t_bcarownerno nvarchar(20),@t_ecarownerno nvarchar(20)', 
@t_bcarno = @t_bcarno,@t_ecarno = @t_ecarno,@t_bcarownerno=@t_bcarownerno,@t_ecarownerno=@t_ecarownerno


insert into @tmp
select '1' gno,carownerno,namea,'',''
from @tmp

select *
from @tmp
order by namea,carownerno,gno;

--************************************************************************************
z_car2_rj3:--z_car2_rj3 ref z_car27車輛統計表
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @t_bcarspecno nvarchar(20)
	declare @t_ecarspecno nvarchar(20)
	declare @t_pdate nvarchar(20)
	declare @t_sssno nvarchar(20)
	declare @t_enddate nvarchar(10)
	declare @t_xcarspec nvarchar(MAX)
	
	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
	set @t_bcarspecno = case when '#non'=[16] then '' else [16] end
	set @t_ecarspecno  = case when '#non'=[17] then char(255) else [17] end	
	set @t_pdate = case when '#non'=[18] then '' else [18] end
	set @t_sssno  = case when '#non'=[19] then char(255) else [19] end	
	set @t_enddate = case when '#non'=[11] then '' else [11] end
	set @t_xcarspec = case when '#non'=[23] then '' else [23] end
	
declare @result table(
		gno nvarchar(1),
		noa nvarchar(20),
		cno nvarchar(20),
		cardeal nvarchar(20),
		carno nvarchar(20),
		carownerno nvarchar(20),
		carowner nvarchar(50),
		indate nvarchar(10),
		outdate nvarchar(10),
		sxdate nvarchar(10),
		exdate nvarchar(10),
		wasted nvarchar(10),
		carkindno nvarchar(10),
		carkind nvarchar(10),
		caryear nvarchar(10),
		weight3 nvarchar(20),
		carbrandno nvarchar(20),
		carbrand nvarchar(20),
		carmount int,
		palmount int 
)
declare @cmd nvarchar(MAX)

set @cmd='select ''0'' gno,a.noa,a.cardealno,ISNULL(c.nick,''''),a.carno,a.carownerno,b.namea,a.indate,a.outdate, 
a.suspdate,a.enddate,a.wastedate,a.carspecno,ISNULL(f.spec,''''),a.caryear,ISNULL(a.weight3,''''),a.carbrandno,isnull(d.brand,''''),0,0 
from car2 a 
left join carowner b on b.noa = a.carownerno 
left join cardeal c on c.noa = a.cardealno 
left join carbrand d on d.noa = a.carbrandno 
left join carspec f on f.noa = a.carspecno 
where a.indate<=@t_enddate and (a.cardealno between @t_bcardealno and @t_ecardealno)
and a.carownerno!='''' '

if(@t_xcarspec!='')
set @cmd=@cmd+'and CHARINDEX(a.carspecno,'''+@t_xcarspec+''')>0'


if(PATINDEX('%遷出%',@t_pdate)=0)
	set @cmd=@cmd+' and (outdate='''' or outdate is null)'
if(PATINDEX('%報停%',@t_pdate)=0)
	set @cmd=@cmd+' and (a.suspdate='''' or a.suspdate is null)'
if(PATINDEX('%報廢%',@t_pdate)=0)
	set @cmd=@cmd+' and (a.enddate='''' or a.enddate is null)'
if(PATINDEX('%繳銷%',@t_pdate)=0)
	set @cmd=@cmd+' and (a.wastedate='''' or a.wastedate is null)'
declare @ssscount int
set @ssscount=0

if(@t_sssno!=char(255))
begin
	while(PATINDEX('%,%',@t_sssno)>0)
	begin
		if (@ssscount=0)
			set @cmd=@cmd+' and (a.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		else
			set @cmd=@cmd+' or a.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		set @t_sssno=RIGHT(@t_sssno,LEN(@t_sssno)-PATINDEX('%,%',@t_sssno))
		set @ssscount=@ssscount+1
	end
	if (@ssscount=0)
		set @cmd=@cmd+' and a.sssno='''+@t_sssno+''''
	else
		set @cmd=@cmd+' or a.sssno='''+@t_sssno+''')'
end

insert into @result 
execute sp_executesql @cmd,N'@t_enddate nvarchar(10),@t_bcardealno nvarchar(20),@t_ecardealno nvarchar(20),@t_bcarspecno nvarchar(20),@t_ecarspecno nvarchar(20)',
		@t_enddate=@t_enddate,@t_bcardealno=@t_bcardealno,@t_ecardealno=@t_ecardealno,@t_bcarspecno=@t_bcarspecno,@t_ecarspecno=@t_ecarspecno

insert into @result
select '1' gno,'',cno,'',COUNT(distinct carno),'','','','','','','','','','','','','',0,0
from @result
group by cno

declare @cno nvarchar(20) 
declare cursor_table cursor for 
select cno from @result where gno='1'
open cursor_table 
fetch next from cursor_table 
into @cno
while(@@FETCH_STATUS <> -1) 
begin 
	
	update @result
	set carmount=(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and (charindex('A',b.carspecno)=1 or charindex('C',b.carspecno)=1) and a.cno=@cno),
	palmount=(select COUNT(*) from @result a left join car2 b on a.carno=b.noa where a.gno='0' and charindex('B',b.carspecno)=1 and a.cno=@cno)
	where cno=@cno and gno='1'

	fetch next from cursor_table 
	into @cno
end 
close cursor_table 
deallocate cursor_table 

select *
from @result
order by cno,gno,carkindno,noa;

--***************************************************************************************
z_car2_rj4:-- z_car2_rj4 ref z_car29車主擁有車輛
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_bcarspecno nvarchar(20)
	declare @t_ecarspecno nvarchar(20)
	declare @t_pdate nvarchar(20)
	declare @t_sssno nvarchar(20)
	declare @t_enddate nvarchar(10)

	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_enddate = case when '#non'=[11] then '' else [11] end
	set @t_bcarspecno = case when '#non'=[16] then '' else [16] end
	set @t_ecarspecno  = case when '#non'=[17] then char(255) else [17] end	
	set @t_pdate = case when '#non'=[18] then '' else [18] end
	set @t_sssno  = case when '#non'=[19] then char(255) else [19] end	
	
declare @result table(
		gno nvarchar(1),
		noa nvarchar(20),
		cardealno nvarchar(20),
		[card] nvarchar(20),
		carno nvarchar(20),
		carownerno nvarchar(20),
		a nvarchar(50),
		b nvarchar(10),
		c nvarchar(10),
		d nvarchar(10),
		h nvarchar(10),
		e nvarchar(10),
		carkindno nvarchar(10),
		f nvarchar(10),
		weight3 nvarchar(20),
		carbrandno nvarchar(20),
		g nvarchar(20),
		datea nvarchar(10),
		total float,
		carspecno nvarchar(10),
		carmount float ,
		palmount float
)

declare @cmd nvarchar(MAX)

set @cmd='select ''0'' gno,a.noa,a.cardealno,ISNULL(c.nick,''''),a.carno,a.carownerno,b.namea,a.indate,a.outdate, 
a.suspdate,a.enddate,a.wastedate,a.carkindno,a.caryear,ISNULL(a.weight3,''''),a.carbrandno,isnull(d.brand,''''),isnull(f.bdate,''''),0 
,a.carspecno,0,0
from car2 a 
left join carowner b on b.noa = a.carownerno 
left join cardeal c on c.noa = a.cardealno 
left join carbrand d on d.noa = a.carbrandno 
left join (select * from carInsure where (noa+noq) in(select noa+MAX(noq) from carInsure group by noa)) f on f.noa = a.noa 
where a.indate<=@t_enddate and (a.carownerno between @t_bcarownerno and @t_ecarownerno) and 
(a.cardealno between @t_bcardealno and @t_ecardealno)and 
(a.carspecno between @t_bcarspecno and @t_ecarspecno) and a.carownerno!='''''

if(charindex('遷出',@t_pdate)=0) 
set @cmd=@cmd+' and (outdate='''' or outdate is null or outdate >@t_enddate) ' 

if(charindex('報停',@t_pdate)=0) 
set @cmd=@cmd+' and (a.suspdate='''' or a.suspdate is null or a.suspdate >@t_enddate)' 

if(charindex('報廢',@t_pdate)=0) 
set @cmd=@cmd+' and (a.enddate='''' or a.enddate is null or a.enddate >@t_enddate)'

if(charindex('繳銷',@t_pdate)=0) 
set @cmd=@cmd+' and (a.wastedate='''' or a.wastedate is null or a.wastedate >@t_enddate)' 


declare @ssscount int
set @ssscount=0

if(@t_sssno!=char(255))
begin
	while(PATINDEX('%,%',@t_sssno)>0)
	begin
		if (@ssscount=0)
			set @cmd=@cmd+' and (a.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		else
			set @cmd=@cmd+' or a.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		set @t_sssno=RIGHT(@t_sssno,LEN(@t_sssno)-PATINDEX('%,%',@t_sssno))
		set @ssscount=@ssscount+1
	end
	if (@ssscount=0)
		set @cmd=@cmd+' and a.sssno='''+@t_sssno+''''
	else
		set @cmd=@cmd+' or a.sssno='''+@t_sssno+''')'
end

insert into @result 
execute sp_executesql @cmd,N'@t_enddate nvarchar(10),@t_bcarownerno nvarchar(20),@t_ecarownerno nvarchar(20),@t_bcardealno nvarchar(20),@t_ecardealno nvarchar(20),@t_bcarspecno nvarchar(20),@t_ecarspecno nvarchar(20)',
		@t_enddate=@t_enddate,@t_bcarownerno=@t_bcarownerno,@t_ecarownerno=@t_ecarownerno,@t_bcardealno=@t_bcardealno,@t_ecardealno=@t_ecardealno,@t_bcarspecno=@t_bcarspecno,@t_ecarspecno=@t_ecarspecno

insert into @result
select '1','','','','',carownerno,'','','','','','','','','','','','',count(*),'',sum(case when (left(carspecno,1)='A' or left(carspecno,1)='C') then 1 else 0 end),sum(case when left(carspecno,1)='B' then 1 else 0 end)
from @result group by carownerno

select *
from @result
order by carownerno,gno,cardealno,noa;

--***************************************************************************************
z_car2_rj5:--z_car2_rj5 ref z_car31
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
declare @t_sssno nvarchar(20)
set @t_bdate = case when '#non' = [3] then '' else [3] end
set @t_edate = case when '#non' = [4] then CHAR(255) else [4] end
set @t_sssno  = case when '#non'=[19] then char(255) else [19] end
declare @tmp table(
        gno nvarchar(1), 
        datea nvarchar(20),
        carno nvarchar(20),
        carowner nvarchar(50),
        insurer nvarchar(50),
        moneys float,
        insuresheet nvarchar(20),
        insurecard nvarchar(20)
)
declare @cmd nvarchar(MAX)

set @cmd='select ''0'' gno,a.edate,a.noa,c.namea,a.insurer,a.money,a.insuresheet,a.insurecard 
from carInsure a left join car2 b on a.noa = b.noa left join carOwner c on c.noa = b.carownerno 
where (a.edate >= @t_bdate and a.edate <= @t_edate) and (b.outdate is null or b.outdate='''') and b.carownerno!='''' and (b.enddate='''' or b.enddate is null)'

declare @ssscount int
set @ssscount=0

if(@t_sssno!=char(255))
begin
	while(PATINDEX('%,%',@t_sssno)>0)
	begin
		if (@ssscount=0)
			set @cmd=@cmd+' and (b.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		else
			set @cmd=@cmd+' or b.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		set @t_sssno=RIGHT(@t_sssno,LEN(@t_sssno)-PATINDEX('%,%',@t_sssno))
		set @ssscount=@ssscount+1
	end
	if (@ssscount=0)
		set @cmd=@cmd+' and b.sssno='''+@t_sssno+''''
	else
		set @cmd=@cmd+' or b.sssno='''+@t_sssno+''')'
end

insert into @tmp 
execute sp_executesql @cmd,N'@t_bdate nvarchar(20),@t_edate nvarchar(20)',
		@t_bdate=@t_bdate,@t_edate=@t_edate
		
insert into @tmp 
select '1' gno,'','','','',SUM(moneys),'','' 
from @tmp 

select gno,datea,carno,carowner,insurer, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,moneys),1)),4,12)) moneys, 
insuresheet,insurecard 
from @tmp order by gno,datea;

--***************************************************************************************
z_car2_rj6:--z_car2_rj6 ref z_car32
declare @t_binsurerno nvarchar(20)
declare @t_einsurerno nvarchar(20)
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
declare @t_sssno nvarchar(20)
set @t_binsurerno = case when '#non' = [14] then '' else [14] end
set @t_einsurerno = case when '#non' = [15] then CHAR(255) else [15] end
set @t_bdate = case when '#non' = [3] then '' else [3] end
set @t_edate = case when '#non' = [4] then CHAR(255) else [4] end
set @t_sssno  = case when '#non'=[19] then char(255) else [19] end
declare @tmp table(
		gno nvarchar(20),
		xinsurerno nvarchar(20),
		insurer nvarchar(50),
		carno nvarchar(20),
		carowner nvarchar(50),
		datea nvarchar(20),
		moneys float,
		kind nvarchar(20),
		recno float
)

declare @cmd nvarchar(MAX)

set @cmd='select ''0'' gno,a.insurerno,a.insurer,a.noa,c.namea,a.edate,a.money,a.kind,ROW_NUMBER()over(PARTITION BY a.insurer order by a.noa) recno 
from carInsure a 
left join car2 b on a.noa = b.noa 
left join carOwner c on c.noa = b.carownerno 
where (a.edate >= @t_bdate and a.edate <= @t_edate) and 
(a.insurerno between @t_binsurerno and @t_einsurerno) and b.carownerno!='''' and (b.enddate='''' or b.enddate is null) and (b.outdate='''' or b.outdate is null)'

declare @ssscount int
set @ssscount=0

if(@t_sssno!=char(255))
begin
	while(PATINDEX('%,%',@t_sssno)>0)
	begin
		if (@ssscount=0)
			set @cmd=@cmd+' and (b.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		else
			set @cmd=@cmd+' or b.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		set @t_sssno=RIGHT(@t_sssno,LEN(@t_sssno)-PATINDEX('%,%',@t_sssno))
		set @ssscount=@ssscount+1
	end
	if (@ssscount=0)
		set @cmd=@cmd+' and b.sssno='''+@t_sssno+''''
	else
		set @cmd=@cmd+' or b.sssno='''+@t_sssno+''')'
end

insert into @tmp 
execute sp_executesql @cmd,N'@t_bdate nvarchar(20),@t_edate nvarchar(20),@t_binsurerno nvarchar(20),@t_einsurerno nvarchar(20)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_binsurerno=@t_binsurerno,@t_einsurerno=@t_einsurerno

insert into @tmp
select '1' gno,xinsurerno,'','','','',SUM(moneys),'',max(recno)
from @tmp
group by xinsurerno

select gno,xinsurerno,insurer,carno,carowner,datea,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,moneys),1)),4,12)) moneys,
kind,recno
from @tmp
order by xinsurerno,gno,carno,datea;

--***************************************************************************************
z_car2_rj7:--z_car2_rj7 ref z_car22
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_enddate nvarchar(10)
	
	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_enddate = case when '#non'=[11] then '' else [11] end

	declare @tmp table(
		cardealno nvarchar(20),
		cardeal nvarchar(50),
		carownerno nvarchar(20),
		carowner nvarchar(50),
		lenderno nvarchar(20),
		lender nvarchar(50),
		money int,
		installmentamount int,
		installment int,
		bkmoney int,
		surplusment int,
		surplusmoney int, 
		date nvarchar(50),
		memo nvarchar(MAX),
		carnos nvarchar(MAX)
		
)
--20130903睿庭貸款止日>截止日期就不顯示,且車子有遷出.報廢.繳銷也不顯示
--case說明--如果貸款止日>截止日期表示還沒還清否則已還清，沒有還清則計算剩餘還款期數(如果今天日期<計日，表示當期還沒還款，所以+1)
insert into @tmp
select a.cardealno,a.cardeal,a.noa,b.namea,a.lenderno,a.lender,a.money,a.installmentamount,a.installment,a.bkmoney,
case when a.edate > @t_enddate then
(left(a.edate,3)*12+right(left(a.edate,6),2))-(left(@t_enddate,3)*12+right(left(@t_enddate,6),2))+(case when cast(right(@t_enddate,2) as int)<=cast(a.day as int) then 1 else 0 end) else 0 end surplusment,
0 surplusmoney,a.bdate+' - '+a.edate date,a.memo,a.carnos
from carLender a left join carOwner b on a.noa=b.noa 
where (a.cardealno between @t_bcardealno and @t_ecardealno) and (a.noa between @t_bcarownerno and @t_ecarownerno)
and a.edate>@t_enddate 
and (select COUNT(*) from car2 where CHARINDEX(noa,a.carnos)>0 and (outdate='' or outdate is null ) and (enddate='' or enddate is null) and (wastedate='' or wastedate is null))>0
order by a.cardealno,a.noa,bdate desc
--計算貸款餘額
update @tmp
set surplusmoney=surplusment*installmentamount
where surplusment>0

--select * from @tmp
----------------------------------------------------------------------------------
declare @result table(
		gno nvarchar(1),
		cardealno nvarchar(20),
		cardeal nvarchar(50),
		carownerno nvarchar(20),
		carowner nvarchar(50),
		lenderno nvarchar(20),
		lender nvarchar(50),
		money int,
		installmentamount int,
		installment int,
		bkmoney int,
		surplusment int,
		surplusmoney int, 
		date nvarchar(50),
		memo nvarchar(MAX),
		carno nvarchar(MAX)
)

declare @cardealno nvarchar(20)
declare @cardeal nvarchar(50)
declare @carownerno nvarchar(20)
declare @carowner nvarchar(50)
declare @lenderno nvarchar(20)
declare @lender nvarchar(50)
declare @money int
declare @installmentamount int
declare @installment int
declare @bkmoney int
declare @surplusment int
declare @surplusmoney int
declare @date nvarchar(50)
declare @memo nvarchar(MAX)
declare @carnos nvarchar(MAX)
declare @count int

	declare cursor_table cursor for
	select cardealno,cardeal,carownerno,carowner,lenderno,lender,money,installmentamount,installment,bkmoney,surplusment,surplusmoney,date,memo,carnos from @tmp
	open cursor_table
	fetch next from cursor_table
	into @cardealno,@cardeal,@carownerno,@carowner,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,@carnos
	while(@@FETCH_STATUS <> -1)
	begin
		if(len(@carnos)>0)
		begin
			set @count=1
			while(@count>0)
			begin
				if(CHARINDEX(',',@carnos)=0)
				begin
					if(@count>1)
					begin
						insert into @result
						select '0',null,null,null,null,null,null,null,null,null,null,null,null,null,null,@carnos
					end
					else
					begin
						insert into @result
						select '0',@cardealno,@cardeal,@carownerno,@carowner,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,@carnos
					end
					
					set @count=0
				end
				else
				begin
					if(@count>1)
					begin
						insert into @result
						select '0',null,null,null,null,null,null,null,null,null,null,null,null,null,null,SUBSTRING(@carnos,0,CHARINDEX(',',@carnos))
					end
					else
					begin
						insert into @result
						select '0',@cardealno,@cardeal,@carownerno,@carowner,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,SUBSTRING(@carnos,0,CHARINDEX(',',@carnos))
					end
					set @carnos=SUBSTRING(@carnos,CHARINDEX(',',@carnos)+1,len(@carnos))
					set @count=@count+1
				end	
			end
		end
		else
		begin
			insert into @result
			select '0',@cardealno,@cardeal,@carownerno,@carowner,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,@carnos
		end
		insert into @result
		select '1',null,null,null,null,null,null,null,null,null,null,null,null,null,null,null
		
		fetch next from cursor_table
		into @cardealno,@cardeal,@carownerno,@carowner,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,@carnos
	end
	close cursor_table
	deallocate cursor_table
	
	insert into @result
	select '2',null,null,null,null,null,null,null,null,null,null,null,sum(surplusmoney),null,null,null
	from @result
	
	select a.gno,a.carownerno,a.carowner,a.cardealno,left(a.cardeal,3)cardeal,a.lenderno,left(a.lender,3)lender,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.money),1)),4,12)) money,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.installmentamount),1)),4,12)) installmentamount,a.installment,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.bkmoney),1)),4,12)) bkmoney,a.surplusment,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.surplusmoney),1)),4,12)) surplusmoney,a.date,a.memo,a.carno,
	c.brand,b.caryear from @result a left join car2 b on a.carno=b.noa left join carbrand c on b.carbrandno=c.noa;

--***************************************************************************************
z_car2_rj8:--z_car2_rj8 ref z_car24
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_enddate nvarchar(10)
	
	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_enddate = case when '#non'=[11] then '' else [11] end

	declare @tmp table(
		cardealno nvarchar(20),
		cardeal nvarchar(50),
		carownerno nvarchar(20),
		carowner nvarchar(50),
		lenderno nvarchar(20),
		lender nvarchar(50),
		money int,
		installmentamount int,
		installment int,
		bkmoney int,
		surplusment int,
		surplusmoney int, 
		date nvarchar(50),
		memo nvarchar(MAX),
		carnos nvarchar(MAX)
		
)
--20130903睿庭貸款止日>截止日期就不顯示,且車子有遷出.報廢.繳銷也不顯示
--case說明--如果貸款止日>截止日期表示還沒還清否則已還清，沒有還清則計算剩餘還款期數(如果今天日期<計日，表示當期還沒還款，所以+1)
insert into @tmp
select a.cardealno,a.cardeal,a.noa,b.namea,a.lenderno,a.lender,a.money,a.installmentamount,a.installment,a.bkmoney,
case when a.edate > @t_enddate then
(left(a.edate,3)*12+right(left(a.edate,6),2))-(left(@t_enddate,3)*12+right(left(@t_enddate,6),2))+(case when cast(right(@t_enddate,2)as int)<=cast(a.day AS int) then 1 else 0 end) else 0 end surplusment,
0 surplusmoney,a.bdate+' - '+a.edate date,a.memo,a.carnos
from carLender a left join carOwner b on a.noa=b.noa
where (a.cardealno between @t_bcardealno and @t_ecardealno) and (a.noa between @t_bcarownerno and @t_ecarownerno)
and a.edate>@t_enddate 
and (select COUNT(*) from car2 where CHARINDEX(noa,a.carnos)>0 and (outdate='' or outdate is null ) and (enddate='' or enddate is null) and (wastedate='' or wastedate is null))>0
order by a.noa

--計算貸款餘額
update @tmp
set surplusmoney=surplusment*installmentamount
where surplusment>0

--select * from @tmp
----------------------------------------------------------------------------------
declare @result table(
		gno nvarchar(1),
		carownerno nvarchar(20),
		carowner nvarchar(50),
		cardealno nvarchar(20),
		cardeal nvarchar(50),
		lenderno nvarchar(20),
		lender nvarchar(50),
		money int,
		installmentamount int,
		installment int,
		bkmoney int,
		surplusment int,
		surplusmoney int, 
		date nvarchar(50),
		memo nvarchar(MAX),
		carno nvarchar(MAX)
)

declare @cardealno nvarchar(20)
declare @cardeal nvarchar(50)
declare @carownerno nvarchar(20)
declare @t_carownerno nvarchar(20) 
declare @carowner nvarchar(50)
declare @lenderno nvarchar(20)
declare @lender nvarchar(50)
declare @money int
declare @installmentamount int
declare @installment int
declare @bkmoney int
declare @surplusment int
declare @surplusmoney int
declare @date nvarchar(50)
declare @memo nvarchar(MAX)
declare @carnos nvarchar(MAX)
declare @count int

set @t_carownerno='XXXX'

	declare cursor_table cursor for
	select cardealno,cardeal,carownerno,carowner,lenderno,lender,money,installmentamount,installment,bkmoney,surplusment,surplusmoney,date,memo,carnos from @tmp
	open cursor_table
	fetch next from cursor_table
	into @cardealno,@cardeal,@carownerno,@carowner,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,@carnos
	while(@@FETCH_STATUS <> -1)
	begin
	
		if(@carownerno!=@t_carownerno and @t_carownerno!='XXXX')
		begin
			insert into @result 
			select '2',@t_carownerno,null,null,null,null,null,null,null,null,null,null,sum(surplusmoney),null,null,null from @tmp where carownerno=@t_carownerno
		end
		set @t_carownerno=@carownerno
	
		if(len(@carnos)>0)
		begin
			set @count=1
			while(@count>0)
			begin
				if(CHARINDEX(',',@carnos)=0)
				begin
					if(@count>1)
					begin
						insert into @result
						select '0',@carownerno,null,null,null,null,null,null,null,null,null,null,null,null,null,@carnos
					end
					else
					begin
						insert into @result
						select '0',@carownerno,@carowner,@cardealno,@cardeal,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,@carnos
					end
					
					set @count=0
				end
				else
				begin
					if(@count>1)
					begin
						insert into @result
						select '0',@carownerno,null,null,null,null,null,null,null,null,null,null,null,null,null,SUBSTRING(@carnos,0,CHARINDEX(',',@carnos))
					end
					else
					begin
						insert into @result
						select '0',@carownerno,@carowner,@cardealno,@cardeal,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,SUBSTRING(@carnos,0,CHARINDEX(',',@carnos))
					end
					set @carnos=SUBSTRING(@carnos,CHARINDEX(',',@carnos)+1,len(@carnos))
					set @count=@count+1
				end	
			end
		end
		else
		begin
			insert into @result
			select '0',@carownerno,@carowner,@cardealno,@cardeal,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,@carnos
		end
		insert into @result
		select '1',@carownerno,null,null,null,null,null,null,null,null,null,null,null,null,null,null
		
		fetch next from cursor_table
		into @cardealno,@cardeal,@carownerno,@carowner,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,@carnos
	end
	
	insert into @result 
	select '2',@t_carownerno,null,null,null,null,null,null,null,null,null,null,sum(surplusmoney),null,null,null from @tmp where carownerno=@t_carownerno
	
	close cursor_table
	deallocate cursor_table
	
	insert into @result 
	select '3',@t_carownerno,null,null,null,null,null,null,null,null,null,null,sum(surplusmoney),null,null,null from @result where gno='2'

	select a.gno,a.carownerno,a.carowner,a.cardealno,left(a.cardeal,3)cardeal,a.lenderno,left(a.lender,3)lender,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.money),1)),4,12)) money,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.installmentamount),1)),4,12)) installmentamount,a.installment,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.bkmoney),1)),4,12)) bkmoney,a.surplusment,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.surplusmoney),1)),4,12)) surplusmoney,a.date,a.memo,a.carno,
	c.brand,b.caryear from @result a left join car2 b on a.carno=b.noa left join carbrand c on b.carbrandno=c.noa;

--***************************************************************************************
z_car2_rj9:--z_car2_rj9 ref z_car21
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_bcarno nvarchar(20)
	declare @t_ecarno nvarchar(20)
	declare @t_sssno nvarchar(20)
	declare @t_order nvarchar(20)
	
	set @t_bdate = case when '#non'=[3] then '' else [3] end
	set @t_edate = case when '#non'=[4] then char(255) else [4] end
	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_bcarno = case when '#non'=[12] then '' else [12] end
	set @t_ecarno  = case when '#non'=[13] then char(255) else [13] end	
	set @t_sssno  = case when '#non'=[19] then char(255) else [19] end	
	set @t_order = case when '#non'=[21] then '車行' else [21] end	

--*********************************************************************************** 

	declare @tmp table( 
		gno nvarchar(1), 
		recno int identity(1,1),--順序 
		checkdate nvarchar(10),--驗車日期 
		carno nvarchar(20),--車牌號碼 
		carowner nvarchar(20),--車主 
		passdate nvarchar(10),--發照日期 
		caryeartw nvarchar(10),--出廠 
		carbrand nvarchar(20),--廠牌 
		insurance nvarchar(10),--保險止日 
		cardeal nvarchar(20),--車行
		notice nvarchar(10)--通知  
	) 
	declare @cmd nvarchar(MAX)
--ROW_NUMBER()over(order by (case when len(@t_bdate+@t_edate)=0 then LEFT(a.checkdate,6) else a.checkdate end),a.carno)
set @cmd='select ''0'' gno, 
a.checkdate, a.carno, b.namea, a.passdate, a.caryeartw, c.brand, d.edate, e.nick ,a.notice
from car2 a 
left join carowner b on a.carownerno = b.noa 
left join carbrand c on a.carbrandno = c.noa 
left join (select noa,MAX(case when len(stopdate)>0 then stopdate else edate end) edate from carInsure group by noa) as d on a.carno = d.noa 
left join cardeal e on a.cardealno = e.noa 
where (a.checkdate between @t_bdate and @t_edate) and 
(a.cardealno between @t_bcardealno and @t_ecardealno) and 
(a.carownerno between @t_bcarownerno and @t_ecarownerno) and 
(a.carno between @t_bcarno and @t_ecarno) and 
a.carownerno!='''' and (a.enddate='''' or a.enddate is null) and (a.outdate='''' or a.outdate is null) and (a.wastedate='''' or a.wastedate is null)and (a.suspdate='''' or a.suspdate is null)' 

--婉容說不要顯示報停20130603

declare @ssscount int
set @ssscount=0

if(@t_sssno!=char(255))
begin
	while(PATINDEX('%,%',@t_sssno)>0)
	begin
		if (@ssscount=0)
			set @cmd=@cmd+' and (a.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		else
			set @cmd=@cmd+' or a.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		set @t_sssno=RIGHT(@t_sssno,LEN(@t_sssno)-PATINDEX('%,%',@t_sssno))
		set @ssscount=@ssscount+1
	end
	if (@ssscount=0)
		set @cmd=@cmd+' and a.sssno='''+@t_sssno+''''
	else
		set @cmd=@cmd+' or a.sssno='''+@t_sssno+''')'
end
	
if(@t_order='車行')
	set @cmd=@cmd+' order by a.cardealno,a.checkdate'
if(@t_order='車主')
	set @cmd=@cmd+' order by b.namea,a.checkdate'
if(@t_order='驗車日期')
	set @cmd=@cmd+' order by a.checkdate,a.noa'

insert into @tmp 
execute sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bcardealno nvarchar(20),@t_ecardealno nvarchar(20),@t_bcarownerno nvarchar(20),@t_ecarownerno nvarchar(20),@t_bcarno nvarchar(20),@t_ecarno nvarchar(20)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bcardealno=@t_bcardealno,@t_ecardealno=@t_ecardealno,@t_bcarownerno=@t_bcarownerno,@t_ecarownerno=@t_ecarownerno,@t_bcarno=@t_bcarno,@t_ecarno=@t_ecarno

select * from @tmp;

--***************************************************************************************
z_car2_rj10:--z_car2_rj10 ref z_car39
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @xyear nvarchar(10)
	
	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
	set @xyear = case when '#non' = [22] then '' else [22] end
--**********************************************************************************************

declare @tmp table( 
		gno nvarchar(1), 		
		carno nvarchar(50),
		year nvarchar(10),
		namea nvarchar(50),
		id nvarchar(10),
		addr nvarchar(MAX),
		jan float,
		feb float,
		mar float,
		apr float,
		may float,
		jun float,
		jul float,
		aug float,
		sep float,
		oct float,
		nov float,
		dec float,
		total float,
		memo nvarchar(MAX),
		cardealno nvarchar(20),
		comp nvarchar(MAX)
	)
	insert into @tmp
	select '0',a.noa,a.year,a.namea,a.id,a.addr,a.jan,a.feb,a.mar,a.apr,a.may,a.jun,a.jul,a.aug,a.sep,a.oct,a.nov,a.dec,
	(a.jan+a.feb+a.mar+a.apr+a.may+a.jun+a.jul+a.aug+a.sep+a.oct+a.nov+a.dec)total,a.memo,b.cardealno,c.comp
	from carsalary a left join car2 b on a.noa=b.noa
	left join cardeal c on b.cardealno=c.noa
	where (b.cardealno between @t_bcardealno and @t_ecardealno) and a.year=@xyear
	
	insert into @tmp (gno,cardealno,total)
	select '1',cardealno,sum(total)
	from @tmp group by cardealno
	
	select gno,carno,year,namea,id,addr,memo,comp
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,jan),1)),4,12)) jan
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,feb),1)),4,12)) feb
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,mar),1)),4,12)) mar
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,apr),1)),4,12)) apr
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,may),1)),4,12)) may
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,jun),1)),4,12)) jun
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,jul),1)),4,12)) jul
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,aug),1)),4,12)) aug
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,sep),1)),4,12)) sep
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,oct),1)),4,12)) oct
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,nov),1)),4,12)) nov
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,dec),1)),4,12)) dec
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total
	from @tmp order by cardealno,gno,carno;

--***************************************************************************************
z_car2_rj11:--z_car2_rj11 ref z_carpack
declare @t_bcardealno nvarchar(20) 
declare @t_ecardealno nvarchar(20) 
declare @t_enddate nvarchar(10) 
	
set @t_bcardealno = case when '#non'=[5] then '' else [5] end
set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
set @t_enddate = case when '#non'=[11] then '' else [11] end
	
------------------取得車頭和板台數---------------------
declare @tmp table( 
	gno nvarchar(20),
	carno nvarchar(20),
	carspecno nvarchar(20),
	cardealno nvarchar(20), 
	cardeal nvarchar(50),  
	carownerno nvarchar(20), 
	carowner nvarchar(50), 
	headmount int,
	palmount int 
) 

insert into @tmp
select '0',a.noa,a.carspecno,a.cardealno,c.comp,a.carownerno,b.namea,0,0
from car2 a 
left join carowner b on b.noa = a.carownerno 
left join cardeal c on c.noa = a.cardealno 
where a.indate<@t_enddate and (a.cardealno between @t_bcardealno and @t_ecardealno)and a.carownerno!=''
and (a.outdate='' or outdate is null) and (a.suspdate='' or a.suspdate is null)
and (a.enddate='' or a.enddate is null) and (a.wastedate='' or a.wastedate is null)
--and a.cardealno!='00' and a.cardealno!='' and a.carspecno!='D12' and a.carspecno!='18' and a.carspecno!='44' and a.carspecno!='55' and a.carspecno!=''
--1020619 A C開頭為車頭B開頭為板台
and a.cardealno!='00' and a.cardealno!='' and (CHARINDEX('A',a.carspecno)=1 or CHARINDEX('C',a.carspecno)=1 or CHARINDEX('B',a.carspecno)=1) and a.carspecno!=''

--insert into @tmp 
--select '1' gno,'','',cardealno,'','','' ,0,0 from @tmp group by cardealno

insert into @tmp 
select '1' gno,'','',noa,'','','' ,0,0 
from cardeal where noa in(select cardealno from carpack where (cardealno between @t_bcardealno and @t_ecardealno) and edate>@t_enddate  group by cardealno)
group by noa  

declare @cardealno nvarchar(20) 
declare cursor_table cursor for 
select cardealno from @tmp where gno='1'
open cursor_table 
fetch next from cursor_table 
into @cardealno
while(@@FETCH_STATUS <> -1) 
	begin 
	
	--update @tmp
	--set headmount=(select COUNT(*) from @tmp where gno='0' and (carspecno='A01' or carspecno='A04' or carspecno='A25' or carspecno='B53' or carspecno='C11' or carspecno='C27' or carspecno='C51') and cardealno=@cardealno),
	--palmount=(select COUNT(*) from @tmp where gno='0' and (carspecno!='A01' and carspecno!='A04' and carspecno!='A25' and carspecno!='B53' and carspecno!='C11' and carspecno!='C27' and carspecno!='C51') and cardealno=@cardealno),
	--cardeal=(select comp from cardeal where noa=@cardealno)
	--where cardealno=@cardealno and gno='1'
	
	update @tmp
	set headmount=(select COUNT(*) from @tmp where gno='0' and (CHARINDEX('A',carspecno)=1 or CHARINDEX('C',carspecno)=1) and cardealno=@cardealno),
	palmount=(select COUNT(*) from @tmp where gno='0' and CHARINDEX('B',carspecno)=1 and cardealno=@cardealno),
	cardeal=(select comp from cardeal where noa=@cardealno)
	where cardealno=@cardealno and gno='1'

	fetch next from cursor_table 
	into @cardealno
	end 
close cursor_table 
deallocate cursor_table 

------------------取得車頭和板台數---------------------

declare @result table( 
	gno nvarchar(20),
	cardealno nvarchar(20), 
	bxdate nvarchar(20), 
	exdate nvarchar(20), 
	mount float,
	carmount float,
	money float, 
	place nvarchar(50),
	hm int,
	pm int 
) 

insert into @result 
select '0' gno,cardealno,bdate,edate,mount,carmount,money,place,0,0
from carpack
where (cardealno between @t_bcardealno and @t_ecardealno) and edate>@t_enddate
order by edate desc

insert into @result 
select '1' gno,b.cardealno,'','',isnull(sum(a.carmount),0)-(b.headmount+b.palmount),isnull(sum(a.carmount),0),0,'',b.headmount,b.palmount
from carpack a right join (select * from @tmp where gno='1') b on a.cardealno=b.cardealno
group by b.cardealno,b.headmount,b.palmount

insert into @result 
select '2' gno,'ZZZZZ','','',SUM(mount),SUM(carmount),0,'',SUM(hm),SUM(pm)
from @result
where gno='1'

select a.gno,a.cardealno,a.bxdate,a.exdate,place
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.mount),1)),4,12)) mount
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.carmount),1)),4,12)) carmount
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.money),1)),4,12)) money
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.hm),1)),4,12)) hm
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.pm),1)),4,12)) pm
,b.nick cardeal from @result a
left join cardeal b on a.cardealno=b.noa
order by cardealno,gno;

--***************************************************************************************
z_car2_rj12:--z_car2_rj12 ref z_car33
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_enddate nvarchar(10)
	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_enddate = case when '#non'=[11] then '' else [11] end

	declare @tmp table( 
		cardealno nvarchar(20), 
		cardeal nvarchar(50), 
		carownerno nvarchar(20), 
		carowner nvarchar(50), 
		lenderno nvarchar(20), 
		lender nvarchar(50), 
		money int, 
		installmentamount int, 
		installment int, 
		bkmoney int, 
		surplusment int, 
		surplusmoney int, 
		bdate nvarchar(50), 
		edate nvarchar(50), 
		memo nvarchar(MAX), 
		carnos nvarchar(MAX) 
	) 
	--case說明--如果貸款止日>截止日期表示還沒還清否則已還清，沒有還清則計算剩餘還款期數(如果今天日期<計日，表示當期還沒還款，所以+1) 
	insert into @tmp 
		select a.cardealno,a.cardeal,a.noa,b.namea,a.lenderno,a.lender,a.money,a.installmentamount,a.installment,a.bkmoney, 
		case when a.edate > @t_enddate then 
		(left(a.edate,3)*12+right(left(a.edate,6),2))-(left(@t_enddate,3)*12+right(left(@t_enddate,6),2))+(case when right(@t_enddate,2)<=a.day then 1 else 0 end) else 0 end surplusment, 
		0 surplusmoney,a.bdate,a.edate,a.memo,a.carnos 
		from carLender a left join carOwner b on a.noa=b.noa 
		order by a.noa 
	
	--計算貸款餘額 
	update @tmp 
	set surplusmoney=surplusment*installmentamount 
	where surplusment>0 
	
	declare @tmpa table( 
		gno nvarchar(20), 
		carownerno nvarchar(20), 
		typea nvarchar(20), 
		asset nvarchar(100),
		gdate nvarchar(10),
		dmoney int, 
		cmoney int,  
		fdate nvarchar(10),
		memo nvarchar(MAX),
		total int
	) 
	insert into @tmpa
	select '0',noa ,typea,asset,getdate,money,null,fdate,memo,0
	from balance
	union all
	select '0',carownerno,'車輛'typea,noa,indate,cast(round(inmoney*POWER(0.800,((left(@t_enddate,3)*12)+right(left(@t_enddate,6),2))-(left(indate,3)*12+right(left(indate,6),2))),0) as int),
	(select total from cara where carno=car2.noa and carno+mon in (select carno+MAX(mon) from cara where carno=car2.noa group by carno)),@t_enddate,memo,0
	from car2 where outdate='' or (select total from cara where carno=car2.noa and carno+mon in (select carno+MAX(mon) from cara where carno=car2.noa group by carno))!=0
	and carownerno between @t_bcarownerno and @t_ecarownerno
	--where indate!='' and inmoney>0
	union all
	select '0',carownerno,'貸款'typea,carnos,bdate,null,surplusmoney,edate,memo,0
	from @tmp
	union all
	select '0',compno,'未兌現票據',gqbno,datea,0,money,indate,(case when gqbno in (select checkno from borrs where checkno!='') then '借支 '+ memo else memo end),0 from gqb
	where left(compno,1)='H' and (len(enda)=0 or enda is null or enda ='N' or enda='n') and len(indate)=9 and typea!='3'
	and (left(right('0'+CONVERT (nvarchar(7),CONVERT (VARCHAR(7),dateadd(d,-5,CONVERT(datetime ,CONVERT(nvarchar(10),CONVERT(int,left(@t_enddate,3))+1911)+right(left(@t_enddate,6),2)+right(left(@t_enddate,9),2)) ),12 )+0890000),7),3)+'/'
	+right(left(right('0'+CONVERT (nvarchar(7),CONVERT (VARCHAR(7),dateadd(d,-5,CONVERT(datetime ,CONVERT(nvarchar(10),CONVERT(int,left(@t_enddate,3))+1911)+right(left(@t_enddate,6),2)+right(left(@t_enddate,9),2)) ),12 )+0890000),7),5),2)+'/'
	+right(right('0'+CONVERT (nvarchar(7),CONVERT (VARCHAR(7),dateadd(d,-5,CONVERT(datetime ,CONVERT(nvarchar(10),CONVERT(int,left(@t_enddate,3))+1911)+right(left(@t_enddate,6),2)+right(left(@t_enddate,9),2)) ),12 )+0890000),7),2))<=indate
	union all
	select '0',custno,'借支',noa,begindate,0,unpay,enddate,memo,0 from borr 
	where unpay!=0  and custno in(select noa from carOwner) and custno!=''
	order by noa
	
	insert into @tmpa
	select '1',carownerno,typea,'','',SUM(dmoney),SUM(cmoney),'','',isnull(SUM(dmoney),0)-isnull(SUM(cmoney),0)
	from @tmpa
	group by carownerno,typea
	
	insert into @tmpa
	select '2',carownerno,char(255),'','',SUM(dmoney),SUM(cmoney),'','',isnull(SUM(dmoney),0)-isnull(SUM(cmoney),0)
	from @tmpa where gno='0'
	group by carownerno
	
	select a.gno,a.carownerno,a.typea,a.asset,a.gdate,a.fdate,REPLACE(a.memo,'chr(10)','<BR>') memo,b.namea
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.dmoney),1)),4,12)) dmoney
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.cmoney),1)),4,12)) cmoney
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.total),1)),4,12)) total
	from @tmpa a left join carOwner b on a.carownerno=b.noa
	where a.carownerno between @t_bcarownerno and @t_ecarownerno and a.carownerno!=''
	order by carownerno,typea,gno;

--***************************************************************************************
