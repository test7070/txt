z_tran_jr1:--z_tran_jr1
declare @t_bdate nvarchar(20) = case when '#non'=[2] then '' else [2] end
declare @t_edate nvarchar(20) = case when '#non'=[3] then char(255) else [3] end
declare @t_bcustno nvarchar(20) = case when '#non'=[6] then '' else [6] end
declare @t_ecustno nvarchar(20) = case when '#non'=[7] then char(255) else [7] end
declare @t_bcarno nvarchar(20) = case when '#non'=[8] then '' else [8] end
declare @t_ecarno nvarchar(20) = case when '#non'=[9] then char(255) else [9] end
declare @t_baddr nvarchar(20) = case when '#non'=[10] then '' else [10] end 
declare @t_eaddr nvarchar(20) = case when '#non'=[11] then char(255) else [11] end 

declare @tmp table(
	rr int,
	gno nvarchar(1),
	datea nvarchar(10),
	trandate nvarchar(10),
	custno nvarchar(100),
	comp nvarchar(200),
	uccno nvarchar(50),
	weight nvarchar(50),
	weight2 nvarchar(50),
	po nvarchar(100),
	carno nvarchar(50),
	straddrno nvarchar(100),
	straddr nvarchar(100),
	chk1 nvarchar(2),
	memo nvarchar(max)
)
insert @tmp
select ROW_NUMBER()over(partition by datea,trandate,po,custno,straddrno,chk1 order by uccno),'0',datea,trandate,custno,nick,uccno,weight,weight2,po,carno,straddrno
,straddr,case chk1 when '1' then 'V' else ' ' end chk1,memo
from view_trans
where (datea between @t_bdate and @t_edate)
and (custno between @t_bcustno and @t_ecustno)
and (carno between @t_bcarno and @t_ecarno)
and (straddrno between @t_baddr and @t_eaddr)

update @tmp
set gno=case when rr=1 then 0 else 1 end

select 
dbo.getComma(weight,2) weight
,dbo.getComma(weight2,2) weight2
,* from @tmp
order by datea,trandate,custno,uccno,straddrno
;
------------------------------------------------------------------------------------------------
z_tran_jr2:--z_tran_jr2
declare @t_bdate nvarchar(20) = case when '#non'=[2] then '' else [2] end
declare @t_edate nvarchar(20) = case when '#non'=[3] then char(255) else [3] end
declare @t_bcustno nvarchar(20) = case when '#non'=[6] then '' else [6] end
declare @t_ecustno nvarchar(20) = case when '#non'=[7] then char(255) else [7] end
declare @t_bcarno nvarchar(20) = case when '#non'=[8] then '' else [8] end
declare @t_ecarno nvarchar(20) = case when '#non'=[9] then char(255) else [9] end
declare @t_baddr nvarchar(20) = case when '#non'=[10] then '' else [10] end 
declare @t_eaddr nvarchar(20) = case when '#non'=[11] then char(255) else [11] end 

declare @tmp table(
	gno nvarchar(1),
	rr int,
	straddrno nvarchar(50),
	straddr nvarchar(100),
	trandate nvarchar(10),
	carno nvarchar(50),
	weight nvarchar(50),
	weight2 float,
	price float,
	total float,
	po nvarchar(100),
	uccno nvarchar(50),
	custno nvarchar(100),
	comp nvarchar(200),
	total2 float,
	total3 float,
	acomp nvarchar(100)
)
insert @tmp (gno,rr,straddrno,straddr,trandate,carno,weight,weight2,price,total,po,uccno,custno,comp)
select '0',ROW_NUMBER()over(partition by straddrno order by trandate),straddrno,straddr,trandate,carno,weight,weight2,price,total,po,uccno,custno,nick
from view_trans
where (trandate between @t_bdate and @t_edate)
and (custno between @t_bcustno and @t_ecustno)
and (carno between @t_bcarno and @t_ecarno)
and (straddrno between @t_baddr and @t_eaddr)

update @tmp
set acomp=(select top 1 nick from acomp)

insert @tmp(gno,straddrno,weight2,total,total2,total3)
select '1',straddrno,SUM(weight2),SUM(total),SUM(total*0.05),SUM(total+total*0.05)
from @tmp group by straddrno

insert @tmp(gno,straddrno)
select '2',straddrno from @tmp
group by straddrno

select 
straddr+'噸數統計' title
,straddr+'噸數' custwn
,dbo.getComma(weight,2) weight
,dbo.getComma(weight2,2) weight2
,'$'+dbo.getComma(price,0) price
,'$'+dbo.getComma(total,0) total
,'$'+dbo.getComma(total2,0) total2
,'$'+dbo.getComma(total3,0) total3
,* from @tmp
order by straddrno,gno,trandate
;
-------------------------------------------------------------------------------------------------
z_tran_jr3:--z_tran_jr3
declare @t_bdate nvarchar(20) = case when '#non'=[2] then '' else [2] end
declare @t_edate nvarchar(20) = case when '#non'=[3] then char(255) else [3] end
declare @t_bcustno nvarchar(20) = case when '#non'=[6] then '' else [6] end
declare @t_ecustno nvarchar(20) = case when '#non'=[7] then char(255) else [7] end
declare @t_bcarno nvarchar(20) = case when '#non'=[8] then '' else [8] end
declare @t_ecarno nvarchar(20) = case when '#non'=[9] then char(255) else [9] end
declare @t_baddr nvarchar(20) = case when '#non'=[10] then '' else [10] end 
declare @t_eaddr nvarchar(20) = case when '#non'=[11] then char(255) else [11] end 

declare @tmp table(
	rr int,
	gno nvarchar(1),
	mon nvarchar(20),
	custno nvarchar(100),
	comp nvarchar(200),
	addr nvarchar(max),
	serial nvarchar(50),
	tel nvarchar(50),
	datea nvarchar(10),
	uccno nvarchar(50),
	weight float,
	price float,
	money float,
	carno nvarchar(50),
	po nvarchar(50),
	straddrno nvarchar(50),
	straddr nvarchar(50),
	tax float,
	total float
)

insert @tmp
select ROW_NUMBER()over(partition by custno,b.trandate,b.carno,po,straddrno order by b.trandate),'0',replace(LEFT(a.datea,6),'/','-')+'月份',b.custno,c.comp,c.addr_comp
,c.serial,c.tel,b.trandate,b.uccno,b.weight2,b.price,b.total,b.carno,b.po
,b.straddrno,b.straddr,0,0
from view_tran a left join view_trans b on a.noa=b.noa
left join cust c on b.custno=c.noa
where (a.datea between @t_bdate and @t_edate)
and (custno between @t_bcustno and @t_ecustno)

update @tmp
set gno=case when rr=1 then 0 else 1 end

insert @tmp(gno,custno,money,tax,total)
select '2',custno,SUM(money),SUM(money)*0.05,SUM(money)*0.05+SUM(money)
from @tmp
group by custno

insert @tmp(gno,custno)
select '3',custno
from @tmp
group by custno

select 
dbo.getComma(weight,2)weight
,dbo.getComma(price,0)price
,dbo.getComma(money,0)money
,dbo.getComma(tax,0)tax
,'$'+dbo.getComma(total,0)total
,* from @tmp
order by custno,gno,datea
;
-----------------------------------------------------------------------------------------------------
z_tran_jr4:--z_tran_jr4
declare @t_mon nvarchar(10)
declare @t_bdriverno nvarchar(20)
declare @t_edriverno nvarchar(20)

set @t_mon = case when '#non'='104/11' then '' else '104/11' end
set @t_bdriverno = case when '#non'='#non' then '' else '#non' end
set @t_edriverno = case when '#non'='#non' then char(255) else '#non' end	
	
declare @tmp table(
	gno nvarchar(1),
	rr int,
	carno nvarchar(50),
	driverno nvarchar(50),
	driver nvarchar(50),
	con nvarchar(max),
	mon nvarchar(10),
	money float,
	memo nvarchar(max),
	counta float
)
insert @tmp(gno,driverno,driver)
select '9',driverno,driver
from carsals
where noa='104/10'

--應領tran
insert @tmp
select '1','1',b.carno,b.driverno,b.driver,b.carno+'總收入',@t_mon,sum(b.total),'',''
from view_trans b left join  view_tran a on a.noa=b.noa
where (LEFT(b.datea,6)=@t_mon)
and exists(select * from @tmp where b.driverno=driverno)
and isnull(b.driverno,'')!=''
group by b.carno,b.driverno,b.driver,b.carno

update @tmp
set counta=b.carno
from @tmp a
outer apply(select count(carno)carno,driverno from @tmp where a.driverno=driverno group by driverno)b

--應領carchg
insert @tmp
select '1','2',carno,driverno,driver,plusitem,@t_mon,sum(plusmoney),'',''
from carchg a
where (LEFT(datea,6)=@t_mon)
and exists(select * from @tmp where a.driverno=driverno and gno='9')
group by carno,driverno,driver,plusitem

--應扣carchg
insert @tmp
select '2','3',carno,driverno,driver,minusitem,@t_mon,sum(minusmoney),'',''
from carchg a
where (LEFT(datea,6)=@t_mon)
and exists(select * from @tmp where a.driverno=driverno and gno='9')
group by carno,driverno,driver,minusitem

--應扣carborr
insert @tmp
select '2','4',carno,driverno,driver,'私人借支('+datea+')',b.mon,b.money,dbo.getcomma(a.driverpay,0)+' '+cast(mount as nvarchar(50))+'期',''
from carborr a left join carborrs b on a.noa=b.noa
where b.mon=@t_mon
and exists(select * from @tmp where a.driverno=driverno and gno='9')

update a
set rr=rx
from (select ROW_NUMBER()over(partition by gno,driverno,driver order by rr,gno)rx,rr from @tmp where ISNULL(money,0)!=0)a

delete @tmp where gno='9' or ISNULL(money,0)=0

declare @result table(
	gno nvarchar(1),
	rr int,
	counta nvarchar(50),
	driverno nvarchar(50),
	driver nvarchar(50),
	con1 nvarchar(max),
	mon1 nvarchar(10),
	money1 float,
	memo1 nvarchar(max),
	con2 nvarchar(max),
	mon2 nvarchar(10),
	money2 float,
	memo2 nvarchar(max)
)
insert @result(gno,rr,driverno,driver)
select '0',rr,driverno,driver
from @tmp a
group by rr,driverno,driver

update @result
set con1=b.con,mon1=b.mon,money1=b.money,memo1=b.memo,counta=b.counta
from @result a left join @tmp b on a.driverno=b.driverno and a.driver=b.driver and a.rr=b.rr
where b.gno='1'

update @result
set con2=b.con,mon2=b.mon,money2=b.money,memo2=b.memo
from @result a left join @tmp b on a.driverno=b.driverno and a.driver=b.driver and a.rr=b.rr
where b.gno='2'

insert @result(gno,rr,driverno,driver,money1,money2)
select '1',9998,driverno,driver,sum(money1),sum(money2)
from @result
group by driverno,driver

insert @result(gno,rr,driverno,driver,money1)
select '2',9998,driverno,driver,sum(money1-money2)
from @result
where gno='1'
group by driverno,driver

insert @result(gno,rr,driverno,driver)
select '3',9998,driverno,driver
from @result
group by driverno,driver

select 
left(@t_mon,3)+'年'+right(@t_mon,2)+'月份薪資表' title
,dbo.getComma(money1,0) money1
,dbo.getComma(money2,0) money2
,counta+'台車收入金額' counta
,* from @result order by driverno,driver,rr,gno
;