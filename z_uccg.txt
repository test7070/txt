
z_uccg02:--z_uccg02	
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_bdate nvarchar(10) = case when '#non'=[2] then '' else [2] end
	declare @t_edate nvarchar(10) = case when '#non'=[3] then char(255) else [3] end
	declare @t_bproductno nvarchar(30) = case when '#non'=[4] then '' else [4] end
	declare @t_eproductno nvarchar(30) = case when '#non'=[5] then char(255) else [5] end
	declare @t_typea nvarchar(15) = case when '#non'=[6] then '' else [6] end
	-----------------------------------------------------
	IF OBJECT_ID('tempdb..#z_uccg02')is not null
	BEGIN
		drop table #z_uccg02
	END
	create table #z_uccg02(
		sel int identity(1,1)
		,typea nvarchar(20)
		,datea nvarchar(10)
		,accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,uno nvarchar(30)
		,productno nvarchar(30)
		,product nvarchar(max)
		,dime float
		,width float
		,lengthb float
		,radius float
		
		,mount float
		,[weight] float
		,price float
		,[money] float
	)
	
	--進貨
	insert into #z_uccg02(typea,datea,accy,noa,noq
		,uno,productno,product,dime,width,lengthb,radius,mount,[weight],price,[money])
	select 'A1',b.datea,a.accy,a.noa,a.noq
		,a.uno,a.productno,a.product,a.dime,a.width,a.lengthb,a.radius
		,a.mount,a.[weight],a.price,a.total
	from view_rc2s a 
	left join view_rc2 b on a.accy=b.accy and a.noa=b.noa
	where a.datea <= @t_edate
	and ISNULL(a.typea,'') = '1'
	and len(ISNULL(a.uno,''))!=0

	--進貨退回
	insert into #z_uccg02(typea,datea,accy,noa,noq
		,uno,productno,product,dime,width,lengthb,radius,mount,[weight])
	select 'B1',b.datea,a.accy,a.noa,a.noq
		,a.uno,a.productno,a.product,a.dime,a.width,a.lengthb,a.radius
		,a.mount,a.[weight]
	from view_rc2s a 
	left join view_rc2 b on a.accy=b.accy and a.noa=b.noa
	where a.datea <= @t_edate
	and ISNULL(a.typea,'') = '2'
	and len(ISNULL(a.uno,''))!=0
	
	--入庫
	insert into #z_uccg02(typea,datea,accy,noa,noq
		,uno,productno,product,dime,width,lengthb,radius,mount,[weight],price,[money])
	select 'A2',b.datea,a.accy,a.noa,a.noq
		,a.uno,a.productno,a.product,a.dime,a.width,a.lengthb,a.radius
		,a.mount,a.[weight],a.price,a.total
	from view_inas a 
	left join view_ina b on a.accy=b.accy and a.noa=b.noa
	where a.datea <= @t_edate
	and len(ISNULL(a.uno,''))!=0
	and a.uno='153E667739'
	
	--領料
	insert into #z_uccg02(typea,datea,accy,noa,noq
		,uno,productno,product,dime,width,lengthb,radius,mount,[weight])
	select 'B2',a.datea,a.accy,a.noa,a.noq
		,a.uno,a.productno,a.product,a.dime,a.width,a.lengthb,a.radius
		,a.mount,case when ISNULL(a.gweight,0)!=0 then a.gweight else a.[weight] end
	from view_gets a 
	left join view_get b on a.accy=b.accy and a.noa=b.noa
	where a.datea <= @t_edate
	and len(ISNULL(a.uno,''))!=0
	
	-- 聯琦 RK   CUT不會有領用
	--成品進倉  cuts
	insert into #z_uccg02(typea,datea,accy,noa,noq
		,uno,productno,product,dime,width,lengthb,radius,mount,[weight])
	select 'A3',a.datea,a.accy,a.noa,a.noq
		,a.bno,a.productno,a.product,a.dime,a.width,a.lengthb,a.radius
		,a.mount,a.[weight]
	from view_cuts a 
	left join view_cut b on a.accy=b.accy and a.noa=b.noa
	where a.datea <= @t_edate
	and len(ISNULL(a.bno,''))!=0
	
	--出貨
	insert into #z_uccg02(typea,datea,accy,noa,noq
		,uno,productno,product,dime,width,lengthb,radius,mount,[weight])
	select 'B4',a.datea,a.accy,a.noa,a.noq
		,a.uno,a.productno,a.product,a.dime,a.width,a.lengthb,a.radius
		,a.mount,case when ISNULL(a.gweight,0)!=0 then a.gweight else a.[weight] end
	from view_vccs a 
	left join view_vcc b on a.accy=b.accy and a.noa=b.noa
	where a.datea <= @t_edate
	and len(ISNULL(a.uno,''))!=0
	and ISNULL(a.typea,'') = '1'
	
	--出貨退回
	insert into #z_uccg02(typea,datea,accy,noa,noq
		,uno,productno,product,dime,width,lengthb,radius,mount,[weight])
	select 'A4',a.datea,a.accy,a.noa,a.noq
		,a.uno,a.productno,a.product,a.dime,a.width,a.lengthb,a.radius
		,a.mount,case when ISNULL(a.gweight,0)!=0 then a.gweight else a.[weight] end
	from view_vccs a 
	left join view_vcc b on a.accy=b.accy and a.noa=b.noa
	where a.datea <= @t_edate
	and len(ISNULL(a.uno,''))!=0
	and ISNULL(a.typea,'') = '2'
	
	----------------------------------------------------------------------------
	update #z_uccg02 set productno = ISNULL(b.productno,'')
		,dime = ISNULL(b.dime,0)
		,width = ISNULL(b.width,0)
		,lengthb = ISNULL(b.lengthb,0)
		,radius = ISNULL(b.radius,0)
	from #z_uccg02 a
	left join view_uccb b on a.uno=b.uno
	
	-- 除了進貨的金額,其他的都由UCCB.SPRICE * WEIGHT 換算
	update #z_uccg02 set price=b.sprice,[money]=ROUND(a.[weight]*b.sprice,0)
	from #z_uccg02 a
	left join view_uccb b on a.uno=b.uno 
	where not(a.typea='A1' or a.typea='B1')
	----------------------------------------------------------------------------
	declare @tmpb table(
		sel int identity(1,1)
		,uno nvarchar(30)
		,productno nvarchar(30)
		,product nvarchar(50)
		,dime float
		,width float
		
		--期初
		,mount01 float
		,weight01 decimal(15,4)
		,price01 float
		,money01 float 
		--本期進
		,mount02 float
		,weight02 decimal(15,4)
		,price02 float
		,money02 float
		--本期入庫
		,mount03 float
		,weight03 decimal(15,4)
		,price03 float
		,money03 float
		--本期領
		,mount04 float
		,weight04 decimal(15,4)
		,price04 float
		,money04 float
		--本期出
		,mount05 float
		,weight05 decimal(15,4)
		,price05 float
		,money05 float
		--期末
		,mountZ float
		,weightZ float
		,priceZ float
		,moneyZ float
	)
	
	declare @sel int
	declare @typea nvarchar(20)
	declare @datea nvarchar(20)
	declare @uno nvarchar(30)
	declare @productno nvarchar(30)
	declare @dime float
	declare @width float
	declare @lengthb float
	declare @radius float
	declare @mount float
	declare @weight float
	declare @money float
	
	declare cursor_table cursor for
	select sel,typea,datea,uno,mount,cast([weight] as decimal(15,4)),[money] 
		from #z_uccg02 order by uno
	open cursor_table
	fetch next from cursor_table
	into @sel,@typea,@datea,@uno,@mount,@weight,@money 
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select * from @tmpb where uno=@uno)
		begin
			insert into @tmpb(uno)values(@uno)
		end
		if @datea<@t_bdate
		begin
			--期初
			if LEFT(@typea,1)='A'
			begin
				update @tmpb set mount01 = ISNULL(mount01,0) + @mount 
					,weight01 = ISNULL(weight01,0) + @weight 
				where uno=@uno
			end
			else
			begin
				update @tmpb set mount01 = ISNULL(mount01,0) - @mount 
					,weight01 = ISNULL(weight01,0) - @weight 
				where uno=@uno
			end
		end
		else
		begin
			--		
			if @typea = 'A1' --進貨
			begin
				update @tmpb set mount02 = ISNULL(mount02,0) + @mount 
					,weight02 = ISNULL(weight02,0) + @weight 
					,money02 = ISNULL(money02,0) + @money
				where uno=@uno
			end
			else if @typea = 'B1' --進貨退回
			begin
				update @tmpb set mount02 = ISNULL(mount02,0) - @mount 
					,weight02 = ISNULL(weight02,0) - @weight 
					,money02 = ISNULL(money02,0) - @money
				where uno=@uno
			end
			else if @typea = 'A2' --入庫
			begin
				update @tmpb set mount03 = ISNULL(mount03,0) + @mount 
					,weight03 = ISNULL(weight03,0) + @weight 
				where uno=@uno
			end
			else if @typea = 'B2' --領料
			begin
				update @tmpb set mount04 = ISNULL(mount04,0) + @mount 
					,weight04 = ISNULL(weight04,0) + @weight 
				where uno=@uno
			end
			else if @typea = 'A3' --成品進倉  cuts
			begin
				update @tmpb set mount04 = ISNULL(mount04,0) + @mount 
					,weight04 = ISNULL(weight04,0) + @weight 
				where uno=@uno
			end
			else if @typea = 'B4' --出貨
			begin
				update @tmpb set mount05 = ISNULL(mount05,0) + @mount 
					,weight05 = ISNULL(weight05,0) + @weight 
				where uno=@uno
			end
			else if @typea = 'A4' --出貨退回
			begin
				update @tmpb set mount05 = ISNULL(mount05,0) - @mount 
					,weight05 = ISNULL(weight05,0) - @weight 
				where uno=@uno
			end
			
		end

		fetch next from cursor_table
		into @sel,@typea,@datea,@uno,@mount,@weight,@money 
	end
	close cursor_table
	deallocate cursor_table
	
	------------------------------------------------------------------------------------------
	update @tmpb set productno=ISNULL(b.productno,'')
		,product=ISNULL(b.product,'')
		,dime=ISNULL(b.dime,0)
		,width=ISNULL(b.width,0) 
		,price01=ISNULL(b.sprice,0)
		,price03=ISNULL(b.sprice,0)
		,price04=ISNULL(b.sprice,0)
		,price05=ISNULL(b.sprice,0)
	from @tmpb a
	left join view_uccb b on a.uno=b.uno
	where b.uno is not null
	
	update @tmpb set money01=round(weight01*price01,0)
		,money03=round(weight03*price03,0)
		,money04=round(weight04*price04,0)
		,money05=round(weight05*price05,0)
	
	update @tmpb set mountZ = ISNULL(mount01,0)+ISNULL(mount02,0)+ISNULL(mount03,0)-ISNULL(mount04,0)-ISNULL(mount05,0)
		,weightZ = ISNULL(weight01,0)+ISNULL(weight02,0)+ISNULL(weight03,0)-ISNULL(weight04,0)-ISNULL(weight05,0)
		,moneyZ = ISNULL(money01,0)+ISNULL(money02,0)+ISNULL(money03,0)-ISNULL(money04,0)-ISNULL(money05,0)
	update @tmpb set priceZ = case when weightZ<=0 then 0 else ROUND(moneyZ/weightZ,3) end
	---------------------------------------------------------------------------------------
	delete @tmpb where not(isnull(productno,'') between @t_bproductno and @t_eproductno)
	--期初庫存負的不計算
	--delete @tmpb where ISNULL(weight01,0)<0
	---------------------------------------------------------------------------------------
	declare @tmpc table(
		sel int identity(1,1)
		,gno nvarchar(20)
		,pno int
		,productno nvarchar(30)
		,product nvarchar(50)
		,dime float
		,width float
		
		--期初
		,mount01 float
		,weight01 decimal(15,4)
		,price01 float
		,money01 float 
		--本期進
		,mount02 float
		,weight02 decimal(15,4)
		,price02 float
		,money02 float
		--本期入庫
		,mount03 float
		,weight03 decimal(15,4)
		,price03 float
		,money03 float
		--本期領
		,mount04 float
		,weight04 decimal(15,4)
		,price04 float
		,money04 float
		--本期出
		,mount05 float
		,weight05 decimal(15,4)
		,price05 float
		,money05 float
		--期末
		,mountZ float
		,weightZ float
		,priceZ float
		,moneyZ float
	)
	insert into @tmpc(gno,pno,productno,product,dime,width
		,mount01,mount02,mount03,mount04,mount05,mountZ
		,weight01,weight02,weight03,weight04,weight05,weightZ
		,money01,money02,money03,money04,money05,moneyZ)
	select '1',1,productno,product,dime,width
		,sum(isnull(mount01,0)),sum(isnull(mount02,0)),sum(isnull(mount03,0)),sum(isnull(mount04,0)),sum(isnull(mount05,0)),sum(isnull(mountZ,0))
		,sum(isnull(weight01,0)),sum(isnull(weight02,0)),sum(isnull(weight03,0)),sum(isnull(weight04,0)),sum(isnull(weight05,0)),sum(isnull(weightZ,0))
		,sum(isnull(money01,0)),sum(isnull(money02,0)),sum(isnull(money03,0)),sum(isnull(money04,0)),sum(isnull(money05,0)),sum(isnull(moneyZ,0))
	from @tmpb 
	group by productno,product,dime,width
	--------------------------------------------------------------------------------------------
	insert into @tmpc(gno,pno
		,mount01,mount02,mount03,mount04,mount05,mountZ
		,weight01,weight02,weight03,weight04,weight05,weightZ
		,money01,money02,money03,money04,money05,moneyZ)
	select '2',2
		,sum(isnull(mount01,0)),sum(isnull(mount02,0)),sum(isnull(mount03,0)),sum(isnull(mount04,0)),sum(isnull(mount05,0)),sum(isnull(mountZ,0))
		,sum(isnull(weight01,0)),sum(isnull(weight02,0)),sum(isnull(weight03,0)),sum(isnull(weight04,0)),sum(isnull(weight05,0)),sum(isnull(weightZ,0))
		,sum(isnull(money01,0)),sum(isnull(money02,0)),sum(isnull(money03,0)),sum(isnull(money04,0)),sum(isnull(money05,0)),sum(isnull(moneyZ,0))
	from @tmpb
	
	update @tmpc set price01 = case when ISNULL(weight01,0)>0 then ROUND(money01/weight01,2) else null end
		,price02 = case when ISNULL(weight02,0)>0 then ROUND(money02/weight02,2) else null end
		,price03 = case when ISNULL(weight03,0)>0 then ROUND(money03/weight03,2) else null end
		,price04 = case when ISNULL(weight04,0)>0 then ROUND(money04/weight04,2) else null end
		,price05 = case when ISNULL(weight05,0)>0 then ROUND(money05/weight05,2) else null end
		,priceZ = case when ISNULL(weightZ,0)>0 then ROUND(moneyZ/weightZ,2) else null end
	select gno
		,productno a01
		,product a02
		,dime a03
		,width a04
		,dbo.getComma(weight01,-1) b01
		,dbo.getComma(price01,-1) b02
		,dbo.getComma(money01,-1) b03
		
		,dbo.getComma(weight02,-1) b04
		,dbo.getComma(price02,-1) b05
		,dbo.getComma(money02,-1) b06
		
		,dbo.getComma(weight03,-1) b07
		,dbo.getComma(price03,-1) b08
		,dbo.getComma(money03,-1) b09
		
		,dbo.getComma(weight04,-1) b10
		,dbo.getComma(price04,-1) b11
		,dbo.getComma(money04,-1) b12
		
		,dbo.getComma(weight05,-1) b13
		,dbo.getComma(price05,-1) b14
		,dbo.getComma(money05,-1) b15
		
		,dbo.getComma(weightZ,-1) b16
		,dbo.getComma(priceZ,-1) b17
		,dbo.getComma(moneyZ,-1) b18
	from @tmpc order by sel
	
	drop table #z_uccg02;


z_uccg1:--z_uccg1	
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bproductno nvarchar(30)
	declare @t_eproductno nvarchar(30)
	declare @t_typea nvarchar(15)
	
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bproductno = case when '#non'=[4] then '' else [4] end
	set @t_eproductno = case when '#non'=[5] then char(255) else [5] end
	set @t_typea = case when '#non'=[6] then '' else [6] end
----------------------------------------------------------------------------------------------------------------
IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
	set @cmd = 'drop table #tmp'
	EXECUTE sp_executesql @cmd
END

IF OBJECT_ID('tempdb..#tmpa')is not null
BEGIN
	set @cmd = 'drop table #tmpa'
	EXECUTE sp_executesql @cmd
END

IF OBJECT_ID('tempdb..#tmpr')is not null
BEGIN
	set @cmd = 'drop table #tmpr'
	EXECUTE sp_executesql @cmd
END

IF OBJECT_ID('tempdb..#tmpv')is not null
BEGIN
	set @cmd = 'drop table #tmpv'
	EXECUTE sp_executesql @cmd
END

IF OBJECT_ID('tempdb..#tmpu')is not null 
BEGIN 
	set @cmd = 'drop table #tmpu' 
	EXECUTE sp_executesql @cmd 
END 

create table #tmp(
	gno nvarchar(1), 
	pno nvarchar(50), 
	product nvarchar(50), 
	unit nvarchar(10), 
	bmount decimal(18, 2),
	bweight decimal(18, 2),
	bmoney decimal(18, 2),
	rcmount decimal(18, 2),
	rcweight decimal(18, 2),
	rcmoney decimal(18, 2),
	vcmount decimal(18, 2),
	vcweight decimal(18, 2),
	vcmoney decimal(18, 2),
	vccost decimal(18, 2),
	profit decimal(18, 2),
	lmount decimal(18, 2),
	lweight decimal(18, 2),
	lprice decimal(18, 2),
	lmoney decimal(18, 2) 
) 

create table #tmpa( 
	tablea nvarchar(50),
	noa nvarchar(20),
	noq nvarchar(20),
	datea nvarchar(10),
	pno nvarchar(50),
	storeno nvarchar(50),
	mount decimal(18, 2), 
	weight decimal(18, 2),
	money float,
	PRIMARY KEY(tablea,noa,noq,datea,pno)
) 

create table #tmpu( 
	mdate nvarchar(50), 
	noa nvarchar(50), 
	storeno nvarchar(100), 
	productno nvarchar(100)
) 

insert #tmpu
select MAX(datea)mdate,MAX(noa)noa,storeno,productno 
from view_ucces where datea<= @t_bdate group by storeno,productno

--期初
insert #tmpa--插入期初最後盤點(以查詢日的最後一次盤存)
select 'ucce',a.noa,b.noq,a.datea,b.productno,b.storeno,b.mount,b.eweight,b.total 
from view_ucce a left join view_ucces b on a.noa=b.noa 
left join #tmpu c on b.storeno=c.storeno and b.productno=c.productno 
where a.datea<=@t_bdate and a.noa=c.noa and a.datea=c.mdate
and (b.productno  between @t_bproductno and @t_eproductno)
and exists (select * from view_ucaucc where noa=b.productno)

delete a
from #tmpa a 
outer apply (select MAX(datea)datea from #tmpa where pno=a.pno and storeno=a.storeno)b
where a.datea!=b.datea

--有盤點-插入盤點之後且資料起始日之前的資料
insert #tmpa
select 'rc2',ra.noa,rb.noq,ra.datea,rb.productno,rb.storeno
,(case when ra.typea='1' then 1 else -1 end)*rb.mount
,(case when ra.typea='1' then 1 else -1 end)*rb.weight
,(case when ra.typea='1' then 1 else -1 end)*rb.total/(case when ra.taxtype='3' then 1.05 else 1 end) 
from view_rc2 ra left join view_rc2s rb on ra.noa=rb.noa 
where exists(select * from #tmpa where tablea='ucce' and storeno=rb.storeno and pno=rb.productno)
and ra.datea<@t_bdate and ra.datea>=(select MAX(datea) from #tmpa where pno=rb.productno and storeno=rb.storeno and tablea='ucce')
and rb.productno!='' and (rb.productno  between @t_bproductno and @t_eproductno)
and exists (select * from view_ucaucc where noa=rb.productno)

insert #tmpa
select 'vcc',va.noa,vb.noq,va.datea,vb.productno,vb.storeno
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount
,-1*(case when va.typea='1' then 1 else -1 end)*vb.weight
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount*
isnull((select price from view_costs where productno=vb.productno and mon=left(va.datea,6)),0) 
from view_vcc va left join view_vccs vb on va.noa=vb.noa 
where exists(select * from #tmpa where tablea='ucce' and storeno=vb.storeno and pno=vb.productno)
and va.datea<@t_bdate and va.datea>=(select MAX(datea) from #tmpa where pno=vb.productno and storeno=vb.storeno and tablea='ucce')
and vb.productno!='' and (vb.productno  between @t_bproductno and @t_eproductno)
and exists (select * from view_ucaucc where noa=vb.productno)

--調整
insert #tmpa
select 'ina',ia.noa,ib.noq,ia.datea,ib.productno,ia.storeno,ib.mount,ib.weight,ib.total
from view_ina ia left join view_inas ib on ia.noa=ib.noa 
left join view_ucaucc c on ib.productno=c.noa 
where exists (select * from #tmpa where tablea='ucce' and storeno=ia.storeno and pno=ib.productno) 
and ia.datea<@t_bdate and ia.datea>=(select MAX(datea) from #tmpa where pno=ib.productno and storeno=ia.storeno and tablea='ucce')
and ib.productno!='' and (ib.productno  between @t_bproductno and @t_eproductno)
and exists (select * from view_ucaucc where noa=ib.productno)

insert #tmpa
select 'get',ga.noa,gb.noq,ga.datea,gb.productno,ga.storeno,-1*gb.mount,-1*gb.weight,-1*gb.mount
*isnull((select price from view_costs where productno=gb.productno and mon=left(ga.datea,6)),0) 
from view_get ga left join view_gets gb on ga.noa=gb.noa 
left join view_ucaucc c on gb.productno=c.noa 
where exists (select * from #tmpa where tablea='ucce' and storeno=ga.storeno and pno=gb.productno) 
and ga.datea<@t_bdate and ga.datea>=(select MAX(datea) from #tmpa where pno=gb.productno and storeno=ga.storeno and tablea='ucce')
and gb.productno!='' and (gb.productno  between @t_bproductno and @t_eproductno)
and exists (select * from view_ucaucc where noa=gb.productno)

--無盤點-插入資料起始日之前的資料
insert #tmpa
select 'rc2',ra.noa,rb.noq,ra.datea,rb.productno,rb.storeno
,(case when ra.typea='1' then 1 else -1 end)*rb.mount
,(case when ra.typea='1' then 1 else -1 end)*rb.weight
,(case when ra.typea='1' then 1 else -1 end)*rb.total/(case when ra.taxtype='3' then 1.05 else 1 end)
from view_rc2 ra left join view_rc2s rb on ra.noa=rb.noa 
where not exists (select * from #tmpa where tablea='ucce' and storeno=rb.storeno and pno=rb.productno)
and ra.datea<@t_bdate and rb.productno!='' and (rb.productno  between @t_bproductno and @t_eproductno)
and exists (select * from view_ucaucc where noa=rb.productno)

insert #tmpa
select 'vcc',va.noa,vb.noq,va.datea,vb.productno,vb.storeno
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount
,-1*(case when va.typea='1' then 1 else -1 end)*vb.weight
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount*
isnull((select price from view_costs where productno=vb.productno and mon=left(va.datea,6)),0) 
from view_vcc va left join view_vccs vb on va.noa=vb.noa 
where not exists (select * from #tmpa where tablea='ucce' and storeno=vb.storeno and pno=vb.productno)
and va.datea<@t_bdate and vb.productno!='' and (vb.productno  between @t_bproductno and @t_eproductno)
and exists (select * from view_ucaucc where noa=vb.productno)

--調整
insert #tmpa
select 'ina',ia.noa,ib.noq,ia.datea,ib.productno,ia.storeno,ib.mount,ib.weight,ib.total
from view_ina ia left join view_inas ib on ia.noa=ib.noa 
left join view_ucaucc c on ib.productno=c.noa 
where not exists (select * from #tmpa where tablea='ucce' and storeno=ia.storeno and pno=ib.productno) 
and ia.datea<@t_bdate and ib.productno!='' and (ib.productno  between @t_bproductno and @t_eproductno)
and exists (select * from view_ucaucc where noa=ib.productno)

insert #tmpa
select 'get',ga.noa,gb.noq,ga.datea,gb.productno,ga.storeno,-1*gb.mount,-1*gb.weight,-1*gb.mount
*isnull((select price from view_costs where productno=gb.productno and mon=left(ga.datea,6)),0) 
from view_get ga left join view_gets gb on ga.noa=gb.noa 
left join view_ucaucc c on gb.productno=c.noa 
where not exists (select * from #tmpa where tablea='ucce' and storeno=ga.storeno and pno=gb.productno) 
and ga.datea<@t_bdate and gb.productno!='' and (gb.productno  between @t_bproductno and @t_eproductno)
and exists (select * from view_ucaucc where noa=gb.productno)

--105/03/28 避免倉庫盤點不同時 故計算調撥庫存數
insert #tmpa
select 'cng',ca.noa,cb.noq+'1',ca.datea,cb.productno,ca.storeno,-1*cb.mount,-1*cb.weight
,-1*cb.mount*isnull((select price from view_costs where productno=cb.productno and mon=left(ca.datea,6)),0) 
from view_cng ca left join view_cngs cb on ca.noa=cb.noa
where exists(select * from #tmpa where tablea='ucce' and storeno=ca.storeno and pno=cb.productno)
and ca.datea<@t_bdate and ca.datea>=(select MAX(datea) from #tmpa where pno=cb.productno and storeno=ca.storeno and tablea='ucce')
and cb.productno!='' and (cb.productno  between @t_bproductno and @t_eproductno)
and exists (select * from view_ucaucc where noa=cb.productno)

insert #tmpa
select 'cng',ca.noa,cb.noq+'2',ca.datea,cb.productno,ca.storeinno,cb.mount,cb.weight
,cb.mount*isnull((select price from view_costs where productno=cb.productno and mon=left(ca.datea,6)),0) 
from view_cng ca left join view_cngs cb on ca.noa=cb.noa
where exists(select * from #tmpa where tablea='ucce' and storeno=ca.storeinno and pno=cb.productno)
and ca.datea<@t_bdate and ca.datea>=(select MAX(datea) from #tmpa where pno=cb.productno and storeno=ca.storeinno and tablea='ucce')
and cb.productno!='' and (cb.productno  between @t_bproductno and @t_eproductno)
and exists (select * from view_ucaucc where noa=cb.productno)

insert #tmpa
select 'cng',ca.noa,cb.noq+'1',ca.datea,cb.productno,ca.storeno,-1*cb.mount,-1*cb.weight
,-1*cb.mount*isnull((select price from view_costs where productno=cb.productno and mon=left(ca.datea,6)),0) 
from view_cng ca left join view_cngs cb on ca.noa=cb.noa
where not exists (select * from #tmpa where tablea='ucce' and storeno=ca.storeno and pno=cb.productno) 
and ca.datea<@t_bdate and cb.productno!='' and (cb.productno  between @t_bproductno and @t_eproductno)
and exists (select * from view_ucaucc where noa=cb.productno)

insert #tmpa
select 'cng',ca.noa,cb.noq+'2',ca.datea,cb.productno,ca.storeinno,cb.mount,cb.weight
,cb.mount*isnull((select price from view_costs where productno=cb.productno and mon=left(ca.datea,6)),0) 
from view_cng ca left join view_cngs cb on ca.noa=cb.noa
where not exists (select * from #tmpa where tablea='ucce' and storeno=ca.storeinno and pno=cb.productno) 
and ca.datea<@t_bdate and cb.productno!='' and (cb.productno  between @t_bproductno and @t_eproductno)
and exists (select * from view_ucaucc where noa=cb.productno)
 
--********************************************************************************************
--插入期初庫存
insert into #tmp(gno,pno,product,unit,bmount,bweight,bmoney)
select '0',a.pno,MAX(b.product),MAX(b.unit),sum(a.mount),sum(a.weight),sum(a.money) 
from #tmpa a left join view_ucaucc b on a.pno=b.noa
where (len(@t_typea)=0 or @t_typea=isnull(b.typea,'null')) and (a.pno between @t_bproductno and @t_eproductno) 
group by a.pno

create table #tmpr(
	pno nvarchar(50),
	product nvarchar(100),
	unit nvarchar(50),
	rmount decimal(18, 2),
	rweight decimal(18, 2),
	rmoney decimal(18, 2)
) 

--插入有盤存的進貨數量
insert into #tmpr
select rb.productno,MAX(a.product),MAX(a.unit)
,sum((case when ra.typea='1' then 1 else -1 end)*rb.mount)
,sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) 
,sum((case when ra.typea='1' then 1 else -1 end)*rb.total/(case when ra.taxtype='3' then 1.05 else 1 end))
from view_rc2 ra left join view_rc2s rb on ra.noa=rb.noa 
left join view_ucaucc a on rb.productno=a.noa
where exists (select pno from #tmpa where tablea='ucce' and pno=rb.productno and storeno=rb.storeno)
and ra.datea>(select MAX(datea) from #tmpa where pno=rb.productno and storeno=rb.storeno)
and ra.datea<=@t_edate and (len(@t_typea)=0 or @t_typea=a.typea) 
and (rb.productno between @t_bproductno and @t_eproductno) and rb.productno!=''
and exists (select * from view_ucaucc where noa=rb.productno)
group by rb.productno

insert into #tmpr
select ib.productno,MAX(c.product),MAX(c.unit),sum(ib.mount),sum(ib.weight) ,sum(ib.total)
from view_ina ia left join view_inas ib on ia.noa=ib.noa 
left join view_ucaucc c on ib.productno=c.noa
where exists (select pno from #tmpa where tablea='ucce' and pno=ib.productno and storeno=ia.storeno) 
and ia.datea>(select MAX(datea) from #tmpa where pno=ib.productno and storeno=ia.storeno)
and ia.datea<=@t_edate and (ib.productno between @t_bproductno and @t_eproductno) and ib.productno!=''
and (len(@t_typea)=0 or @t_typea=c.typea) 
and exists (select * from view_ucaucc where noa=ib.productno)
group by ib.productno

--插入沒有盤存的進貨數量
insert into #tmpr
select rb.productno,MAX(a.product),MAX(a.unit)
,sum((case when ra.typea='1' then 1 else -1 end)*rb.mount)
,sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) 
,sum((case when ra.typea='1' then 1 else -1 end)*rb.total/(case when ra.taxtype='3' then 1.05 else 1 end))
from view_rc2 ra left join view_rc2s rb on ra.noa=rb.noa 
left join view_ucaucc a on rb.productno=a.noa
where not exists (select pno from #tmpa where tablea='ucce' and pno=rb.productno and storeno=rb.storeno)
and (ra.datea between @t_bdate and @t_edate) and (len(@t_typea)=0 or @t_typea=a.typea)
and (rb.productno between @t_bproductno and @t_eproductno)  and rb.productno!=''
and exists (select * from view_ucaucc where noa=rb.productno)
group by rb.productno

insert into #tmpr
select ib.productno,MAX(c.product),MAX(c.unit),sum(ib.mount),sum(ib.weight) ,sum(ib.total)
from view_ina ia left join view_inas ib on ia.noa=ib.noa 
left join view_ucaucc c on ib.productno=c.noa
where not exists(select pno from #tmpa where tablea='ucce' and pno=ib.productno and storeno=ia.storeno) 
and (ia.datea between @t_bdate and @t_edate)
and (ib.productno between @t_bproductno and @t_eproductno) and ib.productno!=''
and (len(@t_typea)=0 or @t_typea=c.typea) 
and exists (select * from view_ucaucc where noa=ib.productno)
group by ib.productno

create table #tmpv(
	pno nvarchar(50),
	product nvarchar(100),
	unit nvarchar(50),
	vmount decimal(18, 2),
	vweight decimal(18, 2),
	vmoney decimal(18, 2),
	vcost decimal(18, 2)
)

--插入有盤存的出貨數量
insert into #tmpv
select vb.productno,a.product,a.unit
,(case when va.typea='1' then 1 else -1 end)*vb.mount
,(case when va.typea='1' then 1 else -1 end)*vb.weight 
,(case when va.typea='1' then 1 else -1 end)*vb.total/(case when va.taxtype='3' then 1.05 else 1 end)
,(case when va.typea='1' then 1 else -1 end)*vb.mount*isnull((select price from view_costs where productno=vb.productno and mon=left(va.datea,6)),0)
from view_vcc va left join view_vccs vb on va.noa=vb.noa 
left join view_ucaucc a on vb.productno=a.noa
where exists (select pno from #tmpa where tablea='ucce' and pno=vb.productno and storeno=vb.storeno)
and va.datea>(select MAX(datea) from #tmpa where pno=vb.productno and storeno=vb.storeno)
and va.datea<=@t_edate and (len(@t_typea)=0 or @t_typea=a.typea) 
and (vb.productno between @t_bproductno and @t_eproductno) and vb.productno!=''
and exists (select * from view_ucaucc where noa=vb.productno)
--group by vb.productno

insert into #tmpv
select gb.productno,c.product,c.unit,gb.mount,gb.weight
,gb.mount*isnull((select price from view_costs where productno=gb.productno and mon=left(ga.datea,6)),0)
,gb.mount*isnull((select price from view_costs where productno=gb.productno and mon=left(ga.datea,6)),0)
from view_get ga left join view_gets gb on ga.noa=gb.noa 
left join view_ucaucc c on gb.productno=c.noa
where exists(select pno from #tmpa where tablea='ucce' and pno=gb.productno and storeno=ga.storeno) 
and ga.datea>(select MAX(datea) from #tmpa where pno=gb.productno and storeno=ga.storeno)
and ga.datea<=@t_edate and (gb.productno between @t_bproductno and @t_eproductno) and gb.productno!=''
and (len(@t_typea)=0 or @t_typea=c.typea)  
and exists (select * from view_ucaucc where noa=gb.productno)
--group by gb.productno

--插入沒有盤存的出貨數量
insert into #tmpv
select vb.productno,a.product,a.unit
,(case when va.typea='1' then 1 else -1 end)*vb.mount
,(case when va.typea='1' then 1 else -1 end)*vb.weight 
,(case when va.typea='1' then 1 else -1 end)*vb.total/(case when va.taxtype='3' then 1.05 else 1 end)
,(case when va.typea='1' then 1 else -1 end)*vb.mount*isnull((select price from view_costs where productno=vb.productno and mon=left(va.datea,6)),0) 
from view_vcc va left join view_vccs vb on va.noa=vb.noa 
left join view_ucaucc a on vb.productno=a.noa
where not exists (select pno from #tmpa where tablea='ucce' and pno=vb.productno and storeno=vb.storeno)
and (va.datea between @t_bdate and @t_edate) and (len(@t_typea)=0 or @t_typea=a.typea)
and (vb.productno between @t_bproductno and @t_eproductno)  and vb.productno!=''
and exists (select * from view_ucaucc where noa=vb.productno)
--group by vb.productno

insert into #tmpv
select gb.productno,c.product,c.unit,gb.mount,gb.weight
,gb.mount*isnull((select price from view_costs where productno=gb.productno and mon=left(ga.datea,6)),0)
,gb.mount*isnull((select price from view_costs where productno=gb.productno and mon=left(ga.datea,6)),0)
from view_get ga left join view_gets gb on ga.noa=gb.noa 
left join view_ucaucc c on gb.productno=c.noa
where not exists(select pno from #tmpa where tablea='ucce' and pno=gb.productno and storeno=ga.storeno) 
and (ga.datea between @t_bdate and @t_edate)
and (gb.productno between @t_bproductno and @t_eproductno) and gb.productno!=''
and (len(@t_typea)=0 or @t_typea=c.typea) 
and exists (select * from view_ucaucc where noa=gb.productno)
--group by gb.productno

--插入沒有期初的資料
insert into #tmp(gno,pno,product,unit,bmount,bweight,bmoney)
select '0',*,0,0,0 from 
(select pno,product,unit from #tmpr union
select pno,product,unit from #tmpv)tmps 
where not exists (select pno from #tmp where tmps.pno=pno)

--更新資料
update a
set a.rcmount=isnull((select sum(rmount) from #tmpr where pno=a.pno),0)
,a.rcweight=isnull((select sum(rweight) from #tmpr where pno=a.pno),0)
,a.rcmoney=isnull((select sum(rmoney) from #tmpr where pno=a.pno),0)
,a.vcmount=isnull((select sum(vmount) from #tmpv where pno=a.pno),0)
,a.vcweight=isnull((select sum(vweight) from #tmpv where pno=a.pno),0)
,a.vcmoney=isnull((select sum(vmoney) from #tmpv where pno=a.pno),0)
,a.vccost=isnull((select sum(vcost) from #tmpv where pno=a.pno),0)
from #tmp a

--毛利率
update #tmp
set profit=case when vcmoney=0 then 0 else ((vcmoney-vccost)/vcmoney)*100 end

--計算期末******************************************************************
delete #tmpa
delete #tmpu

insert #tmpu
select MAX(datea)mdate,MAX(noa)noa,storeno,productno 
from view_ucces where datea<= @t_edate group by storeno,productno

insert #tmpa--插入期初最後盤點(以查詢日的最後一次盤存)
select 'ucce',a.noa,b.noq,a.datea,b.productno,b.storeno,b.mount,b.eweight,b.total 
from view_ucce a left join view_ucces b on a.noa=b.noa 
left join #tmpu c on b.storeno=c.storeno and b.productno=c.productno 
where a.datea<=@t_edate and a.noa=c.noa and a.datea=c.mdate
and (b.productno  between @t_bproductno and @t_eproductno)
and exists (select * from view_ucaucc where noa=b.productno)

delete a
from #tmpa a 
outer apply (select MAX(datea)datea from #tmpa where pno=a.pno and storeno=a.storeno)b
where a.datea!=b.datea

--有盤點-插入盤點之後且資料起始日之前的資料
insert #tmpa
select 'rc2',ra.noa,rb.noq,ra.datea,rb.productno,rb.storeno
,(case when ra.typea='1' then 1 else -1 end)*rb.mount
,(case when ra.typea='1' then 1 else -1 end)*rb.weight
,(case when ra.typea='1' then 1 else -1 end)*rb.total/(case when ra.taxtype='3' then 1.05 else 1 end) 
from view_rc2 ra left join view_rc2s rb on ra.noa=rb.noa 
where exists(select * from #tmpa where tablea='ucce' and storeno=rb.storeno and pno=rb.productno)
and ra.datea<=@t_edate and ra.datea>=(select MAX(datea) from #tmpa where pno=rb.productno and storeno=rb.storeno and tablea='ucce')
and rb.productno!='' and (rb.productno  between @t_bproductno and @t_eproductno)
and exists (select * from view_ucaucc where noa=rb.productno)

insert #tmpa
select 'vcc',va.noa,vb.noq,va.datea,vb.productno,vb.storeno
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount
,-1*(case when va.typea='1' then 1 else -1 end)*vb.weight
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount*
isnull((select price from view_costs where productno=vb.productno and mon=left(va.datea,6)),0) 
from view_vcc va left join view_vccs vb on va.noa=vb.noa 
where exists(select * from #tmpa where tablea='ucce' and storeno=vb.storeno and pno=vb.productno)
and va.datea<=@t_edate and va.datea>=(select MAX(datea) from #tmpa where pno=vb.productno and storeno=vb.storeno and tablea='ucce')
and vb.productno!='' and (vb.productno  between @t_bproductno and @t_eproductno)
and exists (select * from view_ucaucc where noa=vb.productno)

--調整
insert #tmpa
select 'ina',ia.noa,ib.noq,ia.datea,ib.productno,ia.storeno,ib.mount,ib.weight,ib.total
from view_ina ia left join view_inas ib on ia.noa=ib.noa 
left join view_ucaucc c on ib.productno=c.noa 
where exists (select * from #tmpa where tablea='ucce' and storeno=ia.storeno and pno=ib.productno) 
and ia.datea<=@t_edate and ia.datea>=(select MAX(datea) from #tmpa where pno=ib.productno and storeno=ia.storeno and tablea='ucce')
and ib.productno!='' and (ib.productno  between @t_bproductno and @t_eproductno)
and exists (select * from view_ucaucc where noa=ib.productno)

insert #tmpa
select 'get',ga.noa,gb.noq,ga.datea,gb.productno,ga.storeno,-1*gb.mount,-1*gb.weight,-1*gb.mount
*isnull((select price from view_costs where productno=gb.productno and mon=left(ga.datea,6)),0) 
from view_get ga left join view_gets gb on ga.noa=gb.noa 
left join view_ucaucc c on gb.productno=c.noa 
where exists (select * from #tmpa where tablea='ucce' and storeno=ga.storeno and pno=gb.productno) 
and ga.datea<=@t_edate and ga.datea>=(select MAX(datea) from #tmpa where pno=gb.productno and storeno=ga.storeno and tablea='ucce')
and gb.productno!='' and (gb.productno  between @t_bproductno and @t_eproductno)
and exists (select * from view_ucaucc where noa=gb.productno)

--無盤點-插入資料起始日之前的資料
insert #tmpa
select 'rc2',ra.noa,rb.noq,ra.datea,rb.productno,rb.storeno
,(case when ra.typea='1' then 1 else -1 end)*rb.mount
,(case when ra.typea='1' then 1 else -1 end)*rb.weight
,(case when ra.typea='1' then 1 else -1 end)*rb.total/(case when ra.taxtype='3' then 1.05 else 1 end)
from view_rc2 ra left join view_rc2s rb on ra.noa=rb.noa 
where not exists (select * from #tmpa where tablea='ucce' and storeno=rb.storeno and pno=rb.productno)
and ra.datea<=@t_edate and rb.productno!='' and (rb.productno  between @t_bproductno and @t_eproductno)
and exists (select * from view_ucaucc where noa=rb.productno)

insert #tmpa
select 'vcc',va.noa,vb.noq,va.datea,vb.productno,vb.storeno
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount
,-1*(case when va.typea='1' then 1 else -1 end)*vb.weight
,-1*(case when va.typea='1' then 1 else -1 end)*vb.mount*
isnull((select price from view_costs where productno=vb.productno and mon=left(va.datea,6)),0) 
from view_vcc va left join view_vccs vb on va.noa=vb.noa 
where not exists (select * from #tmpa where tablea='ucce' and storeno=vb.storeno and pno=vb.productno)
and va.datea<=@t_edate and vb.productno!='' and (vb.productno  between @t_bproductno and @t_eproductno)
and exists (select * from view_ucaucc where noa=vb.productno)

--調整
insert #tmpa
select 'ina',ia.noa,ib.noq,ia.datea,ib.productno,ia.storeno,ib.mount,ib.weight,ib.total
from view_ina ia left join view_inas ib on ia.noa=ib.noa 
left join view_ucaucc c on ib.productno=c.noa 
where not exists (select * from #tmpa where tablea='ucce' and storeno=ia.storeno and pno=ib.productno) 
and ia.datea<=@t_edate and ib.productno!='' and (ib.productno  between @t_bproductno and @t_eproductno)
and exists (select * from view_ucaucc where noa=ib.productno)

insert #tmpa
select 'get',ga.noa,gb.noq,ga.datea,gb.productno,ga.storeno,-1*gb.mount,-1*gb.weight,-1*gb.mount
*isnull((select price from view_costs where productno=gb.productno and mon=left(ga.datea,6)),0) 
from view_get ga left join view_gets gb on ga.noa=gb.noa 
left join view_ucaucc c on gb.productno=c.noa 
where not exists (select * from #tmpa where tablea='ucce' and storeno=ga.storeno and pno=gb.productno) 
and ga.datea<=@t_edate and gb.productno!='' and (gb.productno  between @t_bproductno and @t_eproductno)
and exists (select * from view_ucaucc where noa=gb.productno)

--105/03/28 避免倉庫盤點不同時 故計算調撥庫存數
insert #tmpa
select 'cng',ca.noa,cb.noq+'1',ca.datea,cb.productno,ca.storeno,-1*cb.mount,-1*cb.weight
,-1*cb.mount*isnull((select price from view_costs where productno=cb.productno and mon=left(ca.datea,6)),0) 
from view_cng ca left join view_cngs cb on ca.noa=cb.noa
where exists(select * from #tmpa where tablea='ucce' and storeno=ca.storeno and pno=cb.productno)
and ca.datea<@t_edate and ca.datea>=(select MAX(datea) from #tmpa where pno=cb.productno and storeno=ca.storeno and tablea='ucce')
and cb.productno!='' and (cb.productno  between @t_bproductno and @t_eproductno)
and exists (select * from view_ucaucc where noa=cb.productno)

insert #tmpa
select 'cng',ca.noa,cb.noq+'2',ca.datea,cb.productno,ca.storeinno,cb.mount,cb.weight
,cb.mount*isnull((select price from view_costs where productno=cb.productno and mon=left(ca.datea,6)),0) 
from view_cng ca left join view_cngs cb on ca.noa=cb.noa
where exists(select * from #tmpa where tablea='ucce' and storeno=ca.storeinno and pno=cb.productno)
and ca.datea<@t_edate and ca.datea>=(select MAX(datea) from #tmpa where pno=cb.productno and storeno=ca.storeinno and tablea='ucce')
and cb.productno!='' and (cb.productno  between @t_bproductno and @t_eproductno)
and exists (select * from view_ucaucc where noa=cb.productno)

insert #tmpa
select 'cng',ca.noa,cb.noq+'1',ca.datea,cb.productno,ca.storeno,-1*cb.mount,-1*cb.weight
,-1*cb.mount*isnull((select price from view_costs where productno=cb.productno and mon=left(ca.datea,6)),0) 
from view_cng ca left join view_cngs cb on ca.noa=cb.noa
where not exists (select * from #tmpa where tablea='ucce' and storeno=ca.storeno and pno=cb.productno) 
and ca.datea<@t_edate and cb.productno!='' and (cb.productno  between @t_bproductno and @t_eproductno)
and exists (select * from view_ucaucc where noa=cb.productno)

insert #tmpa
select 'cng',ca.noa,cb.noq+'2',ca.datea,cb.productno,ca.storeinno,cb.mount,cb.weight
,cb.mount*isnull((select price from view_costs where productno=cb.productno and mon=left(ca.datea,6)),0) 
from view_cng ca left join view_cngs cb on ca.noa=cb.noa
where not exists (select * from #tmpa where tablea='ucce' and storeno=ca.storeinno and pno=cb.productno) 
and ca.datea<@t_edate and cb.productno!='' and (cb.productno  between @t_bproductno and @t_eproductno)
and exists (select * from view_ucaucc where noa=cb.productno)


--**************************************************************************

--期末
update a 
set lmount=b.mount,lweight=b.weight,lmoney=b.money
from #tmp a outer apply (select SUM(mount)mount,SUM(weight)weight,SUM(money) money from #tmpa where pno=a.pno) b

update #tmp set lprice=case when lmount=0 then 0 else lmoney/lmount end 

delete #tmp
where bmount=0 and bmoney=0 and rcmount=0 and rcmoney=0 and vcmount=0 and vcmoney=0 and vccost=0 --and bweight=0 and rcweight=0 and vcweight=0

insert into #tmp
select '1','','','',sum(bmount),sum(bweight),sum(bmoney)
,sum(rcmount),sum(rcweight),sum(rcmoney)
,sum(vcmount),sum(vcweight),sum(vcmoney),sum(vccost),case when sum(vcmoney)=0 then 0 else ((sum(vcmoney)-sum(vccost))/sum(vcmoney))*100 end
,sum(lmount),sum(lweight),0,sum(lmoney)
from #tmp

select 
gno,pno,product,unit
,dbo.getComma(bmount,0) bmount
,dbo.getComma(bweight,2) bweight
,dbo.getComma(bmoney,0) bmoney

,dbo.getComma(rcmount,0) rcmount
,dbo.getComma(rcweight,2) rcweight
,dbo.getComma(rcmoney,0) rcmoney

,dbo.getComma(vcmount,0) vcmount
,dbo.getComma(vcweight,2) vcweight
,dbo.getComma(vcmoney,0) vcmoney
,dbo.getComma(vccost,0) vccost
,dbo.getComma(profit,2) profit

,dbo.getComma(lmount,0) lmount
,dbo.getComma(lweight,2) lweight
,dbo.getComma(lprice,2) lprice
,dbo.getComma(lmoney,0) lmoney

,dbo.getComma(lmount-(bmount+rcmount-vcmount),0) dmount
,dbo.getComma(lweight-(bweight+rcweight-vcweight),2) dweight
,dbo.getComma(lmoney-(bmoney+rcmoney-vccost),0) dmoney

from #tmp order by gno,pno

IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
	set @cmd = 'drop table #tmp'
	EXECUTE sp_executesql @cmd
END

IF OBJECT_ID('tempdb..#tmpa')is not null
BEGIN
	set @cmd = 'drop table #tmpa'
	EXECUTE sp_executesql @cmd
END

IF OBJECT_ID('tempdb..#tmpr')is not null
BEGIN
	set @cmd = 'drop table #tmpr'
	EXECUTE sp_executesql @cmd
END

IF OBJECT_ID('tempdb..#tmpv')is not null
BEGIN
	set @cmd = 'drop table #tmpv'
	EXECUTE sp_executesql @cmd
END

IF OBJECT_ID('tempdb..#tmpu')is not null 
BEGIN 
	set @cmd = 'drop table #tmpu' 
	EXECUTE sp_executesql @cmd 
END 
;