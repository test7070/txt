   
z_trana15:--z_trana15
	SET QUOTED_IDENTIFIER OFF 
	declare @cmd nvarchar(max) 
	declare @t_bmon nvarchar(20) = case when '#non'=[31] then '' else [31] end
	declare @t_emon nvarchar(20) = case when '#non'=[32] then char(255) else [32] end
	declare @t_bcustno nvarchar(20) = case when '#non'=[6] then '' else [6] end
	declare @t_ecustno nvarchar(20) = case when '#non'=[7] then char(255) else [7] end
	declare @t_carteamno nvarchar(max) = case when '#non'=[15] then '' else [15] end
	declare @t_calctype nvarchar(max) = case when '#non'=[16] then '' else [16] end
	-------------------------------------------------------------------------------------------------
	declare @tmp table(
		gno nvarchar(10),
		pno nvarchar(10),
		carteamno nvarchar(20),
		--custno nvarchar(20),
		insures float,
		money1 float,
		money2 float,
		custplus float,
		custminus float,
		driverplus float,
		driverminus float,
		reserve float,
		tolls float,
		etc float,
		oil float,
		wmoney float,
		wmoneycar float,
		wmoneyplate float,
		cmoney float,
		dmoney float,
		emoney float,
		ticket float,
		bonus float,
		tax float,
		depreciation float,
		driverpay float,
		profit float,
		tax2 float,
		rate float,
		ordemon nvarchar(max),
		ordetype nvarchar(max),
		ordememo1 nvarchar(max),
		ordememo2 nvarchar(max)
	)
	insert into @tmp(gno,pno,carteamno,insures,money1,money2
		,custplus,custminus,driverplus,driverminus,reserve,tolls,etc,oil
		,wmoney,wmoneycar,wmoneyplate,cmoney,dmoney,emoney,ticket,bonus,tax,depreciation,driverpay)
	select '1','1',isnull(a.carteamno,'')
		,sum(ISNULL(a.insures,0)),sum(ISNULL(a.money1,0)),sum(ISNULL(a.money2,0))
		,sum(ISNULL(a.custplus,0)),sum(ISNULL(a.custminus,0)),sum(ISNULL(a.driverplus,0)),sum(ISNULL(a.driverminus,0))
		,sum(ISNULL(a.reserve,0)),sum(ISNULL(a.tolls,0)),sum(ISNULL(a.etc,0)),sum(ISNULL(a.oil,0))
		,sum(ISNULL(a.wmoney,0)),sum(ISNULL(a.wmoneycar,0)),sum(ISNULL(a.wmoneyplate,0)),sum(ISNULL(a.cmoney,0)),sum(ISNULL(a.dmoney,0)),sum(ISNULL(a.emoney,0))
		,sum(ISNULL(a.ticket,0)),sum(ISNULL(a.bonus,0)),sum(ISNULL(a.tax,0)),sum(ISNULL(a.depreciation,0)) 
		,sum(isnull(a.driverpay,0))
	from trans_sum a 
	left join view_trans b on a.tranaccy=b.accy and a.tranno=b.noa and a.trannoq=b.noq
	where a.mon between @t_bmon and @t_emon
	and (len(@t_carteamno)=0 or CHARINDEX(','+b.carteamno+',',','+@t_carteamno+',')>0)
	and (len(@t_calctype)=0 or CHARINDEX(','+b.calctype+',',','+@t_calctype+',')>0)
	group by isnull(a.carteamno,'')
	
	insert into @tmp(gno,pno,carteamno,insures,money1,money2
		,custplus,custminus,driverplus,driverminus,reserve,tolls,etc,oil
		,wmoney,wmoneycar,wmoneyplate,cmoney,dmoney,emoney,ticket,bonus,tax,depreciation,driverpay)
	select '2','3',CHAR(255),sum(ISNULL(a.insures,0)),sum(ISNULL(a.money1,0)),sum(ISNULL(a.money2,0))
		,sum(ISNULL(a.custplus,0)),sum(ISNULL(a.custminus,0)),sum(ISNULL(a.driverplus,0)),sum(ISNULL(a.driverminus,0))
		,sum(ISNULL(a.reserve,0)),sum(ISNULL(a.tolls,0)),sum(ISNULL(a.etc,0)),sum(ISNULL(a.oil,0))
		,sum(ISNULL(a.wmoney,0)),sum(ISNULL(a.wmoneycar,0)),sum(ISNULL(a.wmoneyplate,0)),sum(ISNULL(a.cmoney,0)),sum(ISNULL(a.dmoney,0)),sum(ISNULL(a.emoney,0))
		,sum(ISNULL(a.ticket,0)),sum(ISNULL(a.bonus,0)),sum(ISNULL(a.tax,0)),sum(ISNULL(a.depreciation,0)) 
		,sum(isnull(a.driverpay,0))
	from @tmp a
	----------------------------------------------------------------------------------------------------
	update @tmp set tax2 = round(money1*0.03,0)
	update @tmp set profit = money1-money2-insures+custplus-custminus-driverplus+driverminus-reserve-tolls
		-etc-oil-wmoney-cmoney-dmoney-emoney-ticket-bonus-tax-depreciation+driverpay-tax2
	update @tmp set rate = case money1 when 0 then 0 else round(profit/money1*100,0) end 
	update @tmp set gno = '3' where gno='1' and profit<0
	
	-----------------------------------------------------------------------------------------------------
	--訂單
	declare @curtime datetime
	set @curtime = CURRENT_TIMESTAMP
	declare @curdate nvarchar(10)
	set @curdate = cast(Year(@curtime)-1911 as nvarchar)
		+'/'+ right('00'+cast(Month(@curtime) as nvarchar),2)
		+'/'+ right('00'+cast(Day(@curtime) as nvarchar),2)
	
	declare @curmon nvarchar(10)
	declare @bmon nvarchar(10)
	declare @bbmon nvarchar(10)
	set @curmon = cast(Year(@curtime)-1911 as nvarchar)
		+'/'+ right('00'+cast(Month(@curtime) as nvarchar),2)
	set @bmon =  cast(Year(dateadd(mm,-1,@curtime))-1911 as nvarchar) 
		+'/'+ right('00'+cast(Month(dateadd(mm,-1,@curtime)) as nvarchar),2)
	set @bbmon =  cast(Year(dateadd(mm,-2,@curtime))-1911 as nvarchar) 
		+'/'+ right('00'+cast(Month(dateadd(mm,-2,@curtime)) as nvarchar),2)
	
	declare @tmporde table(
		ctype nvarchar(max),
		ordemon nvarchar(10),
		ordemount float,
		ordeunit nvarchar(max),
		transvccemount float
	)
	declare @ctype nvarchar(max)
	declare @ordemon nvarchar(10)
	declare @ordemount float
	declare @ordeunit nvarchar(max)
	declare @transvccemount float
	
	insert into @tmporde
	 select ctype,LEFT(a.strdate,6),sum(isnull(a.mount,0)),a.unit,sum(isnull(b.mount,0))
	 from view_tranorde a
	 outer apply(
	 	select sum(isnull(x.mount,0)) mount 
	 	from view_transvcces x
	 	left join view_transvcce y on x.noa=y.noa
	 	where y.ordeno=a.noa) b
	 where LEFT(a.strdate,6)=@curmon
	 group by ctype,LEFT(a.strdate,6),unit
	 having sum(isnull(a.mount,0))!=0
	
	declare @tmporde2 table(
		ctype nvarchar(max),
		ordemon nvarchar(10),
		ordememo1 nvarchar(max),
		ordememo2 nvarchar(max)
	)
	insert into @tmporde2(ctype,ordemon)
	select ctype,mon
	from(select ctype from @tmporde group by ctype) a,
	--(select @curmon mon union all select @bmon union all select @bbmon)b
	(select @curmon mon)b
	order by ctype,mon
	
	declare cursor_table cursor for
	select ctype,ordemon,ordemount,ordeunit,transvccemount from @tmporde
	open cursor_table
	fetch next from cursor_table
	into @ctype,@ordemon,@ordemount,@ordeunit,@transvccemount
	while(@@FETCH_STATUS <> -1)
	begin	
		update @tmporde2 set ordememo1 = ISNULL(ordememo1,'')
			+ case when len(ISNULL(ordememo1,''))=0 then '' else ', 'end
			+ CAST(@ordemount as nvarchar)+@ordeunit
		where ctype=@ctype and ordemon=@ordemon
		if(@ordemount-@transvccemount>0 and @ctype='貨櫃')
		begin
			update @tmporde2 set ordememo2 = ISNULL(ordememo2,'')
				+ case when len(ISNULL(ordememo2,''))=0 then '未派 ' else ', 'end
				+ CAST(@ordemount-@transvccemount as nvarchar)+@ordeunit
			where ctype=@ctype and ordemon=@ordemon
		end
		fetch next from cursor_table
		into @ctype,@ordemon,@ordemount,@ordeunit,@transvccemount
	end
	close cursor_table
	deallocate cursor_table	
	
	insert into @tmp(carteamno,gno,pno,ordetype,ordemon,ordememo1,ordememo2)
	select CHAR(255),'4','4'
		,ctype+'訂單',ordemon,ordememo1,ordememo2
	from @tmporde2
	--------------------------------------------------------------------------------------------
	select a.* 
		,b.team 
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.money1),1)),4,12)) a01 --應收運費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.money2),1)),4,12)) a02 --客戶加項
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.custplus),1)),4,12)) a03 --客戶減項
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.custminus),1)),4,12)) a04 --應付運費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.driverplus),1)),4,12)) a05 --司機加項
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.driverminus),1)),4,12)) a06 --司機減項
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.bonus),1)),4,12)) a07 --達成獎金
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.reserve),1)),4,12)) a08--寄櫃費	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.tolls+a.etc),1)),4,12)) a09--通行費	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.oil),1)),4,12)) a10--油費	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.wmoneycar),1)),4,12)) a11--維修	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.wmoneyplate),1)),4,12)) a12--板維修	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.driverpay),1)),4,12)) a13--司機付	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.cmoney),1)),4,12)) a14--輪胎	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.ticket),1)),4,12)) a15--罰單	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.tax),1)),4,12)) a16--保牌燃費	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.depreciation),1)),4,12)) a17--折舊	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.insures),1)),4,12)) a18--勞健保	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.tax2),1)),4,12)) a19--稅捐	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.profit),1)),4,12)) a20--毛利
	from @tmp a 
	left join carteam b on a.carteamno=b.noa
	order by pno,carteamno;

z_trana14:--z_trana14	
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_bmon nvarchar(20) = case when '#non'=[31] then '' else [31] end  --23
	declare @t_emon nvarchar(20) = case when '#non'=[32] then char(255) else [32] end  --23
	declare @t_carno nvarchar(max) = case when '#non'=[12] then '' else [12] end --6
	declare @t_carkind nvarchar(max) = case when '#non'=[14] then '' else [14] end  --8
	declare @t_detail nvarchar(max) = case when '#non'=[22] then '' else [22] end  --16
	declare @t_bdriverno nvarchar(max) = ''
	declare @t_edriverno nvarchar(max) = char(255)
	--------------------------------------------------------------------------------
	declare @t_pageline int = 30  --一頁的行數
	declare @tmp table(
		gno nvarchar(10),
		pno nvarchar(10),
		rno nvarchar(max),
		caryear nvarchar(20),
		carkindno nvarchar(20),
		carkind nvarchar(20),
		oilmount float,
		miles float,
		oilrate float,
		kl float,
		carday float,
		trandate nvarchar(10),
		custno nvarchar(20),
		cust nvarchar(50),
		carno nvarchar(20),
		driverno nvarchar(20),
		driver nvarchar(20),
		insures float,
		money1 float,
		money2 float,
		custplus float,
		custminus float,
		driverplus float,
		driverminus float,
		reserve float,
		tolls float,
		etc float,
		oil float,
		wmoney float,
		wmoneycar float,
		wmoneyplate float,
		cmoney float,
		dmoney float,
		emoney float,
		ticket float,
		bonus float,
		tax float,
		depreciation float,
		tax2 float,--稅捐  money1 * 3%
		driverpay float,
		profit float,
		rate float
	)
	insert into @tmp(gno,pno,carkindno,carkind,carno,insures,money1,money2
		,custplus,custminus,driverplus,driverminus,reserve,tolls,etc,oil
		,wmoney,wmoneycar,wmoneyplate,cmoney,dmoney,emoney,ticket,bonus,tax,depreciation,driverpay)
	select '1','1',isnull(b.carkindno,''),ISNULL(c.kind,''),ISNULL(a.carno,'')
		,sum(ISNULL(a.insures,0)),sum(ISNULL(a.money1,0)),sum(ISNULL(a.money2,0))
		,sum(ISNULL(a.custplus,0)),sum(ISNULL(a.custminus,0)),sum(ISNULL(a.driverplus,0)),sum(ISNULL(a.driverminus,0))
		,sum(ISNULL(a.reserve,0)),sum(ISNULL(a.tolls,0)),sum(ISNULL(a.etc,0)),sum(ISNULL(a.oil,0))
		,sum(ISNULL(a.wmoney,0)),sum(ISNULL(a.wmoneycar,0)),sum(ISNULL(a.wmoneyplate,0)),sum(ISNULL(a.cmoney,0)),sum(ISNULL(a.dmoney,0)),sum(ISNULL(a.emoney,0))
		,sum(ISNULL(a.ticket,0)),sum(ISNULL(a.bonus,0)),sum(ISNULL(a.tax,0)),sum(ISNULL(a.depreciation,0)) 
		,sum(isnull(a.driverpay,0))
	from trans_sum a
	left join car2 b on a.carno=b.carno
	left join carkind c on b.carkindno=c.noa
	where a.mon between @t_bmon and @t_emon
	and b.cartype = '2' --公司車
	and isnull(a.driverno,'') between @t_bdriverno and @t_edriverno
	and (len(@t_carno)=0 or (len(ISNULL(b.carno,''))>0 and CHARINDEX(','+b.carno+',',','+@t_carno+',')>0))
	and (len(@t_carkind)=0 or (len(ISNULL(b.carkindno,''))>0 and CHARINDEX(','+b.carkindno+',',','+@t_carkind+',')>0))
	group by isnull(b.carkindno,''),ISNULL(c.kind,''),ISNULL(a.carno,'')
	
	update @tmp set caryear=b.caryear,oilmount=c.mount,oilrate=case when money1!=0 then oil/money1*100 else 0 end
		,miles=c.miles
		,kl=case when c.mount!=0 then c.miles/c.mount else 0 end
		,carday=d.mount
	from @tmp a
	left join car2 b on a.carno=b.carno
	left join (select carno,SUM(isnull(mount,0)) mount,SUM(ISNULL(miles,0)) miles 
		from oil where LEFT(datea,6) between @t_bmon and @t_emon group by carno) c on a.carno=c.carno
	left join (select carno,count(1) mount 
		from (SELECT DISTINCT isnull(carno,'') carno,trandate from trans_sum where mon between @t_bmon and @t_emon) a 
		group by carno) d on a.carno=d.carno 
	
	insert into @tmp(gno,pno,carkindno,carkind,miles,oilmount,insures,money1,money2
		,custplus,custminus,driverplus,driverminus,reserve,tolls,etc,oil
		,wmoney,wmoneycar,wmoneyplate,cmoney,dmoney,emoney,ticket,bonus,tax,depreciation,driverpay)
	select '2','2',CHAR(255),CHAR(255),SUM(ISNULL(miles,0)),SUM(isnull(oilmount,0)),sum(insures),SUM(money1),SUM(money2)
		,SUM(custplus),SUM(custminus),SUM(driverplus),SUM(driverminus),SUM(reserve),SUM(tolls),SUM(etc),SUM(oil)
		,SUM(wmoney),SUM(wmoneycar),SUM(wmoneyplate),SUM(cmoney),SUM(dmoney),SUM(emoney),SUM(ticket),SUM(bonus),SUM(tax),SUM(depreciation)
		,sum(driverpay)
	from @tmp where pno='1' 
	update @tmp set oilrate=case when money1!=0 then oil/money1*100 else 0 end
		,kl = case when oilmount!=0 then miles/oilmount else 0 end
	where pno='2'
	
	update @tmp set tax2 = round(money1*0.03,0),profit=money1-money2-insures+custplus-custminus-driverplus+driverminus-reserve-tolls
		-etc-oil-wmoney-cmoney-dmoney-emoney-ticket-bonus-tax-depreciation-round(money1*0.03,0)+driverpay
	update @tmp set gno = '4' where profit<0 and pno='1'
	update @tmp set rate=case when money1=0 then 0 else ROUND(profit/money1*100,0) end
	----------------------------------------------------------------------------------------------------
	if len(@t_detail)>0
	begin
		update @tmp set gno='5',rno=case when len(isnull(caryear,''))>0 then '1' else '2' end+isnull(caryear,'')+carno+CHAR(255) where gno='1'
		update @tmp set gno='6',rno=case when len(isnull(caryear,''))>0 then '1' else '2' end+isnull(caryear,'')+carno where gno='4'
		
		insert into @tmp(gno,pno,rno,carkindno,carkind,trandate,custno,cust,carno,driverno,driver,insures,money1,money2
			,custplus,custminus,driverplus,driverminus,reserve,tolls,etc,oil
			,wmoney,wmoneycar,wmoneyplate,cmoney,dmoney,emoney,ticket,bonus,tax,depreciation,driverpay)
		select '7','1'
			,case when len(isnull(b.caryear,''))>0 then '1' else '2' end+isnull(b.caryear,'')+a.carno
			,isnull(b.carkindno,''),ISNULL(c.kind,''),ISNULL(a.trandate,''),ISNULL(a.custno,''),ISNULL(e.nick,'')
			,ISNULL(a.carno,''),ISNULL(a.driverno,''),ISNULL(d.namea,'')
			,ISNULL(a.insures,0),ISNULL(a.money1,0),ISNULL(a.money2,0)
			,ISNULL(a.custplus,0),ISNULL(a.custminus,0),ISNULL(a.driverplus,0),ISNULL(a.driverminus,0)
			,ISNULL(a.reserve,0),ISNULL(a.tolls,0),ISNULL(a.etc,0),ISNULL(a.oil,0)
			,ISNULL(a.wmoney,0),ISNULL(a.wmoneycar,0),ISNULL(a.wmoneyplate,0),ISNULL(a.cmoney,0),ISNULL(a.dmoney,0),ISNULL(a.emoney,0)
			,ISNULL(a.ticket,0),ISNULL(a.bonus,0),ISNULL(a.tax,0),ISNULL(a.depreciation,0) 
			,isnull(a.driverpay,0)
		from trans_sum a
		left join car2 b on a.carno=b.carno
		left join carkind c on b.carkindno=c.noa
		left join driver d on a.driverno=d.noa
		left join cust e on a.custno=e.noa
		where a.mon between @t_bmon and @t_emon
		and b.cartype = '2' --公司車
		and isnull(a.driverno,'') between @t_bdriverno and @t_edriverno
		and (len(@t_carno)=0 or (len(ISNULL(b.carno,''))>0 and CHARINDEX(','+b.carno+',',','+@t_carno+',')>0))
		and (len(@t_carkind)=0 or (len(ISNULL(b.carkindno,''))>0 and CHARINDEX(','+b.carkindno+',',','+@t_carkind+',')>0))
		order by a.trandate
	end
	----------------------------------------------------------------------------------------------------
	select *
	,caryear m01
	,cast(round(oilrate,0) as nvarchar)+'%' m02
	,cast(kl as decimal(10,2)) m03
	,carday m04
	,carno m05
	,driver m06
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money1),1)),4,12))  m07
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,custplus),1)),4,12))  m08
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,custminus),1)),4,12))  m09
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money2),1)),4,12))  m10
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,driverplus),1)),4,12))  m11
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,driverminus),1)),4,12))  m12
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,reserve),1)),4,12))  m13
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)+ISNULL(etc,0)),1)),4,12))  m14
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,oil),1)),4,12))  m15
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ISNULL(wmoney,0)+ISNULL(dmoney,0)+ISNULL(emoney,0)),1)),4,12))  m16
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,wmoneycar),1)),4,12))  ma16
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,wmoneyplate),1)),4,12))  mb16
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ISNULL(cmoney,0)),1)),4,12))  m17
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ticket),1)),4,12))  m18
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bonus),1)),4,12)) m19
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax),1)),4,12))  m20
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,depreciation),1)),4,12))  m21
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,insures),1)),4,12))  m22
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax2),1)),4,12))  m23
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,profit),1)),4,12))  m24
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,driverpay),1)),4,12))  m25
	from @tmp 
	order by case when len(carkindno)=0 then CHAR(255) else carkindno end
		,pno
		,rno
		,caryear
		,case when len(carno)=0 then CHAR(255) else carno end
		;
		
z_trana13:--z_trana13	
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_bmon nvarchar(20) = case when '#non'=[31] then '' else [31] end
	declare @t_emon nvarchar(20) = case when '#non'=[32] then char(255) else [32] end
	declare @t_bcustno nvarchar(20) = case when '#non'=[6] then '' else [6] end
	declare @t_ecustno nvarchar(20) = case when '#non'=[7] then char(255) else [7] end
	declare @t_carteamno nvarchar(max) = case when '#non'=[15] then '' else [15] end
	declare @t_calctype nvarchar(max) = case when '#non'=[16] then '' else [16] end
	-------------------------------------------------------------------------------------------------
	declare @tmp table(
		gno nvarchar(10),
		pno nvarchar(10),
		custno nvarchar(20),
		insures float,
		money1 float,
		money2 float,
		custplus float,
		custminus float,
		driverplus float,
		driverminus float,
		reserve float,
		tolls float,
		etc float,
		oil float,
		wmoney float,
		wmoneycar float,
		wmoneyplate float,
		cmoney float,
		dmoney float,
		emoney float,
		ticket float,
		bonus float,
		tax float,
		depreciation float,
		driverpay float,
		profit float,
		tax2 float,
		rate float
	)
	insert into @tmp(gno,pno,custno,insures,money1,money2
		,custplus,custminus,driverplus,driverminus,reserve,tolls,etc,oil
		,wmoney,wmoneycar,wmoneyplate,cmoney,dmoney,emoney,ticket,bonus,tax,depreciation,driverpay)
	select '1','1',isnull(a.custno,'')
		,sum(ISNULL(a.insures,0)),sum(ISNULL(a.money1,0)),sum(ISNULL(a.money2,0))
		,sum(ISNULL(a.custplus,0)),sum(ISNULL(a.custminus,0)),sum(ISNULL(a.driverplus,0)),sum(ISNULL(a.driverminus,0))
		,sum(ISNULL(a.reserve,0)),sum(ISNULL(a.tolls,0)),sum(ISNULL(a.etc,0)),sum(ISNULL(a.oil,0))
		,sum(ISNULL(a.wmoney,0)),sum(ISNULL(a.wmoneycar,0)),sum(ISNULL(a.wmoneyplate,0)),sum(ISNULL(a.cmoney,0)),sum(ISNULL(a.dmoney,0)),sum(ISNULL(a.emoney,0))
		,sum(ISNULL(a.ticket,0)),sum(ISNULL(a.bonus,0)),sum(ISNULL(a.tax,0)),sum(ISNULL(a.depreciation,0)) 
		,sum(isnull(a.driverpay,0))
	from trans_sum a 
	left join view_trans b on a.tranaccy=b.accy and a.tranno=b.noa and a.trannoq=b.noq
	where a.mon between @t_bmon and @t_emon
	and isnull(a.custno,'') between @t_bcustno and @t_ecustno
	and (len(@t_carteamno)=0 or CHARINDEX(','+b.carteamno+',',','+@t_carteamno+',')>0)
	and (len(@t_calctype)=0 or CHARINDEX(','+b.calctype+',',','+@t_calctype+',')>0)
	group by isnull(a.custno,'')
	
	insert into @tmp(gno,pno,custno,insures,money1,money2
		,custplus,custminus,driverplus,driverminus,reserve,tolls,etc,oil
		,wmoney,wmoneycar,wmoneyplate,cmoney,dmoney,emoney,ticket,bonus,tax,depreciation,driverpay)
	select '2','3',CHAR(255),sum(ISNULL(a.insures,0)),sum(ISNULL(a.money1,0)),sum(ISNULL(a.money2,0))
		,sum(ISNULL(a.custplus,0)),sum(ISNULL(a.custminus,0)),sum(ISNULL(a.driverplus,0)),sum(ISNULL(a.driverminus,0))
		,sum(ISNULL(a.reserve,0)),sum(ISNULL(a.tolls,0)),sum(ISNULL(a.etc,0)),sum(ISNULL(a.oil,0))
		,sum(ISNULL(a.wmoney,0)),sum(ISNULL(a.wmoneycar,0)),sum(ISNULL(a.wmoneyplate,0)),sum(ISNULL(a.cmoney,0)),sum(ISNULL(a.dmoney,0)),sum(ISNULL(a.emoney,0))
		,sum(ISNULL(a.ticket,0)),sum(ISNULL(a.bonus,0)),sum(ISNULL(a.tax,0)),sum(ISNULL(a.depreciation,0)) 
		,sum(isnull(a.driverpay,0))
	from @tmp a
	----------------------------------------------------------------------------------------------------
	update @tmp set tax2 = round(money1*0.03,0)
	update @tmp set profit = money1-money2-insures+custplus-custminus-driverplus+driverminus-reserve-tolls
		-etc-oil-wmoney-cmoney-dmoney-emoney-ticket-bonus-tax-depreciation+driverpay-tax2
	update @tmp set rate = case money1 when 0 then 0 else round(profit/money1*100,0) end 
	update @tmp set gno = '3' where gno='1' and profit<0

	select a.* 
		,b.nick nick
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.money1),1)),4,12)) a01 --應收運費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.money2),1)),4,12)) a02 --客戶加項
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.custplus),1)),4,12)) a03 --客戶減項
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.custminus),1)),4,12)) a04 --應付運費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.driverplus),1)),4,12)) a05 --司機加項
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.driverminus),1)),4,12)) a06 --司機減項
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.bonus),1)),4,12)) a07 --達成獎金
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.reserve),1)),4,12)) a08--寄櫃費	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.tolls+a.etc),1)),4,12)) a09--通行費	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.oil),1)),4,12)) a10--油費	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.wmoneycar),1)),4,12)) a11--維修	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.wmoneyplate),1)),4,12)) a12--板維修	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.driverpay),1)),4,12)) a13--司機付	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.cmoney),1)),4,12)) a14--輪胎	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.ticket),1)),4,12)) a15--罰單	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.tax),1)),4,12)) a16--保牌燃費	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.depreciation),1)),4,12)) a17--折舊	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.insures),1)),4,12)) a18--勞健保	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.tax2),1)),4,12)) a19--稅捐	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.profit),1)),4,12)) a20--毛利
	from @tmp a 
	left join cust b on a.custno=b.noa
	order by pno,profit,custno;

z_trana10:--z_trana10
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_baddrno nvarchar(20)
	declare @t_eaddrno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(max)
	declare @t_po nvarchar(max)
	declare @t_calctype nvarchar(max)
	declare @t_carteam nvarchar(max)
	declare @t_option08 nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_baddrno = case when '#non'=[8] then '' else [8] end
	set @t_eaddrno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_bdriverno = case when '#non'=[10] then '' else [10] end
	set @t_edriverno = case when '#non'=[11] then CHAR(255) else [11] end
	set @t_carno = case when '#non'=[12] then '' else [12] end
	set @t_po = case when '#non'=[13] then '' else [13] end
	set @t_carteam = case when '#non'=[15] then '' else [15] end
	set @t_calctype = case when '#non'=[16] then '' else [16] end
	set @t_option08 = case when '#non'=[39] then '' else [39] end
	----------------------------------------------------------------------------------------------
	declare @string nvarchar(max)
	declare @n int
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carno')is not null
	BEGIN
		set @cmd = 'drop table #carno'
		EXECUTE sp_executesql @cmd
	END
	create table #carno(
		noa nvarchar(20)
	)
	set @string = @t_carno
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carno select @string
			end
			break
		end
		insert into #carno select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#po')is not null
	BEGIN
		set @cmd = 'drop table #po'
		EXECUTE sp_executesql @cmd
	END
	create table #po(
		noa nvarchar(20)
	)
	set @string = @t_po
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #po select @string
			end
			break
		end
		insert into #po select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	declare @mon nvarchar(10)
	declare @datea nvarchar(10)
	declare @custno nvarchar(20)
	declare @nick nvarchar(20)
	declare @carno nvarchar(20)
	declare @driverno nvarchar(20)
	declare @plus float
	declare @minus float
	declare @curplus float
	declare @curminus float
	declare @custplus float
	declare @custminus float
	declare @carplus float
	declare @carminus float
	declare @diffplus float
	declare @diffminus float
	declare @tranno nvarchar(20)
	declare @trannoq nvarchar(10)
	
	declare @fixa float
	declare @tire float
	declare @ticket float
	declare @curfixa float
	declare @curtire float
	declare @curticket float
	declare @carfixa float
	declare @cartire float
	declare @carticket float
	declare @difffixa float
	declare @difftire float
	declare @diffticket float
	
	declare @bonus float
	declare @curbonus float
	declare @carbonus float
	declare @diffbonus float
	
	declare @tax float
	declare @depreciation float
	declare @curtax float
	declare @curdepreciation float
	declare @cartax float
	declare @cardepreciation float
	declare @difftax float
	declare @diffdepreciation float
	
	declare @oil float
	declare @etc float
	declare @curoil float
	declare @curetc float
	declare @caroil float
	declare @caretc float
	declare @diffoil float
	declare @diffetc float
	
	declare @carteamno nvarchar(20)
	declare @carteam nvarchar(20)
	declare @trandate nvarchar(10)
	declare @addrno nvarchar(20)
	declare @addr nvarchar(40)
	--declare @carno nvarchar(20)
	declare @driver nvarchar(20)
	declare @total float
	declare @total2 float
	declare @reserve float
	declare @tolls float
	--declare @custplus float
	--declare @custminus float
	--declare @carplus float
	--declare @carminus float
	--declare @fixa float
	--declare @tire float
	--declare @ticket float
	--declare @bonus float
	--declare @tax float
	--declare @depreciation float
	declare @profit float
	declare @gno nvarchar(10)
	declare @miles float
	----------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_tmp')is not null
	BEGIN
		set @cmd = 'drop table #z_tmp'
		EXECUTE sp_executesql @cmd
	END
	create table #z_tmp(
		isoutside int,
		tranno nvarchar(20),
		trannoq nvarchar(10),
		datea nvarchar(10),
		trandate nvarchar(10),
		carteamno nvarchar(20),
		carteam nvarchar(20),
		calctype nvarchar(20),
		
		custno nvarchar(20),
		custnick nvarchar(20),
		addrno nvarchar(20),
		addr nvarchar(40),
		
		carno nvarchar(20),
		driverno nvarchar(20),
		driver nvarchar(20),
		miles float,
		po nvarchar(max),
		
		mount float,
		price float,
		total float,
		
		mount2 float,
		price2 float,
		price3 float,
		discount float,
		total2 float,
		
		reserve float,
		tolls float,
		memo nvarchar(max),
		
		custplus float,
		custminus float,
		
		carplus float,
		carminus float,
		oil float,
		etc float,
		fixa float,
		tire float,
		ticket float,
		bonus float,
		tax float,
		depreciation float,	
		
		profit float
	)
	set @cmd = 
	" select isnull(c.isoutside,0),a.noa,a.noq,a.datea,a.trandate,isnull(a.carteamno,''),b.team,a.calctype"+
	" ,isnull(a.custno,''),a.nick,a.straddrno,a.straddr"+
	" ,a.carno,a.driverno,a.driver,isnull(a.miles,0),a.po"+
	" ,a.mount,a.price,a.total"+
	" ,a.mount2,a.price2,a.price3,a.discount,a.total2"+
	" ,a.reserve,a.tolls,a.memo"+
	" from view_trans"+@t_accy+" a"+
	" left join carteam b on a.carteamno = b.noa"+
	" left join calctypes c on a.calctype = c.noa+c.noq"+
	" where (left(a.trandate,6) between left(@t_btrandate,6) and left(@t_etrandate,6))"
	
	create index tranno on #z_tmp(tranno,trannoq)
	insert into #z_tmp(isoutside,tranno,trannoq,datea,trandate,carteamno,carteam,calctype
		,custno,custnick,addrno,addr
		,carno,driverno,driver,miles,po
		,mount,price,total
		,mount2,price2,price3,discount,total2
		,reserve,tolls,memo
	)
	execute sp_executesql @cmd,N'@t_btrandate nvarchar(10),@t_etrandate nvarchar(10)'
	,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate
	----------------------------------------------------------------------------------------------
	--客戶加減項
	declare @tmp01 table(
		mon nvarchar(10),
		custno nvarchar(20),
		plus float,
		minus float,
		custplus float,
		custminus float
	)
	insert into @tmp01(mon,custno,plus,minus)
	select LEFT(a.datea,6),isnull(a.custno,''),SUM(ISNULL(plusmoney,0)),SUM(ISNULL(minusmoney,0)) 
	from custchg a
	--排除 代收、付,暫收
	where (left(a.acc1,4)!='2195') and (left(a.acc1,4)!='1191') 
	and (left(a.acc1,4)!='2191') and (left(a.acc1,4)!='1149') 
	and (left(a.acc1,4)!='1194') and (left(a.acc1,4)!='1129') 
	and left(a.datea,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
	group by LEFT(a.datea,6),isnull(a.custno,'')
	--收金額合計
	declare @tmp01_a table(
		mon nvarchar(10),
		custno nvarchar(20),
		total float
	)
	insert into @tmp01_a(mon,custno,total)
	select LEFT(a.trandate,6),isnull(a.custno,''),SUM(ISNULL(total,0)) 
	from #z_tmp a
	group by LEFT(a.trandate,6),isnull(a.custno,'') 
	--依收金額比例分配加減項金額
	update #z_tmp
	set custplus = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.plus,0)/ISNULL(c.total,0),0)end
		,custminus = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.minus,0)/ISNULL(c.total,0),0)end
	from #z_tmp a
	inner join @tmp01 b on left(a.trandate,6)=b.mon and a.custno = b.custno 
	inner join @tmp01_a c on left(a.trandate,6)=c.mon and a.custno = c.custno 
	--檢查有客戶加減項,但當月無收金額的
	insert into #z_tmp(carteamno,custno,trandate,custplus,custminus,addr)
	select 'zzzzz##',a.custno,a.mon,a.plus,a.minus,c.nick+'當月無出車'
	from @tmp01 a
	left join @tmp01_a b on a.mon=b.mon and a.custno=b.custno
	left join cust c on a.custno=c.noa
	where isnull(b.total,0)=0 and (isnull(a.plus,0)!=0 or isnull(a.minus,0)!=0)
	----修正誤差,由收入最高的依序補回一次補1,LOOP
	update @tmp01
	set custplus = ISNULL(b.custplus,0)
		,custminus = ISNULL(b.custminus,0)
	from @tmp01 a
	inner join (select LEFT(ISNULL(trandate,''),6) mon
		,ISNULL(custno,'') custno
		, SUM(ISNULL(custplus,0)) custplus
		,SUM(ISNULL(custminus,0)) custminus 
		from #z_tmp 
		group by LEFT(ISNULL(trandate,''),6),ISNULL(custno,'')) b on a.mon=b.mon and a.custno=b.custno
	
	--修正誤差用
	declare @ztmp01 table(
		recno int,
		custno nvarchar(20),
		mon nvarchar(10),
		tranno nvarchar(20),
		trannoq nvarchar(10),
		custplus float,
		custminus float
		UNIQUE (recno,custno,mon)
	)
	insert into @ztmp01(recno,custno,mon,tranno,trannoq,custplus,custminus)
	select ROW_NUMBER()over(partition by isnull(custno,''),LEFT(isnull(trandate,''),6) order by isnull(total,0) desc,tranno,trannoq) 
	,isnull(custno,''),LEFT(isnull(trandate,''),6),tranno,trannoq,isnull(custplus,0),isnull(custminus,0)
	from #z_tmp
	
	declare cursor_table cursor for
	select mon,custno,custplus-plus,custminus - minus from @tmp01 
	open cursor_table
	fetch next from cursor_table
	into @mon,@custno,@plus,@minus
	while(@@FETCH_STATUS <> -1)
	begin		
		select @n = 1,@curplus=@plus,@curminus=@minus
		while(@curplus!=0 or @curminus!=0)
		begin		
			if not exists(select tranno from @ztmp01 where custno=@custno and @mon=mon and recno=@n)
			begin
				if((@curplus=@plus and @plus!=0) or (@curminus=@minus and @minus!=0))
				begin
					--避免LOOP
					select '資料異常 @ztmp01 01',@custno,@mon,@n
					return
				return
				end
				set @n = 1
			end
			select @tranno=tranno,@trannoq=trannoq,@custplus=custplus,@custminus=custminus 
			from @ztmp01 where custno=@custno and @mon=mon and recno=@n
			if(@tranno is null)
			begin
				select '資料異常 @ztmp01 02',@custno,@mon,@n
				return
			end
			select @diffplus=0,@diffminus=0 
			if(@custplus!=0)
			begin
				set @diffplus = case when @curplus>0 then -1 when @curplus<0 then 1 else 0 end
				set @curplus = @curplus + @diffplus
			end
			if(@custminus!=0)
			begin
				set @diffminus = case when @curminus>0 then -1 when @curminus<0 then 1 else 0 end
				set @curminus = @curminus + @diffminus
			end			
			update #z_tmp set custplus=isnull(custplus,0)+@diffplus
			,custminus=isnull(custminus,0)+@diffminus 
			where tranno=@tranno and trannoq=@trannoq
			
			set @n = @n + 1
		end
		fetch next from cursor_table
		into @mon,@custno,@plus,@minus
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------------------
	--司機加減項
	declare @tmp02 table(
		mon nvarchar(10),
		carno nvarchar(20),
		driverno nvarchar(20),
		plus float,
		minus float,
		carplus float,
		carminus float
	)
	insert into @tmp02(mon,carno,driverno,plus,minus)
	select LEFT(a.datea,6),isnull(a.carno,''),isnull(a.driverno,''),SUM(ISNULL(plusmoney,0)),SUM(ISNULL(minusmoney,0)) 
	from carchg a
	--排除 代收、付,暫收
	where (left(a.acc1,4)!='2195') and (left(a.acc1,4)!='1191') 
	and (left(a.acc1,4)!='2191') and (left(a.acc1,4)!='1149') 
	and (left(a.acc1,4)!='1194') and (left(a.acc1,4)!='1129') 
	and left(a.datea,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
	group by LEFT(a.datea,6),isnull(a.carno,''),isnull(a.driverno,'')
	--發金額合計
	declare @tmp02_a table(
		mon nvarchar(10),
		carno nvarchar(20),
		driverno nvarchar(20),
		total2 float
	)
	insert into @tmp02_a(mon,carno,driverno,total2)
	select LEFT(a.trandate,6),isnull(a.carno,''),isnull(a.driverno,''),SUM(ISNULL(total2,0)) 
	from #z_tmp a
	group by LEFT(a.trandate,6),isnull(a.carno,''),isnull(a.driverno,'')
	--依發金額比例分配加減項金額
	update #z_tmp
	set carplus = case when ISNULL(c.total2,0)=0 then 0 else round(isnull(a.total2,0)*ISNULL(b.plus,0)/ISNULL(c.total2,0),0)end
		,carminus = case when ISNULL(c.total2,0)=0 then 0 else round(isnull(a.total2,0)*ISNULL(b.minus,0)/ISNULL(c.total2,0),0)end
	from #z_tmp a
	inner join @tmp02 b on left(a.trandate,6)=b.mon and a.carno=b.carno and a.driverno=b.driverno 
	inner join @tmp02_a c on left(a.trandate,6)=c.mon and a.carno=c.carno and a.driverno=c.driverno 
	--檢查有司機加減項,但當月無發金額的
	insert into #z_tmp(carteamno,custno,trandate,carno,driverno,driver,carplus,carminus,addr)
	select 'zzzzz##','zzzzz##',a.mon,a.carno,a.driverno,c.namea,a.plus,a.minus,'當月無出車'
	from @tmp02 a
	left join @tmp02_a b on a.mon=b.mon and a.carno=b.carno and a.driverno=b.driverno
	left join driver c on a.driverno=c.noa
	where isnull(b.total2,0)=0 and (isnull(a.plus,0)!=0 or isnull(a.minus,0)!=0)
	----修正誤差,由發金額最高的依序補回一次補1,LOOP
	update @tmp02
	set carplus = ISNULL(b.carplus,0)
		,carminus = ISNULL(b.carminus,0)
	from @tmp02 a
	inner join (select LEFT(ISNULL(trandate,''),6) mon
		,ISNULL(carno,'') carno
		,ISNULL(driverno,'') driverno
		, SUM(ISNULL(carplus,0)) carplus
		,SUM(ISNULL(carminus,0)) carminus 
		from #z_tmp 
		group by LEFT(ISNULL(trandate,''),6),ISNULL(carno,''),ISNULL(driverno,'')) b 
	on a.mon=b.mon and a.carno=b.carno and a.driverno=b.driverno 
	
	--修正誤差用
	declare @ztmp02 table(
		recno int,
		carno nvarchar(20),
		driverno nvarchar(20),
		mon nvarchar(10),
		tranno nvarchar(20),
		trannoq nvarchar(10),
		carplus float,
		carminus float
		UNIQUE (recno,carno,driverno,mon)
	)
	insert into @ztmp02(recno,carno,driverno,mon,tranno,trannoq,carplus,carminus)
	select ROW_NUMBER()over(partition by isnull(carno,''),isnull(driverno,''),LEFT(isnull(trandate,''),6) order by isnull(total2,0) desc,tranno,trannoq) 
	,isnull(carno,''),isnull(driverno,''),LEFT(isnull(trandate,''),6),tranno,trannoq,isnull(carplus,0),isnull(carminus,0)
	from #z_tmp
	
	declare @xplus float
	declare @xminus float
	
	declare cursor_table cursor for
	select mon,carno,driverno,carplus-plus,carminus - minus from @tmp02
	open cursor_table
	fetch next from cursor_table
	into @mon,@carno,@driverno,@plus,@minus
	while(@@FETCH_STATUS <> -1)
	begin		
		select @n = 1,@curplus=@plus,@curminus=@minus,@xplus=0,@xminus=0
		while(@curplus!=0 or @curminus!=0)
		begin		
			if not exists(select tranno from @ztmp02 where carno=@carno and driverno=@driverno and @mon=mon and recno=@n)
			begin
				if((@curplus=@plus and @plus!=0) or (@curminus=@minus and @minus!=0))
				begin
					--避免LOOP
					--select '資料異常 @ztmp02 01',@carno,@driverno,@mon,@n,@curplus,@curminus
					--return
					select @xplus = @plus,@xminus=@minus
				end
				set @n = 1
			end
			select @tranno=tranno,@trannoq=trannoq,@carplus=carplus,@carminus=carminus 
			from @ztmp02 where carno=@carno and driverno=@driverno and @mon=mon and recno=@n
			if(@tranno is null)
			begin
				select '資料異常 @ztmp02 02',@carno,@driverno,@mon,@n,@curplus,@curminus
				return
			end
			select @diffplus=0,@diffminus=0 
			if(@carplus!=0 or @xplus!=0)
			begin
				set @diffplus = case when @xplus!=0 then -@xplus else case when @curplus>0 then -1 when @curplus<0 then 1 else 0 end end
				set @curplus = @curplus + @diffplus -- @xplus
				set @xplus = 0
			end
			if(@carminus!=0 or @xminus!=0)
			begin
				set @diffminus = case when @xminus!=0 then -@xminus else case when @curminus>0 then -1 when @curminus<0 then 1 else 0 end end
				set @curminus = @curminus + @diffminus
				set @xminus = 0
			end			
			update #z_tmp set carplus=isnull(carplus,0)+@diffplus
			,carminus=isnull(carminus,0)+@diffminus 
			where tranno=@tranno and trannoq=@trannoq
			
			set @n = @n + 1
		end
		fetch next from cursor_table
		into @mon,@carno,@driverno,@plus,@minus
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------------------
	--維修、輪胎、罰單
	declare @tmp03 table(
		mon nvarchar(10),
		carno nvarchar(20),
		driverno nvarchar(20),
		fixa float,
		tire float,
		ticket float,
		carfixa float,
		cartire float,
		carticket float
	)
	insert into @tmp03(mon,carno,driverno,fixa,tire,ticket)
	select mon,carno,driverno,SUM(fixa),SUM(tire),SUM(ticket)
	from(
		select LEFT(a.fixadate,6) mon,isnull(a.carno,'') carno,isnull(a.driverno,'') driverno
		,SUM(ISNULL(a.wmoney,0)) fixa,SUM(ISNULL(a.cmoney,0)) tire,0 ticket 
		from fixa a
		where left(a.fixadate,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
		group by LEFT(a.fixadate,6),isnull(a.carno,''),isnull(a.driverno,'')
		union all
		select LEFT(a.outdate,6),isnull(a.carno,''),isnull(a.driverno,'')
		,0,SUM(ISNULL(a.[money],0)),0
		from fixout a
		where left(a.outdate,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
		group by LEFT(a.outdate,6),isnull(a.carno,''),isnull(a.driverno,'')
		union all
		select LEFT(a.datea,6),isnull(a.carno,''),isnull(a.driverno,'')
		,0,0,sum(isnull(a.comppay,0)) 
		from carborr a
		where left(a.datea,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
		and a.typea='罰單' and isnull(a.comppay,0)!=0
		group by LEFT(a.datea,6),isnull(a.carno,''),isnull(a.driverno,''))a
	group by mon,carno,driverno 
	
	--收金額合計
	declare @tmp03_a table(
		mon nvarchar(10),
		carno nvarchar(20),
		driverno nvarchar(20),
		total float
	)
	insert into @tmp03_a(mon,carno,driverno,total)
	select LEFT(a.trandate,6),isnull(a.carno,''),isnull(a.driverno,''),SUM(ISNULL(total,0)) 
	from #z_tmp a
	group by LEFT(a.trandate,6),isnull(a.carno,''),isnull(a.driverno,'') 
	--依收金額比例分配維修、輪胎、罰單
	update #z_tmp
	set fixa = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.fixa,0)/ISNULL(c.total,0),0)end
		,tire = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.tire,0)/ISNULL(c.total,0),0)end
		,ticket = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.ticket,0)/ISNULL(c.total,0),0)end
	from #z_tmp a
	inner join @tmp03 b on left(a.trandate,6)=b.mon and a.carno=b.carno and a.driverno=b.driverno 
	inner join @tmp03_a c on left(a.trandate,6)=c.mon and a.carno=c.carno and a.driverno=c.driverno 
	--檢查有達成獎金,但當月無收金額的
	insert into #z_tmp(carteamno,custno,trandate,carno,driverno,driver,fixa,tire,ticket,addr)
	select 'zzzzz##','zzzzz##',a.mon,a.carno,a.driverno,c.namea,a.fixa,a.tire,a.ticket,'當月無出車'
	from @tmp03 a
	left join @tmp03_a b on a.mon=b.mon and a.carno=b.carno and a.driverno=b.driverno
	left join driver c on a.driverno=c.noa
	where isnull(b.total,0)=0 and (isnull(a.fixa,0)!=0 or isnull(a.tire,0)!=0 or isnull(a.ticket,0)!=0)
	----修正誤差,由收入最高的依序補回一次補1,LOOP
	update @tmp03
	set carfixa = ISNULL(b.fixa,0)
		,cartire = ISNULL(b.tire,0)
		,carticket = ISNULL(b.ticket,0)
	from @tmp03 a
	inner join (select LEFT(ISNULL(trandate,''),6) mon
		,ISNULL(carno,'') carno
		,ISNULL(driverno,'') driverno
		,SUM(ISNULL(fixa,0)) fixa
		,SUM(ISNULL(tire,0)) tire
		,SUM(ISNULL(ticket,0)) ticket 
		from #z_tmp 
		group by LEFT(ISNULL(trandate,''),6),ISNULL(carno,''),ISNULL(driverno,'')) b 
		on a.mon=b.mon and a.carno=b.carno and a.driverno=b.driverno
	
	--修正誤差用
	declare @ztmp03 table(
		recno int,
		carno nvarchar(20),
		driverno nvarchar(20),
		mon nvarchar(10),
		tranno nvarchar(20),
		trannoq nvarchar(10),
		fixa float,
		tire float,
		ticket float
		UNIQUE (recno,carno,driverno,mon)
	)
	insert into @ztmp03(recno,carno,driverno,mon,tranno,trannoq,fixa,tire,ticket)
	select ROW_NUMBER()over(partition by isnull(carno,''),isnull(driverno,''),LEFT(isnull(trandate,''),6) order by isnull(total,0) desc,tranno,trannoq) 
	,isnull(carno,''),isnull(driverno,''),LEFT(isnull(trandate,''),6),tranno,trannoq,isnull(fixa,0),isnull(tire,0),isnull(ticket,0)
	from #z_tmp
	
	declare cursor_table cursor for
	select mon,carno,driverno,carfixa-fixa,cartire-tire,carticket-ticket from @tmp03 
	open cursor_table
	fetch next from cursor_table
	into @mon,@carno,@driverno,@fixa,@tire,@ticket
	while(@@FETCH_STATUS <> -1)
	begin		
		select @n = 1,@curfixa=@fixa,@curtire=@tire,@curticket=@ticket
		while(@curfixa!=0 or @curtire!=0 or @curticket!=0)
		begin		
			if not exists(select tranno from @ztmp03 where carno=@carno and driverno=@driverno and mon=@mon and recno=@n)
			begin
				if((@curfixa=@fixa and @fixa!=0) or (@curtire=@tire and @tire!=0) or (@curticket=@ticket and @ticket!=0))
				begin
					--避免LOOP
					select '資料異常 @ztmp03 01',@carno,@driverno,@mon,@n
					return
				return
				end
				set @n = 1
			end
			select @tranno=tranno,@trannoq=trannoq,@carfixa=fixa,@cartire=tire,@carticket=ticket
			from @ztmp03 where carno=@carno and driverno=@driverno and mon=@mon and recno=@n
			if(@tranno is null)
			begin
				select '資料異常 @ztmp03 02',@carno,@driverno,@mon,@n
				return
			end
			select @difffixa=0,@difftire=0,@diffticket=0
			if(@carfixa!=0)
			begin
				set @difffixa = case when @curfixa>0 then -1 when @curfixa<0 then 1 else 0 end
				set @curfixa = @curfixa + @difffixa
			end
			if(@cartire!=0)
			begin
				set @difftire = case when @curtire>0 then -1 when @curtire<0 then 1 else 0 end
				set @curtire = @curtire + @difftire
			end
			if(@carticket!=0)
			begin
				set @diffticket = case when @curticket>0 then -1 when @curticket<0 then 1 else 0 end
				set @curticket = @curticket + @diffticket
			end
				
			update #z_tmp set fixa=isnull(fixa,0)+@difffixa
			,tire=isnull(tire,0)+@difftire
			,ticket=isnull(ticket,0)+@diffticket
			where tranno=@tranno and trannoq=@trannoq
			
			set @n = @n + 1
		end
		fetch next from cursor_table
		into @mon,@carno,@driverno,@fixa,@tire,@ticket
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------------------
	--達成獎金
	declare @tmp04 table(
		mon nvarchar(10),
		driverno nvarchar(20),
		bonus float,
		carbonus float
	)
	insert into @tmp04(mon,driverno,bonus)
	select noa,driverno,sum(ISNULL(bonus,0))
	from carsals
	where noa between LEFT(@t_btrandate,6) and LEFT(@t_etrandate,6)
	group by noa,driverno 
	
	--發金額合計 (不包含折扣)
	declare @tmp04_a table(
		mon nvarchar(10),
		driverno nvarchar(20),
		total float
	)
	insert into @tmp04_a(mon,driverno,total)
	select LEFT(a.trandate,6),isnull(a.driverno,''),SUM(round(ISNULL(mount2,0)*(ISNULL(price2,0)+ISNULL(price3,0)),0)) 
	from #z_tmp a
	group by LEFT(a.trandate,6),isnull(a.driverno,'') 
	--依發金額比例分配達成獎金
	update #z_tmp
	set bonus = case when ISNULL(c.total,0)=0 then 0 else round(round(ISNULL(a.mount2,0)*(ISNULL(a.price2,0)+ISNULL(a.price3,0)),0)*ISNULL(b.bonus,0)/ISNULL(c.total,0),0)end
	from #z_tmp a
	inner join @tmp04 b on left(a.trandate,6)=b.mon and a.driverno=b.driverno 
	inner join @tmp04_a c on left(a.trandate,6)=c.mon and a.driverno=c.driverno 
	--檢查有達成獎金,但當月無發金額的
	insert into #z_tmp(carteamno,custno,trandate,driverno,driver,bonus,addr)
	select 'zzzzz##','zzzzz##',a.mon,a.driverno,c.namea,a.bonus,'當月無出車'
	from @tmp04 a
	left join @tmp04_a b on a.mon=b.mon and a.driverno=b.driverno
	left join driver c on a.driverno=c.noa
	where isnull(b.total,0)=0 and (isnull(a.bonus,0)!=0)
	----修正誤差,由收入最高的依序補回一次補1,LOOP
	update @tmp04
	set carbonus = ISNULL(b.bonus,0)
	from @tmp04 a
	inner join (select LEFT(ISNULL(trandate,''),6) mon
		,ISNULL(driverno,'') driverno
		,SUM(ISNULL(bonus,0)) bonus
		from #z_tmp 
		group by LEFT(ISNULL(trandate,''),6),ISNULL(driverno,'')) b 
		on a.mon=b.mon and a.driverno=b.driverno
	
	--修正誤差用
	declare @ztmp04 table(
		recno int,
		driverno nvarchar(20),
		mon nvarchar(10),
		tranno nvarchar(20),
		trannoq nvarchar(10),
		bonus float,
		UNIQUE (recno,driverno,mon)
	)
	insert into @ztmp04(recno,driverno,mon,tranno,trannoq,bonus)
	select ROW_NUMBER()over(partition by isnull(driverno,''),LEFT(isnull(trandate,''),6) order by round(ISNULL(mount2,0)*(ISNULL(price2,0)+ISNULL(price3,0)),0) desc,tranno,trannoq) 
	,isnull(driverno,''),LEFT(isnull(trandate,''),6),tranno,trannoq,isnull(bonus,0)
	from #z_tmp
	
	declare cursor_table cursor for
	select mon,driverno,carbonus-bonus from @tmp04 
	open cursor_table
	fetch next from cursor_table
	into @mon,@driverno,@bonus
	while(@@FETCH_STATUS <> -1)
	begin		
		select @n = 1,@curbonus=@bonus
		while(@curbonus!=0)
		begin		
			if not exists(select tranno from @ztmp04 where driverno=@driverno and mon=@mon and recno=@n)
			begin
				if(@curbonus=@bonus and @bonus!=0)
				begin
					--避免LOOP
					select '資料異常 @ztmp04 01',@driverno,@mon,@n
					return
				return
				end
				set @n = 1
			end
			select @tranno=tranno,@trannoq=trannoq,@carbonus=bonus
			from @ztmp04 where driverno=@driverno and mon=@mon and recno=@n
			if(@tranno is null)
			begin
				select '資料異常 @ztmp04 02',@driverno,@mon,@n
				return
			end
			select @diffbonus=0
			if(@carbonus!=0)
			begin
				set @diffbonus = case when @curbonus>0 then -1 when @curbonus<0 then 1 else 0 end
				set @curbonus = @curbonus + @diffbonus
			end			
				
			update #z_tmp set bonus=isnull(bonus,0)+@diffbonus
			where tranno=@tranno and trannoq=@trannoq
			
			set @n = @n + 1
		end
		fetch next from cursor_table
		into @mon,@driverno,@bonus
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------------------
	--保牌燃、折舊
	declare @tmp05 table(
		mon nvarchar(10),
		carno nvarchar(20),
		tax float,
		depreciation float,
		cartax float,
		cardepreciation float
	)
	insert into @tmp05(mon,carno,tax,depreciation)
	select a.mon,isnull(b.carno,''),sum(ISNULL(a.tax,0)),sum(ISNULL(a.depreciation,0))
	from carts a
	left join cart b on a.noa=b.noa
	where a.mon between LEFT(@t_btrandate,6) and LEFT(@t_etrandate,6)
	group by a.mon,isnull(b.carno,'')
	
	--收金額合計
	declare @tmp05_a table(
		mon nvarchar(10),
		carno nvarchar(20),
		total float
	)
	insert into @tmp05_a(mon,carno,total)
	select LEFT(a.trandate,6),isnull(a.carno,''),SUM(ISNULL(a.total,0)) 
	from #z_tmp a
	group by LEFT(a.trandate,6),isnull(a.carno,'')
	--依收金額比例分配保牌燃、折舊
	update #z_tmp
	set tax = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.tax,0)/ISNULL(c.total,0),0)end
	,depreciation = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.depreciation,0)/ISNULL(c.total,0),0)end
	from #z_tmp a
	inner join @tmp05 b on left(a.trandate,6)=b.mon and a.carno=b.carno
	inner join @tmp05_a c on left(a.trandate,6)=c.mon and a.carno=c.carno
	--檢查有保牌燃、折舊,但當月無收金額的
	insert into #z_tmp(carteamno,custno,trandate,carno,tax,depreciation,addr)
	select 'zzzzz##','zzzzz##',a.mon,a.carno,a.tax,a.depreciation,'當月無出車'
	from @tmp05 a
	left join @tmp05_a b on a.mon=b.mon and a.carno=b.carno
	where isnull(b.total,0)=0 and (isnull(a.tax,0)!=0 or isnull(a.depreciation,0)!=0)
	
	----修正誤差,由收入最高的依序補回一次補1,LOOP
	update @tmp05
	set cartax = ISNULL(b.tax,0),cardepreciation = ISNULL(b.depreciation,0)
	from @tmp05 a
	inner join (select LEFT(ISNULL(trandate,''),6) mon
		,ISNULL(carno,'') carno
		,SUM(ISNULL(tax,0)) tax
		,SUM(ISNULL(depreciation,0)) depreciation
		from #z_tmp 
		group by LEFT(ISNULL(trandate,''),6),ISNULL(carno,'')) b 
		on a.mon=b.mon and a.carno=b.carno
	
	--修正誤差用
	declare @ztmp05 table(
		recno int,
		carno nvarchar(20),
		mon nvarchar(10),
		tranno nvarchar(20),
		trannoq nvarchar(10),
		tax float,
		depreciation float,
		UNIQUE (recno,carno,mon)
	)
	insert into @ztmp05(recno,carno,mon,tranno,trannoq,tax,depreciation)
	select ROW_NUMBER()over(partition by isnull(carno,''),LEFT(isnull(trandate,''),6) order by isnull(total,0) desc,tranno,trannoq) 
	,isnull(carno,''),LEFT(isnull(trandate,''),6),tranno,trannoq,isnull(tax,0),isnull(depreciation,0)
	from #z_tmp
	
	declare cursor_table cursor for
	select mon,carno,cartax-tax,cardepreciation-depreciation from @tmp05
	open cursor_table
	fetch next from cursor_table
	into @mon,@carno,@tax,@depreciation
	while(@@FETCH_STATUS <> -1)
	begin		
		select @n = 1,@curtax=@tax,@curdepreciation=@depreciation
		while(@curtax!=0 or @curdepreciation!=0)
		begin		
			if not exists(select tranno from @ztmp05 where carno=@carno and mon=@mon and recno=@n)
			begin
				if((@curtax=@tax and @tax!=0) or (@curdepreciation=@depreciation and @depreciation!=0))
				begin
					--避免LOOP
					select '資料異常 @ztmp05 01',@carno,@mon,@n,@tax,@depreciation
					return
				return
				end
				set @n = 1
			end
			select @tranno=tranno,@trannoq=trannoq,@cartax=tax,@cardepreciation=@depreciation
			from @ztmp05 where carno=@carno and mon=@mon and recno=@n
			if(@tranno is null)
			begin
				select '資料異常 @ztmp05 02',@carno,@mon,@n
				return
			end
			select @difftax=0,@diffdepreciation=0
			if(@cartax!=0)
			begin
				set @difftax = case when @curtax>0 then -1 when @curtax<0 then 1 else 0 end
				set @curtax = @curtax + @difftax
			end			
			if(@cardepreciation!=0)
			begin
				set @diffdepreciation = case when @curdepreciation>0 then -1 when @curdepreciation<0 then 1 else 0 end
				set @curdepreciation = @curdepreciation + @diffdepreciation
			end	
				
			update #z_tmp set tax=isnull(tax,0)+@difftax,depreciation=ISNULL(depreciation,0)+@diffdepreciation
			where tranno=@tranno and trannoq=@trannoq
			
			set @n = @n + 1
		end
		fetch next from cursor_table
		into @mon,@carno,@tax,@depreciation
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------------------
	--加油,ETC
	declare @tmp06 table(
		datea nvarchar(10),
		carno nvarchar(20),
		oil float,
		etc float,
		caroil float,
		caretc float
	)
	insert into @tmp06(datea,carno,oil,etc)
	select a.datea,a.carno,SUM(a.oil),SUM(a.etc)
	from
		(select a.datea,isnull(a.carno,'') carno,SUM(ISNULL(a.[money],0)) oil,0  etc
		from oil a
		where left(a.datea,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
		group by a.datea,isnull(a.carno,'')
		union all
		select a.datea,isnull(a.carno,''),0,SUM(ISNULL(a.[money],0))
		from etc a
		where (typea='ETC' or typea='CASH')
		and left(a.datea,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
		group by a.datea,isnull(a.carno,'')) a
	group by a.datea,a.carno
	--收金額合計
	declare @tmp06_a table(
		datea nvarchar(10),
		carno nvarchar(20),
		total float
	)
	insert into @tmp06_a(datea,carno,total)
	select a.trandate,isnull(a.carno,''),SUM(ISNULL(total,0)) 
	from #z_tmp a
	group by a.trandate,isnull(a.carno,'')
	--依收金額比例分配加減項金額
	update #z_tmp
	set oil = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.oil,0)/ISNULL(c.total,0),0)end
		,etc = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.etc,0)/ISNULL(c.total,0),0)end
	from #z_tmp a
	inner join @tmp06 b on a.trandate=b.datea and a.carno = b.carno
	inner join @tmp06_a c on a.trandate=c.datea and a.carno = c.carno
	--檢查有加油或ETC,但當天無收金額的
	insert into #z_tmp(carteamno,custno,trandate,carno,oil,etc,addr)
	select 'zzzzz##','zzzzz##',a.datea,a.carno,a.oil,a.etc,'當日無出車'
	from @tmp06 a
	left join @tmp06_a b on a.datea=b.datea and a.carno=b.carno
	where isnull(b.total,0)=0 and (isnull(a.oil,0)!=0 or isnull(a.etc,0)!=0)
	----修正誤差,由收入最高的依序補回一次補1,LOOP
	update @tmp06
	set caroil = ISNULL(b.oil,0)
		,caretc = ISNULL(b.etc,0)
	from @tmp06 a
	inner join (select ISNULL(trandate,'') datea
		,ISNULL(carno,'') carno
		,SUM(ISNULL(oil,0)) oil
		,SUM(ISNULL(etc,0)) etc
		from #z_tmp 
		group by ISNULL(trandate,''),ISNULL(carno,'')) b on a.datea=b.datea and a.carno=b.carno
	
	--修正誤差用
	declare @ztmp06 table(
		recno int,
		carno nvarchar(20),
		datea nvarchar(10),
		tranno nvarchar(20),
		trannoq nvarchar(10),
		oil float,
		etc float
		UNIQUE (recno,carno,datea)
	)
	insert into @ztmp06(recno,carno,datea,tranno,trannoq,oil,etc)
	select ROW_NUMBER()over(partition by isnull(carno,''),isnull(trandate,'') order by isnull(total,0) desc,tranno,trannoq) 
	,isnull(carno,''),isnull(trandate,''),tranno,trannoq,isnull(oil,0),isnull(etc,0)
	from #z_tmp
	
	declare cursor_table cursor for
	select datea,carno,caroil-oil,caretc - etc from @tmp06
	open cursor_table
	fetch next from cursor_table
	into @datea,@carno,@oil,@etc
	while(@@FETCH_STATUS <> -1)
	begin		
		select @n = 1,@curoil=@oil,@curetc=@etc
		while(@curoil!=0 or @curetc!=0)
		begin		
			if not exists(select tranno from @ztmp06 where carno=@carno and datea=@datea and recno=@n)
			begin
				if((@curoil=@oil and @oil!=0) or (@curetc=@etc and @etc!=0))
				begin
					--避免LOOP
					select '資料異常 @ztmp01 01',@carno,@datea,@n
					return
				return
				end
				set @n = 1
			end
			select @tranno=tranno,@trannoq=trannoq,@caroil=oil,@caretc=etc 
			from @ztmp06 where carno=@carno and datea=@datea and recno=@n
			if(@tranno is null)
			begin
				select '資料異常 @ztmp01 02',@carno,@datea,@n
				return
			end
			select @diffoil=0,@diffetc=0 
			if(@caroil!=0)
			begin
				set @diffoil = case when @curoil>0 then -1 when @curoil<0 then 1 else 0 end
				set @curoil = @curoil + @diffoil
			end
			if(@caretc!=0)
			begin
				set @diffetc = case when @curetc>0 then -1 when @curetc<0 then 1 else 0 end
				set @curetc = @curetc + @diffetc
			end			
			update #z_tmp set oil=isnull(oil,0)+@diffoil
			,etc=isnull(etc,0)+@diffetc
			where tranno=@tranno and trannoq=@trannoq
			
			set @n = @n + 1
		end
		fetch next from cursor_table
		into @datea,@carno,@oil,@etc
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------------------
	--只保留所設定的日期
	delete #z_tmp where len(trandate)=9 and not(trandate between @t_btrandate and @t_etrandate)
	
	update #z_tmp set profit = isnull(total,0)-isnull(total2,0)-isnull(reserve,0)-isnull(tolls,0)
		+isnull(custplus,0)-isnull(custminus,0)-isnull(carplus,0)+isnull(carminus,0)-isnull(oil,0)-isnull(etc,0)
		-isnull(fixa,0)-isnull(tire,0)-isnull(ticket,0)-isnull(bonus,0)-isnull(tax,0)-isnull(depreciation,0)
	
	delete #z_tmp
	from #z_tmp a
	left join #carteam b on a.carteamno = b.noa
	left join #calctype c on a.calctype = c.noa
	where  not((a.carteamno='zzzzz##') or (a.custno='zzzzz##'))
	and((b.noa is null and len(isnull(a.carteamno,''))>0)
	or (c.noa is null and len(isnull(a.calctype,''))>0)
	or not(a.trandate between @t_btrandate and @t_etrandate)
	or not(a.custno between @t_bcustno and @t_ecustno)
	or not(a.addrno between @t_baddrno and @t_eaddrno)
	or not(a.driverno between @t_bdriverno and @t_edriverno))

	if(LEN(@t_carno)>0)
	begin
		delete #z_tmp
		from #z_tmp a
		left join #carno b on a.carno = b.noa
		where b.noa is null 
	end
	if(LEN(@t_po)>0)
	begin
		delete #z_tmp
		from #z_tmp a
		left join #po b on a.po = b.noa
		where b.noa is null 
	end
	----------------------------------------------------------------------------------------------	
	declare @tmp table(
		page int,
		nn int,
		gno nvarchar(10),
		recno int,
		custno nvarchar(20),
		nick nvarchar(20),
		carteamno nvarchar(20),
		carteam nvarchar(20),
		trandate nvarchar(10),
		addrno nvarchar(20),
		addr nvarchar(40),
		carno nvarchar(20),
		driver nvarchar(20),
		total float,
		total2 float,
		reserve float,
		tolls float,
		custplus float,
		custminus float,
		carplus float,
		carminus float,
		oil float,
		etc float,
		fixa float,
		tire float,
		ticket float,
		bonus float,
		tax float,
		depreciation float,
		profit float,
		miles float
	)
	--------------------------------------------------------------------------------------------
	declare @rowline int -- 每頁可用行數
	declare @endline int -- 頁尾行數
	declare @page int
	declare @recno int
	declare @curline int -- 當前行數
	set @rowline = 31
	set @endline = 1
	set @page=0
	set @curline = 0

	declare @tot int
	
	update #z_tmp set carno = case when len(isnull(carno,''))=0  then 'yyyyy##' else carno end
	
	declare cursor_table cursor for
	select a.carno,COUNT(1)
	from #z_tmp a
	left join car2 b on a.carno=b.carno
	group by a.carno,case when len(isnull(b.carkindno,''))=0 then char(255) else b.carkindno end,case when len(isnull(b.caryear,''))=0 then char(255) else b.caryear end
	order by case when len(isnull(b.carkindno,''))=0 then char(255) else b.carkindno end
	,case when len(isnull(b.caryear,''))=0 then char(255) else b.caryear end
	,case  when a.carno=char(255) then 1 when a.carno='yyyyy##' then 2 when len(isnull(a.carno,''))=0 then 3 else 4 end desc
	open cursor_table
	fetch next from cursor_table
	into @carno,@tot
	while(@@FETCH_STATUS <> -1)
	begin		
		--小計
		select @total=sum(isnull(total,0)),@total2=sum(isnull(total2,0))
			,@reserve=sum(isnull(reserve,0)),@tolls=sum(isnull(tolls,0))
			,@custplus=sum(isnull(custplus,0)),@custminus=sum(isnull(custminus,0))
			,@carplus=sum(isnull(carplus,0)),@carminus=sum(isnull(carminus,0))
			,@oil=sum(isnull(oil,0)),@etc=sum(isnull(etc,0))
			,@fixa=sum(isnull(fixa,0)),@tire=sum(isnull(tire,0))
			,@ticket=sum(isnull(ticket,0)),@bonus=sum(isnull(bonus,0))
			,@tax=sum(isnull(tax,0)),@depreciation=sum(isnull(depreciation,0))
			,@profit=sum(isnull(profit,0))
			,@miles=sum(isnull(miles,0))
		from #z_tmp where carno=@carno
		select @gno = case when @profit<=0 then '3' else '2' end
		
		if(@t_option08!='detail')
		begin
			if(@curline%@rowline=0)
			begin	
				insert into @tmp(page,nn,gno,carno)
				select @page,@curline%@rowline,'1',@carno
				set @curline = @curline + 1
			end		
			insert into @tmp(page,nn,gno,carno
				,total,total2,reserve,tolls,custplus,custminus,carplus,carminus
				,oil,etc,fixa,tire,ticket,bonus,tax,depreciation,profit,miles)
			select @page,@curline%@rowline,@gno,@carno
				,@total,@total2,@reserve,@tolls,@custplus,@custminus,@carplus,@carminus
				,@oil,@etc,@fixa,@tire,@ticket,@bonus,@tax,@depreciation,@profit,@miles
			set @curline = @curline + 1
			--是否換頁
			if(@curline%@rowline=0)
			begin
				set @page = @page + 1
			end
		end
		else
		begin
			--要顯示明細
			if(@curline%@rowline>@rowline-4)--少於4行就跳到次頁
			begin
				while(1=1)
				begin
					insert into @tmp(page,nn,gno,carno)
					select @page,@curline%@rowline,'0',@carno
					set @curline = @curline + 1
					if(@curline%@rowline=0)
						break
				end
				set @page = @page + 1
			end
			--G.1
			insert into @tmp(page,nn,gno,carno)
			select @page,@curline%@rowline,'1',@carno
			set @curline = @curline + 1
			
			insert into @tmp(page,nn,gno,carno
				,total,total2,reserve,tolls,custplus,custminus,carplus,carminus
				,oil,etc,fixa,tire,ticket,bonus,tax,depreciation,profit,miles)
			select @page,@curline%@rowline,@gno,@carno
				,@total,@total2,@reserve,@tolls,@custplus,@custminus,@carplus,@carminus
				,@oil,@etc,@fixa,@tire,@ticket,@bonus,@tax,@depreciation,@profit,@miles
			set @curline = @curline + 1
			--是否換頁
			if(@curline%@rowline=0)
			begin	
				set @page = @page + 1
			end
			--明細	
			set @n=0
			set @recno = 1
			declare cursor_table2 cursor for
			select total,total2,reserve,tolls,custplus,custminus,carplus,carminus,oil,etc
				,fixa,tire,ticket,bonus,tax,depreciation,profit,trandate,carno,driver,addrno,addr,miles
			from #z_tmp where carno=@carno
			order by trandate,carno,driver
			open cursor_table2
			fetch next from cursor_table2
			into @total,@total2,@reserve,@tolls,@custplus,@custminus,@carplus,@carminus,@oil,@etc
				,@fixa,@tire,@ticket,@bonus,@tax,@depreciation,@profit,@trandate,@carno,@driver,@addrno,@addr,@miles
			while(@@FETCH_STATUS <> -1)
			begin
				set @n = @n + 1
				if(@recno=1)
				begin
					insert into @tmp(page,nn,gno,carno)
					select @page,@curline%@rowline,'4',@carno
					set @curline = @curline + 1	
				end
				else
				begin
					if(@curline%@rowline=0)
					begin	
						insert into @tmp(page,nn,gno,carno)
						select @page,@curline%@rowline,'5',@carno
						set @curline = @curline + 1	
					end
				end
				if(@curline%@rowline=@rowline-1 or @tot=@n)
					select @gno = case when @profit<=0 then '9' else '8' end
				else
					select @gno = case when @profit<=0 then '7' else '6' end
				insert into @tmp(page,nn,gno,recno
					,total,total2,reserve,tolls,custplus,custminus,carplus,carminus,oil,etc
					,fixa,tire,ticket,bonus,tax,depreciation,profit,trandate,carno,driver,addrno,addr,miles)
				select @page,@curline%@rowline,@gno,@recno
					,@total,@total2,@reserve,@tolls,@custplus,@custminus,@carplus,@carminus,@oil,@etc
					,@fixa,@tire,@ticket,@bonus,@tax,@depreciation,@profit,@trandate,@carno,@driver,@addrno,@addr,@miles
				set @curline = @curline + 1
				--是否換頁
				if(@curline%@rowline=0)
				begin	
					set @page = @page + 1
				end
				set @recno = @recno +1
				fetch next from cursor_table2
				into @total,@total2,@reserve,@tolls,@custplus,@custminus,@carplus,@carminus,@oil,@etc
				,@fixa,@tire,@ticket,@bonus,@tax,@depreciation,@profit,@trandate,@carno,@driver,@addrno,@addr,@miles
			end
			close cursor_table2
			deallocate cursor_table2
		end
		fetch next from cursor_table
		into @carno,@tot
	end
	close cursor_table
	deallocate cursor_table	
	
	--總計
	select @total=sum(isnull(total,0)),@total2=sum(isnull(total2,0))
		,@reserve=sum(isnull(reserve,0)),@tolls=sum(isnull(tolls,0))
		,@custplus=sum(isnull(custplus,0)),@custminus=sum(isnull(custminus,0))
		,@carplus=sum(isnull(carplus,0)),@carminus=sum(isnull(carminus,0))
		,@oil=sum(isnull(oil,0)),@etc=sum(isnull(etc,0))
		,@fixa=sum(isnull(fixa,0)),@tire=sum(isnull(tire,0))
		,@ticket=sum(isnull(ticket,0)),@bonus=sum(isnull(bonus,0))
		,@tax=sum(isnull(tax,0)),@depreciation=sum(isnull(depreciation,0))
		,@profit=sum(isnull(profit,0))
		,@miles=sum(isnull(miles,0))
	from #z_tmp
	insert into @tmp(page,nn,gno,carno
		,total,total2,reserve,tolls,custplus,custminus,carplus,carminus
		,oil,etc,fixa,tire,ticket,bonus,tax,depreciation,profit,miles)
	select @page,@curline%@rowline,'10',CHAR(255)
		,@total,@total2,@reserve,@tolls,@custplus,@custminus,@carplus,@carminus
		,@oil,@etc,@fixa,@tire,@ticket,@bonus,@tax,@depreciation,@profit,@miles
				
	select a.* 
	,case when a.carno='yyyyy##' then '' else a.carno end g00
	,a.recno g01
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.total),1)),4,12)) g02
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.custplus),1)),4,12)) g03
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.custminus),1)),4,12)) g04
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.total2),1)),4,12)) g05
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.carplus),1)),4,12)) g06
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.carminus),1)),4,12)) g07
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.reserve),1)),4,12)) g08
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.tolls),1)),4,12)) g09
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.oil),1)),4,12)) g10
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.etc),1)),4,12)) g11
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.fixa),1)),4,12)) g12
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.tire),1)),4,12)) g13
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.ticket),1)),4,12)) g14
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.bonus),1)),4,12)) g15
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.tax),1)),4,12)) g16
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.depreciation),1)),4,12)) g17
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.profit),1)),4,12)) g18
	,a.trandate g19
	,a.carno g20
	,a.driver g21
	,a.addr g22
	,case when ISNULL(total,0)=0 then '' else cast(ROUND(ISNULL(oil,0)/ISNULL(total,0)*100,0)as nvarchar)+'%' end g23
	,case when ISNULL(miles,0)=0 then '' else CAST(ROUND(miles,0)as nvarchar) end g24
	,b.caryear g25
	,c.kind g26
	from @tmp a
	left join car2 b on a.carno=b.carno
	left join carkind c on b.carkindno=c.noa
	order by 
	case when len(isnull(b.carkindno,''))=0 then char(255) else b.carkindno end
	,case when len(isnull(b.caryear,''))=0 then char(255) else b.caryear end
	,case  when a.carno=char(255) then 1 when a.carno='yyyyy##' then 2 when len(isnull(a.carno,''))=0 then 3 else 4 end desc
	,page,nn;
	
z_trana09:--z_trana09
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_baddrno nvarchar(20)
	declare @t_eaddrno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(max)
	declare @t_po nvarchar(max)
	declare @t_calctype nvarchar(max)
	declare @t_carteam nvarchar(max)
	declare @t_option08 nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_baddrno = case when '#non'=[8] then '' else [8] end
	set @t_eaddrno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_bdriverno = case when '#non'=[10] then '' else [10] end
	set @t_edriverno = case when '#non'=[11] then CHAR(255) else [11] end
	set @t_carno = case when '#non'=[12] then '' else [12] end
	set @t_po = case when '#non'=[13] then '' else [13] end
	set @t_carteam = case when '#non'=[15] then '' else [15] end
	set @t_calctype = case when '#non'=[16] then '' else [16] end
	set @t_option08 = case when '#non'=[39] then '' else [39] end
	----------------------------------------------------------------------------------------------
	declare @string nvarchar(max)
	declare @n int
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carno')is not null
	BEGIN
		set @cmd = 'drop table #carno'
		EXECUTE sp_executesql @cmd
	END
	create table #carno(
		noa nvarchar(20)
	)
	set @string = @t_carno
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carno select @string
			end
			break
		end
		insert into #carno select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#po')is not null
	BEGIN
		set @cmd = 'drop table #po'
		EXECUTE sp_executesql @cmd
	END
	create table #po(
		noa nvarchar(20)
	)
	set @string = @t_po
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #po select @string
			end
			break
		end
		insert into #po select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	declare @mon nvarchar(10)
	declare @datea nvarchar(10)
	declare @custno nvarchar(20)
	declare @nick nvarchar(20)
	declare @carno nvarchar(20)
	declare @driverno nvarchar(20)
	declare @plus float
	declare @minus float
	declare @curplus float
	declare @curminus float
	declare @custplus float
	declare @custminus float
	declare @carplus float
	declare @carminus float
	declare @diffplus float
	declare @diffminus float
	declare @tranno nvarchar(20)
	declare @trannoq nvarchar(10)
	
	declare @fixa float
	declare @tire float
	declare @ticket float
	declare @curfixa float
	declare @curtire float
	declare @curticket float
	declare @carfixa float
	declare @cartire float
	declare @carticket float
	declare @difffixa float
	declare @difftire float
	declare @diffticket float
	
	declare @bonus float
	declare @curbonus float
	declare @carbonus float
	declare @diffbonus float
	
	declare @tax float
	declare @depreciation float
	declare @curtax float
	declare @curdepreciation float
	declare @cartax float
	declare @cardepreciation float
	declare @difftax float
	declare @diffdepreciation float
	
	declare @oil float
	declare @etc float
	declare @curoil float
	declare @curetc float
	declare @caroil float
	declare @caretc float
	declare @diffoil float
	declare @diffetc float
	
	declare @carteamno nvarchar(20)
	declare @carteam nvarchar(20)
	declare @trandate nvarchar(10)
	declare @addrno nvarchar(20)
	declare @addr nvarchar(40)
	--declare @carno nvarchar(20)
	declare @driver nvarchar(20)
	declare @total float
	declare @total2 float
	declare @reserve float
	declare @tolls float
	--declare @custplus float
	--declare @custminus float
	--declare @carplus float
	--declare @carminus float
	--declare @fixa float
	--declare @tire float
	--declare @ticket float
	--declare @bonus float
	--declare @tax float
	--declare @depreciation float
	declare @profit float
	declare @gno nvarchar(10)
	----------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_tmp')is not null
	BEGIN
		set @cmd = 'drop table #z_tmp'
		EXECUTE sp_executesql @cmd
	END
	create table #z_tmp(
		isoutside int,
		tranno nvarchar(20),
		trannoq nvarchar(10),
		datea nvarchar(10),
		trandate nvarchar(10),
		carteamno nvarchar(20),
		carteam nvarchar(20),
		calctype nvarchar(20),
		
		custno nvarchar(20),
		custnick nvarchar(20),
		addrno nvarchar(20),
		addr nvarchar(40),
		
		carno nvarchar(20),
		driverno nvarchar(20),
		driver nvarchar(20),
		miles float,
		po nvarchar(max),
		
		mount float,
		price float,
		total float,
		
		mount2 float,
		price2 float,
		price3 float,
		discount float,
		total2 float,
		
		reserve float,
		tolls float,
		memo nvarchar(max),
		
		custplus float,
		custminus float,
		
		carplus float,
		carminus float,
		oil float,
		etc float,
		fixa float,
		tire float,
		ticket float,
		bonus float,
		tax float,
		depreciation float,	
		
		profit float
	)
	set @cmd = 
	" select isnull(c.isoutside,0),a.noa,a.noq,a.datea,a.trandate,isnull(a.carteamno,''),b.team,a.calctype"+
	" ,isnull(a.custno,''),a.nick,a.straddrno,a.straddr"+
	" ,a.carno,a.driverno,a.driver,isnull(a.miles,0),a.po"+
	" ,a.mount,a.price,a.total"+
	" ,a.mount2,a.price2,a.price3,a.discount,a.total2"+
	" ,a.reserve,a.tolls,a.memo"+
	" from view_trans"+@t_accy+" a"+
	" left join carteam b on a.carteamno = b.noa"+
	" left join calctypes c on a.calctype = c.noa+c.noq"+
	" where (left(a.trandate,6) between left(@t_btrandate,6) and left(@t_etrandate,6))"
	
	create index tranno on #z_tmp(tranno,trannoq)
	insert into #z_tmp(isoutside,tranno,trannoq,datea,trandate,carteamno,carteam,calctype
		,custno,custnick,addrno,addr
		,carno,driverno,driver,miles,po
		,mount,price,total
		,mount2,price2,price3,discount,total2
		,reserve,tolls,memo
	)
	execute sp_executesql @cmd,N'@t_btrandate nvarchar(10),@t_etrandate nvarchar(10)'
	,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate
	----------------------------------------------------------------------------------------------
	--客戶加減項
	declare @tmp01 table(
		mon nvarchar(10),
		custno nvarchar(20),
		plus float,
		minus float,
		custplus float,
		custminus float
	)
	insert into @tmp01(mon,custno,plus,minus)
	select LEFT(a.datea,6),isnull(a.custno,''),SUM(ISNULL(plusmoney,0)),SUM(ISNULL(minusmoney,0)) 
	from custchg a
	--排除 代收、付,暫收
	where (left(a.acc1,4)!='2195') and (left(a.acc1,4)!='1191') 
	and (left(a.acc1,4)!='2191') and (left(a.acc1,4)!='1149') 
	and (left(a.acc1,4)!='1194') and (left(a.acc1,4)!='1129') 
	and left(a.datea,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
	group by LEFT(a.datea,6),isnull(a.custno,'')
	--收金額合計
	declare @tmp01_a table(
		mon nvarchar(10),
		custno nvarchar(20),
		total float
	)
	insert into @tmp01_a(mon,custno,total)
	select LEFT(a.trandate,6),isnull(a.custno,''),SUM(ISNULL(total,0)) 
	from #z_tmp a
	group by LEFT(a.trandate,6),isnull(a.custno,'') 
	--依收金額比例分配加減項金額
	update #z_tmp
	set custplus = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.plus,0)/ISNULL(c.total,0),0)end
		,custminus = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.minus,0)/ISNULL(c.total,0),0)end
	from #z_tmp a
	inner join @tmp01 b on left(a.trandate,6)=b.mon and a.custno = b.custno 
	inner join @tmp01_a c on left(a.trandate,6)=c.mon and a.custno = c.custno 
	--檢查有客戶加減項,但當月無收金額的
	insert into #z_tmp(carteamno,custno,trandate,custplus,custminus,addr)
	select 'zzzzz##',a.custno,a.mon,a.plus,a.minus,c.nick+'當月無出車'
	from @tmp01 a
	left join @tmp01_a b on a.mon=b.mon and a.custno=b.custno
	left join cust c on a.custno=c.noa
	where isnull(b.total,0)=0 and (isnull(a.plus,0)!=0 or isnull(a.minus,0)!=0)
	----修正誤差,由收入最高的依序補回一次補1,LOOP
	update @tmp01
	set custplus = ISNULL(b.custplus,0)
		,custminus = ISNULL(b.custminus,0)
	from @tmp01 a
	inner join (select LEFT(ISNULL(trandate,''),6) mon
		,ISNULL(custno,'') custno
		, SUM(ISNULL(custplus,0)) custplus
		,SUM(ISNULL(custminus,0)) custminus 
		from #z_tmp 
		group by LEFT(ISNULL(trandate,''),6),ISNULL(custno,'')) b on a.mon=b.mon and a.custno=b.custno
	
	--修正誤差用
	declare @ztmp01 table(
		recno int,
		custno nvarchar(20),
		mon nvarchar(10),
		tranno nvarchar(20),
		trannoq nvarchar(10),
		custplus float,
		custminus float
		UNIQUE (recno,custno,mon)
	)
	insert into @ztmp01(recno,custno,mon,tranno,trannoq,custplus,custminus)
	select ROW_NUMBER()over(partition by isnull(custno,''),LEFT(isnull(trandate,''),6) order by isnull(total,0) desc,tranno,trannoq) 
	,isnull(custno,''),LEFT(isnull(trandate,''),6),tranno,trannoq,isnull(custplus,0),isnull(custminus,0)
	from #z_tmp
	
	declare cursor_table cursor for
	select mon,custno,custplus-plus,custminus - minus from @tmp01 
	open cursor_table
	fetch next from cursor_table
	into @mon,@custno,@plus,@minus
	while(@@FETCH_STATUS <> -1)
	begin		
		select @n = 1,@curplus=@plus,@curminus=@minus
		while(@curplus!=0 or @curminus!=0)
		begin		
			if not exists(select tranno from @ztmp01 where custno=@custno and @mon=mon and recno=@n)
			begin
				if((@curplus=@plus and @plus!=0) or (@curminus=@minus and @minus!=0))
				begin
					--避免LOOP
					select '資料異常 @ztmp01 01',@custno,@mon,@n
					return
				return
				end
				set @n = 1
			end
			select @tranno=tranno,@trannoq=trannoq,@custplus=custplus,@custminus=custminus 
			from @ztmp01 where custno=@custno and @mon=mon and recno=@n
			if(@tranno is null)
			begin
				select '資料異常 @ztmp01 02',@custno,@mon,@n
				return
			end
			select @diffplus=0,@diffminus=0 
			if(@custplus!=0)
			begin
				set @diffplus = case when @curplus>0 then -1 when @curplus<0 then 1 else 0 end
				set @curplus = @curplus + @diffplus
			end
			if(@custminus!=0)
			begin
				set @diffminus = case when @curminus>0 then -1 when @curminus<0 then 1 else 0 end
				set @curminus = @curminus + @diffminus
			end			
			update #z_tmp set custplus=isnull(custplus,0)+@diffplus
			,custminus=isnull(custminus,0)+@diffminus 
			where tranno=@tranno and trannoq=@trannoq
			
			set @n = @n + 1
		end
		fetch next from cursor_table
		into @mon,@custno,@plus,@minus
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------------------
	--司機加減項
	declare @tmp02 table(
		mon nvarchar(10),
		carno nvarchar(20),
		driverno nvarchar(20),
		plus float,
		minus float,
		carplus float,
		carminus float
	)
	insert into @tmp02(mon,carno,driverno,plus,minus)
	select LEFT(a.datea,6),isnull(a.carno,''),isnull(a.driverno,''),SUM(ISNULL(plusmoney,0)),SUM(ISNULL(minusmoney,0)) 
	from carchg a
	--排除 代收、付,暫收
	where (left(a.acc1,4)!='2195') and (left(a.acc1,4)!='1191') 
	and (left(a.acc1,4)!='2191') and (left(a.acc1,4)!='1149') 
	and (left(a.acc1,4)!='1194') and (left(a.acc1,4)!='1129') 
	and left(a.datea,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
	group by LEFT(a.datea,6),isnull(a.carno,''),isnull(a.driverno,'')
	--發金額合計
	declare @tmp02_a table(
		mon nvarchar(10),
		carno nvarchar(20),
		driverno nvarchar(20),
		total2 float
	)
	insert into @tmp02_a(mon,carno,driverno,total2)
	select LEFT(a.trandate,6),isnull(a.carno,''),isnull(a.driverno,''),SUM(ISNULL(total2,0)) 
	from #z_tmp a
	group by LEFT(a.trandate,6),isnull(a.carno,''),isnull(a.driverno,'')
	--依發金額比例分配加減項金額
	update #z_tmp
	set carplus = case when ISNULL(c.total2,0)=0 then 0 else round(isnull(a.total2,0)*ISNULL(b.plus,0)/ISNULL(c.total2,0),0)end
		,carminus = case when ISNULL(c.total2,0)=0 then 0 else round(isnull(a.total2,0)*ISNULL(b.minus,0)/ISNULL(c.total2,0),0)end
	from #z_tmp a
	inner join @tmp02 b on left(a.trandate,6)=b.mon and a.carno=b.carno and a.driverno=b.driverno 
	inner join @tmp02_a c on left(a.trandate,6)=c.mon and a.carno=c.carno and a.driverno=c.driverno 
	--檢查有司機加減項,但當月無發金額的
	insert into #z_tmp(carteamno,custno,trandate,carno,driverno,driver,carplus,carminus,addr)
	select 'zzzzz##','zzzzz##',a.mon,a.carno,a.driverno,c.namea,a.plus,a.minus,'當月無出車'
	from @tmp02 a
	left join @tmp02_a b on a.mon=b.mon and a.carno=b.carno and a.driverno=b.driverno
	left join driver c on a.driverno=c.noa
	where isnull(b.total2,0)=0 and (isnull(a.plus,0)!=0 or isnull(a.minus,0)!=0)
	----修正誤差,由發金額最高的依序補回一次補1,LOOP
	update @tmp02
	set carplus = ISNULL(b.carplus,0)
		,carminus = ISNULL(b.carminus,0)
	from @tmp02 a
	inner join (select LEFT(ISNULL(trandate,''),6) mon
		,ISNULL(carno,'') carno
		,ISNULL(driverno,'') driverno
		, SUM(ISNULL(carplus,0)) carplus
		,SUM(ISNULL(carminus,0)) carminus 
		from #z_tmp 
		group by LEFT(ISNULL(trandate,''),6),ISNULL(carno,''),ISNULL(driverno,'')) b 
	on a.mon=b.mon and a.carno=b.carno and a.driverno=b.driverno 
	
	--修正誤差用
	declare @ztmp02 table(
		recno int,
		carno nvarchar(20),
		driverno nvarchar(20),
		mon nvarchar(10),
		tranno nvarchar(20),
		trannoq nvarchar(10),
		carplus float,
		carminus float
		UNIQUE (recno,carno,driverno,mon)
	)
	insert into @ztmp02(recno,carno,driverno,mon,tranno,trannoq,carplus,carminus)
	select ROW_NUMBER()over(partition by isnull(carno,''),isnull(driverno,''),LEFT(isnull(trandate,''),6) order by isnull(total2,0) desc,tranno,trannoq) 
	,isnull(carno,''),isnull(driverno,''),LEFT(isnull(trandate,''),6),tranno,trannoq,isnull(carplus,0),isnull(carminus,0)
	from #z_tmp
	
	declare @xplus float
	declare @xminus float
	
	declare cursor_table cursor for
	select mon,carno,driverno,carplus-plus,carminus - minus from @tmp02
	open cursor_table
	fetch next from cursor_table
	into @mon,@carno,@driverno,@plus,@minus
	while(@@FETCH_STATUS <> -1)
	begin		
		select @n = 1,@curplus=@plus,@curminus=@minus,@xplus=0,@xminus=0
		while(@curplus!=0 or @curminus!=0)
		begin		
			if not exists(select tranno from @ztmp02 where carno=@carno and driverno=@driverno and @mon=mon and recno=@n)
			begin
				if((@curplus=@plus and @plus!=0) or (@curminus=@minus and @minus!=0))
				begin
					--避免LOOP
					--select '資料異常 @ztmp02 01',@carno,@driverno,@mon,@n,@curplus,@curminus
					--return
					select @xplus = @plus,@xminus=@minus
				end
				set @n = 1
			end
			select @tranno=tranno,@trannoq=trannoq,@carplus=carplus,@carminus=carminus 
			from @ztmp02 where carno=@carno and driverno=@driverno and @mon=mon and recno=@n
			if(@tranno is null)
			begin
				select '資料異常 @ztmp02 02',@carno,@driverno,@mon,@n,@curplus,@curminus
				return
			end
			select @diffplus=0,@diffminus=0 
			if(@carplus!=0 or @xplus!=0)
			begin
				set @diffplus = case when @xplus!=0 then -@xplus else case when @curplus>0 then -1 when @curplus<0 then 1 else 0 end end
				set @curplus = @curplus + @diffplus -- @xplus
				set @xplus = 0
			end
			if(@carminus!=0 or @xminus!=0)
			begin
				set @diffminus = case when @xminus!=0 then -@xminus else case when @curminus>0 then -1 when @curminus<0 then 1 else 0 end end
				set @curminus = @curminus + @diffminus
				set @xminus = 0
			end			
			update #z_tmp set carplus=isnull(carplus,0)+@diffplus
			,carminus=isnull(carminus,0)+@diffminus 
			where tranno=@tranno and trannoq=@trannoq
			
			set @n = @n + 1
		end
		fetch next from cursor_table
		into @mon,@carno,@driverno,@plus,@minus
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------------------
	--維修、輪胎、罰單
	declare @tmp03 table(
		mon nvarchar(10),
		carno nvarchar(20),
		driverno nvarchar(20),
		fixa float,
		tire float,
		ticket float,
		carfixa float,
		cartire float,
		carticket float
	)
	insert into @tmp03(mon,carno,driverno,fixa,tire,ticket)
	select mon,carno,driverno,SUM(fixa),SUM(tire),SUM(ticket)
	from(
		select LEFT(a.fixadate,6) mon,isnull(a.carno,'') carno,isnull(a.driverno,'') driverno
		,SUM(ISNULL(a.wmoney,0)) fixa,SUM(ISNULL(a.cmoney,0)) tire,0 ticket 
		from fixa a
		where left(a.fixadate,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
		group by LEFT(a.fixadate,6),isnull(a.carno,''),isnull(a.driverno,'')
		union all
		select LEFT(a.outdate,6),isnull(a.carno,''),isnull(a.driverno,'')
		,0,SUM(ISNULL(a.[money],0)),0
		from fixout a
		where left(a.outdate,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
		group by LEFT(a.outdate,6),isnull(a.carno,''),isnull(a.driverno,'')
		union all
		select LEFT(a.datea,6),isnull(a.carno,''),isnull(a.driverno,'')
		,0,0,sum(isnull(a.comppay,0)) 
		from carborr a
		where left(a.datea,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
		and a.typea='罰單' and isnull(a.comppay,0)!=0
		group by LEFT(a.datea,6),isnull(a.carno,''),isnull(a.driverno,''))a
	group by mon,carno,driverno 
	
	--收金額合計
	declare @tmp03_a table(
		mon nvarchar(10),
		carno nvarchar(20),
		driverno nvarchar(20),
		total float
	)
	insert into @tmp03_a(mon,carno,driverno,total)
	select LEFT(a.trandate,6),isnull(a.carno,''),isnull(a.driverno,''),SUM(ISNULL(total,0)) 
	from #z_tmp a
	group by LEFT(a.trandate,6),isnull(a.carno,''),isnull(a.driverno,'') 
	--依收金額比例分配維修、輪胎、罰單
	update #z_tmp
	set fixa = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.fixa,0)/ISNULL(c.total,0),0)end
		,tire = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.tire,0)/ISNULL(c.total,0),0)end
		,ticket = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.ticket,0)/ISNULL(c.total,0),0)end
	from #z_tmp a
	inner join @tmp03 b on left(a.trandate,6)=b.mon and a.carno=b.carno and a.driverno=b.driverno 
	inner join @tmp03_a c on left(a.trandate,6)=c.mon and a.carno=c.carno and a.driverno=c.driverno 
	--檢查有達成獎金,但當月無收金額的
	insert into #z_tmp(carteamno,custno,trandate,carno,driverno,driver,fixa,tire,ticket,addr)
	select 'zzzzz##','zzzzz##',a.mon,a.carno,a.driverno,c.namea,a.fixa,a.tire,a.ticket,'當月無出車'
	from @tmp03 a
	left join @tmp03_a b on a.mon=b.mon and a.carno=b.carno and a.driverno=b.driverno
	left join driver c on a.driverno=c.noa
	where isnull(b.total,0)=0 and (isnull(a.fixa,0)!=0 or isnull(a.tire,0)!=0 or isnull(a.ticket,0)!=0)
	----修正誤差,由收入最高的依序補回一次補1,LOOP
	update @tmp03
	set carfixa = ISNULL(b.fixa,0)
		,cartire = ISNULL(b.tire,0)
		,carticket = ISNULL(b.ticket,0)
	from @tmp03 a
	inner join (select LEFT(ISNULL(trandate,''),6) mon
		,ISNULL(carno,'') carno
		,ISNULL(driverno,'') driverno
		,SUM(ISNULL(fixa,0)) fixa
		,SUM(ISNULL(tire,0)) tire
		,SUM(ISNULL(ticket,0)) ticket 
		from #z_tmp 
		group by LEFT(ISNULL(trandate,''),6),ISNULL(carno,''),ISNULL(driverno,'')) b 
		on a.mon=b.mon and a.carno=b.carno and a.driverno=b.driverno
	
	--修正誤差用
	declare @ztmp03 table(
		recno int,
		carno nvarchar(20),
		driverno nvarchar(20),
		mon nvarchar(10),
		tranno nvarchar(20),
		trannoq nvarchar(10),
		fixa float,
		tire float,
		ticket float
		UNIQUE (recno,carno,driverno,mon)
	)
	insert into @ztmp03(recno,carno,driverno,mon,tranno,trannoq,fixa,tire,ticket)
	select ROW_NUMBER()over(partition by isnull(carno,''),isnull(driverno,''),LEFT(isnull(trandate,''),6) order by isnull(total,0) desc,tranno,trannoq) 
	,isnull(carno,''),isnull(driverno,''),LEFT(isnull(trandate,''),6),tranno,trannoq,isnull(fixa,0),isnull(tire,0),isnull(ticket,0)
	from #z_tmp
	
	declare cursor_table cursor for
	select mon,carno,driverno,carfixa-fixa,cartire-tire,carticket-ticket from @tmp03 
	open cursor_table
	fetch next from cursor_table
	into @mon,@carno,@driverno,@fixa,@tire,@ticket
	while(@@FETCH_STATUS <> -1)
	begin		
		select @n = 1,@curfixa=@fixa,@curtire=@tire,@curticket=@ticket
		while(@curfixa!=0 or @curtire!=0 or @curticket!=0)
		begin		
			if not exists(select tranno from @ztmp03 where carno=@carno and driverno=@driverno and mon=@mon and recno=@n)
			begin
				if((@curfixa=@fixa and @fixa!=0) or (@curtire=@tire and @tire!=0) or (@curticket=@ticket and @ticket!=0))
				begin
					--避免LOOP
					select '資料異常 @ztmp03 01',@carno,@driverno,@mon,@n
					return
				return
				end
				set @n = 1
			end
			select @tranno=tranno,@trannoq=trannoq,@carfixa=fixa,@cartire=tire,@carticket=ticket
			from @ztmp03 where carno=@carno and driverno=@driverno and mon=@mon and recno=@n
			if(@tranno is null)
			begin
				select '資料異常 @ztmp03 02',@carno,@driverno,@mon,@n
				return
			end
			select @difffixa=0,@difftire=0,@diffticket=0
			if(@carfixa!=0)
			begin
				set @difffixa = case when @curfixa>0 then -1 when @curfixa<0 then 1 else 0 end
				set @curfixa = @curfixa + @difffixa
			end
			if(@cartire!=0)
			begin
				set @difftire = case when @curtire>0 then -1 when @curtire<0 then 1 else 0 end
				set @curtire = @curtire + @difftire
			end
			if(@carticket!=0)
			begin
				set @diffticket = case when @curticket>0 then -1 when @curticket<0 then 1 else 0 end
				set @curticket = @curticket + @diffticket
			end
				
			update #z_tmp set fixa=isnull(fixa,0)+@difffixa
			,tire=isnull(tire,0)+@difftire
			,ticket=isnull(ticket,0)+@diffticket
			where tranno=@tranno and trannoq=@trannoq
			
			set @n = @n + 1
		end
		fetch next from cursor_table
		into @mon,@carno,@driverno,@fixa,@tire,@ticket
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------------------
	--達成獎金
	declare @tmp04 table(
		mon nvarchar(10),
		driverno nvarchar(20),
		bonus float,
		carbonus float
	)
	insert into @tmp04(mon,driverno,bonus)
	select noa,driverno,sum(ISNULL(bonus,0))
	from carsals
	where noa between LEFT(@t_btrandate,6) and LEFT(@t_etrandate,6)
	group by noa,driverno 
	
	--發金額合計 (不包含折扣)
	declare @tmp04_a table(
		mon nvarchar(10),
		driverno nvarchar(20),
		total float
	)
	insert into @tmp04_a(mon,driverno,total)
	select LEFT(a.trandate,6),isnull(a.driverno,''),SUM(round(ISNULL(mount2,0)*(ISNULL(price2,0)+ISNULL(price3,0)),0)) 
	from #z_tmp a
	group by LEFT(a.trandate,6),isnull(a.driverno,'') 
	--依發金額比例分配達成獎金
	update #z_tmp
	set bonus = case when ISNULL(c.total,0)=0 then 0 else round(round(ISNULL(a.mount2,0)*(ISNULL(a.price2,0)+ISNULL(a.price3,0)),0)*ISNULL(b.bonus,0)/ISNULL(c.total,0),0)end
	from #z_tmp a
	inner join @tmp04 b on left(a.trandate,6)=b.mon and a.driverno=b.driverno 
	inner join @tmp04_a c on left(a.trandate,6)=c.mon and a.driverno=c.driverno 
	--檢查有達成獎金,但當月無發金額的
	insert into #z_tmp(carteamno,custno,trandate,driverno,driver,bonus,addr)
	select 'zzzzz##','zzzzz##',a.mon,a.driverno,c.namea,a.bonus,'當月無出車'
	from @tmp04 a
	left join @tmp04_a b on a.mon=b.mon and a.driverno=b.driverno
	left join driver c on a.driverno=c.noa
	where isnull(b.total,0)=0 and (isnull(a.bonus,0)!=0)
	----修正誤差,由收入最高的依序補回一次補1,LOOP
	update @tmp04
	set carbonus = ISNULL(b.bonus,0)
	from @tmp04 a
	inner join (select LEFT(ISNULL(trandate,''),6) mon
		,ISNULL(driverno,'') driverno
		,SUM(ISNULL(bonus,0)) bonus
		from #z_tmp 
		group by LEFT(ISNULL(trandate,''),6),ISNULL(driverno,'')) b 
		on a.mon=b.mon and a.driverno=b.driverno
	
	--修正誤差用
	declare @ztmp04 table(
		recno int,
		driverno nvarchar(20),
		mon nvarchar(10),
		tranno nvarchar(20),
		trannoq nvarchar(10),
		bonus float,
		UNIQUE (recno,driverno,mon)
	)
	insert into @ztmp04(recno,driverno,mon,tranno,trannoq,bonus)
	select ROW_NUMBER()over(partition by isnull(driverno,''),LEFT(isnull(trandate,''),6) order by round(ISNULL(mount2,0)*(ISNULL(price2,0)+ISNULL(price3,0)),0) desc,tranno,trannoq) 
	,isnull(driverno,''),LEFT(isnull(trandate,''),6),tranno,trannoq,isnull(bonus,0)
	from #z_tmp
	
	declare cursor_table cursor for
	select mon,driverno,carbonus-bonus from @tmp04 
	open cursor_table
	fetch next from cursor_table
	into @mon,@driverno,@bonus
	while(@@FETCH_STATUS <> -1)
	begin		
		select @n = 1,@curbonus=@bonus
		while(@curbonus!=0)
		begin		
			if not exists(select tranno from @ztmp04 where driverno=@driverno and mon=@mon and recno=@n)
			begin
				if(@curbonus=@bonus and @bonus!=0)
				begin
					--避免LOOP
					select '資料異常 @ztmp04 01',@driverno,@mon,@n
					return
				return
				end
				set @n = 1
			end
			select @tranno=tranno,@trannoq=trannoq,@carbonus=bonus
			from @ztmp04 where driverno=@driverno and mon=@mon and recno=@n
			if(@tranno is null)
			begin
				select '資料異常 @ztmp04 02',@driverno,@mon,@n
				return
			end
			select @diffbonus=0
			if(@carbonus!=0)
			begin
				set @diffbonus = case when @curbonus>0 then -1 when @curbonus<0 then 1 else 0 end
				set @curbonus = @curbonus + @diffbonus
			end			
				
			update #z_tmp set bonus=isnull(bonus,0)+@diffbonus
			where tranno=@tranno and trannoq=@trannoq
			
			set @n = @n + 1
		end
		fetch next from cursor_table
		into @mon,@driverno,@bonus
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------------------
	--保牌燃、折舊
	declare @tmp05 table(
		mon nvarchar(10),
		carno nvarchar(20),
		tax float,
		depreciation float,
		cartax float,
		cardepreciation float
	)
	insert into @tmp05(mon,carno,tax,depreciation)
	select a.mon,isnull(b.carno,''),sum(ISNULL(a.tax,0)),sum(ISNULL(a.depreciation,0))
	from carts a
	left join cart b on a.noa=b.noa
	where a.mon between LEFT(@t_btrandate,6) and LEFT(@t_etrandate,6)
	group by a.mon,isnull(b.carno,'')
	
	--收金額合計
	declare @tmp05_a table(
		mon nvarchar(10),
		carno nvarchar(20),
		total float
	)
	insert into @tmp05_a(mon,carno,total)
	select LEFT(a.trandate,6),isnull(a.carno,''),SUM(ISNULL(a.total,0)) 
	from #z_tmp a
	group by LEFT(a.trandate,6),isnull(a.carno,'')
	--依收金額比例分配保牌燃、折舊
	update #z_tmp
	set tax = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.tax,0)/ISNULL(c.total,0),0)end
	,depreciation = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.depreciation,0)/ISNULL(c.total,0),0)end
	from #z_tmp a
	inner join @tmp05 b on left(a.trandate,6)=b.mon and a.carno=b.carno
	inner join @tmp05_a c on left(a.trandate,6)=c.mon and a.carno=c.carno
	--檢查有保牌燃、折舊,但當月無收金額的
	insert into #z_tmp(carteamno,custno,trandate,carno,tax,depreciation,addr)
	select 'zzzzz##','zzzzz##',a.mon,a.carno,a.tax,a.depreciation,'當月無出車'
	from @tmp05 a
	left join @tmp05_a b on a.mon=b.mon and a.carno=b.carno
	where isnull(b.total,0)=0 and (isnull(a.tax,0)!=0 or isnull(a.depreciation,0)!=0)
	
	----修正誤差,由收入最高的依序補回一次補1,LOOP
	update @tmp05
	set cartax = ISNULL(b.tax,0),cardepreciation = ISNULL(b.depreciation,0)
	from @tmp05 a
	inner join (select LEFT(ISNULL(trandate,''),6) mon
		,ISNULL(carno,'') carno
		,SUM(ISNULL(tax,0)) tax
		,SUM(ISNULL(depreciation,0)) depreciation
		from #z_tmp 
		group by LEFT(ISNULL(trandate,''),6),ISNULL(carno,'')) b 
		on a.mon=b.mon and a.carno=b.carno
	
	--修正誤差用
	declare @ztmp05 table(
		recno int,
		carno nvarchar(20),
		mon nvarchar(10),
		tranno nvarchar(20),
		trannoq nvarchar(10),
		tax float,
		depreciation float,
		UNIQUE (recno,carno,mon)
	)
	insert into @ztmp05(recno,carno,mon,tranno,trannoq,tax,depreciation)
	select ROW_NUMBER()over(partition by isnull(carno,''),LEFT(isnull(trandate,''),6) order by isnull(total,0) desc,tranno,trannoq) 
	,isnull(carno,''),LEFT(isnull(trandate,''),6),tranno,trannoq,isnull(tax,0),isnull(depreciation,0)
	from #z_tmp
	
	declare cursor_table cursor for
	select mon,carno,cartax-tax,cardepreciation-depreciation from @tmp05
	open cursor_table
	fetch next from cursor_table
	into @mon,@carno,@tax,@depreciation
	while(@@FETCH_STATUS <> -1)
	begin		
		select @n = 1,@curtax=@tax,@curdepreciation=@depreciation
		while(@curtax!=0 or @curdepreciation!=0)
		begin		
			if not exists(select tranno from @ztmp05 where carno=@carno and mon=@mon and recno=@n)
			begin
				if((@curtax=@tax and @tax!=0) or (@curdepreciation=@depreciation and @depreciation!=0))
				begin
					--避免LOOP
					select '資料異常 @ztmp05 01',@carno,@mon,@n,@tax,@depreciation
					return
				return
				end
				set @n = 1
			end
			select @tranno=tranno,@trannoq=trannoq,@cartax=tax,@cardepreciation=@depreciation
			from @ztmp05 where carno=@carno and mon=@mon and recno=@n
			if(@tranno is null)
			begin
				select '資料異常 @ztmp05 02',@carno,@mon,@n
				return
			end
			select @difftax=0,@diffdepreciation=0
			if(@cartax!=0)
			begin
				set @difftax = case when @curtax>0 then -1 when @curtax<0 then 1 else 0 end
				set @curtax = @curtax + @difftax
			end			
			if(@cardepreciation!=0)
			begin
				set @diffdepreciation = case when @curdepreciation>0 then -1 when @curdepreciation<0 then 1 else 0 end
				set @curdepreciation = @curdepreciation + @diffdepreciation
			end	
				
			update #z_tmp set tax=isnull(tax,0)+@difftax,depreciation=ISNULL(depreciation,0)+@diffdepreciation
			where tranno=@tranno and trannoq=@trannoq
			
			set @n = @n + 1
		end
		fetch next from cursor_table
		into @mon,@carno,@tax,@depreciation
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------------------
	--加油,ETC
	declare @tmp06 table(
		datea nvarchar(10),
		carno nvarchar(20),
		oil float,
		etc float,
		caroil float,
		caretc float
	)
	insert into @tmp06(datea,carno,oil,etc)
	select a.datea,a.carno,SUM(a.oil),SUM(a.etc)
	from
		(select a.datea,isnull(a.carno,'') carno,SUM(ISNULL(a.[money],0)) oil,0  etc
		from oil a
		where left(a.datea,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
		group by a.datea,isnull(a.carno,'')
		union all
		select a.datea,isnull(a.carno,''),0,SUM(ISNULL(a.[money],0))
		from etc a
		where (typea='ETC' or typea='CASH')
		and left(a.datea,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
		group by a.datea,isnull(a.carno,'')) a
	group by a.datea,a.carno
	--收金額合計
	declare @tmp06_a table(
		datea nvarchar(10),
		carno nvarchar(20),
		total float
	)
	insert into @tmp06_a(datea,carno,total)
	select a.trandate,isnull(a.carno,''),SUM(ISNULL(total,0)) 
	from #z_tmp a
	group by a.trandate,isnull(a.carno,'')
	--依收金額比例分配加減項金額
	update #z_tmp
	set oil = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.oil,0)/ISNULL(c.total,0),0)end
		,etc = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.etc,0)/ISNULL(c.total,0),0)end
	from #z_tmp a
	inner join @tmp06 b on a.trandate=b.datea and a.carno = b.carno
	inner join @tmp06_a c on a.trandate=c.datea and a.carno = c.carno
	--檢查有加油或ETC,但當天無收金額的
	insert into #z_tmp(carteamno,custno,trandate,carno,oil,etc,addr)
	select 'zzzzz##','zzzzz##',a.datea,a.carno,a.oil,a.etc,'當日無出車'
	from @tmp06 a
	left join @tmp06_a b on a.datea=b.datea and a.carno=b.carno
	where isnull(b.total,0)=0 and (isnull(a.oil,0)!=0 or isnull(a.etc,0)!=0)
	----修正誤差,由收入最高的依序補回一次補1,LOOP
	update @tmp06
	set caroil = ISNULL(b.oil,0)
		,caretc = ISNULL(b.etc,0)
	from @tmp06 a
	inner join (select ISNULL(trandate,'') datea
		,ISNULL(carno,'') carno
		,SUM(ISNULL(oil,0)) oil
		,SUM(ISNULL(etc,0)) etc
		from #z_tmp 
		group by ISNULL(trandate,''),ISNULL(carno,'')) b on a.datea=b.datea and a.carno=b.carno
	
	--修正誤差用
	declare @ztmp06 table(
		recno int,
		carno nvarchar(20),
		datea nvarchar(10),
		tranno nvarchar(20),
		trannoq nvarchar(10),
		oil float,
		etc float
		UNIQUE (recno,carno,datea)
	)
	insert into @ztmp06(recno,carno,datea,tranno,trannoq,oil,etc)
	select ROW_NUMBER()over(partition by isnull(carno,''),isnull(trandate,'') order by isnull(total,0) desc,tranno,trannoq) 
	,isnull(carno,''),isnull(trandate,''),tranno,trannoq,isnull(oil,0),isnull(etc,0)
	from #z_tmp
	
	declare cursor_table cursor for
	select datea,carno,caroil-oil,caretc - etc from @tmp06
	open cursor_table
	fetch next from cursor_table
	into @datea,@carno,@oil,@etc
	while(@@FETCH_STATUS <> -1)
	begin		
		select @n = 1,@curoil=@oil,@curetc=@etc
		while(@curoil!=0 or @curetc!=0)
		begin		
			if not exists(select tranno from @ztmp06 where carno=@carno and datea=@datea and recno=@n)
			begin
				if((@curoil=@oil and @oil!=0) or (@curetc=@etc and @etc!=0))
				begin
					--避免LOOP
					select '資料異常 @ztmp01 01',@carno,@datea,@n
					return
				return
				end
				set @n = 1
			end
			select @tranno=tranno,@trannoq=trannoq,@caroil=oil,@caretc=etc 
			from @ztmp06 where carno=@carno and datea=@datea and recno=@n
			if(@tranno is null)
			begin
				select '資料異常 @ztmp01 02',@carno,@datea,@n
				return
			end
			select @diffoil=0,@diffetc=0 
			if(@caroil!=0)
			begin
				set @diffoil = case when @curoil>0 then -1 when @curoil<0 then 1 else 0 end
				set @curoil = @curoil + @diffoil
			end
			if(@caretc!=0)
			begin
				set @diffetc = case when @curetc>0 then -1 when @curetc<0 then 1 else 0 end
				set @curetc = @curetc + @diffetc
			end			
			update #z_tmp set oil=isnull(oil,0)+@diffoil
			,etc=isnull(etc,0)+@diffetc
			where tranno=@tranno and trannoq=@trannoq
			
			set @n = @n + 1
		end
		fetch next from cursor_table
		into @datea,@carno,@oil,@etc
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------------------
	--只保留所設定的日期
	delete #z_tmp where len(trandate)=9 and not(trandate between @t_btrandate and @t_etrandate)
	
	update #z_tmp set profit = isnull(total,0)-isnull(total2,0)-isnull(reserve,0)-isnull(tolls,0)
		+isnull(custplus,0)-isnull(custminus,0)-isnull(carplus,0)+isnull(carminus,0)-isnull(oil,0)-isnull(etc,0)
		-isnull(fixa,0)-isnull(tire,0)-isnull(ticket,0)-isnull(bonus,0)-isnull(tax,0)-isnull(depreciation,0)
	
	delete #z_tmp
	from #z_tmp a
	left join #carteam b on a.carteamno = b.noa
	left join #calctype c on a.calctype = c.noa
	where  not((a.carteamno='zzzzz##') or (a.custno='zzzzz##'))
	and((b.noa is null and len(isnull(a.carteamno,''))>0)
	or (c.noa is null and len(isnull(a.calctype,''))>0)
	or not(a.trandate between @t_btrandate and @t_etrandate)
	or not(a.custno between @t_bcustno and @t_ecustno)
	or not(a.addrno between @t_baddrno and @t_eaddrno)
	or not(a.driverno between @t_bdriverno and @t_edriverno))

	if(LEN(@t_carno)>0)
	begin
		delete #z_tmp
		from #z_tmp a
		left join #carno b on a.carno = b.noa
		where b.noa is null 
	end
	if(LEN(@t_po)>0)
	begin
		delete #z_tmp
		from #z_tmp a
		left join #po b on a.po = b.noa
		where b.noa is null 
	end
	----------------------------------------------------------------------------------------------	
	declare @tmp table(
		page int,
		nn int,
		gno nvarchar(10),
		recno int,
		custno nvarchar(20),
		nick nvarchar(20),
		carteamno nvarchar(20),
		carteam nvarchar(20),
		trandate nvarchar(10),
		addrno nvarchar(20),
		addr nvarchar(40),
		carno nvarchar(20),
		driver nvarchar(20),
		total float,
		total2 float,
		reserve float,
		tolls float,
		custplus float,
		custminus float,
		carplus float,
		carminus float,
		oil float,
		etc float,
		fixa float,
		tire float,
		ticket float,
		bonus float,
		tax float,
		depreciation float,
		profit float
	)
	--------------------------------------------------------------------------------------------
	declare @rowline int -- 每頁可用行數
	declare @endline int -- 頁尾行數
	declare @page int
	declare @recno int
	declare @curline int -- 當前行數
	set @rowline = 31
	set @endline = 1
	set @page=0
	set @curline = 0

	declare @tot int
	
	update #z_tmp set custno = case when len(isnull(custno,''))=0  then 'yyyyy##' else custno end
	
	declare cursor_table cursor for
	select a.custno
	,case when a.custno='yyyyy##' then '無輸入公司' when a.custno='zzzzz##' then '無出車單' when len(isnull(b.nick,''))=0 then a.custno else b.nick end
	,count(1)
	from #z_tmp a
	left join cust b on a.custno=b.noa
	group by a.custno,case when a.custno='yyyyy##' then '無輸入公司' when a.custno='zzzzz##' then '無出車單' when len(isnull(b.nick,''))=0 then a.custno else b.nick end
	order by a.custno
	open cursor_table
	fetch next from cursor_table
	into @custno,@nick,@tot
	while(@@FETCH_STATUS <> -1)
	begin		
		--小計
		select @total=sum(isnull(total,0)),@total2=sum(isnull(total2,0))
			,@reserve=sum(isnull(reserve,0)),@tolls=sum(isnull(tolls,0))
			,@custplus=sum(isnull(custplus,0)),@custminus=sum(isnull(custminus,0))
			,@carplus=sum(isnull(carplus,0)),@carminus=sum(isnull(carminus,0))
			,@oil=sum(isnull(oil,0)),@etc=sum(isnull(etc,0))
			,@fixa=sum(isnull(fixa,0)),@tire=sum(isnull(tire,0))
			,@ticket=sum(isnull(ticket,0)),@bonus=sum(isnull(bonus,0))
			,@tax=sum(isnull(tax,0)),@depreciation=sum(isnull(depreciation,0))
			,@profit=sum(isnull(profit,0))
		from #z_tmp where custno=@custno
		select @gno = case when @profit<=0 then '3' else '2' end
		
		if(@t_option08!='detail')
		begin
			if(@curline%@rowline=0)
			begin	
				insert into @tmp(page,nn,gno,custno,nick)
				select @page,@curline%@rowline,'1',@custno,@nick
				set @curline = @curline + 1
			end		
			insert into @tmp(page,nn,gno,custno,nick
				,total,total2,reserve,tolls,custplus,custminus,carplus,carminus
				,oil,etc,fixa,tire,ticket,bonus,tax,depreciation,profit)
			select @page,@curline%@rowline,@gno,@custno,@nick
				,@total,@total2,@reserve,@tolls,@custplus,@custminus,@carplus,@carminus
				,@oil,@etc,@fixa,@tire,@ticket,@bonus,@tax,@depreciation,@profit
			set @curline = @curline + 1
			--是否換頁
			if(@curline%@rowline=0)
			begin
				set @page = @page + 1
			end
		end
		else
		begin
			--要顯示明細
			if(@curline%@rowline>@rowline-4)--少於4行就跳到次頁
			begin
				while(1=1)
				begin
					insert into @tmp(page,nn,gno,custno,nick)
					select @page,@curline%@rowline,'0',@custno,@nick
					set @curline = @curline + 1
					if(@curline%@rowline=0)
						break
				end
				set @page = @page + 1
			end
			--G.1
			insert into @tmp(page,nn,gno,custno,nick)
			select @page,@curline%@rowline,'1',@custno,@nick
			set @curline = @curline + 1
			
			insert into @tmp(page,nn,gno,custno,nick
				,total,total2,reserve,tolls,custplus,custminus,carplus,carminus
				,oil,etc,fixa,tire,ticket,bonus,tax,depreciation,profit)
			select @page,@curline%@rowline,@gno,@custno,@nick
				,@total,@total2,@reserve,@tolls,@custplus,@custminus,@carplus,@carminus
				,@oil,@etc,@fixa,@tire,@ticket,@bonus,@tax,@depreciation,@profit
			set @curline = @curline + 1
			--是否換頁
			if(@curline%@rowline=0)
			begin	
				set @page = @page + 1
			end
			--明細	
			set @n=0
			set @recno = 1
			declare cursor_table2 cursor for
			select total,total2,reserve,tolls,custplus,custminus,carplus,carminus,oil,etc
				,fixa,tire,ticket,bonus,tax,depreciation,profit,trandate,carno,driver,addrno,addr
			from #z_tmp where custno=@custno
			order by trandate,carno,driver
			open cursor_table2
			fetch next from cursor_table2
			into @total,@total2,@reserve,@tolls,@custplus,@custminus,@carplus,@carminus,@oil,@etc
				,@fixa,@tire,@ticket,@bonus,@tax,@depreciation,@profit,@trandate,@carno,@driver,@addrno,@addr
			while(@@FETCH_STATUS <> -1)
			begin
				set @n = @n + 1
				if(@recno=1)
				begin
					insert into @tmp(page,nn,gno,custno,nick)
					select @page,@curline%@rowline,'4',@custno,@nick
					set @curline = @curline + 1	
				end
				else
				begin
					if(@curline%@rowline=0)
					begin	
						insert into @tmp(page,nn,gno,custno,nick)
						select @page,@curline%@rowline,'5',@custno,@nick
						set @curline = @curline + 1	
					end
				end
				if(@curline%@rowline=@rowline-1 or @tot=@n)
					select @gno = case when @profit<=0 then '9' else '8' end
				else
					select @gno = case when @profit<=0 then '7' else '6' end
				insert into @tmp(page,nn,gno,recno,custno,nick
					,total,total2,reserve,tolls,custplus,custminus,carplus,carminus,oil,etc
					,fixa,tire,ticket,bonus,tax,depreciation,profit,trandate,carno,driver,addrno,addr)
				select @page,@curline%@rowline,@gno,@recno,@custno,@nick
					,@total,@total2,@reserve,@tolls,@custplus,@custminus,@carplus,@carminus,@oil,@etc
					,@fixa,@tire,@ticket,@bonus,@tax,@depreciation,@profit,@trandate,@carno,@driver,@addrno,@addr
				set @curline = @curline + 1
				--是否換頁
				if(@curline%@rowline=0)
				begin	
					set @page = @page + 1
				end
				set @recno = @recno +1
				fetch next from cursor_table2
				into @total,@total2,@reserve,@tolls,@custplus,@custminus,@carplus,@carminus,@oil,@etc
				,@fixa,@tire,@ticket,@bonus,@tax,@depreciation,@profit,@trandate,@carno,@driver,@addrno,@addr
			end
			close cursor_table2
			deallocate cursor_table2
		end
		fetch next from cursor_table
		into @custno,@nick,@tot
	end
	close cursor_table
	deallocate cursor_table	
	
	--總計
	select @total=sum(isnull(total,0)),@total2=sum(isnull(total2,0))
		,@reserve=sum(isnull(reserve,0)),@tolls=sum(isnull(tolls,0))
		,@custplus=sum(isnull(custplus,0)),@custminus=sum(isnull(custminus,0))
		,@carplus=sum(isnull(carplus,0)),@carminus=sum(isnull(carminus,0))
		,@oil=sum(isnull(oil,0)),@etc=sum(isnull(etc,0))
		,@fixa=sum(isnull(fixa,0)),@tire=sum(isnull(tire,0))
		,@ticket=sum(isnull(ticket,0)),@bonus=sum(isnull(bonus,0))
		,@tax=sum(isnull(tax,0)),@depreciation=sum(isnull(depreciation,0))
		,@profit=sum(isnull(profit,0))
	from #z_tmp
	insert into @tmp(page,nn,gno,custno
		,total,total2,reserve,tolls,custplus,custminus,carplus,carminus
		,oil,etc,fixa,tire,ticket,bonus,tax,depreciation,profit)
	select @page,@curline%@rowline,'10',CHAR(255)
		,@total,@total2,@reserve,@tolls,@custplus,@custminus,@carplus,@carminus
		,@oil,@etc,@fixa,@tire,@ticket,@bonus,@tax,@depreciation,@profit
				
	select * 
	,nick g00
	,recno g01
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) g02
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,custplus),1)),4,12)) g03
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,custminus),1)),4,12)) g04
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total2),1)),4,12)) g05
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,carplus),1)),4,12)) g06
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,carminus),1)),4,12)) g07
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,reserve),1)),4,12)) g08
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tolls),1)),4,12)) g09
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,oil),1)),4,12)) g10
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,etc),1)),4,12)) g11
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,fixa),1)),4,12)) g12
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tire),1)),4,12)) g13
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ticket),1)),4,12)) g14
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bonus),1)),4,12)) g15
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax),1)),4,12)) g16
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,depreciation),1)),4,12)) g17
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,profit),1)),4,12)) g18
	,trandate g19
	,carno g20
	,driver g21
	,addr g22
	,case when isnull(total,0)=0 then 0 else CAST(ISNULL(profit,0)*100/total as decimal(10,1)) end g23
	from @tmp order by custno,page,nn;
	
z_trana08:--z_trana08
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_baddrno nvarchar(20)
	declare @t_eaddrno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(max)
	declare @t_po nvarchar(max)
	declare @t_calctype nvarchar(max)
	declare @t_carteam nvarchar(max)
	declare @t_option08 nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_baddrno = case when '#non'=[8] then '' else [8] end
	set @t_eaddrno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_bdriverno = case when '#non'=[10] then '' else [10] end
	set @t_edriverno = case when '#non'=[11] then CHAR(255) else [11] end
	set @t_carno = case when '#non'=[12] then '' else [12] end
	set @t_po = case when '#non'=[13] then '' else [13] end
	set @t_carteam = case when '#non'=[15] then '' else [15] end
	set @t_calctype = case when '#non'=[16] then '' else [16] end
	set @t_option08 = case when '#non'=[39] then '' else [39] end
	----------------------------------------------------------------------------------------------
	declare @string nvarchar(max)
	declare @n int
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carno')is not null
	BEGIN
		set @cmd = 'drop table #carno'
		EXECUTE sp_executesql @cmd
	END
	create table #carno(
		noa nvarchar(20)
	)
	set @string = @t_carno
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carno select @string
			end
			break
		end
		insert into #carno select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#po')is not null
	BEGIN
		set @cmd = 'drop table #po'
		EXECUTE sp_executesql @cmd
	END
	create table #po(
		noa nvarchar(20)
	)
	set @string = @t_po
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #po select @string
			end
			break
		end
		insert into #po select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	declare @mon nvarchar(10)
	declare @datea nvarchar(10)
	declare @custno nvarchar(20)
	declare @carno nvarchar(20)
	declare @driverno nvarchar(20)
	declare @plus float
	declare @minus float
	declare @curplus float
	declare @curminus float
	declare @custplus float
	declare @custminus float
	declare @carplus float
	declare @carminus float
	declare @diffplus float
	declare @diffminus float
	declare @tranno nvarchar(20)
	declare @trannoq nvarchar(10)
	
	declare @fixa float
	declare @tire float
	declare @ticket float
	declare @curfixa float
	declare @curtire float
	declare @curticket float
	declare @carfixa float
	declare @cartire float
	declare @carticket float
	declare @difffixa float
	declare @difftire float
	declare @diffticket float
	
	declare @bonus float
	declare @curbonus float
	declare @carbonus float
	declare @diffbonus float
	
	declare @tax float
	declare @depreciation float
	declare @curtax float
	declare @curdepreciation float
	declare @cartax float
	declare @cardepreciation float
	declare @difftax float
	declare @diffdepreciation float
	
	declare @oil float
	declare @etc float
	declare @curoil float
	declare @curetc float
	declare @caroil float
	declare @caretc float
	declare @diffoil float
	declare @diffetc float
	
	declare @carteamno nvarchar(20)
	declare @carteam nvarchar(20)
	declare @trandate nvarchar(10)
	declare @addrno nvarchar(20)
	declare @addr nvarchar(40)
	--declare @carno nvarchar(20)
	declare @driver nvarchar(20)
	declare @total float
	declare @total2 float
	declare @reserve float
	declare @tolls float
	--declare @custplus float
	--declare @custminus float
	--declare @carplus float
	--declare @carminus float
	--declare @fixa float
	--declare @tire float
	--declare @ticket float
	--declare @bonus float
	--declare @tax float
	--declare @depreciation float
	declare @profit float
	declare @gno nvarchar(10)
	----------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_tmp')is not null
	BEGIN
		set @cmd = 'drop table #z_tmp'
		EXECUTE sp_executesql @cmd
	END
	create table #z_tmp(
		isoutside int,
		tranno nvarchar(20),
		trannoq nvarchar(10),
		datea nvarchar(10),
		trandate nvarchar(10),
		carteamno nvarchar(20),
		carteam nvarchar(20),
		calctype nvarchar(20),
		
		custno nvarchar(20),
		custnick nvarchar(20),
		addrno nvarchar(20),
		addr nvarchar(40),
		
		carno nvarchar(20),
		driverno nvarchar(20),
		driver nvarchar(20),
		miles float,
		po nvarchar(max),
		
		mount float,
		price float,
		total float,
		
		mount2 float,
		price2 float,
		price3 float,
		discount float,
		total2 float,
		
		reserve float,
		tolls float,
		memo nvarchar(max),
		
		custplus float,
		custminus float,
		
		carplus float,
		carminus float,
		oil float,
		etc float,
		fixa float,
		tire float,
		ticket float,
		bonus float,
		tax float,
		depreciation float,	
		
		profit float
	)
	set @cmd = 
	" select isnull(c.isoutside,0),a.noa,a.noq,a.datea,a.trandate,isnull(a.carteamno,''),b.team,a.calctype"+
	" ,isnull(a.custno,''),a.nick,a.straddrno,a.straddr"+
	" ,a.carno,a.driverno,a.driver,isnull(a.miles,0),a.po"+
	" ,a.mount,a.price,a.total"+
	" ,a.mount2,a.price2,a.price3,a.discount,a.total2"+
	" ,a.reserve,a.tolls,a.memo"+
	" from view_trans"+@t_accy+" a"+
	" left join carteam b on a.carteamno = b.noa"+
	" left join calctypes c on a.calctype = c.noa+c.noq"+
	" where (left(a.trandate,6) between left(@t_btrandate,6) and left(@t_etrandate,6))"
	
	create index tranno on #z_tmp(tranno,trannoq)
	insert into #z_tmp(isoutside,tranno,trannoq,datea,trandate,carteamno,carteam,calctype
		,custno,custnick,addrno,addr
		,carno,driverno,driver,miles,po
		,mount,price,total
		,mount2,price2,price3,discount,total2
		,reserve,tolls,memo
	)
	execute sp_executesql @cmd,N'@t_btrandate nvarchar(10),@t_etrandate nvarchar(10)'
	,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate
	----------------------------------------------------------------------------------------------
	--客戶加減項
	declare @tmp01 table(
		mon nvarchar(10),
		custno nvarchar(20),
		plus float,
		minus float,
		custplus float,
		custminus float
	)
	insert into @tmp01(mon,custno,plus,minus)
	select LEFT(a.datea,6),isnull(a.custno,''),SUM(ISNULL(plusmoney,0)),SUM(ISNULL(minusmoney,0)) 
	from custchg a
	--排除 代收、付,暫收
	where (left(a.acc1,4)!='2195') and (left(a.acc1,4)!='1191') 
	and (left(a.acc1,4)!='2191') and (left(a.acc1,4)!='1149') 
	and (left(a.acc1,4)!='1194') and (left(a.acc1,4)!='1129') 
	and left(a.datea,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
	group by LEFT(a.datea,6),isnull(a.custno,'')
	--收金額合計
	declare @tmp01_a table(
		mon nvarchar(10),
		custno nvarchar(20),
		total float
	)
	insert into @tmp01_a(mon,custno,total)
	select LEFT(a.trandate,6),isnull(a.custno,''),SUM(ISNULL(total,0)) 
	from #z_tmp a
	group by LEFT(a.trandate,6),isnull(a.custno,'') 
	--依收金額比例分配加減項金額
	update #z_tmp
	set custplus = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.plus,0)/ISNULL(c.total,0),0)end
		,custminus = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.minus,0)/ISNULL(c.total,0),0)end
	from #z_tmp a
	inner join @tmp01 b on left(a.trandate,6)=b.mon and a.custno = b.custno 
	inner join @tmp01_a c on left(a.trandate,6)=c.mon and a.custno = c.custno 
	--檢查有客戶加減項,但當月無收金額的
	insert into #z_tmp(carteamno,custno,trandate,custplus,custminus,addr)
	select 'zzzzz##',a.custno,a.mon,a.plus,a.minus,c.nick+'當月無出車'
	from @tmp01 a
	left join @tmp01_a b on a.mon=b.mon and a.custno=b.custno
	left join cust c on a.custno=c.noa
	where isnull(b.total,0)=0 and (isnull(a.plus,0)!=0 or isnull(a.minus,0)!=0)
	----修正誤差,由收入最高的依序補回一次補1,LOOP
	update @tmp01
	set custplus = ISNULL(b.custplus,0)
		,custminus = ISNULL(b.custminus,0)
	from @tmp01 a
	inner join (select LEFT(ISNULL(trandate,''),6) mon
		,ISNULL(custno,'') custno
		, SUM(ISNULL(custplus,0)) custplus
		,SUM(ISNULL(custminus,0)) custminus 
		from #z_tmp 
		group by LEFT(ISNULL(trandate,''),6),ISNULL(custno,'')) b on a.mon=b.mon and a.custno=b.custno
	
	--修正誤差用
	declare @ztmp01 table(
		recno int,
		custno nvarchar(20),
		mon nvarchar(10),
		tranno nvarchar(20),
		trannoq nvarchar(10),
		custplus float,
		custminus float
		UNIQUE (recno,custno,mon)
	)
	insert into @ztmp01(recno,custno,mon,tranno,trannoq,custplus,custminus)
	select ROW_NUMBER()over(partition by isnull(custno,''),LEFT(isnull(trandate,''),6) order by isnull(total,0) desc,tranno,trannoq) 
	,isnull(custno,''),LEFT(isnull(trandate,''),6),tranno,trannoq,isnull(custplus,0),isnull(custminus,0)
	from #z_tmp
	
	declare cursor_table cursor for
	select mon,custno,custplus-plus,custminus - minus from @tmp01 
	open cursor_table
	fetch next from cursor_table
	into @mon,@custno,@plus,@minus
	while(@@FETCH_STATUS <> -1)
	begin		
		select @n = 1,@curplus=@plus,@curminus=@minus
		while(@curplus!=0 or @curminus!=0)
		begin		
			if not exists(select tranno from @ztmp01 where custno=@custno and @mon=mon and recno=@n)
			begin
				if((@curplus=@plus and @plus!=0) or (@curminus=@minus and @minus!=0))
				begin
					--避免LOOP
					select '資料異常 @ztmp01 01',@custno,@mon,@n
					return
				return
				end
				set @n = 1
			end
			select @tranno=tranno,@trannoq=trannoq,@custplus=custplus,@custminus=custminus 
			from @ztmp01 where custno=@custno and @mon=mon and recno=@n
			if(@tranno is null)
			begin
				select '資料異常 @ztmp01 02',@custno,@mon,@n
				return
			end
			select @diffplus=0,@diffminus=0 
			if(@custplus!=0)
			begin
				set @diffplus = case when @curplus>0 then -1 when @curplus<0 then 1 else 0 end
				set @curplus = @curplus + @diffplus
			end
			if(@custminus!=0)
			begin
				set @diffminus = case when @curminus>0 then -1 when @curminus<0 then 1 else 0 end
				set @curminus = @curminus + @diffminus
			end			
			update #z_tmp set custplus=isnull(custplus,0)+@diffplus
			,custminus=isnull(custminus,0)+@diffminus 
			where tranno=@tranno and trannoq=@trannoq
			
			set @n = @n + 1
		end
		fetch next from cursor_table
		into @mon,@custno,@plus,@minus
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------------------
	--司機加減項
	declare @tmp02 table(
		mon nvarchar(10),
		carno nvarchar(20),
		driverno nvarchar(20),
		plus float,
		minus float,
		carplus float,
		carminus float
	)
	insert into @tmp02(mon,carno,driverno,plus,minus)
	select LEFT(a.datea,6),isnull(a.carno,''),isnull(a.driverno,''),SUM(ISNULL(plusmoney,0)),SUM(ISNULL(minusmoney,0)) 
	from carchg a
	--排除 代收、付,暫收
	where (left(a.acc1,4)!='2195') and (left(a.acc1,4)!='1191') 
	and (left(a.acc1,4)!='2191') and (left(a.acc1,4)!='1149') 
	and (left(a.acc1,4)!='1194') and (left(a.acc1,4)!='1129') 
	and left(a.datea,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
	group by LEFT(a.datea,6),isnull(a.carno,''),isnull(a.driverno,'')
	--發金額合計
	declare @tmp02_a table(
		mon nvarchar(10),
		carno nvarchar(20),
		driverno nvarchar(20),
		total2 float
	)
	insert into @tmp02_a(mon,carno,driverno,total2)
	select LEFT(a.trandate,6),isnull(a.carno,''),isnull(a.driverno,''),SUM(ISNULL(total2,0)) 
	from #z_tmp a
	group by LEFT(a.trandate,6),isnull(a.carno,''),isnull(a.driverno,'')
	--依發金額比例分配加減項金額
	update #z_tmp
	set carplus = case when ISNULL(c.total2,0)=0 then 0 else round(isnull(a.total2,0)*ISNULL(b.plus,0)/ISNULL(c.total2,0),0)end
		,carminus = case when ISNULL(c.total2,0)=0 then 0 else round(isnull(a.total2,0)*ISNULL(b.minus,0)/ISNULL(c.total2,0),0)end
	from #z_tmp a
	inner join @tmp02 b on left(a.trandate,6)=b.mon and a.carno=b.carno and a.driverno=b.driverno 
	inner join @tmp02_a c on left(a.trandate,6)=c.mon and a.carno=c.carno and a.driverno=c.driverno 
	--檢查有司機加減項,但當月無發金額的
	insert into #z_tmp(carteamno,custno,trandate,carno,driverno,driver,carplus,carminus,addr)
	select 'zzzzz##','zzzzz##',a.mon,a.carno,a.driverno,c.namea,a.plus,a.minus,'當月無出車'
	from @tmp02 a
	left join @tmp02_a b on a.mon=b.mon and a.carno=b.carno and a.driverno=b.driverno
	left join driver c on a.driverno=c.noa
	where isnull(b.total2,0)=0 and (isnull(a.plus,0)!=0 or isnull(a.minus,0)!=0)
	----修正誤差,由發金額最高的依序補回一次補1,LOOP
	update @tmp02
	set carplus = ISNULL(b.carplus,0)
		,carminus = ISNULL(b.carminus,0)
	from @tmp02 a
	inner join (select LEFT(ISNULL(trandate,''),6) mon
		,ISNULL(carno,'') carno
		,ISNULL(driverno,'') driverno
		, SUM(ISNULL(carplus,0)) carplus
		,SUM(ISNULL(carminus,0)) carminus 
		from #z_tmp 
		group by LEFT(ISNULL(trandate,''),6),ISNULL(carno,''),ISNULL(driverno,'')) b 
	on a.mon=b.mon and a.carno=b.carno and a.driverno=b.driverno 
	
	--修正誤差用
	declare @ztmp02 table(
		recno int,
		carno nvarchar(20),
		driverno nvarchar(20),
		mon nvarchar(10),
		tranno nvarchar(20),
		trannoq nvarchar(10),
		carplus float,
		carminus float
		UNIQUE (recno,carno,driverno,mon)
	)
	insert into @ztmp02(recno,carno,driverno,mon,tranno,trannoq,carplus,carminus)
	select ROW_NUMBER()over(partition by isnull(carno,''),isnull(driverno,''),LEFT(isnull(trandate,''),6) order by isnull(total2,0) desc,tranno,trannoq) 
	,isnull(carno,''),isnull(driverno,''),LEFT(isnull(trandate,''),6),tranno,trannoq,isnull(carplus,0),isnull(carminus,0)
	from #z_tmp
	
	declare @xplus float
	declare @xminus float
	
	declare cursor_table cursor for
	select mon,carno,driverno,carplus-plus,carminus - minus from @tmp02
	open cursor_table
	fetch next from cursor_table
	into @mon,@carno,@driverno,@plus,@minus
	while(@@FETCH_STATUS <> -1)
	begin		
		select @n = 1,@curplus=@plus,@curminus=@minus,@xplus=0,@xminus=0
		while(@curplus!=0 or @curminus!=0)
		begin		
			if not exists(select tranno from @ztmp02 where carno=@carno and driverno=@driverno and @mon=mon and recno=@n)
			begin
				if((@curplus=@plus and @plus!=0) or (@curminus=@minus and @minus!=0))
				begin
					--避免LOOP
					--select '資料異常 @ztmp02 01',@carno,@driverno,@mon,@n,@curplus,@curminus
					--return
					select @xplus = @plus,@xminus=@minus
				end
				set @n = 1
			end
			select @tranno=tranno,@trannoq=trannoq,@carplus=carplus,@carminus=carminus 
			from @ztmp02 where carno=@carno and driverno=@driverno and @mon=mon and recno=@n
			if(@tranno is null)
			begin
				select '資料異常 @ztmp02 02',@carno,@driverno,@mon,@n,@curplus,@curminus
				return
			end
			select @diffplus=0,@diffminus=0 
			if(@carplus!=0 or @xplus!=0)
			begin
				set @diffplus = case when @xplus!=0 then -@xplus else case when @curplus>0 then -1 when @curplus<0 then 1 else 0 end end
				set @curplus = @curplus + @diffplus -- @xplus
				set @xplus = 0
			end
			if(@carminus!=0 or @xminus!=0)
			begin
				set @diffminus = case when @xminus!=0 then -@xminus else case when @curminus>0 then -1 when @curminus<0 then 1 else 0 end end
				set @curminus = @curminus + @diffminus
				set @xminus = 0
			end			
			update #z_tmp set carplus=isnull(carplus,0)+@diffplus
			,carminus=isnull(carminus,0)+@diffminus 
			where tranno=@tranno and trannoq=@trannoq
			
			set @n = @n + 1
		end
		fetch next from cursor_table
		into @mon,@carno,@driverno,@plus,@minus
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------------------
	--維修、輪胎、罰單
	declare @tmp03 table(
		mon nvarchar(10),
		carno nvarchar(20),
		driverno nvarchar(20),
		fixa float,
		tire float,
		ticket float,
		carfixa float,
		cartire float,
		carticket float
	)
	insert into @tmp03(mon,carno,driverno,fixa,tire,ticket)
	select mon,carno,driverno,SUM(fixa),SUM(tire),SUM(ticket)
	from(
		select LEFT(a.fixadate,6) mon,isnull(a.carno,'') carno,isnull(a.driverno,'') driverno
		,SUM(ISNULL(a.wmoney,0)) fixa,SUM(ISNULL(a.cmoney,0)) tire,0 ticket 
		from fixa a
		where left(a.fixadate,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
		group by LEFT(a.fixadate,6),isnull(a.carno,''),isnull(a.driverno,'')
		union all
		select LEFT(a.outdate,6),isnull(a.carno,''),isnull(a.driverno,'')
		,0,SUM(ISNULL(a.[money],0)),0
		from fixout a
		where left(a.outdate,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
		group by LEFT(a.outdate,6),isnull(a.carno,''),isnull(a.driverno,'')
		union all
		select LEFT(a.datea,6),isnull(a.carno,''),isnull(a.driverno,'')
		,0,0,sum(isnull(a.comppay,0)) 
		from carborr a
		where left(a.datea,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
		and a.typea='罰單' and isnull(a.comppay,0)!=0
		group by LEFT(a.datea,6),isnull(a.carno,''),isnull(a.driverno,''))a
	group by mon,carno,driverno 
	
	--收金額合計
	declare @tmp03_a table(
		mon nvarchar(10),
		carno nvarchar(20),
		driverno nvarchar(20),
		total float
	)
	insert into @tmp03_a(mon,carno,driverno,total)
	select LEFT(a.trandate,6),isnull(a.carno,''),isnull(a.driverno,''),SUM(ISNULL(total,0)) 
	from #z_tmp a
	group by LEFT(a.trandate,6),isnull(a.carno,''),isnull(a.driverno,'') 
	--依收金額比例分配維修、輪胎、罰單
	update #z_tmp
	set fixa = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.fixa,0)/ISNULL(c.total,0),0)end
		,tire = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.tire,0)/ISNULL(c.total,0),0)end
		,ticket = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.ticket,0)/ISNULL(c.total,0),0)end
	from #z_tmp a
	inner join @tmp03 b on left(a.trandate,6)=b.mon and a.carno=b.carno and a.driverno=b.driverno 
	inner join @tmp03_a c on left(a.trandate,6)=c.mon and a.carno=c.carno and a.driverno=c.driverno 
	--檢查有達成獎金,但當月無收金額的
	insert into #z_tmp(carteamno,custno,trandate,carno,driverno,driver,fixa,tire,ticket,addr)
	select 'zzzzz##','zzzzz##',a.mon,a.carno,a.driverno,c.namea,a.fixa,a.tire,a.ticket,'當月無出車'
	from @tmp03 a
	left join @tmp03_a b on a.mon=b.mon and a.carno=b.carno and a.driverno=b.driverno
	left join driver c on a.driverno=c.noa
	where isnull(b.total,0)=0 and (isnull(a.fixa,0)!=0 or isnull(a.tire,0)!=0 or isnull(a.ticket,0)!=0)
	----修正誤差,由收入最高的依序補回一次補1,LOOP
	update @tmp03
	set carfixa = ISNULL(b.fixa,0)
		,cartire = ISNULL(b.tire,0)
		,carticket = ISNULL(b.ticket,0)
	from @tmp03 a
	inner join (select LEFT(ISNULL(trandate,''),6) mon
		,ISNULL(carno,'') carno
		,ISNULL(driverno,'') driverno
		,SUM(ISNULL(fixa,0)) fixa
		,SUM(ISNULL(tire,0)) tire
		,SUM(ISNULL(ticket,0)) ticket 
		from #z_tmp 
		group by LEFT(ISNULL(trandate,''),6),ISNULL(carno,''),ISNULL(driverno,'')) b 
		on a.mon=b.mon and a.carno=b.carno and a.driverno=b.driverno
	
	--修正誤差用
	declare @ztmp03 table(
		recno int,
		carno nvarchar(20),
		driverno nvarchar(20),
		mon nvarchar(10),
		tranno nvarchar(20),
		trannoq nvarchar(10),
		fixa float,
		tire float,
		ticket float
		UNIQUE (recno,carno,driverno,mon)
	)
	insert into @ztmp03(recno,carno,driverno,mon,tranno,trannoq,fixa,tire,ticket)
	select ROW_NUMBER()over(partition by isnull(carno,''),isnull(driverno,''),LEFT(isnull(trandate,''),6) order by isnull(total,0) desc,tranno,trannoq) 
	,isnull(carno,''),isnull(driverno,''),LEFT(isnull(trandate,''),6),tranno,trannoq,isnull(fixa,0),isnull(tire,0),isnull(ticket,0)
	from #z_tmp
	
	declare cursor_table cursor for
	select mon,carno,driverno,carfixa-fixa,cartire-tire,carticket-ticket from @tmp03 
	open cursor_table
	fetch next from cursor_table
	into @mon,@carno,@driverno,@fixa,@tire,@ticket
	while(@@FETCH_STATUS <> -1)
	begin		
		select @n = 1,@curfixa=@fixa,@curtire=@tire,@curticket=@ticket
		while(@curfixa!=0 or @curtire!=0 or @curticket!=0)
		begin		
			if not exists(select tranno from @ztmp03 where carno=@carno and driverno=@driverno and mon=@mon and recno=@n)
			begin
				if((@curfixa=@fixa and @fixa!=0) or (@curtire=@tire and @tire!=0) or (@curticket=@ticket and @ticket!=0))
				begin
					--避免LOOP
					select '資料異常 @ztmp03 01',@carno,@driverno,@mon,@n
					return
				return
				end
				set @n = 1
			end
			select @tranno=tranno,@trannoq=trannoq,@carfixa=fixa,@cartire=tire,@carticket=ticket
			from @ztmp03 where carno=@carno and driverno=@driverno and mon=@mon and recno=@n
			if(@tranno is null)
			begin
				select '資料異常 @ztmp03 02',@carno,@driverno,@mon,@n
				return
			end
			select @difffixa=0,@difftire=0,@diffticket=0
			if(@carfixa!=0)
			begin
				set @difffixa = case when @curfixa>0 then -1 when @curfixa<0 then 1 else 0 end
				set @curfixa = @curfixa + @difffixa
			end
			if(@cartire!=0)
			begin
				set @difftire = case when @curtire>0 then -1 when @curtire<0 then 1 else 0 end
				set @curtire = @curtire + @difftire
			end
			if(@carticket!=0)
			begin
				set @diffticket = case when @curticket>0 then -1 when @curticket<0 then 1 else 0 end
				set @curticket = @curticket + @diffticket
			end
				
			update #z_tmp set fixa=isnull(fixa,0)+@difffixa
			,tire=isnull(tire,0)+@difftire
			,ticket=isnull(ticket,0)+@diffticket
			where tranno=@tranno and trannoq=@trannoq
			
			set @n = @n + 1
		end
		fetch next from cursor_table
		into @mon,@carno,@driverno,@fixa,@tire,@ticket
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------------------
	--達成獎金
	declare @tmp04 table(
		mon nvarchar(10),
		driverno nvarchar(20),
		bonus float,
		carbonus float
	)
	insert into @tmp04(mon,driverno,bonus)
	select noa,driverno,sum(ISNULL(bonus,0))
	from carsals
	where noa between LEFT(@t_btrandate,6) and LEFT(@t_etrandate,6)
	group by noa,driverno 
	
	--發金額合計 (不包含折扣)
	declare @tmp04_a table(
		mon nvarchar(10),
		driverno nvarchar(20),
		total float
	)
	insert into @tmp04_a(mon,driverno,total)
	select LEFT(a.trandate,6),isnull(a.driverno,''),SUM(round(ISNULL(mount2,0)*(ISNULL(price2,0)+ISNULL(price3,0)),0)) 
	from #z_tmp a
	group by LEFT(a.trandate,6),isnull(a.driverno,'') 
	--依發金額比例分配達成獎金
	update #z_tmp
	set bonus = case when ISNULL(c.total,0)=0 then 0 else round(round(ISNULL(a.mount2,0)*(ISNULL(a.price2,0)+ISNULL(a.price3,0)),0)*ISNULL(b.bonus,0)/ISNULL(c.total,0),0)end
	from #z_tmp a
	inner join @tmp04 b on left(a.trandate,6)=b.mon and a.driverno=b.driverno 
	inner join @tmp04_a c on left(a.trandate,6)=c.mon and a.driverno=c.driverno 
	--檢查有達成獎金,但當月無發金額的
	insert into #z_tmp(carteamno,custno,trandate,driverno,driver,bonus,addr)
	select 'zzzzz##','zzzzz##',a.mon,a.driverno,c.namea,a.bonus,'當月無出車'
	from @tmp04 a
	left join @tmp04_a b on a.mon=b.mon and a.driverno=b.driverno
	left join driver c on a.driverno=c.noa
	where isnull(b.total,0)=0 and (isnull(a.bonus,0)!=0)
	----修正誤差,由收入最高的依序補回一次補1,LOOP
	update @tmp04
	set carbonus = ISNULL(b.bonus,0)
	from @tmp04 a
	inner join (select LEFT(ISNULL(trandate,''),6) mon
		,ISNULL(driverno,'') driverno
		,SUM(ISNULL(bonus,0)) bonus
		from #z_tmp 
		group by LEFT(ISNULL(trandate,''),6),ISNULL(driverno,'')) b 
		on a.mon=b.mon and a.driverno=b.driverno
	
	--修正誤差用
	declare @ztmp04 table(
		recno int,
		driverno nvarchar(20),
		mon nvarchar(10),
		tranno nvarchar(20),
		trannoq nvarchar(10),
		bonus float,
		UNIQUE (recno,driverno,mon)
	)
	insert into @ztmp04(recno,driverno,mon,tranno,trannoq,bonus)
	select ROW_NUMBER()over(partition by isnull(driverno,''),LEFT(isnull(trandate,''),6) order by round(ISNULL(mount2,0)*(ISNULL(price2,0)+ISNULL(price3,0)),0) desc,tranno,trannoq) 
	,isnull(driverno,''),LEFT(isnull(trandate,''),6),tranno,trannoq,isnull(bonus,0)
	from #z_tmp
	
	declare cursor_table cursor for
	select mon,driverno,carbonus-bonus from @tmp04 
	open cursor_table
	fetch next from cursor_table
	into @mon,@driverno,@bonus
	while(@@FETCH_STATUS <> -1)
	begin		
		select @n = 1,@curbonus=@bonus
		while(@curbonus!=0)
		begin		
			if not exists(select tranno from @ztmp04 where driverno=@driverno and mon=@mon and recno=@n)
			begin
				if(@curbonus=@bonus and @bonus!=0)
				begin
					--避免LOOP
					select '資料異常 @ztmp04 01',@driverno,@mon,@n
					return
				return
				end
				set @n = 1
			end
			select @tranno=tranno,@trannoq=trannoq,@carbonus=bonus
			from @ztmp04 where driverno=@driverno and mon=@mon and recno=@n
			if(@tranno is null)
			begin
				select '資料異常 @ztmp04 02',@driverno,@mon,@n
				return
			end
			select @diffbonus=0
			if(@carbonus!=0)
			begin
				set @diffbonus = case when @curbonus>0 then -1 when @curbonus<0 then 1 else 0 end
				set @curbonus = @curbonus + @diffbonus
			end			
				
			update #z_tmp set bonus=isnull(bonus,0)+@diffbonus
			where tranno=@tranno and trannoq=@trannoq
			
			set @n = @n + 1
		end
		fetch next from cursor_table
		into @mon,@driverno,@bonus
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------------------
	--保牌燃、折舊
	declare @tmp05 table(
		mon nvarchar(10),
		carno nvarchar(20),
		tax float,
		depreciation float,
		cartax float,
		cardepreciation float
	)
	insert into @tmp05(mon,carno,tax,depreciation)
	select a.mon,isnull(b.carno,''),sum(ISNULL(a.tax,0)),sum(ISNULL(a.depreciation,0))
	from carts a
	left join cart b on a.noa=b.noa
	where a.mon between LEFT(@t_btrandate,6) and LEFT(@t_etrandate,6)
	group by a.mon,isnull(b.carno,'')
	
	--收金額合計
	declare @tmp05_a table(
		mon nvarchar(10),
		carno nvarchar(20),
		total float
	)
	insert into @tmp05_a(mon,carno,total)
	select LEFT(a.trandate,6),isnull(a.carno,''),SUM(ISNULL(a.total,0)) 
	from #z_tmp a
	group by LEFT(a.trandate,6),isnull(a.carno,'')
	--依收金額比例分配保牌燃、折舊
	update #z_tmp
	set tax = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.tax,0)/ISNULL(c.total,0),0)end
	,depreciation = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.depreciation,0)/ISNULL(c.total,0),0)end
	from #z_tmp a
	inner join @tmp05 b on left(a.trandate,6)=b.mon and a.carno=b.carno
	inner join @tmp05_a c on left(a.trandate,6)=c.mon and a.carno=c.carno
	--檢查有保牌燃、折舊,但當月無收金額的
	insert into #z_tmp(carteamno,custno,trandate,carno,tax,depreciation,addr)
	select 'zzzzz##','zzzzz##',a.mon,a.carno,a.tax,a.depreciation,'當月無出車'
	from @tmp05 a
	left join @tmp05_a b on a.mon=b.mon and a.carno=b.carno
	where isnull(b.total,0)=0 and (isnull(a.tax,0)!=0 or isnull(a.depreciation,0)!=0)
	
	----修正誤差,由收入最高的依序補回一次補1,LOOP
	update @tmp05
	set cartax = ISNULL(b.tax,0),cardepreciation = ISNULL(b.depreciation,0)
	from @tmp05 a
	inner join (select LEFT(ISNULL(trandate,''),6) mon
		,ISNULL(carno,'') carno
		,SUM(ISNULL(tax,0)) tax
		,SUM(ISNULL(depreciation,0)) depreciation
		from #z_tmp 
		group by LEFT(ISNULL(trandate,''),6),ISNULL(carno,'')) b 
		on a.mon=b.mon and a.carno=b.carno
	
	--修正誤差用
	declare @ztmp05 table(
		recno int,
		carno nvarchar(20),
		mon nvarchar(10),
		tranno nvarchar(20),
		trannoq nvarchar(10),
		tax float,
		depreciation float,
		UNIQUE (recno,carno,mon)
	)
	insert into @ztmp05(recno,carno,mon,tranno,trannoq,tax,depreciation)
	select ROW_NUMBER()over(partition by isnull(carno,''),LEFT(isnull(trandate,''),6) order by isnull(total,0) desc,tranno,trannoq) 
	,isnull(carno,''),LEFT(isnull(trandate,''),6),tranno,trannoq,isnull(tax,0),isnull(depreciation,0)
	from #z_tmp
	
	declare cursor_table cursor for
	select mon,carno,cartax-tax,cardepreciation-depreciation from @tmp05
	open cursor_table
	fetch next from cursor_table
	into @mon,@carno,@tax,@depreciation
	while(@@FETCH_STATUS <> -1)
	begin		
		select @n = 1,@curtax=@tax,@curdepreciation=@depreciation
		while(@curtax!=0 or @curdepreciation!=0)
		begin		
			if not exists(select tranno from @ztmp05 where carno=@carno and mon=@mon and recno=@n)
			begin
				if((@curtax=@tax and @tax!=0) or (@curdepreciation=@depreciation and @depreciation!=0))
				begin
					--避免LOOP
					select '資料異常 @ztmp05 01',@carno,@mon,@n,@tax,@depreciation
					return
				return
				end
				set @n = 1
			end
			select @tranno=tranno,@trannoq=trannoq,@cartax=tax,@cardepreciation=@depreciation
			from @ztmp05 where carno=@carno and mon=@mon and recno=@n
			if(@tranno is null)
			begin
				select '資料異常 @ztmp05 02',@carno,@mon,@n
				return
			end
			select @difftax=0,@diffdepreciation=0
			if(@cartax!=0)
			begin
				set @difftax = case when @curtax>0 then -1 when @curtax<0 then 1 else 0 end
				set @curtax = @curtax + @difftax
			end			
			if(@cardepreciation!=0)
			begin
				set @diffdepreciation = case when @curdepreciation>0 then -1 when @curdepreciation<0 then 1 else 0 end
				set @curdepreciation = @curdepreciation + @diffdepreciation
			end	
				
			update #z_tmp set tax=isnull(tax,0)+@difftax,depreciation=ISNULL(depreciation,0)+@diffdepreciation
			where tranno=@tranno and trannoq=@trannoq
			
			set @n = @n + 1
		end
		fetch next from cursor_table
		into @mon,@carno,@tax,@depreciation
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------------------
	--加油,ETC
	declare @tmp06 table(
		datea nvarchar(10),
		carno nvarchar(20),
		oil float,
		etc float,
		caroil float,
		caretc float
	)
	insert into @tmp06(datea,carno,oil,etc)
	select a.datea,a.carno,SUM(a.oil),SUM(a.etc)
	from
		(select a.datea,isnull(a.carno,'') carno,SUM(ISNULL(a.[money],0)) oil,0  etc
		from oil a
		where left(a.datea,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
		group by a.datea,isnull(a.carno,'')
		union all
		select a.datea,isnull(a.carno,''),0,SUM(ISNULL(a.[money],0))
		from etc a
		where (typea='ETC' or typea='CASH')
		and left(a.datea,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
		group by a.datea,isnull(a.carno,'')) a
	group by a.datea,a.carno
	--收金額合計
	declare @tmp06_a table(
		datea nvarchar(10),
		carno nvarchar(20),
		total float
	)
	insert into @tmp06_a(datea,carno,total)
	select a.trandate,isnull(a.carno,''),SUM(ISNULL(total,0)) 
	from #z_tmp a
	group by a.trandate,isnull(a.carno,'')
	--依收金額比例分配加減項金額
	update #z_tmp
	set oil = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.oil,0)/ISNULL(c.total,0),0)end
		,etc = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.etc,0)/ISNULL(c.total,0),0)end
	from #z_tmp a
	inner join @tmp06 b on a.trandate=b.datea and a.carno = b.carno
	inner join @tmp06_a c on a.trandate=c.datea and a.carno = c.carno
	--檢查有加油或ETC,但當天無收金額的
	insert into #z_tmp(carteamno,custno,trandate,carno,oil,etc,addr)
	select 'zzzzz##','zzzzz##',a.datea,a.carno,a.oil,a.etc,'當日無出車'
	from @tmp06 a
	left join @tmp06_a b on a.datea=b.datea and a.carno=b.carno
	where isnull(b.total,0)=0 and (isnull(a.oil,0)!=0 or isnull(a.etc,0)!=0)
	----修正誤差,由收入最高的依序補回一次補1,LOOP
	update @tmp06
	set caroil = ISNULL(b.oil,0)
		,caretc = ISNULL(b.etc,0)
	from @tmp06 a
	inner join (select ISNULL(trandate,'') datea
		,ISNULL(carno,'') carno
		,SUM(ISNULL(oil,0)) oil
		,SUM(ISNULL(etc,0)) etc
		from #z_tmp 
		group by ISNULL(trandate,''),ISNULL(carno,'')) b on a.datea=b.datea and a.carno=b.carno
	
	--修正誤差用
	declare @ztmp06 table(
		recno int,
		carno nvarchar(20),
		datea nvarchar(10),
		tranno nvarchar(20),
		trannoq nvarchar(10),
		oil float,
		etc float
		UNIQUE (recno,carno,datea)
	)
	insert into @ztmp06(recno,carno,datea,tranno,trannoq,oil,etc)
	select ROW_NUMBER()over(partition by isnull(carno,''),isnull(trandate,'') order by isnull(total,0) desc,tranno,trannoq) 
	,isnull(carno,''),isnull(trandate,''),tranno,trannoq,isnull(oil,0),isnull(etc,0)
	from #z_tmp
	
	declare cursor_table cursor for
	select datea,carno,caroil-oil,caretc - etc from @tmp06
	open cursor_table
	fetch next from cursor_table
	into @datea,@carno,@oil,@etc
	while(@@FETCH_STATUS <> -1)
	begin		
		select @n = 1,@curoil=@oil,@curetc=@etc
		while(@curoil!=0 or @curetc!=0)
		begin		
			if not exists(select tranno from @ztmp06 where carno=@carno and datea=@datea and recno=@n)
			begin
				if((@curoil=@oil and @oil!=0) or (@curetc=@etc and @etc!=0))
				begin
					--避免LOOP
					select '資料異常 @ztmp01 01',@carno,@datea,@n
					return
				return
				end
				set @n = 1
			end
			select @tranno=tranno,@trannoq=trannoq,@caroil=oil,@caretc=etc 
			from @ztmp06 where carno=@carno and datea=@datea and recno=@n
			if(@tranno is null)
			begin
				select '資料異常 @ztmp01 02',@carno,@datea,@n
				return
			end
			select @diffoil=0,@diffetc=0 
			if(@caroil!=0)
			begin
				set @diffoil = case when @curoil>0 then -1 when @curoil<0 then 1 else 0 end
				set @curoil = @curoil + @diffoil
			end
			if(@caretc!=0)
			begin
				set @diffetc = case when @curetc>0 then -1 when @curetc<0 then 1 else 0 end
				set @curetc = @curetc + @diffetc
			end			
			update #z_tmp set oil=isnull(oil,0)+@diffoil
			,etc=isnull(etc,0)+@diffetc
			where tranno=@tranno and trannoq=@trannoq
			
			set @n = @n + 1
		end
		fetch next from cursor_table
		into @datea,@carno,@oil,@etc
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------------------
	--只保留所設定的日期
	delete #z_tmp where len(trandate)=9 and not(trandate between @t_btrandate and @t_etrandate)
	
	update #z_tmp set profit = isnull(total,0)-isnull(total2,0)-isnull(reserve,0)-isnull(tolls,0)
		+isnull(custplus,0)-isnull(custminus,0)-isnull(carplus,0)+isnull(carminus,0)-isnull(oil,0)-isnull(etc,0)
		-isnull(fixa,0)-isnull(tire,0)-isnull(ticket,0)-isnull(bonus,0)-isnull(tax,0)-isnull(depreciation,0)
	
	delete #z_tmp
	from #z_tmp a
	left join #carteam b on a.carteamno = b.noa
	left join #calctype c on a.calctype = c.noa
	where  not((a.carteamno='zzzzz##') or (a.custno='zzzzz##'))
	and((b.noa is null and len(isnull(a.carteamno,''))>0)
	or (c.noa is null and len(isnull(a.calctype,''))>0)
	or not(a.trandate between @t_btrandate and @t_etrandate)
	or not(a.custno between @t_bcustno and @t_ecustno)
	or not(a.addrno between @t_baddrno and @t_eaddrno)
	or not(a.driverno between @t_bdriverno and @t_edriverno))

	if(LEN(@t_carno)>0)
	begin
		delete #z_tmp
		from #z_tmp a
		left join #carno b on a.carno = b.noa
		where b.noa is null 
	end
	if(LEN(@t_po)>0)
	begin
		delete #z_tmp
		from #z_tmp a
		left join #po b on a.po = b.noa
		where b.noa is null 
	end
	----------------------------------------------------------------------------------------------	
	declare @tmp table(
		page int,
		nn int,
		gno nvarchar(10),
		recno int,
		carteamno nvarchar(20),
		carteam nvarchar(20),
		trandate nvarchar(10),
		addrno nvarchar(20),
		addr nvarchar(40),
		carno nvarchar(20),
		driver nvarchar(20),
		total float,
		total2 float,
		reserve float,
		tolls float,
		custplus float,
		custminus float,
		carplus float,
		carminus float,
		oil float,
		etc float,
		fixa float,
		tire float,
		ticket float,
		bonus float,
		tax float,
		depreciation float,
		profit float,
		ordemon nvarchar(max),
		ordetype nvarchar(max),
		ordememo1 nvarchar(max),
		ordememo2 nvarchar(max)
	)
	--------------------------------------------------------------------------------------------
	declare @rowline int -- 每頁可用行數
	declare @endline int -- 頁尾行數
	declare @page int
	declare @recno int
	declare @curline int -- 當前行數
	set @rowline = 31
	set @endline = 1
	set @page=0
	set @curline = 0

	declare @tot int

	declare cursor_table cursor for
	select carteamno,carteam,count(1) from #z_tmp group by carteamno,carteam order by carteamno
	open cursor_table
	fetch next from cursor_table
	into @carteamno,@carteam,@tot
	while(@@FETCH_STATUS <> -1)
	begin		
		--小計
		select @total=sum(isnull(total,0)),@total2=sum(isnull(total2,0))
			,@reserve=sum(isnull(reserve,0)),@tolls=sum(isnull(tolls,0))
			,@custplus=sum(isnull(custplus,0)),@custminus=sum(isnull(custminus,0))
			,@carplus=sum(isnull(carplus,0)),@carminus=sum(isnull(carminus,0))
			,@oil=sum(isnull(oil,0)),@etc=sum(isnull(etc,0))
			,@fixa=sum(isnull(fixa,0)),@tire=sum(isnull(tire,0))
			,@ticket=sum(isnull(ticket,0)),@bonus=sum(isnull(bonus,0))
			,@tax=sum(isnull(tax,0)),@depreciation=sum(isnull(depreciation,0))
			,@profit=sum(isnull(profit,0))
		from #z_tmp where carteamno=@carteamno
		select @gno = case when @profit<=0 then '3' else '2' end
		
		if(@t_option08!='detail')
		begin
			if(@curline%@rowline=0)
			begin	
				insert into @tmp(page,nn,gno,carteamno,carteam)
				select @page,@curline%@rowline,'1',@carteamno,@carteam
				set @curline = @curline + 1
			end		
			insert into @tmp(page,nn,gno,carteamno,carteam
				,total,total2,reserve,tolls,custplus,custminus,carplus,carminus
				,oil,etc,fixa,tire,ticket,bonus,tax,depreciation,profit)
			select @page,@curline%@rowline,@gno,@carteamno,@carteam
				,@total,@total2,@reserve,@tolls,@custplus,@custminus,@carplus,@carminus
				,@oil,@etc,@fixa,@tire,@ticket,@bonus,@tax,@depreciation,@profit
			set @curline = @curline + 1
			--是否換頁
			if(@curline%@rowline=0)
			begin
				set @page = @page + 1
			end
		end
		else
		begin
			--要顯示明細
			if(@curline%@rowline>@rowline-4)--少於4行就跳到次頁
			begin
				while(1=1)
				begin
					insert into @tmp(page,nn,gno,carteamno,carteam)
					select @page,@curline%@rowline,'0',@carteamno,@carteam
					set @curline = @curline + 1
					if(@curline%@rowline=0)
						break
				end
				set @page = @page + 1
			end
			--G.1
			insert into @tmp(page,nn,gno,carteamno,carteam)
			select @page,@curline%@rowline,'1',@carteamno,@carteam
			set @curline = @curline + 1
			
			insert into @tmp(page,nn,gno,carteamno,carteam
				,total,total2,reserve,tolls,custplus,custminus,carplus,carminus
				,oil,etc,fixa,tire,ticket,bonus,tax,depreciation,profit)
			select @page,@curline%@rowline,@gno,@carteamno,@carteam
				,@total,@total2,@reserve,@tolls,@custplus,@custminus,@carplus,@carminus
				,@oil,@etc,@fixa,@tire,@ticket,@bonus,@tax,@depreciation,@profit
			set @curline = @curline + 1
			--是否換頁
			if(@curline%@rowline=0)
			begin	
				set @page = @page + 1
			end
			--明細	
			set @n = 0
			set @recno = 1
			declare cursor_table2 cursor for
			select total,total2,reserve,tolls,custplus,custminus,carplus,carminus,oil,etc
				,fixa,tire,ticket,bonus,tax,depreciation,profit,trandate,carno,driver,addrno,addr
			from #z_tmp where carteamno=@carteamno
			order by trandate,carno,driver
			open cursor_table2
			fetch next from cursor_table2
			into @total,@total2,@reserve,@tolls,@custplus,@custminus,@carplus,@carminus,@oil,@etc
				,@fixa,@tire,@ticket,@bonus,@tax,@depreciation,@profit,@trandate,@carno,@driver,@addrno,@addr
			while(@@FETCH_STATUS <> -1)
			begin
				set @n = @n + 1
				if(@recno=1)
				begin
					insert into @tmp(page,nn,gno,carteamno,carteam)
					select @page,@curline%@rowline,'4',@carteamno,@carteam
					set @curline = @curline + 1	
				end
				else
				begin
					if(@curline%@rowline=0)
					begin	
						insert into @tmp(page,nn,gno,carteamno,carteam)
						select @page,@curline%@rowline,'5',@carteamno,@carteam
						set @curline = @curline + 1	
					end
				end
				if(@curline%@rowline=@rowline-1 or @tot=@n)
					select @gno = case when @profit<=0 then '9' else '8' end
				else
					select @gno = case when @profit<=0 then '7' else '6' end
				insert into @tmp(page,nn,gno,recno,carteamno,carteam
					,total,total2,reserve,tolls,custplus,custminus,carplus,carminus,oil,etc
					,fixa,tire,ticket,bonus,tax,depreciation,profit,trandate,carno,driver,addrno,addr)
				select @page,@curline%@rowline,@gno,@recno,@carteamno,case when @curline%@rowline=0 then @carteam else '' end
					,@total,@total2,@reserve,@tolls,@custplus,@custminus,@carplus,@carminus,@oil,@etc
					,@fixa,@tire,@ticket,@bonus,@tax,@depreciation,@profit,@trandate,@carno,@driver,@addrno,@addr
				set @curline = @curline + 1
				--是否換頁
				if(@curline%@rowline=0)
				begin	
					set @page = @page + 1
				end
				set @recno = @recno +1
				fetch next from cursor_table2
				into @total,@total2,@reserve,@tolls,@custplus,@custminus,@carplus,@carminus,@oil,@etc
				,@fixa,@tire,@ticket,@bonus,@tax,@depreciation,@profit,@trandate,@carno,@driver,@addrno,@addr
			end
			close cursor_table2
			deallocate cursor_table2
		end
		fetch next from cursor_table
		into @carteamno,@carteam,@tot
	end
	close cursor_table
	deallocate cursor_table	
	
	--總計
	select @total=sum(isnull(total,0)),@total2=sum(isnull(total2,0))
		,@reserve=sum(isnull(reserve,0)),@tolls=sum(isnull(tolls,0))
		,@custplus=sum(isnull(custplus,0)),@custminus=sum(isnull(custminus,0))
		,@carplus=sum(isnull(carplus,0)),@carminus=sum(isnull(carminus,0))
		,@oil=sum(isnull(oil,0)),@etc=sum(isnull(etc,0))
		,@fixa=sum(isnull(fixa,0)),@tire=sum(isnull(tire,0))
		,@ticket=sum(isnull(ticket,0)),@bonus=sum(isnull(bonus,0))
		,@tax=sum(isnull(tax,0)),@depreciation=sum(isnull(depreciation,0))
		,@profit=sum(isnull(profit,0))
	from #z_tmp
	insert into @tmp(page,nn,gno,carteamno
		,total,total2,reserve,tolls,custplus,custminus,carplus,carminus
		,oil,etc,fixa,tire,ticket,bonus,tax,depreciation,profit)
	select @page,@curline%@rowline,'10',CHAR(255)
		,@total,@total2,@reserve,@tolls,@custplus,@custminus,@carplus,@carminus
		,@oil,@etc,@fixa,@tire,@ticket,@bonus,@tax,@depreciation,@profit
	-----------------------------------------------------------------------------------------------------
	--訂單
	declare @curtime datetime
	set @curtime = CURRENT_TIMESTAMP
	declare @curdate nvarchar(10)
	set @curdate = cast(Year(@curtime)-1911 as nvarchar)
		+'/'+ right('00'+cast(Month(@curtime) as nvarchar),2)
		+'/'+ right('00'+cast(Day(@curtime) as nvarchar),2)
	
	declare @curmon nvarchar(10)
	declare @bmon nvarchar(10)
	declare @bbmon nvarchar(10)
	set @curmon = cast(Year(@curtime)-1911 as nvarchar)
		+'/'+ right('00'+cast(Month(@curtime) as nvarchar),2)
	set @bmon =  cast(Year(dateadd(mm,-1,@curtime))-1911 as nvarchar) 
		+'/'+ right('00'+cast(Month(dateadd(mm,-1,@curtime)) as nvarchar),2)
	set @bbmon =  cast(Year(dateadd(mm,-2,@curtime))-1911 as nvarchar) 
		+'/'+ right('00'+cast(Month(dateadd(mm,-2,@curtime)) as nvarchar),2)
	
	declare @tmporde table(
		ctype nvarchar(max),
		ordemon nvarchar(10),
		ordemount float,
		ordeunit nvarchar(max),
		transvccemount float
	)
	declare @ctype nvarchar(max)
	declare @ordemon nvarchar(10)
	declare @ordemount float
	declare @ordeunit nvarchar(max)
	declare @transvccemount float
	
	set @cmd =
	" select ctype,LEFT(a.strdate,6),sum(isnull(a.mount,0)),a.unit,sum(isnull(b.mount,0))"+
	" from view_tranorde"+@t_accy+" a"+
	" outer apply("+
	" 	select sum(isnull(x.mount,0)) mount "+
	" 	from transvcces"+@t_accy+" x"+
	" 	left join transvcce"+@t_accy+" y on x.noa=y.noa"+
	" 	where y.ordeno=a.noa) b"+
	--" where LEFT(a.strdate,6)=@curmon or LEFT(a.strdate,6)=@bmon or LEFT(a.strdate,6)=@bbmon"+
	" where LEFT(a.strdate,6)=@curmon"+
	" group by ctype,LEFT(a.strdate,6),unit"+
	" having sum(isnull(a.mount,0))!=0"
	insert into @tmporde
	execute sp_executesql @cmd,N'@curmon nvarchar(10),@bmon nvarchar(10),@bbmon nvarchar(10)'
	,@curmon=@curmon,@bmon=@bmon,@bbmon=@bbmon
	
	declare @tmporde2 table(
		ctype nvarchar(max),
		ordemon nvarchar(10),
		ordememo1 nvarchar(max),
		ordememo2 nvarchar(max)
	)
	insert into @tmporde2(ctype,ordemon)
	select ctype,mon
	from(select ctype from @tmporde group by ctype) a,
	--(select @curmon mon union all select @bmon union all select @bbmon)b
	(select @curmon mon)b
	order by ctype,mon
	
	declare cursor_table cursor for
	select ctype,ordemon,ordemount,ordeunit,transvccemount from @tmporde
	open cursor_table
	fetch next from cursor_table
	into @ctype,@ordemon,@ordemount,@ordeunit,@transvccemount
	while(@@FETCH_STATUS <> -1)
	begin	
		update @tmporde2 set ordememo1 = ISNULL(ordememo1,'')
			+ case when len(ISNULL(ordememo1,''))=0 then '' else ', 'end
			+ CAST(@ordemount as nvarchar)+@ordeunit
		where ctype=@ctype and ordemon=@ordemon
		if(@ordemount-@transvccemount>0 and @ctype='貨櫃')
		begin
			update @tmporde2 set ordememo2 = ISNULL(ordememo2,'')
				+ case when len(ISNULL(ordememo2,''))=0 then '未派 ' else ', 'end
				+ CAST(@ordemount-@transvccemount as nvarchar)+@ordeunit
			where ctype=@ctype and ordemon=@ordemon
		end
		fetch next from cursor_table
		into @ctype,@ordemon,@ordemount,@ordeunit,@transvccemount
	end
	close cursor_table
	deallocate cursor_table	
	
	insert into @tmp(carteamno,page,nn,gno,ordetype,ordemon,ordememo1,ordememo2)
	select CHAR(255),99999,99999,'11'
		,ctype+'訂單',ordemon,ordememo1,ordememo2
	from @tmporde2
	-----------------------------------------------------------------------------------------------------				
	select * 
	,carteam g00
	,recno g01
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) g02
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,custplus),1)),4,12)) g03
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,custminus),1)),4,12)) g04
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total2),1)),4,12)) g05
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,carplus),1)),4,12)) g06
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,carminus),1)),4,12)) g07
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,reserve),1)),4,12)) g08
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tolls),1)),4,12)) g09
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,oil),1)),4,12)) g10
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,etc),1)),4,12)) g11
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,fixa),1)),4,12)) g12
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tire),1)),4,12)) g13
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ticket),1)),4,12)) g14
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bonus),1)),4,12)) g15
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax),1)),4,12)) g16
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,depreciation),1)),4,12)) g17
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,profit),1)),4,12)) g18
	,trandate g19
	,carno g20
	,driver g21
	,addr g22
	from @tmp order by carteamno,page,nn;

----------------------------------------------------------------------------------------------------
z_trana07:--z_trana07
SET QUOTED_IDENTIFIER OFF 
declare @cmd nvarchar(max) 
declare @t_accy nvarchar(10) 
declare @t_bmon nvarchar(10) 
declare @t_emon nvarchar(10) 
declare @t_bcustno nvarchar(20) 
declare @t_ecustno nvarchar(20) 
declare @t_vccno nvarchar(20) 
declare @t_sort3 nvarchar(20) 
declare @t_bummdate nvarchar(20) 
declare @t_eummdate nvarchar(20) 

set @t_accy = '[1]' 
set @t_bcustno = case when '#non'=[6] then '' else [6] end 
set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
set @t_bmon = case when '#non'=[31] then '' else [31] end 
set @t_emon = case when '#non'=[32] then CHAR(255) else [32] end 
set @t_bummdate = case when '#non'=[35] then '' else [35] end 
set @t_eummdate = case when '#non'=[36] then CHAR(255) else [36] end
set @t_vccno = case when '#non'=[37] then '' else [37] end 
set @t_sort3 = case when '#non2'=[38] then '' else [38] end 
 
-------------------------------------------------------------------------------------------- 
declare @vccno nvarchar(20)
	declare @datea nvarchar(10)
	declare @mon nvarchar(10)
	declare @custno nvarchar(20)
	declare @nick nvarchar(20)
	declare @total float
	declare @unpay float
	declare @ummno nvarchar(20)
	declare @ummnoq nvarchar(10)
	declare @datea2 nvarchar(10)
	declare @chgs float
	declare @paysale float
	declare @t_unpay float
	declare @n int
	declare @checkno nvarchar(20)
	declare @money float
	declare @indate nvarchar(10)
	--------------------------------------------------------------------------------------------
	declare @tmp1 table(
		vccno nvarchar(20),
		datea nvarchar(20),
		mon nvarchar(10),
		custno nvarchar(20),
		nick nvarchar(20),
		total float,
		unpay float
	)
	---------請款單號=0 (立帳請款作業)
	if len(@t_vccno)=0
	begin
		set @cmd =
		" select a.noa,a.datea,a.mon,a.custno,a.nick,a.total,a.unpay"+
		" from view_vcc"+@t_accy+" a"+
		" where (a.mon between @t_bmon and @t_emon)"+
		" and (a.custno between @t_bcustno and @t_ecustno)"
		insert into @tmp1
		execute sp_executesql @cmd,N'@t_bmon nvarchar(10),@t_emon nvarchar(10),@t_bcustno nvarchar(20),@t_ecustno nvarchar(20)'
		,@t_bmon=@t_bmon,@t_emon=@t_emon,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno
	end
	else
	begin
		set @cmd =
		" select a.noa,a.datea,a.mon,a.custno,a.nick,a.total,a.unpay"+
		" from view_vcc"+@t_accy+" a"+
		" where a.noa=@t_vccno"
		insert into @tmp1
		execute sp_executesql @cmd,N'@t_vccno nvarchar(20)',@t_vccno=@t_vccno
	end
	------收款作業--------
	declare @tmp2 table(
		vccno nvarchar(20),
		ummno nvarchar(20),
		ummnoq nvarchar(10),
		datea nvarchar(10),
		chgs float,
		paysale float
	)
	insert into @tmp2
	select a.vccno,a.noa,a.noq,b.datea,a.chgs,a.paysale
	from umms a
	left join umm b on a.noa=b.noa
	left join @tmp1 c on a.vccno=c.vccno
	where (c.vccno is not null) and (a.chgs!=0 or a.paysale!=0)
	
	IF OBJECT_ID('tempdb..#z_ummtran3')is not null
	BEGIN
		set @cmd = 'drop table #z_ummtran3'
		EXECUTE sp_executesql @cmd
	END
	create table #z_ummtran3(
		pno int,
		gno nvarchar(3),
		vccno nvarchar(20),
		datea nvarchar(10),
		mon nvarchar(10),
		custno nvarchar(20),
		nick nvarchar(20),
		total float,
		unpay float,
		ummno nvarchar(20),
		ummnoq nvarchar(10),
		datea2 nvarchar(10),
		chgs float,
		paysale float,
		checkno nvarchar(max)
	)
	
	insert into #z_ummtran3
	select 1,'0',*,'','','',null,null,null from @tmp1------立帳請款作業
	
	declare cursor_table cursor for
	select vccno,datea,mon,custno,nick,total,unpay from @tmp1----請款作業
	open cursor_table
	fetch next from cursor_table
	into @vccno,@datea,@mon,@custno,@nick,@total,@unpay
	while(@@FETCH_STATUS <> -1)
	begin
		select @t_unpay=@total
		declare cursor_table2 cursor for
		select ummno,ummnoq,datea,chgs,paysale from @tmp2 where vccno=@vccno----收款作業
		open cursor_table2
		fetch next from cursor_table2
		into @ummno,@ummnoq,@datea2,@chgs,@paysale
		while(@@FETCH_STATUS <> -1)
		begin
			set @cmd = ''
			declare cursor_table3 cursor for
			select checkno,indate,money from umms where noa=@ummno and len(isnull(checkno,''))>0 --收款作業
			open cursor_table3
			fetch next from cursor_table3
			into @checkno,@indate,@money
			while(@@FETCH_STATUS <> -1)
			begin
				--set @cmd = @cmd + case when LEN(@cmd)>0 then ',&nbsp'+char(59) else '' end + @checkno 
				--+ '&nbsp'+char(59)+ '&nbsp'+char(59)+@indate
				--+ '&nbsp'+char(59)+ '&nbsp'+char(59)+reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,@money),1)),4,12))
				set @cmd = @cmd + case when LEN(@cmd)>0 then ', ' else '' end + @checkno 
				+ ' '+@indate
				+ ' '+reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,@money),1)),4,12))
				
				fetch next from cursor_table3
				into @checkno,@indate,@money
			end
			close cursor_table3
			deallocate cursor_table3
		
			select @t_unpay=@t_unpay-@paysale
			if exists(select * from #z_ummtran3 where vccno=@vccno and len(ummno)=0)
				update #z_ummtran3 set ummno=@ummno,ummnoq=@ummnoq,datea2=@datea2,chgs=@chgs,paysale=@paysale,checkno=@cmd where vccno=@vccno
			else
				insert into #z_ummtran3(pno,gno,vccno,datea,mon,custno,nick,total,unpay,ummno,ummnoq,datea2,chgs,paysale,checkno)
				values(1,'0',@vccno,@datea,@mon,@custno,@nick,@total,@unpay,@ummno,@ummnoq,@datea2,@chgs,@paysale,@cmd)
				
			fetch next from cursor_table2
			into @ummno,@ummnoq,@datea2,@chgs,@paysale
		end
		close cursor_table2
		deallocate cursor_table2
		
		if (@t_unpay-@unpay)!=0
		insert into #z_ummtran3(pno,gno,vccno,mon,nick,total,unpay)
		values(1,'0',@vccno,'異常',cast((@t_unpay-@unpay) as nvarchar),@total,@unpay)
		
		select @n=0
		select @n=COUNT(1) from @tmp2 where vccno=@vccno
		if @n>1
			insert into #z_ummtran3
			select 1,'0',@vccno,@datea,@mon,@custno,@nick,@total,@unpay,CHAR(255),'','小計：',SUM(ISNULL(chgs,0)),SUM(ISNULL(paysale,0)),'' from @tmp2  where vccno=@vccno
		
		insert  into  #z_ummtran3(pno,gno,vccno,custno,total,unpay)values(1,'1',@vccno,@custno,@total,@unpay)
		
		fetch next from cursor_table
		into @vccno,@datea,@mon,@custno,@nick,@total,@unpay
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select vccno from #z_ummtran3 where (datea2 between @t_bummdate and @t_eummdate) group by vccno
	open cursor_table
	fetch next from cursor_table
	into @vccno
	while(@@FETCH_STATUS <> -1)
	begin
		update #z_ummtran3 set gno=gno+'z' where vccno=@vccno	
		fetch next from cursor_table
		into @vccno
	end
	close cursor_table
	deallocate cursor_table
	delete #z_ummtran3 where len(gno)=1
	update #z_ummtran3 set gno=left(gno,1) 
	
	declare @tot_total float
	declare @tot_unpay float
	select @tot_total=0,@tot_unpay=0
	select @tot_total=SUM(ISNULL(total,0)),@tot_unpay=SUM(ISNULL(unpay,0)) from #z_ummtran3 where gno='1'
	
	insert into #z_ummtran3(pno,gno,total,unpay)values(2,'2',@tot_total,@tot_unpay)
	
	set @cmd=
	" select * "+
	" ,vccno g"+
	" ,case when ummno=char(255) or  len(isnull(ummno,''))=0 then  ''  else  (ummno)  end nox"+
	" ,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) ctotal"+
	" ,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,unpay),1)),4,12)) cunpay"+
	" ,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,chgs),1)),4,12)) cchgs"+
	" ,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,paysale),1)),4,12)) cpaysale"+
	" from #z_ummtran3 order by pno,"
	
	if @t_sort3='vccno'
		set @cmd=@cmd+"vccno,gno,ummno"
	else
		if @t_sort3='custno'
			set @cmd=@cmd+@t_sort3+",vccno,gno,ummno"
		else
			set @cmd=@cmd+@t_sort3+" desc,vccno,gno,ummno"
	execute sp_executesql @cmd
	drop table #z_ummtran3;
----------------------------------------------------------------------------------------------------
z_trana06:--z_trana06
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bmon nvarchar(10)
	declare @t_emon nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_trdno nvarchar(20) 
	declare @t_sort3 nvarchar(20)
	declare @t_bummdate nvarchar(20)
	declare @t_eummdate nvarchar(20)
	set @t_accy = [1]
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bmon = case when '#non'=[31] then '' else [31] end
	set @t_emon = case when '#non'=[32] then CHAR(255) else [32] end
	set @t_trdno = case when '#non'=[33] then '' else [33] end
	set @t_sort3 = case when '#non'=[34] then '' else [34] end
	set @t_bummdate = case when '#non'=[35] then '' else [35] end
	set @t_eummdate = case when '#non'=[36] then CHAR(255) else [36] end
	--------------------------------------------------------------------------------------------
	declare @trdno nvarchar(20)
	declare @datea nvarchar(10)
	declare @mon nvarchar(10)
	declare @custno nvarchar(20)
	declare @nick nvarchar(20)
	declare @total float
	declare @unpay float
	declare @ummno nvarchar(20)
	declare @ummnoq nvarchar(10)
	declare @datea2 nvarchar(10)
	declare @chgs float
	declare @paysale float
	declare @t_unpay float
	declare @n int
	declare @checkno nvarchar(20)
	declare @money float
	declare @indate nvarchar(10)
	--------------------------------------------------------------------------------------------
	declare @tmp1 table(
		trdno nvarchar(20),
		datea nvarchar(20),
		mon nvarchar(10),
		custno nvarchar(20),
		nick nvarchar(20),
		total float,
		unpay float
	)
	if len(@t_trdno)=0
	begin
		set @cmd =
		" select a.noa,a.datea,a.mon,a.custno,a.nick,a.total,a.unpay"+
		" from view_trd"+@t_accy+" a"+
		" where (a.mon between @t_bmon and @t_emon)"+
		" and (a.custno between @t_bcustno and @t_ecustno)"
		insert into @tmp1
		execute sp_executesql @cmd,N'@t_bmon nvarchar(10),@t_emon nvarchar(10),@t_bcustno nvarchar(20),@t_ecustno nvarchar(20)'
		,@t_bmon=@t_bmon,@t_emon=@t_emon,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno
	end
	else
	begin
		set @cmd =
		" select a.noa,a.datea,a.mon,a.custno,a.nick,a.total,a.unpay"+
		" from view_trd"+@t_accy+" a"+
		" where a.noa=@t_trdno"
		insert into @tmp1
		execute sp_executesql @cmd,N'@t_trdno nvarchar(20)',@t_trdno=@t_trdno
	end
	
	declare @tmp2 table(
		trdno nvarchar(20),
		ummno nvarchar(20),
		ummnoq nvarchar(10),
		datea nvarchar(10),
		chgs float,
		paysale float
	)
	insert into @tmp2
	select a.vccno,a.noa,a.noq,b.datea,a.chgs,a.paysale
	from umms a
	left join umm b on a.noa=b.noa
	left join @tmp1 c on a.vccno=c.trdno
	where (c.trdno is not null) and (a.chgs!=0 or a.paysale!=0)
	
	IF OBJECT_ID('tempdb..#z_ummtran3')is not null
	BEGIN
		set @cmd = 'drop table #z_ummtran3'
		EXECUTE sp_executesql @cmd
	END
	create table #z_ummtran3(
		pno int,
		gno nvarchar(3),
		trdno nvarchar(20),
		datea nvarchar(10),
		mon nvarchar(10),
		custno nvarchar(20),
		nick nvarchar(20),
		total float,
		unpay float,
		ummno nvarchar(20),
		ummnoq nvarchar(10),
		datea2 nvarchar(10),
		chgs float,
		paysale float,
		checkno nvarchar(max)
	)
	
	insert into #z_ummtran3
	select 1,'0',*,'','','',null,null,null from @tmp1
	
	declare cursor_table cursor for
	select trdno,datea,mon,custno,nick,total,unpay from @tmp1
	open cursor_table
	fetch next from cursor_table
	into @trdno,@datea,@mon,@custno,@nick,@total,@unpay
	while(@@FETCH_STATUS <> -1)
	begin
		select @t_unpay=@total
		declare cursor_table2 cursor for
		select ummno,ummnoq,datea,chgs,paysale from @tmp2 where trdno=@trdno
		open cursor_table2
		fetch next from cursor_table2
		into @ummno,@ummnoq,@datea2,@chgs,@paysale
		while(@@FETCH_STATUS <> -1)
		begin
			set @cmd = ''
			declare cursor_table3 cursor for
			select checkno,indate,money from umms where noa=@ummno and len(isnull(checkno,''))>0
			open cursor_table3
			fetch next from cursor_table3
			into @checkno,@indate,@money
			while(@@FETCH_STATUS <> -1)
			begin
				--set @cmd = @cmd + case when LEN(@cmd)>0 then ',&nbsp'+char(59) else '' end + @checkno 
				--+ '&nbsp'+char(59)+ '&nbsp'+char(59)+@indate
				--+ '&nbsp'+char(59)+ '&nbsp'+char(59)+reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,@money),1)),4,12))
				set @cmd = @cmd + case when LEN(@cmd)>0 then ', ' else '' end + @checkno 
				+ ' '+@indate
				+ ' '+reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,@money),1)),4,12))
				
				fetch next from cursor_table3
				into @checkno,@indate,@money
			end
			close cursor_table3
			deallocate cursor_table3
		
			select @t_unpay=@t_unpay-@paysale
			if exists(select * from #z_ummtran3 where trdno=@trdno and len(ummno)=0)
				update #z_ummtran3 set ummno=@ummno,ummnoq=@ummnoq,datea2=@datea2,chgs=@chgs,paysale=@paysale,checkno=@cmd where trdno=@trdno
			else
				insert into #z_ummtran3(pno,gno,trdno,datea,mon,custno,nick,total,unpay,ummno,ummnoq,datea2,chgs,paysale,checkno)
				values(1,'0',@trdno,@datea,@mon,@custno,@nick,@total,@unpay,@ummno,@ummnoq,@datea2,@chgs,@paysale,@cmd)
				
			fetch next from cursor_table2
			into @ummno,@ummnoq,@datea2,@chgs,@paysale
		end
		close cursor_table2
		deallocate cursor_table2
		
		if (@t_unpay-@unpay)!=0
		insert into #z_ummtran3(pno,gno,trdno,mon,nick,total,unpay)
		values(1,'0',@trdno,'異常',cast((@t_unpay-@unpay) as nvarchar),@total,@unpay)
		
		select @n=0
		select @n=COUNT(1) from @tmp2 where trdno=@trdno
		if @n>1
			insert into #z_ummtran3
			select 1,'0',@trdno,@datea,@mon,@custno,@nick,@total,@unpay,CHAR(255),'','小計：',SUM(ISNULL(chgs,0)),SUM(ISNULL(paysale,0)),'' from @tmp2  where trdno=@trdno
		
		insert  into  #z_ummtran3(pno,gno,trdno,custno,total,unpay)values(1,'1',@trdno,@custno,@total,@unpay)
		
		fetch next from cursor_table
		into @trdno,@datea,@mon,@custno,@nick,@total,@unpay
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select trdno from #z_ummtran3 where (datea2 between @t_bummdate and @t_eummdate) group by trdno
	open cursor_table
	fetch next from cursor_table
	into @trdno
	while(@@FETCH_STATUS <> -1)
	begin
		update #z_ummtran3 set gno=gno+'z' where trdno=@trdno	
		fetch next from cursor_table
		into @trdno
	end
	close cursor_table
	deallocate cursor_table
	delete #z_ummtran3 where len(gno)=1
	update #z_ummtran3 set gno=left(gno,1) 
	
	declare @tot_total float
	declare @tot_unpay float
	select @tot_total=0,@tot_unpay=0
	select @tot_total=SUM(ISNULL(total,0)),@tot_unpay=SUM(ISNULL(unpay,0)) from #z_ummtran3 where gno='1'
	
	insert into #z_ummtran3(pno,gno,total,unpay)values(2,'2',@tot_total,@tot_unpay)
	
	set @cmd=
	" select * "+
	" ,trdno g"+
	" ,case when ummno=char(255) or  len(isnull(ummno,''))=0 then  ''  else  (ummno)  end nox"+
	" ,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) ctotal"+
	" ,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,unpay),1)),4,12)) cunpay"+
	" ,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,chgs),1)),4,12)) cchgs"+
	" ,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,paysale),1)),4,12)) cpaysale"+
	" from #z_ummtran3 order by pno,"
	
	if @t_sort3='trdno'
		set @cmd=@cmd+"trdno,gno,ummno"
	else
		if @t_sort3='custno'
			set @cmd=@cmd+@t_sort3+",trdno,gno,ummno"
		else
			set @cmd=@cmd+@t_sort3+" desc,trdno,gno,ummno"
	execute sp_executesql @cmd
	drop table #z_ummtran3;
---------------------------------------------------------------------------------------------------
z_trana05:--z_trana05高額欠款追蹤依車主
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_xmon nvarchar(10)
	declare @t_sssno nvarchar(20)
	declare @t_bmoney int
	declare @t_emoney int
	declare @t_order nvarchar(20)
	set @t_bcarownerno = case when '#non'=[24] then '' else [24] end
	set @t_ecarownerno  = case when '#non'=[25] then char(255) else [25] end	
	set @t_xmon  = case when '#non'=[26] then '' else [26] end
	set @t_sssno  = case when '#non'=[27] then char(255) else [27] end
	set @t_bmoney = case when '#non'=[28] then -99999999 else [28] end
	set @t_emoney  = case when '#non'=[29] then 99999999 else [29] end
	set @t_order = case when '#non'=[30] then '車主' else [30] end	
		
--************************************************************************************
SET QUOTED_IDENTIFIER OFF
declare @result table(
		gno nvarchar(1),
		noa nvarchar(20),
		mon nvarchar(10),
		carno nvarchar(20),
		carownerno nvarchar(20),
		carowner nvarchar(20),
		cardealno nvarchar(20),
		cardeal nvarchar(20),
		indate nvarchar(10),
		caryear nvarchar(10),
		carbrandno nvarchar(20),
		carbrand nvarchar(20),
		tel nvarchar(50),
		mobile nvarchar(50),
		total float
)
declare @cmd nvarchar(MAX)

set @cmd='select ''0'' gno,isnull(e.noa,''''),isnull(e.mon,''''),isnull(e.carno,''''),a.carownerno
,b.namea,a.cardealno,ISNULL(c.nick,''''),a.indate,a.caryear,a.carbrandno,isnull(d.brand,'''')
,b.tel1,b.mobile,isnull(e.total,0)
from car2 a left join carOwner b on b.noa = a.carownerno
left join  cardeal c on c.noa = a.cardealno
left join carbrand d on d.noa = a.carbrandno
left join cara e on e.carno = a.carno
where (e.mon=@t_xmon) and (isnull(a.carownerno,'''') between @t_bcarownerno and @t_ecarownerno)  
and a.carownerno!='''' and a.carownerno!=''H003'' and a.carownerno!=''H264'' and a.carownerno!=''H326''
and a.carownerno!=''H273'' and a.carownerno!=''H249'' and a.carownerno!=''H041'' and a.noa!=''1111'' and a.noa!=''1120'' and a.noa!=''1122'''

declare @ssscount int
set @ssscount=0

if(@t_sssno!=char(255))
begin
	while(PATINDEX('%,%',@t_sssno)>0)
	begin
		if (@ssscount=0)
			set @cmd=@cmd+' and (a.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		else
			set @cmd=@cmd+' or a.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		set @t_sssno=RIGHT(@t_sssno,LEN(@t_sssno)-PATINDEX('%,%',@t_sssno))
		set @ssscount=@ssscount+1
	end
	if (@ssscount=0)
		set @cmd=@cmd+' and a.sssno='''+@t_sssno+''''
	else
		set @cmd=@cmd+' or a.sssno='''+@t_sssno+''')'
end

insert into @result
execute sp_executesql @cmd,N'@t_xmon nvarchar(10),@t_bcarownerno nvarchar(20),@t_ecarownerno nvarchar(20)',
		@t_xmon=@t_xmon,@t_bcarownerno=@t_bcarownerno,@t_ecarownerno=@t_ecarownerno

--20130327加入vcc未付金額
--declare @carownerno nvarchar(50)
--declare @unpay float
--set @cmd="
--	declare cursor_table cursor for
--	select carownerno,sum(unpay) unpay from (
--	select b.carownerno carownerno,isnull(a.total-a.payed,0) unpay 
--	from vcc"+left(@t_xmon,3)+" a left join car2 b on 
--	(case when (select count(*) from car2 where noa=substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0
--	then substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))else
--	(select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by mon desc,carno)end)=b.noa 
--	left join carbrand d on b.carbrandno=d.noa 
--	left join carOwner e on a.custno=e.noa 
--	where left(a.custno,1)='H' and (left(a.carno,6) <= '"+@t_xmon+"')) a group by carownerno"
--	execute sp_executesql @cmd
	
--open cursor_table 
--fetch next from cursor_table 
--into @carownerno,@unpay
--while(@@FETCH_STATUS <> -1) 
--	begin 
--		update @result
--		set total=total+@unpay
--		where carownerno=@carownerno
		
--		fetch next from cursor_table 
--		into @carownerno,@unpay
--	end 
--close cursor_table 
--deallocate cursor_table 

if(@t_order='車主')
	begin
		insert into @result
		select '1' gno,'',mon,'',carownerno,carowner,'','','','','','','','',SUM(total)
		from @result
		group by carownerno,carowner,mon
		
		delete @result
		where carownerno in(select carownerno from @result where gno=1 and (total not between @t_bmoney and @t_emoney))
		
		insert into @result
		select '2' gno,'','','','',CHAR(255),'','','','','','','','',SUM(total)
		from @result
		where (gno = 1)
		
		select gno,noa,mon,carno,carownerno,carowner,cardealno,cardeal,indate,caryear,carbrandno,carbrand,tel,mobile,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total
		from @result
		order by carowner,gno
	end
if(@t_order='金額')
	begin
	
		declare @tmp table(
				gno nvarchar(1),
				noa nvarchar(20),
				mon nvarchar(10),
				carno nvarchar(20),
				carownerno nvarchar(20),
				carowner nvarchar(20),
				cardealno nvarchar(20),
				cardeal nvarchar(20),
				indate nvarchar(10),
				caryear nvarchar(10),
				carbrandno nvarchar(20),
				carbrand nvarchar(20),
				tel nvarchar(50),
				mobile nvarchar(50),
				total float
		)
		declare @t_carownerno nvarchar(30)
		declare @t_total int

		declare cursor_table cursor for 
		select carownerno,SUM(total)from @result group by carownerno order by sum(total) desc
		open cursor_table 
		fetch next from cursor_table 
		into @t_carownerno,@t_total
		while(@@FETCH_STATUS <> -1) 
			begin 
			insert into @tmp
			select * from @result where carownerno=@t_carownerno
			
			insert into @tmp
			select '1' gno,'','','',@t_carownerno,'','','','','','','','','',@t_total
			
			fetch next from cursor_table 
			into @t_carownerno,@t_total
			end 
		close cursor_table 
		deallocate cursor_table 
		
		
		delete @tmp
		where carownerno in(select carownerno from @tmp where gno=1 and (total not between @t_bmoney and @t_emoney))
		
		insert into @tmp
		select '2' gno,'','','','',CHAR(255),'','','','','','','','',SUM(total)
		from @tmp
		where (gno = 1)
		
		select gno,noa,mon,carno,carownerno,carowner,cardealno,cardeal,indate,caryear,carbrandno,carbrand,tel,mobile,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total
		from @tmp
		
	end;
----------------------------------------------------------------------------------------------------------------------
z_trana04:--z_trana04	
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_baddrno nvarchar(20)
	declare @t_eaddrno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_carkind  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_calctypes  nvarchar(max)
	declare @t_rate nvarchar(10)
	declare @t_sort01 nvarchar(max)
	declare @t_filter01 nvarchar(max)
	declare @t_option01 nvarchar(max)
	declare @t_sort02 nvarchar(max)
	declare @t_filter04 nvarchar(max)
	declare @t_sort04 nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_baddrno = case when '#non'=[8] then '' else [8] end
	set @t_eaddrno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_bdriverno = case when '#non'=[10] then '' else [10] end
	set @t_edriverno = case when '#non'=[11] then CHAR(255) else [11] end	
	set @t_carno = case when '#non'=[12] then '' else [12] end
	set @t_po = case when '#non'=[13] then '' else [13] end
	set @t_carkind  = case when '#non'=[14] then '' else [14] end
	set @t_carteam  = case when '#non'=[15] then '' else [15] end
	set @t_calctypes  = case when '#non'=[16] then '' else [16] end	
	set @t_rate  = case when '#non'=[17] then '' else [17] end
	set @t_sort01  = case when '#non'=[18] then '' else [18] end
	set @t_filter01  = case when '#non'=[19] then '' else [19] end
	set @t_option01  = case when '#non'=[20] then '' else [20] end
	set @t_sort02  = case when '#non'=[21] then '' else [21] end
	set @t_filter04  = case when '#non'=[22] then '' else [22] end
	set @t_sort04 = case when '#non'=[23] then '' else [23] end
	----------------------------------------------------------------------------------
	declare @string nvarchar(max)
	declare @n int
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	IF OBJECT_ID('tempdb..#calctypes')is not null
	BEGIN
		set @cmd = 'drop table #calctypes'
		EXECUTE sp_executesql @cmd
	END
	create table #calctypes(
		noa nvarchar(20)
	)
	set @string = @t_calctypes
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctypes select @string
			end
			break
		end
		insert into #calctypes select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	--出車單
	IF OBJECT_ID('tempdb..#tmp1')is not null
	BEGIN
		set @cmd = 'drop table #tmp1'
		EXECUTE sp_executesql @cmd
	END
	create table #tmp1(
		p bit, -- 最後是否顯示
		tranno nvarchar(20),
		trannoq nvarchar(10),
		trandate nvarchar(20),
		custno nvarchar(20),
		carno nvarchar(20),
		driverno nvarchar(20),
		outside bit, --外車
		po nvarchar(40),
		addrno nvarchar(20),
		addr nvarchar(40),
		inmoney float,
		outmoney float,
		reserve float
	)
	set @cmd = 
	" select 1,a.noa,a.noq,a.trandate,a.custno,a.carno,a.driverno,isnull(b.isoutside,0),isnull(a.po,'')"+
	" ,isnull(a.straddrno,''),isnull(a.straddr,''),a.total,a.total2,a.reserve "+
	" from view_trans"+@t_accy+" a"+
	" left join calctypes b on a.calctype = b.noa+b.noq"+
	" left join car2 c on a.carno=c.carno"+
	" left join #carkind d on c.carkindno=d.noa"+
	" left join #carteam e on a.carteamno=e.noa"+
	" left join #calctypes f on a.calctype=f.noa"+
	" where not (isnull(a.total,0)=0 and isnull(a.total2,0)=0 and isnull(a.reserve,0)=0)"+
	" and (a.trandate between @t_btrandate and @t_etrandate)"+
	" and (a.custno between @t_bcustno and @t_ecustno )"+
	" and (a.straddrno between @t_baddrno and @t_eaddrno )"+
	" and (a.driverno between @t_bdriverno and @t_edriverno )"+
	" and (len(@t_carno)=0 or isnull(a.carno,'')=@t_carno)"+
	" and (len(@t_po)=0 or isnull(a.po,'')=@t_po)"+
	" and (d.noa is not null or exists(select * from #carkind where noa='all'))"+
	" and e.noa is not null"+
	" and f.noa is not null"
	insert into #tmp1
	execute sp_executesql @cmd,N'@t_po nvarchar(20),@t_carno nvarchar(20),@t_bdriverno nvarchar(20),@t_edriverno nvarchar(20),@t_baddrno nvarchar(20),@t_eaddrno nvarchar(20),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10),@t_bcustno nvarchar(10),@t_ecustno nvarchar(10)'
	,@t_po=@t_po,@t_carno=@t_carno,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_baddrno=@t_baddrno,@t_eaddrno=@t_eaddrno,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno
	
	--該時間內所有出車單都需計算
	set @cmd = 
	" select 0,a.noa,a.noq,a.trandate,a.custno,a.carno,a.driverno,isnull(d.isoutside,0),isnull(a.po,'')"+
	" ,isnull(a.straddrno,''),isnull(a.straddr,''),a.total,a.total2,a.reserve "+
	" from view_trans"+@t_accy+" a"+
	" left join #tmp1 b on a.noa=b.tranno and a.noq=b.trannoq"+
	" left join (select left(trandate,6) mon from #tmp1 group by left(trandate,6)) c on left(a.trandate,6) = c.mon 	"+
	" left join calctypes d on a.calctype = d.noa+d.noq"+
	" where b.tranno is null and c.mon is not null"+
	" and not(isnull(a.total,0)=0 and isnull(a.total2,0)=0 and isnull(a.reserve,0)=0)"+
	" order by a.noa"
	insert into #tmp1
	execute sp_executesql @cmd,N'@t_btrandate nvarchar(10),@t_etrandate nvarchar(10),@t_bcustno nvarchar(10),@t_ecustno nvarchar(10)'
	,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno

	--客戶加減項
	declare @tmp2 table(
		mon nvarchar(10),
		custno nvarchar(20),
		plusmoney float,
		minusmoney float
	)
	insert into @tmp2
	select left(a.datea,6),a.custno,sum(isnull(a.plusmoney,0)),sum(isnull(a.minusmoney,0)) from custchg a
	left join (select custno,LEFT(trandate,6) mon from #tmp1 group by custno,LEFT(trandate,6)) b on a.custno=b.custno and left(a.datea,6)=b.mon
	where b.custno is not null and not (ISNULL(a.plusmoney,0)=0 and ISNULL(a.minusmoney,0)=0)
	group by left(a.datea,6),a.custno
	
	--達成金額
	declare @tmp3 table(
		mon nvarchar(10),
		driverno nvarchar(20),
		bonus float
	)
	insert into @tmp3
	select a.noa,a.driverno,a.bonus from carsals a
	left join (select LEFT(trandate,6) mon from #tmp1 group by LEFT(trandate,6)) b on a.noa=b.mon
	where b.mon is not null and ISNULL(a.bonus,0)!=0
	
	--司機加項
	declare @tmp4 table(
		mon nvarchar(10),
		driverno nvarchar(20),
		plusmoney float
	)
	insert into @tmp4
	select left(a.datea,6),a.driverno,SUM(ISNULL(a.plusmoney,0)) from carchg a
	left join (select LEFT(trandate,6) mon from #tmp1 group by LEFT(trandate,6)) b on left(a.datea,6)=b.mon
	where b.mon is not null and ISNULL(a.plusmoney,0)!=0
	group by left(a.datea,6),a.driverno
	
	--維修
	declare @tmp5 table(
		mon nvarchar(10),
		carno nvarchar(20),
		fixamoney float,
		tiremoney float
	)
	insert into @tmp5
	select left(a.fixadate,6),carno,SUM(ISNULL(a.wmoney,0)),SUM(ISNULL(a.cmoney,0)) from fixa a
	left join (select LEFT(trandate,6) mon from #tmp1 group by LEFT(trandate,6)) b on left(a.fixadate,6)=b.mon
	where b.mon is not null and not(ISNULL(a.wmoney,0)=0 and ISNULL(a.cmoney,0)=0)
	group by left(a.fixadate,6),carno
	
	--輪胎、零件領料
	declare @tmp6 table(
		mon nvarchar(10),
		carno nvarchar(20),
		tiremoney float
	)
	insert into @tmp6
	select left(a.outdate,6),carno,SUM(ISNULL(a.[money],0)) from fixout a
	left join (select LEFT(trandate,6) mon from #tmp1 group by LEFT(trandate,6)) b on left(a.outdate,6)=b.mon
	where b.mon is not null and not ISNULL(a.[money],0)=0
	group by left(a.outdate,6),carno
	
	--油費
	declare @tmp7 table(
		mon nvarchar(10),
		carno nvarchar(20),
		oilmoney float
	)
	insert into @tmp7
	select left(a.datea,6),carno,SUM(ISNULL(a.[money],0)) from oil a
	left join (select LEFT(trandate,6) mon from #tmp1 group by LEFT(trandate,6)) b on left(a.datea,6)=b.mon
	where b.mon is not null and not ISNULL(a.[money],0)=0
	group by left(a.datea,6),carno
	--通行費 
	declare @tmp8 table(
		mon nvarchar(10),
		carno nvarchar(20),
		tolls float
	)
	insert into @tmp8
	select left(a.datea,6),carno,SUM(ISNULL(a.[money],0)) from etc a
	left join (select LEFT(trandate,6) mon from #tmp1 group by LEFT(trandate,6)) b on left(a.datea,6)=b.mon
	where b.mon is not null and not ISNULL(a.[money],0)=0 and (typea='ETC' or typea='CASH')
	group by left(a.datea,6),carno
	--罰款 
	declare @tmp9 table(
		mon nvarchar(10),
		driverno nvarchar(20),
		ticket float
	)
	insert into @tmp9
	select left(a.datea,6),a.driverno,SUM(ISNULL(a.comppay,0)) from carborr a
	left join (select LEFT(trandate,6) mon from #tmp1 group by LEFT(trandate,6)) b on left(a.datea,6)=b.mon
	where b.mon is not null and not ISNULL(a.comppay,0)=0 
	group by left(a.datea,6),a.driverno
	--保牌燃費,折舊
	declare @tmp10 table(
		mon nvarchar(10),
		carno nvarchar(20),
		tax float,
		depreciation float
	)
	insert into @tmp10
	select a.mon,b.carno,sum(isnull(a.tax,0)),sum(isnull(a.depreciation,0)) from carts a
	left join cart b on a.noa = b.noa	
	left join (select LEFT(trandate,6) mon from #tmp1 group by LEFT(trandate,6)) c on c.mon=a.mon
	where c.mon is not null and not (ISNULL(a.tax,0)=0 and ISNULL(a.depreciation,0)=0)
	group by a.mon,b.carno
	----------------------------------------------------------------------------------------------------------	
	declare @tmp table( 
		sel int,
		gno nvarchar(3),
		pno int,
		csortkey nvarchar(max),
		nsortkey float,
		p bit,
		tranno nvarchar(20),
		trannoq nvarchar(10),
		custno nvarchar(20),
		carno nvarchar(20),
		driverno nvarchar(20),
		outside bit, --0 公司車, 1 外車
		trandate nvarchar(20),
		tranmon nvarchar(10),
		po nvarchar(40),
		addrno nvarchar(20),
		addr nvarchar(40),
		--收入--
		inmoney float,   --運費收入
		
		--支出--
		-------公司車,外車
		outmoney float,  --業績獎金
		reserve float, --寄櫃費
		
		-----依當月運費收入比例分攤
		custplus float, --客戶加項
		custminus float, --客戶減項
		
		
		-----依當月業績獎金比例分攤
		bonus float,  --達成金額
		carplus float, --司機加項
		fixa float, --維修
		tire float, --輪胎
		oilmoney float, --油費
		tolls float,--通行費 
		ticket float,--罰款 
		tax float,--保牌燃費
		depreciation float,--折舊
		
		--金額修正
		tmoney float,
		
		--淨利
		profit float
	) 
	--客戶收入
	declare @tmpCust table(
		custno nvarchar(20),
		mon nvarchar(10),
		inmoney float
	)
	insert into @tmpCust
	select a.custno,LEFT(a.trandate,6),sum(isnull(a.inmoney,0))
	from #tmp1 a
	group by a.custno,LEFT(a.trandate,6)
	--車輛收入
	declare @tmpCar table(
		carno nvarchar(20),
		mon nvarchar(10),
		outmoney float
	)
	insert into @tmpCar
	select a.carno,LEFT(a.trandate,6),sum(isnull(a.outmoney,0))
	from #tmp1 a
	group by a.carno,LEFT(a.trandate,6)
	--司機收入
	declare @tmpDriver table(
		driverno nvarchar(20),
		mon nvarchar(10),
		outmoney float
	)
	insert into @tmpDriver
	select a.driverno,LEFT(a.trandate,6),sum(isnull(a.outmoney,0))
	from #tmp1 a
	group by a.driverno,LEFT(a.trandate,6)
	
	declare @p bit
	declare @tranno nvarchar(20)
	declare @trannoq nvarchar(10)
	declare @trandate nvarchar(10)
	declare @tranmon nvarchar(10)
	declare @po nvarchar(40)
	declare @addrno nvarchar(20)
	declare @addr nvarchar(40)
	declare @custno nvarchar(20)
	declare @carno nvarchar(20)
	declare @driverno nvarchar(20)
	declare @outside bit
	declare @inmoney float
	declare @outmoney float
	declare @reserve float
	declare @custplus float
	declare @custminus float
	declare @bonus float
	declare @carplus float
	declare @fixa float
	declare @tire float
	declare @oilmoney float
	declare @tolls float
	declare @ticket float
	declare @tax float
	declare @depreciation float
	
	declare @cust_inmoney float
	declare @car_outmoney float
	declare @driver_outmoney float
	declare @tot_custplus float
	declare @tot_custminus float
	declare @tot_bonus float
	declare @tot_carplus float
	declare @tot_fixa float
	declare @tot_tire float
	declare @tot_oilmoney float
	declare @tot_tolls float
	declare @tot_ticket float
	declare @tot_tax float
	declare @tot_depreciation float
	declare @tmoney float
	declare @profit float
	
	declare cursor_table cursor for
	select p,tranno,trannoq,trandate,po,addrno,addr,custno,carno,driverno,outside,isnull(inmoney,0),isnull(outmoney,0),isnull(reserve,0) from #tmp1 
	open cursor_table
	fetch next from cursor_table
	into @p,@tranno,@trannoq,@trandate,@po,@addrno,@addr,@custno,@carno,@driverno,@outside,@inmoney,@outmoney,@reserve
	while(@@FETCH_STATUS <> -1)
	begin
		select @tranmon = LEFT(@trandate,6),@cust_inmoney = 0, @car_outmoney = 0, @driver_outmoney = 0
		,@tot_custplus = 0, @tot_custminus = 0
		,@tot_bonus = 0, @tot_carplus = 0, @tot_fixa = 0, @tot_tire = 0, @tot_oilmoney = 0, @tot_tolls = 0
		,@tot_ticket = 0, @tot_tax = 0, @tot_depreciation = 0
		
		select @cust_inmoney = inmoney from @tmpCust where custno=@custno and mon = @tranmon
		select @car_outmoney = outmoney from @tmpCar where carno=@carno and mon = @tranmon
		select @driver_outmoney = outmoney from @tmpDriver where driverno=@driverno and mon = @tranmon
		
		select @tot_custplus = plusmoney, @tot_custminus = minusmoney from @tmp2 where custno=@custno and mon = @tranmon 	
		select @tot_bonus = bonus from @tmp3 where driverno=@driverno and mon=@tranmon
		select @tot_carplus = plusmoney from @tmp4 where driverno=@driverno and mon=@tranmon
		select @tot_fixa = fixamoney,@tot_tire = tiremoney from @tmp5 where carno=@carno and mon=@tranmon
		select @tot_tire = isnull(@tot_tire,0)+isnull(tiremoney,0) from @tmp6 where carno=@carno and mon=@tranmon
		select @tot_oilmoney = oilmoney from @tmp7 where carno=@carno and mon=@tranmon
		select @tot_tolls = tolls from @tmp8 where carno=@carno and mon=@tranmon
		select @tot_ticket = ticket from @tmp9 where driverno=@driverno and mon=@tranmon
		select @tot_tax = tax, @tot_depreciation = depreciation from @tmp10 where carno=@carno and mon=@tranmon
		
		select @custplus = 0, @custminus = 0
		,@bonus = 0, @carplus = 0, @fixa = 0, @tire = 0, @oilmoney = 0, @tolls = 0
		,@ticket = 0, @tax = 0, @depreciation = 0
		--依運費比較算出 客戶加減項
		if ISNULL(@cust_inmoney,0)!=0
		begin--誤差稍後再修正
			select @custplus = ROUND(@inmoney/@cust_inmoney*@tot_custplus,0)
			,@custminus = ROUND(@inmoney/@cust_inmoney*@tot_custminus,0)
		end
		
		--依司機業績算出 達成獎金
		if ISNULL(@driver_outmoney,0)!=0
		begin--誤差稍後再修正
			select @bonus = ROUND(@outmoney/@driver_outmoney*@tot_bonus,0)
		end
		--依司機業績算出 司機加項
		if ISNULL(@driver_outmoney,0)!=0
		begin--誤差稍後再修正
			select @carplus = ROUND(@outmoney/@driver_outmoney*@tot_carplus,0)
		end
		--依車輛業績算出 維修、輪胎
		if ISNULL(@car_outmoney,0)!=0
		begin--誤差稍後再修正
			select @fixa = ROUND(@outmoney/@car_outmoney*@tot_fixa,0)
			,@tire = ROUND(@outmoney/@car_outmoney*@tot_tire,0)
		end
		--依車輛業績算出 油費
		if ISNULL(@car_outmoney,0)!=0
		begin--誤差稍後再修正
			select @oilmoney = ROUND(@outmoney/@car_outmoney*@tot_oilmoney,0)
		end
		--依車輛業績算出 通行費
		if ISNULL(@car_outmoney,0)!=0
		begin--誤差稍後再修正
			select @tolls = ROUND(@outmoney/@car_outmoney*@tot_tolls,0)
		end
		--依司機業績算出 罰單(公司付)
		if ISNULL(@driver_outmoney,0)!=0
		begin--誤差稍後再修正
			select @ticket = ROUND(@outmoney/@driver_outmoney*@tot_ticket,0)
		end
		--依車輛業績算出 稅費、折舊
		if ISNULL(@car_outmoney,0)!=0
		begin--誤差稍後再修正
			select @tax = ROUND(@outmoney/@car_outmoney*@tot_tax,0)
			,@depreciation = ROUND(@outmoney/@car_outmoney*@tot_depreciation,0)
		end
		
		insert into @tmp(p,tranno,trannoq,trandate,tranmon,po,addrno,addr,custno,carno,driverno,outside,inmoney,outmoney,reserve
		,custplus,custminus,bonus,carplus,fixa,tire,oilmoney,tolls,ticket,tax,depreciation)
		values(@p,@tranno,@trannoq,@trandate,@tranmon,@po,@addrno,@addr,@custno,@carno,@driverno,@outside,@inmoney,@outmoney,@reserve
		,@custplus,@custminus,@bonus,@carplus,@fixa,@tire,@oilmoney,@tolls,@ticket,@tax,@depreciation)

		fetch next from cursor_table
		into @p,@tranno,@trannoq,@trandate,@po,@addrno,@addr,@custno,@carno,@driverno,@outside,@inmoney,@outmoney,@reserve
	end
	close cursor_table
	deallocate cursor_table
	--客戶加項先忽略
	update @tmp set profit = inmoney - outmoney - reserve     -- custplus 
	- custminus - bonus - carplus 
	- fixa - tire - oilmoney - tolls - ticket - tax - depreciation
	--金額四捨五入問題 暫不計算
	
	delete @tmp where p=0	
	--排序 & 總計
	declare @csortkey nvarchar(max)
	declare @nsortkey float

	declare cursor_table cursor for
	select custno,sum(isnull(inmoney,0)),sum(isnull(outmoney,0)),sum(isnull(reserve,0))
	,sum(isnull(custplus,0)),sum(isnull(custminus,0)),sum(isnull(bonus,0)),sum(isnull(carplus,0))
	,sum(isnull(fixa,0)),sum(isnull(tire,0)),sum(isnull(oilmoney,0)),sum(isnull(tolls,0)),sum(isnull(ticket,0))
	,sum(isnull(tax,0)),sum(isnull(depreciation,0)),sum(isnull(tmoney,0)),sum(isnull(profit,0))
	from @tmp group by custno
	open cursor_table
	fetch next from cursor_table
	into @custno,@inmoney,@outmoney,@reserve,@custplus,@custminus,@bonus,@carplus,@fixa,@tire,@oilmoney
		,@tolls,@ticket,@tax,@depreciation,@tmoney,@profit
	while(@@FETCH_STATUS <> -1)
	begin
		select @csortkey='',@nsortkey=-999999999
		if(@t_sort04='custno')
		begin
			set @csortkey=@custno
		end
		if(@t_sort04='inmoney')
		begin
			set @nsortkey=@inmoney
		end
		if(@t_sort04='profit')
		begin
			set @nsortkey=@profit
		end
		update @tmp set gno='1',pno=2,csortkey = @csortkey,nsortkey = @nsortkey where custno=@custno
		insert into @tmp(gno,pno,csortkey,nsortkey,custno,tranno,inmoney,outmoney,reserve,custplus,custminus
			,bonus,carplus,fixa,tire,oilmoney,tolls,ticket,tax,depreciation,tmoney,profit)
		values('2',1,@csortkey,@nsortkey,@custno,CHAR(255),@inmoney,@outmoney,@reserve,@custplus,@custminus
		,@bonus,@carplus,@fixa,@tire,@oilmoney,@tolls,@ticket,@tax,@depreciation,@tmoney,@profit)
		
		fetch next from cursor_table
		into @custno,@inmoney,@outmoney,@reserve,@custplus,@custminus,@bonus,@carplus,@fixa,@tire,@oilmoney
		,@tolls,@ticket,@tax,@depreciation,@tmoney,@profit
	end
	close cursor_table
	deallocate cursor_table

	insert into @tmp
	select null,'3',3,char(255),-9999999999,null,null,null,null,null,null,null,null,null,null,null,null
	,sum(isnull(inmoney,0)),sum(isnull(outmoney,0)),sum(isnull(reserve,0))
	,sum(isnull(custplus,0)),sum(isnull(custminus,0)),sum(isnull(bonus,0)),sum(isnull(carplus,0))
	,sum(isnull(fixa,0)),sum(isnull(tire,0)),sum(isnull(oilmoney,0)),sum(isnull(tolls,0)),sum(isnull(ticket,0))
	,sum(isnull(tax,0)),sum(isnull(depreciation,0)),sum(isnull(tmoney,0)),sum(isnull(profit,0))
	from @tmp where gno='1'
	
	if(patindex("%trans%",@t_filter04)>0)
	begin		
		update @tmp set gno = '4' where gno='1' and profit<0
		update @tmp set gno = '5' where gno='2' and profit<0
	end
	else
	begin
		delete @tmp where gno='1'
		update @tmp set gno = '5' where gno='2' and profit<0
	end
	
	set @cmd = "交運日期："+@t_btrandate + '～'+@t_etrandate
	
	declare @sel int
	set @sel = 1
	if(@t_sort04='inmoney' or @t_sort04='profit')
	begin
		declare cursor_table cursor for
		select custno from @tmp where gno='2' or gno='5' order by nsortkey desc
		open cursor_table
		fetch next from cursor_table
		into @custno
		while(@@FETCH_STATUS <> -1)
		begin
			update @tmp set sel = @sel where (gno='2' or gno='5') and custno=@custno
			set @sel = @sel + 1
			fetch next from cursor_table
			into @custno
		end
		close cursor_table
		deallocate cursor_table
		
		select a.*
		,isnull(b.comp,'') comp
		,isnull(b.nick,'') nick
		,@cmd titlea
		,a.trandate dd
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.inmoney,0)),1)),4,12)) a01
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.outmoney,0)),1)),4,12)) a02
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.reserve,0)),1)),4,12)) a03
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.custplus,0)),1)),4,12)) a04
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.custminus,0)),1)),4,12)) a05
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.bonus,0)),1)),4,12)) a06
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.carplus,0)),1)),4,12)) a07
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.fixa,0)),1)),4,12)) a08
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.tire,0)),1)),4,12)) a09
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.oilmoney,0)),1)),4,12)) a10
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.tolls,0)),1)),4,12)) a11
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.ticket,0)),1)),4,12)) a12
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.tax,0)),1)),4,12)) a13
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.depreciation,0)),1)),4,12)) a14
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.tmoney,0)),1)),4,12)) a15
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.profit,0)),1)),4,12)) a16
		from @tmp a
		left join cust b on a.custno=b.noa
		order by nsortkey desc,pno
	end
	else
	begin
		declare cursor_table cursor for
		select custno from @tmp where gno='2' or gno='5' order by csortkey
		open cursor_table
		fetch next from cursor_table
		into @custno
		while(@@FETCH_STATUS <> -1)
		begin
			update @tmp set sel = @sel where (gno='2' or gno='5') and custno=@custno
			set @sel = @sel + 1
			fetch next from cursor_table
			into @custno
		end
		close cursor_table
		deallocate cursor_table
		
		select a.*
		,isnull(b.comp,'') comp
		,isnull(b.nick,'') nick
		,@cmd titlea
		,a.trandate dd
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.inmoney,0)),1)),4,12)) a01
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.outmoney,0)),1)),4,12)) a02
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.reserve,0)),1)),4,12)) a03
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.custplus,0)),1)),4,12)) a04
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.custminus,0)),1)),4,12)) a05
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.bonus,0)),1)),4,12)) a06
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.carplus,0)),1)),4,12)) a07
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.fixa,0)),1)),4,12)) a08
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.tire,0)),1)),4,12)) a09
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.oilmoney,0)),1)),4,12)) a10
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.tolls,0)),1)),4,12)) a11
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.ticket,0)),1)),4,12)) a12
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.tax,0)),1)),4,12)) a13
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.depreciation,0)),1)),4,12)) a14
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.tmoney,0)),1)),4,12)) a15
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.profit,0)),1)),4,12)) a16
		from @tmp a
		left join cust b on a.custno=b.noa
		order by csortkey,pno
	end
	drop table #tmp1;
	
z_trana03:--z_trana03	
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_baddrno nvarchar(20)
	declare @t_eaddrno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_carkind  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_calctypes  nvarchar(max)
	declare @t_rate nvarchar(10)
	declare @t_sort01 nvarchar(max)
	declare @t_filter01 nvarchar(max)
	declare @t_option01 nvarchar(max)
	declare @t_sort02 nvarchar(max)
	declare @t_filter04 nvarchar(max)
	declare @t_sort04 nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_baddrno = case when '#non'=[8] then '' else [8] end
	set @t_eaddrno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_bdriverno = case when '#non'=[10] then '' else [10] end
	set @t_edriverno = case when '#non'=[11] then CHAR(255) else [11] end	
	set @t_carno = case when '#non'=[12] then '' else [12] end
	set @t_po = case when '#non'=[13] then '' else [13] end
	set @t_carkind  = case when '#non'=[14] then '' else [14] end
	set @t_carteam  = case when '#non'=[15] then '' else [15] end
	set @t_calctypes  = case when '#non'=[16] then '' else [16] end	
	set @t_rate  = case when '#non'=[17] then '' else [17] end
	set @t_sort01  = case when '#non'=[18] then '' else [18] end
	set @t_filter01  = case when '#non'=[19] then '' else [19] end
	set @t_option01  = case when '#non'=[20] then '' else [20] end
	set @t_sort02  = case when '#non'=[21] then '' else [21] end
	set @t_filter04  = case when '#non'=[22] then '' else [22] end
	set @t_sort04 = case when '#non'=[23] then '' else [23] end
	------------------------------------------------------------------------------------------
	set @t_btrandate = case when len(@t_btrandate)=0 then @t_accy+'/01/01' else @t_btrandate end
	set @t_etrandate = case when @t_etrandate=CHAR(255) then @t_accy+'/12/31' else @t_etrandate end
	------------------------------------------------------------------------------------------
	declare @ncarno int
	set @ncarno = 15 -- 一頁顯示幾台車
	declare @carno nvarchar(20)
	declare @datea nvarchar(10)
	declare @field nvarchar(20)
	declare @miles float
	declare @carkindno nvarchar(20)
	declare @carkind nvarchar(20)
	declare @caryear nvarchar(20)
	------------------------------------------------------------------------------------------
	declare @string nvarchar(max)
	declare @n int
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	--日期列表
	declare @t_date nvarchar(10)
	declare @t_date1 nvarchar(10)
	declare @t_date2 nvarchar(10)

	set @t_date1 = convert(nvarchar(4),convert(int,LEFT(@t_btrandate,3))+1911)+'-'+SUBSTRING(@t_btrandate,5,2)+'-'+RIGHT(@t_btrandate,2)
	set @t_date2 = convert(nvarchar(4),convert(int,LEFT(@t_etrandate,3))+1911)+'-'+SUBSTRING(@t_etrandate,5,2)+'-'+RIGHT(@t_etrandate,2)
	set @t_date=@t_date1

	if(isdate(@t_date1)=0 or isdate(@t_date2)=0)
	begin
		print '日期錯誤'
		return	
	end
	--if(DATEDIFF(MM,@t_date1,@t_date2)>2)
	--begin
	--	print '查詢區間不可超過三個月'
	--	return	
	--end
	IF OBJECT_ID('tempdb..#listDate')is not null
	BEGIN
		set @cmd = 'drop table #listDate'
		EXECUTE sp_executesql @cmd
	END
	create table #listDate(
		[date] nvarchar(20)
	)

	while (@t_date between @t_date1 and @t_date2)
	begin
		insert into #listDate select right('00'+convert(nvarchar(3),convert(int,YEAR(@t_date))-1911),3)+'/'+right('0'+convert(nvarchar(2),convert(int,MONTH(@t_date))),2)+'/'+right('0'+convert(nvarchar(2),convert(int,DAY(@t_date))),2)
		set @t_date= convert(date,DATEADD(DD,1,@t_date),111)
	end
	------------------------------------------------------------------------------------------------
	declare @tmp1 table(
		carno nvarchar(20),
		trandate nvarchar(20),
		miles float
	)
	
	set @cmd =
	" select a.carno,a.trandate,sum(ISNULL(miles,0))"+
	" from view_trans"+@t_accy+" a"+
	" left join car2 b on a.carno=b.carno"+
	" left join calctypes c on c.noa+c.noq=a.calctype "+
	" left join #carkind d on b.carkindno=d.noa"+
	" left join carKind e on d.noa=e.noa "+
	" where len(ISNULL(a.carno,''))>0 and isnull(c.isoutside,0)=0"+ --判斷是不是公司車 
	" and (patindex('%option01%',@t_option01)=0 or (patindex('%option01%',@t_option01)>0 and isnull(b.option01,0)=1))"+
	" and d.noa is not null"+
	" and (a.trandate between @t_btrandate and @t_etrandate)"+
	" and (len(@t_carno)=0 or a.carno=@t_carno)"+
	" and ISNULL(a.miles,0)!=0"+
	" group by a.carno,a.trandate"
	
	insert into @tmp1
	execute sp_executesql @cmd,N'@t_option01 nvarchar(max),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10),@t_carno nvarchar(20)'
	,@t_option01=@t_option01,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate,@t_carno=@t_carno
	-------------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_trana03')is not null 
	BEGIN 
		set @cmd = 'drop table #z_trana03' 
		EXECUTE sp_executesql @cmd 
	END 
	create table #z_trana03( 
		n int,
		gno nvarchar(10),
		pno nvarchar(10),
		datea nvarchar(10)
	)
	CREATE INDEX noa ON #z_trana03 (n,datea)
	
	set @n = 1
	while(@n<=@ncarno)
	begin
		set @cmd = "ALTER TABLE #z_trana03 ADD aa"+RIGHT("00"+CAST(@n as nvarchar),2)+" nvarchar(20) NULL"
		+",bb"+RIGHT("00"+CAST(@n as nvarchar),2)+" nvarchar(20) NULL"
		+",cc"+RIGHT("00"+CAST(@n as nvarchar),2)+" nvarchar(20) NULL"
		+",dd"+RIGHT("00"+CAST(@n as nvarchar),2)+" nvarchar(20) NULL"
		execute sp_executesql @cmd
		set @n = @n + 1
	end
	-------------------------------------------------------------------------------------------------
	--車輛欄位對應
	declare @tmp2 table(
		n int,
		field nvarchar(10),
		carno nvarchar(20),
		carkindno nvarchar(20),
		carkind nvarchar(20),
		caryear nvarchar(10)
	)
	insert into @tmp2
	select null,null,a.carno,isnull(b.carkindno,''),isnull(c.kind,''),isnull(b.caryear,'') from @tmp1 a
	left join car2 b on a.carno=b.carno
	left join carKind c on b.carkindno=c.noa
	group by a.carno,isnull(b.carkindno,''),isnull(c.kind,''),isnull(b.caryear,'')
	order by isnull(b.carkindno,''),isnull(b.caryear,''),a.carno
	
	set @n = 0
	declare cursor_table cursor for
	select carno from @tmp2
	open cursor_table
	fetch next from cursor_table
	into @carno
	while(@@FETCH_STATUS <> -1)
	begin
		update @tmp2 set n = floor(@n/@ncarno)+1,field= right("00"+cast(@n%@ncarno+1 as nvarchar),2) where carno=@carno
		set @n = @n + 1
		fetch next from cursor_table
		into @carno
	end
	close cursor_table
	deallocate cursor_table
	------------------------------------------------------------------------------------------------
	--總計欄位
	declare @tmp3 table(
		n int,
		field nvarchar(10)
	)
	insert into @tmp3 select floor(@n/@ncarno)+1, right("00"+cast(@n%@ncarno+1 as nvarchar),2)
	------------------------------------------------------------------------------------------------
	declare @count int
	set @count = floor(@n/@ncarno)+1
	while @count > 0
	begin
		insert into #z_trana03(n,gno,pno,datea)values(@count,'1','2','車輛小計')
		declare cursor_table cursor for
		select [date] from #listDate
		open cursor_table
		fetch next from cursor_table
		into @datea
		while(@@FETCH_STATUS <> -1)
		begin
			insert into #z_trana03(n,gno,pno,datea)values(@count,'0','1',@datea)
			declare cursor_table2 cursor for
			select n,field,carno,carkind,caryear from @tmp2
			open cursor_table2
			fetch next from cursor_table2
			into @n,@field,@carno,@carkind,@caryear
			while(@@FETCH_STATUS <> -1)
			begin
				set @cmd = "update #z_trana03 set aa"+@field+"=@carkind"
				+",bb"+@field+"=@caryear"
				+",cc"+@field+"=@carno"
				+" where n=@n"			
				execute sp_executesql @cmd,N'@n int,@carkind nvarchar(20),@caryear nvarchar(20),@carno nvarchar(20)'
				,@n=@n,@carkind=@carkind,@caryear=@caryear,@carno=@carno
				
				fetch next from cursor_table2
				into @n,@field,@carno,@carkind,@caryear
			end
			close cursor_table2
			deallocate cursor_table2
			
			select @n=null,@field=null
			select @n = n, @field = field from @tmp3 
			set @cmd = "update #z_trana03 set aa"+@field+"=''"
			+",bb"+@field+"='日小計'"
			+",cc"+@field+"=''"
			+" where n=@n"			
			execute sp_executesql @cmd,N'@n int,@carkind nvarchar(20),@caryear nvarchar(20),@carno nvarchar(20)'
			,@n=@n,@carkind=@carkind,@caryear=@caryear,@carno=@carno
			
			fetch next from cursor_table
			into @datea
		end
		close cursor_table
		deallocate cursor_table
		set @count= @count - 1
	end
	---------------------------------------------------------------------------------------
	--每日
	declare cursor_table cursor for
	select a.carno,a.trandate,a.miles,b.n,b.field,b.carkindno,b.carkind,b.caryear from @tmp1 a
	left join @tmp2 b on a.carno=b.carno
	open cursor_table
	fetch next from cursor_table
	into @carno,@datea,@miles,@n,@field,@carkindno,@carkind,@caryear
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd = "update #z_trana03 set dd"+@field+"=reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(@miles,0)),1)),4,12))"
		+" where n=@n and datea=@datea"
		execute sp_executesql @cmd,N'@n int,@datea nvarchar(10),@miles float'
		,@n=@n,@datea=@datea,@miles=@miles
		fetch next from cursor_table
		into @carno,@datea,@miles,@n,@field,@carkindno,@carkind,@caryear
	end
	close cursor_table
	deallocate cursor_table
	--日小計
	declare cursor_table cursor for
	select b.n,b.field,a.trandate,SUM(ISNULL(a.miles,0)) from @tmp1 a,@tmp3 b  
	group by b.n,b.field,a.trandate
	open cursor_table
	fetch next from cursor_table
	into @n,@field,@datea,@miles
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd = "update #z_trana03 set dd"+@field+"=reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(@miles,0)),1)),4,12))"
		+" where n=@n and datea=@datea"
		execute sp_executesql @cmd,N'@n int,@datea nvarchar(10),@miles float'
		,@n=@n,@datea=@datea,@miles=@miles
		fetch next from cursor_table
		into @n,@field,@datea,@miles
	end
	close cursor_table
	deallocate cursor_table
	--車輛小計
	declare cursor_table cursor for
	select a.carno,SUM(ISNULL(a.miles,0)),b.n,b.field,b.carkindno,b.carkind,b.caryear from @tmp1 a
	left join @tmp2 b on a.carno=b.carno
	group by a.carno,b.n,b.field,b.carkindno,b.carkind,b.caryear
	open cursor_table
	fetch next from cursor_table
	into @carno,@miles,@n,@field,@carkindno,@carkind,@caryear
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd = "update #z_trana03 set dd"+@field+"=reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(@miles,0)),1)),4,12))"
		+" where n=@n and gno='1'"
		execute sp_executesql @cmd,N'@n int,@datea nvarchar(10),@miles float'
		,@n=@n,@datea=@datea,@miles=@miles
		fetch next from cursor_table
		into @carno,@miles,@n,@field,@carkindno,@carkind,@caryear
	end
	close cursor_table
	deallocate cursor_table
	
	select @n=null,@field=null,@miles=0
	select @n=n,@field=field from @tmp3
	select @miles=SUM(ISNULL(miles,0)) from @tmp1
	set @cmd = "update #z_trana03 set dd"+@field+"=reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(@miles,0)),1)),4,12))"
	+" where n=@n and gno='1'"
	execute sp_executesql @cmd,N'@n int,@datea nvarchar(10),@miles float'
	,@n=@n,@datea=@datea,@miles=@miles
	
	select * from #z_trana03 order by n,pno,datea
	drop table #z_trana03;

z_trana02:--z_trana02	
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_baddrno nvarchar(20)
	declare @t_eaddrno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_carkind  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_calctypes  nvarchar(max)
	declare @t_rate nvarchar(10)
	declare @t_sort01 nvarchar(max)
	declare @t_filter01 nvarchar(max)
	declare @t_option01 nvarchar(max)
	declare @t_sort02 nvarchar(max)
	declare @t_filter04 nvarchar(max)
	declare @t_sort04 nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_baddrno = case when '#non'=[8] then '' else [8] end
	set @t_eaddrno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_bdriverno = case when '#non'=[10] then '' else [10] end
	set @t_edriverno = case when '#non'=[11] then CHAR(255) else [11] end	
	set @t_carno = case when '#non'=[12] then '' else [12] end
	set @t_po = case when '#non'=[13] then '' else [13] end
	set @t_carkind  = case when '#non'=[14] then '' else [14] end
	set @t_carteam  = case when '#non'=[15] then '' else [15] end
	set @t_calctypes  = case when '#non'=[16] then '' else [16] end	
	set @t_rate  = case when '#non'=[17] then '' else [17] end
	set @t_sort01  = case when '#non'=[18] then '' else [18] end
	set @t_filter01  = case when '#non'=[19] then '' else [19] end
	set @t_option01  = case when '#non'=[20] then '' else [20] end
	set @t_sort02  = case when '#non'=[21] then '' else [21] end
	set @t_filter04  = case when '#non'=[22] then '' else [22] end
	set @t_sort04 = case when '#non'=[23] then '' else [23] end
	----------------------------------------------------------------------------------------------
	declare @string nvarchar(max)
	declare @n int
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_trana02')is not null 
	BEGIN 
		set @cmd = 'drop table #z_trana02' 
		EXECUTE sp_executesql @cmd 
	END 
	create table #z_trana02( 
		carkindno nvarchar(20), 
		carkind nvarchar(20), 
		carno nvarchar(20), 
		mon nvarchar(10), 
		caryear nvarchar(10),--年份

		inmoney float,--收入 
		tranmiles float,--公里數 
		
		oilmoney float,--油費 
		oilmount float,--油量 
		oilmiles float,--公里數
		
		fixa1 float,--修理費
		fixa2 float,--板修理
		tire1 float,--輪胎費
		tire2 float,--板輪胎
		driverpay float,--司機維修負擔

		tolls float,--通行費 
		ticket float,--罰款 
		reserve float,--寄櫃費
		 
		carsal float,--業績獎金 
		tax float,--保牌燃費
		depreciation float,--折舊
		profit float--淨利 
	) 
	---------------------------------------------------------------------------------- 
	declare @carkindno nvarchar(20) 
	declare @carkind nvarchar(20) 
	declare @caryear nvarchar(10) 
	declare @carno nvarchar(20) 
	declare @mon nvarchar(10) 
	declare @inmoney float 
	declare @outmoney float 
	declare @tranmiles float 
	declare @reserve float 

	set @cmd = 
	" declare cursor_table cursor for"+ 
	" select ISNULL(e.noa,'') carkindno,ISNULL(e.kind,'') carkind,ISNULL(b.caryear,'') caryear,isnull(a.carno,'') carno,left(isnull(a.trandate,''),6) mon"+ 
	" ,SUM(ISNULL(a.total,0)) inmoney,SUM(ISNULL(a.miles,0)) tranmiles,SUM(ISNULL(a.reserve,0)) reserve"+ 
	" from view_trans"+@t_accy+" a"+ 
	" left join car2 b on a.carno=b.carno"+ 
	" left join calctypes c on c.noa+c.noq=a.calctype "+ 
	" left join #carkind d on b.carkindno=d.noa"+ 
	" left join carKind e on d.noa=e.noa"+ 
	" where isnull(c.isoutside,0)=0"+ --判斷是不是公司車 
	" and d.noa is not null"+ 
	" and (a.trandate between @t_btrandate and @t_etrandate)"+ 
	" and (len(@t_carno)=0 or a.carno=@t_carno)"+ 
	" group by ISNULL(e.noa,''),ISNULL(e.kind,''),ISNULL(b.caryear,''),isnull(a.carno,''),left(isnull(a.trandate,''),6)"+ 
	" order by carkindno,carkind,caryear,carno,mon"+ 
	" open cursor_table"+ 
	" fetch next from cursor_table"+ 
	" into @carkindno,@carkind,@caryear,@carno,@mon,@inmoney,@tranmiles,@reserve"+ 
	" while(@@FETCH_STATUS <> -1)"+ 
	" begin"+ 
	" insert into #z_trana02(carkindno,carkind,caryear,carno,mon,inmoney,tranmiles,reserve)"+ 
	" values(@carkindno,@carkind,@caryear,@carno,@mon,@inmoney,@tranmiles,@reserve)"+ 

	" fetch next from cursor_table"+ 
	" into @carkindno,@carkind,@caryear,@carno,@mon,@inmoney,@tranmiles,@reserve"+ 
	" end"+ 
	" close cursor_table"+ 
	" deallocate cursor_table" 
	execute sp_executesql @cmd,N'@t_btrandate nvarchar(10),@t_etrandate nvarchar(10),@t_carno nvarchar(20),@carkindno nvarchar(20),@carkind nvarchar(20),@caryear nvarchar(10),@carno nvarchar(20),@mon nvarchar(10),@inmoney float,@tranmiles float,@reserve float' 
	,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate,@t_carno=@t_carno 
	,@carkindno=@carkindno,@carkind=@carkind,@caryear=@caryear,@carno=@carno,@mon=@mon
	,@inmoney=@inmoney,@tranmiles=@tranmiles,@reserve=@reserve 
	------------------------------------------------------------------------------------ 
	--OIL
	declare @oilmount float
	declare @oilmoney float
	declare @oilmiles float
	
	declare cursor_table cursor for
	select ISNULL(e.noa,'') carkindno,ISNULL(e.kind,'') carkind,ISNULL(b.caryear,'') caryear,isnull(a.carno,'') carno,left(isnull(a.datea,''),6) mon
	,sum(ISNULL(a.mount,0)) oilmount,sum(ISNULL(a.[money],0)) oilmoney,sum(ISNULL(a.miles,0)) oilmiles
	from oil a
	left join car2 b on a.carno=b.carno
	left join #carkind d on b.carkindno=d.noa
	left join carKind e on d.noa=e.noa
	where d.noa is not null
	and (a.datea between @t_btrandate and @t_etrandate)
	and (len(@t_carno)=0 or a.carno=@t_carno)
	group by ISNULL(e.noa,''),ISNULL(e.kind,''),ISNULL(b.caryear,''),isnull(a.carno,''),left(isnull(a.datea,''),6)
	order by carkindno,carkind,caryear,carno,mon
	open cursor_table
	fetch next from cursor_table
	into @carkindno,@carkind,@caryear,@carno,@mon,@oilmount,@oilmoney,@oilmiles
	while(@@FETCH_STATUS <> -1)
	begin
		if exists(select * from #z_trana02 where carno=@carno and mon=@mon)
			update #z_trana02 set oilmount=@oilmount,oilmoney=@oilmoney,oilmiles=@oilmiles where carno=@carno and mon=@mon
		else
			insert into #z_trana02(carkindno,carkind,caryear,carno,mon,oilmount,oilmoney,oilmiles)
			values(@carkindno,@carkind,@caryear,@carno,@mon,@oilmount,@oilmoney,@oilmiles)

		fetch next from cursor_table
		into @carkindno,@carkind,@caryear,@carno,@mon,@oilmount,@oilmoney,@oilmiles
	end
	close cursor_table
	deallocate cursor_table
	------------------------------------------------------------------------------------
	--ETC
	declare @tolls float
	
	declare cursor_table cursor for
	select ISNULL(e.noa,'') carkindno,ISNULL(e.kind,'') carkind,ISNULL(b.caryear,'') caryear,isnull(a.carno,'') carno,left(isnull(a.datea,''),6) mon
	,SUM(isnull(a.[money],0)) tolls
	from etc a
	left join car2 b on a.carno=b.carno
	left join #carkind d on b.carkindno=d.noa
	left join carKind e on d.noa=e.noa
	where (a.typea='ETC' or a.typea='CASH') and (d.noa is not null)
	and (a.datea between @t_btrandate and @t_etrandate)
	and (len(@t_carno)=0 or a.carno=@t_carno)
	group by ISNULL(e.noa,''),ISNULL(e.kind,''),ISNULL(b.caryear,''),isnull(a.carno,''),left(isnull(a.datea,''),6)
	order by carkindno,carkind,caryear,carno,mon
	open cursor_table
	fetch next from cursor_table
	into @carkindno,@carkind,@caryear,@carno,@mon,@tolls
	while(@@FETCH_STATUS <> -1)
	begin
		if exists(select * from #z_trana02 where carno=@carno and mon=@mon)
			update #z_trana02 set tolls=@tolls where carno=@carno and mon=@mon
		else
			insert into #z_trana02(carkindno,carkind,caryear,carno,mon,tolls)
			values(@carkindno,@carkind,@caryear,@carno,@mon,@tolls)

		fetch next from cursor_table
		into @carkindno,@carkind,@caryear,@carno,@mon,@tolls
	end
	close cursor_table
	deallocate cursor_table
	--------------------------------------------------------------------------------------
	--維修
	declare @fixa1 float
	declare @fixa2 float
	declare @tire1 float
	declare @tire2 float
	
	declare cursor_table cursor for
	select ISNULL(e.noa,'') carkindno,ISNULL(e.kind,'') carkind,ISNULL(b.caryear,'') caryear,isnull(a.carno,'') carno,left(isnull(a.fixadate,''),6) mon
	,sum(case when len(isnull(a.carplateno,''))=0 then ISNULL(a.wmoney,0)-ISNULL(a.discount,0) else 0 end) fixa1
	,sum(case when len(isnull(a.carplateno,''))>0 then ISNULL(a.wmoney,0)-ISNULL(a.discount,0) else 0 end) fixa2
	,sum(case when len(isnull(a.carplateno,''))=0 then ISNULL(a.cmoney,0) else 0 end) tire1
	,sum(case when len(isnull(a.carplateno,''))>0 then ISNULL(a.cmoney,0) else 0 end) tire2
	from fixa a
	left join car2 b on a.carno=b.carno
	left join #carkind d on b.carkindno=d.noa
	left join carKind e on d.noa=e.noa
	where  d.noa is not null
	and (a.fixadate between @t_btrandate and @t_etrandate)
	and (len(@t_carno)=0 or a.carno=@t_carno)
	group by ISNULL(e.noa,''),ISNULL(e.kind,''),ISNULL(b.caryear,''),isnull(a.carno,''),left(isnull(a.fixadate,''),6)
	order by carkindno,carkind,caryear,carno,mon
	open cursor_table
	fetch next from cursor_table
	into @carkindno,@carkind,@caryear,@carno,@mon,@fixa1,@fixa2,@tire1,@tire2
	while(@@FETCH_STATUS <> -1)
	begin
		if exists(select * from #z_trana02 where carno=@carno and mon=@mon)
			update #z_trana02 set fixa1=@fixa1,fixa2=@fixa2,tire1=@tire1,tire2=@tire2 where carno=@carno and mon=@mon
		else
			insert into #z_trana02(carkindno,carkind,caryear,carno,mon,fixa1,fixa2,tire1,tire2)
			values(@carkindno,@carkind,@caryear,@carno,@mon,@fixa1,@fixa2,@tire1,@tire2)

		fetch next from cursor_table
		into @carkindno,@carkind,@caryear,@carno,@mon,@fixa1,@fixa2,@tire1,@tire2
	end
	close cursor_table
	deallocate cursor_table
	--fixout
	declare cursor_table cursor for
	select ISNULL(e.noa,'') carkindno,ISNULL(e.kind,'') carkind,ISNULL(b.caryear,'') caryear,isnull(a.carno,'') carno,left(isnull(a.outdate,''),6) mon
	,sum(case when len(isnull(a.carplateno,''))=0 then ISNULL(a.[money],0) else 0 end) tire1
	,sum(case when len(isnull(a.carplateno,''))>0 then ISNULL(a.[money],0) else 0 end) tire2
	from fixout a
	left join car2 b on a.carno=b.carno
	left join #carkind d on b.carkindno=d.noa
	left join carKind e on d.noa=e.noa
	where  d.noa is not null
	and (a.outdate between @t_btrandate and @t_etrandate)
	and (len(@t_carno)=0 or a.carno=@t_carno)
	group by ISNULL(e.noa,''),ISNULL(e.kind,''),ISNULL(b.caryear,''),isnull(a.carno,''),left(isnull(a.outdate,''),6)
	order by carkindno,carkind,caryear,carno,mon
	open cursor_table
	fetch next from cursor_table
	into @carkindno,@carkind,@caryear,@carno,@mon,@tire1,@tire2
	while(@@FETCH_STATUS <> -1)
	begin
		if exists(select * from #z_trana02 where carno=@carno and mon=@mon)
			update #z_trana02 set tire1=@tire1,tire2=@tire2 where carno=@carno and mon=@mon
		else
			insert into #z_trana02(carkindno,carkind,caryear,carno,mon,tire1,tire2)
			values(@carkindno,@carkind,@caryear,@carno,@mon,@tire1,@tire2)

		fetch next from cursor_table
		into @carkindno,@carkind,@caryear,@carno,@mon,@tire1,@tire2
	end
	close cursor_table
	deallocate cursor_table
	--------------------------------------------------------------------------------------
	--罰單, 司機維修自付
	declare @ticket float
	declare @driverpay float
	
	declare cursor_table cursor for
	select ISNULL(e.noa,'') carkindno,ISNULL(e.kind,'') carkind,ISNULL(b.caryear,'') caryear,isnull(a.carno,'') carno,left(isnull(a.datea,''),6) mon
	,sum(ISNULL(a.comppay,0)) ticket,sum(case when a.typea='維修' then isnull(a.driverpay,0) else 0 end) driverpay
	from carborr a
	left join car2 b on a.carno=b.carno
	left join #carkind d on b.carkindno=d.noa
	left join carKind e on d.noa=e.noa
	where (isnull(a.comppay,0)!=0 or (a.typea='維修' and isnull(a.driverpay,0)!=0)) and d.noa is not null
	and (a.datea between @t_btrandate and @t_etrandate)
	and (len(@t_carno)=0 or a.carno=@t_carno)
	group by ISNULL(e.noa,''),ISNULL(e.kind,''),ISNULL(b.caryear,''),isnull(a.carno,''),left(isnull(a.datea,''),6)
	order by carkindno,carkind,caryear,carno,mon
	open cursor_table
	fetch next from cursor_table
	into @carkindno,@carkind,@caryear,@carno,@mon,@ticket,@driverpay
	while(@@FETCH_STATUS <> -1)
	begin
		if exists(select * from #z_trana02 where carno=@carno and mon=@mon)
			update #z_trana02 set ticket=@ticket,driverpay=@driverpay where carno=@carno and mon=@mon
		else
			insert into #z_trana02(carkindno,carkind,caryear,carno,mon,ticket,driverpay)
			values(@carkindno,@carkind,@caryear,@carno,@mon,@ticket,@driverpay)

		fetch next from cursor_table
		into @carkindno,@carkind,@caryear,@carno,@mon,@ticket,@driverpay
	end
	close cursor_table
	deallocate cursor_table
	--------------------------------------------------------------------------------------
	--業績獎金,  開2台車以上的,算在收入最高的那台車
	declare @driverno nvarchar(20)
	declare @carsal float
	declare @total float
	declare cursor_table cursor for
	select driverno,noa,[money] from carsals 
	where (noa between left(@t_btrandate,6) and left(@t_etrandate,6))
	open cursor_table
	fetch next from cursor_table
	into @driverno,@mon,@carsal
	while(@@FETCH_STATUS <> -1)
	begin
		select @carno=''
		set @cmd =
		" select top(1) @carno=a.carno,@total=SUM(ISNULL(a.total,0))"+
		" from view_trans"+@t_accy+" a "+
		" where a.driverno=@driverno and LEFT(a.datea,6)=@mon"+
		" group by a.carno"+
		" order by SUM(ISNULL(a.total,0)) desc"
		execute sp_executesql @cmd,N'@driverno nvarchar(20),@mon nvarchar(10),@carno nvarchar(20) output,@total float output'
		,@driverno=@driverno,@mon=@mon,@carno=@carno output,@total=@total output
	
		select @carkindno='',@carkind='',@caryear=''
		select @carkindno=a.carkindno,@carkind=ISNULL(b.kind,''),@caryear=a.caryear
		from car2 a
		left join carKind b on a.carkindno=b.noa
		where a.carno=@carno
		
		--select @carno=''
		--set @cmd = 
		--" select @carkindno=a.carkindno,@carkind=a.carkind,@caryear=a.caryear,@carno=a.carno"+
		--" from (select top(1) ISNULL(e.noa,'') carkindno,ISNULL(e.kind,'') carkind,ISNULL(b.caryear,'') caryear,isnull(a.carno,'') carno"+
		--" ,sum(ISNULL(total,0)) total"+
		--" from view_trans"+@t_accy+" a "+
		--" left join car2 b on a.carno=b.carno"+
		--" left join #carkind d on b.carkindno=d.noa"+
		--" left join carKind e on d.noa=e.noa"+
		--" where (d.noa is not null) and isnull(a.driverno,'')=@driverno and left(isnull(a.trandate,''),6) = @mon"+
		--" group by ISNULL(e.noa,''),ISNULL(e.kind,''),ISNULL(b.caryear,''),isnull(a.carno,'')"+
		--" order by total desc) a"
		--execute sp_executesql @cmd,N'@carkindno nvarchar(20) output,@carkind nvarchar(20) output,@caryear nvarchar(10) output,@carno nvarchar(20) output,@driverno nvarchar(20),@mon nvarchar(10)'
		--,@carkindno=@carkindno output,@carkind=@carkind output,@caryear=@caryear output,@carno=@carno output,@driverno=@driverno,@mon=@mon
		if(len(isnull(@carno,''))>0) and exists(select * from #carkind where noa=@carkindno)
		begin
			if exists(select * from #z_trana02 where carno=@carno and mon=@mon)
				update #z_trana02 set carsal=ISNULL(carsal,0)+@carsal where carno=@carno and mon=@mon
			else
				insert into #z_trana02(carkindno,carkind,caryear,carno,mon,carsal)
				values(@carkindno,@carkind,@caryear,@carno,@mon,@carsal)
		end

		fetch next from cursor_table
		into @driverno,@mon,@carsal
	end
	close cursor_table
	deallocate cursor_table
	--------------------------------------------------------------------------------------
	--保牌燃費,折舊 
	declare @tax float
	declare @depreciation float
	
	declare cursor_table cursor for
	select ISNULL(e.noa,'') carkindno,ISNULL(e.kind,'') carkind,ISNULL(b.caryear,'') caryear,isnull(f.carno,'') carno,isnull(a.mon,'') mon
	,sum(ISNULL(a.tax,0)) tax,sum(ISNULL(a.depreciation,0)) depreciation
	from carts a
	left join cart f on f.noa=a.noa
	left join car2 b on f.carno=b.carno
	left join #carkind d on b.carkindno=d.noa
	left join carKind e on d.noa=e.noa
	where d.noa is not null
	and (a.mon between left(@t_btrandate,6) and left(@t_etrandate,6))
	and (len(@t_carno)=0 or f.carno=@t_carno)
	group by ISNULL(e.noa,''),ISNULL(e.kind,''),ISNULL(b.caryear,''),isnull(f.carno,''),isnull(a.mon,'')
	order by carkindno,carkind,caryear,carno,mon
	open cursor_table
	fetch next from cursor_table
	into @carkindno,@carkind,@caryear,@carno,@mon,@tax,@depreciation
	while(@@FETCH_STATUS <> -1)
	begin
		if exists(select * from #z_trana02 where carno=@carno and mon=@mon)
			update #z_trana02 set tax=@tax,depreciation=@depreciation where carno=@carno and mon=@mon
		else
			insert into #z_trana02(carkindno,carkind,caryear,carno,mon,tax,depreciation)
			values(@carkindno,@carkind,@caryear,@carno,@mon,@tax,@depreciation)

		fetch next from cursor_table
		into @carkindno,@carkind,@caryear,@carno,@mon,@tax,@depreciation
	end
	close cursor_table
	deallocate cursor_table
	--------------------------------------------------------------------------------------
	update #z_trana02 set profit=ISNULL(inmoney,0)+ISNULL(driverpay,0)
	-ISNULL(oilmoney,0)-ISNULL(fixa1,0)-ISNULL(fixa2,0)-ISNULL(tire1,0)-ISNULL(tire2,0)
	-ISNULL(tolls,0)-ISNULL(ticket,0)-ISNULL(reserve,0)
	-ISNULL(carsal,0)-ISNULL(tax,0)-ISNULL(depreciation,0)
	delete #z_trana02 where len(isnull(@t_carno,''))>0 and carno!=@t_carno
	--只顯示特定車牌
	if patindex('%option01%',@t_option01)>0
	begin
		declare cursor_table cursor for
		select a.carno,isnull(b.option01,0) from #z_trana02 a left join car2 b on a.carno=b.carno
		open cursor_table
		fetch next from cursor_table
		into @carno,@n
		while(@@FETCH_STATUS <> -1)
		begin
			if @n = 0
				delete #z_trana02 where carno=@carno
			fetch next from cursor_table
			into @carno,@n
		end
		close cursor_table
		deallocate cursor_table
	end
	set @cmd = "交運日期："+@t_btrandate + '～'+@t_etrandate
	if @t_sort02='carkind'
	begin
		select 
		ROW_NUMBER()over(order by (case when gno='0' then '1' else '9'end),carkindno,carkind,caryear,carno) nn
		,case when gno='1' then '1'
			when ISNULL(profit,0)<0 then '2'
			else '0' end gno
		,case when gno='0' then '1' else '9' end pno
		,carkindno ck1
		,carkind ck2
		,carno
		,caryear cy
		,case when ISNULL(inmoney,0)=0 then '' else cast(round((isnull(oilmoney,0)/inmoney)*100,0) as nvarchar)+'%' end rate1
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(inmoney,0)),1)),4,12)) mm01	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12)) mm02
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) mm03
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(fixa1,0)),1)),4,12)) mm04
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(fixa2,0)),1)),4,12)) mm05
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tire1,0)),1)),4,12)) mm06
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tire2,0)),1)),4,12)) mm07
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(driverpay,0)),1)),4,12)) mm08
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) mm09
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) mm10
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(reserve,0)),1)),4,12)) mm11
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(carsal,0)),1)),4,12)) mm12
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tax,0)),1)),4,12)) mm13
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(depreciation,0)),1)),4,12)) mm14
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(profit	,0)),1)),4,12)) mm15
		,@cmd titlea		
		from(
			select '0' gno,carkindno,carkind,carno,caryear
			,SUM(ISNULL(inmoney,0)) inmoney,SUM(ISNULL(tranmiles,0)) tranmiles
			,SUM(ISNULL(oilmoney,0)) oilmoney,SUM(ISNULL(oilmount,0)) oilmount,SUM(ISNULL(oilmiles,0)) oilmiles
			,SUM(ISNULL(fixa1,0)) fixa1,SUM(ISNULL(fixa2,0)) fixa2,SUM(ISNULL(tire1,0)) tire1,SUM(ISNULL(tire2,0)) tire2
			,SUM(ISNULL(driverpay,0)) driverpay,SUM(ISNULL(tolls,0)) tolls,SUM(ISNULL(ticket,0)) ticket
			,SUM(ISNULL(reserve,0)) reserve,SUM(ISNULL(carsal,0)) carsal,SUM(ISNULL(tax,0)) tax
			,sum(ISNULL(depreciation,0)) depreciation,SUM(ISNULL(profit,0)) profit	
			from #z_trana02 
			group by carkindno,carkind,carno,caryear
			union all
			select '1' gno,'','','',''
			,SUM(ISNULL(inmoney,0)) inmoney,SUM(ISNULL(tranmiles,0)) tranmiles
			,SUM(ISNULL(oilmoney,0)) oilmoney,SUM(ISNULL(oilmount,0)) oilmount,SUM(ISNULL(oilmiles,0)) oilmiles
			,SUM(ISNULL(fixa1,0)) fixa1,SUM(ISNULL(fixa2,0)) fixa2,SUM(ISNULL(tire1,0)) tire1,SUM(ISNULL(tire2,0)) tire2
			,SUM(ISNULL(driverpay,0)) driverpay,SUM(ISNULL(tolls,0)) tolls,SUM(ISNULL(ticket,0)) ticket
			,SUM(ISNULL(reserve,0)) reserve,SUM(ISNULL(carsal,0)) carsal,SUM(ISNULL(tax,0)) tax
			,sum(ISNULL(depreciation,0)) depreciation,SUM(ISNULL(profit,0)) profit
			from #z_trana02  ) a	
		order by pno,carkindno,carkind,caryear,carno
	end
	else if @t_sort02='caryear'
	begin
		select 
		ROW_NUMBER()over(order by (case when gno='0' then '1' else '9'end),caryear,carkindno,carkind,carno) nn
		,case when gno='1' then '1'
			when ISNULL(profit,0)<0 then '2'
			else '0' end gno
		,case when gno='0' then '1' else '9' end pno
		,carkindno ck1
		,carkind ck2
		,carno
		,caryear cy
		,case when ISNULL(inmoney,0)=0 then '' else cast(round((isnull(oilmoney,0)/inmoney)*100,0) as nvarchar)+'%' end rate1
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(inmoney,0)),1)),4,12)) mm01	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12)) mm02
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) mm03
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(fixa1,0)),1)),4,12)) mm04
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(fixa2,0)),1)),4,12)) mm05
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tire1,0)),1)),4,12)) mm06
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tire2,0)),1)),4,12)) mm07
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(driverpay,0)),1)),4,12)) mm08
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) mm09
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) mm10
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(reserve,0)),1)),4,12)) mm11
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(carsal,0)),1)),4,12)) mm12
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tax,0)),1)),4,12)) mm13
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(depreciation,0)),1)),4,12)) mm14
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(profit	,0)),1)),4,12)) mm15
		,@cmd titlea		
		from(
			select '0' gno,carkindno,carkind,carno,caryear
			,SUM(ISNULL(inmoney,0)) inmoney,SUM(ISNULL(tranmiles,0)) tranmiles
			,SUM(ISNULL(oilmoney,0)) oilmoney,SUM(ISNULL(oilmount,0)) oilmount,SUM(ISNULL(oilmiles,0)) oilmiles
			,SUM(ISNULL(fixa1,0)) fixa1,SUM(ISNULL(fixa2,0)) fixa2,SUM(ISNULL(tire1,0)) tire1,SUM(ISNULL(tire2,0)) tire2
			,SUM(ISNULL(driverpay,0)) driverpay,SUM(ISNULL(tolls,0)) tolls,SUM(ISNULL(ticket,0)) ticket
			,SUM(ISNULL(reserve,0)) reserve,SUM(ISNULL(carsal,0)) carsal,SUM(ISNULL(tax,0)) tax
			,sum(ISNULL(depreciation,0)) depreciation,SUM(ISNULL(profit,0)) profit	
			from #z_trana02 
			group by carkindno,carkind,carno,caryear
			union all
			select '1' gno,'','','',''
			,SUM(ISNULL(inmoney,0)) inmoney,SUM(ISNULL(tranmiles,0)) tranmiles
			,SUM(ISNULL(oilmoney,0)) oilmoney,SUM(ISNULL(oilmount,0)) oilmount,SUM(ISNULL(oilmiles,0)) oilmiles
			,SUM(ISNULL(fixa1,0)) fixa1,SUM(ISNULL(fixa2,0)) fixa2,SUM(ISNULL(tire1,0)) tire1,SUM(ISNULL(tire2,0)) tire2
			,SUM(ISNULL(driverpay,0)) driverpay,SUM(ISNULL(tolls,0)) tolls,SUM(ISNULL(ticket,0)) ticket
			,SUM(ISNULL(reserve,0)) reserve,SUM(ISNULL(carsal,0)) carsal,SUM(ISNULL(tax,0)) tax
			,sum(ISNULL(depreciation,0)) depreciation,SUM(ISNULL(profit,0)) profit
			from #z_trana02  ) a	
		order by pno,caryear,carkindno,carkind,carno
	end
	else if @t_sort02='rate1'
	begin
		select 
		ROW_NUMBER()over(order by (case when gno='0' then '1' else '9'end),case when ISNULL(inmoney,0)=0 then '' else cast(round((isnull(oilmoney,0)/inmoney)*100,0) as nvarchar)+'%' end  desc,carkindno,carkind,caryear,carno) nn
		,case when gno='1' then '1'
			when ISNULL(profit,0)<0 then '2'
			else '0' end gno
		,case when gno='0' then '1' else '9' end pno
		,carkindno ck1
		,carkind ck2
		,carno
		,caryear cy
		,case when ISNULL(inmoney,0)=0 then '' else cast(round((isnull(oilmoney,0)/inmoney)*100,0) as nvarchar)+'%' end rate1
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(inmoney,0)),1)),4,12)) mm01	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12)) mm02
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) mm03
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(fixa1,0)),1)),4,12)) mm04
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(fixa2,0)),1)),4,12)) mm05
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tire1,0)),1)),4,12)) mm06
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tire2,0)),1)),4,12)) mm07
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(driverpay,0)),1)),4,12)) mm08
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) mm09
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) mm10
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(reserve,0)),1)),4,12)) mm11
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(carsal,0)),1)),4,12)) mm12
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tax,0)),1)),4,12)) mm13
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(depreciation,0)),1)),4,12)) mm14
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(profit	,0)),1)),4,12)) mm15
		,@cmd titlea		
		from(
			select '0' gno,carkindno,carkind,carno,caryear
			,SUM(ISNULL(inmoney,0)) inmoney,SUM(ISNULL(tranmiles,0)) tranmiles
			,SUM(ISNULL(oilmoney,0)) oilmoney,SUM(ISNULL(oilmount,0)) oilmount,SUM(ISNULL(oilmiles,0)) oilmiles
			,SUM(ISNULL(fixa1,0)) fixa1,SUM(ISNULL(fixa2,0)) fixa2,SUM(ISNULL(tire1,0)) tire1,SUM(ISNULL(tire2,0)) tire2
			,SUM(ISNULL(driverpay,0)) driverpay,SUM(ISNULL(tolls,0)) tolls,SUM(ISNULL(ticket,0)) ticket
			,SUM(ISNULL(reserve,0)) reserve,SUM(ISNULL(carsal,0)) carsal,SUM(ISNULL(tax,0)) tax
			,sum(ISNULL(depreciation,0)) depreciation,SUM(ISNULL(profit,0)) profit	
			from #z_trana02 
			group by carkindno,carkind,carno,caryear
			union all
			select '1' gno,'','','',''
			,SUM(ISNULL(inmoney,0)) inmoney,SUM(ISNULL(tranmiles,0)) tranmiles
			,SUM(ISNULL(oilmoney,0)) oilmoney,SUM(ISNULL(oilmount,0)) oilmount,SUM(ISNULL(oilmiles,0)) oilmiles
			,SUM(ISNULL(fixa1,0)) fixa1,SUM(ISNULL(fixa2,0)) fixa2,SUM(ISNULL(tire1,0)) tire1,SUM(ISNULL(tire2,0)) tire2
			,SUM(ISNULL(driverpay,0)) driverpay,SUM(ISNULL(tolls,0)) tolls,SUM(ISNULL(ticket,0)) ticket
			,SUM(ISNULL(reserve,0)) reserve,SUM(ISNULL(carsal,0)) carsal,SUM(ISNULL(tax,0)) tax
			,sum(ISNULL(depreciation,0)) depreciation,SUM(ISNULL(profit,0)) profit
			from #z_trana02  ) a	
		order by pno,rate1 desc,carkindno,carkind,caryear,carno
	end
	else if @t_sort02='profit'
	begin
		select 
		ROW_NUMBER()over(order by (case when gno='0' then '1' else '9'end),profit desc,carkindno,carkind,caryear,carno) nn
		,case when gno='1' then '1'
			when ISNULL(profit,0)<0 then '2'
			else '0' end gno
		,case when gno='0' then '1' else '9' end pno
		,carkindno ck1
		,carkind ck2
		,carno
		,caryear cy
		,case when ISNULL(inmoney,0)=0 then '' else cast(round((isnull(oilmoney,0)/inmoney)*100,0) as nvarchar)+'%' end rate1
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(inmoney,0)),1)),4,12)) mm01	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12)) mm02
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) mm03
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(fixa1,0)),1)),4,12)) mm04
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(fixa2,0)),1)),4,12)) mm05
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tire1,0)),1)),4,12)) mm06
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tire2,0)),1)),4,12)) mm07
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(driverpay,0)),1)),4,12)) mm08
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) mm09
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) mm10
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(reserve,0)),1)),4,12)) mm11
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(carsal,0)),1)),4,12)) mm12
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tax,0)),1)),4,12)) mm13
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(depreciation,0)),1)),4,12)) mm14
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(profit	,0)),1)),4,12)) mm15
		,@cmd titlea		
		from(
			select '0' gno,carkindno,carkind,carno,caryear
			,SUM(ISNULL(inmoney,0)) inmoney,SUM(ISNULL(tranmiles,0)) tranmiles
			,SUM(ISNULL(oilmoney,0)) oilmoney,SUM(ISNULL(oilmount,0)) oilmount,SUM(ISNULL(oilmiles,0)) oilmiles
			,SUM(ISNULL(fixa1,0)) fixa1,SUM(ISNULL(fixa2,0)) fixa2,SUM(ISNULL(tire1,0)) tire1,SUM(ISNULL(tire2,0)) tire2
			,SUM(ISNULL(driverpay,0)) driverpay,SUM(ISNULL(tolls,0)) tolls,SUM(ISNULL(ticket,0)) ticket
			,SUM(ISNULL(reserve,0)) reserve,SUM(ISNULL(carsal,0)) carsal,SUM(ISNULL(tax,0)) tax
			,sum(ISNULL(depreciation,0)) depreciation,SUM(ISNULL(profit,0)) profit	
			from #z_trana02 
			group by carkindno,carkind,carno,caryear
			union all
			select '1' gno,'','','',''
			,SUM(ISNULL(inmoney,0)) inmoney,SUM(ISNULL(tranmiles,0)) tranmiles
			,SUM(ISNULL(oilmoney,0)) oilmoney,SUM(ISNULL(oilmount,0)) oilmount,SUM(ISNULL(oilmiles,0)) oilmiles
			,SUM(ISNULL(fixa1,0)) fixa1,SUM(ISNULL(fixa2,0)) fixa2,SUM(ISNULL(tire1,0)) tire1,SUM(ISNULL(tire2,0)) tire2
			,SUM(ISNULL(driverpay,0)) driverpay,SUM(ISNULL(tolls,0)) tolls,SUM(ISNULL(ticket,0)) ticket
			,SUM(ISNULL(reserve,0)) reserve,SUM(ISNULL(carsal,0)) carsal,SUM(ISNULL(tax,0)) tax
			,sum(ISNULL(depreciation,0)) depreciation,SUM(ISNULL(profit,0)) profit
			from #z_trana02  ) a	
		order by pno,profit desc,carkindno,carkind,caryear,carno
	end;

z_trana01:--z_trana01	
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_baddrno nvarchar(20)
	declare @t_eaddrno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_carkind  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_calctypes  nvarchar(max)
	declare @t_rate nvarchar(10)
	declare @t_sort01 nvarchar(max)
	declare @t_filter01 nvarchar(max)
	declare @t_option01 nvarchar(max)
	declare @t_sort02 nvarchar(max)
	declare @t_filter04 nvarchar(max)
	declare @t_sort04 nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_baddrno = case when '#non'=[8] then '' else [8] end
	set @t_eaddrno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_bdriverno = case when '#non'=[10] then '' else [10] end
	set @t_edriverno = case when '#non'=[11] then CHAR(255) else [11] end	
	set @t_carno = case when '#non'=[12] then '' else [12] end
	set @t_po = case when '#non'=[13] then '' else [13] end
	set @t_carkind  = case when '#non'=[14] then '' else [14] end
	set @t_carteam  = case when '#non'=[15] then '' else [15] end
	set @t_calctypes  = case when '#non'=[16] then '' else [16] end	
	set @t_rate  = case when '#non'=[17] then '' else [17] end
	set @t_sort01  = case when '#non'=[18] then '' else [18] end
	set @t_filter01  = case when '#non'=[19] then '' else [19] end
	set @t_option01  = case when '#non'=[20] then '' else [20] end
	set @t_sort02  = case when '#non'=[21] then '' else [21] end
	set @t_filter04  = case when '#non'=[22] then '' else [22] end
	set @t_sort04 = case when '#non'=[23] then '' else [23] end
	----------------------------------------------------------------------------------------------
	set @t_btrandate = case when len(@t_btrandate)=0 then @t_accy+'/01/01' else @t_btrandate end
	set @t_etrandate = case when @t_etrandate=CHAR(255) then @t_accy+'/12/31' else @t_etrandate end
	----------------------------------------------------------------------------------------------
	declare @string nvarchar(max)
	declare @n int
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end

	----------------------------------------------------------------------------------------------
	declare @carno nvarchar(20)
	declare @datea nvarchar(10)
	declare @carkindno  nvarchar(20)
	declare @carkind	nvarchar(20)
	declare @miles float
	declare @tranmoney float
	declare @drivermoney float
	declare @reserve float 
	declare @mount float 
	declare @money float 
	----------------------------------------------------------------------------------------------
	
	declare @t_date nvarchar(10)
	declare @t_date1 nvarchar(10)
	declare @t_date2 nvarchar(10)

	set @t_date1 = convert(nvarchar(4),convert(int,LEFT(@t_btrandate,3))+1911)+'-'+SUBSTRING(@t_btrandate,5,2)+'-'+RIGHT(@t_btrandate,2)
	set @t_date2 = convert(nvarchar(4),convert(int,LEFT(@t_etrandate,3))+1911)+'-'+SUBSTRING(@t_etrandate,5,2)+'-'+RIGHT(@t_etrandate,2)
	set @t_date=@t_date1

	if(isdate(@t_date1)=0 or isdate(@t_date2)=0)
	begin
		print '日期錯誤'
		return	
	end
	--if(DATEDIFF(MM,@t_date1,@t_date2)>2)
	--begin
	--	print '查詢區間不可超過三個月'
	--	return	
	--end
	IF OBJECT_ID('tempdb..#listDate')is not null
	BEGIN
		set @cmd = 'drop table #listDate'
		EXECUTE sp_executesql @cmd
	END
	create table #listDate(
		[date] nvarchar(20)
	)

	while (@t_date between @t_date1 and @t_date2)
	begin
		insert into #listDate select right('00'+convert(nvarchar(3),convert(int,YEAR(@t_date))-1911),3)+'/'+right('0'+convert(nvarchar(2),convert(int,MONTH(@t_date))),2)+'/'+right('0'+convert(nvarchar(2),convert(int,DAY(@t_date))),2)
		set @t_date= convert(date,DATEADD(DD,1,@t_date),111)
	end
	----------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#listCarno')is not null
	BEGIN
		set @cmd = 'drop table #listCarno'
		EXECUTE sp_executesql @cmd
	END
	create table #listCarno(
		carno nvarchar(20),	
		carkindno nvarchar(20),
		carkind nvarchar(20)																																				
	)
	set @cmd=
	" select  a.carno,isnull(c.noa,''),isnull(c.kind,'') "+ 
	" from  view_trans"+@t_accy+" a  "+
	" left join car2 b on a.carno=b.carno"+
	" left join carKind c on b.carkindno=c.noa"+
	" left join calctypes d on d.noa+d.noq=a.calctype"+
	" left join #carkind e on e.noa=c.noa"+ 
	" where isnull(d.isoutside,0)=0"+
	" and (len(@t_carno)=0 or @t_carno=a.carno)"+
	" and (e.noa is not null)"+
	" and (LEFT(a.trandate,6)  between LEFT(@t_btrandate,6)  and  LEFT(@t_etrandate,6)) "+ 
	" group  by a.carno,isnull(c.noa,''),isnull(c.kind,'') "
	
	insert into #listCarno
	execute  sp_executesql @cmd,N'@t_carno nvarchar(20),@t_btrandate  nvarchar(10),@t_etrandate  nvarchar(10)',@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate,@t_carno=@t_carno
	----------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_tran01')is not null
	BEGIN
		set @cmd = 'drop table #z_tran01'
		EXECUTE sp_executesql @cmd
	END
	create table #z_tran01 (
		n float,
		gno nvarchar(3),
		carno nvarchar(20),
		carkindno nvarchar(20),
		carkind nvarchar(20),
		driverno nvarchar(20),
		driver nvarchar(20),
		trandate nvarchar(10),
		miles float,
		tranmoney float,
		drivermoney float,
		oilmount float,
		oilmoney float,
		tolls float,
		ticket float,
		reserve float,
		profit  float,
		memo nvarchar(max),
		rate1 float
	)
	CREATE INDEX noa ON #z_tran01 (carno,trandate)
	
	declare cursor_table cursor for
	select carno,carkindno,carkind,[date] from #listCarno,#listDate
	open cursor_table
	fetch next from cursor_table
	into @carno,@carkindno,@carkind,@datea
	while(@@FETCH_STATUS <> -1)
	begin
		insert into #z_tran01(n,gno,carno,carkindno,carkind,trandate,rate1)values(-1,'1',@carno,@carkindno,@carkind,@datea,0)
		fetch next from cursor_table
		into @carno,@carkindno,@carkind,@datea
	end
	close cursor_table
	deallocate cursor_table
	-----------------------------------------------------------------------------------------------------------
	declare @trandate nvarchar(10)
	declare @memo nvarchar(max)
	--出車單
	declare @tmp table(
		carno nvarchar(20),
		trandate nvarchar(20),
		miles float,
		tranmoney float,
		drivermoney float,
		reserve float
	)
	set @cmd  =
	" select a.carno,a.trandate"+
	" ,sum(ISNULL(miles,0))"+
	" ,sum(round(a.price*a.mount,0))"+
	" ,sum(round(a.price2*a.mount2*a.discount,0))"+
	" ,sum(isnull(a.reserve,0))"+
	" from view_trans"+@t_accy+" a"+
	" left join car2 b on a.carno=b.carno"+
	" left join #carkind c on b.carkindno=c.noa"+
	" left  join  calctypes d on d.noa+d.noq=a.calctype "+
	" where (c.noa is not null)"+
	" and (patindex('%option01%',@t_option01)=0 or (patindex('%option01%',@t_option01)>0 and isnull(b.option01,0)=1))"+
	" and isnull(d.isoutside,0)=0"+
	" and (a.trandate between @t_btrandate and @t_etrandate)"+
	" group by a.carno,a.trandate"
	
	insert into @tmp
	execute sp_executesql @cmd,N'@t_option01 nvarchar(max),@t_filter01 nvarchar(max),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10)'
	,@t_option01=@t_option01,@t_filter01=@t_filter01,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate
	
	
	----------------------------------------------------------------------------------------------
	declare cursor_table cursor for
	select carno,trandate,miles,tranmoney,drivermoney,reserve from @tmp
	open cursor_table
	fetch next from cursor_table
	into @carno,@trandate,@miles,@tranmoney,@drivermoney,@reserve
	while(@@FETCH_STATUS <> -1)
	begin
		update #z_tran01 set miles=@miles,tranmoney=@tranmoney,drivermoney=@drivermoney,reserve=@reserve where carno=@carno and trandate=@trandate
		
		fetch next from cursor_table
		into @carno,@trandate,@miles,@tranmoney,@drivermoney,@reserve
	end
	close cursor_table
	deallocate cursor_table
	
	-----------------------------------------------------------------------------------------------------------
	--油費
	declare cursor_table cursor for
	select a.carno,a.datea,SUM(isnull(a.mount,0)),SUM(isnull(a.[money],0))
	from oil a
	left join car2 b on a.carno=b.carno
	where (a.datea between @t_btrandate and @t_etrandate)
	and patindex('%option01%',@t_option01)=0 or (patindex('%option01%',@t_option01)>0 and isnull(b.option01,0)=1)
	group  by  a.carno,a.datea
	open cursor_table
	fetch next from cursor_table
	into @carno,@datea,@mount,@money
	while(@@FETCH_STATUS <> -1)
	begin
		update #z_tran01 set oilmount=@mount,oilmoney=@money where carno=@carno and trandate=@datea
		
		fetch next from cursor_table
		into @carno,@datea,@mount,@money
	end
	close cursor_table
	deallocate cursor_table
	--加油備註
	declare cursor_table cursor for
	select a.carno,a.datea,a.memo
	from oil a
	left join car2 b on a.carno=b.carno
	where len(isnull(a.memo,''))>1 --排除MEMO  =  .  的
	and (a.datea between @t_btrandate and @t_etrandate)
	and patindex('%option01%',@t_option01)=0 or (patindex('%option01%',@t_option01)>0 and isnull(b.option01,0)=1)
	open cursor_table
	fetch next from cursor_table
	into @carno,@datea,@memo
	while(@@FETCH_STATUS <> -1)
	begin
		set @memo = case when left(@memo,1)='.' then SUBSTRING(@memo,1,LEN(@memo)) else @memo end
		update #z_tran01 set
		memo=ISNULL(memo,'')+case when len(ISNULL(memo,''))>0 then CHAR(59) else '' end + @memo
		where carno=@carno and trandate=@datea
		
		fetch next from cursor_table
		into @carno,@datea,@memo
	end
	close cursor_table
	deallocate cursor_table
	-----------------------------------------------------------------------------------------------------------
	--ETC
	declare cursor_table cursor for
	select a.carno,a.datea,SUM(isnull(a.[money],0))
	from etc a
	left join car2 b on a.carno=b.carno
	where (a.typea='ETC' or a.typea='CASH')
	and (a.datea between @t_btrandate and @t_etrandate)
	and patindex('%option01%',@t_option01)=0 or (patindex('%option01%',@t_option01)>0 and isnull(b.option01,0)=1)
	group  by  a.carno,a.datea
	open cursor_table
	fetch next from cursor_table
	into @carno,@datea,@money
	while(@@FETCH_STATUS <> -1)
	begin
		update #z_tran01 set tolls=@money where carno=@carno and trandate=@datea
		
		fetch next from cursor_table
		into @carno,@datea,@money
	end
	close cursor_table
	deallocate cursor_table
	-----------------------------------------------------------------------------------------------------------
	--罰單
	declare cursor_table cursor for
	select a.carno,a.datea,SUM(isnull(a.comppay,0))
	from carborr a
	left join car2 b on a.carno=b.carno
	where comppay!=0
	and patindex('%option01%',@t_option01)=0 or (patindex('%option01%',@t_option01)>0 and isnull(b.option01,0)=1)
	and (a.datea between @t_btrandate and @t_etrandate)
	group  by  a.carno,a.datea
	open cursor_table
	fetch next from cursor_table
	into @carno,@datea,@money
	while(@@FETCH_STATUS <> -1)
	begin
		update #z_tran01 set ticket=@money where carno=@carno and trandate=@datea
		
		fetch next from cursor_table
		into @carno,@datea,@money
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------------------
	update #z_tran01 set profit=ISNULL(tranmoney,0)-ISNULL(drivermoney,0)-ISNULL(oilmoney,0)-ISNULL(tolls,0)-ISNULL(ticket,0)-ISNULL(reserve,0)
	
	delete #z_tran01 where (isnull(tranmoney,0)=0 and isnull(oilmoney,0)=0 and @t_rate>0) or (isnull(tranmoney,0)!=0 and round(isnull(oilmoney,0)*100/isnull(tranmoney,0),0)<CAST(@t_rate as float))
	
	---------------------------------------------------------------------------------------------
	insert  into  #z_tran01
	select  2,'2',CHAR(255),'','','','',CHAR(255)
	,SUM(ISNULL(miles,0)),SUM(ISNULL(tranmoney,0)),SUM(ISNULL(drivermoney,0)),SUM(ISNULL(oilmount,0)),SUM(ISNULL(oilmoney,0))
	,SUM(ISNULL(tolls,0)),SUM(ISNULL(ticket,0)),SUM(ISNULL(reserve,0)),SUM(ISNULL(profit,0)),'',0
	from  #z_tran01 where gno='1'
	
	update #z_tran01 set rate1 = cast(case when isnull(tranmoney,0)=0 then 0 else round(isnull(oilmoney,0)*100/isnull(tranmoney,0),0) end as nvarchar)
	----------------------------------------------------------------------------------------------
	declare @driver nvarchar(40)
	declare @straddr nvarchar(40)
	declare @total float
	declare @str varchar(max)
	declare @bool bit
	declare @rate1 float
	declare @oilstation nvarchar(20)
	declare @price float
	declare @bmiles float
	declare @emiles float
	declare @oilmoney float
	declare @profit float
	if(patindex('%trans%',@t_filter01)>0 or patindex('%oil%',@t_filter01)>0)
	begin
		declare cursor_table cursor for
		select trandate,carkindno,carno,isnull(rate1,0),tranmoney,oilmoney,profit from #z_tran01 where gno='1'
		open cursor_table
		fetch next from cursor_table
		into @trandate,@carkindno,@carno,@rate1,@tranmoney,@oilmoney,@profit
		while(@@FETCH_STATUS <> -1)
		begin
			--出車明細
			set @bool = 0
			set @cmd ="if exists(select noa from view_trans"+@t_accy+" where carno=@carno and trandate=@trandate) set @bool = 1 else set @bool = 0"
			execute sp_executesql @cmd,N'@bool bit output,@carno nvarchar(20),@trandate nvarchar(10)',@bool=@bool output,@carno=@carno,@trandate=@trandate			
			if(@bool=1 and patindex('%trans%',@t_filter01)>0)
			begin
				set @str = '司機'+SPACE(8)
				+SPACE(2)+'起迄地點'+SPACE(12)
				+SPACE(2)+SPACE(6)+'收入'
				+SPACE(2)+SPACE(4)+'里程數'
				set @str = REPLACE(@str,SPACE(1),'&nbsp'+CHAR(59))
				insert into #z_tran01(n,gno,trandate,carkindno,carno,memo,rate1,tranmoney,oilmoney,profit)values(0,'3',@trandate,@carkindno,@carno,@str,@rate1,@tranmoney,@oilmoney,@profit)
				set @cmd =
				" declare cursor_table2 cursor for"+
				" select driver,straddr,total,miles from view_trans"+@t_accy+" where carno=@carno and trandate=@trandate"+
				" open cursor_table2"+
				" fetch next from cursor_table2"+
				" into @driver,@straddr,@total,@miles"+
				" while(@@FETCH_STATUS <> -1)"+
				" begin"+
				" 	set @str = left(CAST(@driver+space(12) as varchar(12)),12) "+
				" 	+SPACE(2)+ left(CAST(@straddr+space(20) as varchar(20)),20) "+
				" 	+SPACE(2)+ RIGHT(space(10)+ reverse(substring(reverse(convert(varchar(15),CONVERT(money,isnull(@total,0)),1)),4,10)),10)"+
				" 	+SPACE(2)+ RIGHT(space(10)+ reverse(substring(reverse(convert(varchar(15),CONVERT(money,isnull(@miles,0)),1)),4,10)),10)"+
				" 	set @str = REPLACE(@str,SPACE(1),'&nbsp'+CHAR(59))"+
				" 	insert into #z_tran01(n,gno,trandate,carkindno,carno,memo,rate1,tranmoney,oilmoney,profit)values(0.1,'0',@trandate,@carkindno,@carno,@str,@rate1,@tranmoney,@oilmoney,@profit)"+
				" 	fetch next from cursor_table2"+
				" 	into @driver,@straddr,@total,@miles"+
				" end"+
				" close cursor_table2"+
				" deallocate cursor_table2"

				execute sp_executesql @cmd,N'@profit float,@tranmoney float,@oilmoney float,@rate1 float,@carno nvarchar(20),@carkindno nvarchar(20),@trandate nvarchar(10),@driver nvarchar(20),@straddr nvarchar(40),@total float,@miles float,@str varchar(max)'
				,@profit=@profit,@tranmoney=@tranmoney,@oilmoney=@oilmoney,@rate1=@rate1,@carno=@carno,@carkindno=@carkindno,@trandate=@trandate,@driver=@driver,@straddr=@straddr,@total=@total,@miles=@miles,@str=@str
			end
			--加油明細
			set @bool = 0
			if exists(select noa from oil where carno=@carno and datea=@trandate )
				set @bool = 1
			else
				set @bool = 0
			if(@bool=1 and patindex('%oil%',@t_filter01)>0)
			begin	
				set @str = '站名'+SPACE(4)
				+SPACE(2)+SPACE(4)+'公升'
				+SPACE(2)+SPACE(4)+'單價'
				+SPACE(2)+SPACE(12)+'金額'
				+SPACE(2)+SPACE(4)+'里程數'
				+SPACE(2)+SPACE(2)+'上次里程數'
				+SPACE(2)+SPACE(2)+'本次里程數'

				set @str = REPLACE(@str,SPACE(1),'&nbsp'+CHAR(59))
				insert into #z_tran01(n,gno,trandate,carkindno,carno,memo,rate1,tranmoney,oilmoney,profit)values(0.2,'4',@trandate,@carkindno,@carno,@str,@rate1,@tranmoney,@oilmoney,@profit)

				declare cursor_table2 cursor for
				select oilstation,price,mount,[money],bmiles,emiles,miles from oil where carno=@carno and datea=@trandate order by datea,timea
				open cursor_table2
				fetch next from cursor_table2
				into @oilstation,@price,@mount,@money,@bmiles,@emiles,@miles
				while(@@FETCH_STATUS <> -1)
				begin
					set @str = left(CAST(@oilstation+space(8) as varchar(8)),8)
					+SPACE(2)+ RIGHT(space(8)+ Cast(CAST(@mount as decimal(10,2)) as varchar(8)),8) 
					+SPACE(2)+ RIGHT(space(8)+ Cast(CAST(@price as decimal(10,2)) as varchar(8)),8)
					+SPACE(2)+ RIGHT(space(16)+ reverse(substring(reverse(convert(varchar(16),CONVERT(money,isnull(@money,0)),1)),4,16)),16)
					+SPACE(2)+ RIGHT(space(10)+ reverse(substring(reverse(convert(varchar(15),CONVERT(money,isnull(@miles,0)),1)),4,10)),10) 
					+SPACE(2)+ RIGHT(space(12)+ reverse(substring(reverse(convert(varchar(15),CONVERT(money,isnull(@bmiles,0)),1)),4,12)),12)
					+SPACE(2)+ RIGHT(space(12)+ reverse(substring(reverse(convert(varchar(15),CONVERT(money,isnull(@emiles,0)),1)),4,12)),12)					
					set @str = REPLACE(@str,SPACE(1),'&nbsp'+CHAR(59))
					insert into #z_tran01(n,gno,trandate,carkindno,carno,memo,rate1,tranmoney,oilmoney,profit)values(0.21,'0',@trandate,@carkindno,@carno,@str,@rate1,@tranmoney,@oilmoney,@profit)

					fetch next from cursor_table2
					into @oilstation,@price,@mount,@money,@bmiles,@emiles,@miles
				end
				close cursor_table2
				deallocate cursor_table2
			end

			fetch next from cursor_table
			into @trandate,@carkindno,@carno,@rate1,@tranmoney,@oilmoney,@profit
		end
		close cursor_table
		deallocate cursor_table
	end
	----------------------------------------------------------------------------------------------
	update #z_tran01 set gno='5' where gno='1' and profit<0
	select @cmd = ''
	select @cmd = cast(COUNT(1) as nvarchar)+'車次' from #z_tran01 where gno='1' or gno='5'
	if @t_sort01 = 'trandate'
	begin
		insert into #z_tran01
		select -1,'6','','','','','',LEFT(trandate,6)+'小計'
		,SUM(ISNULL(miles,0)),SUM(ISNULL(tranmoney,0)),SUM(ISNULL(drivermoney,0))
		,SUM(ISNULL(oilmount,0)),SUM(ISNULL(oilmoney,0)),SUM(ISNULL(tolls,0))
		,SUM(ISNULL(ticket,0)),SUM(ISNULL(reserve,0)),SUM(ISNULL(profit,0))
		,'' memo
		,case when sum(isnull(tranmoney,0))!=0 then round(sum(ISNULL(oilmoney,0))/sum(isnull(tranmoney,0))*100,0) else 0 end
		from #z_tran01
		where (gno='1' or gno='5')
		group by LEFT(trandate,6)
		
		select a.*,trandate dd,c.kind 類別,b.caryear 年份,b.cylinder 汽缸
		,case when a.oilmount=0 then null else cast(a.miles/a.oilmount as decimal(10,3)) end kml
		,cast(a.rate1 as nvarchar)+'%' 耗油比
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(miles,0)),1)),4,12)) 公里數
		,cast(case when isnull(oilmount,0)=0 then 0 else round(isnull(miles,0)/isnull(oilmount,0),2) end as nvarchar) 公里升
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tranmoney,0)),1)),4,12)) 收入
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(drivermoney,0)),1)),4,12)) 薪資
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) 油費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12))油量
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) 通行費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) 罰款
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.reserve,0)),1)),4,12)) 寄櫃費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.profit,0)),1)),4,12)) 淨利
		,isnull(a.memo,'')+case when len(ISNULL(a.memo,''))>0 then CHAR(59) else '' end +isnull(e.memo,'') mmm
		,@cmd times
		from #z_tran01 a
		left join car2 b on a.carno=b.carno
		left join carKind c on b.carkindno=c.noa
		left join driver d on a.driverno=d.noa
		left join carpresents e on a.carno=e.carno and a.trandate=e.datea
		order  by  a.trandate,a.carkindno,b.caryear,a.carno,n
	end
	if @t_sort01 = 'rate1'
	begin
		select a.*,trandate dd,c.kind 類別,b.caryear 年份,b.cylinder 汽缸
		,case when a.oilmount=0 then null else cast(a.miles/a.oilmount as decimal(10,3)) end kml
		,cast(a.rate1 as nvarchar)+'%' 耗油比
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(miles,0)),1)),4,12)) 公里數
		,cast(case when isnull(oilmount,0)=0 then 0 else round(isnull(miles,0)/isnull(oilmount,0),2) end as nvarchar) 公里升
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tranmoney,0)),1)),4,12)) 收入
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(drivermoney,0)),1)),4,12)) 薪資
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) 油費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12))油量
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) 通行費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) 罰款
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.reserve,0)),1)),4,12)) 寄櫃費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.profit,0)),1)),4,12)) 淨利
		,isnull(a.memo,'')+case when len(ISNULL(a.memo,''))>0 then CHAR(59) else '' end +isnull(e.memo,'') mmm
		,@cmd times
		,case when gno='2' then -999 when a.rate1=0 and a.oilmoney!=0 then (9999) else a.rate1 end sort01
		from #z_tran01 a
		left join car2 b on a.carno=b.carno
		left join carKind c on b.carkindno=c.noa
		left join driver d on a.driverno=d.noa
		left join carpresents e on a.carno=e.carno and a.trandate=e.datea
		order  by  sort01 desc,a.trandate,a.carkindno,b.caryear,a.carno,n
	end
	if @t_sort01 = 'tranmoney'
	begin
		select a.*,trandate dd,c.kind 類別,b.caryear 年份,b.cylinder 汽缸
		,case when a.oilmount=0 then null else cast(a.miles/a.oilmount as decimal(10,3)) end kml
		,cast(a.rate1 as nvarchar)+'%' 耗油比
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(miles,0)),1)),4,12)) 公里數
		,cast(case when isnull(oilmount,0)=0 then 0 else round(isnull(miles,0)/isnull(oilmount,0),2) end as nvarchar) 公里升
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tranmoney,0)),1)),4,12)) 收入
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(drivermoney,0)),1)),4,12)) 薪資
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) 油費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12))油量
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) 通行費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) 罰款
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.reserve,0)),1)),4,12)) 寄櫃費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.profit,0)),1)),4,12)) 淨利
		,isnull(a.memo,'')+case when len(ISNULL(a.memo,''))>0 then CHAR(59) else '' end +isnull(e.memo,'') mmm
		,@cmd times
		from #z_tran01 a
		left join car2 b on a.carno=b.carno
		left join carKind c on b.carkindno=c.noa
		left join driver d on a.driverno=d.noa
		left join carpresents e on a.carno=e.carno and a.trandate=e.datea
		order  by  (case when a.gno='2' then 9 else 1 end),a.tranmoney desc,a.trandate,a.carkindno,b.caryear,a.carno,n
	end
	if @t_sort01 = 'caryear'
	begin
		select a.*,trandate dd,c.kind 類別,b.caryear 年份,b.cylinder 汽缸
		,case when a.oilmount=0 then null else cast(a.miles/a.oilmount as decimal(10,3)) end kml
		,cast(a.rate1 as nvarchar)+'%' 耗油比
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(miles,0)),1)),4,12)) 公里數
		,cast(case when isnull(oilmount,0)=0 then 0 else round(isnull(miles,0)/isnull(oilmount,0),2) end as nvarchar) 公里升
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tranmoney,0)),1)),4,12)) 收入
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(drivermoney,0)),1)),4,12)) 薪資
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) 油費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12))油量
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) 通行費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) 罰款
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.reserve,0)),1)),4,12)) 寄櫃費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.profit,0)),1)),4,12)) 淨利
		,isnull(a.memo,'')+case when len(ISNULL(a.memo,''))>0 then CHAR(59) else '' end +isnull(e.memo,'') mmm
		,@cmd times
		from #z_tran01 a
		left join car2 b on a.carno=b.carno
		left join carKind c on b.carkindno=c.noa
		left join driver d on a.driverno=d.noa
		left join carpresents e on a.carno=e.carno and a.trandate=e.datea
		order  by  (case when a.gno='2' then 9 else 1 end),isnull(b.caryear,'') desc,a.carkindno,a.carno,a.trandate,n
	end
	if @t_sort01 = 'driverno'
	begin
		select a.*,trandate dd,c.kind 類別,b.caryear 年份,b.cylinder 汽缸
		,case when a.oilmount=0 then null else cast(a.miles/a.oilmount as decimal(10,3)) end kml
		,cast(a.rate1 as nvarchar)+'%' 耗油比
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(miles,0)),1)),4,12)) 公里數
		,cast(case when isnull(oilmount,0)=0 then 0 else round(isnull(miles,0)/isnull(oilmount,0),2) end as nvarchar) 公里升
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tranmoney,0)),1)),4,12)) 收入
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(drivermoney,0)),1)),4,12)) 薪資
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) 油費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12))油量
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) 通行費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) 罰款
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.reserve,0)),1)),4,12)) 寄櫃費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.profit,0)),1)),4,12)) 淨利
		,isnull(a.memo,'')+case when len(ISNULL(a.memo,''))>0 then CHAR(59) else '' end +isnull(e.memo,'') mmm
		,@cmd times
		from #z_tran01 a
		left join car2 b on a.carno=b.carno
		left join carKind c on b.carkindno=c.noa
		left join driver d on a.driverno=d.noa
		left join carpresents e on a.carno=e.carno and a.trandate=e.datea
		order  by  (case when a.gno='2' then 9 else 1 end),a.driverno,a.carkindno,a.carno,a.trandate,n
	end
	if @t_sort01 = 'profit'
	begin
		select a.*,trandate dd,c.kind 類別,b.caryear 年份,b.cylinder 汽缸
		,case when a.oilmount=0 then null else cast(a.miles/a.oilmount as decimal(10,3)) end kml
		,cast(a.rate1 as nvarchar)+'%' 耗油比
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(miles,0)),1)),4,12)) 公里數
		,cast(case when isnull(oilmount,0)=0 then 0 else round(isnull(miles,0)/isnull(oilmount,0),2) end as nvarchar) 公里升
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tranmoney,0)),1)),4,12)) 收入
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(drivermoney,0)),1)),4,12)) 薪資
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) 油費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12))油量
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) 通行費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) 罰款
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.reserve,0)),1)),4,12)) 寄櫃費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.profit,0)),1)),4,12)) 淨利
		,isnull(a.memo,'')+case when len(ISNULL(a.memo,''))>0 then CHAR(59) else '' end +isnull(e.memo,'') mmm
		,@cmd times
		from #z_tran01 a
		left join car2 b on a.carno=b.carno
		left join carKind c on b.carkindno=c.noa
		left join driver d on a.driverno=d.noa
		left join carpresents e on a.carno=e.carno and a.trandate=e.datea
		order  by  (case when a.gno='2' then 9 else 1 end),a.profit desc,a.trandate,a.carkindno,b.caryear,a.carno,n
	end
	----------------------------------------------------------------------------------------------
	drop table #carkind
	drop table #listDate
	drop table #z_tran01;