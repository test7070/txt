z_vcc1:--z_vcc1
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) =''
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

if(charindex('永勝',@t_acomp)>0)
begin
	set @mount_decimal =4
	set @weight_decimal =4
	set @price_decimal =4
end
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @mount_decimal =4
--------------------------------------------------
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @qhref_acomp='_it'
if(charindex('永勝',@t_acomp)>0)
	set @qhref_acomp='_uu'
if(charindex('楊家',@t_acomp)>0 or charindex('德芳',@t_acomp)>0)
	set @qhref_acomp='_tn'
if(charindex('有達',@t_acomp)>0 )
	set @qhref_acomp='_xy'
if(charindex('義橋',@t_acomp)>0 )
	set @qhref_acomp='_yc'
if(charindex('彩虹',@t_acomp)>0 )
	set @qhref_acomp='_rb'
-------------------------------------------------
set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--***********************************************************************************
SET QUOTED_IDENTIFIER OFF

declare @result table(
	gno nvarchar(10),
	noa nvarchar(30),
	noq nvarchar(10),
	typea nvarchar(12),
	datea nvarchar(10),
	mon nvarchar(7),
	custno nvarchar(30),
	comp nvarchar(90),
	productno nvarchar(30),
	xproduct nvarchar(MAX),
	unit nvarchar(12),
	mount float,
	weight float,
	price float,
	total float,
	qhref nvarchar(max),
	invono nvarchar(MAX),
	idate nvarchar(30),
	imoney float,
	itax float,
	itotal float
)

	insert into @result
	select '91' gno, a.noa noa, b.noq noq, a.typea typea, a.datea datea, (case when a.mon='' then left(a.datea,@r_lenm) else a.mon end), a.custno, a.comp
		, b.productno, b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end), b.unit, 
		   b.mount, b.weight, b.price, b.total,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
		   ,a.invono,v.datea,v.money,v.tax,v.total
	from view_vccs b
	left join view_vcc a on a.noa = b.noa
	left join view_ucaucc c on b.productno = c.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	left join vcca v on a.invono=v.noa
	where (a.datea between @t_bdate and @t_edate) and
		  (a.custno between @t_bcustno and @t_ecustno) and
		  (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and
		  (b.productno between @t_bproductno and @t_eproductno) and
		  (len(@t_groupano)=0 or c.groupano = @t_groupano) and
		  (len(@t_groupbno)=0 or c.groupbno = @t_groupbno) and
		  (len(@t_groupcno)=0 or c.groupcno = @t_groupcno) and
		  (len(@t_typea)=0 or isnull(c.typea,'null') = @t_typea) and (len(@t_stype)=0 or a.stype = @t_stype) 
		  and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
		  and (isnull(c.tggno,'') between @t_btggno and @t_etggno) and (len(@vcctypea)=0 or a.typea = @vcctypea) 
		  and (len(@t_partno)=0 or s.partno=@t_partno)
		  and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by a.datea,gno,noa,noq
	
if(@t_showinvono='1')
begin
	insert into @result(gno,datea,noa,noq,invono,idate,imoney,itax,itotal)
	select '92',datea,noa,'ZZZ',invono,idate,imoney,itax,itotal
	from @result group by datea,noa,invono,idate,imoney,itax,itotal
end
	
insert into @result(gno,datea,noa,mount,price,total)
	select '93',datea,'ZZZZZZZZZZZZ',
		sum((case typea when '1' then mount else (-1)*mount end)),
		sum((case typea when '1' then price else (-1)*price end)),
		sum((case typea when '1' then total else (-1)*total end))
	from @result group by datea
	
insert into @result(gno,datea,noa,mount,price,total)
	select '94',left(datea,@r_lenm)+'z','ZZZZZZZZZZZZ',sum(mount),sum(price),sum(total)
	from @result a where gno='93' group by left(datea,@r_lenm)
--*************************************************************************	
update @result set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'
update @result set gno='0' where gno='91'
update @result set gno='1' where gno='92'
update @result set gno='2' where gno='93'
update @result set gno='3' where gno='94'


update @result
set mount=mount*-1,total=total*-1
where typea='退'

select gno, noa, noq, typea, datea, LEFT(datea,@r_lenm) xdatea, mon, custno, left(comp,10) comp, productno, xproduct,unit,qhref
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),@mount_decimal,30)) mount 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,weight),1)),@weight_decimal,30)) weight 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,price),1)),@price_decimal,30)) price 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),@total_decimal,30)) total 
	,invono,idate
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,imoney),1)),@total_decimal,30)) imoney 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,itax),1)),@total_decimal,30)) itax 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,itotal),1)),@total_decimal,30)) itotal 
from @result order by datea,noa,noq;
--*********************************************************************************************************
z_vcc2:--z_vcc2
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bsalesno nvarchar(20)
	declare @t_esalesno nvarchar(20)
	declare @t_bproductno nvarchar(30)
	declare @t_eproductno nvarchar(30)
	declare @t_btggno nvarchar(50)
	declare @t_etggno nvarchar(50)
	declare @t_typea nvarchar(30)
	declare @t_groupano nvarchar(30)
	declare @t_groupbno nvarchar(30)
	declare @t_groupcno nvarchar(30)
	declare @t_stype nvarchar(30)
	declare @t_salesgroup nvarchar(100)
	declare @t_showinvono nvarchar(10)
	declare @vcctypea nvarchar(10) =''
	declare @r_len nvarchar(10)='[28]'
	declare @r_lenm nvarchar(10)='6'
	if (@r_len='4')
		set @r_lenm='7'
	
	set @t_bdate = case when '#non'=[4] then '' else [4] end
	set @t_edate = case when '#non'=[5] then char(255) else [5] end
	set @t_bcustno = case when '#non'=[8] then '' else [8] end
	set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
	set @t_bsalesno = case when '#non'=[10] then '' else [10] end
	set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
	set @t_bproductno = case when '#non'=[12] then '' else [12] end
	set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
	set @t_btggno = case when '#non' = [14] then '' else [14] end
	set @t_etggno = case when '#non' = [15] then char(255) else [15] end
	set @t_typea = case when '#non'=[16] then '' else [16] end
	set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
	set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
	set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
	set @t_stype = case when '#non'=[20] then '' else [20] end
	set @t_salesgroup = case when '#non' = [21] then '' else [21] end
	set @t_showinvono = case when '#non' = [24] then 0 else [24] end
	set @vcctypea = case when '#non' = [22] then '' else [22] end
	--***********************************************************************************
	declare @result table(
		gno nvarchar(1),
		typea nvarchar(4),
		noa nvarchar(15),
		noq nvarchar(3),
		datea nvarchar(10),
		mon nvarchar(7),
		custno nvarchar(20),
		comp nvarchar(90),
		addr_invo nvarchar(90),
		tel nvarchar(90),
		productno nvarchar(30),
		xproduct nvarchar(40),
		unit nvarchar(8),
		mount float,
		weight float,
		price float,
		total float,
		money float,
		back float,
		tax float,
		total1 float,
		pay float,
		unpay float,
		total2 float,
		pcount int,
		qhref nvarchar(MAX)
		primary key (custno,gno,mon,datea,noa,noq) 
	)
	
	insert into @result
	select '0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, (case when a.mon='' then left(a.datea,@r_lenm) else a.mon end) mon, 
		   (case when a.custno2!='' then a.custno2 else a.custno end) custno
		   , isnull(c.comp,''), isnull(c.addr_invo,''), isnull(c.tel,''), b.productno, b.product, b.unit, 
	       b.mount, b.weight, b.price, b.total, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount,'vcc?noa=$noa?'+a.accy
	from view_vccs b
	left join view_vcc a on a.noa = b.noa
	left join cust c on  (case when a.custno2!='' then a.custno2 else a.custno end) = c.noa
	where (a.datea between @t_bdate and @t_edate) and
		  ((case when a.mon='' then left(a.datea,@r_lenm) else a.mon end) between @t_bmon and @t_emon) and
		  (a.custno between @t_bcustno and @t_ecustno) and
		  (a.salesno between @t_bsalesno and @t_esalesno) and
		  (b.productno between @t_bproductno and @t_eproductno) and (len(@vcctypea)=0 or a.typea = @vcctypea) 
	union all --無發票系統
	select '0' gno, '稅' typea, noa, CHAR(255) noq, datea, (case when mon='' then left(datea,@r_lenm) else mon end), 
		    (case when custno2!='' then custno2 else custno end),  
		     (case when custno2!='' then comp2 else comp end),
		     '' addr_invo, '' tel, '' productno, '稅額' product, '' unit, 
		   0 mount, 0 weight, 0 price, tax, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount,'vcc?noa=$noa?'
	from view_vcc
	where tax > 0 and (taxtype='1' or taxtype='5') and
		  (datea between @t_bdate and @t_edate)and
		  ((case when mon='' then left(datea,@r_lenm) else mon end) between @t_bmon and @t_emon) and
		  ((case when custno2!='' then custno2 else custno end) between @t_bcustno and @t_ecustno)
	union all --有發票系統
	select '0' gno, '稅' typea, noa, '' noq, datea, (case when mon='' then left(datea,@r_lenm) else mon end), 
		   custno, comp, '' addr_invo, '' tel, '' productno, '稅額' product, '' unit, 
		   0 mount, 0 weight, 0 price, tax, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount,'vcca?noa=$noa?'
	from vcca 
	where tax > 0 and (taxtype='1' or taxtype='5') and [2]!=3 and
			(datea between @t_bdate and @t_edate)and
		  ((case when mon='' then left(datea,@r_lenm) else mon end) between @t_bmon and @t_emon) and
		  (custno between @t_bcustno and @t_ecustno)
		  and noa not in (select invono from view_vcc where tax > 0 and
		  (datea between @t_bdate and @t_edate)and
		  ((case when mon='' then left(datea,@r_lenm) else mon end) between @t_bmon and @t_emon) and
		  (custno between @t_bcustno and @t_ecustno) ) 	    	  
	order by custno,gno,mon,datea,noa,noq

	--***********************************************************************
	declare @gno nvarchar(1)
	declare @typea nvarchar(4)
	declare @noa nvarchar(15)
	declare @total float
	declare @mon nvarchar(7)
	declare @custno nvarchar(20)
	declare @comp nvarchar(90)
	declare @t_custno nvarchar(20)
	declare @t_comp nvarchar(90)
	declare @t_money float
	declare @t_back float
	declare @t_tax float
	declare @t_total1 float
	declare @t_pay float
	declare @t_unpay float
	declare @t_total2 float
	declare @t_pcount int
	set @t_custno = '#zzzz#zzzz'
	set @t_comp = ''
	set @t_money = 0
	set @t_back = 0
	set @t_tax = 0
	set @t_total1 = 0
	set @t_pay = 0
	set @t_unpay = 0
	set @t_total2 = 0
	set @t_pcount = 0
	--***********************************************************************
	declare cursor_table cursor for
	select gno,typea,custno,comp,mon,total from @result
	open cursor_table
	fetch next from cursor_table
	into @gno,@typea,@custno,@comp,@mon,@total
	while(@@FETCH_STATUS <> -1)
	begin
		if @t_custno != @custno
		begin
			if @t_custno != '#zzzz#zzzz'
			begin
				set @t_total1 = @t_money - @t_back + @t_tax
				insert into @result
				select '1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, @t_custno, @t_comp comp, '' addr_invo, '' tel, 
				       '' productno, '' product, '' unit, 0 mount, 0 weight, 0 price, 0 total, 
					   @t_money, @t_back, @t_tax, @t_total1, 0 pay, 0 unpay, 0 total2, @t_pcount,''
			end
			set @t_custno = @custno
			set @t_comp = @comp
			set @t_money = case when @typea = '1' then @total else 0 end
			set @t_back = case when @typea = '2' then @total else 0 end
			set @t_tax = case when @typea = '稅' then @total else 0 end
			set @t_pcount = 1
		end
		else
		begin
			set @t_money = @t_money + case when @typea = '1' then @total else 0 end
			set @t_back = @t_back + case when @typea = '2' then @total else 0 end
			set @t_tax = @t_tax + case when @typea = '稅' then @total else 0 end
			set @t_pcount = @t_pcount + 1
		end
		fetch next from cursor_table
		into @gno,@typea,@custno,@comp,@mon,@total
	end
	close cursor_table
	deallocate cursor_table
	
	if @t_custno != '#zzzz#zzzz'
	begin
		set @t_total1 = @t_money - @t_back + @t_tax
		insert into @result
		select '1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, @t_custno, @t_comp comp, '' addr_invo, '' tel, 
		       '' productno, '' product, '' unit, 0 mount, 0 weight, 0 price, 0 total, 
			   @t_money, @t_back, @t_tax, @t_total1, 0 pay, 0 unpay, 0 total2, @t_pcount,''
	end
	--***********************************************************************
	update @result set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'
	--已收款 
	update a
	set pay=isnull((select SUM(paysale) from umms where vccno in(select noa from @result where custno=a.custno)),0)
	+isnull((select SUM(ub.paysale) from umm ua left join umms ub on ua.noa=ub.noa where left(ub.vccno,len(a.custno))=a.custno and ua.datea  between @t_bdate and @t_edate and case when ua.mon!='' then ua.mon else left(ua.datea,@r_lenm) end between @t_bmon and @t_emon ),0)
	from @result a where a.gno='1'
	--*******************************************************************************
	--前期
		declare @tmp table(
		gno nvarchar(1),
		typea nvarchar(4),
		noa nvarchar(15),
		noq nvarchar(3),
		datea nvarchar(10),
		mon nvarchar(7),
		custno nvarchar(20),
		comp nvarchar(90),
		addr_invo nvarchar(90),
		tel nvarchar(90),
		productno nvarchar(30),
		xproduct nvarchar(40),
		unit nvarchar(8),
		mount float,
		weight float,
		price float,
		total float,
		money float,
		back float,
		tax float,
		total1 float,
		pay float,
		unpay float,
		total2 float,
		pcount int,
		qhref nvarchar(MAX)
		primary key (custno,gno,mon,datea,noa,noq) 
	)
	
	insert into @tmp
	select '0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, (case when a.mon='' then left(a.datea,@r_lenm) else a.mon end) mon, 
		   a.custno custno, isnull(c.comp,''), isnull(c.addr_invo,''), isnull(c.tel,''), b.productno, b.product, b.unit, 
	       b.mount, b.weight, b.price, b.total, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount,'vcc?noa=$noa?'+a.accy
	from view_vccs b
	left join view_vcc a on a.noa = b.noa
	left join cust c on  a.custno = c.noa
	where (a.datea < @t_bdate ) and
		  ((case when a.mon='' then left(a.datea,@r_lenm) else a.mon end) < @t_bmon ) and
		  (a.custno between @t_bcustno and @t_ecustno) and
		  (a.salesno between @t_bsalesno and @t_esalesno) and
		  (b.productno between @t_bproductno and @t_eproductno)
	union all
	select '0' gno, '稅' typea, noa, CHAR(255) noq, datea, (case when mon='' then left(datea,@r_lenm) else mon end), 
		   custno, comp, '' addr_invo, '' tel, '' productno, '稅額' product, '' unit, 
		   0 mount, 0 weight, 0 price, tax, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount,'vcc?noa=$noa?'
	from view_vcc
	where tax > 0 and
		  (datea < @t_bdate) and (taxtype='1' or taxtype='5') and
		  ((case when mon='' then left(datea,@r_lenm) else mon end) < @t_bmon) and
		  (custno between @t_bcustno and @t_ecustno) 
	union all
	select '0' gno, '稅' typea, noa, '' noq, datea, (case when mon='' then left(datea,@r_lenm) else mon end), 
		   custno, comp, '' addr_invo, '' tel, '' productno, '稅額' product, '' unit, 
		   0 mount, 0 weight, 0 price, tax, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount,'vcca?noa=$noa?' 
	from vcca
	where tax > 0 and [2]!=3 and
			(datea < @t_bdate) and (taxtype='1' or taxtype='5') and
		  ((case when mon='' then left(datea,@r_lenm) else mon end) < @t_bmon ) and
		  (custno between @t_bcustno and @t_ecustno)	  	    	  
	order by custno,gno,mon,datea,noa,noq

	--***********************************************************************
	set @t_custno = '#zzzz#zzzz'
	set @t_comp = ''
	set @t_money = 0
	set @t_back = 0
	set @t_tax = 0
	set @t_total1 = 0
	set @t_pay = 0
	set @t_unpay = 0
	set @t_total2 = 0
	set @t_pcount = 0
	declare cursor_table cursor for
	select gno,typea,custno,comp,mon,total from @tmp
	open cursor_table
	fetch next from cursor_table
	into @gno,@typea,@custno,@comp,@mon,@total
	while(@@FETCH_STATUS <> -1)
	begin
		if @t_custno != @custno
		begin
			if @t_custno != '#zzzz#zzzz'
			begin
				set @t_total1 = @t_money - @t_back + @t_tax
				insert into @tmp
				select '1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, @t_custno, @t_comp comp, '' addr_invo, '' tel, 
				       '' productno, '' product, '' unit, 0 mount, 0 weight, 0 price, 0 total, 
					   @t_money, @t_back, @t_tax, @t_total1, 0 pay, 0 unpay, 0 total2, @t_pcount,''
			end
			set @t_custno = @custno
			set @t_comp = @comp
			set @t_money = case when @typea = '1' then @total else 0 end
			set @t_back = case when @typea = '2' then @total else 0 end
			set @t_tax = case when @typea = '稅' then @total else 0 end
			set @t_pcount = 1
		end
		else
		begin
			set @t_money = @t_money + case when @typea = '1' then @total else 0 end
			set @t_back = @t_back + case when @typea = '2' then @total else 0 end
			set @t_tax = @t_tax + case when @typea = '稅' then @total else 0 end
			set @t_pcount = @t_pcount + 1
		end
		fetch next from cursor_table
		into @gno,@typea,@custno,@comp,@mon,@total
	end
	close cursor_table
	deallocate cursor_table
	
	if @t_custno != '#zzzz#zzzz'
	begin
		set @t_total1 = @t_money - @t_back + @t_tax
		insert into @tmp
		select '1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, @t_custno, @t_comp comp, '' addr_invo, '' tel, 
		       '' productno, '' product, '' unit, 0 mount, 0 weight, 0 price, 0 total, 
			   @t_money, @t_back, @t_tax, @t_total1, 0 pay, 0 unpay, 0 total2, @t_pcount,''
	end
	--***********************************************************************
	update @tmp set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'
	--已收款 
	update a
	set pay=isnull((select SUM(paysale) from umms where vccno in(select noa from @result where custno=a.custno)),0)
	+isnull((select SUM(ub.paysale) from umm ua left join umms ub on ua.noa=ub.noa where left(ub.vccno,len(a.custno))=a.custno and ua.datea  < @t_bdate and case when ua.mon!='' then ua.mon else left(ua.datea,@r_lenm) end < @t_bmon ),0)
	from @tmp a where a.gno='1'
	
	update a
	set unpay=isnull((select total1-pay from @tmp where custno=a.custno and gno='1'),0)
	from @result a where a.gno='1'
	
	update @result
	set total2=total1+unpay-pay 
	where gno='1'
	
	
	update @result
	set mount=mount*-1,total=total*-1
	where typea='退'
	
	select 
	gno,typea,noa,noq,datea,mon,custno,comp,addr_invo,tel,productno,xproduct,unit
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),0,30)) mount 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,weight),1)),0,30)) weight 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,price),1)),0,30)) price 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),4,30)) total 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,money),1)),4,30)) money 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,back),1)),4,30)) back 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,tax),1)),4,30)) tax 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total1),1)),4,30)) total1 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,pay),1)),4,30)) pay 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,unpay),1)),4,30)) unpay 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total2),1)),4,30)) total2 
	,pcount,qhref
	from @result order by custno,gno,mon,datea,noa,noq;
--**************************************************************************************************
z_vcc3:--z_vcc3
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bsalesno nvarchar(20)
	declare @t_esalesno nvarchar(20)
	declare @t_bproductno nvarchar(30)
	declare @t_eproductno nvarchar(30)
	declare @t_btggno nvarchar(50)
	declare @t_etggno nvarchar(50)
	declare @t_typea nvarchar(30)
	declare @t_groupano nvarchar(30)
	declare @t_groupbno nvarchar(30)
	declare @t_groupcno nvarchar(30)
	declare @t_stype nvarchar(30)
	declare @t_salesgroup nvarchar(100)
	declare @t_showinvono nvarchar(10)
	declare @t_acomp nvarchar(MAX)='[3]'
	declare @qhref_acomp nvarchar(10) =''
	declare @vcctypea nvarchar(10) =''
	declare @t_partno nvarchar(30)
	declare @isspec nvarchar(10)='[25]'
	declare @t_multcust nvarchar(max)
	declare @t_multucc nvarchar(max)
	declare @r_len nvarchar(10)='[28]'
	declare @r_lenm nvarchar(10)='6'
	if (@r_len='4')
		set @r_lenm='7'
	
	set @t_bdate = case when '#non'=[4] then '' else [4] end
	set @t_edate = case when '#non'=[5] then char(255) else [5] end
	set @t_bcustno = case when '#non'=[8] then '' else [8] end
	set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
	set @t_bsalesno = case when '#non'=[10] then '' else [10] end
	set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
	set @t_bproductno = case when '#non'=[12] then '' else [12] end
	set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
	set @t_btggno = case when '#non' = [14] then '' else [14] end
	set @t_etggno = case when '#non' = [15] then char(255) else [15] end
	set @t_typea = case when '#non'=[16] then '' else [16] end
	set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
	set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
	set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
	set @t_stype = case when '#non'=[20] then '' else [20] end
	set @t_salesgroup = case when '#non' = [21] then '' else [21] end
	set @t_showinvono = case when '#non' = [24] then 0 else [24] end
	set @vcctypea = case when '#non' = [22] then '' else [22] end
	set @t_partno = case when '#non' = [23] then '' else [23] end
	set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
	set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

if(charindex('永勝',@t_acomp)>0)
begin
	set @mount_decimal =4
	set @weight_decimal =4
	set @price_decimal =4
end
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @mount_decimal =4
--------------------------------------------------
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @qhref_acomp='_it'
if(charindex('永勝',@t_acomp)>0)
	set @qhref_acomp='_uu'
if(charindex('楊家',@t_acomp)>0 or charindex('德芳',@t_acomp)>0)
	set @qhref_acomp='_tn'
if(charindex('有達',@t_acomp)>0 )
	set @qhref_acomp='_xy'
if(charindex('彩虹',@t_acomp)>0 )
	set @qhref_acomp='_rb'
-------------------------------------------------
	SET QUOTED_IDENTIFIER OFF
	
	declare @result table(
		gno nvarchar(1),
		typea nvarchar(4),
		noa nvarchar(15),
		noq nvarchar(3),
		datea nvarchar(10),
		mon nvarchar(7),
		custno nvarchar(20),
		comp nvarchar(90),
		addr_invo nvarchar(90),
		tel nvarchar(90),
		productno nvarchar(30),
		xproduct nvarchar(MAX),
		unit nvarchar(8),
		mount float,
		weight float,
		price float,
		total float,
		money float,
		back float,
		tax float,
		total1 float,
		pay float,
		unpay float,
		total2 float,
		pcount int,
		qhref nvarchar(MAX)
		primary key (custno,productno,gno,datea,noa,noq) 
	)
	
	insert into @result
	select '0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, a.mon mon, 
		   a.custno custno, isnull(c.comp,''), isnull(c.addr_invo,''), isnull(c.tel,''), b.productno
		   , b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
		   , b.unit,b.mount, b.weight, b.price, b.total, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
	       ,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vccs b
	left join view_vcc a on a.noa = b.noa
	left join cust c on  a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
		  (a.custno between @t_bcustno and @t_ecustno) and
		  (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and
		  (b.productno between @t_bproductno and @t_eproductno) and
		  (len(@t_groupano)=0 or d.groupano = @t_groupano) and 
		  (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and
		  (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea) and (len(@t_stype)=0 or a.stype = @t_stype) 
		  and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
		  and (isnull(d.tggno,'') between @t_btggno and @t_etggno) and (len(@vcctypea)=0 or a.typea = @vcctypea) 
		  and (len(@t_partno)=0 or s.partno=@t_partno)
		  and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by custno,productno,gno,datea,noa,noq
	--***********************************************************************
	declare @gno nvarchar(1)
	declare @typea nvarchar(4)
	declare @noa nvarchar(15)
	declare @mount float
	declare @weight float
	declare @total float
	declare @datea nvarchar(10)
	declare @custno nvarchar(20)
	declare @comp nvarchar(90)
	declare @productno nvarchar(30)
	declare @xproduct nvarchar(MAX)
	declare @t_custno1 nvarchar(20)
	declare @t_comp1 nvarchar(40)
	declare @t_custno2 nvarchar(20)
	declare @t_comp2 nvarchar(40)
	declare @t_productno nvarchar(30)
	declare @t_xproduct nvarchar(MAX)
	declare @t_mount1 float
	declare @t_weight1 float
	declare @t_total1 float
	declare @t_mount2 float
	declare @t_weight2 float
	declare @t_total2 float
	set @t_custno1 = '#zzzz#zzzz'
	set @t_custno2 = '#zzzz#zzzz'
	set @t_productno = '#zzzz#zzzz'
	set @t_xproduct = ''
	set @t_mount1 = 0
	set @t_weight1 = 0
	set @t_total1 = 0
	set @t_mount2 = 0
	set @t_weight2 = 0
	set @t_total2 = 0

	--***********************************************************************
	declare cursor_table cursor for
	select gno,typea,custno,comp,productno,xproduct,datea,total,mount,weight from @result
	open cursor_table
	fetch next from cursor_table
	into @gno,@typea,@custno,@comp,@productno,@xproduct,@datea,@total,@mount,@weight
	while(@@FETCH_STATUS <> -1)
	begin
		if @gno='0'
		begin
			if NOT(@t_custno1 = @custno and @t_productno = @productno)
			begin
				if NOT(@t_custno1 = '#zzzz#zzzz' and @t_productno = '#zzzz#zzzz')
				begin   
					insert into @result
					select '1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, @t_custno1, @t_comp1 comp, '' addr_invo, '' tel, 
						   @t_productno, @xproduct xproduct, '' unit, @t_mount1 mount, @t_weight1 weight, 0 price, @t_total1 total, 
						   0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount,''
				end
				set @t_custno1 = @custno
				set @t_comp1 = @comp
				set @t_productno = @productno
				set @t_xproduct = @xproduct
				set @t_mount1 = case @typea 
									when'1' then @mount 
									when'2' then -@mount 
									else 0 
								end 
				set @t_weight1 = case @typea 
									when'1' then @weight
									when'2' then -@weight
									else 0 
								end 
				set @t_total1 = case @typea
									when'1' then @total
									when'2' then -@total
								end
			end
			else
			begin
				set @t_mount1 = @t_mount1 + case @typea 
									when'1' then @mount 
									when'2' then -@mount 
									else 0 
								end 
				set @t_weight1 = @t_mount1 + case @typea 
									when'1' then @weight
									when'2' then -@weight
									else 0 
								end 
				set @t_total1 = @t_total1 + case @typea
									when'1' then @total
									when'2' then -@total
								end
			end
			
			if @t_custno2 != @custno
			begin
				if @t_custno2 != '#zzzz#zzzz'
				begin
					insert into @result
					select '2' gno, '' typea, '' noa, '' noq, '' datea, '' mon, @t_custno2, @t_comp2 comp, '' addr_invo, '' tel, 
						   CHAR(255) productno, '' xproduct, '' unit, @t_mount2 mount, @t_weight2 weight, 0 price, @t_total2 total, 
						   0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount,''
				end
				set @t_custno2 = @custno
				set @t_comp2 = @comp
				set @t_mount2 = case @typea 
									when'1' then @mount 
									when'2' then -@mount 
									else 0 
								end 
				set @t_weight2 = case @typea 
									when'1' then @weight
									when'2' then -@weight
									else 0 
								end 
				set @t_total2 = case @typea
									when'1' then @total
									when'2' then -@total
								end
			end
			else
			begin
				set @t_mount2 = @t_mount2 + case @typea 
									when'1' then @mount 
									when'2' then -@mount 
									else 0 
								end 
				set @t_weight2 = @t_mount2 + case @typea 
									when'1' then @weight
									when'2' then -@weight
									else 0 
								end 
				set @t_total2 = @t_total2 + case @typea
									when'1' then @total
									when'2' then -@total
								end
			end
		end
		fetch next from cursor_table
		into @gno,@typea,@custno,@comp,@productno,@xproduct,@datea,@total,@mount,@weight
	end
	close cursor_table
	deallocate cursor_table
	if NOT(@t_custno1 = '#zzzz#zzzz' and @t_productno = '#zzzz#zzzz')
	begin
		insert into @result
		select '1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, @t_custno1, @t_comp1 comp, '' addr_invo, '' tel, 
		       @t_productno, @xproduct xproduct, '' unit, @t_mount1 mount, @t_weight1 weight, 0 price, @t_total1 total, 
			   0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount,''
	end
	if @t_custno2 != '#zzzz#zzzz'
	begin
		insert into @result
		select '2' gno, '' typea, '' noa, '' noq, '' datea, '' mon, @t_custno2, @t_comp2 comp, '' addr_invo, '' tel, 
		       CHAR(255) productno, '' xproduct, '' unit, @t_mount2 mount, @t_weight2 weight, 0 price, @t_total2 total, 
			   0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount,''
	end
	--***********************************************************************
	update @result set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'
	
	
	update @result
	set mount=mount*-1,total=total*-1
	where typea='退'

	select gno, typea, noa, noq, datea, mon, custno, comp
	,addr_invo,tel,productno,xproduct,unit
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),@mount_decimal,30)) mount 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,weight),1)),@weight_decimal,30)) weight 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,price),1)),@price_decimal,30)) price 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),@total_decimal,30)) total 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,money),1)),@total_decimal,30)) money 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,back),1)),@total_decimal,30)) back 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,tax),1)),@total_decimal,30)) tax 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total1),1)),@total_decimal,30)) total1 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,pay),1)),@total_decimal,30)) pay 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,unpay),1)),@total_decimal,30)) unpay 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total2),1)),@total_decimal,30)) total2 
	,pcount ,qhref
	from @result order by custno,productno,gno,datea,noa,noq;
--**********************************************************************************************
z_vcc4:--z_vcc4
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
-------------------------------------------------------------------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

if(charindex('永勝',@t_acomp)>0)
begin
	set @mount_decimal =4
	set @weight_decimal =4
	set @price_decimal =4
end
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @mount_decimal =4
--------------------------------------------------
SET QUOTED_IDENTIFIER OFF
declare @tmp table(
	gno nvarchar(1),
	productno nvarchar(30),
	products nvarchar(MAX),
	cno nvarchar(30),
	custnick nvarchar(90),
	mount float,
	total float
)
	insert into @tmp
	select '9',b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end),a.custno,
		(case when isnull(c.nick,'') = '' then c.comp else c.nick end)
		,(case when a.typea='1' then 1 else -1 end)*b.mount,(case when a.typea='1' then 1 else -1 end)*b.total
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	where (a.datea between @t_bdate and @t_edate) and (a.custno between @t_bcustno and @t_ecustno) and 
			 (b.productno between @t_bproductno and @t_eproductno) 
			 and (len(@t_groupano)=0 or d.groupano = @t_groupano)
			 and (len(@t_groupbno)=0 or d.groupbno = @t_groupbno)
		  	 and (len(@t_groupcno)=0 or d.groupcno = @t_groupcno)
			 and (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea) and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno) and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by b.productno,b.product,a.custno,c.nick,c.comp	
	
	insert into @tmp 
	select '0',productno,products,cno,custnick,SUM(mount),SUM(total) from @tmp
	group by productno,products,cno,custnick
	
	delete @tmp where gno='9'

	insert into @tmp(gno,productno,products,mount,total) 
	select '1',productno,products,sum(mount),sum(total) 
	from @tmp where gno='0' group by productno,products 
	
select gno,productno,products,cno,left(custnick,10) custnick
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),@mount_decimal,30)) mount 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),@total_decimal,30)) total 
from @tmp order by productno,products,gno,cno;
--**********************************************************************************************
z_vcc5:--z_vcc5
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) =''
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

if(charindex('永勝',@t_acomp)>0)
begin
	set @mount_decimal =4
	set @weight_decimal =4
	set @price_decimal =4
end
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @mount_decimal =4
--------------------------------------------------
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @qhref_acomp='_it'
if(charindex('永勝',@t_acomp)>0)
	set @qhref_acomp='_uu'
if(charindex('楊家',@t_acomp)>0 or charindex('德芳',@t_acomp)>0)
	set @qhref_acomp='_tn'
if(charindex('有達',@t_acomp)>0 )
	set @qhref_acomp='_xy'
if(charindex('彩虹',@t_acomp)>0 )
	set @qhref_acomp='_rb'
-------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @result table(
	gno nvarchar(1),
	typea nvarchar(4),
	noa nvarchar(30),
	noq nvarchar(3),
	datea nvarchar(10),
	mon nvarchar(7),
	custno nvarchar(20),
	comp nvarchar(90),
	addr_invo nvarchar(90),
	tel nvarchar(90),
	productno nvarchar(30),
	xproduct nvarchar(MAX),
	unit nvarchar(8),
	mount float,
	weight float,
	price float,
	total float,
	pcount int,
	qhref nvarchar(MAX)
)

insert into @result
	select '0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, a.mon mon, 
		   a.custno custno, isnull(c.comp,''), isnull(c.addr_invo,''), isnull(c.tel,''), b.productno
		   , b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
		   , b.unit,b.mount, b.weight, b.price, b.total, 0 pcount,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vccs b
	left join view_vcc a on a.noa = b.noa
	left join cust c on  a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
		  (a.custno between @t_bcustno and @t_ecustno) and
		  (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and
		  (b.productno between @t_bproductno and @t_eproductno) and
		  (len(@t_groupano)=0 or d.groupano = @t_groupano) and 
		  (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and
		  (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
		  and (len(@t_stype)=0 or a.stype = @t_stype) 
		  and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
		  and (isnull(d.tggno,'') between @t_btggno and @t_etggno) and (len(@vcctypea)=0 or a.typea = @vcctypea) 
		  and (len(@t_partno)=0 or s.partno=@t_partno)
		  and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by custno,gno,mon,datea,noa,noq
	
insert into @result(gno,custno,pcount,mount,total)
	select '1',custno,
		count(*),
		sum((case typea when '1' then mount else (-1)*mount end)),
		sum((case typea when '1' then total else (-1)*total end))
	from @result a group by custno
	
update @result set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'

update @result
	set mount=mount*-1,total=total*-1
	where typea='退'

select 
	gno,typea,noa,noq,datea,mon,custno,comp,addr_invo,tel,productno,xproduct,unit, qhref
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),@mount_decimal,30)) mount 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,weight),1)),@weight_decimal,30)) weight 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,price),1)),@price_decimal,30)) price 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),@total_decimal,30)) total
	,pcount 
from @result order by custno,gno,mon,datea,noa,noq;
--**********************************************************************************************
z_vcc6:--z_vcc6
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
-------------------------------------------------------------------------------------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

if(charindex('永勝',@t_acomp)>0)
begin
	set @mount_decimal =4
	set @weight_decimal =4
	set @price_decimal =4
end
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @mount_decimal =4
--------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	custno nvarchar(30),
	custs nvarchar(90),
	mon nvarchar(15),
	mount float,
	total float,
	tax float
)

insert into @tmp
	select
		'0',a.custno,(case when isnull(c.nick,'') = '' then c.comp else c.nick end),
		case when isnull(a.mon,'')!='' then a.mon else left(a.datea,@r_lenm) end,sum((case when a.typea='1' then 1 else -1 end)*b.mount),sum((case when a.typea='1' then 1 else -1 end)*b.total)
		,sum((case when a.typea='1' then 1 else -1 end)*a.tax)
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	where  (a.datea between @t_bdate and @t_edate) and --(isnull(a.salesno,'') != '') and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and 
			 (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  	 (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and
			 (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea) and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno) and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	group by a.custno,c.nick,c.comp,case when isnull(a.mon,'')!='' then a.mon else left(a.datea,@r_lenm) end
	
insert into @tmp(gno,custno,custs,mon,mount,total,tax) 
select '1',custno,custs,'999/99',sum(mount),sum(total),sum(tax) from @tmp group by custno,custs

insert into @tmp(gno,custno,mount,total,tax) 
select '2','ZZZZ_ZZZ',sum(mount), sum(total), sum(tax) from @tmp where gno='1'


select gno,custno cno,left(custs,10) custs,mon
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),@mount_decimal,30)) mount 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),@total_decimal,30)) total 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,tax),1)),@total_decimal,30)) tax 
from @tmp order by custno,mon,gno;
--**********************************************************************************************
z_vcc7:--z_vcc7
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) =''
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

if(charindex('永勝',@t_acomp)>0)
begin
	set @mount_decimal =4
	set @weight_decimal =4
	set @price_decimal =4
end
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @mount_decimal =4
--------------------------------------------------
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @qhref_acomp='_it'
if(charindex('永勝',@t_acomp)>0)
	set @qhref_acomp='_uu'
if(charindex('楊家',@t_acomp)>0 or charindex('德芳',@t_acomp)>0)
	set @qhref_acomp='_tn'
if(charindex('有達',@t_acomp)>0 )
	set @qhref_acomp='_xy'
if(charindex('彩虹',@t_acomp)>0 )
	set @qhref_acomp='_rb'
-------------------------------------------------
	SET QUOTED_IDENTIFIER OFF
	
	declare @result table(
		gno nvarchar(1),
		typea nvarchar(4),
		noa nvarchar(15),
		noq nvarchar(3),
		datea nvarchar(10),
		mon nvarchar(7),
		custno nvarchar(20),
		comp nvarchar(90),
		addr_invo nvarchar(90),
		tel nvarchar(90),
		productno nvarchar(30),
		xproduct nvarchar(MAX),
		unit nvarchar(8),
		mount float,
		weight float,
		price float,
		total float,
		money float,
		back float,
		tax float,
		total1 float,
		pay float,
		unpay float,
		total2 float,
		pcount int,
		qhref nvarchar(MAX)
		primary key (productno,gno,datea,noa,noq) 
	)
	
	insert into @result
	select '0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, case when isnull(a.mon,'')!='' then a.mon else left(a.datea,@r_lenm) end mon, 
		   a.custno custno, isnull(c.comp,''), isnull(c.addr_invo,''), isnull(c.tel,''), b.productno
		   , b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
		   , b.unit,(case when a.typea='1' then 1 else -1 end) *b.mount, b.weight, b.price, b.total, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
	       ,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vccs b
	left join view_vcc a on a.noa = b.noa
	left join cust c on  a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
		  (a.custno between @t_bcustno and @t_ecustno) and
		  (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and
		  (b.productno between @t_bproductno and @t_eproductno) and
		  (len(@t_groupano)=0 or d.groupano = @t_groupano) and 
		  (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and
		  (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
		  and (len(@t_stype)=0 or a.stype = @t_stype) 
		  and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
		  and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
		  and (len(@vcctypea)=0 or a.typea = @vcctypea) 
		  and (len(@t_partno)=0 or s.partno=@t_partno)
		  and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by productno,gno,datea,noa,noq

	--***********************************************************************
	declare @gno nvarchar(1)
	declare @typea nvarchar(4)
	declare @noa nvarchar(15)
	declare @total float
	declare @datea nvarchar(10)
	declare @productno nvarchar(30)
	declare @t_productno nvarchar(30)
	declare @t_money float
	declare @t_back float
	declare @t_tax float
	declare @t_total1 float
	declare @t_pcount int
	set @t_productno = '#zzzz#zzzz'
	set @t_money = 0
	set @t_back = 0
	set @t_tax = 0
	set @t_total1 = 0
	set @t_pcount = 0
	--***********************************************************************
	declare cursor_table cursor for
	select gno,typea,productno,datea,total from @result
	open cursor_table
	fetch next from cursor_table
	into @gno,@typea,@productno,@datea,@total
	while(@@FETCH_STATUS <> -1)
	begin
		if @t_productno != @productno
		begin
			if @t_productno != '#zzzz#zzzz'
			begin
				set @t_total1 = @t_money - @t_back + @t_tax
				insert into @result
				select '1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, '' custno, '' comp, '' addr_invo, '' tel, 
				       @t_productno, '' product, '' unit, 0 mount, 0 weight, 0 price, 0 total, 
					   @t_money, @t_back, @t_tax, @t_total1, 0 pay, 0 unpay, 0 total2, @t_pcount,''
			end
			set @t_productno = @productno
			set @t_money = case when @typea = '1' then @total else 0 end
			set @t_back = case when @typea = '2' then @total else 0 end
			set @t_tax = case when @typea = '稅' then @total else 0 end
			set @t_pcount = 1
		end
		else
		begin
			set @t_money = @t_money + case when @typea = '1' then @total else 0 end
			set @t_back = @t_back + case when @typea = '2' then @total else 0 end
			set @t_tax = @t_tax + case when @typea = '稅' then @total else 0 end
			set @t_pcount = @t_pcount + 1
		end
		fetch next from cursor_table
		into @gno,@typea,@productno,@datea,@total
	end
	close cursor_table
	deallocate cursor_table
	
	if @t_productno != '#zzzz#zzzz'
	begin
		set @t_total1 = @t_money - @t_back + @t_tax
		insert into @result
		select '1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, '' custno, '' comp, '' addr_invo, '' tel, 
		       @t_productno, '' product, '' unit, 0 mount, 0 weight, 0 price, 0 total, 
			   @t_money, @t_back, @t_tax, @t_total1, 0 pay, 0 unpay, 0 total2, @t_pcount,''
	end
	--***********************************************************************
	update @result set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'
	
	update a 
	set mount=(select sum(mount) from @result where gno='0' and productno=a.productno) 
	from @result a	where gno='1' 
	
	update @result
	set total=total*-1
	where typea='退'
	
	select gno, typea, noa, noq, datea, mon, custno, left(comp,10) comp
	,addr_invo,tel,productno,xproduct,unit, qhref
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),@mount_decimal,30)) mount 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,weight),1)),@weight_decimal,30)) weight 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,price),1)),@price_decimal,30)) price 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),@total_decimal,30)) total 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,money),1)),@total_decimal,30)) money 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,back),1)),@total_decimal,30)) back 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,tax),1)),@total_decimal,30)) tax 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total1),1)),@total_decimal,30)) total1 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,pay),1)),@total_decimal,30)) pay 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,unpay),1)),@total_decimal,30)) unpay 
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total2),1)),@total_decimal,30)) total2 
	,pcount 
	from @result order by productno,gno,datea,noa,noq;
--**********************************************************************************************
z_vcc8:--z_vcc8
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end

--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

if(charindex('永勝',@t_acomp)>0)
begin
	set @mount_decimal =4
	set @weight_decimal =4
	set @price_decimal =4
end
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @mount_decimal =4
--------------------------------------------------
SET QUOTED_IDENTIFIER OFF	

declare @tmp table(
	gno nvarchar(1),
	productno nvarchar(30),
	products nvarchar(MAX),
	mon nvarchar(15),
	mount float,
	total float
)
declare @cmd nvarchar(max)

insert into @tmp
	select
		'0',b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
		,case when charindex('永勝',@t_acomp)>0 then left(a.datea,@r_lenm) when isnull(a.mon,'')!='' then a.mon else left(a.datea,@r_lenm) end
		,sum((case when a.typea='1' then 1 else -1 end)*b.mount),sum((case when a.typea='1' then 1 else -1 end)*b.total)
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join view_ucaucc d on b.productno = d.noa
	where  (a.datea between @t_bdate and @t_edate) and --(isnull(a.salesno,'') != '') and
	 		(a.custno between @t_bcustno and @t_ecustno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and
			 (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  	 (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and 
			 (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	group by b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
	,case when charindex('永勝',@t_acomp)>0 then left(a.datea,@r_lenm) when isnull(a.mon,'')!='' then a.mon else left(a.datea,@r_lenm) end
	
insert into @tmp(gno,productno,products,mon,mount,total)
select '1',productno,products,'999/99',sum(mount),sum(total)
from @tmp group by productno,products
	
insert into @tmp(gno,productno,mount,total)
select '2','ZZZZZZZZZZZZ',sum(mount),sum(total)
from @tmp where gno='1'

select gno,productno,(case when gno='0' then dbo.charbr(products,24) else products end )products,mon
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),@mount_decimal,30)) mount 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),@total_decimal,30)) total 
from @tmp order by productno,mon,gno;
--**********************************************************************************************
z_vcc9:--z_vcc9
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) =''
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

if(charindex('永勝',@t_acomp)>0)
begin
	set @mount_decimal =4
	set @weight_decimal =4
	set @price_decimal =4
end
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @mount_decimal =4
--------------------------------------------------
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @qhref_acomp='_it'
if(charindex('永勝',@t_acomp)>0)
	set @qhref_acomp='_uu'
if(charindex('楊家',@t_acomp)>0 or charindex('德芳',@t_acomp)>0)
	set @qhref_acomp='_tn'
if(charindex('有達',@t_acomp)>0 )
	set @qhref_acomp='_xy'
if(charindex('彩虹',@t_acomp)>0 )
	set @qhref_acomp='_rb'
-------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	salesno nvarchar(30),
	salesname nvarchar(50),
	comp nvarchar(100),
	datea nvarchar(10),
	noa nvarchar(35),
	typea nvarchar(15),
	productno nvarchar(30),
	products nvarchar(max),
	unit nvarchar(15),
	mount float,
	price float,
	total float,
	qhref nvarchar(max)
)
declare @cmd nvarchar(max)

insert into @tmp
	select '0',a.salesno,s.namea,a.comp,a.datea,a.noa,a.typea,b.productno
	,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end),b.unit,b.mount,b.price,b.total
	,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vcc a
	left join view_vccs b  on a.noa = b.noa and a.accy = b.accy
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and --(isnull(a.salesno,'') != '') and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and
			 (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  	 (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and 
			 (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_partno)=0 or s.partno=@t_partno)
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by a.salesno,a.datea

insert into @tmp(gno,salesno,salesname,mount,total)
	select '1' gno,salesno,salesname,
		sum((case when typea='1' then mount else mount*(-1) end)),
		sum((case when typea='1' then total else total*(-1) end)) 
	from @tmp group by salesno,salesname
update @tmp set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'

update @tmp
set mount=mount*-1,total=total*-1
where typea='退'

select gno,salesno,salesname,left(comp,10)comp,datea,noa,typea,productno,products,unit,qhref
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,price),1)),@price_decimal,30)) price 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),@mount_decimal,30)) mount 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),@total_decimal,30)) total 
from @tmp order by salesno,salesname,gno,datea,productno;
--**********************************************************************************************
z_vcc10:--z_vcc10
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

if(charindex('永勝',@t_acomp)>0)
begin
	set @mount_decimal =4
	set @weight_decimal =4
	set @price_decimal =4
end
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @mount_decimal =4
--------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	salesno nvarchar(30),
	salesname nvarchar(90),
	mon nvarchar(15),
	mount float,
	total float
)

insert into @tmp
	select
		'0',a.salesno,s.namea,case when isnull(a.mon,'')!='' then a.mon else left(a.datea,@r_lenm) end
		,sum((case when a.typea='1' then 1 else -1 end)*b.mount)
		,sum((case when a.typea='1' then 1 else -1 end)*b.total)
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where  (a.datea between @t_bdate and @t_edate) and --(isnull(a.salesno,'') != '') and
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and 
			 (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  	 (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and
			 (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and  (a.custno between @t_bcustno and @t_ecustno) 
			 and (isnull(b.productno,'') between @t_bproductno and @t_eproductno)
			and (len(@t_stype)=0 or a.stype = @t_stype) 
			and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			and (len(@t_partno)=0 or s.partno=@t_partno)
			and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	group by a.salesno,s.namea,case when isnull(a.mon,'')!='' then a.mon else left(a.datea,@r_lenm) end
	
insert into @tmp(gno,salesno,salesname,mon,mount,total)
select '1',salesno,salesname,'999/99',sum(mount),sum(total)
from @tmp group by salesno,salesname
	
insert into @tmp(gno,salesno,mount,total)
select '2','ZZZZZZ',sum(mount),sum(total)
from @tmp where gno='1'
	
select gno,salesno sno,salesname,mon
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),@mount_decimal,30)) mount 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),@total_decimal,30)) total 
from @tmp order by salesno,mon,gno;
--**********************************************************************************************
z_vcc11:--z_vcc11
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) =''
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

if(charindex('永勝',@t_acomp)>0)
begin
	set @mount_decimal =4
	set @weight_decimal =4
	set @price_decimal =4
end
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @mount_decimal =4
--------------------------------------------------
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @qhref_acomp='_it'
if(charindex('永勝',@t_acomp)>0)
	set @qhref_acomp='_uu'
if(charindex('楊家',@t_acomp)>0 or charindex('德芳',@t_acomp)>0)
	set @qhref_acomp='_tn'
if(charindex('有達',@t_acomp)>0 )
	set @qhref_acomp='_xy'
if(charindex('彩虹',@t_acomp)>0 )
	set @qhref_acomp='_rb'
-------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	salesno nvarchar(30),
	salesname nvarchar(50),
	comp nvarchar(100),
	datea nvarchar(10),
	noa nvarchar(35),
	typea nvarchar(15),
	productno nvarchar(30),
	products nvarchar(max),
	unit nvarchar(15),
	mount float,
	price float,
	total float,
	qhref nvarchar(max)
)

insert into @tmp
	select '0',a.salesno,s.namea,a.comp,a.datea,a.noa,a.typea
	,b.productno
	,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
	,b.unit,b.mount,b.price,b.total
	,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vcc a
	left join view_vccs b  on a.noa = b.noa and a.accy = b.accy
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and --(isnull(a.salesno,'') != '') and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and
			 (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  	 (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and 
			 (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_partno)=0 or s.partno=@t_partno)
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by a.salesno,b.productno

insert into @tmp(gno,salesno,salesname,mount,total)
	select '1' gno,salesno,salesname,
		sum((case when typea='1' then mount else mount*(-1) end)),
		sum((case when typea='1' then total else total*(-1) end)) 
	from @tmp group by salesno,salesname
	
update @tmp set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'

update @tmp
set mount=mount*-1,total=total*-1
where typea='退'

select 
gno,salesno,salesname,left(comp,10) comp,productno,products,datea,noa,typea,unit, qhref
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,price),1)),@price_decimal,30)) price 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),@mount_decimal,30)) mount 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),@total_decimal,30)) total  
from @tmp order by salesno,salesname,gno,productno,datea;
--**********************************************************************************************
z_vcc12:--z_vcc12
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

if(charindex('永勝',@t_acomp)>0)
begin
	set @mount_decimal =4
	set @weight_decimal =4
	set @price_decimal =4
end
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @mount_decimal =4
--------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	salesno nvarchar(30),
	salesname nvarchar(50),
	productno nvarchar(30),
	products nvarchar(max),
	mount float,
	total float
)

insert into @tmp
	select '0',a.salesno,s.namea,b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
	,sum((case when a.typea='1' then 1 else -1 end)*b.mount)
	,sum((case when a.typea='1' then 1 else -1 end)*b.total)
	from view_vcc a
	left join view_vccs b  on a.noa = b.noa and a.accy = b.accy
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and 
			  (a.custno between @t_bcustno and @t_ecustno) and 
			 --(isnull(a.salesno,'') != '') and 
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and
			 (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  	 (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and 
			 (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_partno)=0 or s.partno=@t_partno)
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	group by a.salesno,s.namea,b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
	order by a.salesno,b.productno
	
insert into @tmp(gno,mount,total)
select '1',sum(mount),sum(total)
from @tmp

select gno,salesno sno ,salesname,productno,products
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),@mount_decimal,30)) mount 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),@total_decimal,30)) total  
from @tmp order by gno,salesno,productno;
--**********************************************************************************************
z_vcc13:--z_vcc13
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) =''
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

if(charindex('永勝',@t_acomp)>0)
begin
	set @mount_decimal =4
	set @weight_decimal =4
	set @price_decimal =4
end
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @mount_decimal =4
--------------------------------------------------
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @qhref_acomp='_it'
if(charindex('永勝',@t_acomp)>0)
	set @qhref_acomp='_uu'
if(charindex('楊家',@t_acomp)>0 or charindex('德芳',@t_acomp)>0)
	set @qhref_acomp='_tn'
if(charindex('有達',@t_acomp)>0 )
	set @qhref_acomp='_xy'
if(charindex('彩虹',@t_acomp)>0 )
	set @qhref_acomp='_rb'
-------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	custno nvarchar(30),
	custnick nvarchar(90),
	salesno nvarchar(30),
	salesname nvarchar(50),
	productno nvarchar(30),
	products nvarchar(max),
	datea nvarchar(10),
	noa nvarchar(35),
	typea nvarchar(15),
	unit nvarchar(15),
	mount float,
	price float,
	total float,
	qhref nvarchar(MAX)
)

insert into @tmp
	select '0',a.custno,(case when isnull(c.nick,'') = '' then left(c.comp,10) else c.nick end),
	a.salesno,s.namea,b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
	,a.datea,a.noa,a.typea,b.unit,b.mount,b.price,b.total
	,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vcc a
	left join view_vccs b  on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and --(isnull(a.salesno,'') != '') and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			 and (len(@t_groupbno)=0 or d.groupbno = @t_groupbno)
		  	 and (len(@t_groupcno)=0 or d.groupcno = @t_groupcno)
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_partno)=0 or s.partno=@t_partno)
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by a.salesno,a.custno,b.productno
	
insert into @tmp(gno,salesno,salesname,mount,total)
	select '1' gno,salesno,salesname,
		sum((case when typea='1' then mount else mount*(-1) end)),
		sum((case when typea='1' then total else total*(-1) end)) 
	from @tmp group by salesno,salesname
	
update @tmp set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'

update @tmp
set mount=mount*-1,total=total*-1
where typea='退'

select gno,custno,custnick,salesno,salesname,productno,products,datea,noa,typea,unit,qhref
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,price),1)),@price_decimal,30)) price 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),@mount_decimal,30)) mount 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),@total_decimal,30)) total  
from @tmp order by salesno,gno,custno,productno,datea;
--**********************************************************************************************
z_vcc14:--z_vcc14
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

if(charindex('永勝',@t_acomp)>0)
begin
	set @mount_decimal =4
	set @weight_decimal =4
	set @price_decimal =4
end
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @mount_decimal =4
--------------------------------------------------
SET QUOTED_IDENTIFIER OFF	

declare @tmp table(
	gno nvarchar(1),
	custno nvarchar(30),
	custnick nvarchar(90),
	salesno nvarchar(30),
	salesname nvarchar(50),
	productno nvarchar(30),
	products nvarchar(max),
	mount float,
	total float
)

insert into @tmp
	select '0',a.custno,(case when isnull(c.nick,'') = '' then left(c.comp,10) else c.nick end),
	a.salesno,s.namea,b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
	,sum((case when a.typea='1' then 1 else -1 end)*b.mount)
	,sum((case when a.typea='1' then 1 else -1 end)*b.total)
	from view_vcc a
	left join view_vccs b  on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (isnull(a.salesno,'')between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and --(isnull(a.salesno,'') != '') and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and
			 (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  	 (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and 
			 (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			and (len(@vcctypea)=0 or a.typea = @vcctypea)
			and (len(@t_partno)=0 or s.partno=@t_partno)
			and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
			and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	group by a.salesno,s.namea,a.custno,c.nick,c.comp,b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
	order by a.salesno,a.custno,b.productno
	
insert into @tmp(gno,mount,total)
select '1',sum(mount),sum(total)
from @tmp

select gno,custno,left(custnick,7) custnick,salesno sno ,salesname,productno,products
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),@mount_decimal,30)) mount 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),@total_decimal,30)) total  
from @tmp order by gno,salesno,custno,productno;
--**********************************************************************************************
z_vcc15:--z_vcc15
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) =''
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

if(charindex('永勝',@t_acomp)>0)
begin
	set @mount_decimal =4
	set @weight_decimal =4
	set @price_decimal =4
end
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @mount_decimal =4
--------------------------------------------------
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @qhref_acomp='_it'
if(charindex('永勝',@t_acomp)>0)
	set @qhref_acomp='_uu'
if(charindex('楊家',@t_acomp)>0 or charindex('德芳',@t_acomp)>0)
	set @qhref_acomp='_tn'
if(charindex('有達',@t_acomp)>0 )
	set @qhref_acomp='_xy'
if(charindex('彩虹',@t_acomp)>0 )
	set @qhref_acomp='_rb'
-------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	productno nvarchar(30),
	products nvarchar(MAX),
	sno nvarchar(30),
	salesname nvarchar(90),
	cno nvarchar(30),
	custnick nvarchar(90),
	datea nvarchar(10),
	noa nvarchar(30),
	typea nvarchar(15),
	mount float,
	price float,
	total float,
	qhref nvarchar(MAX)
)

insert into @tmp
	select
		'0',b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
		,a.salesno,s.namea,a.custno,
		(case when isnull(c.nick,'') = '' then left(c.comp,10) else c.nick end),
		a.datea,a.noa,a.typea,b.mount,b.price,b.total,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and
			 (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  	 (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and 
			 (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno) and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_partno)=0 or s.partno=@t_partno)
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by b.productno,b.product,a.salesno,s.namea,a.custno,c.nick,c.comp,a.datea,a.noa,a.typea
	  
insert into @tmp(gno,productno,products,mount,total)
	select '1',productno,products,
		sum((case when typea='1' then mount else mount*(-1) end)),
		sum((case when typea='1' then total else total*(-1) end))
	from @tmp group by productno,products
update @tmp set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'

update @tmp
set mount=mount*-1,total=total*-1
where typea='退'

select gno,productno,products,sno,salesname,cno,custnick,datea,noa,typea, qhref
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,price),1)),@price_decimal,30)) price 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),@mount_decimal,30)) mount 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),@total_decimal,30)) total  
from @tmp order by productno,products,gno,sno,cno,datea,typea;
--**********************************************************************************************
z_vcc16:--z_vcc16
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

if(charindex('永勝',@t_acomp)>0)
begin
	set @mount_decimal =4
	set @weight_decimal =4
	set @price_decimal =4
end
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @mount_decimal =4
--------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	productno nvarchar(30),
	products nvarchar(MAX),
	sno nvarchar(30),
	salesname nvarchar(90),
	cno nvarchar(30),
	custnick nvarchar(90),
	mount float,
	total float
)

insert into @tmp
	select
		'0',b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
		,a.salesno,s.namea,a.custno,
		(case when isnull(c.nick,'') = '' then c.comp else c.nick end)
		,sum((case when a.typea='1' then 1 else -1 end)*b.mount)
		,sum((case when a.typea='1' then 1 else -1 end)*b.total)
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			 and (len(@t_groupbno)=0 or d.groupbno = @t_groupbno)
		  	 and (len(@t_groupcno)=0 or d.groupcno = @t_groupcno)
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_partno)=0 or s.partno=@t_partno)
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	group by b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
	,a.salesno,s.namea,a.custno,c.nick,c.comp
	
insert into @tmp(gno,productno,products,mount,total)
select '1',productno,products,sum(mount),sum(total)
from @tmp group by productno,products
	
select gno,productno,products,sno,salesname,cno,left(custnick,10) custnick 
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),@mount_decimal,30)) mount 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),@total_decimal,30)) total  
from @tmp order by productno,products,gno,sno,cno;
--**********************************************************************************************
z_vcc17:--z_vcc17
declare @t_bmon nvarchar(7)
declare @t_emon nvarchar(7)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'
	
set @t_bmon = case when '#non'=[6] then '' else [6] end
set @t_emon = case when '#non'=[7] then char(255) else [7] end
--declare @tmp table(
--	gno nvarchar(1),
--	idno int,
--	salesno nvarchar(30),
--	salesname nvarchar(90),
--	custno nvarchar(30),
--	custs nvarchar(90),
--	unpay float,
--	money float,
--	tax float,
--	total1 float,
--	opay float,
--	total2 float
--)
--insert into @tmp
--	select
--		'0',ROW_NUMBER()over(partition by salesno order by a.noa),
--		a.salesno,b.namea,a.noa,a.nick,0,0,0,0,0,0
--	from cust a
--	left join sss b on a.salesno = b.noa
--	order by a.salesno
--declare @custno nvarchar(30)
--declare @idno int
--declare @w_unpay float
--declare @w_money float
--declare @w_tax float
--declare @w_opay float
--declare cursor_table cursor for
--	select custno,idno from @tmp
--open cursor_table
--fetch next from cursor_table
--	into @custno,@idno
--while(@@FETCH_STATUS <> -1)
--begin
--	select @w_unpay = (
--		select sum(a.total) from view_vcc[1] a where (case when a.custno2!='' then a.custno2 else a.custno end) = @custno and
--		((case when a.mon='' then left(a.datea,@r_lenm) else a.mon end) < @t_bmon )
--	)
--	select @w_money = (
--		select sum(a.money) from view_vcc[1] a where (case when a.custno2!='' then a.custno2 else a.custno end) = @custno and
--		((case when a.mon='' then left(a.datea,@r_lenm) else a.mon end) between @t_bmon and @t_emon)
--	)
--	select @w_tax = (
--		select sum(a.tax) from view_vcc[1] a where (case when a.custno2!='' then a.custno2 else a.custno end) = @custno and
--		((case when a.mon='' then left(a.datea,@r_lenm) else a.mon end) between @t_bmon and @t_emon)
--	)
--	select @w_opay = (
--		select sum(a.total) from umm a where a.custno = @custno and
--		((case when a.mon='' then left(a.datea,@r_lenm) else a.mon end) between @t_bmon and @t_emon)
--	)
--	update @tmp set unpay = isnull(@w_unpay,0),money = isnull(@w_money,0),
--							tax = isnull(@w_tax,0),opay = isnull(@w_opay,0)
--						where custno=@custno
--	fetch next from cursor_table
--	into @custno,@idno
--end
--close cursor_table
--deallocate cursor_table
--insert into @tmp(gno,salesno,unpay,money,tax,total1,opay,total2)
--	select '1',salesno,sum(unpay),sum(money),sum(tax),sum(total1),sum(opay),sum(total2)
--	from @tmp group by salesno
--update @tmp set total1 = (money+tax)
--update @tmp set total2 = (unpay+total1-opay)
--select * from @tmp order by salesno,gno,custno
----------------------------------------------------------------------------------------------------------------------

declare @tmp table( 
	gno nvarchar(1), 
	custno nvarchar(30), 
	comp nvarchar(90), 
	salesno nvarchar(30), 
	namea nvarchar(30), 
	money float, 
	total float, 
	payed float
) 

--前期
insert into @tmp (gno,custno,salesno,money,total,payed)
select '9',custno,salesno,SUM(money),0,0 from (
	--trd 
	--select aa.custno,bb.salesno,SUM(isnull(unpay,0)) money from view_trd[1] aa left join cust bb on aa.custno=bb.noa where (case when len(aa.mon)=0 then left(aa.datea,@r_lenm) else aa.mon end) < @t_bmon group by  aa.custno,bb.salesno
	--union all
	--vcc 
	select (case when aa.custno2!='' then aa.custno2 else aa.custno end) custno,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end) salesno
	,SUM(isnull((case when aa.typea='1' then 1 else -1 end)*unpay,0))-isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where len(vccno)>8 and right(vccno,4)!='-TAX' and right(vccno,@r_lenm)<@t_bmon and left(vccno,len(vccno)-7)=(case when aa.custno2!='' then aa.custno2 else aa.custno end)),0) money 
	from view_vcc aa left join cust bb on aa.custno=bb.noa where (case when len(aa.mon)=0 then left(aa.datea,@r_lenm) else aa.mon end) < @t_bmon and (left(kind,4)!='健勞勞退') 
	group by (case when aa.custno2!='' then aa.custno2 else aa.custno end) ,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end)
	 --vcca
	union all
	select  ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end) salesno
	,SUM(isnull(ca.tax,0))-isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where len(vccno)>8 and right(vccno,4)='-TAX' and left(right(vccno,10),@r_lenm)<@t_bmon and left(vccno,len(vccno)-11)=ca.custno),0)
	from vcca ca left join view_vcc cb on ca.noa=cb.invono left join cust cc on ca.custno=cc.noa
	where (case when ca.mon!='' then ca.mon else LEFT(ca.datea,@r_lenm) end) < @t_bmon
	and (ca.taxtype='1' or ca.taxtype='5')
	group by ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end)
	--union all
	--cara 
	--select ca.carownerno,ca.sssno,outmoney-inmoney from cara ca left join caras cb on ca.noa=cb.noa where ca.mon=@t_bmon and cb.caritemno='001'
)tmp group by custno,salesno

--本期

insert into @tmp (gno,custno,salesno,money,total,payed)
select '9',custno,salesno,0,SUM(total),0 from (
	--trd 
	--select aa.custno,bb.salesno,SUM(isnull(total,0)) total from view_trd[1] aa left join cust bb on aa.custno=bb.noa where (case when len(aa.mon)=0 then left(aa.datea,@r_lenm) else aa.mon end) between @t_bmon and @t_emon group by  aa.custno,bb.salesno
	--union all
	--vcc 
	select (case when aa.custno2!='' then aa.custno2 else aa.custno end) custno,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end) salesno
	,SUM(isnull((case when aa.typea='1' then 1 else -1 end)*total,0)) total
	from view_vcc aa left join cust bb on aa.custno=bb.noa where (case when len(aa.mon)=0 then left(aa.datea,@r_lenm) else aa.mon end) between @t_bmon and @t_emon and (left(kind,4)!='健勞勞退') 
	group by (case when aa.custno2!='' then aa.custno2 else aa.custno end) ,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end)
	--vcca
	union all
	select  ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end) salesno
	,SUM(isnull(ca.tax,0))
	from vcca ca left join view_vcc cb on ca.noa=cb.invono left join cust cc on ca.custno=cc.noa
	where (case when ca.mon!='' then ca.mon else LEFT(ca.datea,@r_lenm) end) between @t_bmon and @t_emon
	and (ca.taxtype='1' or ca.taxtype='5')
	group by ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end) 
	--union all
	--cara 
	--select ca.carownerno,ca.sssno,sum(outmoney) from cara ca left join caras cb on ca.noa=cb.noa where ca.mon between @t_bmon and @t_emon and cb.caritemno!='001' group by ca.carownerno,ca.sssno
)tmp group by custno,salesno

--本期已付
insert into @tmp (gno,custno,salesno,money,total,payed)
select '9',custno,salesno,0,0,SUM(payed) from (
	--trd 
	--select aa.custno,bb.salesno,SUM(isnull(payed,0)) payed from view_trd[1] aa left join cust bb on aa.custno=bb.noa where (case when len(aa.mon)=0 then left(aa.datea,@r_lenm) else aa.mon end) between @t_bmon and @t_emon group by  aa.custno,bb.salesno
	--union all
	--vcc 
	select (case when aa.custno2!='' then aa.custno2 else aa.custno end) custno,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end) salesno
	,SUM(isnull((case when aa.typea='1' then 1 else -1 end)*payed,0)) 
	+isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where len(vccno)>8 and right(vccno,4)!='-TAX' and right(vccno,@r_lenm) between @t_bmon and @t_emon and left(vccno,len(vccno)-7)=(case when aa.custno2!='' then aa.custno2 else aa.custno end)),0) payed 
	from view_vcc aa left join cust bb on aa.custno=bb.noa where (case when len(aa.mon)=0 then left(aa.datea,@r_lenm) else aa.mon end) between @t_bmon and @t_emon and (left(kind,4)!='健勞勞退') 
	group by (case when aa.custno2!='' then aa.custno2 else aa.custno end) ,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end)
	--vcca
	union all
	select  ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end) salesno
	,0+isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where len(vccno)>8 and right(vccno,4)='-TAX' and left(right(vccno,10),@r_lenm) between @t_bmon and @t_emon and left(vccno,len(vccno)-11)=ca.custno),0)
	from vcca ca left join view_vcc cb on ca.noa=cb.invono left join cust cc on ca.custno=cc.noa
	where (case when ca.mon!='' then ca.mon else LEFT(ca.datea,@r_lenm) end) between @t_bmon and @t_emon
	and (ca.taxtype='1' or ca.taxtype='5')
	group by ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end)
	--union all
	--cara 
	--select ca.carownerno,ca.sssno,sum(inmoney) from cara ca left join caras cb on ca.noa=cb.noa where ca.mon between @t_bmon and @t_emon and cb.caritemno!='001' group by ca.carownerno,ca.sssno
)tmp group by custno,salesno

insert into @tmp (gno,custno,salesno,money,total,payed)
select '0',custno,salesno,SUM(money),SUM(total),SUM(payed) from @tmp group by custno,salesno

delete @tmp where gno='9'

delete @tmp where money=0 and total=0 and payed=0 
update @tmp
set comp=(select top 1 nick from ((select nick from cust where noa=custno union select namea from carOwner where noa=custno union select namea from sss where noa=custno))tmp)
,namea=(select namea from sss where noa=salesno)

insert into @tmp 
select '1'gno,'','',salesno,'',sum(money),sum(total),sum(payed) from @tmp group by salesno 

---------------------------------------------------------------------------------------------------------------------
select gno,custno,comp,salesno,namea
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money),1)),4,12)) money
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,payed),1)),4,12)) payed
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money+total-payed),1)),4,12)) unpay
from @tmp order by salesno,gno;
------------------------------------------------------------------------------------------------------------------------------------
z_vcc18:--z_vcc18
	declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end

declare @tmp table( 
	gno nvarchar(1), 
	custno nvarchar(30), 
	comp nvarchar(90), 
	salesno nvarchar(30), 
	namea nvarchar(30), 
	money float, 
	total float, 
	payed float
) 

--前期
insert into @tmp (gno,custno,salesno,money,total,payed)
select '9',a.custno,a.salesno,SUM(a.money),0,0 from (
	--trd 
	--select aa.custno,bb.salesno,SUM(isnull(unpay,0)) money from view_trd[1] aa left join cust bb on aa.custno=bb.noa where (case when len(aa.mon)=0 then left(aa.datea,@r_lenm) else aa.mon end) < @t_bmon 
	--and @t_paytype='全部'
	--group by  aa.custno,bb.salesno
	--union all
	--vcc 
	select (case when aa.custno2!='' then aa.custno2 else aa.custno end) custno,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end) salesno
	,SUM(isnull((case when aa.typea='1' then 1 else -1 end)*unpay,0))-isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where len(vccno)>8 and right(vccno,@r_lenm)<@t_bmon and left(vccno,len(vccno)-7)=(case when aa.custno2!='' then aa.custno2 else aa.custno end)),0) money 
	from view_vcc aa left join cust bb on aa.custno=bb.noa where (case when len(aa.mon)=0 then left(aa.datea,@r_lenm) else aa.mon end) < @t_bmon and (left(kind,4)!='健勞勞退')
	and (@t_paytype='全部' or aa.paytype=@t_paytype)
	group by (case when aa.custno2!='' then aa.custno2 else aa.custno end) ,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end)
	--vcca
	union all
	select  ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end) salesno
	,SUM(isnull(ca.tax,0))-isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where len(vccno)>8 and right(vccno,4)='-TAX' and left(right(vccno,10),@r_lenm)<@t_bmon and left(vccno,len(vccno)-11)=ca.custno),0)
	from vcca ca left join view_vcc cb on ca.noa=cb.invono left join cust cc on ca.custno=cc.noa
	where (case when ca.mon!='' then ca.mon else LEFT(ca.datea,@r_lenm) end) < @t_bmon
	and (ca.taxtype='1' or ca.taxtype='5')
	group by ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end)
	--union all
	--cara 
	--select ca.carownerno,ca.sssno,outmoney-inmoney from cara ca left join caras cb on ca.noa=cb.noa where ca.mon=@t_bmon and cb.caritemno='001'
	--and @t_paytype='全部'
)a left join sss s on isnull(a.salesno,'')=s.noa
where (a.custno between @t_bcustno and @t_ecustno ) 
and (a.salesno between @t_bsalesno and @t_esalesno) 
and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
group by a.custno,a.salesno

--本期

insert into @tmp (gno,custno,salesno,money,total,payed)
select '9',a.custno,a.salesno,0,SUM(a.total),0 from (
	--trd 
	--select aa.custno,bb.salesno,SUM(isnull(total,0)) total from view_trd[1] aa left join cust bb on aa.custno=bb.noa where (case when len(aa.mon)=0 then left(aa.datea,@r_lenm) else aa.mon end) between @t_bmon and @t_emon 
	--and @t_paytype='全部'
	--group by  aa.custno,bb.salesno
	--union all
	--vcc 
	select (case when aa.custno2!='' then aa.custno2 else aa.custno end) custno,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end) salesno
	,SUM(isnull((case when aa.typea='1' then 1 else -1 end)*total,0)) total
	from view_vcc aa left join cust bb on aa.custno=bb.noa where (case when len(aa.mon)=0 then left(aa.datea,@r_lenm) else aa.mon end) between @t_bmon and @t_emon and (left(kind,4)!='健勞勞退')
	and (@t_paytype='全部' or aa.paytype=@t_paytype) 
	group by (case when aa.custno2!='' then aa.custno2 else aa.custno end) ,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end)
	--vcca
	union all
	select  ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end) salesno
	,SUM(isnull(ca.tax,0))
	from vcca ca left join view_vcc cb on ca.noa=cb.invono left join cust cc on ca.custno=cc.noa
	where (case when ca.mon!='' then ca.mon else LEFT(ca.datea,@r_lenm) end) between @t_bmon and @t_emon
	and (ca.taxtype='1' or ca.taxtype='5')
	group by ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end) 
	--union all
	--cara 
	--select ca.carownerno,ca.sssno,sum(outmoney) from cara ca left join caras cb on ca.noa=cb.noa where ca.mon between @t_bmon and @t_emon and cb.caritemno!='001' 
	--and @t_paytype='全部'
	--group by ca.carownerno,ca.sssno
)a left join sss s on isnull(a.salesno,'')=s.noa
where (a.custno between @t_bcustno and @t_ecustno ) 
and (a.salesno between @t_bsalesno and @t_esalesno) 
and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
group by custno,salesno

--本期已付
insert into @tmp (gno,custno,salesno,money,total,payed)
select '9',a.custno,a.salesno,0,0,SUM(a.payed) from (
	--trd 
	--select aa.custno,bb.salesno,SUM(isnull(payed,0)) payed from view_trd[1] aa left join cust bb on aa.custno=bb.noa where (case when len(aa.mon)=0 then left(aa.datea,@r_lenm) else aa.mon end) between @t_bmon and @t_emon 
	--and @t_paytype='全部'
	--group by  aa.custno,bb.salesno
	--union all
	--vcc 
	select (case when aa.custno2!='' then aa.custno2 else aa.custno end) custno,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end) salesno
	,SUM(isnull((case when aa.typea='1' then 1 else -1 end)*payed,0)) 
	+isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where len(vccno)>8 and right(vccno,@r_lenm) between @t_bmon and @t_emon and left(vccno,len(vccno)-7)=(case when aa.custno2!='' then aa.custno2 else aa.custno end)),0) payed 
	from view_vcc aa left join cust bb on aa.custno=bb.noa where (case when len(aa.mon)=0 then left(aa.datea,@r_lenm) else aa.mon end) between @t_bmon and @t_emon and (left(kind,4)!='健勞勞退')
	and (@t_paytype='全部' or aa.paytype=@t_paytype) 
	group by (case when aa.custno2!='' then aa.custno2 else aa.custno end) ,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end)
	--vcca
	union all
	select  ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end) salesno
	,0+isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where len(vccno)>8 and right(vccno,4)='-TAX' and left(right(vccno,10),@r_lenm) between @t_bmon and @t_emon and left(vccno,len(vccno)-11)=ca.custno),0)
	from vcca ca left join view_vcc cb on ca.noa=cb.invono left join cust cc on ca.custno=cc.noa
	where (case when ca.mon!='' then ca.mon else LEFT(ca.datea,@r_lenm) end) between @t_bmon and @t_emon
	and (ca.taxtype='1' or ca.taxtype='5')
	group by ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end)
	--union all
	--cara 
	--select ca.carownerno,ca.sssno,sum(inmoney) from cara ca left join caras cb on ca.noa=cb.noa where ca.mon between @t_bmon and @t_emon and cb.caritemno!='001' 
	--and @t_paytype='全部'
	--group by ca.carownerno,ca.sssno
)a left join sss s on isnull(a.salesno,'')=s.noa
where (a.custno between @t_bcustno and @t_ecustno ) 
and (a.salesno between @t_bsalesno and @t_esalesno) 
and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
group by a.custno,a.salesno

insert into @tmp (gno,custno,salesno,money,total,payed)
select '0',custno,salesno,SUM(money),SUM(total),SUM(payed) from @tmp group by custno,salesno

delete @tmp where gno='9'

delete @tmp where money=0 and total=0 and payed=0 
update @tmp
set comp=(select top 1 nick from ((select nick from cust where noa=custno union select namea from carOwner where noa=custno union select namea from sss where noa=custno))tmp)
,namea=(select namea from sss where noa=salesno)

insert into @tmp 
select '1'gno,'','',salesno,'',sum(money),sum(total),sum(payed) from @tmp group by salesno

select gno,custno,comp,salesno saleno,namea sales
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money),1)),4,12)) money
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,payed),1)),4,12)) payed
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money+total-payed),1)),4,12)) unpay
from @tmp order by salesno,gno,custno;
--**********************************************************************************************
z_vcc19:--z_vcc19
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
-------------------------------------------------------------------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

if(charindex('永勝',@t_acomp)>0)
begin
	set @mount_decimal =4
	set @weight_decimal =4
	set @price_decimal =4
end
if(charindex('英特瑞',@t_acomp)>0 or charindex('安美得',@t_acomp)>0)
	set @mount_decimal =4
--------------------------------------------------
SET QUOTED_IDENTIFIER OFF
declare @tmp table(
	gno nvarchar(1),
	productno nvarchar(30),
	products nvarchar(MAX),
	cno nvarchar(30),
	custnick nvarchar(90),
	mount float,
	total float
)

insert into @tmp
	select '9',b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
		,a.custno,	(case when isnull(c.nick,'') = '' then c.comp else c.nick end)
		,(case when a.typea='1' then 1 else -1 end)*b.mount,(case when a.typea='1' then 1 else -1 end)*b.total
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	where (a.datea between @t_bdate and @t_edate) and (a.custno between @t_bcustno and @t_ecustno) and 
			 (b.productno between @t_bproductno and @t_eproductno) 
			 and (len(@t_groupano)=0 or d.groupano = @t_groupano)
			 and (len(@t_groupbno)=0 or d.groupbno = @t_groupbno)
		  	 and (len(@t_groupcno)=0 or d.groupcno = @t_groupcno)
			 and (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea) and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by b.productno,b.product,a.custno,c.nick,c.comp
	
	insert into @tmp 
	select '0',productno,products,cno,custnick,SUM(mount),SUM(total) from @tmp
	group by productno,products,cno,custnick
	
	delete @tmp where gno='9'

	insert into @tmp(gno,cno,custnick,mount,total) 
	select '1',cno,custnick,sum(mount),sum(total) 
	from @tmp where gno='0' group by cno,custnick 
	
select gno,productno,products,cno,custnick
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),@mount_decimal,30)) mount 
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),@total_decimal,30)) total 
from @tmp order by cno,custnick,gno,productno;

--********************************************************************************************************
--XY
--********************************************************************************************************
z_vcc1_xy:--z_vcc1_xy
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) =''
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4
--------------------------------------------------
set @qhref_acomp='_xy'
-------------------------------------------------
set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--***********************************************************************************
SET QUOTED_IDENTIFIER OFF

declare @result table(
	gno nvarchar(10),
	noa nvarchar(30),
	noq nvarchar(10),
	typea nvarchar(12),
	datea nvarchar(10),
	mon nvarchar(7),
	custno nvarchar(30),
	comp nvarchar(90),
	productno nvarchar(30),
	xproduct nvarchar(MAX),
	unit nvarchar(12),
	lengthb float,
	lengthc float,
	mount float,
	weight float,
	price float,
	total float,
	qhref nvarchar(max),
	invono nvarchar(MAX),
	idate nvarchar(30),
	imoney float,
	itax float,
	itotal float
)

	insert into @result
	select '91' gno, a.noa noa, b.noq noq, a.typea typea, a.datea datea, (case when a.mon='' then left(a.datea,@r_lenm) else a.mon end), a.custno, a.comp
		, b.productno, b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end), b.unit, b.lengthb,b.lengthc
		  , b.mount, b.weight, b.price, b.total,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
		   ,a.invono,v.datea,v.money,v.tax,v.total
	from view_vccs b
	left join view_vcc a on a.noa = b.noa
	left join view_ucaucc c on b.productno = c.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	left join vcca v on a.invono=v.noa
	where (a.datea between @t_bdate and @t_edate) and
		  (a.custno between @t_bcustno and @t_ecustno) and
		  (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and
		  (b.productno between @t_bproductno and @t_eproductno) and
		  (len(@t_groupano)=0 or c.groupano = @t_groupano) and
		  (len(@t_groupbno)=0 or c.groupbno = @t_groupbno) and
		  (len(@t_groupcno)=0 or c.groupcno = @t_groupcno) and
		  (len(@t_typea)=0 or isnull(c.typea,'null') = @t_typea) and (len(@t_stype)=0 or a.stype = @t_stype) 
		  and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
		  and (isnull(c.tggno,'') between @t_btggno and @t_etggno) and (len(@vcctypea)=0 or a.typea = @vcctypea) 
		  and (len(@t_partno)=0 or s.partno=@t_partno)
		  and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by a.datea,gno,noa,noq
	
if(@t_showinvono='1')
begin
	insert into @result(gno,datea,noa,noq,invono,idate,imoney,itax,itotal)
	select '92',datea,noa,'ZZZ',invono,idate,imoney,itax,itotal
	from @result group by datea,noa,invono,idate,imoney,itax,itotal
end
	
insert into @result(gno,datea,noa,lengthb,lengthc,mount,price,total)
	select '93',datea,'ZZZZZZZZZZZZ',
		sum((case typea when '1' then lengthb else (-1)*lengthb end)),
		sum((case typea when '1' then lengthc else (-1)*lengthc end)),
		sum((case typea when '1' then mount else (-1)*mount end)),
		sum((case typea when '1' then price else (-1)*price end)),
		sum((case typea when '1' then total else (-1)*total end))
	from @result group by datea
	
insert into @result(gno,datea,noa,lengthb,lengthc,mount,price,total)
	select '94',left(datea,@r_lenm)+'z','ZZZZZZZZZZZZ',sum(lengthb),sum(lengthc),sum(mount),sum(price),sum(total)
	from @result a where gno='93' group by left(datea,@r_lenm)
--*************************************************************************	
update @result set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'
update @result set gno='0' where gno='91'
update @result set gno='1' where gno='92'
update @result set gno='2' where gno='93'
update @result set gno='3' where gno='94'

update @result
set mount=mount*-1,total=total*-1
where typea='退'

select gno, noa, noq, typea, datea, LEFT(datea,@r_lenm) xdatea, mon, custno, left(comp,10) comp, productno, xproduct,unit,qhref
	,dbo.getComma(lengthb,-1) lengthb
	,dbo.getComma(lengthc,-1) lengthc
	,dbo.getComma(mount,-1) mount
	,dbo.getComma(weight,-1) weight
	,dbo.getComma(price,-1) price
	,dbo.getComma(total,-1) total
	,invono,idate
	,dbo.getComma(imoney,-1) imoney
	,dbo.getComma(itax,-1) itax
	,dbo.getComma(itotal,-1) itotal
from @result order by datea,noa,noq;
--*********************************************************************************************************
z_vcc3_xy:--z_vcc3_xy
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bsalesno nvarchar(20)
	declare @t_esalesno nvarchar(20)
	declare @t_bproductno nvarchar(30)
	declare @t_eproductno nvarchar(30)
	declare @t_btggno nvarchar(50)
	declare @t_etggno nvarchar(50)
	declare @t_typea nvarchar(30)
	declare @t_groupano nvarchar(30)
	declare @t_groupbno nvarchar(30)
	declare @t_groupcno nvarchar(30)
	declare @t_stype nvarchar(30)
	declare @t_salesgroup nvarchar(100)
	declare @t_showinvono nvarchar(10)
	declare @t_acomp nvarchar(MAX)='[3]'
	declare @qhref_acomp nvarchar(10) =''
	declare @vcctypea nvarchar(10) =''
	declare @t_partno nvarchar(30)
	declare @isspec nvarchar(10)='[25]'
	declare @t_multcust nvarchar(max)
	declare @t_multucc nvarchar(max)
	declare @r_len nvarchar(10)='[28]'
	declare @r_lenm nvarchar(10)='6'
	if (@r_len='4')
		set @r_lenm='7'
	
	set @t_bdate = case when '#non'=[4] then '' else [4] end
	set @t_edate = case when '#non'=[5] then char(255) else [5] end
	set @t_bcustno = case when '#non'=[8] then '' else [8] end
	set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
	set @t_bsalesno = case when '#non'=[10] then '' else [10] end
	set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
	set @t_bproductno = case when '#non'=[12] then '' else [12] end
	set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
	set @t_btggno = case when '#non' = [14] then '' else [14] end
	set @t_etggno = case when '#non' = [15] then char(255) else [15] end
	set @t_typea = case when '#non'=[16] then '' else [16] end
	set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
	set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
	set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
	set @t_stype = case when '#non'=[20] then '' else [20] end
	set @t_salesgroup = case when '#non' = [21] then '' else [21] end
	set @t_showinvono = case when '#non' = [24] then 0 else [24] end
	set @vcctypea = case when '#non' = [22] then '' else [22] end
	set @t_partno = case when '#non' = [23] then '' else [23] end
	set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
	set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4
--------------------------------------------------
set @qhref_acomp='_xy'
-------------------------------------------------
	SET QUOTED_IDENTIFIER OFF
	
	declare @result table(
		gno nvarchar(1),
		typea nvarchar(4),
		noa nvarchar(15),
		noq nvarchar(3),
		datea nvarchar(10),
		mon nvarchar(7),
		custno nvarchar(20),
		comp nvarchar(90),
		addr_invo nvarchar(90),
		tel nvarchar(90),
		productno nvarchar(30),
		xproduct nvarchar(MAX),
		unit nvarchar(8),
		lengthb float,
		lengthc float,
		mount float,
		weight float,
		price float,
		total float,
		money float,
		back float,
		tax float,
		total1 float,
		pay float,
		unpay float,
		total2 float,
		pcount int,
		qhref nvarchar(MAX)
		primary key (custno,productno,gno,datea,noa,noq) 
	)
	
	insert into @result
	select '0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, a.mon mon, 
		   a.custno custno, isnull(c.comp,''), isnull(c.addr_invo,''), isnull(c.tel,''), b.productno
		   , b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
		   , b.unit,b.lengthb,b.lengthc,b.mount, b.weight, b.price, b.total, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
	       ,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vccs b
	left join view_vcc a on a.noa = b.noa
	left join cust c on  a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
		  (a.custno between @t_bcustno and @t_ecustno) and
		  (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and
		  (b.productno between @t_bproductno and @t_eproductno) and
		  (len(@t_groupano)=0 or d.groupano = @t_groupano) and 
		  (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and
		  (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea) and (len(@t_stype)=0 or a.stype = @t_stype) 
		  and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
		  and (isnull(d.tggno,'') between @t_btggno and @t_etggno) and (len(@vcctypea)=0 or a.typea = @vcctypea) 
		  and (len(@t_partno)=0 or s.partno=@t_partno)
		  and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by custno,productno,gno,datea,noa,noq
	--***********************************************************************
	insert @result(gno,custno,comp,productno,lengthb,lengthc,mount,total,datea,noa,noq)
	select '1',custno,MAX(comp),productno
	,sum(case typea when '1' then 1 else -1 end*lengthb)
	,sum(case typea when '1' then 1 else -1 end*lengthc)
	,sum(case typea when '1' then 1 else -1 end*mount)
	,sum(case typea when '1' then 1 else -1 end*total) ,CHAR(255),CHAR(255),CHAR(255)
	from @result where gno='0'
	group by custno,productno
	
	insert @result(gno,custno,comp,productno,lengthb,lengthc,mount,total,datea,noa,noq)
	select '2',custno,MAX(comp),char(255)
	,sum(case typea when '1' then 1 else -1 end*lengthb)
	,sum(case typea when '1' then 1 else -1 end*lengthc)
	,sum(case typea when '1' then 1 else -1 end*mount)
	,sum(case typea when '1' then 1 else -1 end*total) ,CHAR(255),CHAR(255),CHAR(255)
	from @result where gno='0'
	group by custno
	
	--***********************************************************************
	update @result set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'
	
	update @result
	set mount=mount*-1,total=total*-1,lengthb=lengthb*-1,lengthc=lengthc*-1
	where typea='退'

	select gno, typea, noa, noq, datea, mon, custno, comp
	,addr_invo,tel,productno,xproduct,unit
	,dbo.getComma(lengthb,-1) lengthb
	,dbo.getComma(lengthc,-1) lengthc
	,dbo.getComma(mount,-1) mount
	,dbo.getComma(total,-1) total
	,dbo.getComma(price,-1) price 
	,pcount ,qhref
	from @result order by custno,productno,gno,datea,noa,noq;
--**********************************************************************************************
z_vcc4_xy:--z_vcc4_xy
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
-------------------------------------------------------------------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

--------------------------------------------------
SET QUOTED_IDENTIFIER OFF
declare @tmp table(
	gno nvarchar(1),
	productno nvarchar(30),
	products nvarchar(MAX),
	unit nvarchar(10),
	cno nvarchar(30),
	custnick nvarchar(90),
	lengthb float,
	lengthc float,
	mount float,
	total float
)
	insert into @tmp
	select '9',b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end),d.unit
	,a.custno,(case when isnull(c.nick,'') = '' then c.comp else c.nick end)
	,(case when a.typea='1' then 1 else -1 end)*b.lengthb
	,(case when a.typea='1' then 1 else -1 end)*b.lengthc
	,(case when a.typea='1' then 1 else -1 end)*b.mount
	,(case when a.typea='1' then 1 else -1 end)*b.total
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	where (a.datea between @t_bdate and @t_edate) and (a.custno between @t_bcustno and @t_ecustno) and 
			 (b.productno between @t_bproductno and @t_eproductno) 
			 and (len(@t_groupano)=0 or d.groupano = @t_groupano)
			 and (len(@t_groupbno)=0 or d.groupbno = @t_groupbno)
		  	 and (len(@t_groupcno)=0 or d.groupcno = @t_groupcno)
			 and (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea) and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno) and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by b.productno,b.product,a.custno,c.nick,c.comp	
	
	insert into @tmp 
	select '0',productno,products,unit,cno,custnick,SUM(lengthb),SUM(lengthc),SUM(mount),SUM(total) from @tmp
	group by productno,products,unit,cno,custnick
	
	delete @tmp where gno='9'

	insert into @tmp(gno,productno,products,lengthb,lengthc,mount,total) 
	select '1',productno,products,sum(lengthb),sum(lengthc),sum(mount),sum(total) 
	from @tmp where gno='0' group by productno,products
	
select gno,productno,products,cno,left(custnick,10) custnick
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,dbo.getComma(lengthb,-1) lengthb
,dbo.getComma(lengthc,-1) lengthc
,dbo.getComma(mount,-1) mount
,dbo.getComma(total,-1) total
from @tmp order by productno,products,gno,cno;
--**********************************************************************************************
z_vcc5_xy:--z_vcc5_xy
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) =''
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4
--------------------------------------------------
set @qhref_acomp='_xy'
-------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @result table(
	gno nvarchar(1),
	typea nvarchar(4),
	noa nvarchar(30),
	noq nvarchar(3),
	datea nvarchar(10),
	mon nvarchar(7),
	custno nvarchar(20),
	comp nvarchar(90),
	addr_invo nvarchar(90),
	tel nvarchar(90),
	productno nvarchar(30),
	xproduct nvarchar(MAX),
	unit nvarchar(8),
	lengthb float,
	lengthc float,
	mount float,
	weight float,
	price float,
	total float,
	pcount int,
	qhref nvarchar(MAX)
)

insert into @result
	select '0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, a.mon mon, 
		   a.custno custno, isnull(c.comp,''), isnull(c.addr_invo,''), isnull(c.tel,''), b.productno
		   , b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
		   , b.unit,b.lengthb,b.lengthc,b.mount, b.weight, b.price, b.total, 0 pcount,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vccs b
	left join view_vcc a on a.noa = b.noa
	left join cust c on  a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
		  (a.custno between @t_bcustno and @t_ecustno) and
		  (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and
		  (b.productno between @t_bproductno and @t_eproductno) and
		  (len(@t_groupano)=0 or d.groupano = @t_groupano) and 
		  (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and
		  (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
		  and (len(@t_stype)=0 or a.stype = @t_stype) 
		  and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
		  and (isnull(d.tggno,'') between @t_btggno and @t_etggno) and (len(@vcctypea)=0 or a.typea = @vcctypea) 
		  and (len(@t_partno)=0 or s.partno=@t_partno)
		  and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by custno,gno,mon,datea,noa,noq
	
insert into @result(gno,custno,pcount,lengthb,lengthc,mount,total)
	select '1',custno,
		count(*),
		sum((case typea when '1' then lengthb else (-1)*lengthb end)),
		sum((case typea when '1' then lengthc else (-1)*lengthc end)),
		sum((case typea when '1' then mount else (-1)*mount end)),
		sum((case typea when '1' then total else (-1)*total end))
	from @result a group by custno
	
update @result set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'

update @result
	set mount=mount*-1,total=total*-1,lengthb=lengthb*-1,lengthc=lengthc*-1
	where typea='退'

select 
	gno,typea,noa,noq,datea,mon,custno,comp,addr_invo,tel,productno,xproduct,unit, qhref
	,dbo.getComma(lengthb,-1) lengthb
	,dbo.getComma(lengthc,-1) lengthc
	,dbo.getComma(mount,-1) mount
	,dbo.getComma(price,-1) price
	,dbo.getComma(total,-1) total
	,pcount 
from @result order by custno,gno,mon,datea,noa,noq;
--**********************************************************************************************
z_vcc6_xy:--z_vcc6_xy
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
-------------------------------------------------------------------------------------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

--------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	custno nvarchar(30),
	custs nvarchar(90),
	mon nvarchar(15),
	lengthb float,
	lengthc float,
	mount float,
	total float,
	tax float
)

insert into @tmp
	select
		'0',a.custno,(case when isnull(c.nick,'') = '' then c.comp else c.nick end),
		case when isnull(a.mon,'')!='' then a.mon else left(a.datea,@r_lenm) end
		,sum((case when a.typea='1' then 1 else -1 end)*b.lengthb)
		,sum((case when a.typea='1' then 1 else -1 end)*b.lengthc)
		,sum((case when a.typea='1' then 1 else -1 end)*b.mount)
		,sum((case when a.typea='1' then 1 else -1 end)*b.total)
		,sum((case when a.typea='1' then 1 else -1 end)*a.tax)
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	where  (a.datea between @t_bdate and @t_edate) and --(isnull(a.salesno,'') != '') and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and 
			 (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  	 (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and
			 (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea) and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno) and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	group by a.custno,c.nick,c.comp,case when isnull(a.mon,'')!='' then a.mon else left(a.datea,@r_lenm) end
	
insert into @tmp(gno,custno,custs,mon,lengthb,lengthc,mount,total,tax) 
select '1',custno,custs,'999/99',sum(lengthb),sum(lengthc),sum(mount),sum(total),sum(tax) from @tmp group by custno,custs

insert into @tmp(gno,custno,lengthb,lengthc,mount,total,tax) 
select '2','ZZZZ_ZZZ',sum(lengthb),sum(lengthc),sum(mount), sum(total), sum(tax) from @tmp where gno='1'


select gno,custno cno,left(custs,10) custs,mon
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,dbo.getComma(lengthb,-1) lengthb
,dbo.getComma(lengthc,-1) lengthc
,dbo.getComma(mount,-1) mount
,dbo.getComma(total,-1) total
,dbo.getComma(tax,-1) tax
from @tmp order by custno,mon,gno;
--**********************************************************************************************
z_vcc7_xy:--z_vcc7_xy
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) =''
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4
--------------------------------------------------
set @qhref_acomp='_xy'
-------------------------------------------------
	SET QUOTED_IDENTIFIER OFF
	
	declare @result table(
		gno nvarchar(1),
		typea nvarchar(4),
		noa nvarchar(15),
		noq nvarchar(3),
		datea nvarchar(10),
		mon nvarchar(7),
		custno nvarchar(20),
		comp nvarchar(90),
		addr_invo nvarchar(90),
		tel nvarchar(90),
		productno nvarchar(30),
		xproduct nvarchar(MAX),
		unit nvarchar(8),
		lengthb float,
		lengthc float,
		mount float,
		weight float,
		price float,
		total float,
		money float,
		back float,
		tax float,
		total1 float,
		pay float,
		unpay float,
		total2 float,
		pcount int,
		qhref nvarchar(MAX)
		primary key (productno,gno,datea,noa,noq) 
	)
	
	insert into @result
	select '0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, case when isnull(a.mon,'')!='' then a.mon else left(a.datea,@r_lenm) end mon, 
		   a.custno custno, isnull(c.comp,''), isnull(c.addr_invo,''), isnull(c.tel,''), b.productno
		   , b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
		   , b.unit,(case when a.typea='1' then 1 else -1 end) *b.lengthb,(case when a.typea='1' then 1 else -1 end) *b.lengthc
		   ,(case when a.typea='1' then 1 else -1 end) *b.mount, b.weight, b.price, b.total, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
	       ,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vccs b
	left join view_vcc a on a.noa = b.noa
	left join cust c on  a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
		  (a.custno between @t_bcustno and @t_ecustno) and
		  (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and
		  (b.productno between @t_bproductno and @t_eproductno) and
		  (len(@t_groupano)=0 or d.groupano = @t_groupano) and 
		  (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and
		  (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
		  and (len(@t_stype)=0 or a.stype = @t_stype) 
		  and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
		  and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
		  and (len(@vcctypea)=0 or a.typea = @vcctypea) 
		  and (len(@t_partno)=0 or s.partno=@t_partno)
		  and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by productno,gno,datea,noa,noq

	--***********************************************************************
	declare @gno nvarchar(1)
	declare @typea nvarchar(4)
	declare @noa nvarchar(15)
	declare @total float
	declare @datea nvarchar(10)
	declare @productno nvarchar(30)
	declare @t_productno nvarchar(30)
	declare @t_money float
	declare @t_back float
	declare @t_tax float
	declare @t_total1 float
	declare @t_pcount int
	set @t_productno = '#zzzz#zzzz'
	set @t_money = 0
	set @t_back = 0
	set @t_tax = 0
	set @t_total1 = 0
	set @t_pcount = 0
	--***********************************************************************
	declare cursor_table cursor for
	select gno,typea,productno,datea,total from @result
	open cursor_table
	fetch next from cursor_table
	into @gno,@typea,@productno,@datea,@total
	while(@@FETCH_STATUS <> -1)
	begin
		if @t_productno != @productno
		begin
			if @t_productno != '#zzzz#zzzz'
			begin
				set @t_total1 = @t_money - @t_back + @t_tax
				insert into @result
				select '1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, '' custno, '' comp, '' addr_invo, '' tel, 
				       @t_productno, '' product, '' unit,0,0, 0 mount, 0 weight, 0 price, 0 total, 
					   @t_money, @t_back, @t_tax, @t_total1, 0 pay, 0 unpay, 0 total2, @t_pcount,''
			end
			set @t_productno = @productno
			set @t_money = case when @typea = '1' then @total else 0 end
			set @t_back = case when @typea = '2' then @total else 0 end
			set @t_tax = case when @typea = '稅' then @total else 0 end
			set @t_pcount = 1
		end
		else
		begin
			set @t_money = @t_money + case when @typea = '1' then @total else 0 end
			set @t_back = @t_back + case when @typea = '2' then @total else 0 end
			set @t_tax = @t_tax + case when @typea = '稅' then @total else 0 end
			set @t_pcount = @t_pcount + 1
		end
		fetch next from cursor_table
		into @gno,@typea,@productno,@datea,@total
	end
	close cursor_table
	deallocate cursor_table
	
	if @t_productno != '#zzzz#zzzz'
	begin
		set @t_total1 = @t_money - @t_back + @t_tax
		insert into @result
		select '1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, '' custno, '' comp, '' addr_invo, '' tel, 
		       @t_productno, '' product, '' unit,0,0, 0 mount, 0 weight, 0 price, 0 total, 
			   @t_money, @t_back, @t_tax, @t_total1, 0 pay, 0 unpay, 0 total2, @t_pcount,''
	end
	--***********************************************************************
	update @result set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'
	
	update a 
	set mount=(select sum(mount) from @result where gno='0' and productno=a.productno) 
	,lengthb=(select sum(lengthb) from @result where gno='0' and productno=a.productno)
	,lengthc=(select sum(lengthc) from @result where gno='0' and productno=a.productno)
	from @result a	where gno='1' 
	
	update @result
	set total=total*-1
	where typea='退'
	
	select gno, typea, noa, noq, datea, mon, custno, left(comp,10) comp
	,addr_invo,tel,productno,xproduct,unit, qhref
	,dbo.getComma(lengthb,-1) lengthb
	,dbo.getComma(lengthc,-1) lengthc
	,dbo.getComma(mount,-1) mount
	,dbo.getComma(price,-1) price
	,dbo.getComma(total,-1) total
	,dbo.getComma(total1,-1) total1
	,pcount 
	from @result order by productno,gno,datea,noa,noq;
--**********************************************************************************************
z_vcc8_xy:--z_vcc8_xy
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end

--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

--------------------------------------------------
SET QUOTED_IDENTIFIER OFF	

declare @tmp table(
	gno nvarchar(1),
	productno nvarchar(30),
	products nvarchar(MAX),
	mon nvarchar(15),
	lengthb float,
	lengthc float,
	mount float,
	total float
)
declare @cmd nvarchar(max)

insert into @tmp
	select
		'0',b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
		,case when charindex('永勝',@t_acomp)>0 then left(a.datea,@r_lenm) when isnull(a.mon,'')!='' then a.mon else left(a.datea,@r_lenm) end
		,sum((case when a.typea='1' then 1 else -1 end)*b.lengthb),sum((case when a.typea='1' then 1 else -1 end)*b.lengthc)
		,sum((case when a.typea='1' then 1 else -1 end)*b.mount),sum((case when a.typea='1' then 1 else -1 end)*b.total)
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join view_ucaucc d on b.productno = d.noa
	where  (a.datea between @t_bdate and @t_edate) and --(isnull(a.salesno,'') != '') and
	 		(a.custno between @t_bcustno and @t_ecustno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and
			 (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  	 (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and 
			 (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	group by b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
	,case when charindex('永勝',@t_acomp)>0 then left(a.datea,@r_lenm) when isnull(a.mon,'')!='' then a.mon else left(a.datea,@r_lenm) end
	
insert into @tmp(gno,productno,products,mon,lengthb,lengthc,mount,total)
select '1',productno,products,'999/99',sum(lengthb),sum(lengthc),sum(mount),sum(total)
from @tmp group by productno,products
	
insert into @tmp(gno,productno,lengthb,lengthc,mount,total)
select '2','ZZZZZZZZZZZZ',sum(lengthb),sum(lengthc),sum(mount),sum(total)
from @tmp where gno='1'

select gno,productno,(case when gno='0' then dbo.charbr(products,24) else products end )products,mon
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,dbo.getComma(lengthb,-1) lengthb
,dbo.getComma(lengthc,-1) lengthc
,dbo.getComma(mount,-1) mount
,dbo.getComma(total,-1) total
from @tmp order by productno,mon,gno;
--**********************************************************************************************
z_vcc9_xy:--z_vcc9_xy
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) =''
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

--------------------------------------------------
set @qhref_acomp='_xy'
-------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	salesno nvarchar(30),
	salesname nvarchar(50),
	comp nvarchar(100),
	datea nvarchar(10),
	noa nvarchar(35),
	typea nvarchar(15),
	productno nvarchar(30),
	products nvarchar(max),
	unit nvarchar(15),
	lengthb float,
	lengthc float,
	mount float,
	price float,
	total float,
	qhref nvarchar(max)
)
declare @cmd nvarchar(max)

insert into @tmp
	select '0',a.salesno,s.namea,a.comp,a.datea,a.noa,a.typea,b.productno
	,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end),b.unit,b.lengthb,b.lengthc
	,b.mount,b.price,b.total
	,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vcc a
	left join view_vccs b  on a.noa = b.noa and a.accy = b.accy
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and --(isnull(a.salesno,'') != '') and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and
			 (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  	 (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and 
			 (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_partno)=0 or s.partno=@t_partno)
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by a.salesno,a.datea

insert into @tmp(gno,salesno,salesname,lengthb,lengthc,mount,total)
	select '1' gno,salesno,salesname,
		sum((case when typea='1' then lengthb else lengthb*(-1) end)),
		sum((case when typea='1' then lengthc else lengthc*(-1) end)),
		sum((case when typea='1' then mount else mount*(-1) end)),
		sum((case when typea='1' then total else total*(-1) end)) 
	from @tmp group by salesno,salesname
update @tmp set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'

update @tmp
set mount=mount*-1,total=total*-1,lengthb=lengthb*-1,lengthc=lengthc*-1
where typea='退'

select gno,salesno,salesname,left(comp,10)comp,datea,noa,typea,productno,products,unit,qhref
,dbo.getComma(lengthb,-1) lengthb
,dbo.getComma(lengthc,-1) lengthc
,dbo.getComma(mount,-1) mount
,dbo.getComma(price,-1) price
,dbo.getComma(total,-1) total
from @tmp order by salesno,salesname,gno,datea,productno;
--**********************************************************************************************
z_vcc10_xy:--z_vcc10_xy
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

--------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	salesno nvarchar(30),
	salesname nvarchar(90),
	mon nvarchar(15),
	lengthb float,
	lengthc float,
	mount float,
	total float
)

insert into @tmp
	select
		'0',a.salesno,s.namea,case when isnull(a.mon,'')!='' then a.mon else left(a.datea,@r_lenm) end
		,sum((case when a.typea='1' then 1 else -1 end)*b.lengthb)
		,sum((case when a.typea='1' then 1 else -1 end)*b.lengthc)
		,sum((case when a.typea='1' then 1 else -1 end)*b.mount)
		,sum((case when a.typea='1' then 1 else -1 end)*b.total)
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where  (a.datea between @t_bdate and @t_edate) and --(isnull(a.salesno,'') != '') and
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and 
			 (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  	 (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and
			 (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and  (a.custno between @t_bcustno and @t_ecustno) 
			 and (isnull(b.productno,'') between @t_bproductno and @t_eproductno)
			and (len(@t_stype)=0 or a.stype = @t_stype) 
			and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			and (len(@t_partno)=0 or s.partno=@t_partno)
			and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	group by a.salesno,s.namea,case when isnull(a.mon,'')!='' then a.mon else left(a.datea,@r_lenm) end
	
insert into @tmp(gno,salesno,salesname,mon,lengthb,lengthc,mount,total)
select '1',salesno,salesname,'999/99',sum(lengthb),sum(lengthc),sum(mount),sum(total)
from @tmp group by salesno,salesname
	
insert into @tmp(gno,salesno,lengthb,lengthc,mount,total)
select '2','ZZZZZZ',sum(lengthb),sum(lengthc),sum(mount),sum(total)
from @tmp where gno='1'
	
select gno,salesno sno,salesname,mon
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,dbo.getComma(lengthb,-1) lengthb
,dbo.getComma(lengthc,-1) lengthc
,dbo.getComma(mount,-1) mount
,dbo.getComma(total,-1) total
from @tmp order by salesno,mon,gno;
--**********************************************************************************************
z_vcc11_xy:--z_vcc11_xy
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) =''
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4
--------------------------------------------------
	set @qhref_acomp='_xy'
-------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	salesno nvarchar(30),
	salesname nvarchar(50),
	comp nvarchar(100),
	datea nvarchar(10),
	noa nvarchar(35),
	typea nvarchar(15),
	productno nvarchar(30),
	products nvarchar(max),
	unit nvarchar(15),
	lengthb float,
	lengthc float,
	mount float,
	price float,
	total float,
	qhref nvarchar(max)
)

insert into @tmp
	select '0',a.salesno,s.namea,a.comp,a.datea,a.noa,a.typea
	,b.productno
	,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
	,b.unit,b.lengthb,b.lengthc,b.mount,b.price,b.total
	,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vcc a
	left join view_vccs b  on a.noa = b.noa and a.accy = b.accy
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and --(isnull(a.salesno,'') != '') and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and
			 (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  	 (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and 
			 (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_partno)=0 or s.partno=@t_partno)
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by a.salesno,b.productno

insert into @tmp(gno,salesno,salesname,lengthb,lengthc,mount,total)
	select '1' gno,salesno,salesname,
		sum((case when typea='1' then lengthb else lengthb*(-1) end)),
		sum((case when typea='1' then lengthc else lengthc*(-1) end)),
		sum((case when typea='1' then mount else mount*(-1) end)),
		sum((case when typea='1' then total else total*(-1) end)) 
	from @tmp group by salesno,salesname
	
update @tmp set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'

update @tmp
set mount=mount*-1,total=total*-1,lengthb=lengthb*-1,lengthc=lengthc*-1
where typea='退'

select 
gno,salesno,salesname,left(comp,10) comp,productno,products,datea,noa,typea,unit, qhref
,dbo.getComma(lengthb,-1) lengthb
,dbo.getComma(lengthc,-1) lengthc
,dbo.getComma(mount,-1) mount
,dbo.getComma(price,-1) price
,dbo.getComma(total,-1) total
from @tmp order by salesno,salesname,gno,productno,datea;
--**********************************************************************************************
z_vcc12_xy:--z_vcc12_xy
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4
--------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	salesno nvarchar(30),
	salesname nvarchar(50),
	productno nvarchar(30),
	products nvarchar(max),
	lengthb float,
	lengthc float,
	mount float,
	total float
)

insert into @tmp
	select '0',a.salesno,s.namea,b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
	,sum((case when a.typea='1' then 1 else -1 end)*b.lengthb)
	,sum((case when a.typea='1' then 1 else -1 end)*b.lengthc)
	,sum((case when a.typea='1' then 1 else -1 end)*b.mount)
	,sum((case when a.typea='1' then 1 else -1 end)*b.total)
	from view_vcc a
	left join view_vccs b  on a.noa = b.noa and a.accy = b.accy
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and 
			  (a.custno between @t_bcustno and @t_ecustno) and 
			 --(isnull(a.salesno,'') != '') and 
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and
			 (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  	 (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and 
			 (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_partno)=0 or s.partno=@t_partno)
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	group by a.salesno,s.namea,b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
	order by a.salesno,b.productno
	
insert into @tmp(gno,lengthb,lengthc,mount,total)
select '1',sum(lengthb),sum(lengthc),sum(mount),sum(total)
from @tmp

select gno,salesno sno ,salesname,productno,products
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,dbo.getComma(lengthb,-1) lengthb
,dbo.getComma(lengthc,-1) lengthc
,dbo.getComma(mount,-1) mount
,dbo.getComma(total,-1) total
from @tmp order by gno,salesno,productno;
--**********************************************************************************************
z_vcc13_xy:--z_vcc13_xy
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) =''
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4
--------------------------------------------------
set @qhref_acomp='_xy'
-------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	custno nvarchar(30),
	custnick nvarchar(90),
	salesno nvarchar(30),
	salesname nvarchar(50),
	productno nvarchar(30),
	products nvarchar(max),
	datea nvarchar(10),
	noa nvarchar(35),
	typea nvarchar(15),
	unit nvarchar(15),
	lengthb float,
	lengthc float,
	mount float,
	price float,
	total float,
	qhref nvarchar(MAX)
)

insert into @tmp
	select '0',a.custno,(case when isnull(c.nick,'') = '' then left(c.comp,10) else c.nick end),
	a.salesno,s.namea,b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
	,a.datea,a.noa,a.typea,b.unit,b.lengthb,b.lengthc,b.mount,b.price,b.total
	,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vcc a
	left join view_vccs b  on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and --(isnull(a.salesno,'') != '') and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			 and (len(@t_groupbno)=0 or d.groupbno = @t_groupbno)
		  	 and (len(@t_groupcno)=0 or d.groupcno = @t_groupcno)
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_partno)=0 or s.partno=@t_partno)
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by a.salesno,a.custno,b.productno
	
insert into @tmp(gno,salesno,salesname,lengthb,lengthc,mount,total)
	select '1' gno,salesno,salesname,
		sum((case when typea='1' then lengthb else lengthb*(-1) end)),
		sum((case when typea='1' then lengthc else lengthc*(-1) end)),
		sum((case when typea='1' then mount else mount*(-1) end)),
		sum((case when typea='1' then total else total*(-1) end)) 
	from @tmp group by salesno,salesname
	
update @tmp set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'

update @tmp
set mount=mount*-1,total=total*-1,lengthb=lengthb*-1,lengthc=lengthc*-1
where typea='退'

select gno,custno,custnick,salesno,salesname,productno,products,datea,noa,typea,unit,qhref
,dbo.getComma(lengthb,-1) lengthb
,dbo.getComma(lengthc,-1) lengthc
,dbo.getComma(mount,-1) mount
,dbo.getComma(price,-1) price
,dbo.getComma(total,-1) total
from @tmp order by salesno,gno,custno,productno,datea;
--**********************************************************************************************
z_vcc14_xy:--z_vcc14_xy
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4
--------------------------------------------------
SET QUOTED_IDENTIFIER OFF	

declare @tmp table(
	gno nvarchar(1),
	custno nvarchar(30),
	custnick nvarchar(90),
	salesno nvarchar(30),
	salesname nvarchar(50),
	productno nvarchar(30),
	products nvarchar(max),
	lengthb float,
	lengthc float,
	mount float,
	total float
)

insert into @tmp
	select '0',a.custno,(case when isnull(c.nick,'') = '' then left(c.comp,10) else c.nick end),
	a.salesno,s.namea,b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
	,sum((case when a.typea='1' then 1 else -1 end)*b.lengthb)
	,sum((case when a.typea='1' then 1 else -1 end)*b.lengthc)
	,sum((case when a.typea='1' then 1 else -1 end)*b.mount)
	,sum((case when a.typea='1' then 1 else -1 end)*b.total)
	from view_vcc a
	left join view_vccs b  on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (isnull(a.salesno,'')between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and --(isnull(a.salesno,'') != '') and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and
			 (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  	 (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and 
			 (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			and (len(@vcctypea)=0 or a.typea = @vcctypea)
			and (len(@t_partno)=0 or s.partno=@t_partno)
			and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
			and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	group by a.salesno,s.namea,a.custno,c.nick,c.comp,b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
	order by a.salesno,a.custno,b.productno
	
insert into @tmp(gno,lengthb,lengthc,mount,total)
select '1',sum(lengthb),sum(lengthc),sum(mount),sum(total)
from @tmp

select gno,custno,left(custnick,7) custnick,salesno sno ,salesname,productno,products
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,dbo.getComma(lengthb,-1) lengthb
,dbo.getComma(lengthc,-1) lengthc
,dbo.getComma(mount,-1) mount
,dbo.getComma(total,-1) total
from @tmp order by gno,salesno,custno,productno;
--**********************************************************************************************
z_vcc15_xy:--z_vcc15_xy
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) =''
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4
--------------------------------------------------
set @qhref_acomp='_xy'
-------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	productno nvarchar(30),
	products nvarchar(MAX),
	sno nvarchar(30),
	salesname nvarchar(90),
	cno nvarchar(30),
	custnick nvarchar(90),
	datea nvarchar(10),
	noa nvarchar(30),
	typea nvarchar(15),
	lengthb float,
	lengthc float,
	mount float,
	price float,
	total float,
	qhref nvarchar(MAX)
)

insert into @tmp
	select
		'0',b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
		,a.salesno,s.namea,a.custno,
		(case when isnull(c.nick,'') = '' then left(c.comp,10) else c.nick end),
		a.datea,a.noa,a.typea,b.lengthb,b.lengthc,b.mount,b.price,b.total,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and
			 (len(@t_groupbno)=0 or d.groupbno = @t_groupbno) and
		  	 (len(@t_groupcno)=0 or d.groupcno = @t_groupcno) and 
			 (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno) and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_partno)=0 or s.partno=@t_partno)
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by b.productno,b.product,a.salesno,s.namea,a.custno,c.nick,c.comp,a.datea,a.noa,a.typea
	  
insert into @tmp(gno,productno,products,lengthb,lengthc,mount,total)
	select '1',productno,products,
		sum((case when typea='1' then lengthb else lengthb*(-1) end)),
		sum((case when typea='1' then lengthc else lengthc*(-1) end)),
		sum((case when typea='1' then mount else mount*(-1) end)),
		sum((case when typea='1' then total else total*(-1) end))
	from @tmp group by productno,products
update @tmp set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'

update @tmp
set mount=mount*-1,total=total*-1,lengthb=lengthb*-1,lengthc=lengthc*-1
where typea='退'

select gno,productno,products,sno,salesname,cno,custnick,datea,noa,typea, qhref
,dbo.getComma(lengthb,-1) lengthb
,dbo.getComma(lengthc,-1) lengthc
,dbo.getComma(mount,-1) mount
,dbo.getComma(price,-1) price
,dbo.getComma(total,-1) total
from @tmp order by productno,products,gno,sno,cno,datea,typea;
--**********************************************************************************************
z_vcc16_xy:--z_vcc16_xy
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

--------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	productno nvarchar(30),
	products nvarchar(MAX),
	sno nvarchar(30),
	salesname nvarchar(90),
	cno nvarchar(30),
	custnick nvarchar(90),
	lengthb float,
	lengthc float,
	mount float,
	total float
)

insert into @tmp
	select
		'0',b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
		,a.salesno,s.namea,a.custno,
		(case when isnull(c.nick,'') = '' then c.comp else c.nick end)
		,sum((case when a.typea='1' then 1 else -1 end)*b.lengthb)
		,sum((case when a.typea='1' then 1 else -1 end)*b.lengthc)
		,sum((case when a.typea='1' then 1 else -1 end)*b.mount)
		,sum((case when a.typea='1' then 1 else -1 end)*b.total)
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			 and (len(@t_groupbno)=0 or d.groupbno = @t_groupbno)
		  	 and (len(@t_groupcno)=0 or d.groupcno = @t_groupcno)
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_partno)=0 or s.partno=@t_partno)
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	group by b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
	,a.salesno,s.namea,a.custno,c.nick,c.comp
	
insert into @tmp(gno,productno,products,lengthb,lengthc,mount,total)
select '1',productno,products,sum(lengthb),sum(lengthc),sum(mount),sum(total)
from @tmp group by productno,products
	
select gno,productno,products,sno,salesname,cno,left(custnick,10) custnick 
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,dbo.getComma(lengthb,-1) lengthb
,dbo.getComma(lengthc,-1) lengthc
,dbo.getComma(mount,-1) mount
,dbo.getComma(total,-1) total
from @tmp order by productno,products,gno,sno,cno;
--**********************************************************************************************
z_vcc19_xy:--z_vcc19_xy
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
-------------------------------------------------------------------------------------------------------------
--設定小數點--4表示無小數點--2表示小數點1位---0表示小數點2位--
declare @mount_decimal int = 0
declare @weight_decimal int = 0
declare @price_decimal int = 0
declare @total_decimal int = 4

--------------------------------------------------
SET QUOTED_IDENTIFIER OFF
declare @tmp table(
	gno nvarchar(1),
	productno nvarchar(30),
	products nvarchar(MAX),
	cno nvarchar(30),
	custnick nvarchar(90),
	lengthb float,
	lengthc float,
	mount float,
	total float
)

insert into @tmp
	select '9',b.productno,b.product+(case when @isspec='1' then '<BR>&nbsp'+isnull(b.spec,'') else '' end)
		,a.custno,	(case when isnull(c.nick,'') = '' then c.comp else c.nick end)
		,(case when a.typea='1' then 1 else -1 end)*b.lengthb
		,(case when a.typea='1' then 1 else -1 end)*b.lengthc
		,(case when a.typea='1' then 1 else -1 end)*b.mount,(case when a.typea='1' then 1 else -1 end)*b.total
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	where (a.datea between @t_bdate and @t_edate) and (a.custno between @t_bcustno and @t_ecustno) and 
			 (b.productno between @t_bproductno and @t_eproductno) 
			 and (len(@t_groupano)=0 or d.groupano = @t_groupano)
			 and (len(@t_groupbno)=0 or d.groupbno = @t_groupbno)
		  	 and (len(@t_groupcno)=0 or d.groupcno = @t_groupcno)
			 and (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea) and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_multcust)=0 or CHARINDEX(a.custno+',',@t_multcust)>0)
		  	and (len(@t_multucc)=0 or CHARINDEX(b.productno+',',@t_multucc)>0)
	order by b.productno,b.product,a.custno,c.nick,c.comp
	
	insert into @tmp 
	select '0',productno,products,cno,custnick,sum(lengthb),sum(lengthc),SUM(mount),SUM(total) from @tmp
	group by productno,products,cno,custnick
	
	delete @tmp where gno='9'

	insert into @tmp(gno,cno,custnick,lengthb,lengthc,mount,total) 
	select '1',cno,custnick,sum(lengthb),sum(lengthc),sum(mount),sum(total) 
	from @tmp where gno='0' group by cno,custnick 
	
select gno,productno,products,cno,custnick
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,dbo.getComma(lengthb,-1) lengthb
,dbo.getComma(lengthc,-1) lengthc
,dbo.getComma(mount,-1) mount
,dbo.getComma(total,-1) total
from @tmp order by cno,custnick,gno,productno;
--**********************************************************************************************
z_vcc17_xy:--z_vcc17_xy
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_groupbno nvarchar(30)
declare @t_groupcno nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_acomp nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @isspec nvarchar(10)='[25]'
declare @t_multcust nvarchar(max)
declare @t_multucc nvarchar(max)
declare @r_len nvarchar(10)='[28]'
declare @r_lenm nvarchar(10)='6'
if (@r_len='4')
	set @r_lenm='7'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_groupbno = case when '#non'=[18] then '' else (case when [18] = ' ' then '' else [18] end) end
set @t_groupcno = case when '#non'=[19] then '' else (case when [19] = ' ' then '' else [19] end) end
set @t_stype = case when '#non'=[20] then '' else [20] end
set @t_salesgroup = case when '#non' = [21] then '' else [21] end
set @t_showinvono = case when '#non' = [24] then 0 else [24] end
set @vcctypea = case when '#non' = [22] then '' else [22] end
set @t_partno = case when '#non' = [23] then '' else [23] end
set @t_multcust = case when '#non' = [26] then '' else [26]+',' end
set @t_multucc = case when '#non' = [27] then '' else [27]+',' end
--------------------------------------------------
SET QUOTED_IDENTIFIER OFF

IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
	drop table #tmp
END

create table #tmp(
 gno nvarchar(10),
 typea nvarchar(10),
 typea2 nvarchar(10),
 vccno nvarchar(50),
 salesno nvarchar(MAX),
 sales nvarchar(MAX),
 custno nvarchar(MAX),
 comp nvarchar(MAX),
 productno nvarchar(MAX),
 products nvarchar(MAX),
 spec nvarchar(MAX),
 unit nvarchar(MAX),
 mount float,
 price float,
 total float,
 stk float 
)

insert #tmp
select '9','1','1',a.noa
,isnull(a.salesno,''),a.sales,a.custno,a.comp,b.productno,b.product,b.spec,b.unit
,case when a.typea='1' then 1 else -1 end*b.mount,b.price
,case when a.typea='1' then 1 else -1 end*b.total
,case when a.typea='1' then 1 else -1 end*case when b.itemno='1' then 1 when b.itemno='2' then -1 else 0 end*b.dime
from view_vcc a left join view_vccs b on a.noa=b.noa left join cust c on a.custno=c.noa
where a.datea between @t_bdate and @t_edate
and a.custno between @t_bcustno and @t_ecustno
and a.salesno between @t_bsalesno and @t_esalesno 
and b.productno between @t_bproductno and @t_eproductno
and a.custno!='' and b.productno!=''

insert #tmp
select '0',typea,typea2,'',salesno,sales,custno,comp,productno,products,spec,unit 
,SUM(mount),price,SUM(total),SUM(stk)
from #tmp
group by typea,typea2,salesno,sales,custno,comp,productno,products,spec,unit,price

update a 
set typea='0'
from #tmp a
where gno='0' and not exists(select noa from view_vccs where custno=a.custno and datea<@t_bdate)

update a 
set typea2='0'
from #tmp a
where gno='0' and not exists(select noa from view_vccs where custno=a.custno and productno=a.productno and datea<@t_bdate)

if((select count(*) from #tmp)>0)
begin
	insert #tmp(gno,typea,typea2,vccno,salesno,sales,custno,comp,productno,products,spec,unit,mount,price,total,stk)
	select '1','1','1','',salesno,MAX(sales),CHAR(255),CHAR(255),CHAR(255),CHAR(255),CHAR(255),CHAR(255),SUM(mount),null,SUM(total),SUM(stk)
	from #tmp where gno='0'
	group by salesno

	insert #tmp(gno,typea,typea2,vccno,salesno,sales,custno,comp,productno,products,spec,unit,mount,price,total,stk)
	select '2','1','1','',CHAR(255),CHAR(255),CHAR(255),CHAR(255),CHAR(255),CHAR(255),CHAR(255),CHAR(255),SUM(mount),null,SUM(total),SUM(stk)
	from #tmp where gno='0'
end

select 
case when typea='0' then '*'+comp else comp end xcomp
,case when typea2='0' then '*'+productno else productno end xproductno
,dbo.getComma(mount,-1)mount
,dbo.getComma(price,-1)price
,dbo.getComma(total,-1)total
,*
from #tmp where gno!='9' order by salesno,gno,typea,typea2,productno

IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
 drop table #tmp
END
;